# æ—¥å¿—çª—å£åˆå§‹æ˜¾ç¤ºé—®é¢˜ä¿®å¤ï¼ˆæœ€ç»ˆç‰ˆï¼‰

## ğŸ“… æ—¥æœŸ
2025-12-26

## ğŸ› é—®é¢˜æè¿°

**ç—‡çŠ¶ï¼š**
- ç¨‹åºå¯åŠ¨åï¼ŒçŠ¶æ€æ æ˜¾ç¤ºæ—¥å¿—æ­£å¸¸
- æ—¥å¿—çª—å£ï¼ˆLogWindowï¼‰å®Œå…¨ä¸æ˜¾ç¤ºä»»ä½•æ—¥å¿—
- å³ä½¿ä¸è¿›è¡Œåˆ†ç¦»/é™„åŠ æ“ä½œï¼Œåˆå§‹çŠ¶æ€å°±æ— æ³•æ˜¾ç¤º

**æ ¹æœ¬åŸå› ï¼š**
1. `GridControl` åˆå§‹åŒ–æ—¶æ²¡æœ‰è®¾ç½®æ•°æ®æº
2. æ—¥å¿—é¢æ¿é»˜è®¤éšè—ï¼Œé¦–æ¬¡æ˜¾ç¤ºæ—¶æ²¡æœ‰è§¦å‘åˆ·æ–°
3. `LoadHistoricalLogs()` å¯èƒ½åœ¨æ§ä»¶å®Œå…¨åˆå§‹åŒ–å‰è°ƒç”¨

---

## âœ… æœ€ç»ˆè§£å†³æ–¹æ¡ˆ

### 1. åˆå§‹åŒ–æ—¶è®¾ç½®æ•°æ®æº

**æ–‡ä»¶**: `æ°¸åˆ©ç³»ç»Ÿ/Views/LogWindow.cs`

**ä¿®æ”¹å‰ï¼š**
```csharp
// ä¸åœ¨åˆå§‹åŒ–æ—¶è®¾ç½®æ•°æ®æºï¼Œç­‰å¾…åŠ è½½å†å²æ—¥å¿—åè®¾ç½®
// _gridControl.DataSource = _logEntries;
```

**ä¿®æ”¹åï¼š**
```csharp
// ğŸ”¥ åˆå§‹åŒ–æ—¶è®¾ç½®ç©ºçš„æ•°æ®æºï¼ˆç¡®ä¿ GridControl å¯ä»¥æ­£å¸¸ç»‘å®šï¼‰
_gridControl.DataSource = new List<LogEntry>();
```

**åŸå› ï¼š** DevExpress GridControl éœ€è¦åœ¨åˆå§‹åŒ–æ—¶è®¾ç½®æ•°æ®æºï¼Œå¦åˆ™åç»­çš„æ•°æ®ç»‘å®šå¯èƒ½å¤±æ•ˆã€‚

---

### 2. å¢å¼º ForceRefresh æ–¹æ³•

**æ–‡ä»¶**: `æ°¸åˆ©ç³»ç»Ÿ/Views/LogWindow.cs`

```csharp
public void ForceRefresh()
{
    System.Diagnostics.Debug.WriteLine("========== ForceRefresh å¼€å§‹ ==========");
    System.Diagnostics.Debug.WriteLine($"ForceRefresh: _logEntries.Count = {_logEntries.Count}");
    System.Diagnostics.Debug.WriteLine($"ForceRefresh: IsHandleCreated = {IsHandleCreated}");
    System.Diagnostics.Debug.WriteLine($"ForceRefresh: Visible = {Visible}");
    System.Diagnostics.Debug.WriteLine($"ForceRefresh: InvokeRequired = {InvokeRequired}");
    
    // é‡æ–°è®¢é˜…äº‹ä»¶ï¼ˆç¡®ä¿ä¸ä¼šä¸¢å¤±ï¼‰
    SubscribeToLogEvents();
    
    // å¦‚æœéœ€è¦è·¨çº¿ç¨‹è°ƒç”¨
    if (InvokeRequired)
    {
        System.Diagnostics.Debug.WriteLine("ForceRefresh: ä½¿ç”¨ Invoke è°ƒç”¨åˆ·æ–°");
        BeginInvoke(new Action(() => 
        {
            RefreshDisplay();
            System.Diagnostics.Debug.WriteLine($"ForceRefresh å®Œæˆ: GridView è¡Œæ•° = {_gridView?.RowCount ?? 0}");
        }));
    }
    else
    {
        System.Diagnostics.Debug.WriteLine("ForceRefresh: ç›´æ¥è°ƒç”¨åˆ·æ–°");
        RefreshDisplay();
        System.Diagnostics.Debug.WriteLine($"ForceRefresh å®Œæˆ: GridView è¡Œæ•° = {_gridView?.RowCount ?? 0}");
    }
    
    System.Diagnostics.Debug.WriteLine("========== ForceRefresh ç»“æŸ ==========");
}
```

**æ”¹è¿›ï¼š**
- æ·»åŠ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—
- æ­£ç¡®å¤„ç†è·¨çº¿ç¨‹è°ƒç”¨
- è¾“å‡ºå…³é”®çŠ¶æ€ä¿¡æ¯

---

### 3. æ˜¾ç¤ºæ—¥å¿—é¢æ¿æ—¶å¼ºåˆ¶åˆ·æ–°

**æ–‡ä»¶**: `æ°¸åˆ©ç³»ç»Ÿ/Views/MainTabs.cs`

#### ShowLogWindow() æ–¹æ³•

```csharp
public void ShowLogWindow()
{
    // ç¡®ä¿æ—¥å¿—é¢æ¿æ˜¾ç¤º
    if (splitContainerControl1.PanelVisibility == DevExpress.XtraEditors.SplitPanelVisibility.Panel1)
    {
        splitContainerControl1.PanelVisibility = DevExpress.XtraEditors.SplitPanelVisibility.Both;
        splitContainerControl1.SplitterPosition = splitContainerControl1.Height - 250;
        toolStripMenuItemViewLog.Checked = true;
        
        // ğŸ”¥ æ˜¾ç¤ºæ—¥å¿—é¢æ¿åï¼Œå¼ºåˆ¶åˆ·æ–°æ˜¾ç¤º
        logWindow1?.ForceRefresh();
    }
}
```

#### ToggleLogWindow() æ–¹æ³•

```csharp
private void ToggleLogWindow()
{
    if (splitContainerControl1.PanelVisibility == DevExpress.XtraEditors.SplitPanelVisibility.Panel1)
    {
        // æ˜¾ç¤ºæ—¥å¿—é¢æ¿
        splitContainerControl1.PanelVisibility = DevExpress.XtraEditors.SplitPanelVisibility.Both;
        splitContainerControl1.SplitterPosition = splitContainerControl1.Height - 250;
        toolStripMenuItemViewLog.Checked = true;
        
        // ğŸ”¥ æ˜¾ç¤ºæ—¥å¿—é¢æ¿åï¼Œå¼ºåˆ¶åˆ·æ–°æ˜¾ç¤º
        logWindow1?.ForceRefresh();
    }
    else
    {
        // éšè—æ—¥å¿—é¢æ¿
        splitContainerControl1.PanelVisibility = DevExpress.XtraEditors.SplitPanelVisibility.Panel1;
        toolStripMenuItemViewLog.Checked = false;
    }
}
```

---

## ğŸ¯ å®Œæ•´çš„åˆ·æ–°è§¦å‘æœºåˆ¶

### æ—¥å¿—æ˜¾ç¤ºçš„æ‰€æœ‰è§¦å‘ç‚¹

```
1. ç¨‹åºå¯åŠ¨
   â””â”€ LogWindow æ„é€ å‡½æ•°
      â””â”€ InitializeUI()
         â””â”€ _gridControl.DataSource = new List<LogEntry>() âœ…

2. æ§ä»¶å¥æŸ„åˆ›å»º
   â””â”€ HandleCreated äº‹ä»¶
      â””â”€ SubscribeToLogEvents() âœ…

3. æ§ä»¶å˜ä¸ºå¯è§
   â””â”€ VisibleChanged äº‹ä»¶
      â””â”€ SubscribeToLogEvents() âœ…
      â””â”€ LoadHistoricalLogs() âœ…
         â””â”€ RefreshDisplay() âœ…

4. ç”¨æˆ·ç‚¹å‡»"æ—¥å¿—"æŒ‰é’®
   â””â”€ ShowLogWindowAndFilter("å¾®ä¿¡åŠ©æ‰‹")
      â””â”€ ShowLogWindow()
         â””â”€ logWindow1.ForceRefresh() âœ…

5. ç”¨æˆ·æŒ‰ F12 åˆ‡æ¢æ—¥å¿—
   â””â”€ ToggleLogWindow()
      â””â”€ logWindow1.ForceRefresh() âœ…

6. åˆ†ç¦»æ“ä½œ
   â””â”€ LogWindow_DetachRequested()
      â””â”€ logWindow1.ForceRefresh() âœ…

7. é™„åŠ æ“ä½œ
   â””â”€ AttachLogWindow()
      â””â”€ logWindow1.ForceRefresh() âœ…

8. æ–°æ—¥å¿—åˆ°è¾¾
   â””â”€ OnLogReceived()
      â””â”€ AddLogEntry()
         â””â”€ RefreshDisplay() âœ…
```

---

## ğŸ“Š è°ƒè¯•æ—¥å¿—ç¤ºä¾‹

### æ­£å¸¸æƒ…å†µçš„è¾“å‡º

```
========== ForceRefresh å¼€å§‹ ==========
ForceRefresh: _logEntries.Count = 52
ForceRefresh: IsHandleCreated = True
ForceRefresh: Visible = True
ForceRefresh: InvokeRequired = False
ForceRefresh: ç›´æ¥è°ƒç”¨åˆ·æ–°
========== RefreshDisplay å¼€å§‹ ==========
GridControl: å­˜åœ¨
GridView: å­˜åœ¨
========== ApplyFilters å¼€å§‹ ==========
åŸå§‹æ—¥å¿—: 52 æ¡
_selectedModule = 'å…¨éƒ¨'
æœ€ç»ˆè¿”å›: 52 æ¡
========== ApplyFilters ç»“æŸ ==========
RefreshDisplay: è¿‡æ»¤å 52 æ¡æ—¥å¿—
  [0] 15:30:01 [ç³»ç»Ÿ] ä¸»çª—å£åˆå§‹åŒ–å®Œæˆ
  [1] 15:30:02 [å¾®ä¿¡åŠ©æ‰‹] å¾®ä¿¡åŠ©æ‰‹é¡µé¢å·²åˆå§‹åŒ–
  [2] 15:30:03 [å¾®ä¿¡åŠ©æ‰‹] æ¸¸æˆæœåŠ¡å·²å¯åŠ¨
RefreshDisplay: GridView è¡Œæ•° = 52
RefreshDisplay: GridControl.DataSource ç±»å‹ = List`1
RefreshDisplay: GridView.Columns.Count = 4
  åˆ—: Timestamp (æ—¶é—´) Visible=True
  åˆ—: Module (æ¨¡å—) Visible=True
  åˆ—: Level (çº§åˆ«) Visible=True
  åˆ—: Message (æ¶ˆæ¯) Visible=True
========== RefreshDisplay ç»“æŸ ==========
ForceRefresh å®Œæˆ: GridView è¡Œæ•° = 52
========== ForceRefresh ç»“æŸ ==========
```

### é—®é¢˜æƒ…å†µçš„è¾“å‡º

```
========== ForceRefresh å¼€å§‹ ==========
ForceRefresh: _logEntries.Count = 52
ForceRefresh: IsHandleCreated = False  â† âŒ æ§ä»¶å¥æŸ„æœªåˆ›å»º
ForceRefresh: Visible = False           â† âŒ æ§ä»¶ä¸å¯è§
ForceRefresh: InvokeRequired = False
```

---

## ğŸ§ª æµ‹è¯•æ¸…å•

### åŸºæœ¬æ˜¾ç¤ºæµ‹è¯•
- [x] ç¨‹åºå¯åŠ¨åï¼ŒæŒ‰ F12 æ˜¾ç¤ºæ—¥å¿—é¢æ¿ï¼Œæ—¥å¿—æ­£å¸¸æ˜¾ç¤º
- [x] ç¨‹åºå¯åŠ¨åï¼Œç‚¹å‡»èœå•"è§†å›¾ â†’ æ—¥å¿—"ï¼Œæ—¥å¿—æ­£å¸¸æ˜¾ç¤º
- [x] ç¨‹åºå¯åŠ¨åï¼Œç‚¹å‡»å¾®ä¿¡åŠ©æ‰‹"æ—¥å¿—"æŒ‰é’®ï¼Œæ—¥å¿—æ­£å¸¸æ˜¾ç¤º

### å®æ—¶æ›´æ–°æµ‹è¯•
- [x] æ—¥å¿—é¢æ¿æ˜¾ç¤ºåï¼Œäº§ç”Ÿæ–°æ—¥å¿—ï¼Œå®æ—¶æ›´æ–°
- [x] æ—¥å¿—é¢æ¿éšè—åäº§ç”Ÿæ—¥å¿—ï¼Œå†æ˜¾ç¤ºæ—¶æ˜¾ç¤ºæ‰€æœ‰å†å²æ—¥å¿—

### åˆ†ç¦»/é™„åŠ æµ‹è¯•
- [x] åˆ†ç¦»åæ—¥å¿—æ­£å¸¸æ˜¾ç¤º
- [x] é™„åŠ åæ—¥å¿—æ­£å¸¸æ˜¾ç¤º
- [x] å¤šæ¬¡åˆ†ç¦»/é™„åŠ ï¼Œæ—¥å¿—å§‹ç»ˆæ­£å¸¸æ˜¾ç¤º

### è¿‡æ»¤æµ‹è¯•
- [x] è¿‡æ»¤"å¾®ä¿¡åŠ©æ‰‹"æ¨¡å—ï¼Œåªæ˜¾ç¤ºå¾®ä¿¡åŠ©æ‰‹æ—¥å¿—
- [x] åˆ‡æ¢è¿‡æ»¤æ¡ä»¶ï¼Œæ—¥å¿—æ­£ç¡®æ›´æ–°
- [x] æœç´¢åŠŸèƒ½æ­£å¸¸å·¥ä½œ

---

## ğŸ’¡ å…³é”®æŠ€æœ¯ç‚¹

### 1. DevExpress GridControl æ•°æ®ç»‘å®š

```csharp
// âŒ é”™è¯¯ï¼šä¸è®¾ç½®åˆå§‹æ•°æ®æº
_gridControl.MainView = _gridView;
// åç»­è®¾ç½®å¯èƒ½å¤±æ•ˆ

// âœ… æ­£ç¡®ï¼šåˆå§‹åŒ–æ—¶è®¾ç½®æ•°æ®æº
_gridControl.MainView = _gridView;
_gridControl.DataSource = new List<LogEntry>();
// åç»­æ›´æ–°æ•°æ®æºä¼šæ­£å¸¸å·¥ä½œ
```

### 2. æ§ä»¶å¯è§æ€§ä¸åˆ·æ–°æ—¶æœº

```csharp
// æ§ä»¶ä»éšè—å˜ä¸ºå¯è§æ—¶
splitContainerControl1.PanelVisibility = ...Both;

// ğŸ”¥ ç«‹å³åˆ·æ–°ï¼Œç¡®ä¿æ•°æ®æ˜¾ç¤º
logWindow1?.ForceRefresh();
```

### 3. è·¨çº¿ç¨‹UIæ›´æ–°

```csharp
if (InvokeRequired)
{
    BeginInvoke(new Action(() => RefreshDisplay()));
}
else
{
    RefreshDisplay();
}
```

---

## ğŸ“ˆ æ€§èƒ½è€ƒè™‘

### RefreshDisplay() ä¼˜åŒ–

```csharp
_gridControl.BeginUpdate();    // å¼€å§‹æ‰¹é‡æ›´æ–°
_gridControl.DataSource = null; // æ¸…ç©ºæ—§æ•°æ®
_gridControl.DataSource = filtered; // è®¾ç½®æ–°æ•°æ®
_gridControl.RefreshDataSource();
_gridView.RefreshData();
_gridControl.EndUpdate();      // ç»“æŸæ‰¹é‡æ›´æ–°
```

**å¥½å¤„ï¼š**
- å‡å°‘é‡ç»˜æ¬¡æ•°
- æé«˜å¤§æ•°æ®é‡æ—¶çš„æ€§èƒ½
- é¿å…ç•Œé¢é—ªçƒ

---

## ğŸ” æ•…éšœæ’æŸ¥æ­¥éª¤

### å¦‚æœæ—¥å¿—è¿˜æ˜¯ä¸æ˜¾ç¤º

1. **æŸ¥çœ‹è°ƒè¯•è¾“å‡º**ï¼ˆVS è¾“å‡ºçª—å£ï¼‰
   - æ£€æŸ¥ `_logEntries.Count` æ˜¯å¦ > 0
   - æ£€æŸ¥ `GridView.RowCount` æ˜¯å¦ > 0
   - æ£€æŸ¥ `IsHandleCreated` æ˜¯å¦ä¸º True
   - æ£€æŸ¥ `Visible` æ˜¯å¦ä¸º True

2. **æ‰‹åŠ¨è§¦å‘åˆ·æ–°**
   - æŒ‰ F12 ä¸¤æ¬¡ï¼ˆéšè—å†æ˜¾ç¤ºï¼‰
   - åˆ‡æ¢è¿‡æ»¤æ¡ä»¶ï¼ˆæ¨¡å—/çº§åˆ«ï¼‰
   - ç‚¹å‡»"æ¸…ç©º"å†ç­‰å¾…æ–°æ—¥å¿—

3. **æ£€æŸ¥æ•°æ®æº**
   ```
   RefreshDisplay: GridControl.DataSource ç±»å‹ = ?
   // åº”è¯¥æ˜¯ List`1 æˆ–å…¶ä»–é›†åˆç±»å‹
   // å¦‚æœæ˜¯ nullï¼Œè¯´æ˜æ•°æ®æºè®¾ç½®å¤±è´¥
   ```

4. **æ£€æŸ¥åˆ—é…ç½®**
   ```
   RefreshDisplay: GridView.Columns.Count = ?
   // åº”è¯¥æ˜¯ 4 (æ—¶é—´/æ¨¡å—/çº§åˆ«/æ¶ˆæ¯)
   // å¦‚æœæ˜¯ 0ï¼Œè¯´æ˜åˆ—æœªæ­£ç¡®æ·»åŠ 
   ```

---

## ğŸ“š ç›¸å…³æ–‡ä»¶

- `æ°¸åˆ©ç³»ç»Ÿ/Views/LogWindow.cs` - æ—¥å¿—æ§ä»¶ï¼ˆä¿®å¤ï¼‰
- `æ°¸åˆ©ç³»ç»Ÿ/Views/MainTabs.cs` - ä¸»çª—å£ï¼ˆä¿®å¤ï¼‰
- `æ°¸åˆ©ç³»ç»Ÿ/Views/FloatingLogWindow.cs` - æµ®åŠ¨æ—¥å¿—çª—å£

---

## ğŸ‰ ä¿®å¤æ€»ç»“

### ä¸‰ä¸ªå…³é”®ä¿®å¤

1. **åˆå§‹åŒ–æ•°æ®æº** âœ…
   - `_gridControl.DataSource = new List<LogEntry>()`

2. **å¢å¼º ForceRefresh** âœ…
   - æ·»åŠ è¯¦ç»†æ—¥å¿—
   - å¤„ç†è·¨çº¿ç¨‹è°ƒç”¨

3. **æ˜¾ç¤ºæ—¶å¼ºåˆ¶åˆ·æ–°** âœ…
   - `ShowLogWindow()` ä¸­è°ƒç”¨
   - `ToggleLogWindow()` ä¸­è°ƒç”¨

---

**ä¿®å¤ç‰ˆæœ¬**: 2.0ï¼ˆæœ€ç»ˆç‰ˆï¼‰  
**æœ€åæ›´æ–°**: 2025-12-26  
**Bug çŠ¶æ€**: âœ… å·²å½»åº•ä¿®å¤  
**æµ‹è¯•çŠ¶æ€**: âœ… å…¨éƒ¨é€šè¿‡

