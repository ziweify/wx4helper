# æ—¥å¿—çª—å£é™„åŠ å¾ªç¯è°ƒç”¨ Bug ä¿®å¤

## ğŸ“… æ—¥æœŸ
2025-12-26

## ğŸ› é—®é¢˜æè¿°

**ç—‡çŠ¶ï¼š** ç‚¹å‡»æµ®åŠ¨æ—¥å¿—çª—å£çš„"ğŸ”’ é™„åŠ "æŒ‰é’®æ—¶ï¼Œç¨‹åºå¡æ­»å¹¶ç›´æ¥é€€å‡ºã€‚

**åŸå› ï¼š** å¾ªç¯è°ƒç”¨å¯¼è‡´æ ˆæº¢å‡º (StackOverflowException)

---

## ğŸ” é—®é¢˜åˆ†æ

### è°ƒç”¨é“¾è·¯ï¼ˆé—®é¢˜ç‰ˆæœ¬ï¼‰

```
ç”¨æˆ·ç‚¹å‡»"ğŸ”’ é™„åŠ "æŒ‰é’®
    â†“
LogWindow.BtnDetach_Click()
    â†“
è§¦å‘ AttachRequested äº‹ä»¶
    â†“
MainTabs.LogWindow_AttachRequested()
    â†“
MainTabs.AttachLogWindow()
    â†“
_floatingLogWindow.Close()  â† å…³é”®ç‚¹
    â†“
è§¦å‘ FormClosing äº‹ä»¶
    â†“
FloatingLogWindow.FloatingLogWindow_FormClosing()
    â†“
_onClosing?.Invoke()
    â†“
MainTabs.AttachLogWindow()  â† åˆå›åˆ°è¿™é‡Œï¼
    â†“
_floatingLogWindow.Close()  â† å¾ªç¯å¼€å§‹
    â†“
... æ— é™å¾ªç¯ï¼Œæ ˆæº¢å‡ºï¼Œç¨‹åºå´©æºƒ ğŸ’¥
```

### é—®é¢˜æ ¹æº

```csharp
// FloatingLogWindow.cs (é—®é¢˜ç‰ˆæœ¬)
private void FloatingLogWindow_FormClosing(object? sender, FormClosingEventArgs e)
{
    // âŒ é—®é¢˜ï¼šæ— è®ºè°è§¦å‘ Close()ï¼Œéƒ½ä¼šè°ƒç”¨ _onClosing
    _onClosing?.Invoke();
}
```

```csharp
// MainTabs.cs (é—®é¢˜ç‰ˆæœ¬)
private void AttachLogWindow()
{
    // ...
    _floatingLogWindow.Close(); // â† è§¦å‘ FormClosing â†’ è°ƒç”¨ _onClosing â†’ åˆè°ƒç”¨ AttachLogWindow()
    // âŒ æ­»å¾ªç¯ï¼
}
```

---

## âœ… è§£å†³æ–¹æ¡ˆ

### æ ¸å¿ƒæ€è·¯ï¼š**æ·»åŠ æ ‡å¿—ä½é˜²æ­¢é‡å¤è°ƒç”¨**

åœ¨ `FloatingLogWindow` ä¸­æ·»åŠ  `_isAttaching` æ ‡å¿—ä½ï¼Œåœ¨é™„åŠ æ“ä½œæ—¶è®¾ç½®ä¸º `true`ï¼Œé˜»æ­¢ `FormClosing` äº‹ä»¶å†æ¬¡è°ƒç”¨ `_onClosing`ã€‚

---

## ğŸ”§ ä¿®å¤ä»£ç 

### 1. FloatingLogWindow.cs

#### æ·»åŠ æ ‡å¿—ä½å­—æ®µ

```csharp
public partial class FloatingLogWindow : Form
{
    private readonly LogWindow _logWindow;
    private readonly Action? _onClosing;
    private bool _isAttaching = false; // ğŸ”¥ é˜²æ­¢å¾ªç¯è°ƒç”¨çš„æ ‡å¿—ä½

    // ...
}
```

#### ä¿®æ”¹ FormClosing äº‹ä»¶å¤„ç†

```csharp
private void FloatingLogWindow_FormClosing(object? sender, FormClosingEventArgs e)
{
    // ğŸ”¥ å¦‚æœæ˜¯é™„åŠ æ“ä½œè§¦å‘çš„å…³é—­ï¼Œä¸å†é‡å¤è°ƒç”¨
    if (_isAttaching)
    {
        return;
    }

    // é€šçŸ¥ä¸»çª—å£ï¼Œæ—¥å¿—çª—å£å³å°†å…³é—­ï¼ˆé™„åŠ å›ä¸»çª—å£ï¼‰
    _onClosing?.Invoke();
}
```

#### æ·»åŠ å…¬å¼€æ–¹æ³•

```csharp
/// <summary>
/// æ ‡è®°ä¸ºæ­£åœ¨é™„åŠ ï¼Œé˜²æ­¢ FormClosing äº‹ä»¶é‡å¤è°ƒç”¨
/// </summary>
public void MarkAsAttaching()
{
    _isAttaching = true;
}
```

---

### 2. MainTabs.cs

#### ä¿®æ”¹ AttachLogWindow æ–¹æ³•

```csharp
private void AttachLogWindow()
{
    try
    {
        if (_floatingLogWindow != null && !_floatingLogWindow.IsDisposed)
        {
            // ğŸ”¥ å…³é”®ï¼šæ ‡è®°ä¸ºæ­£åœ¨é™„åŠ ï¼Œé˜²æ­¢ FormClosing äº‹ä»¶é‡å¤è°ƒç”¨
            _floatingLogWindow.MarkAsAttaching();

            // ä»æµ®åŠ¨çª—å£ç§»é™¤ logWindow1
            if (logWindow1 != null && _floatingLogWindow.Controls.Contains(logWindow1))
            {
                _floatingLogWindow.Controls.Remove(logWindow1);
            }

            // å…³é—­æµ®åŠ¨çª—å£ï¼ˆæ­¤æ—¶ FormClosing ä¸ä¼šå†è°ƒç”¨ _onClosingï¼‰
            _floatingLogWindow.Close();
            _floatingLogWindow.Dispose();
            _floatingLogWindow = null;
        }

        // é™„åŠ å›ä¸»çª—å£
        if (logWindow1 != null && !splitContainerControl1.Panel2.Controls.Contains(logWindow1))
        {
            logWindow1.Dock = DockStyle.Fill;
            splitContainerControl1.Panel2.Controls.Add(logWindow1);
        }

        // æ˜¾ç¤ºä¸»çª—å£çš„æ—¥å¿—é¢æ¿
        ShowLogWindow();

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        logWindow1?.SetDetachedState(false);

        _loggingService.Info("ä¸»çª—å£", "æ—¥å¿—çª—å£å·²é™„åŠ ");
    }
    catch (Exception ex)
    {
        _loggingService.Error("ä¸»çª—å£", $"é™„åŠ æ—¥å¿—çª—å£å¤±è´¥: {ex.Message}", ex);
        MessageBox.Show($"é™„åŠ æ—¥å¿—çª—å£å¤±è´¥:\n{ex.Message}", "é”™è¯¯", 
            MessageBoxButtons.OK, MessageBoxIcon.Error);
    }
}
```

---

## ğŸ¯ ä¿®å¤åçš„è°ƒç”¨é“¾è·¯

### åœºæ™¯ 1ï¼šç‚¹å‡»"ğŸ”’ é™„åŠ "æŒ‰é’®

```
ç”¨æˆ·ç‚¹å‡»"ğŸ”’ é™„åŠ "æŒ‰é’®
    â†“
LogWindow.BtnDetach_Click()
    â†“
è§¦å‘ AttachRequested äº‹ä»¶
    â†“
MainTabs.LogWindow_AttachRequested()
    â†“
MainTabs.AttachLogWindow()
    â†“
_floatingLogWindow.MarkAsAttaching()  â† ğŸ”¥ è®¾ç½® _isAttaching = true
    â†“
_floatingLogWindow.Close()
    â†“
è§¦å‘ FormClosing äº‹ä»¶
    â†“
FloatingLogWindow.FloatingLogWindow_FormClosing()
    â†“
if (_isAttaching) return;  â† ğŸ”¥ æ£€æŸ¥æ ‡å¿—ä½ï¼Œç›´æ¥è¿”å›ï¼Œä¸å†è°ƒç”¨ _onClosing
    â†“
âœ… æ­£å¸¸å…³é—­ï¼Œæ— å¾ªç¯è°ƒç”¨
```

### åœºæ™¯ 2ï¼šç‚¹å‡»çª—å£å…³é—­æŒ‰é’® (X)

```
ç”¨æˆ·ç‚¹å‡»æµ®åŠ¨çª—å£çš„ [X] æŒ‰é’®
    â†“
è§¦å‘ FormClosing äº‹ä»¶
    â†“
FloatingLogWindow.FloatingLogWindow_FormClosing()
    â†“
if (_isAttaching) return;  â† _isAttaching = falseï¼Œä¸æ»¡è¶³æ¡ä»¶
    â†“
_onClosing?.Invoke()  â† æ­£å¸¸è°ƒç”¨
    â†“
MainTabs.AttachLogWindow()
    â†“
_floatingLogWindow.MarkAsAttaching()  â† ğŸ”¥ è®¾ç½® _isAttaching = true
    â†“
_floatingLogWindow.Close()  â† å†æ¬¡è§¦å‘ FormClosing
    â†“
if (_isAttaching) return;  â† ğŸ”¥ æ­¤æ—¶æ»¡è¶³æ¡ä»¶ï¼Œç›´æ¥è¿”å›
    â†“
âœ… æ­£å¸¸å…³é—­ï¼Œæ— å¾ªç¯è°ƒç”¨
```

---

## ğŸ“Š å¯¹æ¯”æ€»ç»“

| è§¦å‘æ–¹å¼ | ä¿®å¤å‰ | ä¿®å¤å |
|---------|-------|--------|
| ç‚¹å‡»"é™„åŠ "æŒ‰é’® | âŒ å¾ªç¯è°ƒç”¨ â†’ å´©æºƒ | âœ… æ­£å¸¸é™„åŠ  |
| ç‚¹å‡»çª—å£ [X] | âŒ å¾ªç¯è°ƒç”¨ â†’ å´©æºƒ | âœ… æ­£å¸¸é™„åŠ  |
| Alt+F4 å…³é—­ | âŒ å¾ªç¯è°ƒç”¨ â†’ å´©æºƒ | âœ… æ­£å¸¸é™„åŠ  |

---

## ğŸ§ª æµ‹è¯•æ¸…å•

- [x] ç‚¹å‡»"ğŸ”’ é™„åŠ "æŒ‰é’®ï¼Œæ­£å¸¸é™„åŠ ï¼Œæ— å¡æ­»
- [x] ç‚¹å‡»æµ®åŠ¨çª—å£ [X] æŒ‰é’®ï¼Œæ­£å¸¸é™„åŠ ï¼Œæ— å¡æ­»
- [x] Alt+F4 å…³é—­æµ®åŠ¨çª—å£ï¼Œæ­£å¸¸é™„åŠ ï¼Œæ— å¡æ­»
- [x] æ—¥å¿—æ•°æ®å®Œæ•´ä¿ç•™
- [x] è¿‡æ»¤æ¡ä»¶ä¿æŒä¸å˜
- [x] æŒ‰é’®çŠ¶æ€æ­£ç¡®åˆ‡æ¢
- [x] ä¸»çª—å£æ—¥å¿—é¢æ¿æ­£å¸¸æ˜¾ç¤º

---

## ğŸ’¡ è®¾è®¡æ¨¡å¼ï¼š**é˜²å¾¡æ€§ç¼–ç¨‹**

### æ ¸å¿ƒåŸåˆ™
1. **å‡è®¾æ‰€æœ‰å›è°ƒéƒ½å¯èƒ½é‡å…¥**
2. **ä½¿ç”¨æ ‡å¿—ä½é˜²æ­¢å¾ªç¯è°ƒç”¨**
3. **å…³é”®æ“ä½œå‰å…ˆè®¾ç½®çŠ¶æ€**

### ç±»ä¼¼åº”ç”¨åœºæ™¯
- çª—å£å…³é—­äº‹ä»¶ï¼ˆFormClosing/FormClosedï¼‰
- æ–‡æœ¬æ¡†å€¼å˜æ›´äº‹ä»¶ï¼ˆTextChangedï¼‰
- ComboBox é€‰æ‹©å˜æ›´äº‹ä»¶ï¼ˆSelectedIndexChangedï¼‰
- ä»»ä½•å¯èƒ½è§¦å‘è‡ªèº«çš„äº‹ä»¶

---

## ğŸ“š ç›¸å…³çŸ¥è¯†

### StackOverflowException
- **å®šä¹‰**: æ ˆæº¢å‡ºå¼‚å¸¸ï¼Œé€šå¸¸ç”±æ— é™é€’å½’æˆ–æ·±åº¦é€’å½’å¯¼è‡´
- **ç‰¹ç‚¹**: .NET Framework æ— æ³•æ•è·æ­¤å¼‚å¸¸ï¼Œç¨‹åºä¼šç›´æ¥å´©æºƒ
- **é¢„é˜²**: ä½¿ç”¨æ ‡å¿—ä½ã€é¿å…é€’å½’ã€å¢åŠ è¾¹ç•Œæ¡ä»¶

### FormClosing vs FormClosed
- **FormClosing**: çª—å£å³å°†å…³é—­ï¼Œå¯å–æ¶ˆï¼ˆe.Cancel = trueï¼‰
- **FormClosed**: çª—å£å·²å…³é—­ï¼Œä¸å¯å–æ¶ˆ
- **é€‰æ‹©**: éœ€è¦æ¸…ç†æ“ä½œæ—¶ç”¨ FormClosing

---

## âœ… ä¿®å¤çŠ¶æ€

- [x] ä»£ç ä¿®å¤å®Œæˆ
- [x] ç¼–è¯‘é€šè¿‡ï¼Œæ— é”™è¯¯
- [x] é€»è¾‘éªŒè¯å®Œæˆ
- [x] æ–‡æ¡£å·²æ›´æ–°

---

**ä¿®å¤ç‰ˆæœ¬**: 1.1  
**æœ€åæ›´æ–°**: 2025-12-26  
**Bug çŠ¶æ€**: âœ… å·²ä¿®å¤

