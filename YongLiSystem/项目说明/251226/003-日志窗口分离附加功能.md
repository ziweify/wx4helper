# 日志窗口分离/附加功能

## 📅 日期
2025-12-26

## 🎯 功能说明
实现类似 Visual Studio 的日志窗口分离/附加功能，允许用户将日志窗口从主窗口分离成独立窗口，方便查看大量日志。关闭浮动窗口时，自动附加回主窗口。

---

## ✨ 功能特点

### 1. **分离 (Detach)** 🔓
- 点击日志窗口工具栏的"🔓 分离"按钮
- 日志窗口从主窗口底部分离
- 弹出独立的浮动日志窗口
- 主窗口日志面板自动隐藏

### 2. **附加 (Attach)** 🔒
- **方式 1**: 点击浮动窗口工具栏的"🔒 附加"按钮
- **方式 2**: 关闭浮动日志窗口（自动附加）
- 日志窗口回到主窗口底部
- 主窗口日志面板自动显示

### 3. **状态保持** 💾
- 过滤条件保持（模块/级别/搜索）
- 滚动位置保持
- 暂停/继续状态保持
- 分离前后数据无缝衔接

---

## 🏗️ 技术实现

### 架构设计

```
MainTabs (主窗口)
    ├── SplitContainer.Panel2
    │   └── logWindow1 (日志控件) ← 默认位置
    │
    └── FloatingLogWindow (浮动窗口) ← 分离后
            └── logWindow1 (日志控件移动到这里)
```

### 核心类

#### 1. **FloatingLogWindow** (新增)
**文件**: `永利系统/Views/FloatingLogWindow.cs`

```csharp
/// <summary>
/// 浮动日志窗口 - 可以从主窗口分离的独立日志窗口
/// </summary>
public partial class FloatingLogWindow : Form
{
    private readonly LogWindow _logWindow;
    private readonly Action? _onClosing;

    public FloatingLogWindow(LogWindow logWindow, Action? onClosing = null)
    {
        _logWindow = logWindow;
        _onClosing = onClosing;
        
        // 设置窗口属性
        this.Text = "📋 日志查看器";
        this.Size = new Size(1200, 600);
        this.MinimumSize = new Size(800, 400);
        this.StartPosition = FormStartPosition.CenterScreen;
        
        // 添加日志控件
        _logWindow.Dock = DockStyle.Fill;
        this.Controls.Add(_logWindow);
    }
    
    private void FloatingLogWindow_FormClosing(...)
    {
        // 通知主窗口，自动附加回去
        _onClosing?.Invoke();
    }
}
```

#### 2. **LogWindow** (增强)
**文件**: `永利系统/Views/LogWindow.cs`

**新增事件：**
```csharp
public event EventHandler? DetachRequested; // 分离请求
public event EventHandler? AttachRequested; // 附加请求
```

**新增按钮：**
```csharp
_btnDetach = new SimpleButton
{
    Location = new Point(635, 5),
    Width = 80,
    Text = "🔓 分离"
};
_btnDetach.Click += BtnDetach_Click;
```

**状态管理：**
```csharp
public void SetDetachedState(bool isDetached)
{
    _isDetached = isDetached;
    _btnDetach.Text = isDetached ? "🔒 附加" : "🔓 分离";
}
```

#### 3. **MainTabs** (增强)
**文件**: `永利系统/Views/MainTabs.cs`

**新增字段：**
```csharp
private FloatingLogWindow? _floatingLogWindow; // 浮动日志窗口
```

**初始化订阅：**
```csharp
private void InitializeLogging()
{
    // 订阅日志窗口的分离/附加事件
    logWindow1.DetachRequested += LogWindow_DetachRequested;
    logWindow1.AttachRequested += LogWindow_AttachRequested;
}
```

**分离逻辑：**
```csharp
private void LogWindow_DetachRequested(object? sender, EventArgs e)
{
    // 1. 从主窗口移除 logWindow1
    splitContainerControl1.Panel2.Controls.Remove(logWindow1);
    
    // 2. 隐藏主窗口日志面板
    splitContainerControl1.PanelVisibility = ...Panel1;
    
    // 3. 创建浮动窗口
    _floatingLogWindow = new FloatingLogWindow(logWindow1, () => {
        AttachLogWindow(); // 关闭时自动附加
    });
    _floatingLogWindow.Show();
    
    // 4. 更新按钮状态
    logWindow1.SetDetachedState(true);
}
```

**附加逻辑：**
```csharp
private void AttachLogWindow()
{
    // 1. 从浮动窗口移除 logWindow1
    _floatingLogWindow.Controls.Remove(logWindow1);
    
    // 2. 关闭浮动窗口
    _floatingLogWindow.Close();
    
    // 3. 附加回主窗口
    logWindow1.Dock = DockStyle.Fill;
    splitContainerControl1.Panel2.Controls.Add(logWindow1);
    
    // 4. 显示主窗口日志面板
    ShowLogWindow();
    
    // 5. 更新按钮状态
    logWindow1.SetDetachedState(false);
}
```

---

## 🎬 使用流程

### 场景 1：分离日志窗口

```
1. 用户点击微信助手工具栏"日志"按钮
   ↓
2. 主窗口底部显示日志面板（过滤"微信助手"）
   ↓
3. 用户点击日志窗口工具栏的"🔓 分离"按钮
   ↓
4. 弹出独立的浮动日志窗口（1200x600）
   ↓
5. 主窗口日志面板自动隐藏
   ↓
6. 按钮变为"🔒 附加"
```

### 场景 2：附加日志窗口

**方式 A：点击附加按钮**
```
1. 用户在浮动日志窗口点击"🔒 附加"按钮
   ↓
2. 浮动窗口关闭
   ↓
3. 日志面板回到主窗口底部
   ↓
4. 按钮变为"🔓 分离"
```

**方式 B：关闭浮动窗口（推荐）**
```
1. 用户点击浮动窗口的关闭按钮 (X)
   ↓
2. 自动触发附加逻辑
   ↓
3. 日志面板回到主窗口底部
```

---

## 🎨 UI 效果

### 主窗口日志面板
```
┌──────────────────────────────────────────────────────┐
│ 主窗口内容区域                                        │
│                                                       │
├──────────────────────────────────────────────────────┤
│ [模块▼] [级别▼] [搜索] [清空][暂停][导出][🔓分离]    │ ← 工具栏
├──────────────────────────────────────────────────────┤
│ 日志表格区域                                          │
└──────────────────────────────────────────────────────┘
```

### 浮动日志窗口
```
┌──────────────────────────────────────────────────────┐
│ 📋 日志查看器                                [─][□][✕]│
├──────────────────────────────────────────────────────┤
│ [模块▼] [级别▼] [搜索] [清空][暂停][导出][🔒附加]    │ ← 按钮变化
├──────────────────────────────────────────────────────┤
│                                                       │
│ 日志表格区域 (更大的显示空间)                         │
│                                                       │
│                                                       │
│                                                       │
└──────────────────────────────────────────────────────┘
尺寸: 1200 x 600 (可调整，最小 800 x 400)
```

---

## 💡 优势

### 1. **更好的日志查看体验** 📊
- 独立窗口，更大的显示空间
- 可以调整窗口大小
- 可以移动到第二屏幕

### 2. **灵活的工作方式** 🔄
- 主窗口和日志窗口同时可见
- 边操作边查看日志
- 类似 VS 的专业体验

### 3. **智能的状态管理** 🧠
- 过滤条件不丢失
- 暂停状态保持
- 关闭自动附加，不会丢失

### 4. **无缝切换** ⚡
- 分离/附加瞬间完成
- 控件复用，无需重新创建
- 数据连续，无需重新加载

---

## 🔧 实现细节

### 控件移动机制

```csharp
// 分离：从 Panel2 移到 FloatingLogWindow
splitContainerControl1.Panel2.Controls.Remove(logWindow1);
_floatingLogWindow.Controls.Add(logWindow1);

// 附加：从 FloatingLogWindow 移回 Panel2
_floatingLogWindow.Controls.Remove(logWindow1);
splitContainerControl1.Panel2.Controls.Add(logWindow1);
```

### 关键点
1. **控件复用**：`logWindow1` 是同一个实例，只是改变父容器
2. **事件保持**：`DetachRequested/AttachRequested` 事件始终有效
3. **状态同步**：`SetDetachedState()` 确保按钮文本正确
4. **自动附加**：浮动窗口关闭时自动调用 `_onClosing` 回调

---

## 🎯 扩展功能（未来）

### 可选增强
1. **记住窗口位置** 💾
   - 保存浮动窗口的位置和大小
   - 下次分离时恢复上次的位置

2. **多屏支持** 🖥️
   - 检测多屏环境
   - 智能选择显示屏幕

3. **快捷键** ⌨️
   - `Ctrl+D`: 分离/附加切换
   - `F12`: 切换日志面板显示

4. **透明度调整** 🔆
   - 浮动窗口支持透明度
   - 便于同时查看背后内容

5. **置顶选项** 📌
   - 浮动窗口可设置为 TopMost
   - 始终在最前面显示

---

## ⚠️ 注意事项

### 1. 控件所有权
- `logWindow1` 始终属于一个父容器
- 移动时必须先 Remove 再 Add
- Dispose 时注意不要重复释放

### 2. 事件订阅
- 分离/附加事件在 `InitializeLogging` 中订阅
- 窗口销毁时会自动取消订阅（通过 Dispose）

### 3. 状态一致性
- 浮动窗口关闭 = 附加回主窗口
- 不存在"丢失日志窗口"的情况
- 按钮状态始终反映当前状态

---

## 🧪 测试清单

- [x] 点击"分离"按钮，弹出浮动窗口
- [x] 主窗口日志面板自动隐藏
- [x] 浮动窗口显示所有日志（保持过滤）
- [x] 浮动窗口可调整大小
- [x] 浮动窗口可移动
- [x] 点击"附加"按钮，窗口关闭并附加回主窗口
- [x] 关闭浮动窗口(X)，自动附加回主窗口
- [x] 主窗口日志面板自动显示
- [x] 过滤条件保持不变
- [x] 日志数据完整无丢失
- [x] 按钮文本正确切换（分离↔附加）

---

## 📚 相关文件

- `永利系统/Views/FloatingLogWindow.cs` - 浮动日志窗口（新增）
- `永利系统/Views/LogWindow.cs` - 日志控件（增强）
- `永利系统/Views/MainTabs.cs` - 主窗口（增强）

---

## 🎉 效果预览

### 分离前（主窗口底部）
- 日志面板高度固定 250px
- 占用主窗口空间

### 分离后（独立窗口）
- 窗口尺寸 1200x600
- 可最大化、调整大小
- 主窗口空间全部用于内容

### 类似体验
- Visual Studio 的输出窗口
- Chrome DevTools 的 Console 面板
- WebStorm 的 Run/Debug 窗口

---

**文档版本**: 1.0  
**最后更新**: 2025-12-26  
**实现状态**: ✅ 已完成

