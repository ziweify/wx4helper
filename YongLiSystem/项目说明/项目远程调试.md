# Visual Studio 远程开发与调试指南

## 📅 文档信息
- **创建日期**: 2025-12-26
- **适用项目**: 永利系统 (.NET 8 WinForms)
- **适用场景**: 代码在本地，程序在远程运行，需要远程调试

---

## 📋 目录
- [方案概览](#方案概览)
- [方案1：Remote Debugger（推荐）](#方案1remote-debugger推荐)
- [方案2：VS Code Remote SSH](#方案2vs-code-remote-ssh)
- [方案3：Remote Desktop](#方案3remote-desktop)
- [快速开始（5分钟）](#快速开始5分钟)
- [自动化脚本](#自动化脚本)
- [常见问题](#常见问题)

---

## 方案概览

### 对比表格

| 方案 | 代码位置 | 运行位置 | 调试位置 | 网络要求 | 适用场景 |
|------|---------|---------|---------|---------|---------|
| **Remote Debugger** | 本地 | 远程 | 本地 | 中等 | ⭐ WinForms 远程调试 |
| VS Code SSH | 远程 | 远程 | 本地 | 低 | Linux/.NET Core |
| RDP | 远程 | 远程 | 远程 | 高 | 完整远程开发 |
| 本地虚拟机 | 本地 | VM | 本地 | 无 | 本地测试环境 |

### 推荐方案

**针对永利系统项目，推荐使用 Remote Debugger + 自动部署脚本**

**优点：**
- ✅ 代码在本地编辑（快速、低延迟）
- ✅ 程序在远程运行（真实环境）
- ✅ 调试在本地进行（完整断点、变量查看）
- ✅ 一键部署和调试
- ✅ 无需在远程机器安装完整 Visual Studio

---

## 方案1：Remote Debugger（推荐）

### 适用场景
- 代码在本地开发
- 程序在远程 Windows 机器上运行
- 需要远程调试（断点、单步执行、变量查看）
- 远程机器不需要安装完整的 Visual Studio

### 架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        本地开发机器                          │
├─────────────────────────────────────────────────────────────┤
│  Visual Studio 2022                                         │
│    ├─ 代码编辑                                              │
│    ├─ 项目编译                                              │
│    └─ 调试器 (Debugger)                                     │
│         ↓                                                   │
│    通过网络连接 (TCP 4024)                                   │
└─────────────────────────────────────────────────────────────┘
                            ↓
                    网络连接 (LAN/VPN)
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                        远程机器                              │
├─────────────────────────────────────────────────────────────┤
│  Remote Debugger (msvsmon.exe)                              │
│    ├─ 监听调试请求                                          │
│    ├─ 控制程序执行                                          │
│    └─ 返回调试信息                                          │
│                                                             │
│  永利系统.exe (运行中)                                       │
│    └─ 被 Remote Debugger 控制                               │
└─────────────────────────────────────────────────────────────┘
```

---

### 步骤 1：远程机器配置

#### 1.1 下载 Remote Tools

**方式 A：官方下载**
```
https://visualstudio.microsoft.com/downloads/
→ 滚动到底部 "用于 Visual Studio 2022 的远程工具"
→ 下载 x64 版本
```

**方式 B：从本地 VS 复制**
```
从本地 Visual Studio 安装目录复制整个文件夹：
C:\Program Files\Microsoft Visual Studio\2022\Enterprise\Common7\IDE\Remote Debugger\

复制到远程机器的任意位置，如：
C:\Program Files (x86)\Microsoft Visual Studio\2022\Remote Debugger\
```

#### 1.2 安装 Remote Tools

**使用安装包：**
```
双击 RemoteTools.amd64ret.enu.exe
→ 按默认选项安装
→ 完成
```

**或使用 xcopy 部署：**
```powershell
# 在远程机器上
xcopy /E /I "\\本地机器\共享\Remote Debugger" "C:\Program Files (x86)\Microsoft Visual Studio\2022\Remote Debugger"
```

#### 1.3 配置 Windows 防火墙

**方法 A：使用配置向导（推荐）**
```
1. 运行 "Remote Debugger Configuration Wizard"
   路径: C:\Program Files (x86)\Microsoft Visual Studio\2022\Remote Debugger\rdbgwiz.exe

2. 选择配置选项：
   ☑ Configure the Remote Debugging Monitor
   ☐ Run the Remote Debugging Monitor as a service (如果需要开机自启，勾选此项)

3. 配置防火墙：
   ☑ Configure Windows Firewall to allow Remote Debugging

4. 完成配置
```

**方法 B：手动配置防火墙**

```powershell
# 以管理员身份运行 PowerShell

# 方式1：允许程序通过防火墙
New-NetFirewallRule -DisplayName "VS Remote Debugger" `
    -Direction Inbound `
    -Program "C:\Program Files (x86)\Microsoft Visual Studio\2022\Remote Debugger\x64\msvsmon.exe" `
    -Action Allow

# 方式2：打开端口
New-NetFirewallRule -DisplayName "VS Remote Debugger Port" `
    -Direction Inbound `
    -LocalPort 4024,4025 `
    -Protocol TCP `
    -Action Allow
```

#### 1.4 启动 Remote Debugger

**方法 A：手动启动（推荐用于开发）**

```powershell
# 以管理员身份运行
& "C:\Program Files (x86)\Microsoft Visual Studio\2022\Remote Debugger\x64\msvsmon.exe"

# 或双击运行
# C:\Program Files (x86)\Microsoft Visual Studio\2022\Remote Debugger\x64\msvsmon.exe
```

**启动后的界面：**
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  Visual Studio 2022 Remote Debugger
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  服务器名称: REMOTE-PC:4024
  
  状态: 正在等待连接...
  
  选项:
    ☑ 允许任何用户调试
    ☐ 不允许未经身份验证的用户
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

**方法 B：作为服务运行（用于生产环境）**

```powershell
# 安装服务
& "C:\Program Files (x86)\Microsoft Visual Studio\2022\Remote Debugger\x64\msvsmon.exe" /install

# 启动服务
Start-Service -Name "Remote Debugger"

# 设置开机自启
Set-Service -Name "Remote Debugger" -StartupType Automatic
```

#### 1.5 关键配置选项

**身份验证模式：**

| 模式 | 安全性 | 适用场景 |
|------|-------|---------|
| **Windows 身份验证** | 高 | 生产环境、域环境 |
| **无身份验证** | 低 | 开发环境、局域网 |

**配置建议（开发环境）：**
```
工具 → 选项：
  ☑ 允许任何用户调试
  ☑ 无身份验证（仅限 Windows 身份验证不可用时）
  ☐ 不显示警告对话框
```

---

### 步骤 2：本地 Visual Studio 配置

#### 2.1 方法 A：附加到进程（灵活）

**适用场景：** 程序已在远程运行，需要临时调试

**操作步骤：**

```
1. 在 Visual Studio 中打开永利系统项目

2. 菜单：调试 → 附加到进程 (Ctrl+Alt+P)

3. 配置连接：
   连接类型: 远程 (无身份验证)
   连接目标: 192.168.1.100:4024
   
   (替换为实际的远程机器 IP)

4. 点击"刷新"按钮，查找进程

5. 在进程列表中找到：永利系统.exe

6. 选中进程，点击"附加"

7. 选择代码类型：
   ☑ 托管代码 (.NET Core, .NET 5+)

8. 开始调试！
```

**快捷配置：**
```
在"连接目标"框中，可以保存常用的远程机器：
- 192.168.1.100:4024
- REMOTE-PC:4024
- testserver.local:4024
```

#### 2.2 方法 B：配置启动项（自动化）

**适用场景：** 频繁远程调试，需要自动化

**步骤 1：创建启动配置**

```
1. 在解决方案资源管理器中，右键点击"永利系统"项目

2. 属性 → 调试 → 常规

3. 点击"打开调试启动配置 UI"

4. 点击"创建新配置" → "远程计算机"

5. 配置参数：
   名称: 远程调试 - 测试服务器
   远程计算机: 192.168.1.100:4024
   工作目录: C:\RemoteApp\永利系统
   身份验证模式: 无身份验证
```

**步骤 2：修改 launchSettings.json**

在 `永利系统/Properties/launchSettings.json` 中添加：

```json
{
  "profiles": {
    "本地调试": {
      "commandName": "Project"
    },
    "远程调试 - 测试服务器": {
      "commandName": "RemoteDebugger",
      "remoteDebugMachine": "192.168.1.100:4024",
      "remoteDebugProgram": "C:\\RemoteApp\\永利系统\\永利系统.exe",
      "authenticationMode": "None"
    }
  }
}
```

**步骤 3：使用配置**

```
1. 在 Visual Studio 工具栏，找到启动配置下拉框
   (默认显示 "永利系统" 或 "IIS Express")

2. 选择 "远程调试 - 测试服务器"

3. 按 F5 开始调试
```

#### 2.3 符号（.pdb）文件配置

**确保符号文件正确加载：**

```
调试 → 选项 → 调试 → 符号：

1. 符号文件(.pdb)位置：
   ☑ Microsoft 符号服务器
   ☑ 指定路径: C:\Symbols (本地符号缓存)

2. 模块加载设置：
   ○ 加载所有模块，除非排除
   ○ 仅加载指定的模块

   推荐：加载所有模块（开发阶段）

3. 源服务器支持：
   ☐ 启用源服务器支持 (可选)
```

**确保部署了 .pdb 文件：**
```
部署清单：
  永利系统\bin\Debug\net8.0-windows\
    ├─ 永利系统.exe          ← 可执行文件
    ├─ 永利系统.pdb          ← 符号文件（必需！）
    ├─ 永利系统.dll
    └─ ... (其他依赖)
```

---

### 步骤 3：部署程序到远程

#### 3.1 手动部署（快速测试）

```powershell
# 在本地 PowerShell 中

# 1. 编译项目
cd E:\gitcode\wx4helper
dotnet build ".\永利系统\永利系统.csproj" --configuration Debug

# 2. 复制到远程（使用网络共享）
$RemoteHost = "192.168.1.100"
$RemotePath = "\\$RemoteHost\C$\RemoteApp\永利系统"

# 创建目录
New-Item -Path $RemotePath -ItemType Directory -Force

# 复制文件
Copy-Item -Path ".\永利系统\bin\Debug\net8.0-windows\*" `
          -Destination $RemotePath `
          -Recurse -Force

Write-Host "部署完成！" -ForegroundColor Green
```

#### 3.2 使用 Robocopy（增量部署）

```batch
@echo off
REM deploy.bat - 增量部署脚本

set REMOTE_HOST=192.168.1.100
set REMOTE_PATH=\\%REMOTE_HOST%\C$\RemoteApp\永利系统
set LOCAL_PATH=.\永利系统\bin\Debug\net8.0-windows

echo 正在编译项目...
dotnet build ".\永利系统\永利系统.csproj" --configuration Debug

echo 正在部署到远程机器...
robocopy "%LOCAL_PATH%" "%REMOTE_PATH%" /MIR /Z /W:5 /R:3 /NDL /NJH /NJS

echo 部署完成！
pause
```

**Robocopy 参数说明：**
- `/MIR` - 镜像目录（同步删除）
- `/Z` - 可重启模式（适合大文件）
- `/W:5` - 重试等待 5 秒
- `/R:3` - 重试 3 次
- `/NDL` - 不显示目录列表
- `/NJH /NJS` - 不显示作业头和摘要

#### 3.3 使用 MSBuild 自动部署

**修改 `永利系统.csproj`，添加部署任务：**

```xml
<Project Sdk="Microsoft.NET.Sdk">
  
  <!-- 现有配置 -->
  
  <!-- 远程部署配置 -->
  <PropertyGroup Condition="'$(Configuration)' == 'Debug'">
    <RemoteDeployEnabled>false</RemoteDeployEnabled>
    <RemoteDeployHost>192.168.1.100</RemoteDeployHost>
    <RemoteDeployPath>C$\RemoteApp\永利系统</RemoteDeployPath>
  </PropertyGroup>

  <!-- 编译后自动部署任务 -->
  <Target Name="RemoteDeploy" AfterTargets="Build" Condition="'$(RemoteDeployEnabled)' == 'true'">
    <Message Text="正在部署到远程机器: $(RemoteDeployHost)" Importance="high" />
    
    <ItemGroup>
      <OutputFiles Include="$(OutDir)**\*.*" />
    </ItemGroup>
    
    <Copy SourceFiles="@(OutputFiles)" 
          DestinationFolder="\\$(RemoteDeployHost)\$(RemoteDeployPath)\%(RecursiveDir)" 
          SkipUnchangedFiles="true" />
    
    <Message Text="部署完成！" Importance="high" />
  </Target>
  
</Project>
```

**启用自动部署：**
```powershell
# 临时启用（本次编译）
dotnet build /p:RemoteDeployEnabled=true

# 或修改项目文件，将 RemoteDeployEnabled 设为 true
```

---

### 步骤 4：开始调试

#### 4.1 启动调试会话

**方法 1：附加到进程**
```
1. 在远程机器上运行 永利系统.exe
2. 在本地 VS 中：调试 → 附加到进程
3. 连接到远程机器
4. 选择 永利系统.exe
5. 附加
```

**方法 2：使用启动配置**
```
1. 确保远程机器上的程序已关闭
2. 选择启动配置："远程调试 - 测试服务器"
3. 按 F5
4. VS 会自动启动远程程序并附加调试器
```

#### 4.2 设置断点

```
在本地代码中设置断点：
- 单击代码行左侧边距，或按 F9
- 断点会显示为红色圆点 ●

支持的断点类型：
  ● 行断点
  ◆ 条件断点（右键 → 条件）
  ⚠ 跟踪点（Tracepoint，不中断执行）
```

#### 4.3 调试操作

| 操作 | 快捷键 | 说明 |
|------|-------|------|
| 继续 | F5 | 继续执行到下一个断点 |
| 单步跳过 | F10 | 执行当前行，不进入方法 |
| 单步进入 | F11 | 进入当前方法内部 |
| 单步跳出 | Shift+F11 | 跳出当前方法 |
| 停止调试 | Shift+F5 | 终止调试会话 |
| 重启 | Ctrl+Shift+F5 | 重启程序和调试会话 |

#### 4.4 查看变量

```
方式 1：悬停鼠标
  鼠标悬停在变量上，查看当前值

方式 2：监视窗口
  调试 → 窗口 → 监视 → 监视 1
  输入变量名或表达式

方式 3：即时窗口
  调试 → 窗口 → 即时窗口 (Ctrl+Alt+I)
  输入表达式并按回车

方式 4：局部变量窗口
  调试 → 窗口 → 局部变量
  自动显示当前作用域的所有变量
```

---

## 方案2：VS Code Remote SSH

### 适用场景
- 远程机器是 Linux
- 使用 .NET Core / .NET 5+
- 希望在远程机器上完整开发

### 配置步骤

**1. 安装扩展**
```
在 VS Code 中安装：
- Remote - SSH
- Remote Development
- C# Dev Kit
```

**2. 配置 SSH 连接**
```
1. Ctrl+Shift+P → "Remote-SSH: Connect to Host"
2. 输入: ssh user@remote-host
3. 输入密码或使用 SSH 密钥
4. 连接成功后，选择远程文件夹
```

**3. 在远程安装扩展**
```
在远程 VS Code 中安装：
- C# Dev Kit
- .NET Runtime Install Tool
```

**4. 开始开发**
```
- 所有代码文件在远程
- 编译在远程执行
- 调试在远程执行
- 通过 SSH 隧道同步
```

**注意：** 此方案不适用于 WinForms 项目（需要 Windows 桌面环境）

---

## 方案3：Remote Desktop

### 适用场景
- 简单直接的远程开发
- 需要完整的 GUI 访问
- 网络带宽充足

### 配置步骤

**1. 启用远程桌面（远程机器）**
```powershell
# 以管理员身份运行
Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0

# 允许防火墙
Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

# 添加用户到远程桌面组
Add-LocalGroupMember -Group "Remote Desktop Users" -Member "YourUsername"
```

**2. 连接到远程桌面（本地）**
```
1. Win+R → mstsc
2. 输入远程机器 IP 或主机名
3. 输入用户名和密码
4. 连接
```

**3. 在远程桌面中开发**
```
- 在远程机器上安装 Visual Studio
- 使用 Git 同步代码
- 或使用网络共享访问本地代码
```

**优点：**
- 简单直接
- 完整的 Windows GUI 体验
- 无需额外配置

**缺点：**
- 需要较高网络带宽
- 延迟影响体验
- 需要在远程安装完整 VS

---

## 快速开始（5分钟）

### 快速配置清单

```
┌─────────────────────────────────────────────┐
│ 远程机器准备（3分钟）                        │
├─────────────────────────────────────────────┤
│ ☐ 1. 创建部署目录                           │
│      mkdir C:\RemoteApp\永利系统            │
│                                             │
│ ☐ 2. 安装 Remote Debugger                   │
│      下载并运行 RemoteTools.amd64ret.enu.exe │
│                                             │
│ ☐ 3. 配置防火墙                             │
│      运行 Remote Debugger Configuration     │
│                                             │
│ ☐ 4. 启动 Remote Debugger                   │
│      运行 msvsmon.exe                       │
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│ 本地 VS 配置（2分钟）                        │
├─────────────────────────────────────────────┤
│ ☐ 1. 编译项目 (Ctrl+Shift+B)               │
│                                             │
│ ☐ 2. 部署到远程                             │
│      复制 bin\Debug\net8.0-windows\         │
│      到远程 C:\RemoteApp\永利系统\          │
│                                             │
│ ☐ 3. 附加调试器                             │
│      调试 → 附加到进程 → 远程               │
│                                             │
│ ☐ 4. 开始调试！                             │
└─────────────────────────────────────────────┘
```

### 一键启动脚本（远程）

创建 `start-debug.bat` 在远程机器上：

```batch
@echo off
title 永利系统远程调试环境

echo ====================================
echo   永利系统远程调试环境
echo ====================================
echo.

echo [1/2] 启动 Remote Debugger...
start "Remote Debugger" "C:\Program Files (x86)\Microsoft Visual Studio\2022\Remote Debugger\x64\msvsmon.exe"
timeout /t 3 /nobreak >nul

echo [2/2] 启动永利系统...
cd /d C:\RemoteApp\永利系统
start "永利系统" "永利系统.exe"

echo.
echo ====================================
echo 远程调试环境已启动！
echo.
echo Remote Debugger: 正在运行
echo 永利系统: 正在运行
echo.
echo 现在可以从本地 VS 附加调试器
echo ====================================
pause
```

---

## 自动化脚本

### 完整部署脚本

创建 `Tools\RemoteDeploy.ps1`：

```powershell
<#
.SYNOPSIS
    永利系统远程部署工具
.DESCRIPTION
    自动编译、部署和启动远程调试
.PARAMETER RemoteHost
    远程机器 IP 或主机名
.PARAMETER RemotePath
    远程部署路径（默认: C:\RemoteApp\永利系统）
.PARAMETER AutoStart
    部署后自动启动远程程序
.EXAMPLE
    .\Tools\RemoteDeploy.ps1 -RemoteHost "192.168.1.100"
.EXAMPLE
    .\Tools\RemoteDeploy.ps1 -RemoteHost "192.168.1.100" -AutoStart
#>

param(
    [Parameter(Mandatory=$true, HelpMessage="远程机器 IP 或主机名")]
    [string]$RemoteHost,
    
    [Parameter(HelpMessage="远程部署路径")]
    [string]$RemotePath = "C:\RemoteApp\永利系统",
    
    [Parameter(HelpMessage="程序名称")]
    [string]$ProcessName = "永利系统.exe",
    
    [switch]$AutoStart
)

$ErrorActionPreference = "Stop"
$ProgressPreference = "SilentlyContinue"

# 颜色输出函数
function Write-Step {
    param([string]$Message, [string]$Color = "Cyan")
    Write-Host "`n$Message" -ForegroundColor $Color
}

function Write-Success {
    param([string]$Message)
    Write-Host "  ✓ $Message" -ForegroundColor Green
}

function Write-Warning {
    param([string]$Message)
    Write-Host "  ! $Message" -ForegroundColor Yellow
}

function Write-Error {
    param([string]$Message)
    Write-Host "  ✗ $Message" -ForegroundColor Red
}

# 标题
Clear-Host
Write-Host "========================================" -ForegroundColor Cyan
Write-Host "   永利系统远程部署工具 v1.0" -ForegroundColor Cyan
Write-Host "========================================" -ForegroundColor Cyan
Write-Host "  远程主机: $RemoteHost" -ForegroundColor Yellow
Write-Host "  部署路径: $RemotePath" -ForegroundColor Yellow
Write-Host "========================================`n" -ForegroundColor Cyan

# 步骤 1：编译项目
Write-Step "[1/5] 正在编译项目..." "Green"
try {
    $startTime = Get-Date
    dotnet build ".\永利系统\永利系统.csproj" --configuration Debug --verbosity minimal --nologo
    
    if ($LASTEXITCODE -eq 0) {
        $duration = (Get-Date) - $startTime
        Write-Success "编译成功！耗时: $($duration.TotalSeconds.ToString('0.0'))秒"
    } else {
        Write-Error "编译失败！退出代码: $LASTEXITCODE"
        exit 1
    }
} catch {
    Write-Error "编译异常: $_"
    exit 1
}

# 步骤 2：准备文件
Write-Step "[2/5] 正在准备部署文件..." "Green"
$LocalPath = ".\永利系统\bin\Debug\net8.0-windows\"
$Destination = "\\$RemoteHost\$($RemotePath.Replace(':', '$'))"

$files = Get-ChildItem -Path $LocalPath -Recurse -File
Write-Success "找到 $($files.Count) 个文件待部署"

# 步骤 3：测试网络连接
Write-Step "[3/5] 正在测试网络连接..." "Green"
try {
    $testConnection = Test-Connection -ComputerName $RemoteHost -Count 1 -Quiet
    if ($testConnection) {
        Write-Success "网络连接正常"
    } else {
        Write-Error "无法连接到远程主机: $RemoteHost"
        Write-Warning "请检查："
        Write-Host "    - 远程主机是否在线"
        Write-Host "    - 网络是否畅通"
        Write-Host "    - IP 地址是否正确"
        exit 1
    }
} catch {
    Write-Warning "网络测试失败（可能是防火墙阻止 ICMP），继续尝试部署..."
}

# 步骤 4：停止远程进程
Write-Step "[4/5] 正在停止远程进程（如果正在运行）..." "Green"
try {
    $session = New-PSSession -ComputerName $RemoteHost -ErrorAction Stop
    
    Invoke-Command -Session $session -ScriptBlock {
        param($ProcessName)
        $processBaseName = [System.IO.Path]::GetFileNameWithoutExtension($ProcessName)
        $processes = Get-Process -Name $processBaseName -ErrorAction SilentlyContinue
        
        if ($processes) {
            $processes | Stop-Process -Force
            return "已停止 $($processes.Count) 个进程"
        } else {
            return "无进程运行"
        }
    } -ArgumentList $ProcessName | ForEach-Object {
        Write-Success $_
    }
    
    Remove-PSSession $session
    Start-Sleep -Seconds 1
    
} catch {
    Write-Warning "无法连接到远程主机执行命令: $_"
    Write-Warning "请确保："
    Write-Host "    - 远程主机启用了 PowerShell Remoting"
    Write-Host "    - 当前用户有管理员权限"
    Write-Host "    - 运行以下命令启用 Remoting:"
    Write-Host "      Enable-PSRemoting -Force" -ForegroundColor Yellow
    Write-Warning "继续尝试部署文件..."
}

# 步骤 5：部署文件
Write-Step "[5/5] 正在部署文件到远程机器..." "Green"
try {
    # 测试远程路径
    if (-not (Test-Path $Destination)) {
        Write-Warning "远程目录不存在，正在创建: $Destination"
        New-Item -Path $Destination -ItemType Directory -Force | Out-Null
    }
    
    # 复制文件
    $startTime = Get-Date
    Copy-Item -Path "$LocalPath\*" -Destination $Destination -Recurse -Force
    $duration = (Get-Date) - $startTime
    
    Write-Success "部署成功！耗时: $($duration.TotalSeconds.ToString('0.0'))秒"
    Write-Success "远程路径: $RemotePath"
    
} catch {
    Write-Error "部署失败: $_"
    Write-Warning "`n可能的原因："
    Write-Host "    - 管理共享 (C$) 未启用"
    Write-Host "    - 没有访问权限"
    Write-Host "    - 远程主机防火墙阻止文件共享"
    Write-Host "`n解决方案："
    Write-Host "    1. 在远程机器上启用文件共享"
    Write-Host "    2. 或使用其他共享文件夹"
    Write-Host "    3. 或手动复制文件"
    exit 1
}

# 完成
Write-Host "`n========================================" -ForegroundColor Cyan
Write-Host "  部署完成！" -ForegroundColor Green
Write-Host "========================================" -ForegroundColor Cyan

# 可选：启动远程程序
if ($AutoStart) {
    Write-Step "正在启动远程程序..." "Green"
    
    try {
        $session = New-PSSession -ComputerName $RemoteHost -ErrorAction Stop
        
        Invoke-Command -Session $session -ScriptBlock {
            param($RemotePath, $ProcessName)
            $exePath = Join-Path $RemotePath $ProcessName
            Start-Process -FilePath $exePath -WorkingDirectory $RemotePath
        } -ArgumentList $RemotePath, $ProcessName -AsJob | Out-Null
        
        Remove-PSSession $session
        Start-Sleep -Seconds 2
        
        Write-Success "远程程序已启动"
    } catch {
        Write-Warning "无法启动远程程序: $_"
    }
} else {
    Write-Host "`n是否启动远程程序？(Y/N): " -NoNewline -ForegroundColor Yellow
    $start = Read-Host
    
    if ($start -eq 'Y' -or $start -eq 'y') {
        try {
            $session = New-PSSession -ComputerName $RemoteHost -ErrorAction Stop
            
            Invoke-Command -Session $session -ScriptBlock {
                param($RemotePath, $ProcessName)
                $exePath = Join-Path $RemotePath $ProcessName
                Start-Process -FilePath $exePath -WorkingDirectory $RemotePath
            } -ArgumentList $RemotePath, $ProcessName -AsJob | Out-Null
            
            Remove-PSSession $session
            Start-Sleep -Seconds 2
            
            Write-Success "远程程序已启动"
        } catch {
            Write-Warning "无法启动远程程序: $_"
        }
    }
}

# 提示后续操作
Write-Host "`n========================================" -ForegroundColor Cyan
Write-Host "  后续步骤" -ForegroundColor Yellow
Write-Host "========================================" -ForegroundColor Cyan
Write-Host "1. 在 Visual Studio 中："
Write-Host "   调试 → 附加到进程 (Ctrl+Alt+P)"
Write-Host "`n2. 连接设置："
Write-Host "   连接类型: 远程 (无身份验证)"
Write-Host "   连接目标: ${RemoteHost}:4024"
Write-Host "`n3. 选择进程: $ProcessName"
Write-Host "`n4. 开始调试！"
Write-Host "========================================`n" -ForegroundColor Cyan
```

### 使用方法

```powershell
# 基本用法
.\Tools\RemoteDeploy.ps1 -RemoteHost "192.168.1.100"

# 自动启动远程程序
.\Tools\RemoteDeploy.ps1 -RemoteHost "192.168.1.100" -AutoStart

# 指定远程路径
.\Tools\RemoteDeploy.ps1 -RemoteHost "192.168.1.100" -RemotePath "D:\Apps\永利系统"

# 查看帮助
Get-Help .\Tools\RemoteDeploy.ps1 -Full
```

---

## 常见问题

### Q1: 无法连接到远程调试器

**症状：**
```
无法连接到 Microsoft Visual Studio Remote Debugging Monitor
连接被拒绝
```

**解决方案：**

```powershell
# 1. 检查网络连接
Test-NetConnection -ComputerName 192.168.1.100 -Port 4024

# 2. 检查远程调试器是否运行
# 在远程机器上查看进程
Get-Process -Name msvsmon -ErrorAction SilentlyContinue

# 3. 检查防火墙
Get-NetFirewallRule -DisplayName "*Remote*" | Where-Object {$_.Enabled -eq $true}

# 4. 添加防火墙规则
New-NetFirewallRule -DisplayName "VS Remote Debugger" `
    -Direction Inbound `
    -LocalPort 4024,4025 `
    -Protocol TCP `
    -Action Allow

# 5. 重启 Remote Debugger
Stop-Process -Name msvsmon -Force -ErrorAction SilentlyContinue
Start-Sleep -Seconds 2
& "C:\Program Files (x86)\Microsoft Visual Studio\2022\Remote Debugger\x64\msvsmon.exe"
```

---

### Q2: 找不到远程进程

**症状：**
```
在进程列表中找不到 永利系统.exe
列表为空或没有想要的进程
```

**解决方案：**

```
1. 确认程序正在远程机器上运行
   在远程机器上：任务管理器 → 详细信息 → 找到 永利系统.exe

2. 使用管理员权限启动 msvsmon.exe
   右键 → 以管理员身份运行

3. 更改身份验证模式
   msvsmon.exe → 工具 → 选项 → 无身份验证

4. 刷新进程列表
   点击"附加到进程"对话框中的"刷新"按钮

5. 检查进程架构
   确保选择了正确的架构（x64）
```

---

### Q3: 断点无法命中（灰色空心圆）

**症状：**
```
断点显示为 ⭕ 灰色空心圆
提示："当前不会命中断点。还没有为该文档加载任何符号。"
```

**解决方案：**

```
1. 确保部署的是 Debug 版本
   - 检查远程机器上的文件日期
   - 确认是最新编译的版本

2. 确保 .pdb 文件也部署了
   远程机器应该有：
     C:\RemoteApp\永利系统\永利系统.pdb

3. 手动加载符号
   调试 → 窗口 → 模块
   找到 永利系统.dll → 右键 → 加载符号

4. 检查符号设置
   调试 → 选项 → 调试 → 符号
   ☑ 加载所有模块，除非排除

5. 清理并重新编译
   dotnet clean
   dotnet build --configuration Debug
   重新部署所有文件（包括 .pdb）

6. 检查代码版本是否一致
   本地代码和远程程序必须是相同的版本
```

---

### Q4: 无法访问远程网络共享

**症状：**
```
访问 \\192.168.1.100\C$ 被拒绝
网络路径未找到
```

**解决方案：**

```powershell
# 在远程机器上（以管理员身份运行）

# 1. 启用网络发现和文件共享
Set-NetFirewallRule -DisplayGroup "文件和打印机共享" -Enabled True -Profile Private
Set-NetFirewallRule -DisplayGroup "网络发现" -Enabled True -Profile Private

# 2. 启用管理共享
Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters" `
    -Name "AutoShareWks" -Value 1

# 3. 重启 Server 服务
Restart-Service -Name LanmanServer

# 4. 验证共享
Get-SmbShare

# 替代方案：创建显式共享
New-SmbShare -Name "永利系统" `
    -Path "C:\RemoteApp\永利系统" `
    -FullAccess "Everyone"

# 本地访问路径变为：
# \\192.168.1.100\永利系统
```

---

### Q5: 调试很慢，单步执行延迟

**症状：**
```
每次单步执行都要等待 1-2 秒
变量查看很慢
```

**优化方案：**

```
1. 禁用自动属性求值
   调试 → 选项 → 调试 → 常规
   ☐ 启用属性求值和其他隐式函数调用

2. 减少监视表达式
   删除不必要的监视窗口表达式

3. 禁用诊断工具
   调试 → 选项 → 调试 → 常规
   ☐ 在调试时启用诊断工具

4. 使用条件断点
   而不是频繁的无条件断点

5. 优化网络
   - 使用有线连接而非 WiFi
   - 检查网络延迟: ping -t 192.168.1.100
   - 使用局域网而非 VPN

6. 禁用 IntelliTrace
   调试 → 选项 → IntelliTrace
   ☐ 启用 IntelliTrace
```

---

### Q6: PowerShell Remoting 未启用

**症状：**
```
New-PSSession: 连接到远程服务器失败
WinRM 服务未运行
```

**解决方案：**

```powershell
# 在远程机器上（以管理员身份运行）

# 1. 启用 PowerShell Remoting
Enable-PSRemoting -Force

# 2. 配置 TrustedHosts（如果需要）
Set-Item WSMan:\localhost\Client\TrustedHosts -Value "192.168.1.*" -Force

# 3. 启动 WinRM 服务
Start-Service WinRM
Set-Service -Name WinRM -StartupType Automatic

# 4. 配置防火墙
Enable-PSRemoting -SkipNetworkProfileCheck -Force

# 5. 测试连接
# 在本地机器上
Test-WSMan -ComputerName 192.168.1.100

# 6. 创建会话
$session = New-PSSession -ComputerName 192.168.1.100
Enter-PSSession $session
```

---

### Q7: 远程程序崩溃，无法调试

**症状：**
```
程序在远程机器上崩溃
无法捕获崩溃时的状态
```

**解决方案：**

```
1. 启用崩溃转储
   在远程机器上设置注册表：
   
   HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\Windows Error Reporting\LocalDumps
   
   创建键值：
   - DumpFolder: C:\CrashDumps
   - DumpCount: 10
   - DumpType: 2 (完整转储)

2. 配置 Just-In-Time 调试
   在远程机器上运行：
   
   "C:\Program Files (x86)\Microsoft Visual Studio\2022\Remote Debugger\x64\msvsmon.exe" /anyuser /nosecuritywarn
   
   勾选：工具 → 选项 → Just-In-Time 调试

3. 使用 DebugDiag 工具
   下载: https://www.microsoft.com/en-us/download/details.aspx?id=58210
   配置崩溃监控规则

4. 添加全局异常处理
   在 Program.cs 中添加：
   
   AppDomain.CurrentDomain.UnhandledException += (s, e) => {
       File.WriteAllText(@"C:\crash.log", e.ExceptionObject.ToString());
   };

5. 使用 Application Insights
   添加遥测和崩溃报告
```

---

## 最佳实践

### 开发工作流

```
推荐的日常开发流程：

1. 本地编写代码和单元测试
   ├─ 快速迭代
   ├─ 即时反馈
   └─ 离线工作

2. 定期部署到远程测试
   ├─ 集成测试
   ├─ 性能测试
   └─ 环境兼容性测试

3. 远程调试关键问题
   ├─ 环境相关问题
   ├─ 性能问题
   └─ 数据问题

4. 持续集成/部署
   └─ 自动化构建和部署
```

### 安全建议

```
生产环境配置：

1. 使用 Windows 身份验证
   ☑ msvsmon.exe → 工具 → 选项 → Windows 身份验证

2. 限制允许的用户
   ☐ 允许任何用户调试

3. 使用 VPN 或 SSH 隧道
   而不是直接暴露 4024 端口到公网

4. 定期更新 Remote Tools
   保持与 Visual Studio 版本一致

5. 审计日志
   启用 Windows 事件日志审计
```

### 性能优化

```
1. 使用增量部署
   - Robocopy /MIR
   - 只复制变更的文件

2. 压缩传输
   - 使用压缩的网络协议
   - 或手动压缩后传输大文件

3. 本地符号缓存
   调试 → 选项 → 符号
   符号文件位置: C:\Symbols

4. 减少断点数量
   - 使用条件断点
   - 使用跟踪点而非断点

5. 关闭不必要的调试功能
   - 禁用诊断工具
   - 禁用属性自动求值
```

---

## 附录

### A. Remote Debugger 端口列表

| 端口 | 用途 | 协议 |
|------|------|------|
| 4024 | Remote Debugger 主端口 | TCP |
| 4025 | Discovery 端口 | UDP |
| 135 | RPC 端点映射器 | TCP |
| 445 | SMB 文件共享 | TCP |

### B. 常用命令参考

```powershell
# 编译项目
dotnet build ".\永利系统\永利系统.csproj" --configuration Debug

# 清理项目
dotnet clean ".\永利系统\永利系统.csproj"

# 发布项目（Release 版）
dotnet publish ".\永利系统\永利系统.csproj" --configuration Release --output ".\publish"

# 测试网络连接
Test-NetConnection -ComputerName 192.168.1.100 -Port 4024

# 启动远程会话
$session = New-PSSession -ComputerName 192.168.1.100
Enter-PSSession $session

# 远程执行命令
Invoke-Command -ComputerName 192.168.1.100 -ScriptBlock { Get-Process }

# 复制文件到远程
Copy-Item -Path ".\local\*" -Destination "\\192.168.1.100\C$\remote\" -Recurse
```

### C. 相关链接

- [Visual Studio Remote Debugger 官方文档](https://learn.microsoft.com/en-us/visualstudio/debugger/remote-debugging)
- [下载 Remote Tools](https://visualstudio.microsoft.com/downloads/)
- [配置 Windows 防火墙](https://learn.microsoft.com/en-us/windows/security/operating-system-security/network-security/windows-firewall/)
- [PowerShell Remoting 指南](https://learn.microsoft.com/en-us/powershell/scripting/learn/ps101/08-powershell-remoting)

---

## 更新日志

### v1.0 (2025-12-26)
- 初始版本
- Remote Debugger 配置指南
- VS Code Remote SSH 简介
- RDP 方案说明
- 自动化部署脚本
- 常见问题解答

---

**文档维护**: 开发团队  
**技术支持**: [support@example.com](mailto:support@example.com)  
**最后更新**: 2025-12-26

