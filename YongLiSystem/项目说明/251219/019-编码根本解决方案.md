# PowerShell脚本中文编码问题 - 根本解决方案

**📅 日期**: 2025-12-19  
**🎯 目标**: 解决PowerShell脚本文件中中文字符串的编码问题  
**💡 核心问题**: PowerShell读取.ps1文件时，如果文件没有UTF-8 BOM，会使用系统默认编码（GBK）读取，导致中文乱码

---

## 🔍 问题根源

### 现象
```powershell
# 脚本文件中的代码
$name = "本地DLL引用"

# PowerShell执行时读取到
$name = "鏈湴DLL寮曠敤"  # 乱码！
```

### 原因
1. **文件保存时没有UTF-8 BOM**
   - PowerShell需要BOM来识别UTF-8编码
   - 没有BOM时，使用系统默认编码（Windows通常是GBK/936）

2. **编码转换错误**
   - 文件以UTF-8保存
   - PowerShell以GBK读取
   - UTF-8字节被当作GBK解释 → 乱码

---

## ✅ 解决方案

### 方案1: 确保文件以UTF-8 with BOM保存 ⭐⭐⭐⭐⭐

**最根本的解决方案**

#### 在Cursor/VS Code中设置

1. **设置文件编码为UTF-8 with BOM**
   - 打开文件
   - 右下角点击编码（如"UTF-8"）
   - 选择"通过编码保存" → "UTF-8 with BOM"

2. **设置默认编码**
   ```json
   // settings.json
   {
     "files.encoding": "utf8bom",
     "files.autoGuessEncoding": false
   }
   ```

#### 验证文件是否有BOM

```powershell
# 检查文件前3个字节
$bytes = [System.IO.File]::ReadAllBytes("script.ps1")
$hasBOM = ($bytes[0] -eq 0xEF -and $bytes[1] -eq 0xBB -and $bytes[2] -eq 0xBF)
Write-Host "Has UTF-8 BOM: $hasBOM"
```

**BOM字节**: `EF BB BF` (UTF-8 BOM)

---

### 方案2: 在脚本开头强制设置编码 ⭐⭐⭐⭐

```powershell
# 在脚本最开头添加
$PSDefaultParameterValues['*:Encoding'] = 'utf8'
[Console]::OutputEncoding = [System.Text.Encoding]::UTF8
$OutputEncoding = [System.Text.Encoding]::UTF8
```

**限制**: 这只影响输出编码，不能改变PowerShell读取文件时的编码。

---

### 方案3: 使用Base64编码存储中文 ⭐⭐⭐

**适用于**: 脚本中需要硬编码中文字符串

```powershell
function Decode-UTF8Base64 {
    param([string]$base64)
    $bytes = [System.Convert]::FromBase64String($base64)
    return [System.Text.Encoding]::UTF8.GetString($bytes)
}

# 使用Base64存储中文
$name = Decode-UTF8Base64 "6Y+I7oSA5rm0RExM5a+u5pug5pWk"  # "本地DLL引用"
```

**优势**:
- ✅ Base64只包含ASCII字符，不受文件编码影响
- ✅ 运行时解码，保证正确

**劣势**:
- ❌ 代码可读性差
- ❌ 需要手动编码

---

## 🎯 推荐方案组合

### 最佳实践

1. **文件保存**: UTF-8 with BOM ⭐⭐⭐⭐⭐
   - 这是最根本的解决方案
   - 确保所有.ps1文件都使用UTF-8 with BOM

2. **脚本开头**: 设置编码参数 ⭐⭐⭐⭐
   ```powershell
   $PSDefaultParameterValues['*:Encoding'] = 'utf8'
   [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
   ```

3. **关键字符串**: 使用Base64或外部配置 ⭐⭐⭐
   - 对于重要的中文字符串
   - 如果文件编码仍有问题，使用Base64

---

## 🔧 实际操作步骤

### 步骤1: 检查现有文件编码

```powershell
# 检查文件是否有BOM
function Test-UTF8BOM {
    param([string]$filePath)
    $bytes = [System.IO.File]::ReadAllBytes($filePath)
    return ($bytes.Length -ge 3 -and $bytes[0] -eq 0xEF -and $bytes[1] -eq 0xBB -and $bytes[2] -eq 0xBF)
}

Test-UTF8BOM "script.ps1"
```

### 步骤2: 转换文件为UTF-8 with BOM

**在Cursor/VS Code中**:
1. 打开文件
2. 右下角点击编码
3. "通过编码保存" → "UTF-8 with BOM"
4. 保存

**使用PowerShell**:
```powershell
# 读取文件内容
$content = Get-Content "script.ps1" -Raw -Encoding UTF8
# 添加BOM并保存
$utf8WithBOM = New-Object System.Text.UTF8Encoding $true
[System.IO.File]::WriteAllText("script.ps1", $content, $utf8WithBOM)
```

---

## 💡 总结

### 根本解决方案

**确保所有PowerShell脚本文件以UTF-8 with BOM保存**

这是唯一能从根本上解决问题的方案：
- ✅ 不需要修改代码
- ✅ 不需要使用Base64
- ✅ 不需要外部配置
- ✅ PowerShell能正确识别和读取

### 实施建议

1. **立即行动**: 将所有.ps1文件转换为UTF-8 with BOM
2. **配置编辑器**: 设置默认编码为UTF-8 with BOM
3. **团队规范**: 在项目文档中明确编码要求
4. **验证工具**: 创建检查脚本验证文件编码

---

**文档编号**: 251219-019-编码根本解决方案  
**创建时间**: 2025-12-19  
**重要性**: ⭐⭐⭐⭐⭐ 关键解决方案  
**版本**: v1.0

