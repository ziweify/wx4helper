# è‡ªå®šä¹‰è„šæœ¬ç³»ç»Ÿè®¾è®¡æ–‡æ¡£

**ğŸ“… åˆ›å»ºæ—¥æœŸ**: 2025-01-01  
**ğŸ¯ åŠŸèƒ½**: è‡ªå®šä¹‰è„šæœ¬å’Œæµç¨‹ç³»ç»Ÿï¼Œæ”¯æŒè¿è¡Œæ—¶ç¼–è¾‘ã€è°ƒè¯•  
**ğŸ“ ä½ç½®**: å®šåˆ¶é‡‡é›†ä»»åŠ¡ â†’ è„šæœ¬ç¼–è¾‘å™¨

---

## ğŸ“‹ éœ€æ±‚åˆ†æ

### æ ¸å¿ƒéœ€æ±‚
1. **è‡ªå®šä¹‰è„šæœ¬è¯­è¨€**ï¼šä¸æ˜¯ç®€å•çš„JavaScriptï¼Œè€Œæ˜¯æ”¯æŒè‡ªå®šä¹‰æµç¨‹å’ŒåŠŸèƒ½
2. **è¿è¡Œæ—¶ç¼–è¾‘**ï¼šç”¨æˆ·å¯ä»¥åœ¨è¿è¡Œæ—¶ä¿®æ”¹å’Œè°ƒè¯•è„šæœ¬
3. **ç¼–è¾‘å™¨åŠŸèƒ½**ï¼š
   - âœ… æ–­ç‚¹è°ƒè¯•
   - âœ… è¯­æ³•é«˜äº®
   - âœ… è¯­æ³•é”™è¯¯æ£€æŸ¥
   - âœ… é”™è¯¯æ˜¾ç¤º
   - âœ… åŠŸèƒ½ç»‘å®šï¼ˆç”¨æˆ·å®šä¹‰çš„åŠŸèƒ½ï¼‰
4. **è„šæœ¬è¯­è¨€é€‰æ‹©**ï¼šé™¤äº†Luaï¼Œè¿˜æœ‰å…¶ä»–é€‰æ‹©

---

## ğŸ¯ è„šæœ¬è¯­è¨€é€‰æ‹©åˆ†æ

### æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | æ¨èåº¦ |
|------|------|------|--------|
| **Lua (NLua/MoonSharp)** | âœ… è½»é‡çº§ã€å¿«é€Ÿ<br>âœ… æ˜“äºåµŒå…¥<br>âœ… è°ƒè¯•æ”¯æŒå¥½<br>âœ… è¯­æ³•ç®€å• | âš ï¸ éœ€è¦å­¦ä¹ Luaè¯­æ³• | â­â­â­â­â­ |
| **Python (IronPython)** | âœ… è¯­æ³•å‹å¥½<br>âœ… åŠŸèƒ½å¼ºå¤§<br>âœ… ç”Ÿæ€ä¸°å¯Œ | âŒ æ€§èƒ½ä¸€èˆ¬<br>âŒ è°ƒè¯•æ”¯æŒæœ‰é™<br>âŒ ä¾èµ–è¾ƒå¤§ | â­â­â­ |
| **JavaScript (V8/ChakraCore)** | âœ… ç”¨æˆ·ç†Ÿæ‚‰<br>âœ… æ€§èƒ½å¥½ | âŒ è°ƒè¯•æ”¯æŒå¤æ‚<br>âŒ éœ€è¦é¢å¤–å¼•æ“ | â­â­â­ |
| **C# Script (Roslyn)** | âœ… ç›´æ¥ä½¿ç”¨C#è¯­æ³•<br>âœ… ç±»å‹å®‰å…¨<br>âœ… è°ƒè¯•æ”¯æŒå¥½ | âŒ éœ€è¦ç¼–è¯‘<br>âŒ æ€§èƒ½å¼€é”€ | â­â­â­â­ |
| **è‡ªå®šä¹‰DSL** | âœ… å®Œå…¨å®šåˆ¶<br>âœ… ç¬¦åˆä¸šåŠ¡éœ€æ±‚ | âŒ å¼€å‘æˆæœ¬é«˜<br>âŒ éœ€è¦å®ç°è§£æå™¨ | â­â­ |

### æ¨èæ–¹æ¡ˆï¼š**Lua (MoonSharp)**

**ç†ç”±ï¼š**
1. âœ… **è½»é‡çº§**ï¼šä½“ç§¯å°ï¼Œæ€§èƒ½å¥½
2. âœ… **æ˜“äºåµŒå…¥**ï¼šMoonSharp æ˜¯çº¯ C# å®ç°ï¼Œæ— éœ€å¤–éƒ¨ä¾èµ–
3. âœ… **è°ƒè¯•æ”¯æŒ**ï¼šMoonSharp æ”¯æŒæ–­ç‚¹ã€å•æ­¥è°ƒè¯•
4. âœ… **è¯­æ³•ç®€å•**ï¼šå­¦ä¹ æˆæœ¬ä½
5. âœ… **åŠŸèƒ½ç»‘å®š**ï¼šå¯ä»¥è½»æ¾ç»‘å®š C# å‡½æ•°å’Œå¯¹è±¡
6. âœ… **è¿è¡Œæ—¶ä¿®æ”¹**ï¼šæ”¯æŒåŠ¨æ€æ‰§è¡Œå’Œä¿®æ”¹

**å¤‡é€‰æ–¹æ¡ˆï¼šC# Script (Roslyn)**
- å¦‚æœç”¨æˆ·æ›´ç†Ÿæ‚‰ C#ï¼Œå¯ä»¥ä½¿ç”¨ Roslyn è„šæœ¬
- æ”¯æŒå®Œæ•´çš„ C# è¯­æ³•å’Œè°ƒè¯•

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### 1. è„šæœ¬å¼•æ“å±‚

#### ScriptEngineï¼ˆè„šæœ¬å¼•æ“æ¥å£ï¼‰
```csharp
namespace YongLiSystem.Services.Scripting
{
    /// <summary>
    /// è„šæœ¬å¼•æ“æ¥å£
    /// </summary>
    public interface IScriptEngine
    {
        /// <summary>
        /// æ‰§è¡Œè„šæœ¬
        /// </summary>
        ScriptResult Execute(string script, Dictionary<string, object>? context = null);
        
        /// <summary>
        /// éªŒè¯è„šæœ¬è¯­æ³•
        /// </summary>
        ScriptValidationResult Validate(string script);
        
        /// <summary>
        /// ç»‘å®šå‡½æ•°
        /// </summary>
        void BindFunction(string name, Delegate function);
        
        /// <summary>
        /// ç»‘å®šå¯¹è±¡
        /// </summary>
        void BindObject(string name, object obj);
        
        /// <summary>
        /// è®¾ç½®æ–­ç‚¹
        /// </summary>
        void SetBreakpoint(int lineNumber);
        
        /// <summary>
        /// æ¸…é™¤æ–­ç‚¹
        /// </summary>
        void ClearBreakpoint(int lineNumber);
        
        /// <summary>
        /// è°ƒè¯•äº‹ä»¶
        /// </summary>
        event EventHandler<ScriptDebugEventArgs>? OnBreakpoint;
        event EventHandler<ScriptErrorEventArgs>? OnError;
    }
}
```

#### MoonSharpScriptEngineï¼ˆLuaå¼•æ“å®ç°ï¼‰
```csharp
namespace YongLiSystem.Services.Scripting
{
    /// <summary>
    /// MoonSharp Lua è„šæœ¬å¼•æ“å®ç°
    /// </summary>
    public class MoonSharpScriptEngine : IScriptEngine
    {
        private readonly Script _script;
        private readonly HashSet<int> _breakpoints = new();
        
        public MoonSharpScriptEngine()
        {
            _script = new Script();
            
            // é…ç½®è°ƒè¯•æ”¯æŒ
            _script.Options.DebugPrint = (s) => OnDebugPrint?.Invoke(s);
            
            // è®¢é˜…è°ƒè¯•äº‹ä»¶
            _script.AttachDebugger(new MoonSharpDebugger());
        }
        
        public ScriptResult Execute(string scriptCode, Dictionary<string, object>? context = null)
        {
            try
            {
                // åŠ è½½ä¸Šä¸‹æ–‡
                if (context != null)
                {
                    foreach (var kvp in context)
                    {
                        _script.Globals[kvp.Key] = ObjectValue.FromObject(_script, kvp.Value);
                    }
                }
                
                // æ‰§è¡Œè„šæœ¬
                var result = _script.DoString(scriptCode);
                
                return new ScriptResult
                {
                    Success = true,
                    Data = result.ToObject(),
                    Output = GetOutput()
                };
            }
            catch (ScriptRuntimeException ex)
            {
                return new ScriptResult
                {
                    Success = false,
                    Error = ex.Message,
                    LineNumber = ex.DebugSymbols?.SourceLine ?? 0
                };
            }
        }
        
        public ScriptValidationResult Validate(string scriptCode)
        {
            try
            {
                // å°è¯•è§£æè„šæœ¬
                _script.LoadString(scriptCode);
                return new ScriptValidationResult { IsValid = true };
            }
            catch (SyntaxErrorException ex)
            {
                return new ScriptValidationResult
                {
                    IsValid = false,
                    Error = ex.Message,
                    LineNumber = ex.Line ?? 0,
                    ColumnNumber = ex.Column ?? 0
                };
            }
        }
        
        public void BindFunction(string name, Delegate function)
        {
            _script.Globals[name] = DynValue.FromObject(_script, function);
        }
        
        public void BindObject(string name, object obj)
        {
            _script.Globals[name] = DynValue.FromObject(_script, obj);
        }
        
        public void SetBreakpoint(int lineNumber)
        {
            _breakpoints.Add(lineNumber);
        }
        
        public void ClearBreakpoint(int lineNumber)
        {
            _breakpoints.Remove(lineNumber);
        }
        
        public event EventHandler<ScriptDebugEventArgs>? OnBreakpoint;
        public event EventHandler<ScriptErrorEventArgs>? OnError;
        public event Action<string>? OnDebugPrint;
    }
}
```

---

### 2. ç¼–è¾‘å™¨å±‚

#### ä»£ç ç¼–è¾‘å™¨é€‰æ‹©

**æ¨èæ–¹æ¡ˆï¼šScintillaNET**

**ç†ç”±ï¼š**
1. âœ… **åŠŸèƒ½å®Œæ•´**ï¼šè¯­æ³•é«˜äº®ã€ä»£ç æŠ˜å ã€è‡ªåŠ¨å®Œæˆ
2. âœ… **æ–­ç‚¹æ”¯æŒ**ï¼šå¯ä»¥æ ‡è®°æ–­ç‚¹è¡Œ
3. âœ… **é”™è¯¯æ ‡è®°**ï¼šå¯ä»¥æ ‡è®°é”™è¯¯è¡Œ
4. âœ… **WinFormsé›†æˆ**ï¼šåŸç”Ÿæ”¯æŒ WinForms
5. âœ… **å¼€æºå…è´¹**ï¼šMIT è®¸å¯è¯
6. âœ… **æ€§èƒ½å¥½**ï¼šé€‚åˆå¤§æ–‡ä»¶ç¼–è¾‘

**å¤‡é€‰æ–¹æ¡ˆï¼š**
- **AvalonEdit**ï¼ˆéœ€è¦ WPF é›†æˆï¼‰
- **Monaco Editor**ï¼ˆéœ€è¦ WebView2ï¼‰
- **DevExpress Code Editor**ï¼ˆå¦‚æœé¡¹ç›®å·²æœ‰ DevExpressï¼‰

## ğŸ“¦ è„šæœ¬ç¼–è¾‘å™¨æ§ä»¶å°è£…è®¾è®¡

### è®¾è®¡åŸåˆ™

1. **å¼€ç®±å³ç”¨**ï¼šåˆ›å»ºå³ç”¨ï¼Œæ— éœ€é¢å¤–é…ç½®
2. **é«˜åº¦å°è£…**ï¼šæ‰€æœ‰åŠŸèƒ½å†…ç½®ï¼Œå¤–éƒ¨åªéœ€ç®€å•è°ƒç”¨
3. **å¯å¤ç”¨**ï¼šå¯åœ¨å¤šä¸ªåœ°æ–¹ä½¿ç”¨ï¼Œç»Ÿä¸€ä½“éªŒ
4. **è®¾è®¡å™¨æ”¯æŒ**ï¼šå¯åœ¨è®¾è®¡å™¨ä¸­ç›´æ¥ä½¿ç”¨å’Œé¢„è§ˆ

### æ§ä»¶ä½ç½®

**å»ºè®®ä½ç½®**ï¼š`æ°¸åˆ©ç³»ç»Ÿ/Views/Shared/Controls/ScriptEditorControl.cs`

**ç†ç”±**ï¼š
- æ”¾åœ¨ Shared ä½ç½®ï¼Œä¾¿äºå¤šä¸ªæ¨¡å—å¤ç”¨
- ç‹¬ç«‹çš„æ§ä»¶ï¼Œä¸ä¾èµ–ç‰¹å®šä¸šåŠ¡é€»è¾‘
- å¯ä»¥åœ¨è®¾è®¡å™¨ä¸­ç›´æ¥æ‹–æ”¾ä½¿ç”¨

---

### ScriptEditorControlï¼ˆè„šæœ¬ç¼–è¾‘å™¨æ§ä»¶ - å®Œæ•´å°è£…ç‰ˆï¼‰

```csharp
namespace YongLiSystem.Views.Shared.Controls
{
    /// <summary>
    /// è„šæœ¬ç¼–è¾‘å™¨æ§ä»¶ï¼ˆå®Œæ•´å°è£…ï¼Œå¼€ç®±å³ç”¨ï¼‰
    /// 
    /// ä½¿ç”¨æ–¹å¼ï¼š
    /// 1. åœ¨è®¾è®¡å™¨ä¸­æ‹–æ”¾åˆ°çª—ä½“/ç”¨æˆ·æ§ä»¶
    /// 2. è®¾ç½® ScriptText å±æ€§åŠ è½½è„šæœ¬
    /// 3. è®¢é˜…äº‹ä»¶å¤„ç†è„šæœ¬å˜æ›´å’Œæ‰§è¡Œ
    /// 
    /// åŠŸèƒ½ç‰¹æ€§ï¼š
    /// - âœ… è¯­æ³•é«˜äº®ï¼ˆLuaï¼‰
    /// - âœ… æ–­ç‚¹è°ƒè¯•ï¼ˆç‚¹å‡»å·¦è¾¹è·ï¼‰
    /// - âœ… å®æ—¶è¯­æ³•éªŒè¯
    /// - âœ… é”™è¯¯æ ‡è®°å’Œæç¤º
    /// - âœ… è‡ªåŠ¨å®Œæˆ
    /// - âœ… ä»£ç æŠ˜å 
    /// - âœ… è¡Œå·æ˜¾ç¤º
    /// - âœ… æŸ¥æ‰¾æ›¿æ¢
    /// </summary>
    public partial class ScriptEditorControl : XtraUserControl
    {
        private IScriptEngine? _scriptEngine;
        private readonly List<int> _breakpoints = new();
        private System.Windows.Forms.Timer? _validationTimer;
        private bool _isInitialized = false;
        
        /// <summary>
        /// æ„é€ å‡½æ•° - è‡ªåŠ¨åˆå§‹åŒ–æ‰€æœ‰åŠŸèƒ½
        /// </summary>
        public ScriptEditorControl()
        {
            InitializeComponent(); // è®¾è®¡å™¨ä¸­åˆ›å»º ScintillaNET æ§ä»¶å’Œæ‰€æœ‰UI
            InitializeAll(); // è‡ªåŠ¨åˆå§‹åŒ–æ‰€æœ‰åŠŸèƒ½
        }
        
        /// <summary>
        /// åˆå§‹åŒ–æ‰€æœ‰åŠŸèƒ½ï¼ˆè‡ªåŠ¨è°ƒç”¨ï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®ï¼‰
        /// </summary>
        private void InitializeAll()
        {
            if (_isInitialized) return;
            
            // 1. åˆå§‹åŒ–ç¼–è¾‘å™¨åŸºç¡€é…ç½®
            InitializeEditor();
            
            // 2. é…ç½®è¯­æ³•é«˜äº®
            ConfigureSyntaxHighlighting();
            
            // 3. é…ç½®æ–­ç‚¹æ ‡è®°
            ConfigureBreakpointMarker();
            
            // 4. é…ç½®é”™è¯¯æ ‡è®°
            ConfigureErrorMarker();
            
            // 5. é…ç½®è‡ªåŠ¨å®Œæˆ
            ConfigureAutoComplete();
            
            // 6. é…ç½®ä»£ç æŠ˜å 
            ConfigureCodeFolding();
            
            // 7. é…ç½®è¡Œå·
            ConfigureLineNumbers();
            
            // 8. è®¢é˜…äº‹ä»¶
            SubscribeEvents();
            
            // 9. åˆ›å»ºé»˜è®¤è„šæœ¬å¼•æ“ï¼ˆLuaï¼‰
            CreateDefaultScriptEngine();
            
            _isInitialized = true;
        }
        
        /// <summary>
        /// åˆå§‹åŒ–ç¼–è¾‘å™¨
        /// </summary>
        private void InitializeEditor()
        {
            // é…ç½® ScintillaNET
            scintilla.Lexer = Lexer.Lua; // ä½¿ç”¨ Lua è¯­æ³•é«˜äº®
            scintilla.StyleClearAll();
            
            // é…ç½®è¯­æ³•é«˜äº®
            ConfigureSyntaxHighlighting();
            
            // é…ç½®æ–­ç‚¹æ ‡è®°
            ConfigureBreakpointMarker();
            
            // é…ç½®é”™è¯¯æ ‡è®°
            ConfigureErrorMarker();
            
            // é…ç½®è‡ªåŠ¨å®Œæˆ
            ConfigureAutoComplete();
            
            // è®¢é˜…äº‹ä»¶
            scintilla.MarginClick += Scintilla_MarginClick; // æ–­ç‚¹ç‚¹å‡»
            scintilla.TextChanged += Scintilla_TextChanged; // æ–‡æœ¬å˜æ›´ï¼ˆå®æ—¶éªŒè¯ï¼‰
        }
        
        /// <summary>
        /// é…ç½®è¯­æ³•é«˜äº®
        /// </summary>
        private void ConfigureSyntaxHighlighting()
        {
            // Lua å…³é”®å­—
            scintilla.SetKeywords(0, "function end if then else elseif while do repeat until for in return break local and or not");
            
            // è®¾ç½®æ ·å¼
            scintilla.Styles[Style.Lua.Default].ForeColor = Color.Black;
            scintilla.Styles[Style.Lua.Comment].ForeColor = Color.Green;
            scintilla.Styles[Style.Lua.CommentLine].ForeColor = Color.Green;
            scintilla.Styles[Style.Lua.Number].ForeColor = Color.Blue;
            scintilla.Styles[Style.Lua.String].ForeColor = Color.Maroon;
            scintilla.Styles[Style.Lua.Word].ForeColor = Color.Blue;
            scintilla.Styles[Style.Lua.Word2].ForeColor = Color.Purple;
        }
        
        /// <summary>
        /// é…ç½®æ–­ç‚¹æ ‡è®°
        /// </summary>
        private void ConfigureBreakpointMarker()
        {
            // åœ¨å·¦è¾¹è·æ˜¾ç¤ºæ–­ç‚¹
            scintilla.Margins[0].Width = 20;
            scintilla.Margins[0].Type = MarginType.Symbol;
            scintilla.Margins[0].Mask = (1 << 0); // ä½¿ç”¨æ ‡è®° 0
            
            // æ–­ç‚¹å›¾æ ‡ï¼ˆçº¢è‰²åœ†ç‚¹ï¼‰
            scintilla.Markers[0].Symbol = MarkerSymbol.Circle;
            scintilla.Markers[0].SetBackColor(Color.Red);
        }
        
        /// <summary>
        /// é…ç½®é”™è¯¯æ ‡è®°
        /// </summary>
        private void ConfigureErrorMarker()
        {
            // é”™è¯¯æ ‡è®°ï¼ˆçº¢è‰²æ³¢æµªçº¿ï¼‰
            scintilla.Markers[1].Symbol = MarkerSymbol.Underline;
            scintilla.Markers[1].SetBackColor(Color.Red);
        }
        
        /// <summary>
        /// é…ç½®è‡ªåŠ¨å®Œæˆ
        /// </summary>
        private void ConfigureAutoComplete()
        {
            scintilla.AutoCSetSeparator(' ');
            scintilla.AutoCSetIgnoreCase(true);
            scintilla.AutoCSetMaxHeight(10);
        }
        
        /// <summary>
        /// æ–­ç‚¹ç‚¹å‡»äº‹ä»¶
        /// </summary>
        private void Scintilla_MarginClick(object sender, MarginClickEventArgs e)
        {
            if (e.Margin == 0) // å·¦è¾¹è·
            {
                int line = scintilla.LineFromPosition(e.Position);
                ToggleBreakpoint(line);
            }
        }
        
        /// <summary>
        /// åˆ‡æ¢æ–­ç‚¹
        /// </summary>
        private void ToggleBreakpoint(int line)
        {
            if (_breakpoints.Contains(line))
            {
                // ç§»é™¤æ–­ç‚¹
                scintilla.MarkerDelete(line, 0);
                _breakpoints.Remove(line);
                _scriptEngine?.ClearBreakpoint(line + 1); // Lua è¡Œå·ä»1å¼€å§‹
            }
            else
            {
                // æ·»åŠ æ–­ç‚¹
                scintilla.MarkerAdd(line, 0);
                _breakpoints.Add(line);
                _scriptEngine?.SetBreakpoint(line + 1);
            }
        }
        
        /// <summary>
        /// æ–‡æœ¬å˜æ›´äº‹ä»¶ï¼ˆå®æ—¶éªŒè¯ï¼‰
        /// </summary>
        private void Scintilla_TextChanged(object sender, EventArgs e)
        {
            // å»¶è¿ŸéªŒè¯ï¼ˆé¿å…é¢‘ç¹éªŒè¯ï¼‰
            _validationTimer?.Stop();
            _validationTimer = new System.Windows.Forms.Timer { Interval = 500 };
            _validationTimer.Tick += (s, args) =>
            {
                _validationTimer.Stop();
                ValidateScript();
            };
            _validationTimer.Start();
        }
        
        /// <summary>
        /// éªŒè¯è„šæœ¬
        /// </summary>
        private void ValidateScript()
        {
            if (_scriptEngine == null) return;
            
            // æ¸…é™¤ä¹‹å‰çš„é”™è¯¯æ ‡è®°
            ClearErrorMarkers();
            
            var script = scintilla.Text;
            var result = _scriptEngine.Validate(script);
            
            if (!result.IsValid)
            {
                // æ ‡è®°é”™è¯¯è¡Œ
                MarkErrorLine(result.LineNumber - 1, result.Error);
                OnValidationError?.Invoke(result);
            }
            else
            {
                OnValidationSuccess?.Invoke();
            }
        }
        
        /// <summary>
        /// æ ‡è®°é”™è¯¯è¡Œ
        /// </summary>
        private void MarkErrorLine(int line, string error)
        {
            scintilla.MarkerAdd(line, 1); // ä½¿ç”¨æ ‡è®°1ï¼ˆé”™è¯¯æ ‡è®°ï¼‰
            
            // åœ¨çŠ¶æ€æ æ˜¾ç¤ºé”™è¯¯
            OnError?.Invoke($"ç¬¬ {line + 1} è¡Œ: {error}");
        }
        
        /// <summary>
        /// æ¸…é™¤é”™è¯¯æ ‡è®°
        /// </summary>
        private void ClearErrorMarkers()
        {
            for (int i = 0; i < scintilla.Lines.Count; i++)
            {
                scintilla.MarkerDelete(i, 1);
            }
        }
        
        #region å…¬å…±å±æ€§ï¼ˆè®¾è®¡å™¨å¯è§ï¼Œå³æ‹¿å³ç”¨ï¼‰
        
        /// <summary>
        /// è·å–æˆ–è®¾ç½®è„šæœ¬å†…å®¹ï¼ˆè®¾è®¡å™¨å¯è§ï¼‰
        /// </summary>
        [Category("è„šæœ¬")]
        [Description("è„šæœ¬ä»£ç å†…å®¹")]
        public string ScriptText
        {
            get => scintilla.Text;
            set
            {
                scintilla.Text = value ?? string.Empty;
                ValidateScript(); // è‡ªåŠ¨éªŒè¯
            }
        }
        
        /// <summary>
        /// æ˜¯å¦å¯ç”¨å®æ—¶éªŒè¯ï¼ˆè®¾è®¡å™¨å¯è§ï¼‰
        /// </summary>
        [Category("è„šæœ¬")]
        [Description("æ˜¯å¦å¯ç”¨å®æ—¶è¯­æ³•éªŒè¯")]
        [DefaultValue(true)]
        public bool EnableRealTimeValidation { get; set; } = true;
        
        /// <summary>
        /// éªŒè¯å»¶è¿Ÿæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ï¼ˆè®¾è®¡å™¨å¯è§ï¼‰
        /// </summary>
        [Category("è„šæœ¬")]
        [Description("å®æ—¶éªŒè¯å»¶è¿Ÿæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰")]
        [DefaultValue(500)]
        public int ValidationDelay { get; set; } = 500;
        
        /// <summary>
        /// æ˜¯å¦æ˜¾ç¤ºè¡Œå·ï¼ˆè®¾è®¡å™¨å¯è§ï¼‰
        /// </summary>
        [Category("å¤–è§‚")]
        [Description("æ˜¯å¦æ˜¾ç¤ºè¡Œå·")]
        [DefaultValue(true)]
        public bool ShowLineNumbers
        {
            get => scintilla.Margins[1].Width > 0;
            set => scintilla.Margins[1].Width = value ? 50 : 0;
        }
        
        /// <summary>
        /// æ˜¯å¦å¯ç”¨æ–­ç‚¹ï¼ˆè®¾è®¡å™¨å¯è§ï¼‰
        /// </summary>
        [Category("è°ƒè¯•")]
        [Description("æ˜¯å¦å¯ç”¨æ–­ç‚¹åŠŸèƒ½")]
        [DefaultValue(true)]
        public bool EnableBreakpoints { get; set; } = true;
        
        /// <summary>
        /// å­—ä½“å¤§å°ï¼ˆè®¾è®¡å™¨å¯è§ï¼‰
        /// </summary>
        [Category("å¤–è§‚")]
        [Description("ç¼–è¾‘å™¨å­—ä½“å¤§å°")]
        [DefaultValue(10)]
        public int FontSize
        {
            get => (int)scintilla.Styles[Style.Default].Size;
            set
            {
                for (int i = 0; i < scintilla.Styles.Count; i++)
                {
                    scintilla.Styles[i].Size = value;
                }
            }
        }
        
        #endregion
        
        #region å…¬å…±æ–¹æ³•ï¼ˆç®€å•æ˜“ç”¨ï¼‰
        
        /// <summary>
        /// æ‰§è¡Œè„šæœ¬ï¼ˆç®€å•è°ƒç”¨ï¼‰
        /// </summary>
        public ScriptResult ExecuteScript(Dictionary<string, object>? context = null)
        {
            if (_scriptEngine == null)
            {
                CreateDefaultScriptEngine();
            }
            
            return _scriptEngine?.Execute(ScriptText, context) 
                ?? new ScriptResult { Success = false, Error = "è„šæœ¬å¼•æ“æœªåˆå§‹åŒ–" };
        }
        
        /// <summary>
        /// éªŒè¯è„šæœ¬ï¼ˆç®€å•è°ƒç”¨ï¼‰
        /// </summary>
        public ScriptValidationResult ValidateScript()
        {
            if (_scriptEngine == null)
            {
                CreateDefaultScriptEngine();
            }
            
            var result = _scriptEngine?.Validate(ScriptText) 
                ?? new ScriptValidationResult { IsValid = false, Error = "è„šæœ¬å¼•æ“æœªåˆå§‹åŒ–" };
            
            // è‡ªåŠ¨æ ‡è®°é”™è¯¯
            if (!result.IsValid)
            {
                MarkErrorLine(result.LineNumber - 1, result.Error);
                OnValidationError?.Invoke(result);
            }
            else
            {
                ClearErrorMarkers();
                OnValidationSuccess?.Invoke();
            }
            
            return result;
        }
        
        /// <summary>
        /// ç»‘å®šå‡½æ•°åˆ°è„šæœ¬ï¼ˆç®€å•è°ƒç”¨ï¼‰
        /// </summary>
        public void BindFunction(string name, Delegate function)
        {
            if (_scriptEngine == null)
            {
                CreateDefaultScriptEngine();
            }
            
            _scriptEngine?.BindFunction(name, function);
        }
        
        /// <summary>
        /// ç»‘å®šå¯¹è±¡åˆ°è„šæœ¬ï¼ˆç®€å•è°ƒç”¨ï¼‰
        /// </summary>
        public void BindObject(string name, object obj)
        {
            if (_scriptEngine == null)
            {
                CreateDefaultScriptEngine();
            }
            
            _scriptEngine?.BindObject(name, obj);
        }
        
        /// <summary>
        /// è®¾ç½®æ–­ç‚¹ï¼ˆç®€å•è°ƒç”¨ï¼‰
        /// </summary>
        public void SetBreakpoint(int lineNumber)
        {
            if (!EnableBreakpoints) return;
            
            int line = lineNumber - 1; // è½¬æ¢ä¸º0åŸºç´¢å¼•
            if (line >= 0 && line < scintilla.Lines.Count)
            {
                scintilla.MarkerAdd(line, 0);
                _breakpoints.Add(line);
                _scriptEngine?.SetBreakpoint(lineNumber);
            }
        }
        
        /// <summary>
        /// æ¸…é™¤æ–­ç‚¹ï¼ˆç®€å•è°ƒç”¨ï¼‰
        /// </summary>
        public void ClearBreakpoint(int lineNumber)
        {
            int line = lineNumber - 1;
            if (_breakpoints.Contains(line))
            {
                scintilla.MarkerDelete(line, 0);
                _breakpoints.Remove(line);
                _scriptEngine?.ClearBreakpoint(lineNumber);
            }
        }
        
        /// <summary>
        /// æ¸…é™¤æ‰€æœ‰æ–­ç‚¹ï¼ˆç®€å•è°ƒç”¨ï¼‰
        /// </summary>
        public void ClearAllBreakpoints()
        {
            foreach (var line in _breakpoints.ToList())
            {
                scintilla.MarkerDelete(line, 0);
                _scriptEngine?.ClearBreakpoint(line + 1);
            }
            _breakpoints.Clear();
        }
        
        /// <summary>
        /// æŸ¥æ‰¾æ–‡æœ¬ï¼ˆç®€å•è°ƒç”¨ï¼‰
        /// </summary>
        public void FindText(string text, bool matchCase = false, bool wholeWord = false)
        {
            scintilla.SearchFlags = (matchCase ? SearchFlags.MatchCase : SearchFlags.None) 
                | (wholeWord ? SearchFlags.WholeWord : SearchFlags.None);
            
            int pos = scintilla.SearchInTarget(text);
            if (pos >= 0)
            {
                scintilla.SetSelection(scintilla.TargetStart, scintilla.TargetEnd);
                scintilla.ScrollCaret();
            }
        }
        
        /// <summary>
        /// æ›¿æ¢æ–‡æœ¬ï¼ˆç®€å•è°ƒç”¨ï¼‰
        /// </summary>
        public void ReplaceText(string findText, string replaceText, bool matchCase = false)
        {
            scintilla.SearchFlags = matchCase ? SearchFlags.MatchCase : SearchFlags.None;
            scintilla.TargetStart = 0;
            scintilla.TargetEnd = scintilla.TextLength;
            
            scintilla.ReplaceTarget(replaceText);
        }
        
        /// <summary>
        /// è®¾ç½®è‡ªå®šä¹‰è„šæœ¬å¼•æ“ï¼ˆé«˜çº§ç”¨æ³•ï¼‰
        /// </summary>
        public void SetScriptEngine(IScriptEngine engine)
        {
            _scriptEngine = engine;
            _scriptEngine.OnError += (s, e) => OnError?.Invoke(e.Error);
            _scriptEngine.OnBreakpoint += (s, e) => OnBreakpointHit?.Invoke(e);
        }
        
        #endregion
        
        #region ç§æœ‰æ–¹æ³•ï¼ˆå†…éƒ¨å®ç°ï¼‰
        
        /// <summary>
        /// åˆ›å»ºé»˜è®¤è„šæœ¬å¼•æ“ï¼ˆLuaï¼‰
        /// </summary>
        private void CreateDefaultScriptEngine()
        {
            if (_scriptEngine != null) return;
            
            _scriptEngine = new MoonSharpScriptEngine();
            _scriptEngine.OnError += (s, e) => OnError?.Invoke(e.Error);
            _scriptEngine.OnBreakpoint += (s, e) => OnBreakpointHit?.Invoke(e);
            
            // ç»‘å®šé»˜è®¤åŠŸèƒ½ï¼ˆå¦‚æœå·²æ³¨å†Œï¼‰
            var registry = ScriptFunctionRegistry.Instance;
            if (registry != null)
            {
                registry.BindToEngine(_scriptEngine);
            }
        }
        
        /// <summary>
        /// é…ç½®ä»£ç æŠ˜å 
        /// </summary>
        private void ConfigureCodeFolding()
        {
            scintilla.SetProperty("fold", "1");
            scintilla.SetProperty("fold.compact", "1");
            scintilla.SetProperty("fold.lua", "1");
            
            // æŠ˜å æ ‡è®°
            scintilla.Markers[Marker.Folder].Symbol = MarkerSymbol.BoxPlus;
            scintilla.Markers[Marker.FolderOpen].Symbol = MarkerSymbol.BoxMinus;
            scintilla.Markers[Marker.FolderEnd].Symbol = MarkerSymbol.BoxPlusConnected;
            scintilla.Markers[Marker.FolderMidTail].Symbol = MarkerSymbol.TCorner;
            scintilla.Markers[Marker.FolderTail].Symbol = MarkerSymbol.LCorner;
            scintilla.Markers[Marker.FolderSub].Symbol = MarkerSymbol.VLine;
            scintilla.Markers[Marker.Folder].SetBackColor(Color.LightGray);
        }
        
        /// <summary>
        /// é…ç½®è¡Œå·
        /// </summary>
        private void ConfigureLineNumbers()
        {
            scintilla.Margins[1].Type = MarginType.Number;
            scintilla.Margins[1].Width = 50;
            scintilla.Margins[1].Sensitive = false;
        }
        
        /// <summary>
        /// è®¢é˜…äº‹ä»¶
        /// </summary>
        private void SubscribeEvents()
        {
            scintilla.MarginClick += Scintilla_MarginClick;
            scintilla.TextChanged += Scintilla_TextChanged;
            scintilla.CharAdded += Scintilla_CharAdded; // è‡ªåŠ¨å®Œæˆè§¦å‘
        }
        
        /// <summary>
        /// å­—ç¬¦è¾“å…¥äº‹ä»¶ï¼ˆè§¦å‘è‡ªåŠ¨å®Œæˆï¼‰
        /// </summary>
        private void Scintilla_CharAdded(object sender, CharAddedEventArgs e)
        {
            // è§¦å‘è‡ªåŠ¨å®Œæˆï¼ˆå¯ä»¥æ ¹æ®éœ€è¦å®ç°ï¼‰
            // scintilla.AutoCShow(...);
        }
        
        /// <summary>
        /// æ ‡è®°é”™è¯¯è¡Œ
        /// </summary>
        private void MarkErrorLine(int line, string error)
        {
            if (line >= 0 && line < scintilla.Lines.Count)
            {
                scintilla.MarkerAdd(line, 1); // ä½¿ç”¨æ ‡è®°1ï¼ˆé”™è¯¯æ ‡è®°ï¼‰
                OnError?.Invoke($"ç¬¬ {line + 1} è¡Œ: {error}");
            }
        }
        
        /// <summary>
        /// æ¸…é™¤é”™è¯¯æ ‡è®°
        /// </summary>
        private void ClearErrorMarkers()
        {
            for (int i = 0; i < scintilla.Lines.Count; i++)
            {
                scintilla.MarkerDelete(i, 1);
            }
        }
        
        #endregion
        
        #region å…¬å…±äº‹ä»¶ï¼ˆç®€å•è®¢é˜…ï¼‰
        
        /// <summary>
        /// è„šæœ¬å†…å®¹å˜æ›´äº‹ä»¶
        /// </summary>
        [Category("è„šæœ¬")]
        [Description("è„šæœ¬å†…å®¹å˜æ›´æ—¶è§¦å‘")]
        public event EventHandler? ScriptTextChanged;
        
        /// <summary>
        /// è„šæœ¬éªŒè¯é”™è¯¯äº‹ä»¶
        /// </summary>
        [Category("è„šæœ¬")]
        [Description("è„šæœ¬éªŒè¯å¤±è´¥æ—¶è§¦å‘")]
        public event Action<ScriptValidationResult>? OnValidationError;
        
        /// <summary>
        /// è„šæœ¬éªŒè¯æˆåŠŸäº‹ä»¶
        /// </summary>
        [Category("è„šæœ¬")]
        [Description("è„šæœ¬éªŒè¯æˆåŠŸæ—¶è§¦å‘")]
        public event Action? OnValidationSuccess;
        
        /// <summary>
        /// è„šæœ¬æ‰§è¡Œé”™è¯¯äº‹ä»¶
        /// </summary>
        [Category("è„šæœ¬")]
        [Description("è„šæœ¬æ‰§è¡Œé”™è¯¯æ—¶è§¦å‘")]
        public event Action<string>? OnError;
        
        /// <summary>
        /// æ–­ç‚¹å‘½ä¸­äº‹ä»¶
        /// </summary>
        [Category("è°ƒè¯•")]
        [Description("è„šæœ¬æ‰§è¡Œåˆ°æ–­ç‚¹æ—¶è§¦å‘")]
        public event Action<ScriptDebugEventArgs>? OnBreakpointHit;
        
        #endregion
        
        #region é‡å†™æ–¹æ³•
        
        protected override void OnLoad(EventArgs e)
        {
            base.OnLoad(e);
            // ç¡®ä¿åˆå§‹åŒ–å®Œæˆ
            if (!_isInitialized)
            {
                InitializeAll();
            }
        }
        
        #endregion
    }
}
```

---

## ğŸ“– ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šæœ€ç®€å•çš„ä½¿ç”¨ï¼ˆå³æ‹¿å³ç”¨ï¼‰

```csharp
// åœ¨è®¾è®¡å™¨ä¸­æ‹–æ”¾ ScriptEditorControl åˆ°çª—ä½“
// æˆ–è€…ä»£ç ä¸­åˆ›å»º
var editor = new ScriptEditorControl();
editor.Dock = DockStyle.Fill;
this.Controls.Add(editor);

// è®¾ç½®è„šæœ¬å†…å®¹ï¼ˆè‡ªåŠ¨éªŒè¯ï¼‰
editor.ScriptText = @"
function login(username, password)
    navigate('https://example.com/login')
    wait(2000)
    setValue('#username', username)
    setValue('#password', password)
    click('#login-button')
    return true
end
";

// è®¢é˜…äº‹ä»¶
editor.OnValidationError += (result) => 
{
    MessageBox.Show($"è¯­æ³•é”™è¯¯: {result.Error}");
};

// æ‰§è¡Œè„šæœ¬
var result = editor.ExecuteScript();
if (result.Success)
{
    MessageBox.Show("æ‰§è¡ŒæˆåŠŸï¼");
}
```

### ç¤ºä¾‹2ï¼šç»‘å®šè‡ªå®šä¹‰åŠŸèƒ½

```csharp
var editor = new ScriptEditorControl();

// ç»‘å®šè‡ªå®šä¹‰å‡½æ•°
editor.BindFunction("customFunction", new Action<string>((msg) => 
{
    MessageBox.Show(msg);
}));

// ç»‘å®šå¯¹è±¡
var myObject = new { Name = "Test", Value = 123 };
editor.BindObject("myObj", myObject);

// è„šæœ¬ä¸­å¯ä»¥ä½¿ç”¨
editor.ScriptText = @"
customFunction('Hello from Lua!')
local name = myObj.Name
log('Name: ' .. name)
";
```

### ç¤ºä¾‹3ï¼šåœ¨ä»»åŠ¡é…ç½®å¯¹è¯æ¡†ä¸­ä½¿ç”¨

```csharp
public partial class ScriptTaskConfigDialog : XtraForm
{
    private ScriptEditorControl _scriptEditor;
    
    public ScriptTaskConfigDialog()
    {
        InitializeComponent();
        
        // åˆ›å»ºè„šæœ¬ç¼–è¾‘å™¨ï¼ˆè‡ªåŠ¨åˆå§‹åŒ–æ‰€æœ‰åŠŸèƒ½ï¼‰
        _scriptEditor = new ScriptEditorControl
        {
            Dock = DockStyle.Fill,
            EnableBreakpoints = true,
            ShowLineNumbers = true,
            FontSize = 10
        };
        
        // æ·»åŠ åˆ°é¢æ¿
        panelScriptEditor.Controls.Add(_scriptEditor);
        
        // è®¢é˜…äº‹ä»¶
        _scriptEditor.OnValidationError += (result) =>
        {
            lblError.Text = $"é”™è¯¯: {result.Error}";
            lblError.Visible = true;
        };
        
        _scriptEditor.OnValidationSuccess += () =>
        {
            lblError.Visible = false;
        };
    }
    
    public string GetScript()
    {
        return _scriptEditor.ScriptText;
    }
    
    public void SetScript(string script)
    {
        _scriptEditor.ScriptText = script;
    }
}
```

### ç¤ºä¾‹4ï¼šåœ¨è®¾è®¡å™¨ä¸­ä½¿ç”¨

```
1. æ‰“å¼€ Visual Studio è®¾è®¡å™¨
2. åœ¨å·¥å…·ç®±ä¸­æ‰¾åˆ° ScriptEditorControl
3. æ‹–æ”¾åˆ°çª—ä½“æˆ–ç”¨æˆ·æ§ä»¶
4. åœ¨å±æ€§çª—å£ä¸­è®¾ç½®ï¼š
   - ScriptText: åˆå§‹è„šæœ¬å†…å®¹
   - EnableBreakpoints: true
   - ShowLineNumbers: true
   - FontSize: 10
5. åœ¨äº‹ä»¶çª—å£ä¸­è®¢é˜…ï¼š
   - OnValidationError
   - OnValidationSuccess
   - OnError
6. å®Œæˆï¼æ§ä»¶å·²å¯ç”¨
```

---

## ğŸ¨ è®¾è®¡å™¨ä¸­çš„UIå¸ƒå±€

### ScriptEditorControl.Designer.csï¼ˆè®¾è®¡å™¨ä¸­åˆ›å»ºï¼‰

```csharp
namespace YongLiSystem.Views.Shared.Controls
{
    partial class ScriptEditorControl
    {
        private System.ComponentModel.IContainer components = null;
        private ScintillaNET.Scintilla scintilla;
        private DevExpress.XtraEditors.PanelControl panelError;
        private DevExpress.XtraEditors.LabelControl lblError;
        
        protected override void Dispose(bool disposing)
        {
            if (disposing && (components != null))
            {
                components.Dispose();
            }
            base.Dispose(disposing);
        }
        
        private void InitializeComponent()
        {
            this.scintilla = new ScintillaNET.Scintilla();
            this.panelError = new DevExpress.XtraEditors.PanelControl();
            this.lblError = new DevExpress.XtraEditors.LabelControl();
            ((System.ComponentModel.ISupportInitialize)(this.panelError)).BeginInit();
            this.panelError.SuspendLayout();
            this.SuspendLayout();
            
            // scintilla
            this.scintilla.Dock = System.Windows.Forms.DockStyle.Fill;
            this.scintilla.Location = new System.Drawing.Point(0, 0);
            this.scintilla.Name = "scintilla";
            this.scintilla.Size = new System.Drawing.Size(800, 500);
            this.scintilla.TabIndex = 0;
            
            // panelError
            this.panelError.Controls.Add(this.lblError);
            this.panelError.Dock = System.Windows.Forms.DockStyle.Bottom;
            this.panelError.Location = new System.Drawing.Point(0, 500);
            this.panelError.Name = "panelError";
            this.panelError.Size = new System.Drawing.Size(800, 30);
            this.panelError.TabIndex = 1;
            this.panelError.Visible = false;
            
            // lblError
            this.lblError.Dock = System.Windows.Forms.DockStyle.Fill;
            this.lblError.Location = new System.Drawing.Point(2, 2);
            this.lblError.Name = "lblError";
            this.lblError.Size = new System.Drawing.Size(796, 26);
            this.lblError.TabIndex = 0;
            this.lblError.Text = "é”™è¯¯ä¿¡æ¯";
            this.lblError.Appearance.ForeColor = System.Drawing.Color.Red;
            
            // ScriptEditorControl
            this.AutoScaleDimensions = new System.Drawing.SizeF(7F, 14F);
            this.AutoScaleMode = System.Windows.Forms.AutoScaleMode.Font;
            this.Controls.Add(this.scintilla);
            this.Controls.Add(this.panelError);
            this.Name = "ScriptEditorControl";
            this.Size = new System.Drawing.Size(800, 530);
            ((System.ComponentModel.ISupportInitialize)(this.panelError)).EndInit();
            this.panelError.ResumeLayout(false);
            this.ResumeLayout(false);
        }
    }
}
```

---

## âœ… å°è£…ç‰¹æ€§æ€»ç»“

### 1. å¼€ç®±å³ç”¨
- âœ… æ„é€ å‡½æ•°è‡ªåŠ¨åˆå§‹åŒ–æ‰€æœ‰åŠŸèƒ½
- âœ… é»˜è®¤åˆ›å»º Lua è„šæœ¬å¼•æ“
- âœ… é»˜è®¤é…ç½®æ‰€æœ‰ç¼–è¾‘å™¨åŠŸèƒ½
- âœ… æ— éœ€æ‰‹åŠ¨é…ç½®å³å¯ä½¿ç”¨

### 2. ç®€å•API
- âœ… å…¬å…±å±æ€§ï¼š`ScriptText`, `EnableBreakpoints`, `ShowLineNumbers` ç­‰
- âœ… å…¬å…±æ–¹æ³•ï¼š`ExecuteScript()`, `ValidateScript()`, `BindFunction()` ç­‰
- âœ… å…¬å…±äº‹ä»¶ï¼š`OnValidationError`, `OnError`, `OnBreakpointHit` ç­‰

### 3. è®¾è®¡å™¨æ”¯æŒ
- âœ… æ‰€æœ‰å…¬å…±å±æ€§åœ¨è®¾è®¡å™¨ä¸­å¯è§
- âœ… æ‰€æœ‰å…¬å…±äº‹ä»¶åœ¨è®¾è®¡å™¨ä¸­å¯è®¢é˜…
- âœ… å¯åœ¨è®¾è®¡å™¨ä¸­ç›´æ¥é¢„è§ˆ

### 4. é«˜åº¦å°è£…
- âœ… æ‰€æœ‰å†…éƒ¨å®ç°ç»†èŠ‚éšè—
- âœ… å¤–éƒ¨åªéœ€è°ƒç”¨ç®€å•API
- âœ… è‡ªåŠ¨å¤„ç†é”™è¯¯å’ŒéªŒè¯

### 5. å¯å¤ç”¨
- âœ… ç‹¬ç«‹æ§ä»¶ï¼Œä¸ä¾èµ–ä¸šåŠ¡é€»è¾‘
- âœ… å¯åœ¨å¤šä¸ªåœ°æ–¹ä½¿ç”¨
- âœ… ç»Ÿä¸€çš„ä½¿ç”¨ä½“éªŒ

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **é¦–æ¬¡ä½¿ç”¨**ï¼šæ§ä»¶åˆ›å»ºåè‡ªåŠ¨åˆå§‹åŒ–ï¼Œæ— éœ€é¢å¤–é…ç½®
2. **è„šæœ¬å¼•æ“**ï¼šé»˜è®¤ä½¿ç”¨ Lua (MoonSharp)ï¼Œå¯é€šè¿‡ `SetScriptEngine()` æ›´æ¢
3. **åŠŸèƒ½ç»‘å®š**ï¼šé€šè¿‡ `BindFunction()` å’Œ `BindObject()` ç»‘å®šè‡ªå®šä¹‰åŠŸèƒ½
4. **æ–­ç‚¹è°ƒè¯•**ï¼šç‚¹å‡»å·¦è¾¹è·å³å¯è®¾ç½®/æ¸…é™¤æ–­ç‚¹
5. **å®æ—¶éªŒè¯**ï¼šè„šæœ¬ä¿®æ”¹åè‡ªåŠ¨éªŒè¯ï¼ˆå»¶è¿Ÿ500msï¼‰

---

**è®¾è®¡å®Œæˆï¼Œæ§ä»¶å®Œå…¨å°è£…ï¼Œå¼€ç®±å³ç”¨** âœ…

---

### 3. åŠŸèƒ½ç»‘å®šç³»ç»Ÿ

#### ScriptFunctionRegistryï¼ˆåŠŸèƒ½æ³¨å†Œè¡¨ï¼‰
```csharp
namespace YongLiSystem.Services.Scripting
{
    /// <summary>
    /// è„šæœ¬åŠŸèƒ½æ³¨å†Œè¡¨
    /// ç®¡ç†æ‰€æœ‰å¯ç»‘å®šåˆ°è„šæœ¬çš„åŠŸèƒ½
    /// </summary>
    public class ScriptFunctionRegistry
    {
        private readonly Dictionary<string, ScriptFunctionInfo> _functions = new();
        
        /// <summary>
        /// æ³¨å†ŒåŠŸèƒ½
        /// </summary>
        public void RegisterFunction(string name, Delegate function, string description, string example)
        {
            _functions[name] = new ScriptFunctionInfo
            {
                Name = name,
                Function = function,
                Description = description,
                Example = example
            };
        }
        
        /// <summary>
        /// ç»‘å®šæ‰€æœ‰åŠŸèƒ½åˆ°è„šæœ¬å¼•æ“
        /// </summary>
        public void BindToEngine(IScriptEngine engine)
        {
            foreach (var func in _functions.Values)
            {
                engine.BindFunction(func.Name, func.Function);
            }
        }
        
        /// <summary>
        /// è·å–æ‰€æœ‰åŠŸèƒ½ä¿¡æ¯ï¼ˆç”¨äºè‡ªåŠ¨å®Œæˆå’Œå¸®åŠ©ï¼‰
        /// </summary>
        public IEnumerable<ScriptFunctionInfo> GetAllFunctions()
        {
            return _functions.Values;
        }
    }
    
    /// <summary>
    /// è„šæœ¬åŠŸèƒ½ä¿¡æ¯
    /// </summary>
    public class ScriptFunctionInfo
    {
        public string Name { get; set; } = string.Empty;
        public Delegate Function { get; set; } = null!;
        public string Description { get; set; } = string.Empty;
        public string Example { get; set; } = string.Empty;
    }
}
```

#### é¢„å®šä¹‰åŠŸèƒ½ç»‘å®šç¤ºä¾‹
```csharp
namespace YongLiSystem.Services.Scripting
{
    /// <summary>
    /// åˆå§‹åŒ–è„šæœ¬åŠŸèƒ½ç»‘å®š
    /// </summary>
    public static class ScriptFunctionInitializer
    {
        public static void InitializeFunctions(ScriptFunctionRegistry registry, BrowserWindowProxy browserProxy)
        {
            // æµè§ˆå™¨æ“ä½œ
            registry.RegisterFunction(
                "navigate",
                new Action<string>(url => browserProxy.ExecuteCommandAsync("é‡æ–°å¯¼èˆª", url)),
                "å¯¼èˆªåˆ°æŒ‡å®šURL",
                "navigate('https://example.com')"
            );
            
            registry.RegisterFunction(
                "click",
                new Action<string>(selector => browserProxy.ExecuteCommandAsync("ç‚¹å‡»å…ƒç´ ", selector)),
                "ç‚¹å‡»é¡µé¢å…ƒç´ ",
                "click('#submit-button')"
            );
            
            registry.RegisterFunction(
                "getText",
                new Func<string, string>(selector => 
                {
                    var result = browserProxy.ExecuteCommandAsync("è·å–å…ƒç´ æ–‡æœ¬", selector).Result;
                    return result.Data?.ToString() ?? string.Empty;
                }),
                "è·å–å…ƒç´ æ–‡æœ¬",
                "local text = getText('.title')"
            );
            
            registry.RegisterFunction(
                "setValue",
                new Action<string, string>((selector, value) => 
                {
                    browserProxy.ExecuteCommandAsync("è®¾ç½®å…ƒç´ å€¼", new { selector, value });
                }),
                "è®¾ç½®å…ƒç´ å€¼",
                "setValue('#username', 'admin')"
            );
            
            registry.RegisterFunction(
                "wait",
                new Action<int>(ms => Thread.Sleep(ms)),
                "ç­‰å¾…æŒ‡å®šæ¯«ç§’",
                "wait(1000) -- ç­‰å¾…1ç§’"
            );
            
            registry.RegisterFunction(
                "log",
                new Action<string>(msg => LoggingService.Instance.Info("è„šæœ¬", msg)),
                "è¾“å‡ºæ—¥å¿—",
                "log('Hello World')"
            );
            
            // æ•°æ®æ“ä½œ
            registry.RegisterFunction(
                "getIssueData",
                new Func<string>(() => 
                {
                    // è·å–æœŸå·æ•°æ®
                    return "113004873";
                }),
                "è·å–å½“å‰æœŸå·",
                "local issue = getIssueData()"
            );
            
            // æ›´å¤šåŠŸèƒ½...
        }
    }
}
```

---

### 4. è°ƒè¯•ç³»ç»Ÿ

#### ScriptDebuggerï¼ˆè„šæœ¬è°ƒè¯•å™¨ï¼‰
```csharp
namespace YongLiSystem.Services.Scripting
{
    /// <summary>
    /// è„šæœ¬è°ƒè¯•å™¨
    /// </summary>
    public class ScriptDebugger
    {
        private IScriptEngine? _engine;
        private bool _isPaused = false;
        private int _currentLine = 0;
        
        /// <summary>
        /// å¯åŠ¨è°ƒè¯•
        /// </summary>
        public void StartDebugging(IScriptEngine engine, string script)
        {
            _engine = engine;
            _engine.OnBreakpoint += Engine_OnBreakpoint;
            _engine.OnError += Engine_OnError;
            
            // æ‰§è¡Œè„šæœ¬ï¼ˆä¼šåœ¨æ–­ç‚¹å¤„æš‚åœï¼‰
            var result = _engine.Execute(script);
        }
        
        /// <summary>
        /// ç»§ç»­æ‰§è¡Œ
        /// </summary>
        public void Continue()
        {
            _isPaused = false;
            // ç»§ç»­æ‰§è¡Œè„šæœ¬
        }
        
        /// <summary>
        /// å•æ­¥æ‰§è¡Œ
        /// </summary>
        public void StepOver()
        {
            // å•æ­¥æ‰§è¡Œ
        }
        
        /// <summary>
        /// å•æ­¥è¿›å…¥
        /// </summary>
        public void StepInto()
        {
            // å•æ­¥è¿›å…¥
        }
        
        /// <summary>
        /// åœæ­¢è°ƒè¯•
        /// </summary>
        public void Stop()
        {
            _isPaused = false;
            _currentLine = 0;
        }
        
        private void Engine_OnBreakpoint(object? sender, ScriptDebugEventArgs e)
        {
            _isPaused = true;
            _currentLine = e.LineNumber;
            OnBreakpointHit?.Invoke(e);
        }
        
        private void Engine_OnError(object? sender, ScriptErrorEventArgs e)
        {
            OnError?.Invoke(e);
        }
        
        public event Action<ScriptDebugEventArgs>? OnBreakpointHit;
        public event Action<ScriptErrorEventArgs>? OnError;
    }
}
```

---

## ğŸ¨ UI è®¾è®¡

### ScriptEditorDialogï¼ˆè„šæœ¬ç¼–è¾‘å™¨å¯¹è¯æ¡†ï¼‰
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è„šæœ¬ç¼–è¾‘å™¨                                    [Ã—]       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [æ–‡ä»¶] [ç¼–è¾‘] [è°ƒè¯•] [å¸®åŠ©]                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â— 1  function login(username, password)        â”‚   â”‚
â”‚  â”‚   2      navigate('https://example.com/login') â”‚   â”‚
â”‚  â”‚   3      wait(2000)                             â”‚   â”‚
â”‚  â”‚   4      setValue('#username', username)        â”‚   â”‚
â”‚  â”‚   5      setValue('#password', password)        â”‚   â”‚
â”‚  â”‚   6      click('#login-button')                 â”‚   â”‚
â”‚  â”‚   7      wait(3000)                             â”‚   â”‚
â”‚  â”‚   8      local result = getText('.status')      â”‚   â”‚
â”‚  â”‚   9      log('ç™»å½•ç»“æœ: ' .. result)            â”‚   â”‚
â”‚  â”‚  10      return result                          â”‚   â”‚
â”‚  â”‚  11  end                                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ é”™è¯¯: ç¬¬5è¡Œ - æœªå®šä¹‰çš„å˜é‡ 'password'           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [è¿è¡Œ] [è°ƒè¯•] [éªŒè¯] [æ¸…é™¤]                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è¯´æ˜ï¼š**
- å·¦ä¾§ï¼šè¡Œå·å’Œæ–­ç‚¹æ ‡è®°ï¼ˆçº¢è‰²åœ†ç‚¹ï¼‰
- ä¸­é—´ï¼šä»£ç ç¼–è¾‘åŒºï¼ˆè¯­æ³•é«˜äº®ï¼‰
- åº•éƒ¨ï¼šé”™è¯¯æç¤ºåŒº
- å·¥å…·æ ï¼šè¿è¡Œã€è°ƒè¯•ã€éªŒè¯ç­‰æŒ‰é’®

---

## ğŸ“¦ ä¾èµ–åŒ…

### NuGet åŒ…
```xml
<PackageReference Include="MoonSharp" Version="2.0.0" />
<PackageReference Include="ScintillaNET" Version="5.3.0" />
```

---

## ğŸ”„ å·¥ä½œæµç¨‹

### 1. è„šæœ¬ç¼–è¾‘æµç¨‹
```
ç”¨æˆ·æ‰“å¼€è„šæœ¬ç¼–è¾‘å™¨
    â†“
åŠ è½½è„šæœ¬å†…å®¹åˆ° ScintillaNET
    â†“
ç”¨æˆ·ç¼–è¾‘è„šæœ¬
    â†“
å®æ—¶éªŒè¯ï¼ˆ500mså»¶è¿Ÿï¼‰
    â†“
æ˜¾ç¤ºè¯­æ³•é”™è¯¯ï¼ˆçº¢è‰²æ ‡è®°ï¼‰
    â†“
ç”¨æˆ·è®¾ç½®æ–­ç‚¹ï¼ˆç‚¹å‡»å·¦è¾¹è·ï¼‰
    â†“
ä¿å­˜è„šæœ¬
```

### 2. è„šæœ¬æ‰§è¡Œæµç¨‹
```
ç”¨æˆ·ç‚¹å‡»"è¿è¡Œ"
    â†“
éªŒè¯è„šæœ¬è¯­æ³•
    â†“
ç»‘å®šåŠŸèƒ½åˆ°è„šæœ¬å¼•æ“
    â†“
æ‰§è¡Œè„šæœ¬
    â†“
å¦‚æœé‡åˆ°æ–­ç‚¹ï¼Œæš‚åœæ‰§è¡Œ
    â†“
æ˜¾ç¤ºæ‰§è¡Œç»“æœæˆ–é”™è¯¯
```

### 3. è°ƒè¯•æµç¨‹
```
ç”¨æˆ·ç‚¹å‡»"è°ƒè¯•"
    â†“
å¯åŠ¨è°ƒè¯•æ¨¡å¼
    â†“
æ‰§è¡Œè„šæœ¬ï¼ˆé‡åˆ°æ–­ç‚¹æš‚åœï¼‰
    â†“
æ˜¾ç¤ºå˜é‡å€¼ã€è°ƒç”¨å †æ ˆ
    â†“
ç”¨æˆ·é€‰æ‹©ï¼šç»§ç»­/å•æ­¥/åœæ­¢
    â†“
ç»§ç»­æ‰§è¡Œæˆ–åœæ­¢
```

---

## âœ… å®ç°æ£€æŸ¥æ¸…å•

### è„šæœ¬å¼•æ“
- [ ] åˆ›å»º `IScriptEngine` æ¥å£
- [ ] å®ç° `MoonSharpScriptEngine`
- [ ] å®ç°è„šæœ¬æ‰§è¡Œ
- [ ] å®ç°è¯­æ³•éªŒè¯
- [ ] å®ç°æ–­ç‚¹æ”¯æŒ

### ç¼–è¾‘å™¨
- [ ] é›†æˆ ScintillaNET
- [ ] é…ç½® Lua è¯­æ³•é«˜äº®
- [ ] å®ç°æ–­ç‚¹æ ‡è®°
- [ ] å®ç°é”™è¯¯æ ‡è®°
- [ ] å®ç°å®æ—¶éªŒè¯

### åŠŸèƒ½ç»‘å®š
- [ ] åˆ›å»º `ScriptFunctionRegistry`
- [ ] å®ç°åŠŸèƒ½æ³¨å†Œ
- [ ] å®ç°åŠŸèƒ½ç»‘å®š
- [ ] å®šä¹‰é¢„ç½®åŠŸèƒ½ï¼ˆæµè§ˆå™¨æ“ä½œã€æ•°æ®æ“ä½œç­‰ï¼‰

### è°ƒè¯•ç³»ç»Ÿ
- [ ] åˆ›å»º `ScriptDebugger`
- [ ] å®ç°æ–­ç‚¹æš‚åœ
- [ ] å®ç°å•æ­¥æ‰§è¡Œ
- [ ] å®ç°å˜é‡æŸ¥çœ‹

### UIé›†æˆ
- [ ] åˆ›å»º `ScriptEditorControl`
- [ ] åˆ›å»º `ScriptEditorDialog`
- [ ] é›†æˆåˆ°ä»»åŠ¡é…ç½®å¯¹è¯æ¡†

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **æ€§èƒ½ä¼˜åŒ–**ï¼šå®æ—¶éªŒè¯ä½¿ç”¨å»¶è¿Ÿæœºåˆ¶ï¼Œé¿å…é¢‘ç¹éªŒè¯
2. **é”™è¯¯å¤„ç†**ï¼šæ‰€æœ‰è„šæœ¬æ‰§è¡Œéƒ½è¦æœ‰é”™è¯¯æ•è·
3. **çº¿ç¨‹å®‰å…¨**ï¼šè„šæœ¬æ‰§è¡Œåœ¨åå°çº¿ç¨‹ï¼ŒUIæ›´æ–°åœ¨ä¸»çº¿ç¨‹
4. **èµ„æºç®¡ç†**ï¼šæ­£ç¡®é‡Šæ”¾è„šæœ¬å¼•æ“å’Œç¼–è¾‘å™¨èµ„æº

---

## ğŸ¯ åç»­æ‰©å±•

1. **è„šæœ¬æ¨¡æ¿**ï¼šæä¾›å¸¸ç”¨è„šæœ¬æ¨¡æ¿
2. **è„šæœ¬åº“**ï¼šä¿å­˜å¸¸ç”¨è„šæœ¬ç‰‡æ®µ
3. **è„šæœ¬ç‰ˆæœ¬ç®¡ç†**ï¼šæ”¯æŒè„šæœ¬ç‰ˆæœ¬å†å²
4. **è„šæœ¬å¯¼å…¥å¯¼å‡º**ï¼šæ”¯æŒè„šæœ¬æ–‡ä»¶å¯¼å…¥å¯¼å‡º
5. **è„šæœ¬æ€§èƒ½åˆ†æ**ï¼šåˆ†æè„šæœ¬æ‰§è¡Œæ€§èƒ½

---

**è®¾è®¡å®Œæˆï¼Œç­‰å¾…ç¡®è®¤åå¼€å§‹å®ç°** âœ…
