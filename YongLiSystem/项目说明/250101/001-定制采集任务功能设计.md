# å®šåˆ¶é‡‡é›†ä»»åŠ¡åŠŸèƒ½è®¾è®¡æ–‡æ¡£

**ğŸ“… åˆ›å»ºæ—¥æœŸ**: 2025-01-01  
**ğŸ¯ åŠŸèƒ½**: å®šåˆ¶é‡‡é›†ä»»åŠ¡ï¼ˆåŠè‡ªåŠ¨è„šæœ¬ä»»åŠ¡ï¼‰  
**ğŸ“ ä½ç½®**: æ•°æ®é‡‡é›†é¡µé¢ â†’ å³ä¾§ groupCustTask

---

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

### æ ¸å¿ƒåŠŸèƒ½
1. **æ·»åŠ ä»»åŠ¡**: ç‚¹å‡» `buttonAddScriptTask` å¼¹å‡ºé…ç½®å¯¹è¯æ¡†ï¼Œåˆ›å»ºæ–°çš„è„šæœ¬ä»»åŠ¡
2. **ä»»åŠ¡ç®¡ç†**: æµå¼å¸ƒå±€æ˜¾ç¤ºæ‰€æœ‰ä»»åŠ¡å¡ç‰‡
3. **æµè§ˆå™¨é›†æˆ**: æ¯ä¸ªä»»åŠ¡åŒ…å«ä¸€ä¸ªç‹¬ç«‹çš„æµè§ˆå™¨çª—å£ï¼ˆBrowserWindowï¼‰
4. **å®æ—¶ç¼©ç•¥å›¾**: 1ç§’ç”Ÿæˆä¸€æ¬¡æµè§ˆå™¨çª—å£ç¼©ç•¥å›¾ï¼Œå®æ—¶æ›´æ–°åˆ°å¡ç‰‡ä¸Š
5. **æ•°æ®æŒä¹…åŒ–**: ä½¿ç”¨ SQLite æ•°æ®åº“å­˜å‚¨ä»»åŠ¡é…ç½®ï¼Œè‡ªåŠ¨ä¿å­˜å’ŒåŠ è½½

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### 1. æ•°æ®æ¨¡å‹å±‚

#### ScriptTask ç±»ï¼ˆè„šæœ¬ä»»åŠ¡å¯¹è±¡ï¼‰
```csharp
namespace æ°¸åˆ©ç³»ç»Ÿ.Models.Dashboard
{
    /// <summary>
    /// è„šæœ¬ä»»åŠ¡å¯¹è±¡
    /// </summary>
    public class ScriptTask
    {
        /// <summary>
        /// ä»»åŠ¡IDï¼ˆæ•°æ®åº“ä¸»é”®ï¼‰
        /// </summary>
        public int Id { get; set; }
        
        /// <summary>
        /// ä»»åŠ¡åç§°
        /// </summary>
        public string Name { get; set; } = string.Empty;
        
        /// <summary>
        /// ç½‘å€
        /// </summary>
        public string Url { get; set; } = string.Empty;
        
        /// <summary>
        /// ç”¨æˆ·å
        /// </summary>
        public string Username { get; set; } = string.Empty;
        
        /// <summary>
        /// å¯†ç 
        /// </summary>
        public string Password { get; set; } = string.Empty;
        
        /// <summary>
        /// æ˜¯å¦è‡ªåŠ¨ç™»å½•
        /// </summary>
        public bool AutoLogin { get; set; }
        
        /// <summary>
        /// è„šæœ¬å†…å®¹
        /// </summary>
        public string Script { get; set; } = string.Empty;
        
        /// <summary>
        /// åˆ›å»ºæ—¶é—´
        /// </summary>
        public DateTime CreateTime { get; set; } = DateTime.Now;
        
        /// <summary>
        /// æœ€åæ›´æ–°æ—¶é—´
        /// </summary>
        public DateTime UpdateTime { get; set; } = DateTime.Now;
        
        /// <summary>
        /// æ˜¯å¦å¯ç”¨
        /// </summary>
        public bool IsEnabled { get; set; } = true;
        
        // ========== è¿è¡Œæ—¶å±æ€§ï¼ˆä¸å­˜å‚¨åˆ°æ•°æ®åº“ï¼‰==========
        
        /// <summary>
        /// æµè§ˆå™¨çª—å£ä»£ç†ï¼ˆè¿è¡Œæ—¶åˆ›å»ºï¼‰
        /// </summary>
        [Ignore] // SQLite å¿½ç•¥æ­¤å±æ€§
        public BrowserWindowProxy? BrowserProxy { get; set; }
        
        /// <summary>
        /// å½“å‰çŠ¶æ€
        /// </summary>
        [Ignore]
        public ScriptTaskStatus Status { get; set; } = ScriptTaskStatus.Stopped;
        
        /// <summary>
        /// æœ€æ–°æœŸå·æ•°æ®
        /// </summary>
        [Ignore]
        public string? LatestIssueData { get; set; }
        
        /// <summary>
        /// æµè§ˆå™¨ç¼©ç•¥å›¾ï¼ˆ1ç§’æ›´æ–°ä¸€æ¬¡ï¼‰
        /// </summary>
        [Ignore]
        public Image? Thumbnail { get; set; }
    }
    
    /// <summary>
    /// è„šæœ¬ä»»åŠ¡çŠ¶æ€
    /// </summary>
    public enum ScriptTaskStatus
    {
        Stopped,    // å·²åœæ­¢
        Running,    // è¿è¡Œä¸­
        Error       // é”™è¯¯
    }
}
```

---

### 2. æ•°æ®åº“å±‚

#### æ•°æ®åº“æ–‡ä»¶
- **è·¯å¾„**: ä½¿ç”¨å…±åŒçš„æ•°æ®åº“æ–‡ä»¶ `app.db`ï¼ˆä½äº `C:\Users\[ç”¨æˆ·å]\AppData\Local\æ°¸åˆ©ç³»ç»Ÿ\Data\app.db`ï¼‰
- **è¡¨å**: `ScriptTasks`ï¼ˆæ–°å¢è¡¨ï¼Œä¸ç°æœ‰è¡¨å…±å­˜ï¼‰

#### æ•°æ®åº“æ“ä½œï¼ˆé›†æˆåˆ° DataCollectionServiceï¼‰
```csharp
namespace æ°¸åˆ©ç³»ç»Ÿ.Services.Dashboard
{
    /// <summary>
    /// æ•°æ®é‡‡é›†æœåŠ¡ï¼ˆæ‰©å±•ï¼Œæ·»åŠ è„šæœ¬ä»»åŠ¡ç®¡ç†åŠŸèƒ½ï¼‰
    /// </summary>
    public class DataCollectionService
    {
        private readonly LoggingService _loggingService;
        private readonly string _dbPath; // å…±åŒçš„æ•°æ®åº“è·¯å¾„
        
        public DataCollectionService()
        {
            _loggingService = LoggingService.Instance;
            // è·å–å…±åŒçš„æ•°æ®åº“è·¯å¾„ï¼ˆä¸è½¯ä»¶å…¶ä»–æ¨¡å—ä½¿ç”¨åŒä¸€ä¸ªæ•°æ®åº“ï¼‰
            var appDataPath = Path.Combine(
                Environment.GetFolderPath(Environment.SpecialFolder.LocalApplicationData),
                "æ°¸åˆ©ç³»ç»Ÿ",
                "Data"
            );
            if (!Directory.Exists(appDataPath))
                Directory.CreateDirectory(appDataPath);
            _dbPath = Path.Combine(appDataPath, "app.db");
            
            // åˆå§‹åŒ–è„šæœ¬ä»»åŠ¡è¡¨
            InitializeScriptTasksTable();
        }
        
        /// <summary>
        /// åˆå§‹åŒ–è„šæœ¬ä»»åŠ¡è¡¨ï¼ˆåœ¨å…±åŒçš„æ•°æ®åº“ä¸­åˆ›å»ºæ–°è¡¨ï¼‰
        /// </summary>
        private void InitializeScriptTasksTable()
        {
            try
            {
                using var db = new SQLiteConnection(_dbPath);
                db.CreateTable<ScriptTask>();
                _loggingService.Info("æ•°æ®é‡‡é›†", "è„šæœ¬ä»»åŠ¡è¡¨åˆå§‹åŒ–æˆåŠŸ");
            }
            catch (Exception ex)
            {
                _loggingService.Error("æ•°æ®é‡‡é›†", $"è„šæœ¬ä»»åŠ¡è¡¨åˆå§‹åŒ–å¤±è´¥: {ex.Message}", ex);
            }
        }
        
        /// <summary>
        /// åŠ è½½æ‰€æœ‰è„šæœ¬ä»»åŠ¡
        /// </summary>
        public List<ScriptTask> LoadAllScriptTasks()
        {
            try
            {
                using var db = new SQLiteConnection(_dbPath);
                return db.Table<ScriptTask>().ToList();
            }
            catch (Exception ex)
            {
                _loggingService.Error("æ•°æ®é‡‡é›†", $"åŠ è½½è„šæœ¬ä»»åŠ¡å¤±è´¥: {ex.Message}", ex);
                return new List<ScriptTask>();
            }
        }
        
        /// <summary>
        /// ä¿å­˜è„šæœ¬ä»»åŠ¡ï¼ˆæ–°å¢æˆ–æ›´æ–°ï¼‰
        /// </summary>
        public void SaveScriptTask(ScriptTask task)
        {
            try
            {
                task.UpdateTime = DateTime.Now;
                using var db = new SQLiteConnection(_dbPath);
                if (task.Id == 0)
                {
                    task.CreateTime = DateTime.Now;
                    db.Insert(task);
                    _loggingService.Info("æ•°æ®é‡‡é›†", $"æ–°å¢è„šæœ¬ä»»åŠ¡: {task.Name}");
                }
                else
                {
                    db.Update(task);
                    _loggingService.Info("æ•°æ®é‡‡é›†", $"æ›´æ–°è„šæœ¬ä»»åŠ¡: {task.Name}");
                }
            }
            catch (Exception ex)
            {
                _loggingService.Error("æ•°æ®é‡‡é›†", $"ä¿å­˜è„šæœ¬ä»»åŠ¡å¤±è´¥: {ex.Message}", ex);
                throw;
            }
        }
        
        /// <summary>
        /// åˆ é™¤è„šæœ¬ä»»åŠ¡
        /// </summary>
        public void DeleteScriptTask(int taskId)
        {
            try
            {
                using var db = new SQLiteConnection(_dbPath);
                db.Delete<ScriptTask>(taskId);
                _loggingService.Info("æ•°æ®é‡‡é›†", $"åˆ é™¤è„šæœ¬ä»»åŠ¡: ID={taskId}");
            }
            catch (Exception ex)
            {
                _loggingService.Error("æ•°æ®é‡‡é›†", $"åˆ é™¤è„šæœ¬ä»»åŠ¡å¤±è´¥: {ex.Message}", ex);
                throw;
            }
        }
        
        // ... åŸæœ‰çš„å…¶ä»–æ–¹æ³•ä¿æŒä¸å˜ ...
    }
}
```

---

### 3. UI æ§ä»¶å±‚

#### ScriptTaskCardï¼ˆä»»åŠ¡å¡ç‰‡æ§ä»¶ï¼‰
```csharp
namespace æ°¸åˆ©ç³»ç»Ÿ.Views.Dashboard.Controls
{
    /// <summary>
    /// è„šæœ¬ä»»åŠ¡å¡ç‰‡æ§ä»¶ï¼ˆæµå¼å¸ƒå±€ä¸­çš„å•ä¸ªå¡ç‰‡ï¼‰
    /// åœ¨è®¾è®¡å™¨ä¸­åˆ›å»ºUI
    /// </summary>
    public partial class ScriptTaskCard : XtraUserControl
    {
        private ScriptTask _task;
        private System.Windows.Forms.Timer? _thumbnailTimer;
        
        public ScriptTaskCard(ScriptTask task)
        {
            InitializeComponent(); // è®¾è®¡å™¨ä¸­åˆ›å»ºUI
            _task = task;
            InitializeCard();
            StartThumbnailUpdate();
        }
        
        /// <summary>
        /// åˆå§‹åŒ–å¡ç‰‡æ˜¾ç¤º
        /// </summary>
        private void InitializeCard()
        {
            // æ˜¾ç¤ºä»»åŠ¡ä¿¡æ¯
            lblTaskName.Text = _task.Name;
            lblUrl.Text = _task.Url;
            lblStatus.Text = _task.Status.ToString();
            
            // ç»‘å®šäº‹ä»¶
            btnStart.Click += BtnStart_Click;
            btnStop.Click += BtnStop_Click;
            btnEdit.Click += BtnEdit_Click;
            btnDelete.Click += BtnDelete_Click;
            btnShowBrowser.Click += BtnShowBrowser_Click;
        }
        
        /// <summary>
        /// å¯åŠ¨ç¼©ç•¥å›¾æ›´æ–°ï¼ˆ1ç§’ä¸€æ¬¡ï¼‰
        /// </summary>
        private void StartThumbnailUpdate()
        {
            _thumbnailTimer = new System.Windows.Forms.Timer
            {
                Interval = 1000 // 1ç§’
            };
            _thumbnailTimer.Tick += async (s, e) => await UpdateThumbnailAsync();
            _thumbnailTimer.Start();
        }
        
        /// <summary>
        /// æ›´æ–°æµè§ˆå™¨ç¼©ç•¥å›¾
        /// </summary>
        private async Task UpdateThumbnailAsync()
        {
            if (_task.BrowserProxy?.WindowHandle != IntPtr.Zero)
            {
                try
                {
                    // ä½¿ç”¨ Windows API æ•è·çª—å£æˆªå›¾
                    var thumbnail = CaptureWindowThumbnail(_task.BrowserProxy.WindowHandle);
                    if (thumbnail != null)
                    {
                        picThumbnail.Image = thumbnail;
                        _task.Thumbnail = thumbnail;
                    }
                }
                catch (Exception ex)
                {
                    // é™é»˜å¤„ç†é”™è¯¯ï¼Œä¸å½±å“ä¸»æµç¨‹
                }
            }
        }
        
        /// <summary>
        /// æ•è·çª—å£ç¼©ç•¥å›¾
        /// </summary>
        private Image? CaptureWindowThumbnail(IntPtr hWnd)
        {
            // ä½¿ç”¨ PrintWindow API æˆ– BitBlt æ•è·çª—å£
            // è¿”å›ç¼©ç•¥å›¾ Image
        }
        
        // äº‹ä»¶å¤„ç†...
    }
}
```

**UIå¸ƒå±€è®¾è®¡ï¼ˆåœ¨è®¾è®¡å™¨ä¸­åˆ›å»ºï¼‰**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä»»åŠ¡åç§°: [ä»»åŠ¡1]          [çŠ¶æ€]   â”‚
â”‚ URL: https://example.com            â”‚
â”‚                                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚                             â”‚   â”‚
â”‚ â”‚   æµè§ˆå™¨ç¼©ç•¥å›¾ (å®æ—¶æ›´æ–°)    â”‚   â”‚
â”‚ â”‚                             â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚
â”‚ [å¯åŠ¨] [åœæ­¢] [ç¼–è¾‘] [åˆ é™¤] [æ˜¾ç¤º]  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

#### ScriptTaskFlowLayoutï¼ˆæµå¼å¸ƒå±€å®¹å™¨ï¼‰
```csharp
namespace æ°¸åˆ©ç³»ç»Ÿ.Views.Dashboard.Controls
{
    /// <summary>
    /// è„šæœ¬ä»»åŠ¡æµå¼å¸ƒå±€å®¹å™¨
    /// åœ¨è®¾è®¡å™¨ä¸­åˆ›å»ºï¼Œä½¿ç”¨ FlowLayoutPanel
    /// </summary>
    public partial class ScriptTaskFlowLayout : XtraUserControl
    {
        private readonly DataCollectionService _collectionService;
        private readonly List<ScriptTask> _tasks = new();
        private readonly Dictionary<int, ScriptTaskCard> _cardMap = new();
        
        public ScriptTaskFlowLayout()
        {
            InitializeComponent(); // è®¾è®¡å™¨ä¸­åˆ›å»º FlowLayoutPanel
            _collectionService = new DataCollectionService();
            LoadTasks();
        }
        
        /// <summary>
        /// åŠ è½½æ‰€æœ‰ä»»åŠ¡
        /// </summary>
        private void LoadTasks()
        {
            _tasks.Clear();
            _tasks.AddRange(_collectionService.LoadAllScriptTasks());
            
            // ä¸ºæ¯ä¸ªä»»åŠ¡åˆ›å»ºå¡ç‰‡
            foreach (var task in _tasks)
            {
                AddTaskCard(task);
            }
        }
        
        /// <summary>
        /// æ·»åŠ ä»»åŠ¡å¡ç‰‡
        /// </summary>
        private void AddTaskCard(ScriptTask task)
        {
            var card = new ScriptTaskCard(task);
            card.Width = 300; // å›ºå®šå®½åº¦
            card.Height = 250; // å›ºå®šé«˜åº¦
            card.Margin = new Padding(5);
            
            flowLayoutPanel.Controls.Add(card);
            _cardMap[task.Id] = card;
        }
        
        /// <summary>
        /// æ·»åŠ æ–°ä»»åŠ¡
        /// </summary>
        public void AddNewTask()
        {
            // å¼¹å‡ºé…ç½®å¯¹è¯æ¡†
            using var dialog = new ScriptTaskConfigDialog();
            if (dialog.ShowDialog() == DialogResult.OK)
            {
                var task = dialog.GetTask();
                _collectionService.SaveScriptTask(task); // è‡ªåŠ¨ä¿å­˜
                _tasks.Add(task);
                AddTaskCard(task);
            }
        }
        
        /// <summary>
        /// æ›´æ–°ä»»åŠ¡
        /// </summary>
        public void UpdateTask(ScriptTask task)
        {
            _collectionService.SaveScriptTask(task); // è‡ªåŠ¨ä¿å­˜
            if (_cardMap.TryGetValue(task.Id, out var card))
            {
                card.UpdateTask(task);
            }
        }
        
        /// <summary>
        /// åˆ é™¤ä»»åŠ¡
        /// </summary>
        public void DeleteTask(int taskId)
        {
            _collectionService.DeleteScriptTask(taskId);
            if (_cardMap.TryGetValue(taskId, out var card))
            {
                flowLayoutPanel.Controls.Remove(card);
                _cardMap.Remove(taskId);
            }
            _tasks.RemoveAll(t => t.Id == taskId);
        }
    }
}
```

---

### 4. æµè§ˆå™¨é›†æˆ

#### ScriptTaskBrowserManagerï¼ˆæµè§ˆå™¨ç®¡ç†å™¨ï¼‰
```csharp
namespace æ°¸åˆ©ç³»ç»Ÿ.Services.Dashboard
{
    /// <summary>
    /// è„šæœ¬ä»»åŠ¡æµè§ˆå™¨ç®¡ç†å™¨
    /// è´Ÿè´£ç®¡ç†æ¯ä¸ªä»»åŠ¡çš„æµè§ˆå™¨çª—å£
    /// </summary>
    public class ScriptTaskBrowserManager
    {
        private readonly Dictionary<int, BrowserWindowProxy> _browserProxies = new();
        
        /// <summary>
        /// åˆå§‹åŒ–ä»»åŠ¡çš„æµè§ˆå™¨çª—å£
        /// </summary>
        public async Task InitializeBrowserAsync(ScriptTask task)
        {
            if (task.BrowserProxy != null)
                return;
            
            var proxy = new BrowserWindowProxy();
            proxy.OnLog += (s, msg) => 
            {
                // è®°å½•æ—¥å¿—
            };
            
            await proxy.InitializeAsync($"{task.Name} - æµè§ˆå™¨", task.Url);
            
            task.BrowserProxy = proxy;
            _browserProxies[task.Id] = proxy;
            
            // å¦‚æœé…ç½®äº†è‡ªåŠ¨ç™»å½•ï¼Œæ‰§è¡Œç™»å½•
            if (task.AutoLogin && !string.IsNullOrEmpty(task.Username))
            {
                await ExecuteLoginAsync(task);
            }
        }
        
        /// <summary>
        /// æ‰§è¡Œç™»å½•
        /// </summary>
        private async Task ExecuteLoginAsync(ScriptTask task)
        {
            if (task.BrowserProxy == null) return;
            
            // æ‰§è¡Œç™»å½•è„šæœ¬
            await task.BrowserProxy.ExecuteCommandAsync("ç™»å½•", new
            {
                username = task.Username,
                password = task.Password
            });
        }
        
        /// <summary>
        /// æ‰§è¡Œé‡‡é›†è„šæœ¬
        /// </summary>
        public async Task<string?> ExecuteScriptAsync(ScriptTask task)
        {
            if (task.BrowserProxy == null) return null;
            
            var result = await task.BrowserProxy.ExecuteCommandAsync("æ‰§è¡Œè„šæœ¬", task.Script);
            return result.Data?.ToString();
        }
        
        /// <summary>
        /// æ˜¾ç¤º/éšè—æµè§ˆå™¨çª—å£
        /// </summary>
        public void ShowBrowser(ScriptTask task, bool show)
        {
            task.BrowserProxy?.SetVisible(show);
        }
        
        /// <summary>
        /// é‡Šæ”¾æµè§ˆå™¨èµ„æº
        /// </summary>
        public void DisposeBrowser(ScriptTask task)
        {
            if (_browserProxies.TryGetValue(task.Id, out var proxy))
            {
                proxy.Dispose();
                _browserProxies.Remove(task.Id);
            }
            task.BrowserProxy = null;
        }
    }
}
```

---

### 5. é…ç½®å¯¹è¯æ¡†

#### ScriptTaskConfigDialogï¼ˆé…ç½®å¯¹è¯æ¡†ï¼‰
```csharp
namespace æ°¸åˆ©ç³»ç»Ÿ.Views.Dashboard
{
    /// <summary>
    /// è„šæœ¬ä»»åŠ¡é…ç½®å¯¹è¯æ¡†
    /// ä½¿ç”¨ MonitorConfigControl ä½œä¸ºé…ç½®ç•Œé¢
    /// </summary>
    public partial class ScriptTaskConfigDialog : XtraForm
    {
        private MonitorConfigControl _configControl;
        private ScriptTask? _task; // å¦‚æœä¸º nullï¼Œè¡¨ç¤ºæ–°å»ºï¼›å¦åˆ™ä¸ºç¼–è¾‘
        
        public ScriptTaskConfigDialog(ScriptTask? task = null)
        {
            InitializeComponent(); // è®¾è®¡å™¨ä¸­åˆ›å»º
            _task = task;
            InitializeConfigControl();
        }
        
        private void InitializeConfigControl()
        {
            _configControl = new MonitorConfigControl();
            _configControl.Dock = DockStyle.Fill;
            this.Controls.Add(_configControl);
            
            // å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼ŒåŠ è½½ç°æœ‰é…ç½®
            if (_task != null)
            {
                _configControl.Url = _task.Url;
                _configControl.Username = _task.Username;
                _configControl.Password = _task.Password;
                _configControl.AutoLogin = _task.AutoLogin;
                _configControl.Script = _task.Script;
            }
        }
        
        /// <summary>
        /// è·å–é…ç½®çš„ä»»åŠ¡å¯¹è±¡
        /// </summary>
        public ScriptTask GetTask()
        {
            var task = _task ?? new ScriptTask();
            task.Name = $"ä»»åŠ¡_{DateTime.Now:yyyyMMddHHmmss}";
            task.Url = _configControl.Url;
            task.Username = _configControl.Username;
            task.Password = _configControl.Password;
            task.AutoLogin = _configControl.AutoLogin;
            task.Script = _configControl.Script;
            return task;
        }
    }
}
```

---

## ğŸ”„ å·¥ä½œæµç¨‹

### 1. æ·»åŠ ä»»åŠ¡æµç¨‹
```
ç”¨æˆ·ç‚¹å‡» buttonAddScriptTask
    â†“
å¼¹å‡º ScriptTaskConfigDialogï¼ˆä½¿ç”¨ MonitorConfigControlï¼‰
    â†“
ç”¨æˆ·å¡«å†™é…ç½®ï¼ˆURLã€ç”¨æˆ·åã€å¯†ç ã€è„šæœ¬ç­‰ï¼‰
    â†“
ç‚¹å‡»ç¡®å®š
    â†“
åˆ›å»º ScriptTask å¯¹è±¡
    â†“
ä¿å­˜åˆ°æ•°æ®åº“ï¼ˆè‡ªåŠ¨ä¿å­˜ï¼‰
    â†“
åˆ›å»º ScriptTaskCard å¹¶æ·»åŠ åˆ°æµå¼å¸ƒå±€
    â†“
åˆå§‹åŒ–æµè§ˆå™¨çª—å£ï¼ˆBrowserWindowProxyï¼‰
    â†“
å¼€å§‹æ›´æ–°ç¼©ç•¥å›¾ï¼ˆ1ç§’ä¸€æ¬¡ï¼‰
```

### 2. å¯åŠ¨ä»»åŠ¡æµç¨‹
```
ç”¨æˆ·ç‚¹å‡»å¡ç‰‡ä¸Šçš„"å¯åŠ¨"æŒ‰é’®
    â†“
è°ƒç”¨ ScriptTaskBrowserManager.InitializeBrowserAsync()
    â†“
åˆ›å»º BrowserWindowProxy å¹¶åˆå§‹åŒ–æµè§ˆå™¨çª—å£
    â†“
å¦‚æœé…ç½®äº†è‡ªåŠ¨ç™»å½•ï¼Œæ‰§è¡Œç™»å½•
    â†“
æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸º Running
    â†“
å¼€å§‹æ‰§è¡Œè„šæœ¬ï¼ˆå®šæ—¶æˆ–æ‰‹åŠ¨ï¼‰
```

### 3. ç¼©ç•¥å›¾æ›´æ–°æµç¨‹
```
ScriptTaskCard å¯åŠ¨å®šæ—¶å™¨ï¼ˆ1ç§’é—´éš”ï¼‰
    â†“
æ£€æŸ¥ BrowserProxy.WindowHandle æ˜¯å¦æœ‰æ•ˆ
    â†“
ä½¿ç”¨ Windows API æ•è·çª—å£æˆªå›¾
    â†“
ç”Ÿæˆç¼©ç•¥å›¾ï¼ˆç¼©æ”¾ä¸ºå¡ç‰‡å¤§å°ï¼‰
    â†“
æ›´æ–° picThumbnail.Image
    â†“
1ç§’åé‡å¤
```

### 4. æ•°æ®ä¿å­˜æµç¨‹
```
ä»»åŠ¡å¯¹è±¡å±æ€§å˜æ›´
    â†“
è§¦å‘ ScriptTaskFlowLayout.UpdateTask()
    â†“
è°ƒç”¨ DataCollectionService.SaveScriptTask()
    â†“
è‡ªåŠ¨ä¿å­˜åˆ°å…±åŒçš„ app.db æ•°æ®åº“ï¼ˆScriptTasks è¡¨ï¼‰
```

### 5. å¯åŠ¨æ—¶åŠ è½½æµç¨‹
```
DataCollectionPage åˆå§‹åŒ–
    â†“
åˆ›å»º ScriptTaskFlowLayout
    â†“
ScriptTaskFlowLayout æ„é€ å‡½æ•°è°ƒç”¨ LoadTasks()
    â†“
ä»æ•°æ®åº“åŠ è½½æ‰€æœ‰ä»»åŠ¡
    â†“
ä¸ºæ¯ä¸ªä»»åŠ¡åˆ›å»ºå¡ç‰‡
    â†“
å¦‚æœä»»åŠ¡ IsEnabled = trueï¼Œè‡ªåŠ¨åˆå§‹åŒ–æµè§ˆå™¨
```

---

## ğŸ“Š æ•°æ®åº“è¡¨ç»“æ„

### ScriptTasks è¡¨
```sql
CREATE TABLE ScriptTasks (
    Id INTEGER PRIMARY KEY AUTOINCREMENT,
    Name TEXT NOT NULL,
    Url TEXT NOT NULL,
    Username TEXT,
    Password TEXT,
    AutoLogin INTEGER NOT NULL DEFAULT 0,
    Script TEXT,
    CreateTime TEXT NOT NULL,
    UpdateTime TEXT NOT NULL,
    IsEnabled INTEGER NOT NULL DEFAULT 1
);
```

---

## ğŸ¨ UI è®¾è®¡è¦ç‚¹

### 1. ScriptTaskCard å¸ƒå±€ï¼ˆåœ¨è®¾è®¡å™¨ä¸­åˆ›å»ºï¼‰
- **å°ºå¯¸**: 300x250 åƒç´ 
- **å¸ƒå±€**: ä½¿ç”¨ LayoutControl æˆ– TableLayoutPanel
- **æ§ä»¶**:
  - Label: ä»»åŠ¡åç§°
  - Label: URLï¼ˆå¯æˆªæ–­æ˜¾ç¤ºï¼‰
  - Label: çŠ¶æ€
  - PictureBox: æµè§ˆå™¨ç¼©ç•¥å›¾ï¼ˆ200x150ï¼‰
  - SimpleButton: å¯åŠ¨ã€åœæ­¢ã€ç¼–è¾‘ã€åˆ é™¤ã€æ˜¾ç¤ºæµè§ˆå™¨

### 2. ScriptTaskFlowLayout å¸ƒå±€ï¼ˆåœ¨è®¾è®¡å™¨ä¸­åˆ›å»ºï¼‰
- **å®¹å™¨**: FlowLayoutPanel
- **æ–¹å‘**: FlowDirection.LeftToRight
- **æ¢è¡Œ**: WrapContents = true
- **é—´è·**: 5 åƒç´ 

### 3. groupCustTask å¸ƒå±€
- **å®¹å™¨**: GroupControl
- **å†…å®¹**: ScriptTaskFlowLayoutï¼ˆDock = Fillï¼‰
- **æ ‡é¢˜**: "[åŠè‡ªåŠ¨]å®šåˆ¶é‡‡é›†ä»»åŠ¡"

---

## ğŸ”§ æŠ€æœ¯å®ç°ç»†èŠ‚

### 1. çª—å£æˆªå›¾ï¼ˆç¼©ç•¥å›¾ç”Ÿæˆï¼‰
```csharp
[DllImport("user32.dll")]
private static extern bool PrintWindow(IntPtr hWnd, IntPtr hdcBlt, int nFlags);

private Image? CaptureWindowThumbnail(IntPtr hWnd)
{
    if (hWnd == IntPtr.Zero) return null;
    
    var rect = new RECT();
    GetWindowRect(hWnd, out rect);
    
    int width = rect.Right - rect.Left;
    int height = rect.Bottom - rect.Top;
    
    if (width <= 0 || height <= 0) return null;
    
    using var bmp = new Bitmap(width, height);
    using var g = Graphics.FromImage(bmp);
    var hdc = g.GetHdc();
    
    PrintWindow(hWnd, hdc, 0);
    g.ReleaseHdc(hdc);
    
    // ç¼©æ”¾ä¸ºç¼©ç•¥å›¾å¤§å°
    var thumbnail = new Bitmap(200, 150);
    using (var g2 = Graphics.FromImage(thumbnail))
    {
        g2.DrawImage(bmp, 0, 0, 200, 150);
    }
    
    return thumbnail;
}
```

### 2. SQLite æ“ä½œï¼ˆä½¿ç”¨å…±åŒçš„æ•°æ®åº“ï¼‰
- ä½¿ç”¨ `SQLite` å‘½åç©ºé—´ï¼ˆ`using SQLite;`ï¼‰
- ä½¿ç”¨ `SQLiteConnection` è¿æ¥å…±åŒçš„ `app.db` æ•°æ®åº“
- ä½¿ç”¨ `CreateTable<T>()` åˆ›å»º `ScriptTasks` è¡¨ï¼ˆæ–°å¢è¡¨ï¼Œä¸ç°æœ‰è¡¨å…±å­˜ï¼‰
- ä½¿ç”¨ `Insert()` / `Update()` / `Delete()` æ“ä½œæ•°æ®
- æ•°æ®åº“è·¯å¾„ï¼š`C:\Users\[ç”¨æˆ·å]\AppData\Local\æ°¸åˆ©ç³»ç»Ÿ\Data\app.db`

### 3. æµè§ˆå™¨çª—å£ç®¡ç†
- ä½¿ç”¨ `BrowserWindowProxy` ç®¡ç†æµè§ˆå™¨çª—å£
- æ¯ä¸ªä»»åŠ¡ç‹¬ç«‹ä¸€ä¸ªæµè§ˆå™¨çª—å£
- æµè§ˆå™¨çª—å£è¿è¡Œåœ¨ç‹¬ç«‹ STA çº¿ç¨‹
- é€šè¿‡ `ExecuteCommandAsync()` æ‰§è¡Œè„šæœ¬

---

## âœ… å®ç°æ£€æŸ¥æ¸…å•

### æ•°æ®æ¨¡å‹
- [ ] åˆ›å»º `ScriptTask` ç±»
- [ ] åˆ›å»º `ScriptTaskStatus` æšä¸¾
- [ ] æ·»åŠ  `[Ignore]` å±æ€§æ ‡è®°è¿è¡Œæ—¶å±æ€§

### æ•°æ®åº“å±‚ï¼ˆé›†æˆåˆ° DataCollectionServiceï¼‰
- [ ] åœ¨ `DataCollectionService` ä¸­æ·»åŠ  `InitializeScriptTasksTable()`
- [ ] åœ¨ `DataCollectionService` ä¸­æ·»åŠ  `LoadAllScriptTasks()`
- [ ] åœ¨ `DataCollectionService` ä¸­æ·»åŠ  `SaveScriptTask()`
- [ ] åœ¨ `DataCollectionService` ä¸­æ·»åŠ  `DeleteScriptTask()`
- [ ] ç¡®ä¿ä½¿ç”¨å…±åŒçš„ `app.db` æ•°æ®åº“æ–‡ä»¶

### UI æ§ä»¶ï¼ˆè®¾è®¡å™¨ä¸­åˆ›å»ºï¼‰
- [ ] åˆ›å»º `ScriptTaskCard` ç”¨æˆ·æ§ä»¶
- [ ] åˆ›å»º `ScriptTaskFlowLayout` ç”¨æˆ·æ§ä»¶
- [ ] åˆ›å»º `ScriptTaskConfigDialog` å¯¹è¯æ¡†

### æµè§ˆå™¨é›†æˆ
- [ ] åˆ›å»º `ScriptTaskBrowserManager`
- [ ] å®ç°æµè§ˆå™¨åˆå§‹åŒ–
- [ ] å®ç°è„šæœ¬æ‰§è¡Œ
- [ ] å®ç°ç¼©ç•¥å›¾æ•è·

### é›†æˆåˆ°é¡µé¢
- [ ] åœ¨ `DataCollectionPage` ä¸­æ·»åŠ  `ScriptTaskFlowLayout`
- [ ] ç»‘å®š `buttonAddScriptTask` ç‚¹å‡»äº‹ä»¶
- [ ] å®ç°å¯åŠ¨æ—¶è‡ªåŠ¨åŠ è½½

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **è®¾è®¡å™¨ä¼˜å…ˆ**: æ‰€æœ‰ UI æ§ä»¶å¿…é¡»åœ¨è®¾è®¡å™¨ä¸­åˆ›å»ºï¼Œä¸è¦ç”¨ä»£ç åˆ›å»º
2. **è‡ªåŠ¨ä¿å­˜**: ä»»åŠ¡æ·»åŠ ã€ä¿®æ”¹åç«‹å³ä¿å­˜åˆ°æ•°æ®åº“
3. **èµ„æºç®¡ç†**: æµè§ˆå™¨çª—å£éœ€è¦æ­£ç¡®é‡Šæ”¾ï¼Œé¿å…å†…å­˜æ³„æ¼
4. **çº¿ç¨‹å®‰å…¨**: ç¼©ç•¥å›¾æ›´æ–°éœ€è¦åœ¨ UI çº¿ç¨‹æ‰§è¡Œ
5. **æ€§èƒ½ä¼˜åŒ–**: ç¼©ç•¥å›¾æ›´æ–°é¢‘ç‡ä¸º 1 ç§’ï¼Œé¿å…è¿‡äºé¢‘ç¹

---

## ğŸ¯ åç»­æ‰©å±•

1. **ä»»åŠ¡è°ƒåº¦**: æ”¯æŒå®šæ—¶æ‰§è¡Œè„šæœ¬
2. **è„šæœ¬æ¨¡æ¿**: æä¾›å¸¸ç”¨è„šæœ¬æ¨¡æ¿
3. **ä»»åŠ¡åˆ†ç»„**: æ”¯æŒä»»åŠ¡åˆ†ç»„ç®¡ç†
4. **æ‰§è¡Œå†å²**: è®°å½•è„šæœ¬æ‰§è¡Œå†å²
5. **é€šçŸ¥æé†’**: è„šæœ¬æ‰§è¡Œç»“æœé€šçŸ¥

---

**è®¾è®¡å®Œæˆï¼Œç­‰å¾…ç¡®è®¤åå¼€å§‹å®ç°** âœ…
