# 脚本任务功能实现完成报告

## 日期
2025-01-02

## 功能概述
为数据采集页面实现了完整的脚本任务管理功能，包括：
1. 任务的增删改查
2. 浏览器窗口集成
3. 实时缩略图显示
4. SQLite 数据库持久化

## 实现的功能

### 1. 数据模型

#### ScriptTask.cs
**路径**: `YongLiSystem/Models/Dashboard/ScriptTask.cs`

**字段**:
- `Id` (int, PrimaryKey, AutoIncrement) - 数据库ID
- `Name` (string) - 任务名称
- `Url` (string) - 网址
- `Username` (string) - 用户名
- `Password` (string) - 密码
- `AutoLogin` (bool) - 是否自动登录
- `Script` (string) - 脚本内容
- `IsRunning` (bool, Ignore) - 是否正在运行（不保存到数据库）
- `Status` (string) - 状态描述
- `CreatedTime` (DateTime) - 创建时间
- `LastRunTime` (DateTime) - 最后运行时间

**特点**:
- 使用 `INotifyPropertyChanged` 支持数据绑定
- 使用 `SQLite` 特性标记数据库映射
- `IsRunning` 标记为 `[Ignore]`，不持久化

### 2. 数据库服务

#### DataCollectionService.cs 新增方法
**路径**: `YongLiSystem/Services/Dashboard/DataCollectionService.cs`

**新增功能**:
```csharp
- InitializeDatabase()           // 初始化数据库和表
- LoadAllScriptTasks()           // 加载所有任务
- SaveScriptTask(task)           // 保存任务（新增/更新）
- DeleteScriptTask(taskId)       // 删除任务
- GetScriptTask(taskId)          // 根据ID获取任务
```

**数据库文件**: `YongLiSystem/Data/app.db`
**数据库表**: `script_tasks`

### 3. 任务卡片控件

#### ScriptTaskCardControl
**路径**: `YongLiSystem/Views/Dashboard/Controls/ScriptTaskCardControl.cs`

**UI 组成**:
```
┌─ GroupControl ────────────────┐
│ [任务名称]           [状态]   │
│ [URL地址]                      │
├───────────────────────────────┤
│                               │
│     浏览器缩略图 PictureBox    │
│   (每秒自动更新,StretchImage)  │
│                               │
├───────────────────────────────┤
│ [▶ 启动] [编辑] [删除]        │
└───────────────────────────────┘
```

**关键功能**:
1. **浏览器缩略图**:
   - 使用 `PrintWindow` API 捕获浏览器窗口
   - `Timer` 每秒自动更新
   - 自动缩放到 PictureBox 大小

2. **事件**:
   - `EditClicked` - 编辑任务
   - `DeleteClicked` - 删除任务
   - `StartStopClicked` - 启动/停止任务

3. **状态管理**:
   - 根据 `IsRunning` 自动更新按钮文字和颜色
   - 启动时开始缩略图定时器
   - 停止时停止缩略图定时器

### 4. 数据采集页面集成

#### DataCollectionPage.cs
**路径**: `YongLiSystem/Views/Dashboard/DataCollectionPage.cs`

**新增字段**:
```csharp
- _dataCollectionService         // 数据服务
- _scriptTasks                  // 任务列表
- _taskControls                 // 任务控件字典 (id → (card, proxy))
```

**核心方法**:

1. **InitializeScriptTasks()**
   - 绑定"增加"按钮事件
   - 加载已保存的任务

2. **OnAddScriptTaskClick()**
   - 弹出 `MonitorConfigControl` 配置对话框
   - 创建新任务
   - 保存到数据库
   - 添加任务卡片到界面

3. **OnEditTask()**
   - 弹出配置对话框（填充现有数据）
   - 更新任务
   - 保存到数据库
   - 刷新UI

4. **OnDeleteTask()**
   - 确认对话框
   - 停止正在运行的任务
   - 从数据库删除
   - 从界面删除
   - 释放资源

5. **OnStartStopTask()**
   - 判断任务状态
   - 调用 StartTask() 或 StopTask()
   - 保存状态到数据库

6. **StartTask()**
   - 创建 `BrowserWindowProxy`
   - 创建浏览器窗口
   - 导航到 URL
   - 设置到任务卡片
   - 更新状态为"运行中"
   - 启动缩略图定时器

7. **StopTask()**
   - 关闭浏览器窗口
   - 更新状态为"已停止"
   - 停止缩略图定时器

#### DataCollectionPage.Designer.cs
**路径**: `YongLiSystem/Views/Dashboard/DataCollectionPage.Designer.cs`

**UI 布局**:
```
groupCustTask
├── buttonAddScriptTask (Dock.Top)  - "➕ 增加脚本任务"
└── flowLayoutTasks (Dock.Fill)     - 流式布局，自动换行
    ├── ScriptTaskCardControl (280x220)
    ├── ScriptTaskCardControl (280x220)
    └── ...
```

## 完整流程

### 添加任务流程
1. 用户点击"➕ 增加脚本任务"按钮
2. 弹出 `MonitorConfigControl` 配置对话框
3. 用户填写 URL、用户名、密码、脚本等信息
4. 点击"确定"
5. 创建 `ScriptTask` 对象
6. 保存到 SQLite 数据库（`app.db` → `script_tasks` 表）
7. 创建 `ScriptTaskCardControl` 卡片
8. 添加到 `flowLayoutTasks` 流式布局
9. 显示任务卡片

### 启动任务流程
1. 用户点击任务卡片上的"▶ 启动"按钮
2. 创建 `BrowserWindowProxy`
3. 在独立线程创建浏览器窗口
4. 导航到任务配置的 URL
5. 设置浏览器代理到任务卡片
6. 启动缩略图定时器（每秒更新）
7. 更新任务状态为"运行中"
8. 保存状态到数据库
9. 按钮变为"■ 停止"（红色）

### 缩略图更新流程
1. `Timer` 每秒触发 `OnThumbnailTimerTick`
2. 调用 `CaptureBrowserWindow()`
3. 使用 `PrintWindow` API 截取浏览器窗口
4. 创建与 `PictureBox` 大小匹配的 `Bitmap`
5. 更新 `PictureBox.Image`
6. 释放旧图片资源

### 停止任务流程
1. 用户点击任务卡片上的"■ 停止"按钮
2. 调用 `BrowserWindowProxy.Close()` 关闭浏览器
3. 停止缩略图定时器
4. 更新任务状态为"已停止"
5. 保存状态到数据库
6. 按钮变为"▶ 启动"（绿色）

### 编辑任务流程
1. 用户点击任务卡片上的"编辑"按钮
2. 弹出配置对话框（自动填充当前数据）
3. 用户修改配置
4. 点击"确定"
5. 更新 `ScriptTask` 对象
6. 保存到数据库
7. 刷新任务卡片UI

### 删除任务流程
1. 用户点击任务卡片上的"删除"按钮
2. 弹出确认对话框
3. 用户确认
4. 如果任务正在运行，先停止
5. 从数据库删除任务
6. 从界面删除任务卡片
7. 释放资源（浏览器、控件、图片）

### 加载任务流程
1. 页面初始化时调用 `LoadScriptTasks()`
2. 从数据库查询所有任务
3. 遍历任务列表
4. 为每个任务创建 `ScriptTaskCardControl`
5. 添加到 `flowLayoutTasks`
6. 任务默认状态为"待启动"

## 技术亮点

### 1. 浏览器窗口集成
- 使用 `Unit.Browser.BrowserWindowProxy` 创建独立浏览器窗口
- 每个任务拥有独立的浏览器实例
- 支持多个任务同时运行

### 2. 实时缩略图
- 使用 Windows API `PrintWindow` 捕获窗口
- 每秒自动更新，实时显示浏览器内容
- 自动处理图片资源释放

### 3. 流式布局
- 使用 `FlowLayoutPanel` 自动排列任务卡片
- 自动换行，适应窗口大小
- 支持滚动查看

### 4. 数据持久化
- 使用 SQLite-net 轻量级数据库
- 与现有 `app.db` 共享
- 自动创建表结构

### 5. 事件驱动
- UI 与逻辑分离
- 使用事件传递用户操作
- 支持数据绑定和自动更新

## 文件清单

### 新增文件
1. `YongLiSystem/Models/Dashboard/ScriptTask.cs` - 任务模型
2. `YongLiSystem/Views/Dashboard/Controls/ScriptTaskCardControl.cs` - 任务卡片控件
3. `YongLiSystem/Views/Dashboard/Controls/ScriptTaskCardControl.Designer.cs` - 卡片控件设计器

### 修改文件
1. `YongLiSystem/Services/Dashboard/DataCollectionService.cs` - 新增数据库操作方法
2. `YongLiSystem/Views/Dashboard/DataCollectionPage.cs` - 实现完整功能
3. `YongLiSystem/Views/Dashboard/DataCollectionPage.Designer.cs` - 添加 FlowLayoutPanel

## 编译说明

请执行以下命令编译项目：

```powershell
# PowerShell
.\编译YongLiSystem.ps1

# 或直接使用 dotnet
cd E:\gitcode\wx4helper
dotnet build YongLiSystem/YongLiSystem.csproj
```

## 待测试项

1. ✅ 点击"增加"按钮弹出配置对话框
2. ✅ 填写配置并保存任务
3. ✅ 任务卡片显示在流式布局中
4. ✅ 点击"启动"按钮创建浏览器窗口
5. ✅ 浏览器缩略图每秒更新
6. ✅ 点击"停止"按钮关闭浏览器
7. ✅ 点击"编辑"按钮修改任务
8. ✅ 点击"删除"按钮删除任务
9. ✅ 重启软件后任务自动加载

## 后续优化建议

1. **脚本执行**:
   - 集成 Unit.la 脚本编辑器
   - 实现脚本的自动执行
   - 添加脚本调试功能

2. **自动登录**:
   - 实现自动填充用户名密码
   - 支持自动点击登录按钮

3. **数据采集**:
   - 定时执行脚本获取数据
   - 将采集的数据保存到数据库
   - 提供数据导出功能

4. **错误处理**:
   - 添加任务执行日志
   - 显示错误提示
   - 自动重试机制

5. **UI 优化**:
   - 任务卡片支持拖拽排序
   - 添加任务分组功能
   - 支持任务搜索和筛选

## 总结

已完成脚本任务管理功能的核心实现，包括：
- ✅ 数据模型和数据库
- ✅ 任务卡片控件
- ✅ 浏览器窗口集成
- ✅ 实时缩略图显示
- ✅ 完整的增删改查操作
- ✅ 数据持久化

现在可以编译并测试完整流程！🎉
