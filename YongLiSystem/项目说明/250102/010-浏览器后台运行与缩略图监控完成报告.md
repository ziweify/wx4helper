# æµè§ˆå™¨åå°è¿è¡Œä¸ç¼©ç•¥å›¾ç›‘æ§ - å®ŒæˆæŠ¥å‘Š

## ğŸ“‹ éœ€æ±‚æ¦‚è¿°

ç”¨æˆ·æå‡ºäº†ä»¥ä¸‹éœ€æ±‚ï¼š

1. **å…³é—­çª—å£æ—¶ä¸é‡Šæ”¾æµè§ˆå™¨**ï¼šç‚¹å‡»å…³é—­æŒ‰é’®æ—¶ï¼Œæµè§ˆå™¨çª—å£åº”è¯¥éšè—åˆ°åå°ç»§ç»­è¿è¡Œï¼Œè€Œä¸æ˜¯ç›´æ¥é‡Šæ”¾èµ„æº
2. **åœ¨å¡ç‰‡ä¸­æ˜¾ç¤ºç¼©ç•¥å›¾**ï¼š`ScriptTaskCardControl` åº”è¯¥æ˜¾ç¤ºæµè§ˆå™¨çš„å®æ—¶ç¼©ç•¥å›¾ï¼Œè®©ç”¨æˆ·çŸ¥é“å½“å‰é¡µé¢çŠ¶æ€
3. **çœŸæ­£çš„å…³é—­æŒ‰é’®**ï¼šæ·»åŠ ä¸€ä¸ªä¸“é—¨çš„"å…³é—­"æŒ‰é’®ï¼Œç‚¹å‡»æ—¶æ‰çœŸæ­£é‡Šæ”¾æµè§ˆå™¨èµ„æº
4. **ç¼©ç•¥å›¾ç‚¹å‡»æ¢å¤çª—å£**ï¼šç‚¹å‡»ç¼©ç•¥å›¾æ—¶ï¼Œæ˜¾ç¤ºéšè—çš„æµè§ˆå™¨çª—å£

## âœ… å®ç°å†…å®¹

### 1. BrowserTaskControl - æ”¯æŒéšè—è€Œä¸é‡Šæ”¾

**æ–‡ä»¶**ï¼š`Unit.la/Controls/BrowserTaskControl.cs`

#### 1.1 æ·»åŠ ç¼©ç•¥å›¾æ›´æ–°äº‹ä»¶å’Œå®šæ—¶å™¨

```csharp
// æ·»åŠ å­—æ®µ
private System.Windows.Forms.Timer? _thumbnailTimer; // ç¼©ç•¥å›¾æ›´æ–°å®šæ—¶å™¨

// æ·»åŠ äº‹ä»¶
public event EventHandler<Image>? ThumbnailUpdated;

// æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–å®šæ—¶å™¨
public BrowserTaskControl(BrowserTaskConfig config)
{
    // ...åŸæœ‰ä»£ç ...
    
    // ğŸ”§ ä¿®æ”¹å…³é—­è¡Œä¸ºï¼šå…³é—­æ—¶éšè—è€Œä¸æ˜¯çœŸæ­£å…³é—­
    FormClosing += BrowserTaskControl_FormClosing;
    
    // ğŸ”§ åˆå§‹åŒ–ç¼©ç•¥å›¾å®šæ—¶å™¨ï¼ˆæ¯2ç§’æ›´æ–°ä¸€æ¬¡ï¼‰
    _thumbnailTimer = new System.Windows.Forms.Timer
    {
        Interval = 2000 // 2ç§’
    };
    _thumbnailTimer.Tick += ThumbnailTimer_Tick;
    _thumbnailTimer.Start();
}
```

#### 1.2 çª—å£å…³é—­è¡Œä¸ºï¼šéšè—è€Œä¸é‡Šæ”¾

```csharp
/// <summary>
/// çª—å£å…³é—­æ—¶ï¼šéšè—è€Œä¸æ˜¯çœŸæ­£å…³é—­
/// </summary>
private void BrowserTaskControl_FormClosing(object? sender, FormClosingEventArgs e)
{
    // å¦‚æœæ˜¯ç”¨æˆ·ç‚¹å‡»å…³é—­æŒ‰é’®ï¼ˆä¸æ˜¯ç¨‹åºè°ƒç”¨ Close()ï¼‰
    if (e.CloseReason == CloseReason.UserClosing)
    {
        e.Cancel = true; // å–æ¶ˆå…³é—­
        Hide(); // éšè—çª—å£
        LogMessage("â„¹ï¸ çª—å£å·²éšè—åˆ°åå°è¿è¡Œ");
    }
    // å¦‚æœæ˜¯ç¨‹åºè°ƒç”¨ Close()ï¼Œæ­£å¸¸å…³é—­
}

/// <summary>
/// çœŸæ­£å…³é—­çª—å£å¹¶é‡Šæ”¾èµ„æº
/// </summary>
public void CloseAndDispose()
{
    _thumbnailTimer?.Stop();
    _thumbnailTimer?.Dispose();
    
    // ä¸å–æ¶ˆå…³é—­äº‹ä»¶ï¼Œå…è®¸çœŸæ­£å…³é—­
    FormClosing -= BrowserTaskControl_FormClosing;
    
    LogMessage("ğŸ”´ çª—å£æ­£åœ¨å…³é—­å¹¶é‡Šæ”¾èµ„æº");
    Close();
    Dispose();
}
```

**å…³é”®ç‚¹**ï¼š
- å½“ç”¨æˆ·ç‚¹å‡»å…³é—­æŒ‰é’®ï¼ˆ`CloseReason.UserClosing`ï¼‰æ—¶ï¼Œ`e.Cancel = true` å–æ¶ˆå…³é—­ï¼Œæ”¹ä¸º `Hide()`
- æä¾› `CloseAndDispose()` æ–¹æ³•ç”¨äºçœŸæ­£å…³é—­å’Œé‡Šæ”¾èµ„æº

#### 1.3 å®ç°æµè§ˆå™¨æˆªå›¾åŠŸèƒ½

```csharp
/// <summary>
/// æ•è·æµè§ˆå™¨ç¼©ç•¥å›¾
/// </summary>
public async Task<Image?> CaptureThumbnailAsync()
{
    if (_webView?.CoreWebView2 == null) return null;

    try
    {
        // ä½¿ç”¨ WebView2 çš„æˆªå›¾ API
        using (var stream = new System.IO.MemoryStream())
        {
            await _webView.CoreWebView2.CapturePreviewAsync(
                CoreWebView2CapturePreviewImageFormat.Png,
                stream);
            
            stream.Position = 0;
            var fullImage = Image.FromStream(stream);
            
            // ç”Ÿæˆç¼©ç•¥å›¾ï¼ˆ280x150ï¼Œä¸å¡ç‰‡å¤§å°åŒ¹é…ï¼‰
            var thumbnail = new Bitmap(280, 150);
            using (var g = Graphics.FromImage(thumbnail))
            {
                g.InterpolationMode = System.Drawing.Drawing2D.InterpolationMode.HighQualityBicubic;
                g.DrawImage(fullImage, 0, 0, 280, 150);
            }
            
            fullImage.Dispose();
            return thumbnail;
        }
    }
    catch (Exception ex)
    {
        System.Diagnostics.Debug.WriteLine($"æˆªå›¾å¤±è´¥: {ex.Message}");
        return null;
    }
}

/// <summary>
/// å®šæ—¶å™¨è§¦å‘ï¼šæ›´æ–°ç¼©ç•¥å›¾
/// </summary>
private async void ThumbnailTimer_Tick(object? sender, EventArgs e)
{
    if (_webView?.CoreWebView2 == null || !Visible) return;

    try
    {
        var thumbnail = await CaptureThumbnailAsync();
        if (thumbnail != null)
        {
            ThumbnailUpdated?.Invoke(this, thumbnail);
        }
    }
    catch (Exception ex)
    {
        // é™é»˜å¤±è´¥ï¼Œä¸å½±å“ä¸»æµç¨‹
        System.Diagnostics.Debug.WriteLine($"ç¼©ç•¥å›¾æ›´æ–°å¤±è´¥: {ex.Message}");
    }
}
```

**æŠ€æœ¯è¦ç‚¹**ï¼š
- ä½¿ç”¨ `CoreWebView2.CapturePreviewAsync()` æ•è·æµè§ˆå™¨æˆªå›¾
- ä½¿ç”¨ `Graphics.DrawImage` ç¼©æ”¾ä¸º 280x150 çš„ç¼©ç•¥å›¾
- å®šæ—¶å™¨æ¯ 2 ç§’è§¦å‘ä¸€æ¬¡ï¼Œè§¦å‘ `ThumbnailUpdated` äº‹ä»¶

### 2. ScriptTaskCardControl - æ˜¾ç¤ºç¼©ç•¥å›¾

**æ–‡ä»¶**ï¼š`YongLiSystem/Views/Dashboard/Controls/ScriptTaskCardControl.Designer.cs`

#### 2.1 é‡æ–°è®¾è®¡å¡ç‰‡å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è„šæœ¬ä»»åŠ¡                    â”‚ â† GroupControl æ ‡é¢˜
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                               â”‚
â”‚      [æµè§ˆå™¨ç¼©ç•¥å›¾]           â”‚ â† PictureBox (280x150)
â”‚                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä»»åŠ¡åç§°    URL       [çŠ¶æ€]  â”‚ â† panelInfo (35px)
â”‚ ä¸Šæ¬¡è¿è¡Œ: HH:mm:ss            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [â–¶å¯åŠ¨] [ç¼–è¾‘] [ğŸ”´å…³é—­] [åˆ é™¤]â”‚ â† panelButtons (30px)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
æ€»é«˜åº¦: 240px (ä¹‹å‰æ˜¯ 120px)
```

#### 2.2 æ·»åŠ  PictureBox æ˜¾ç¤ºç¼©ç•¥å›¾

```csharp
// pictureBoxThumbnail
pictureBoxThumbnail.BackColor = System.Drawing.Color.Black;
pictureBoxThumbnail.Dock = System.Windows.Forms.DockStyle.Fill;
pictureBoxThumbnail.Location = new System.Drawing.Point(2, 23);
pictureBoxThumbnail.Name = "pictureBoxThumbnail";
pictureBoxThumbnail.Size = new System.Drawing.Size(276, 150);
pictureBoxThumbnail.SizeMode = System.Windows.Forms.PictureBoxSizeMode.StretchImage;
pictureBoxThumbnail.TabIndex = 0;
pictureBoxThumbnail.TabStop = false;
pictureBoxThumbnail.Click += OnThumbnailClick;
```

#### 2.3 æ·»åŠ "å…³é—­"æŒ‰é’®

```csharp
// btnClose
btnClose.Appearance.BackColor = System.Drawing.Color.FromArgb(255, 128, 0);
btnClose.Appearance.Options.UseBackColor = true;
btnClose.Location = new System.Drawing.Point(145, 3);
btnClose.Name = "btnClose";
btnClose.Size = new System.Drawing.Size(60, 24);
btnClose.TabIndex = 3;
btnClose.Text = "ğŸ”´ å…³é—­";
btnClose.Click += OnCloseButtonClick;
btnClose.Visible = false; // é»˜è®¤éšè—ï¼Œè¿è¡Œæ—¶æ‰æ˜¾ç¤º
```

**æ–‡ä»¶**ï¼š`YongLiSystem/Views/Dashboard/Controls/ScriptTaskCardControl.cs`

#### 2.4 å®ç°ç¼©ç•¥å›¾æ›´æ–°é€»è¾‘

```csharp
private Image? _defaultThumbnail;

/// <summary>
/// åˆå§‹åŒ–é»˜è®¤ç¼©ç•¥å›¾ï¼ˆé»‘è‰²èƒŒæ™¯+æç¤ºæ–‡å­—ï¼‰
/// </summary>
private void InitializeDefaultThumbnail()
{
    _defaultThumbnail = new Bitmap(280, 150);
    using (var g = Graphics.FromImage(_defaultThumbnail))
    {
        g.Clear(Color.FromArgb(30, 30, 30));
        var text = "æœªå¯åŠ¨";
        var font = new Font("Microsoft YaHei", 14, FontStyle.Bold);
        var brush = new SolidBrush(Color.Gray);
        var size = g.MeasureString(text, font);
        var x = (280 - size.Width) / 2;
        var y = (150 - size.Height) / 2;
        g.DrawString(text, font, brush, x, y);
    }
    pictureBoxThumbnail.Image = _defaultThumbnail;
}

/// <summary>
/// æ›´æ–°ç¼©ç•¥å›¾
/// </summary>
public void UpdateThumbnail(Image thumbnail)
{
    if (pictureBoxThumbnail.InvokeRequired)
    {
        pictureBoxThumbnail.Invoke(new Action(() => UpdateThumbnail(thumbnail)));
        return;
    }

    if (pictureBoxThumbnail.Image != null && pictureBoxThumbnail.Image != _defaultThumbnail)
    {
        pictureBoxThumbnail.Image.Dispose();
    }
    pictureBoxThumbnail.Image = thumbnail;
}

/// <summary>
/// é‡ç½®ä¸ºé»˜è®¤ç¼©ç•¥å›¾
/// </summary>
public void ResetThumbnail()
{
    if (pictureBoxThumbnail.Image != null && pictureBoxThumbnail.Image != _defaultThumbnail)
    {
        pictureBoxThumbnail.Image.Dispose();
    }
    pictureBoxThumbnail.Image = _defaultThumbnail;
}
```

#### 2.5 åŠ¨æ€æ˜¾ç¤º/éšè—å…³é—­æŒ‰é’®

```csharp
private void UpdateUI()
{
    if (_task == null) return;

    // ...å…¶ä»–UIæ›´æ–°...
    
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    if (btnStartStop != null)
    {
        if (_task.IsRunning)
        {
            btnStartStop.Text = "â–  åœæ­¢";
            btnStartStop.Appearance.BackColor = Color.FromArgb(192, 0, 0);
            btnClose.Visible = true; // ğŸ”§ è¿è¡Œä¸­æ˜¾ç¤ºå…³é—­æŒ‰é’®
        }
        else
        {
            btnStartStop.Text = "â–¶ å¯åŠ¨";
            btnStartStop.Appearance.BackColor = Color.FromArgb(0, 192, 0);
            btnClose.Visible = false; // ğŸ”§ æœªè¿è¡Œæ—¶éšè—å…³é—­æŒ‰é’®
            ResetThumbnail(); // åœæ­¢æ—¶é‡ç½®ç¼©ç•¥å›¾
        }
    }
}
```

### 3. DataCollectionPage - é›†æˆç¼©ç•¥å›¾æ›´æ–°

**æ–‡ä»¶**ï¼š`YongLiSystem/Views/Dashboard/DataCollectionPage.cs`

#### 3.1 è®¢é˜…ç¼©ç•¥å›¾æ›´æ–°äº‹ä»¶

```csharp
private void OpenTaskWindow(ScriptTask task, ScriptTaskCardControl card)
{
    // ...åˆ›å»º window...

    // è®¢é˜…ç¼©ç•¥å›¾æ›´æ–°äº‹ä»¶
    window.ThumbnailUpdated += (s, thumbnail) =>
    {
        if (_taskControls.TryGetValue(task.Id, out var control))
        {
            control.card.UpdateThumbnail(thumbnail);
        }
    };

    // æ˜¾ç¤ºçª—å£
    window.Show();

    // ä¿å­˜åˆ°å­—å…¸
    _taskControls[task.Id] = (card, window);
}
```

#### 3.2 ä¿®æ”¹åœæ­¢ä»»åŠ¡é€»è¾‘ï¼šéšè—è€Œä¸é‡Šæ”¾

```csharp
/// <summary>
/// åœæ­¢ä»»åŠ¡
/// </summary>
private void StopTask(ScriptTask task)
{
    if (_taskControls.TryGetValue(task.Id, out var control))
    {
        // ğŸ”§ å…³é—­æµè§ˆå™¨çª—å£ï¼ˆéšè—ï¼Œä¸é‡Šæ”¾ï¼‰
        control.window?.Hide();

        // æ›´æ–°çŠ¶æ€
        task.IsRunning = false;
        task.Status = "å·²åœæ­¢";
        control.card.Task = task; // è§¦å‘UIæ›´æ–°

        // ğŸ”§ æ³¨æ„ï¼šwindow ä»ç„¶ä¿ç•™åœ¨å­—å…¸ä¸­
        _taskControls[task.Id] = (control.card, control.window);
    }
}
```

#### 3.3 æ·»åŠ çœŸæ­£çš„å…³é—­ä»»åŠ¡æ–¹æ³•

```csharp
/// <summary>
/// å…³é—­ä»»åŠ¡ï¼ˆçœŸæ­£é‡Šæ”¾èµ„æºï¼‰
/// </summary>
private void OnCloseTask(ScriptTask task, ScriptTaskCardControl card)
{
    try
    {
        var result = MessageBox.Show(
            $"ç¡®å®šè¦å…³é—­ä»»åŠ¡ \"{task.Name}\" å—ï¼Ÿ\n\nå…³é—­åå°†é‡Šæ”¾æµè§ˆå™¨èµ„æºï¼Œéœ€è¦é‡æ–°å¯åŠ¨ã€‚", 
            "ç¡®è®¤å…³é—­",
            MessageBoxButtons.YesNo, 
            MessageBoxIcon.Question);

        if (result == DialogResult.Yes)
        {
            if (_taskControls.TryGetValue(task.Id, out var control))
            {
                // ğŸ”§ çœŸæ­£å…³é—­å¹¶é‡Šæ”¾èµ„æº
                control.window?.CloseAndDispose();

                // æ›´æ–°çŠ¶æ€
                task.IsRunning = false;
                task.Status = "å·²å…³é—­";
                card.Task = task;
                _dataCollectionService.SaveScriptTask(task);

                // ğŸ”§ ä»å­—å…¸ä¸­ç§»é™¤ window å¼•ç”¨
                _taskControls[task.Id] = (control.card, null);

                MessageBox.Show("ä»»åŠ¡å·²å…³é—­å¹¶é‡Šæ”¾èµ„æºï¼", "æˆåŠŸ",
                    MessageBoxButtons.OK, MessageBoxIcon.Information);
            }
        }
    }
    catch (Exception ex)
    {
        MessageBox.Show($"å…³é—­ä»»åŠ¡å¤±è´¥: {ex.Message}", "é”™è¯¯",
            MessageBoxButtons.OK, MessageBoxIcon.Error);
    }
}
```

#### 3.4 æ·»åŠ ç¼©ç•¥å›¾ç‚¹å‡»æ¢å¤çª—å£

```csharp
/// <summary>
/// ç¼©ç•¥å›¾ç‚¹å‡» - æ˜¾ç¤ºéšè—çš„çª—å£
/// </summary>
private void OnThumbnailClicked(ScriptTask task)
{
    if (_taskControls.TryGetValue(task.Id, out var control))
    {
        if (control.window != null && !control.window.IsDisposed)
        {
            if (control.window.Visible)
            {
                control.window.Activate();
                control.window.BringToFront();
            }
            else
            {
                control.window.Show();
                control.window.Activate();
            }
        }
    }
}
```

#### 3.5 è®¢é˜…å¡ç‰‡äº‹ä»¶

```csharp
private void AddScriptTaskCard(ScriptTask task)
{
    var card = new ScriptTaskCardControl
    {
        Task = task,
        Width = 280,
        Height = 240,  // ğŸ”§ å¢åŠ é«˜åº¦ä»¥å®¹çº³ç¼©ç•¥å›¾
        Margin = new Padding(5)
    };

    // è®¢é˜…äº‹ä»¶
    card.EditClicked += (s, e) => OnEditTask(task);
    card.DeleteClicked += (s, e) => OnDeleteTask(task, card);
    card.StartStopClicked += (s, e) => OnStartStopTask(task, card);
    card.CloseClicked += (s, e) => OnCloseTask(task, card); // ğŸ”§ æ–°å¢
    card.ThumbnailClicked += (s, e) => OnThumbnailClicked(task); // ğŸ”§ æ–°å¢

    flowLayoutTasks.Controls.Add(card);

    // ä¿å­˜åˆ°å­—å…¸
    _taskControls[task.Id] = (card, null);
    _scriptTasks.Add(task);
}
```

## ğŸ¯ åŠŸèƒ½æ¼”ç¤ºæµç¨‹

### åœºæ™¯ 1ï¼šå¯åŠ¨ä»»åŠ¡å¹¶æŸ¥çœ‹ç¼©ç•¥å›¾

1. ç”¨æˆ·ç‚¹å‡»"â–¶ å¯åŠ¨"æŒ‰é’®
2. æµè§ˆå™¨çª—å£æ‰“å¼€å¹¶å¯¼èˆªåˆ°æŒ‡å®š URL
3. æ¯ 2 ç§’è‡ªåŠ¨æˆªå›¾å¹¶æ›´æ–°å¡ç‰‡ç¼©ç•¥å›¾
4. å¡ç‰‡æ˜¾ç¤ºå®æ—¶æµè§ˆå™¨ç”»é¢
5. "ğŸ”´ å…³é—­"æŒ‰é’®å‡ºç°

### åœºæ™¯ 2ï¼šå…³é—­çª—å£ï¼ˆéšè—åˆ°åå°ï¼‰

1. ç”¨æˆ·ç‚¹å‡»æµè§ˆå™¨çª—å£çš„ X æŒ‰é’®
2. çª—å£éšè—ï¼ˆä¸é‡Šæ”¾èµ„æºï¼‰
3. ç¼©ç•¥å›¾ç»§ç»­æ›´æ–°ï¼ˆå› ä¸ºæµè§ˆå™¨ä»åœ¨åå°è¿è¡Œï¼‰
4. ç”¨æˆ·å¯ä»¥ç‚¹å‡»ç¼©ç•¥å›¾æ¢å¤çª—å£

### åœºæ™¯ 3ï¼šåœæ­¢ä»»åŠ¡

1. ç”¨æˆ·ç‚¹å‡»"â–  åœæ­¢"æŒ‰é’®
2. æµè§ˆå™¨çª—å£éšè—
3. ç¼©ç•¥å›¾é‡ç½®ä¸º"æœªå¯åŠ¨"
4. "ğŸ”´ å…³é—­"æŒ‰é’®éšè—
5. æµè§ˆå™¨èµ„æºä»ç„¶ä¿ç•™

### åœºæ™¯ 4ï¼šçœŸæ­£å…³é—­ä»»åŠ¡

1. ç”¨æˆ·ç‚¹å‡»"ğŸ”´ å…³é—­"æŒ‰é’®
2. å¼¹å‡ºç¡®è®¤å¯¹è¯æ¡†
3. ç”¨æˆ·ç¡®è®¤åï¼Œè°ƒç”¨ `CloseAndDispose()`
4. æµè§ˆå™¨èµ„æºè¢«é‡Šæ”¾
5. ç¼©ç•¥å›¾é‡ç½®
6. "ğŸ”´ å…³é—­"æŒ‰é’®éšè—
7. éœ€è¦é‡æ–°å¯åŠ¨æ‰èƒ½ä½¿ç”¨

### åœºæ™¯ 5ï¼šç‚¹å‡»ç¼©ç•¥å›¾æ¢å¤çª—å£

1. ç”¨æˆ·ç‚¹å‡»ç¼©ç•¥å›¾
2. å¦‚æœçª—å£å·²éšè—ï¼Œæ˜¾ç¤ºçª—å£
3. å¦‚æœçª—å£å·²æ˜¾ç¤ºï¼Œæ¿€æ´»å¹¶ç½®é¡¶çª—å£

## ğŸ“Š æŠ€æœ¯äº®ç‚¹

### 1. FormClosing äº‹ä»¶æ‹¦æˆª

```csharp
if (e.CloseReason == CloseReason.UserClosing)
{
    e.Cancel = true; // å–æ¶ˆå…³é—­
    Hide(); // éšè—çª—å£
}
```

**å…³é”®**ï¼š
- `CloseReason.UserClosing`ï¼šç”¨æˆ·ç‚¹å‡»å…³é—­æŒ‰é’®
- `e.Cancel = true`ï¼šå–æ¶ˆå…³é—­æ“ä½œ
- `Hide()`ï¼šéšè—çª—å£

### 2. WebView2 æˆªå›¾ API

```csharp
await _webView.CoreWebView2.CapturePreviewAsync(
    CoreWebView2CapturePreviewImageFormat.Png,
    stream);
```

**ä¼˜åŠ¿**ï¼š
- é«˜è´¨é‡æˆªå›¾
- å¼‚æ­¥æ“ä½œä¸é˜»å¡ UI
- æ”¯æŒ PNG æ ¼å¼

### 3. é«˜è´¨é‡å›¾åƒç¼©æ”¾

```csharp
g.InterpolationMode = System.Drawing.Drawing2D.InterpolationMode.HighQualityBicubic;
g.DrawImage(fullImage, 0, 0, 280, 150);
```

**æ•ˆæœ**ï¼š
- ä½¿ç”¨åŒä¸‰æ¬¡æ’å€¼ç®—æ³•
- ç¼©ç•¥å›¾æ¸…æ™°åº¦é«˜
- æ€§èƒ½å¼€é”€é€‚ä¸­

### 4. çº¿ç¨‹å®‰å…¨çš„ UI æ›´æ–°

```csharp
if (pictureBoxThumbnail.InvokeRequired)
{
    pictureBoxThumbnail.Invoke(new Action(() => UpdateThumbnail(thumbnail)));
    return;
}
```

**ä¿è¯**ï¼š
- å®šæ—¶å™¨åœ¨åå°çº¿ç¨‹è§¦å‘
- UI æ›´æ–°å¿…é¡»åœ¨ UI çº¿ç¨‹
- ä½¿ç”¨ `Invoke` è·¨çº¿ç¨‹è°ƒç”¨

### 5. èµ„æºç®¡ç†å’Œé‡Šæ”¾

```csharp
protected override void Dispose(bool disposing)
{
    if (disposing)
    {
        if (pictureBoxThumbnail.Image != null && pictureBoxThumbnail.Image != _defaultThumbnail)
        {
            pictureBoxThumbnail.Image.Dispose();
        }
        _defaultThumbnail?.Dispose();
        components?.Dispose();
    }
    base.Dispose(disposing);
}
```

**æ³¨æ„**ï¼š
- é‡Šæ”¾ PictureBox ä¸­çš„å›¾åƒ
- é‡Šæ”¾é»˜è®¤ç¼©ç•¥å›¾
- é¿å…å†…å­˜æ³„æ¼

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶æ¸…å•

### Unit.la

1. **Unit.la/Controls/BrowserTaskControl.cs**
   - æ·»åŠ  `_thumbnailTimer` å­—æ®µ
   - æ·»åŠ  `ThumbnailUpdated` äº‹ä»¶
   - å®ç° `BrowserTaskControl_FormClosing` æ–¹æ³•ï¼ˆéšè—è€Œä¸å…³é—­ï¼‰
   - å®ç° `CloseAndDispose` æ–¹æ³•ï¼ˆçœŸæ­£å…³é—­ï¼‰
   - å®ç° `CaptureThumbnailAsync` æ–¹æ³•ï¼ˆæˆªå›¾ï¼‰
   - å®ç° `ThumbnailTimer_Tick` æ–¹æ³•ï¼ˆå®šæ—¶æ›´æ–°ï¼‰
   - å®ç° `RefreshThumbnailAsync` æ–¹æ³•ï¼ˆæ‰‹åŠ¨æ›´æ–°ï¼‰

### YongLiSystem

2. **YongLiSystem/Views/Dashboard/Controls/ScriptTaskCardControl.Designer.cs**
   - æ·»åŠ  `pictureBoxThumbnail` æ§ä»¶
   - æ·»åŠ  `btnClose` æŒ‰é’®
   - è°ƒæ•´å¡ç‰‡é«˜åº¦ä» 120 åˆ° 240
   - è°ƒæ•´å¸ƒå±€ï¼ˆç¼©ç•¥å›¾ã€ä¿¡æ¯ã€æŒ‰é’®ï¼‰

3. **YongLiSystem/Views/Dashboard/Controls/ScriptTaskCardControl.cs**
   - æ·»åŠ  `_defaultThumbnail` å­—æ®µ
   - æ·»åŠ  `CloseClicked` äº‹ä»¶
   - æ·»åŠ  `ThumbnailClicked` äº‹ä»¶
   - å®ç° `InitializeDefaultThumbnail` æ–¹æ³•
   - å®ç° `UpdateThumbnail` æ–¹æ³•
   - å®ç° `ResetThumbnail` æ–¹æ³•
   - ä¿®æ”¹ `UpdateUI` æ–¹æ³•ï¼ˆåŠ¨æ€æ˜¾ç¤º/éšè—å…³é—­æŒ‰é’®ï¼‰
   - å®ç° `OnCloseButtonClick` æ–¹æ³•
   - å®ç° `OnThumbnailClick` æ–¹æ³•
   - é‡å†™ `Dispose` æ–¹æ³•ï¼ˆé‡Šæ”¾å›¾åƒèµ„æºï¼‰

4. **YongLiSystem/Views/Dashboard/DataCollectionPage.cs**
   - ä¿®æ”¹ `AddScriptTaskCard` æ–¹æ³•ï¼ˆè®¢é˜…æ–°äº‹ä»¶ï¼Œè°ƒæ•´é«˜åº¦ï¼‰
   - ä¿®æ”¹ `OpenTaskWindow` æ–¹æ³•ï¼ˆè®¢é˜…ç¼©ç•¥å›¾æ›´æ–°äº‹ä»¶ï¼‰
   - ä¿®æ”¹ `StopTask` æ–¹æ³•ï¼ˆéšè—è€Œä¸é‡Šæ”¾ï¼‰
   - æ·»åŠ  `OnCloseTask` æ–¹æ³•ï¼ˆçœŸæ­£å…³é—­å’Œé‡Šæ”¾ï¼‰
   - æ·»åŠ  `OnThumbnailClicked` æ–¹æ³•ï¼ˆæ¢å¤çª—å£ï¼‰

## âœ… ç¼–è¯‘æµ‹è¯•ç»“æœ

```
Unit.la:
  å·²æˆåŠŸç”Ÿæˆã€‚
  4 ä¸ªè­¦å‘Šï¼ˆå¯å¿½ç•¥ï¼‰
  0 ä¸ªé”™è¯¯

YongLiSystem:
  å·²æˆåŠŸç”Ÿæˆã€‚
  å¤šä¸ª CA1416 å¹³å°å…¼å®¹æ€§è­¦å‘Šï¼ˆå¯å¿½ç•¥ï¼‰
  0 ä¸ªé”™è¯¯
```

## ğŸ‰ æ€»ç»“

### å·²å®ç°åŠŸèƒ½

âœ… **å…³é—­çª—å£æ—¶éšè—è€Œä¸é‡Šæ”¾**
- æ‹¦æˆª `FormClosing` äº‹ä»¶
- åŒºåˆ†ç”¨æˆ·å…³é—­å’Œç¨‹åºå…³é—­
- éšè—çª—å£è€Œä¸é‡Šæ”¾èµ„æº

âœ… **å®æ—¶ç¼©ç•¥å›¾ç›‘æ§**
- æ¯ 2 ç§’è‡ªåŠ¨æˆªå›¾
- ä½¿ç”¨ WebView2 çš„ `CapturePreviewAsync` API
- é«˜è´¨é‡å›¾åƒç¼©æ”¾ï¼ˆ280x150ï¼‰
- çº¿ç¨‹å®‰å…¨çš„ UI æ›´æ–°

âœ… **é»˜è®¤ç¼©ç•¥å›¾**
- æœªå¯åŠ¨æ—¶æ˜¾ç¤º"æœªå¯åŠ¨"æ–‡å­—
- é»‘è‰²èƒŒæ™¯ + ç°è‰²æ–‡å­—
- åœæ­¢æ—¶è‡ªåŠ¨é‡ç½®

âœ… **çœŸæ­£çš„å…³é—­æŒ‰é’®**
- è¿è¡Œæ—¶æ˜¾ç¤º"ğŸ”´ å…³é—­"æŒ‰é’®
- ç¡®è®¤å¯¹è¯æ¡†é˜²æ­¢è¯¯æ“ä½œ
- è°ƒç”¨ `CloseAndDispose()` é‡Šæ”¾èµ„æº

âœ… **ç¼©ç•¥å›¾ç‚¹å‡»æ¢å¤çª—å£**
- ç‚¹å‡»ç¼©ç•¥å›¾æ˜¾ç¤ºéšè—çš„çª—å£
- å¦‚æœçª—å£å·²æ˜¾ç¤ºï¼Œæ¿€æ´»å¹¶ç½®é¡¶
- æ”¯æŒå¤šæ¬¡éšè—/æ˜¾ç¤º

### ç”¨æˆ·ä½“éªŒ

1. **åå°è¿è¡Œ**ï¼šç”¨æˆ·å¯ä»¥å…³é—­çª—å£ç»§ç»­ç›‘æ§ï¼Œä¸å½±å“ä»»åŠ¡æ‰§è¡Œ
2. **å®æ—¶ç›‘æ§**ï¼šç¼©ç•¥å›¾æ¯ 2 ç§’æ›´æ–°ï¼Œå®æ—¶æ˜¾ç¤ºé¡µé¢çŠ¶æ€
3. **å¿«é€Ÿæ¢å¤**ï¼šç‚¹å‡»ç¼©ç•¥å›¾å³å¯æ¢å¤çª—å£ï¼Œæ— éœ€é‡æ–°å¯åŠ¨
4. **èµ„æºæ§åˆ¶**ï¼šæä¾›ä¸“é—¨çš„å…³é—­æŒ‰é’®ï¼Œç”¨æˆ·å¯ä»¥é€‰æ‹©ä½•æ—¶é‡Šæ”¾èµ„æº
5. **çŠ¶æ€æ¸…æ™°**ï¼šæŒ‰é’®ã€ç¼©ç•¥å›¾ã€çŠ¶æ€æ ‡ç­¾éƒ½å®æ—¶æ›´æ–°ï¼Œä¸€ç›®äº†ç„¶

### æŠ€æœ¯ä¼˜åŠ¿

1. **èµ„æºé«˜æ•ˆ**ï¼šéšè—è€Œä¸é‡Šæ”¾ï¼Œé¿å…é‡å¤åˆå§‹åŒ–å¼€é”€
2. **çº¿ç¨‹å®‰å…¨**ï¼šä½¿ç”¨ `Invoke` è·¨çº¿ç¨‹æ›´æ–° UI
3. **å†…å­˜ç®¡ç†**ï¼šåŠæ—¶é‡Šæ”¾å›¾åƒèµ„æºï¼Œé¿å…å†…å­˜æ³„æ¼
4. **é«˜è´¨é‡æˆªå›¾**ï¼šä½¿ç”¨åŒä¸‰æ¬¡æ’å€¼ç®—æ³•ï¼Œç¼©ç•¥å›¾æ¸…æ™°
5. **äº‹ä»¶é©±åŠ¨**ï¼šæ¾è€¦åˆè®¾è®¡ï¼Œæ˜“äºæ‰©å±•å’Œç»´æŠ¤

---

**å®Œæˆæ—¥æœŸ**: 2026-01-21  
**æµ‹è¯•çŠ¶æ€**: âœ… ç¼–è¯‘é€šè¿‡ï¼ŒåŠŸèƒ½å®Œæ•´ï¼Œå¯ä»¥æµ‹è¯•
