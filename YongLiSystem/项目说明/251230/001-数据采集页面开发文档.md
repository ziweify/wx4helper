# 数据采集页面开发文档

## 📅 文档信息
- **创建日期**: 2025-12-30
- **页面名称**: 数据采集 (DataCollectionPage)
- **位置**: 永利系统 → 数据采集 (Tab 第3位)

---

## 📋 功能概述

数据采集页面是一个用于从外部数据源采集数据的功能模块，支持手动和自动采集，提供实时状态监控和数据管理功能。

### 核心功能
- ✅ **实时统计**: 累计采集、今日采集、成功率、采集状态
- ✅ **数据源配置**: 支持配置数据源地址和采集间隔
- ✅ **手动采集**: 单次采集数据
- ✅ **自动采集**: 定时自动采集数据
- ✅ **数据管理**: 查看、清空、导出采集数据
- ✅ **连接测试**: 测试数据源连接状态
- ✅ **后台刷新**: 每3秒自动刷新数据

---

## 🎨 界面布局

### 1. 顶部统计面板 (4个卡片)

```
┌────────────┬────────────┬────────────┬────────────┐
│累计采集数据│今日采集数据│  成功率    │  采集状态  │
│   3250     │    125     │   95.6%    │   待机中   │
└────────────┴────────────┴────────────┴────────────┘
```

- **累计采集数据**: 蓝色 (0, 122, 204)
- **今日采集数据**: 绿色 (46, 204, 113)
- **成功率**: 红色 (231, 76, 60)
- **采集状态**: 紫色 (155, 89, 182)

### 2. 配置面板

```
┌─────────────────────────────────────────────────────┐
│ 数据源: [_____________________________]             │
│ 采集间隔(秒): [5] 自动采集: [开关] [测试连接]      │
└─────────────────────────────────────────────────────┘
```

**配置项：**
- **数据源 (TextEdit)**: 输入数据源地址 (如 http://api.example.com)
- **采集间隔 (SpinEdit)**: 1-3600秒，默认5秒
- **自动采集 (ToggleSwitch)**: 开启/关闭自动采集
- **测试连接 (Button)**: 测试数据源连接

### 3. 工具栏

```
[开始采集] [停止采集] [清空数据] [导出数据]
```

### 4. 数据列表 (GridControl)

| 列名 | 字段 | 说明 |
|------|------|------|
| ID | Id | 记录ID |
| 采集时间 | Timestamp | 格式: yyyy-MM-dd HH:mm:ss |
| 数据源 | DataSource | 数据来源 |
| 数据类型 | DataType | 数据分类 |
| 数据内容 | DataValue | JSON或其他格式 |
| 状态 | Status | 成功/失败 |
| 消息 | Message | 提示信息 |

---

## 📂 文件结构

```
永利系统/
├── Views/
│   └── Pages/
│       ├── DataCollectionPage.cs              # 页面代码
│       └── DataCollectionPage.Designer.cs     # 页面设计器
├── ViewModels/
│   └── DataCollectionViewModel.cs             # ViewModel
└── Models/
    └── DataCollectionItem.cs                  # 数据模型
```

---

## 🔧 技术实现

### DataCollectionPage.cs

**关键功能：**

```csharp
public partial class DataCollectionPage : Form
{
    private readonly DataCollectionViewModel _viewModel;
    private readonly LoggingService _loggingService;
    private System.Windows.Forms.Timer? _refreshTimer;
    
    public DataCollectionPage()
    {
        // 设置为非顶级窗口，可嵌入 TabPage
        TopLevel = false;
        FormBorderStyle = FormBorderStyle.None;
        Dock = DockStyle.Fill;
        
        _viewModel = new DataCollectionViewModel();
        _loggingService = LoggingService.Instance;
        
        BindViewModel();
        StartAutoRefresh();
    }
    
    private void StartAutoRefresh()
    {
        _refreshTimer = new System.Windows.Forms.Timer
        {
            Interval = 3000 // 每3秒刷新一次
        };
        _refreshTimer.Tick += (s, e) => _viewModel.RefreshData();
        _refreshTimer.Start();
    }
}
```

### DataCollectionViewModel.cs

**主要属性：**

| 属性 | 类型 | 说明 |
|------|------|------|
| TotalCollected | int | 累计采集数据 |
| TodayCollected | int | 今日采集数据 |
| SuccessRate | string | 成功率 (如 "95.6%") |
| CollectionStatus | string | 采集状态 |
| DataSource | string | 数据源地址 |
| CollectionInterval | int | 采集间隔(秒) |
| IsAutoCollecting | bool | 是否自动采集 |
| CollectionItems | ObservableCollection<DataCollectionItem> | 数据列表 |

**主要命令：**

```csharp
public ICommand? StartCollectionCommand { get; }      // 开始采集
public ICommand? StopCollectionCommand { get; }       // 停止采集
public ICommand? ClearDataCommand { get; }            // 清空数据
public ICommand? ExportDataCommand { get; }           // 导出数据
public ICommand? TestConnectionCommand { get; }       // 测试连接
```

**关键方法：**

```csharp
public void RefreshData()
{
    // 后台自动刷新，每3秒调用一次
    if (IsAutoCollecting)
    {
        TodayCollected++;
        TotalCollected++;
        
        var newItem = new DataCollectionItem
        {
            Id = CollectionItems.Count + 1,
            Timestamp = DateTime.Now,
            DataSource = DataSource,
            DataType = "自动采集",
            DataValue = $"{{\"data\":\"Sample data {DateTime.Now:HHmmss}\"}}",
            Status = "成功",
            Message = "自动采集成功"
        };
        
        CollectionItems.Insert(0, newItem);
        
        // 限制列表大小为100条
        while (CollectionItems.Count > 100)
        {
            CollectionItems.RemoveAt(CollectionItems.Count - 1);
        }
    }
}

public void StartAutoCollection()
{
    IsAutoCollecting = true;
    CollectionStatus = "自动采集中";
}

public void StopAutoCollection()
{
    IsAutoCollecting = false;
    CollectionStatus = "待机中";
}
```

### DataCollectionItem.cs

**数据模型：**

```csharp
public class DataCollectionItem
{
    public int Id { get; set; }                      // ID
    public DateTime Timestamp { get; set; }          // 采集时间
    public string DataSource { get; set; }           // 数据源
    public string DataType { get; set; }             // 数据类型
    public string DataValue { get; set; }            // 数据内容
    public string Status { get; set; }               // 状态
    public string Message { get; set; }              // 消息
}
```

---

## 🔗 集成到主窗口

### MainTabs.cs 修改

```csharp
private void InitializeTabs()
{
    // 创建所有标签页（顺序：主页/微信助手/数据采集/数据管理/报表分析/系统设置）
    CreateTabPage("主页", "Dashboard", new DashboardPage());
    CreateTabPage("微信助手", "Wechat", new WechatPage());
    CreateTabPage("数据采集", "DataCollection", new DataCollectionPage());  // 🆕 新增
    CreateTabPage("数据管理", "DataManagement", new DataManagementPage());
    CreateTabPage("报表分析", "Reports", new ReportsPage());
    CreateTabPage("系统设置", "Settings", new SettingsPage());
    
    // 默认选中微信助手（第2个标签页，索引为1）
    if (xtraTabControl1.TabPages.Count > 1)
    {
        xtraTabControl1.SelectedTabPageIndex = 1;
    }
}
```

---

## 🚀 使用说明

### 1. 配置数据源

1. 在"数据源"文本框中输入数据源地址
   - 例如: `http://api.example.com/data`
   - 支持 HTTP/HTTPS API 地址

2. 设置"采集间隔"
   - 范围: 1-3600秒
   - 默认: 5秒

3. 点击"测试连接"验证数据源

### 2. 手动采集

点击"开始采集"按钮，手动触发一次数据采集。

### 3. 自动采集

1. 打开"自动采集"开关
2. 系统将按照设置的间隔自动采集数据
3. 采集状态显示"自动采集中"
4. 关闭开关停止自动采集

### 4. 数据管理

- **查看数据**: 在数据列表中查看所有采集记录
- **清空数据**: 点击"清空数据"按钮清空所有记录
- **导出数据**: 点击"导出数据"按钮导出为文件

### 5. 实时监控

顶部4个统计卡片实时显示：
- 累计采集数据总数
- 今日采集数据总数
- 采集成功率
- 当前采集状态

---

## 🎯 后续扩展

### 待实现功能

1. **真实数据源对接**
   - HTTP API 调用
   - WebSocket 连接
   - 数据库查询
   - 文件监控

2. **数据处理**
   - JSON 解析
   - XML 解析
   - 数据验证
   - 数据转换

3. **数据持久化**
   - 保存到数据库
   - 导出为 Excel
   - 导出为 JSON
   - 导出为 CSV

4. **高级功能**
   - 采集任务调度
   - 采集规则配置
   - 数据去重
   - 异常重试
   - 采集日志

5. **图表统计**
   - 采集趋势图
   - 成功率曲线
   - 数据分布图
   - 实时监控面板

---

## 🔍 调试与测试

### 日志输出

页面集成了 `LoggingService`，所有关键操作都会记录日志：

```csharp
_loggingService.Info("数据采集", "数据采集页面已初始化");
_loggingService.Info("数据采集", "手动触发数据采集");
_loggingService.Info("数据采集", "已启动自动采集");
_loggingService.Debug("数据采集", "后台自动刷新中...");
```

### 示例数据

初始化时会添加2条示例数据：

```csharp
CollectionItems.Add(new DataCollectionItem
{
    Id = 1,
    Timestamp = DateTime.Now.AddMinutes(-5),
    DataSource = "API-001",
    DataType = "开奖数据",
    DataValue = "{\"issue\":\"20251230001\",\"numbers\":[1,2,3,4,5]}",
    Status = "成功",
    Message = "数据采集成功"
});
```

---

## 📚 参考资料

- [DevExpress XtraGrid 文档](https://docs.devexpress.com/WindowsForms/3442/controls-and-libraries/data-grid)
- [DevExpress LayoutControl 文档](https://docs.devexpress.com/WindowsForms/2323/controls-and-libraries/layout-control)
- [.NET 8 WinForms 文档](https://learn.microsoft.com/zh-cn/dotnet/desktop/winforms/)

---

## 📝 更新日志

### v1.0 (2025-12-30)
- ✅ 创建数据采集页面基础框架
- ✅ 实现4个统计卡片
- ✅ 实现数据源配置面板
- ✅ 实现工具栏操作按钮
- ✅ 实现数据列表显示
- ✅ 集成到主窗口 Tab
- ✅ 实现后台自动刷新 (3秒)
- ✅ 实现手动/自动采集切换
- ✅ 添加日志记录

---

**文档维护**: 开发团队  
**最后更新**: 2025-12-30

