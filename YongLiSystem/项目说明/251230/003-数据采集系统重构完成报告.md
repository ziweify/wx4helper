# 数据采集系统重构完成报告

**日期**: 2025-12-30  
**状态**: ✅ 已完成  
**参考**: WinSSSPlan/FrmTaiwanLottery

---

## 📋 概述

成功重构了永利系统的数据采集模块,将其独立到 `Dashboard` 文件夹中,并基于 WinSSSPlan 项目的 FrmTaiwanLottery 设计理念重新设计了界面和功能。

---

## 🗂️ 文件结构

### 新创建的文件

```
永利系统/
├── Models/
│   └── Dashboard/
│       ├── DataCollectionTask.cs         # 采集任务数据模型
│       └── DataCollectionConfig.cs       # 采集配置数据模型
├── Services/
│   └── Dashboard/
│       └── DataCollectionService.cs      # 采集服务 (核心业务逻辑)
├── ViewModels/
│   └── Dashboard/
│       └── DataCollectionViewModel.cs    # 采集页面 ViewModel
└── Views/
    └── Dashboard/
        ├── DataCollectionPage.cs         # 采集页面 (代码)
        └── DataCollectionPage.Designer.cs # 采集页面 (设计器)
```

### 删除的旧文件

```
永利系统/
├── ViewModels/
│   └── DataCollectionViewModel.cs        # ❌ 已删除
└── Views/
    └── Pages/
        ├── DataCollectionPage.cs         # ❌ 已删除
        └── DataCollectionPage.Designer.cs # ❌ 已删除
```

---

## 🎨 界面设计

### 布局结构

```
┌────────────────────────────────────────────────────────────────┐
│  数据采集页面                                                   │
├───────────────────────────┬────────────────────────────────────┤
│                           │                                    │
│  【待采集任务】(上表格)    │     【期号信息】                    │
│  ┌─────────────────────┐  │     - 当期期号: [__________]       │
│  │ ID │ 期号  │ 开奖号码│  │     - 开奖时间: [__________]       │
│  │ -- │ ----- │ -------│  │     - 下期期号: [__________]       │
│  │  1 │113xxx │01,02,03│  │     - 开奖时间: [__________]       │
│  │  2 │113xxx │        │  │     - 倒计时  : [05:00]            │
│  └─────────────────────┘  │     [获取期号信息]                 │
│                           │                                    │
├───────────────────────────┤  【数据源】                         │
│                           │     - 数据源URL                     │
│  【已完成任务】(下表格)    │     [________________________]     │
│  ┌─────────────────────┐  │     ☐ 使用代理 [127.0.0.1:7890]   │
│  │ ID │ 期号  │ 开奖号码│  │     [测试连接]                     │
│  │ -- │ ----- │ -------│  │                                    │
│  │ 10 │112xxx │05,15,25│  │  【提交地址】(多行)                 │
│  │  9 │112xxx │08,18,28│  │     [w168]http://...              │
│  │  8 │112xxx │01,11,21│  │     [boter]http://...             │
│  └─────────────────────┘  │     [wold]http://...              │
│                           │                                    │
│                           │  【操作】                           │
│                           │     [▶ 开始自动采集]                │
│                           │     [■ 停止自动采集]                │
│                           │     [手动采集当前期号]              │
│                           │     [清空已完成] [导出数据]         │
└───────────────────────────┴────────────────────────────────────┘
```

### 关键特点

1. **左侧: 双表格上下布局**
   - **上表格**: 待采集任务 (PendingTasks)
   - **下表格**: 已完成任务 (CompletedTasks)
   - **自动流转**: 采集成功后自动从上表格移到下表格

2. **右侧: 配置和操作面板**
   - **期号信息**: 当期/下期期号和倒计时
   - **数据源配置**: URL和代理设置
   - **提交地址**: 多行配置多个投递目标
   - **操作按钮**: 自动/手动采集、清空、导出

---

## 📊 数据模型

### 1. DataCollectionTask (采集任务)

```csharp
public class DataCollectionTask
{
    public int Id { get; set; }                    // 任务ID
    public int IssueId { get; set; }               // 期号
    public string OpenData { get; set; }           // 开奖数据 "01,02,03,04,05"
    public int AttemptCount { get; set; }          // 采集次数
    public DateTime? CollectionTime { get; set; }  // 采集时间
    public TaskStatus Status { get; set; }         // 状态: Pending/Collecting/Completed/Failed
    public string DataSource { get; set; }         // 数据源
    public string ErrorMessage { get; set; }       // 错误消息
    public DateTime CreatedTime { get; set; }      // 创建时间
    public DateTime UpdatedTime { get; set; }      // 更新时间
}

public enum TaskStatus
{
    Pending,    // 待采集
    Collecting, // 采集中
    Completed,  // 已完成
    Failed      // 失败
}
```

### 2. DataCollectionConfig (采集配置)

```csharp
public class DataCollectionConfig
{
    public string DataSourceUrl { get; set; }      // 数据源URL
    public int CollectionInterval { get; set; }    // 采集间隔(秒)
    public bool UseProxy { get; set; }             // 是否使用代理
    public string ProxyAddress { get; set; }       // 代理地址
    public string SubmitAddresses { get; set; }    // 提交地址(多行)
    public string CurrentIssue { get; set; }       // 当期期号
    public string CurrentOpenTime { get; set; }    // 当期开奖时间
    public string NextIssue { get; set; }          // 下期期号
    public string NextOpenTime { get; set; }       // 下期开奖时间
    public int Countdown { get; set; }             // 倒计时(秒)
    public bool IsAutoCollecting { get; set; }     // 是否自动采集
}
```

---

## 🔧 核心服务

### DataCollectionService

**职责**: 数据采集核心业务逻辑

**主要方法**:

| 方法 | 说明 |
|------|------|
| `StartAutoCollection()` | 开始自动采集 (后台定时任务) |
| `StopAutoCollection()` | 停止自动采集 |
| `CollectDataAsync()` | 手动采集指定期号 |
| `GetIssueInfoAsync()` | 获取期号信息 (当期/下期) |
| `SubmitDataAsync()` | 投递数据到多个API |
| `TestConnectionAsync()` | 测试数据源连接 |

**工作流程**:

```
1. StartAutoCollection()
   ↓
2. 每隔N秒检查待采集任务
   ↓
3. 调用 CollectDataAsync(issueId)
   ├→ 发起HTTP请求到数据源
   ├→ 解析HTML,提取开奖数据
   └→ 正则匹配期号和号码
   ↓
4. 采集成功?
   ├→ 是: 调用 SubmitDataAsync() 投递到API
   │      └→ 移动到已完成列表
   └→ 否: 增加尝试次数,保留在待采集列表
```

---

## 🎯 核心功能

### 1. 获取期号信息

**功能**: 从数据源获取当期和下期的期号及开奖时间

**操作**:
1. 点击 `[获取期号信息]` 按钮
2. 调用数据源API
3. 解析返回的JSON数据
4. 更新期号信息显示
5. 自动添加下期到待采集列表

### 2. 自动采集

**功能**: 后台定时自动采集开奖数据

**操作**:
1. 配置数据源URL
2. 配置采集间隔(默认5秒)
3. 点击 `[▶ 开始自动采集]` 按钮
4. 后台定时检查待采集任务
5. 自动采集、投递、更新状态

### 3. 手动采集

**功能**: 手动采集当前期号的开奖数据

**操作**:
1. 获取期号信息
2. 点击 `[手动采集当前期号]` 按钮
3. 立即采集当前期号
4. 采集成功后自动投递

### 4. 多API投递

**功能**: 一次采集,投递到多个API

**配置格式**:
```
[w168]http://8.134.71.102/api/api/upload_result.do,
[boter]http://8.134.71.102:789/api/boter/uploadbg,
[wold]http://8.138.183.44/api/task/upload_twbgone?token=xxx
```

**说明**:
- `[标识]`: 用于区分不同的API目标
- `URL`: 投递地址
- 每行一个地址,用逗号结尾

### 5. 代理支持

**功能**: 通过HTTP代理访问数据源

**用途**:
- 绕过IP限制
- 提高采集成功率
- 支持境外数据源

**配置**:
- 勾选 `☐ 使用代理`
- 输入代理地址 `127.0.0.1:7890`

### 6. 数据导出

**功能**: 导出已完成任务数据

**格式**: CSV / Excel (待实现)

---

## 🏗️ 技术栈

### UI框架
- **DevExpress GridControl**: 数据表格显示
- **DevExpress LayoutControl**: 自适应布局
- **DevExpress GroupControl**: 分组控件
- **DevExpress SimpleButton**: 按钮
- **DevExpress MemoEdit**: 多行文本框

### 数据绑定
- **ObservableCollection**: 数据集合 (自动更新UI)
- **DataBindings**: WinForms数据绑定
- **MVVM**: Model-View-ViewModel 设计模式

### 异步编程
- **async/await**: 异步采集任务
- **Task**: 后台采集线程
- **CancellationTokenSource**: 任务取消控制

### 日志系统
- **LoggingService**: 统一日志服务
- **日志级别**: Debug/Info/Warn/Error

---

## 📝 与 FrmTaiwanLottery 的对比

### 相似之处

1. **双表格布局**
   - 上表格: 待处理任务
   - 下表格: 已完成任务
   - 清晰的状态流转

2. **右侧配置面板**
   - 期号信息显示
   - 数据源配置
   - 提交地址配置

3. **核心功能**
   - 自动采集
   - 手动采集
   - 多API投递
   - 代理支持

### 改进之处

1. **架构升级**
   - ❌ 旧: 单文件混合 (UI + Logic)
   - ✅ 新: 分层架构 (Model/View/ViewModel/Service)

2. **UI框架**
   - ❌ 旧: CCWin 皮肤控件
   - ✅ 新: DevExpress 专业控件

3. **数据绑定**
   - ❌ 旧: 手动更新UI
   - ✅ 新: ObservableCollection 自动更新

4. **错误处理**
   - ❌ 旧: 基础的 try-catch
   - ✅ 新: 统一日志系统 + 错误状态管理

5. **代码复用**
   - ❌ 旧: 功能耦合在单个Form中
   - ✅ 新: Service 独立,可复用

---

## 🚀 下一步工作

### 待实现功能 (TODO)

1. **实际的HTTP请求逻辑**
   - [ ] 实现 HttpClient 请求封装
   - [ ] 实现 HTML 解析 (CsQuery/HtmlAgilityPack)
   - [ ] 实现正则表达式提取数据

2. **投递API适配**
   - [ ] 实现不同API的POST格式适配
   - [ ] 实现投递重试机制
   - [ ] 实现投递结果验证

3. **数据持久化**
   - [ ] 保存采集配置到数据库
   - [ ] 保存采集历史到数据库
   - [ ] 支持历史查询和统计

4. **数据导出**
   - [ ] 实现 CSV 导出
   - [ ] 实现 Excel 导出
   - [ ] 实现导出格式配置

5. **高级功能**
   - [ ] 采集失败重试机制
   - [ ] 采集结果通知 (邮件/微信)
   - [ ] 采集统计报表
   - [ ] 采集性能监控

---

## ✅ 完成清单

- [x] 创建 Dashboard 文件夹结构
- [x] 创建数据模型 (DataCollectionTask, DataCollectionConfig)
- [x] 创建采集服务 (DataCollectionService)
- [x] 创建 ViewModel (DataCollectionViewModel)
- [x] 创建页面 View (DataCollectionPage)
- [x] 删除旧的 DataCollection 文件
- [x] 更新 MainTabs 集成新页面
- [x] 编写分析文档 (FrmTaiwanLottery分析报告.md)
- [x] 编写完成报告 (本文档)

---

## 📚 参考文档

- **FrmTaiwanLottery 分析报告**: `永利系统/项目说明/251230/002-FrmTaiwanLottery分析报告.md`
- **WinSSSPlan 项目**: `WinSSSPlan/BgPlan/FrmTaiwanLottery.cs`

---

**报告完成日期**: 2025-12-30  
**报告作者**: AI Assistant

