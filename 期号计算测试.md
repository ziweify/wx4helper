# BaiShengVx3Plus å’Œ zhaocaimao æœŸå·æ•°æ®åˆ†ææŠ¥å‘Š

## ğŸ“‹ æ¦‚è¿°

ä¸¤ä¸ªé¡¹ç›®ä½¿ç”¨**å®Œå…¨ç›¸åŒçš„æœŸå·è®¡ç®—é€»è¾‘**ï¼Œéƒ½æ˜¯åŸºäºæœ¬åœ°æ—¶é—´è®¡ç®—ï¼Œä¸ä¾èµ–æœåŠ¡å™¨APIã€‚

## ğŸ¯ æœŸå·è®¡ç®—æ ¸å¿ƒé€»è¾‘

### 1. å…³é”®å¸¸é‡å®šä¹‰

ä¸¤ä¸ªé¡¹ç›®åœ¨ `BinggoHelper.cs` ä¸­å®šä¹‰äº†ç›¸åŒçš„å¸¸é‡ï¼š

```csharp
// æ ¸å¿ƒå¸¸é‡
private const int ISSUES_PER_DAY = 203;           // æ¯å¤©æœŸæ•°
private const int FIRST_ISSUE_ID = 114000001;     // åŸºå‡†æœŸå· (2025-01-01 ç¬¬1æœŸ)
private const long FIRST_TIMESTAMP = 1735686300;  // åŸºå‡†æ—¶é—´æˆ³ (2025-01-01 07:05:00)
private const int MINUTES_PER_ISSUE = 5;          // æ¯æœŸé—´éš”ï¼ˆåˆ†é’Ÿï¼‰
```

### 2. æœŸå·è®¡ç®—æ–¹æ³•

**ä½ç½®ï¼š**
- `BaiShengVx3Plus/Helpers/BinggoHelper.cs` (ç¬¬37-68è¡Œ)
- `zhaocaimao/Helpers/BinggoHelper.cs` (ç¬¬37-68è¡Œ)

**æ ¸å¿ƒç®—æ³•ï¼š**

```csharp
public static int GetCurrentIssueId(DateTime? time = null)
{
    var currentTime = time ?? DateTime.Now;
    var firstTime = DateTimeOffset.FromUnixTimeSeconds(FIRST_TIMESTAMP).LocalDateTime;
    
    // è®¡ç®—å¤©æ•°å·®
    var timeSpan = currentTime - firstTime;
    var days = timeSpan.Days;
    
    // å½“å¤©çš„åŸºç¡€æœŸå·
    int baseDayIssueId = FIRST_ISSUE_ID + days * ISSUES_PER_DAY;
    
    // ğŸ”¥ å…³é”®ï¼šè®¡ç®—å½“å¤©å·²ç»è¿‡äº†å¤šå°‘æœŸ
    int issueCount = 0;
    for (int i = 0; i < ISSUES_PER_DAY; i++)
    {
        var issueTimestamp = GetIssueOpenTimestamp(baseDayIssueId + i);
        var issueTime = DateTimeOffset.FromUnixTimeSeconds(issueTimestamp).LocalDateTime;
        
        // ğŸ”¥ å¦‚æœå½“å‰æ—¶é—´ > è¯¥æœŸå¼€å¥–æ—¶é—´ï¼Œè¯´æ˜è¯¥æœŸå·²è¿‡
        if (currentTime > issueTime)
        {
            issueCount++;
        }
        else
        {
            break;
        }
    }
    
    return baseDayIssueId + issueCount;
}
```

## ğŸ”„ æœŸå·è®¡ç®—æµç¨‹

### æ­¥éª¤1ï¼šè®¡ç®—å¤©æ•°å·®

```
å½“å‰æ—¥æœŸ - åŸºå‡†æ—¥æœŸ(2025-01-01) = å¤©æ•°å·®
```

### æ­¥éª¤2ï¼šè®¡ç®—å½“å¤©åŸºç¡€æœŸå·

```
å½“å¤©åŸºç¡€æœŸå· = 114000001 + å¤©æ•°å·® Ã— 203
```

**ä¾‹å¦‚ï¼š**
- 2025-01-01ï¼š114000001 + 0 Ã— 203 = 114000001
- 2025-01-02ï¼š114000001 + 1 Ã— 203 = 114000204
- 2025-01-03ï¼š114000001 + 2 Ã— 203 = 114000407

### æ­¥éª¤3ï¼šè®¡ç®—å½“å¤©å·²è¿‡æœŸæ•°

ä»å½“å¤©ç¬¬1æœŸå¼€å§‹éå†ï¼Œè®¡ç®—æœ‰å¤šå°‘æœŸçš„å¼€å¥–æ—¶é—´å·²ç»è¿‡å»ï¼š

```
for (ç¬¬1æœŸ åˆ° ç¬¬203æœŸ)
{
    if (å½“å‰æ—¶é—´ > è¯¥æœŸå¼€å¥–æ—¶é—´)
        issueCount++
}
```

### æ­¥éª¤4ï¼šå¾—åˆ°å½“å‰æœŸå·

```
å½“å‰æœŸå· = å½“å¤©åŸºç¡€æœŸå· + å·²è¿‡æœŸæ•°
```

## ğŸ“… æœŸå·ç¤ºä¾‹ï¼ˆ2025å¹´1æœˆ1æ—¥ï¼‰

å‡è®¾å½“å‰æ—¶é—´ï¼š2025-01-01 10:15:00

| æœŸå· | å¼€å¥–æ—¶é—´ | å½“å¤©ç¬¬å‡ æœŸ | çŠ¶æ€ |
|------|---------|----------|------|
| 114000001 | 07:05:00 | ç¬¬1æœŸ | âœ… å·²è¿‡ |
| 114000002 | 07:10:00 | ç¬¬2æœŸ | âœ… å·²è¿‡ |
| 114000003 | 07:15:00 | ç¬¬3æœŸ | âœ… å·²è¿‡ |
| ... | ... | ... | ... |
| 114000039 | 10:10:00 | ç¬¬39æœŸ | âœ… å·²è¿‡ |
| 114000040 | 10:15:00 | ç¬¬40æœŸ | â±ï¸ å½“å‰æœŸï¼ˆåˆšå¼€å¥–ï¼‰ |
| 114000041 | 10:20:00 | ç¬¬41æœŸ | â³ æœªæ¥ |

**è®¡ç®—ç»“æœï¼š** `GetCurrentIssueId()` è¿”å› `114000040`

## ğŸ® æœŸå·åœ¨ä¸¤ä¸ªé¡¹ç›®ä¸­çš„ä½¿ç”¨

### BaiShengVx3Plus

**1. å¼€å¥–æœåŠ¡å®šæ—¶è®¡ç®—**

```
BinggoLotteryService.StartAsync()
  â””â”€> å®šæ—¶å™¨æ¯ç§’æ‰§è¡Œ
      â””â”€> int localIssueId = BinggoHelper.GetCurrentIssueId()
          â””â”€> æ£€æµ‹æœŸå·å˜æ›´
              â””â”€> è§¦å‘ IssueChanged äº‹ä»¶
```

**ä½ç½®ï¼š** `BaiShengVx3Plus/Services/Games/Binggo/BinggoLotteryService.cs` (ç¬¬276è¡Œ)

**2. ç»Ÿè®¡æœåŠ¡æ¥æ”¶æœŸå·**

```
VxMain.OnIssueChanged(e)
  â””â”€> _statisticsService.SetCurrentIssueId(e.NewIssueId)
      â””â”€> IssueidCur = issueId
          â””â”€> UpdateStatistics()  // é‡æ–°è®¡ç®—æœ¬æœŸä¸‹æ³¨
```

**ä½ç½®ï¼š** `BaiShengVx3Plus/Views/VxMain.cs` (ç¬¬821è¡Œ)

### zhaocaimao

**ä½¿ç”¨æ–¹å¼å®Œå…¨ç›¸åŒï¼š**

**1. å¼€å¥–æœåŠ¡**
- ä½ç½®ï¼š`zhaocaimao/Services/Games/Binggo/BinggoLotteryService.cs` (ç¬¬274è¡Œ)

**2. ç»Ÿè®¡æœåŠ¡**
- ä½ç½®ï¼š`zhaocaimao/Views/VxMain.cs` (ç¬¬871è¡Œ)

## ğŸ” å½“å‰æœŸå·æŸ¥çœ‹æ–¹æ³•

### æ–¹æ³•1ï¼šé€šè¿‡å¼€å¥–æœåŠ¡è·å–

```csharp
// è·å–å¼€å¥–æœåŠ¡å®ä¾‹
var lotteryService = Program.ServiceProvider.GetService(typeof(IBinggoLotteryService)) 
    as IBinggoLotteryService;

// è·å–å½“å‰æœŸå·
int currentIssueId = lotteryService?.CurrentIssueId ?? 0;

Console.WriteLine($"å½“å‰æœŸå·ï¼š{currentIssueId}");
```

### æ–¹æ³•2ï¼šç›´æ¥è°ƒç”¨è¾…åŠ©æ–¹æ³•

```csharp
// ç›´æ¥è®¡ç®—å½“å‰æœŸå·
int currentIssueId = BinggoHelper.GetCurrentIssueId();

Console.WriteLine($"å½“å‰æœŸå·ï¼š{currentIssueId}");
```

### æ–¹æ³•3ï¼šè·å–æŒ‡å®šæ—¶é—´çš„æœŸå·

```csharp
// è®¡ç®—æŒ‡å®šæ—¶é—´çš„æœŸå·
DateTime specificTime = new DateTime(2025, 1, 1, 10, 15, 0);
int issueId = BinggoHelper.GetCurrentIssueId(specificTime);

Console.WriteLine($"2025-01-01 10:15:00 çš„æœŸå·ï¼š{issueId}");
```

## ğŸ“Š æœŸå·ç›¸å…³çš„è¾…åŠ©æ–¹æ³•

### 1. è·å–æœŸå·å¼€å¥–æ—¶é—´

```csharp
// æ ¹æ®æœŸå·è®¡ç®—å¼€å¥–æ—¶é—´
DateTime openTime = BinggoHelper.GetIssueOpenTime(114000040);
// è¿”å›ï¼š2025-01-01 10:15:00
```

### 2. è®¡ç®—è·ç¦»å¼€å¥–çš„ç§’æ•°

```csharp
// è®¡ç®—è·ç¦»æŒ‡å®šæœŸå·å¼€å¥–è¿˜æœ‰å¤šå°‘ç§’
int secondsToOpen = BinggoHelper.GetSecondsToOpen(114000041);
// å¦‚æœæ˜¯ 10:15:00ï¼Œè¿”å› 300ï¼ˆ5åˆ†é’Ÿï¼‰
```

### 3. è·å–ä¸Šä¸€æœŸæœŸå·

```csharp
int lastIssueId = BinggoHelper.GetPreviousIssueId(114000040);
// è¿”å›ï¼š114000039
```

### 4. è·å–æœŸå·åœ¨å½“å¤©æ˜¯ç¬¬å‡ æœŸ

```csharp
int dayNumber = BinggoHelper.GetIssueNumber(114000040);
// è¿”å›ï¼š40ï¼ˆå½“å¤©ç¬¬40æœŸï¼‰
```

## ğŸ”„ æœŸå·å˜æ›´æ£€æµ‹æœºåˆ¶

ä¸¤ä¸ªé¡¹ç›®éƒ½ä½¿ç”¨ç›¸åŒçš„æœŸå·å˜æ›´æ£€æµ‹é€»è¾‘ï¼š

```csharp
// BinggoLotteryService æ¯ç§’æ‰§è¡Œ
private async void TimerCallback(object? state)
{
    // 1. æœ¬åœ°è®¡ç®—å½“å‰æœŸå·
    int localIssueId = BinggoHelper.GetCurrentIssueId();
    
    lock (_statusLock)
    {
        // 2. æ£€æŸ¥æœŸå·æ˜¯å¦å˜æ›´
        if (_currentIssueId != localIssueId)
        {
            int previousIssueId = _currentIssueId;
            _currentIssueId = localIssueId;
            
            // 3. è§¦å‘æœŸå·å˜æ›´äº‹ä»¶
            IssueChanged?.Invoke(this, new BinggoIssueChangedEventArgs
            {
                OldIssueId = previousIssueId,
                NewIssueId = localIssueId
            });
        }
    }
}
```

## âš™ï¸ é…ç½®è¯´æ˜

æœŸå·è®¡ç®—æ˜¯**ç¡¬ç¼–ç **çš„ï¼Œä¸éœ€è¦é…ç½®æ–‡ä»¶ã€‚å¦‚æœéœ€è¦ä¿®æ”¹ï¼Œéœ€è¦æ›´æ”¹æºä»£ç ä¸­çš„å¸¸é‡ï¼š

- `FIRST_ISSUE_ID`: åŸºå‡†æœŸå·
- `FIRST_TIMESTAMP`: åŸºå‡†æ—¶é—´æˆ³
- `ISSUES_PER_DAY`: æ¯å¤©æœŸæ•°
- `MINUTES_PER_ISSUE`: æ¯æœŸé—´éš”

## ğŸ¯ æ€»ç»“

### ç›¸åŒç‚¹
1. **è®¡ç®—é€»è¾‘å®Œå…¨ç›¸åŒ**ï¼šä¸¤ä¸ªé¡¹ç›®ä½¿ç”¨ç›¸åŒçš„ `BinggoHelper.GetCurrentIssueId()` æ–¹æ³•
2. **åŸºå‡†å€¼ç›¸åŒ**ï¼šéƒ½ä½¿ç”¨ 2025-01-01 07:05:00 ä½œä¸ºç¬¬ä¸€æœŸï¼ˆæœŸå· 114000001ï¼‰
3. **æ¯å¤©203æœŸ**ï¼šä» 07:05:00 å¼€å§‹ï¼Œæ¯5åˆ†é’Ÿä¸€æœŸ
4. **æœ¬åœ°è®¡ç®—**ï¼šä¸ä¾èµ–æœåŠ¡å™¨APIï¼Œä½¿ç”¨ç³»ç»Ÿæ—¶é—´è®¡ç®—

### ä½¿ç”¨åœºæ™¯
1. **å¼€å¥–æœåŠ¡**ï¼šå®šæ—¶å™¨æ¯ç§’è®¡ç®—å½“å‰æœŸå·ï¼Œæ£€æµ‹æœŸå·å˜æ›´
2. **ä¸‹æ³¨æœåŠ¡**ï¼šåˆ›å»ºè®¢å•æ—¶è·å–å½“å‰æœŸå·
3. **ç»Ÿè®¡æœåŠ¡**ï¼šæŒ‰æœŸå·ç»Ÿè®¡æ•°æ®
4. **è‡ªåŠ¨æŠ•æ³¨**ï¼šæ ¹æ®æœŸå·å‘é€æŠ•æ³¨æŒ‡ä»¤

## ğŸ“ å®æ—¶æœŸå·æŸ¥è¯¢

è¦æŸ¥çœ‹å½“å‰çš„å®æ—¶æœŸå·ï¼Œå¯ä»¥ï¼š

1. **æŸ¥çœ‹ç¨‹åºç•Œé¢**ï¼šä¸¤ä¸ªé¡¹ç›®çš„ä¸»ç•Œé¢éƒ½ä¼šå®æ—¶æ˜¾ç¤ºå½“å‰æœŸå·
2. **æŸ¥çœ‹æ—¥å¿—**ï¼šæœç´¢ "æœŸå·å˜æ›´" æˆ– "IssueChanged" å…³é”®è¯
3. **ä»£ç è°ƒè¯•**ï¼šåœ¨ `BinggoHelper.GetCurrentIssueId()` æ–¹æ³•è®¾ç½®æ–­ç‚¹

---

**ç”Ÿæˆæ—¶é—´ï¼š** 2025-01-01 (ç¤ºä¾‹)
**å½“å‰ç³»ç»Ÿæ—¶é—´ï¼š** è¯·ä½¿ç”¨ `DateTime.Now` æŸ¥çœ‹
**è®¡ç®—å½“å‰æœŸå·ï¼š** `BinggoHelper.GetCurrentIssueId()`


