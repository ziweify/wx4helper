# ⚙️ 设置窗口与命令测试功能

## 📋 **功能概述**

设置窗口提供了两大核心功能：
1. **连接设置** - Socket服务器连接配置和自动重连设置
2. **命令测试** - 实时测试Socket命令，调试WeixinX接口

---

## 🎯 **打开设置窗口**

在主界面点击 **"设置"** 按钮即可打开设置窗口。

---

## 📑 **功能详解**

### **Tab 1: 连接设置**

#### **1. 服务器设置**

| 设置项 | 默认值 | 说明 |
|--------|--------|------|
| **服务器地址** | `127.0.0.1` | WeixinX Socket服务器地址 |
| **端口** | `6328` | WeixinX监听端口 |
| **连接状态** | 实时显示 | 显示当前连接状态 |

**操作按钮**：
- **连接/断开连接** - 手动控制连接
- **刷新状态** - 更新连接状态显示

#### **2. 自动重连设置**

| 设置项 | 默认值 | 说明 |
|--------|--------|------|
| **启用自动重连** | 复选框 | 全局控制自动重连功能 |
| **重连间隔** | `5000` | 毫秒，重连尝试间隔 |

**操作按钮**：
- **应用** - 应用重连间隔设置

---

### **Tab 2: 命令测试**

#### **1. 快捷命令**

预定义的常用命令，点击即可填充到命令输入框：

| 按钮 | 命令 | 说明 |
|------|------|------|
| **获取用户信息** | `GetUserInfo()` | 获取当前登录用户信息 |
| **获取联系人列表** | `GetContacts()` | 获取所有联系人 |
| **发送消息** | `SendMessage("wxid", "Hello")` | 发送消息示例 |

#### **2. Socket 命令测试**

**命令格式**：
```
MethodName(param1, param2, ...)
```

**支持的参数类型**：
- **字符串** - 用双引号包裹：`"Hello World"`
- **整数** - 直接输入：`123`
- **浮点数** - 直接输入：`3.14`
- **布尔值** - `true` 或 `false`
- **无参数** - 空括号：`GetUserInfo()`

**操作按钮**：
- **发送** - 执行命令
- **清空结果** - 清空结果显示区域

---

## 🚀 **使用示例**

### **示例1：获取用户信息（无参数）**

```
GetUserInfo()
```

**预期响应**：
```json
{
  "wxid": "wxid_xxxxx",
  "nickname": "用户昵称",
  "account": "微信号",
  "mobile": "手机号",
  ...
}
```

---

### **示例2：发送消息（字符串参数）**

```
SendMessage("wxid_receiver", "Hello, World!")
```

**预期响应**：
```json
{
  "success": true,
  "message": "消息已发送"
}
```

---

### **示例3：获取群成员（字符串参数）**

```
GetGroupContacts("12345678@chatroom")
```

**预期响应**：
```json
{
  "contacts": [
    {
      "wxid": "wxid_1",
      "nickname": "成员1"
    },
    ...
  ]
}
```

---

### **示例4：多参数命令**

```
SendMessage("wxid_receiver", "Hello", 1)
```

**参数解析**：
- `param[0]` = `"wxid_receiver"` (字符串)
- `param[1]` = `"Hello"` (字符串)
- `param[2]` = `1` (整数)

---

## 🎨 **结果显示**

### **颜色编码**

| 颜色 | 含义 |
|------|------|
| **蓝色** | 发送的命令 |
| **绿色** | 成功的响应 |
| **红色** | 错误信息 |

### **显示格式**

```
>>> 发送命令: GetUserInfo()

<<< 响应:
{
  "wxid": "wxid_xxxxx",
  "nickname": "测试用户"
}

>>> 发送命令: SendMessage("wxid", "test")

!!! 错误: 连接超时
```

---

## 🔧 **命令解析规则**

### **1. 正则表达式匹配**

```csharp
@"^(\w+)\((.*)\)$"
```

- 方法名：只能包含字母、数字、下划线
- 参数：逗号分隔，支持引号包裹字符串

### **2. 参数类型推断**

```csharp
// 字符串（带引号）
"Hello World" → string

// 整数
123 → int

// 浮点数
3.14 → double

// 布尔值
true → bool

// 默认（无引号）
test → string
```

### **3. 特殊字符**

- **逗号** - 参数分隔符
- **双引号** - 字符串标识
- **空格** - 自动trim

---

## 🛡️ **错误处理**

### **常见错误**

#### **1. 命令格式错误**

```
❌ GetUserInfo  // 缺少括号
❌ GetUserInfo) // 括号不匹配
❌ Send Message() // 方法名包含空格
```

```
✅ GetUserInfo()
✅ SendMessage("test")
```

#### **2. 未连接服务器**

```
错误：请先连接到服务器！
```

**解决方案**：
1. 切换到"连接设置"标签
2. 点击"连接"按钮
3. 或者回到主界面，点击"采集"注入微信

#### **3. 超时错误**

```
错误：Request timeout: MethodName
```

**解决方案**：
- 检查WeixinX.dll是否正常运行
- 检查命令是否正确
- 增加超时时间（代码中默认10秒）

---

## 📊 **调试技巧**

### **1. 查看详细日志**

点击主界面的"日志"按钮，查看Socket通信的详细日志：
- 发送的原始JSON
- 接收的原始JSON
- 连接状态变化
- 错误详情

### **2. 测试连接**

```
1. 打开设置窗口
2. 切换到"命令测试"标签
3. 输入: GetUserInfo()
4. 点击"发送"
5. 观察响应
```

如果收到响应，说明连接正常；否则检查连接状态。

### **3. 逐步调试**

从简单命令开始：
```
GetUserInfo()          // 无参数
↓
GetContacts()          // 无参数
↓
SendMessage("id", "test")  // 字符串参数
```

---

## 🎯 **可用命令列表**

根据 `SocketCommands.cpp` 中注册的命令：

| 命令 | 参数 | 说明 |
|------|------|------|
| `GetUserInfo()` | 无 | 获取当前用户信息 |
| `GetContacts()` | 无 | 获取联系人列表 |
| `GetGroupContacts(group_id)` | 群ID | 获取群成员列表 |
| `SendMessage(wxid, message)` | 微信ID, 消息内容 | 发送消息 |

**注意**：具体可用命令取决于 WeixinX 中注册的处理器。

---

## 💡 **高级用法**

### **1. 自定义命令**

如果需要测试新命令，只需：

1. 在 `WeixinX/SocketCommands.cpp` 中注册新命令
2. 在设置窗口输入新命令格式
3. 点击发送测试

### **2. 批量测试**

可以连续发送多个命令，结果会依次显示在结果区域。

### **3. 保存测试记录**

结果区域支持：
- 滚动查看历史记录
- 复制结果文本
- 清空历史记录

---

## 🔐 **安全提示**

1. **服务器地址** - 仅支持本地连接 (`127.0.0.1`)，不暴露到网络
2. **命令权限** - 所有命令都在微信进程内执行，需谨慎使用
3. **数据隐私** - 不要在命令测试中输入敏感信息

---

## 📝 **配置保存**

当前版本的设置保存位置：

```csharp
// TODO: 未实现持久化
// 未来版本将支持保存到配置文件
```

**临时方案**：
- 设置在窗口关闭后重置
- 每次打开需要重新配置

---

## 🚀 **快捷键（未来支持）**

| 快捷键 | 功能 |
|--------|------|
| `Ctrl+Enter` | 发送命令 |
| `Ctrl+L` | 清空结果 |
| `Ctrl+1` | 快捷命令1 |
| `Ctrl+2` | 快捷命令2 |
| `Ctrl+3` | 快捷命令3 |

---

## 📚 **相关文件**

| 文件 | 说明 |
|------|------|
| `BaiShengVx3Plus/Views/SettingsForm.cs` | 设置窗口逻辑 |
| `BaiShengVx3Plus/Views/SettingsForm.Designer.cs` | UI设计器 |
| `BaiShengVx3Plus/Services/WeixinSocketClient.cs` | Socket客户端 |
| `WeixinX/WeixinX/SocketCommands.cpp` | 命令处理器 |

---

## 🎉 **总结**

设置窗口提供了：

- ✅ **可视化配置** - 无需修改代码
- ✅ **实时测试** - 立即查看命令执行结果
- ✅ **调试友好** - 彩色显示，清晰的错误信息
- ✅ **灵活性** - 支持任意命令和参数组合
- ✅ **快捷操作** - 预定义常用命令

非常适合：
- 🔧 开发调试
- 🧪 功能测试
- 📖 学习Socket通信
- 🚀 快速验证新功能

---

**文档创建时间**: 2025-11-04  
**最后更新**: 2025-11-04

