# 系统消息过滤与取消全部命令 - 修复说明

**修复时间**: 2025-12-10  
**同步来源**: BaiShengVx3Plus  

---

## 一、问题概述

### 1.1 系统消息重复处理
- **现象**: 系统自己发送的回复消息被当作新消息处理，导致日志出现"未找到会员"警告
- **原因**: 缺少对系统消息的过滤（message.Sender == currentUserWxid）
- **参考**: F5BotV2 第1954-1956行

### 1.2 取消全部命令缺失
- **现象**: 用户发送"取消全部"或"全部取消"命令，系统没有任何回复
- **原因**: `BinggoLotteryService.ProcessMessageAsync` 没有处理该命令
- **参考**: F5BotV2 第2233-2264行 & BaiShengVx3Plus

---

## 二、修复内容

### 2.1 系统消息过滤

**文件**: `Services/Messages/Handlers/ChatMessageHandler.cs`

**修改位置**: 第63-77行

**修改内容**:
```csharp
// 添加在"检查是否为群消息"后，"检查收单开关"前
// 2. 🔥 过滤系统自己发送的消息（参考 F5BotV2 第1954-1956行）
// 判断来源：如果是系统给的消息，那么两个ID相同
string currentUserWxid = _userInfoService.GetCurrentWxid();
if (!string.IsNullOrEmpty(currentUserWxid) && message.Sender == currentUserWxid)
{
    _logService.Debug("ChatMessageHandler", "系统自己发送的消息，忽略处理");
    return;
}
```

### 2.2 取消全部命令

**文件**: `Services/Games/Binggo/BinggoLotteryService.cs`

**修改位置**: 第1399行后插入

**核心逻辑**:
1. 检查期号是否初始化
2. 检查状态（白名单：只允许"开盘中"和"即将封盘"）
3. 查找所有待处理订单（排除已取消、已完成）
4. 遍历取消所有订单：
   - 双重验证期号
   - 更新订单状态
   - 退款（非管理员）
   - 减掉会员统计（托单也减）
   - 更新全局统计（非托单）
   - 拼接回复消息
5. 添加总计行：`+{totalMoney}|留:{(int)Balance}`

**回复格式**:
```
@{nickname} {BetContent1}|+{Amount1} 已取消
{BetContent2}|+{Amount2} 已取消
+{totalMoney}|留:{(int)Balance}
```

---

## 三、修改文件清单

### 3.1 Services/Messages/Handlers/ChatMessageHandler.cs

**修改行**: 63-85

**修改类型**: 插入系统消息过滤逻辑

**修改说明**:
- 将 `currentUserWxid` 的获取提前到过滤逻辑之前
- 添加 `message.Sender == currentUserWxid` 的判断
- 步骤编号从2开始重新调整（2、3、4）

### 3.2 Services/Games/Binggo/BinggoLotteryService.cs

**修改行**: 1399行后插入约100行

**修改类型**: 添加"全部取消"命令处理

**修改说明**:
- 完全参考 BaiShengVx3Plus 的实现
- 适配 zhaocaimao 的日志服务（`_logService.Info("LotteryService", ...)`）
- 保持与 F5BotV2 的格式一致

---

## 四、测试要点

### 4.1 系统消息过滤测试

**测试步骤**:
1. 会员下单："123大50"
2. 观察日志

**预期结果**:
- ✅ 不会出现"未找到会员: {currentUserWxid}"
- ✅ 日志显示"系统自己发送的消息，忽略处理"

### 4.2 取消全部命令测试

**场景1: 正常取消**
- 输入："取消全部" 或 "全部取消"
- 预期：显示所有订单取消信息和总计

**场景2: 已封盘**
- 输入："取消全部"（封盘后）
- 预期："{nickname}\r时间到!不能取消!"

**场景3: 无订单**
- 输入："取消全部"（未下单）
- 预期："@{nickname}\r当前期号无待处理订单"

---

## 五、技术要点

### 5.1 为什么必须过滤系统消息

1. **防止死循环**: 系统回复被当作新消息，可能触发连锁反应
2. **日志清晰**: 避免无意义的"未找到会员"警告
3. **性能优化**: 减少不必要的数据库查询
4. **业务准确**: 系统消息不是用户输入，不应被业务处理

### 5.2 "全部取消"的关键逻辑

1. **状态白名单**: 防御性编程，明确允许的状态
2. **期号双重验证**: 防止跨期取消
3. **托单统计**: 托单也要减会员统计，但不减全局统计
4. **格式严格**: 最后一行必须有总计，余额转整数

---

## 六、与 BaiShengVx3Plus 的差异

### 6.1 相同点
- 业务逻辑完全相同
- 回复格式完全相同
- 验证流程完全相同

### 6.2 差异点
- 日志服务名称：`LotteryService` vs `BinggoLotteryService`
- 其他实现细节完全一致

---

**同步完成时间**: 2025-12-10  
**同步人员**: AI Assistant  
**审核状态**: 待验证

