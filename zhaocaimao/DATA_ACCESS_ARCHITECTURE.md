# æ•°æ®è®¿é—®æ¶æ„è®¾è®¡

## ğŸ¯ é—®é¢˜ï¼šå¤šè¡¨å¹¶å‘å†™å…¥å†²çª

### åœºæ™¯åˆ†æ

```
æ—¶é—´çº¿ï¼š
T1: ç”¨æˆ·ä¿®æ”¹ä¼šå‘˜Açš„æ•°æ® â†’ UPDATE Members WHERE Id=1
T2: ç”¨æˆ·ä¿®æ”¹è®¢å•Bçš„æ•°æ® â†’ UPDATE Orders WHERE Id=100  
T3: ç³»ç»Ÿè®°å½•æ—¥å¿— â†’ INSERT INTO Logs
T4: å¾®ä¿¡æ¶ˆæ¯åˆ°è¾¾ â†’ INSERT INTO Messages

å¦‚æœä½¿ç”¨åŒä¸€ä¸ªæ•°æ®åº“ï¼ŒT1-T4 å¿…é¡»ä¸²è¡Œæ‰§è¡Œï¼Œäº’ç›¸ç­‰å¾…ï¼
```

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šåˆ†ç¦»æ•°æ®åº“ï¼ˆæ¨èï¼‰â­

```
é¡¹ç›®ç»“æ„ï¼š
BaiShengVx3Plus/
â”œâ”€â”€ Data/
â”‚   â”œâ”€â”€ logs.db          â† æ—¥å¿—æ•°æ®åº“ï¼ˆç‹¬ç«‹ï¼‰
â”‚   â””â”€â”€ business.db      â† ä¸šåŠ¡æ•°æ®åº“ï¼ˆä¼šå‘˜ã€è®¢å•ç­‰ï¼‰

ä¼˜åŠ¿ï¼š
1. å®Œå…¨éš”ç¦»ï¼Œé›¶å†²çª
2. æ—¥å¿—é«˜é¢‘å†™å…¥ä¸å½±å“ä¸šåŠ¡
3. å¯ä»¥ç‹¬ç«‹ä¼˜åŒ–å’Œå¤‡ä»½
4. ç®€å•å¯é 
```

### æ–¹æ¡ˆ 2ï¼šWAL æ¨¡å¼ + æ™ºèƒ½é˜Ÿåˆ—

```csharp
// å¯ç”¨ WAL æ¨¡å¼
connection.Execute("PRAGMA journal_mode=WAL;");
connection.Execute("PRAGMA synchronous=NORMAL;");
connection.Execute("PRAGMA temp_store=MEMORY;");
connection.Execute("PRAGMA cache_size=10000;");

ç‰¹æ€§ï¼š
âœ… è¯»å†™å¯ä»¥å¹¶å‘ï¼ˆè¯»ä¸é˜»å¡å†™ï¼Œå†™ä¸é˜»å¡è¯»ï¼‰
âœ… å¤šä¸ªè¯»å–å®Œå…¨å¹¶å‘
âš ï¸  åŒæ—¶ä»åªèƒ½ä¸€ä¸ªå†™å…¥ï¼ˆä½†é€Ÿåº¦æ›´å¿«ï¼‰
```

### æ–¹æ¡ˆ 3ï¼šåˆ†å±‚æ¶æ„ï¼ˆæœ€ä½³å®è·µï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           UI Layer (VxMain)             â”‚
â”‚  - DataGridView (ä¿®æ”¹å³ä¿å­˜)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Repository Layer (ä»“å‚¨å±‚)          â”‚
â”‚  MemberRepository                       â”‚
â”‚  OrderRepository                        â”‚
â”‚  ContactRepository                      â”‚
â”‚  â†“ è°ƒç”¨                                  â”‚
â”‚  DatabaseService (ç»Ÿä¸€ç®¡ç†)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Database Layer (æ•°æ®åº“å±‚)            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ business.db â”‚   logs.db   â”‚         â”‚
â”‚  â”‚  (WALæ¨¡å¼)  â”‚  (WALæ¨¡å¼)  â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ—ï¸ å®ç°ç­–ç•¥

### ç­–ç•¥ 1ï¼šä¸šåŠ¡æ•°æ® - ç«‹å³å†™å…¥

```csharp
// ç”¨æˆ·ä¿®æ”¹æ•°æ®ç½‘æ ¼æ—¶
private void dgvMembers_CellValueChanged(object sender, EventArgs e)
{
    var member = dgvMembers.CurrentRow.DataBoundItem as V2Member;
    
    // ç«‹å³ä¿å­˜åˆ°æ•°æ®åº“ï¼ˆä½¿ç”¨ä»“å‚¨ï¼‰
    _memberRepository.Update(member);  // â† ç«‹å³æ‰§è¡Œ
    
    // ä¼˜åŒ–ï¼šä½¿ç”¨äº‹åŠ¡ä¿è¯åŸå­æ€§
}

å®ç°ï¼š
âœ… ä½¿ç”¨ WAL æ¨¡å¼
âœ… çŸ­äº‹åŠ¡ï¼ˆå¿«é€Ÿæäº¤ï¼‰
âœ… é”™è¯¯é‡è¯•æœºåˆ¶
```

### ç­–ç•¥ 2ï¼šæ—¥å¿— - å¼‚æ­¥æ‰¹é‡å†™å…¥

```csharp
// æ—¥å¿—ä¸éœ€è¦ç«‹å³æŒä¹…åŒ–
_logService.Info("VxMain", "ç”¨æˆ·ä¿®æ”¹äº†ä¼šå‘˜æ•°æ®");
// â†“
// æ—¥å¿—è¿›å…¥å†…å­˜é˜Ÿåˆ—
// â†“
// åå°çº¿ç¨‹æ‰¹é‡å†™å…¥ï¼ˆ100æ¡/æ¬¡ æˆ– 1ç§’/æ¬¡ï¼‰

å®ç°ï¼š
âœ… ç‹¬ç«‹æ•°æ®åº“
âœ… å¼‚æ­¥æ‰¹é‡å†™å…¥
âœ… å†…å­˜ç¼“å†²
```

### ç­–ç•¥ 3ï¼šç»Ÿä¸€æ•°æ®åº“æœåŠ¡

```csharp
public class DatabaseService
{
    // ä¸šåŠ¡æ•°æ®åº“ï¼ˆWALæ¨¡å¼ï¼Œæ”¯æŒä¿®æ”¹å³ä¿å­˜ï¼‰
    private readonly string _businessDbPath;
    
    // æ—¥å¿—æ•°æ®åº“ï¼ˆç‹¬ç«‹ï¼Œå¼‚æ­¥å†™å…¥ï¼‰
    private readonly string _logDbPath;
    
    // è¿æ¥æ± 
    private readonly Dictionary<string, SQLiteConnection> _connections;
    
    // å†™å…¥é˜Ÿåˆ—ï¼ˆç”¨äºéç´§æ€¥æ•°æ®ï¼‰
    private readonly ConcurrentQueue<DbOperation> _pendingOps;
    
    public void SaveImmediate<T>(T entity)
    {
        // ç«‹å³ä¿å­˜ï¼ˆç”¨äºä¿®æ”¹å³ä¿å­˜ï¼‰
        using var conn = GetBusinessConnection();
        using var transaction = conn.BeginTransaction();
        // ... æ‰§è¡Œä¿å­˜
        transaction.Commit();  // â† ç«‹å³æäº¤
    }
    
    public void SaveDeferred<T>(T entity)
    {
        // å»¶è¿Ÿä¿å­˜ï¼ˆç”¨äºæ—¥å¿—ç­‰éç´§æ€¥æ•°æ®ï¼‰
        _pendingOps.Enqueue(new DbOperation(entity));
    }
}
```

## ğŸ“Š å¹¶å‘æ€§èƒ½å¯¹æ¯”

| æ–¹æ¡ˆ | å¹¶å‘è¯»å– | å¹¶å‘å†™å…¥ | è¯»å†™å¹¶å‘ | é€‚ç”¨åœºæ™¯ |
|-----|---------|---------|---------|----------|
| é»˜è®¤æ¨¡å¼ | âœ… | âŒ | âŒ | å•ç”¨æˆ· |
| WALæ¨¡å¼ | âœ…âœ… | âŒ | âœ… | å¤šè¯»å°‘å†™ |
| åˆ†ç¦»æ•°æ®åº“ | âœ…âœ… | âœ… | âœ… | é«˜å¹¶å‘ |
| é˜Ÿåˆ—+æ‰¹é‡ | âœ…âœ… | âš ï¸ | âœ… | éå®æ—¶æ•°æ® |

## ğŸ¯ é’ˆå¯¹ä½ çš„éœ€æ±‚

### ä¸šåŠ¡æ•°æ®ï¼ˆä¿®æ”¹å³ä¿å­˜ï¼‰

```csharp
// âœ… æ–¹æ¡ˆï¼šWALæ¨¡å¼ + çŸ­äº‹åŠ¡
public class MemberRepository
{
    public void Update(V2Member member)
    {
        using var conn = GetConnection();
        
        // å¯ç”¨WALï¼ˆé¦–æ¬¡ï¼‰
        conn.Execute("PRAGMA journal_mode=WAL");
        
        // çŸ­äº‹åŠ¡
        using var transaction = conn.BeginTransaction();
        
        // ç«‹å³æ‰§è¡Œ
        conn.Execute(@"
            UPDATE Members 
            SET Name = @Name, Phone = @Phone, ...
            WHERE Id = @Id
        ", member);
        
        transaction.Commit();  // â† ç«‹å³æäº¤
    }
}

æ€§èƒ½ï¼š
- å•æ¬¡æ›´æ–°ï¼š< 5ms
- ä¸é˜»å¡å…¶ä»–è¯»å–
- å¤šä¸ªå†™å…¥ä¼šæ’é˜Ÿï¼ˆä½†å¾ˆå¿«ï¼‰
```

### æ—¥å¿—æ•°æ®ï¼ˆé«˜é¢‘å†™å…¥ï¼‰

```csharp
// âœ… æ–¹æ¡ˆï¼šç‹¬ç«‹æ•°æ®åº“ + å¼‚æ­¥æ‰¹é‡
public class LogService
{
    private readonly string _logDbPath = "logs.db";  // ç‹¬ç«‹æ•°æ®åº“
    private readonly ConcurrentQueue<LogEntry> _queue;
    
    public void Log(LogEntry entry)
    {
        // ç«‹å³è¿”å›ï¼ˆä¸é˜»å¡ï¼‰
        _queue.Enqueue(entry);
        
        // åå°çº¿ç¨‹æ‰¹é‡å†™å…¥
        // 100æ¡/æ¬¡ æˆ– 1ç§’/æ¬¡
    }
}

æ€§èƒ½ï¼š
- è°ƒç”¨è€—æ—¶ï¼š< 1msï¼ˆä»…å…¥é˜Ÿï¼‰
- å®Œå…¨ä¸å½±å“ä¸šåŠ¡æ•°æ®åº“
```

## ğŸ’¡ æœ€ä½³å®è·µå»ºè®®

### 1. ä½¿ç”¨ä¸¤ä¸ªæ•°æ®åº“

```csharp
// business.db - ä¸šåŠ¡æ•°æ®ï¼ˆWALæ¨¡å¼ï¼‰
- Members è¡¨
- Orders è¡¨  
- Contacts è¡¨

// logs.db - æ—¥å¿—æ•°æ®ï¼ˆWALæ¨¡å¼ + æ‰¹é‡å†™å…¥ï¼‰
- Logs è¡¨
```

### 2. é…ç½® WAL æ¨¡å¼

```csharp
public void EnableWAL(SQLiteConnection connection)
{
    connection.Execute("PRAGMA journal_mode=WAL;");
    connection.Execute("PRAGMA synchronous=NORMAL;");  // å¹³è¡¡æ€§èƒ½å’Œå®‰å…¨
    connection.Execute("PRAGMA cache_size=10000;");     // 10MBç¼“å­˜
    connection.Execute("PRAGMA temp_store=MEMORY;");    // å†…å­˜ä¸´æ—¶è¡¨
    connection.Execute("PRAGMA mmap_size=30000000000;"); // ä½¿ç”¨å†…å­˜æ˜ å°„
}
```

### 3. çŸ­äº‹åŠ¡åŸåˆ™

```csharp
// âœ… å¥½çš„åšæ³•ï¼šçŸ­äº‹åŠ¡
using var transaction = conn.BeginTransaction();
conn.Execute("UPDATE Members SET Name = @Name WHERE Id = @Id", member);
transaction.Commit();

// âŒ åçš„åšæ³•ï¼šé•¿äº‹åŠ¡
using var transaction = conn.BeginTransaction();
// ... å¤æ‚è®¡ç®— ...
// ... ç½‘ç»œè¯·æ±‚ ...
conn.Execute("UPDATE ...");  // æŒæœ‰é”å¤ªä¹…
transaction.Commit();
```

### 4. é”™è¯¯é‡è¯•

```csharp
public void SaveWithRetry<T>(T entity, int maxRetries = 3)
{
    for (int i = 0; i < maxRetries; i++)
    {
        try
        {
            Save(entity);
            return;  // æˆåŠŸ
        }
        catch (SQLiteException ex) when (ex.ResultCode == SQLiteErrorCode.Busy)
        {
            // æ•°æ®åº“å¿™ï¼Œé‡è¯•
            Thread.Sleep(50 * (i + 1));  // é€’å¢ç­‰å¾…
        }
    }
    
    throw new Exception("ä¿å­˜å¤±è´¥ï¼Œæ•°æ®åº“å¿™");
}
```

## ğŸš€ æ¨èæ–¹æ¡ˆ

### å¯¹äºä½ çš„é¡¹ç›®

```
âœ… ä¸šåŠ¡æ•°æ®ï¼ˆMembers, Orders, Contactsï¼‰
   - ä½¿ç”¨ business.db
   - å¯ç”¨ WAL æ¨¡å¼
   - ä¿®æ”¹å³ä¿å­˜ï¼ˆçŸ­äº‹åŠ¡ï¼‰
   - ä½¿ç”¨ Repository æ¨¡å¼

âœ… æ—¥å¿—æ•°æ®ï¼ˆLogsï¼‰
   - ä½¿ç”¨ç‹¬ç«‹çš„ logs.db
   - å¯ç”¨ WAL æ¨¡å¼
   - å¼‚æ­¥æ‰¹é‡å†™å…¥
   - ä¸å½±å“ä¸šåŠ¡æ“ä½œ

âœ… æ¶æ„æ¨¡å¼
   - Repository å±‚ï¼ˆæ•°æ®è®¿é—®ï¼‰
   - Service å±‚ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰
   - UI å±‚ï¼ˆæ•°æ®ç»‘å®šï¼‰
```

## ğŸ“ˆ æ€§èƒ½é¢„æœŸ

```
ä¸šåŠ¡æ•°æ®æ“ä½œï¼š
- å•æ¬¡æ›´æ–°ï¼š3-5ms
- å¹¶å‘è¯»å–ï¼šæ— é™åˆ¶
- å¹¶å‘å†™å…¥ï¼šæ’é˜Ÿæ‰§è¡Œï¼ˆä½†å¾ˆå¿«ï¼‰

æ—¥å¿—å†™å…¥ï¼š
- è°ƒç”¨è€—æ—¶ï¼š< 1ms
- æ‰¹é‡å†™å…¥ï¼š100æ¡/æ¬¡
- å®Œå…¨ä¸å½±å“ä¸šåŠ¡

æ€»ä½“ï¼š
âœ… ç”¨æˆ·æ„ŸçŸ¥ä¸åˆ°å»¶è¿Ÿ
âœ… æ•°æ®å³æ—¶ä¿å­˜
âœ… ç³»ç»Ÿç¨³å®šå¯é 
```

## ğŸ¯ ç»“è®º

**æ¨èä½¿ç”¨ï¼šåˆ†ç¦»æ•°æ®åº“ + WALæ¨¡å¼ + Repositoryæ¨¡å¼**

è¿™æ ·å¯ä»¥ï¼š
1. âœ… æ”¯æŒ"ä¿®æ”¹å³ä¿å­˜"ï¼ˆ< 5msï¼‰
2. âœ… é¿å…æ—¥å¿—å†™å…¥å†²çª
3. âœ… æ”¯æŒå¹¶å‘è¯»å–
4. âœ… æ¶æ„æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤
5. âœ… æ€§èƒ½ä¼˜ç§€ï¼Œç”¨æˆ·æ— æ„ŸçŸ¥

