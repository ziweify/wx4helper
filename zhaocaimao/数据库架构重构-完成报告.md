# 招财猫 - 数据库架构重构完成报告

## 📅 更新日期
2025-11-27

## 🎯 重构目标
同步 BaiShengVx3Plus 的两个重要更新到 zhaocaimao 项目：
1. **数据库架构改造**：从微信专属数据库改为共享数据库（按 GroupWxId 隔离）
2. **平台下拉框显示修复**：修复平台默认值显示问题

## 📦 更新内容

### 1. 平台下拉框显示修复

#### 问题描述
`cbxPlatform` 下拉框显示问题：
- `GetAllPlatformNames()` 使用 `Enum.GetNames()` 按**字母顺序**返回
- `GetAllPlatforms()` 按**枚举值顺序**返回
- 导致索引不匹配，下拉框选择错误

#### 修复文件
- `zhaocaimao.Shared/Platform/BetPlatform.cs`

#### 修改内容
```csharp
// ✅ 修复后
public static string[] GetAllPlatformNames()
{
    return GetAllPlatforms().Select(p => p.ToString()).ToArray();
}

public static BetPlatform[] GetAllPlatforms()  // 改为 public
{
    if (_allPlatforms == null)
    {
        _allPlatforms = Enum.GetValues(typeof(BetPlatform))
            .Cast<BetPlatform>()
            .OrderBy(p => (int)p)
            .ToArray();
    }
    return _allPlatforms;
}
```

### 2. 数据库架构重构（共享数据库）

#### 旧架构（双库结构）
```
1. 全局数据库: business.db
   - BetConfig（飞单配置）
   - BinggoLotteryData（开奖数据）
   - BinggoBetItem（开奖下注项）

2. 微信专属数据库: business_{wxid}.db
   - V2Member（会员）
   - V2MemberOrder（订单）
   - V2CreditWithdraw（上下分）
   - V2BalanceChange（资金变动）
   - WxContact（联系人）
   - WxUserInfo（用户信息）
```

**问题**：微信换号后数据丢失

#### 新架构（共享数据库）
```
共享数据库: business.db（所有微信号共享）

全局表（全局共享）：
  - BetConfig
  - BinggoLotteryData
  - BinggoBetItem
  - BetRecord

业务表（按 GroupWxId 隔离）：
  - V2Member
  - V2MemberOrder
  - V2CreditWithdraw
  - V2BalanceChange

基础表（所有微信号共享）：
  - WxContact
  - WxUserInfo
```

**优势**：只要新微信号在同一个群中，所有会员数据、订单、余额都会保留

#### 修改文件清单

1. **数据库初始化器**
   - `Services/Database/DatabaseInitializer.cs`
     - ✅ 移除 `InitializeGlobalTables()`
     - ✅ 移除 `InitializeWxTables()`
     - ✅ 新增 `InitializeAllTables()`（合并所有表到共享数据库）
     - ✅ 添加 `[Obsolete]` 标记兼容旧方法

2. **主窗口**
   - `Views/VxMain.cs`
     - ✅ 移除 `_globalDb` 字段，合并为 `_db`（共享数据库）
     - ✅ 重构 `InitializeDatabase()`：不再根据 wxid 创建专属数据库
     - ✅ 更新 `InitializeGlobalServices()`：使用 `_db` 替代 `_globalDb`
     - ✅ 移除旧的表初始化方法
     - ✅ 更新所有数据库相关注释

3. **数据绑定列表**
   - `Core/V2OrderBindingList.cs`
     - ✅ 构造函数添加 `groupWxId` 参数
     - ✅ `LoadFromDatabase()` 添加 `GroupWxId` 过滤

   - `Core/V2CreditWithdrawBindingList.cs`
     - ✅ 已支持 `groupWxid` 参数（无需修改）

## 🔧 技术要点

### 数据隔离机制
```csharp
// ✅ 按 GroupWxId 过滤数据
var orders = _db.Table<V2MemberOrder>()
    .Where(o => o.GroupWxId == _groupWxId)  // 关键：群组隔离
    .OrderByDescending(o => o.TimeStampBet)
    .ToList();
```

### 微信换号数据连续性保证
1. **前提条件**：新微信号必须在同一个绑定的业务群中
2. **数据保留**：
   - ✅ 会员信息（通过 `GroupWxId` + `Wxid` 查找）
   - ✅ 订单数据（按 `GroupWxId` 隔离）
   - ✅ 余额数据（保存在会员表中）
   - ✅ 上下分记录（按 `GroupWxId` 隔离）
3. **数据查询**：所有业务表查询时都加上 `GroupWxId` 过滤

## ✅ 验证清单

- [x] 平台下拉框排序一致（名称列表和枚举列表顺序相同）
- [x] 数据库架构改为共享模式
- [x] 所有表统一在 `business.db` 中
- [x] 业务表添加 `GroupWxId` 过滤
- [x] 移除 `_globalDb` 字段
- [x] 移除微信专属数据库创建逻辑
- [x] 更新所有相关注释
- [x] 编译通过，无错误

## 📝 注意事项

### 数据迁移
现有的 `business_{wxid}.db` 文件不会自动迁移。如果需要迁移：
1. 可以参考 `BaiShengVx3Plus/Services/Database/DatabaseMigrationTool.cs`
2. 或者让用户重新绑定群、重新添加会员（推荐，数据更干净）

### 兼容性
- ✅ 旧方法标记为 `[Obsolete]`，保证编译兼容
- ✅ `DatabaseInitializer` 提供向后兼容方法

## 🎉 完成状态
- **平台显示修复**：✅ 完成
- **数据库架构重构**：✅ 完成
- **编译验证**：✅ 通过
- **文档更新**：✅ 完成

---

## 📖 参考文档
- BaiShengVx3Plus/数据库架构重构-完成报告.md
- BaiShengVx3Plus/微信换号数据连续性解决方案.md

