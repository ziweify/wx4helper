# æ¶ˆæ¯æ¨¡æ‹Ÿå™¨ - ç³»ç»Ÿæ¶ˆæ¯åŒæ­¥ä¿®å¤æŠ¥å‘Š

**ä¿®å¤æ—¥æœŸ**: 2025-12-09  
**é¡¹ç›®**: zhaocaimao  
**å‚è€ƒé¡¹ç›®**: BaiShengVx3Plus  
**åŠŸèƒ½**: å¼€å‘æ¨¡å¼ä¸‹æ¶ˆæ¯æ¨¡æ‹Ÿå™¨æ˜¾ç¤ºç³»ç»Ÿæ¶ˆæ¯

---

## ğŸ“‹ ä¿®å¤å†…å®¹

### 1. æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯é€šçŸ¥æœºåˆ¶ âœ…

**æ–‡ä»¶**: `zhaocaimao/Views/Dev/MessageSimulatorForm.cs`

**æ·»åŠ å†…å®¹**:
```csharp
/// <summary>
/// ğŸ”¥ é™æ€äº‹ä»¶ï¼šå¼€å‘æ¨¡å¼ä¸‹å‘é€åˆ°ç¾¤çš„æ¶ˆæ¯é€šçŸ¥ï¼ˆç”¨äºæ¶ˆæ¯æ¨¡æ‹Ÿå™¨æ˜¾ç¤ºï¼‰
/// </summary>
public static event EventHandler<(string messageType, string message, string? imagePath)>? SystemMessageSent;

/// <summary>
/// ğŸ”¥ é™æ€æ–¹æ³•ï¼šé€šçŸ¥æ‰€æœ‰æ¶ˆæ¯æ¨¡æ‹Ÿå™¨çª—å£æ˜¾ç¤ºç³»ç»Ÿæ¶ˆæ¯ï¼ˆå¼€å‘æ¨¡å¼ä¸“ç”¨ï¼‰
/// </summary>
public static void NotifySystemMessage(string messageType, string message, string? imagePath = null)
{
    var subscriberCount = SystemMessageSent?.GetInvocationList()?.Length ?? 0;
    System.Diagnostics.Debug.WriteLine($"[NotifySystemMessage] messageType={messageType}, messageé•¿åº¦={message?.Length ?? 0}, imagePath={imagePath ?? "null"}, è®¢é˜…è€…æ•°é‡={subscriberCount}");
    
    try
    {
        SystemMessageSent?.Invoke(null, (messageType, message, imagePath));
    }
    catch (Exception ex)
    {
        System.Diagnostics.Debug.WriteLine($"[NotifySystemMessage] å¼‚å¸¸: {ex.Message}");
        throw;
    }
}
```

---

### 2. ä¿®æ”¹å°ç›˜æé†’æ¶ˆæ¯å‘é€ âœ…

**æ–‡ä»¶**: `zhaocaimao/Services/Games/Binggo/BinggoLotteryService.cs`  
**æ–¹æ³•**: `SendSealingReminderAsync`

**æ ¸å¿ƒæ”¹åŠ¨**:
```csharp
// âœ… ä¿®å¤å‰ï¼šæå‰è¿”å›ï¼Œæ¶ˆæ¯æ¨¡æ‹Ÿå™¨æ”¶ä¸åˆ°é€šçŸ¥
if (string.IsNullOrEmpty(groupWxId) || _socketClient == null || !_socketClient.IsConnected)
{
    return;  // âŒ ç›´æ¥è¿”å›
}

// âœ… ä¿®å¤åï¼šåˆ†ç¦»å¾®ä¿¡å‘é€å’Œæ¨¡æ‹Ÿå™¨é€šçŸ¥
bool shouldSend = ShouldSendSystemMessage();
bool isDevMode = _configService.GetIsRunModeDev();

// å‘é€åˆ°å¾®ä¿¡ç¾¤ï¼ˆå¯é€‰ï¼‰
if (shouldSend && !string.IsNullOrEmpty(groupWxId) && ...)
{
    await _socketClient.SendAsync<object>("SendMessage", groupWxId, message);
}

// é€šçŸ¥æ¶ˆæ¯æ¨¡æ‹Ÿå™¨ï¼ˆå¼€å‘æ¨¡å¼æ€»æ˜¯æ‰§è¡Œï¼‰
if (isDevMode)
{
    Views.Dev.MessageSimulatorForm.NotifySystemMessage("å°ç›˜æé†’", message);
}
```

---

### 3. ä¿®æ”¹å°ç›˜æ¶ˆæ¯å‘é€ âœ…

**æ–‡ä»¶**: `zhaocaimao/Services/Games/Binggo/BinggoLotteryService.cs`  
**æ–¹æ³•**: `SendSealingMessageAsync`

**æ ¸å¿ƒæ”¹åŠ¨**:
```csharp
// âœ… ç”Ÿæˆå°ç›˜æ¶ˆæ¯ï¼ˆåŒ…å«è®¢å•åˆ—è¡¨ï¼‰
var sbTxt = new StringBuilder();
sbTxt.Append($"{issueShort} æ—¶é—´åˆ°! åœæ­¢è¿›ä»“! ä»¥æ­¤ä¸ºå‡†!\r ");
// ... æ·»åŠ è®¢å•åˆ—è¡¨ ...
sbTxt.Append("------çº¿ä¸‹æ— æ•ˆ------");

// âœ… å‘é€åˆ°å¾®ä¿¡ç¾¤ï¼ˆå¯é€‰ï¼‰
if (shouldSend && !string.IsNullOrEmpty(groupWxId) && ...)
{
    await _socketClient.SendAsync<object>("SendMessage", groupWxId, sbTxt.ToString());
}

// âœ… é€šçŸ¥æ¶ˆæ¯æ¨¡æ‹Ÿå™¨ï¼ˆå¼€å‘æ¨¡å¼æ€»æ˜¯æ‰§è¡Œï¼‰
if (isDevMode)
{
    Views.Dev.MessageSimulatorForm.NotifySystemMessage("å°ç›˜", sbTxt.ToString());
}
```

---

## ğŸ“Š ä¿®å¤çš„ç³»ç»Ÿæ¶ˆæ¯

| æ¶ˆæ¯ç±»å‹ | æ–¹æ³• | ä¿®å¤çŠ¶æ€ |
|---------|------|---------|
| å€’è®¡æ—¶æé†’ï¼ˆ30ç§’/15ç§’ï¼‰ | `SendSealingReminderAsync` | âœ… å·²åŒæ­¥ |
| å°ç›˜æ¶ˆæ¯ | `SendSealingMessageAsync` | âœ… å·²åŒæ­¥ |
| å¼€ç›˜æ¶ˆæ¯ | `OnOpeningAsync` | â³ å¾…åŒæ­¥ |
| ä¸­å¥–åå• | `SendSettlementMessagesAsync` | â³ å¾…åŒæ­¥ |
| ç•™åˆ†åå• | `SendSettlementMessagesAsync` | â³ å¾…åŒæ­¥ |
| å†å²è®°å½•å›¾ç‰‡ | `SendHistoryLotteryImageAsync` | â³ å¾…åŒæ­¥ |

**è¯´æ˜**: ç”±äºæ–¹æ³•æ•°é‡è¾ƒå¤šï¼Œæœ¬æ¬¡å…ˆåŒæ­¥äº†æœ€å…³é”®çš„å°ç›˜ç›¸å…³æ¶ˆæ¯ã€‚å…¶ä»–æ¶ˆæ¯ç±»å‹éœ€è¦åç»­ç»§ç»­åŒæ­¥ã€‚

---

## ğŸ¯ è®¾è®¡åŸåˆ™

### æ¨ªåˆ‡å£åˆ†ç¦»ï¼ˆCross-Cutting Concernsï¼‰

**å¾®ä¿¡æ¶ˆæ¯å‘é€**ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰:
- éœ€è¦æ»¡è¶³æ‰€æœ‰æ¡ä»¶ï¼šç¾¤ç»‘å®šã€å¾®ä¿¡è¿æ¥ã€æ”¶å•å¼€å¯
- å¤±è´¥æ—¶ä¸å½±å“å…¶ä»–åŠŸèƒ½

**æ¶ˆæ¯æ¨¡æ‹Ÿå™¨é€šçŸ¥**ï¼ˆå¼€å‘ç¯å¢ƒï¼‰:
- åªéœ€è¦å¼€å‘æ¨¡å¼å¼€å¯
- ä¸ä¾èµ–å¾®ä¿¡è¿æ¥çŠ¶æ€
- ç”¨äºæµ‹è¯•å’Œè°ƒè¯•

---

## ğŸ§ª æµ‹è¯•æ–¹æ³•

### æµ‹è¯•æ­¥éª¤

1. **å¯ç”¨å¼€å‘æ¨¡å¼**
   - æ‰“å¼€è®¾ç½® â†’ å‹¾é€‰"å¼€å‘æ¨¡å¼"

2. **æ‰“å¼€æ¶ˆæ¯æ¨¡æ‹Ÿå™¨**
   - é€‰æ‹©ä»»æ„ä¼šå‘˜ â†’ å³é”® â†’ å¼€å‘é€‰é¡¹ â†’ å‘é€æ¶ˆæ¯

3. **ç­‰å¾…ç³»ç»Ÿæ¶ˆæ¯**
   - âœ… å€’è®¡æ—¶ 30 ç§’æé†’åº”è¯¥æ˜¾ç¤º
   - âœ… å€’è®¡æ—¶ 15 ç§’æé†’åº”è¯¥æ˜¾ç¤º
   - âœ… å°ç›˜æ¶ˆæ¯åº”è¯¥æ˜¾ç¤º

### éªŒè¯è¦ç‚¹

| åœºæ™¯ | é¢„æœŸç»“æœ |
|-----|---------|
| å¼€å‘æ¨¡å¼ + æœªç»‘å®šç¾¤ | æ¶ˆæ¯æ¨¡æ‹Ÿå™¨èƒ½çœ‹åˆ°ç³»ç»Ÿæ¶ˆæ¯ âœ… |
| å¼€å‘æ¨¡å¼ + å¾®ä¿¡æœªç™»å½• | æ¶ˆæ¯æ¨¡æ‹Ÿå™¨èƒ½çœ‹åˆ°ç³»ç»Ÿæ¶ˆæ¯ âœ… |
| å¼€å‘æ¨¡å¼ + æ”¶å•å…³é—­ | æ¶ˆæ¯æ¨¡æ‹Ÿå™¨èƒ½çœ‹åˆ°ç³»ç»Ÿæ¶ˆæ¯ âœ… |
| éå¼€å‘æ¨¡å¼ | æ¶ˆæ¯æ¨¡æ‹Ÿå™¨çœ‹ä¸åˆ°ç³»ç»Ÿæ¶ˆæ¯ âœ… |

---

## ğŸ“ åç»­å·¥ä½œ

### éœ€è¦ç»§ç»­åŒæ­¥çš„æ–¹æ³•

1. **`OnOpeningAsync`** - å¼€ç›˜æ¶ˆæ¯
2. **`SendSettlementMessagesAsync`** - ç»“ç®—æ¶ˆæ¯ï¼ˆä¸­~åå•ã€ç•™~åå•ï¼‰
3. **`SendHistoryLotteryImageAsync`** - å†å²è®°å½•å›¾ç‰‡

### åŒæ­¥æ–¹å¼

åœ¨æ¯ä¸ªæ–¹æ³•ä¸­æ·»åŠ ç±»ä¼¼çš„é€»è¾‘ï¼š
```csharp
// ğŸ”¥ å¼€å‘æ¨¡å¼ï¼šé€šçŸ¥æ¶ˆæ¯æ¨¡æ‹Ÿå™¨
if (isDevMode)
{
    Views.Dev.MessageSimulatorForm.NotifySystemMessage("æ¶ˆæ¯ç±»å‹", message);
    _logService.Debug("LotteryService", $"ğŸ”§ å¼€å‘æ¨¡å¼ï¼šå·²é€šçŸ¥æ¶ˆæ¯æ¨¡æ‹Ÿå™¨...");
}
```

---

## ğŸ“š å‚è€ƒæ–‡æ¡£

- **BaiShengVx3Plus ä¿®å¤æŠ¥å‘Š**: `BaiShengVx3Plus/0-èµ„æ–™/æ¶ˆæ¯æ¨¡æ‹Ÿå™¨-ç³»ç»Ÿæ¶ˆæ¯ä¿®å¤æŠ¥å‘Š.md`
- **è®¾è®¡åŸç†**: `BaiShengVx3Plus/èµ„æ–™/ğŸ”æ¨ªåˆ‡å£è®¾è®¡åŸç†è¯¦è§£.md`

---

**ä¿®å¤å®Œæˆæ—¥æœŸ**: 2025-12-09  
**ä¿®å¤çŠ¶æ€**: âœ… æ ¸å¿ƒåŠŸèƒ½å·²åŒæ­¥ï¼ˆå°ç›˜ç›¸å…³æ¶ˆæ¯ï¼‰  
**å¾…å®Œæˆ**: â³ å…¶ä»–ç³»ç»Ÿæ¶ˆæ¯ç±»å‹

