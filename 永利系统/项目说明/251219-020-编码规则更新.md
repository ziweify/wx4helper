# PowerShell脚本编码规则更新

**📅 日期**: 2025-12-19  
**✅ 状态**: 已完成  
**📌 主题**: PowerShell脚本文件编码规则和解决方案  
**📄 文件编号**: 251219-020

---

## 🎯 更新目的

解决PowerShell脚本执行时的中文编码问题，确保脚本文件能够正确处理中文字符串，避免"意外的标记"和"字符串缺少终止符"等错误。

---

## 🔴 问题描述

### 问题现象

即使使用`write`工具创建了PowerShell脚本文件，如果脚本中包含中文字符串字面量，在执行时仍可能出现编码错误：

**错误示例**：
```powershell
# 脚本内容
$title = "本地DLL引用"  # 中文字符串
Rename-Item "old.md" "new-$title.md"
```

**错误信息**：
```
表达式或语句中包含意外的标记"}"
字符串缺少终止符: "
```

### 问题原因

1. **脚本文件编码问题**：
   - PowerShell默认期望脚本文件是UTF-8 with BOM编码
   - 如果脚本是UTF-8 without BOM，中文字符串可能被错误解析
   - Cursor的`write`工具可能创建UTF-8 without BOM的文件

2. **字符串字面量问题**：
   - 脚本中的中文字符串字面量在解析时可能出错
   - 即使文件编码正确，PowerShell解析器也可能误解中文字符

---

## ✅ 解决方案

### 方案1: 使用Base64编码存储中文字符串（推荐）⭐

**优点**：完全避免编码问题，最可靠

**实现方式**：
```powershell
# 使用Base64编码存储中文字符串
function Decode-UTF8Base64 {
    param([string]$base64)
    $bytes = [System.Convert]::FromBase64String($base64)
    return [System.Text.Encoding]::UTF8.GetString($bytes)
}

# 中文字符串使用Base64编码
$title = Decode-UTF8Base64 "6Y+I7oSA5rm0RExM5a+u5pug5pWk"  # "本地DLL引用"
$newName = "251219-002-$title.md"
```

**完整示例**：
```powershell
# 修复乱码文件名的脚本
$fixMap = @{}
$fixMap["251219-002-鏈湴DLL寮曠敤.md"] = "251219-002-" + (Decode-UTF8Base64 "6Y+I7oSA5rm0RExM5a+u5pug5pWk") + ".md"
$fixMap["251219-003-寮曠敤缂哄け瑙ｅ喅.md"] = "251219-003-" + (Decode-UTF8Base64 "5a+u5pug5pWk57yC5ZOE44GR55GZ772F5ZaF") + ".md"
```

### 方案2: 确保脚本文件是UTF-8 with BOM

**步骤**：
1. 创建脚本后，告知用户检查编码
2. 提供转换脚本（如`转换为UTF8BOM.ps1`）
3. 或提供手动转换方法

**转换脚本示例**：
```powershell
# 转换为UTF8BOM.ps1
$content = Get-Content "script.ps1" -Raw -Encoding UTF8
$utf8WithBOM = New-Object System.Text.UTF8Encoding $true
[System.IO.File]::WriteAllText("script.ps1", $content, $utf8WithBOM)
```

### 方案3: 避免在脚本中使用中文字符串字面量

**方法**：
- 使用变量存储，通过Base64解码
- 从文件读取（文件本身是UTF-8 with BOM）
- 使用参数传递（用户在终端输入）

---

## 📋 PowerShell脚本创建检查清单

创建PowerShell脚本时，检查：

- [ ] 脚本是否包含中文字符串字面量？
  - 是 → 使用Base64编码存储 ✅
  - 否 → 可以直接使用 ✅
- [ ] 脚本文件编码是否为UTF-8 with BOM？
  - 不确定 → 提供转换脚本或说明 ✅
- [ ] 是否提供了多种执行方式？
  - 是 → 包括终端执行、批处理脚本、手动操作 ✅

---

## 🎯 PowerShell脚本最佳实践

### DO ✅

1. **使用Base64编码存储中文字符串**
   ```powershell
   $title = Decode-UTF8Base64 "6Y+I7oSA5rm0RExM5a+u5pug5pWk"
   ```

2. **提供编码转换工具**
   - 创建`转换为UTF8BOM.ps1`脚本
   - 告知用户如何检查文件编码

3. **在脚本开头设置编码**
   ```powershell
   [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
   $OutputEncoding = [System.Text.Encoding]::UTF8
   ```

4. **使用相对路径和变量**
   ```powershell
   $baseDir = Split-Path -Parent $MyInvocation.MyCommand.Path
   $targetDir = Join-Path $baseDir "项目说明"
   ```

### DON'T ❌

1. **不要在脚本中直接使用中文字符串字面量**
   ```powershell
   # ❌ 错误
   $title = "本地DLL引用"
   ```

2. **不要假设脚本文件编码正确**
   - 总是提供编码检查和转换方法

3. **不要忽略编码错误**
   - 如果用户报告编码错误，立即提供Base64编码方案

---

## 📝 标准脚本模板

```powershell
# PowerShell脚本模板 - 支持中文
# 注意：中文字符串使用Base64编码

[Console]::OutputEncoding = [System.Text.Encoding]::UTF8
$OutputEncoding = [System.Text.Encoding]::UTF8

# Base64解码函数
function Decode-UTF8Base64 {
    param([string]$base64)
    $bytes = [System.Convert]::FromBase64String($base64)
    return [System.Text.Encoding]::UTF8.GetString($bytes)
}

# 获取脚本所在目录
$baseDir = Split-Path -Parent $MyInvocation.MyCommand.Path

# 使用Base64编码的中文字符串
$title = Decode-UTF8Base64 "6Y+I7oSA5rm0RExM5a+u5pug5pWk"  # "本地DLL引用"

# 脚本逻辑...
```

---

## 🔍 故障排查

### 如果用户报告"脚本执行错误：意外的标记"

1. **检查脚本中是否包含中文字符串字面量**
   - 如果有 → 改为Base64编码 ✅

2. **检查脚本文件编码**
   - 使用`转换为UTF8BOM.ps1`转换 ✅

3. **检查PowerShell版本**
   - PowerShell 5.1+ 和 PowerShell Core 7+ 对编码处理不同
   - 建议使用Base64编码方案（兼容性最好）✅

### 如果用户报告"文件名还是乱码"

1. **检查映射表中的键值**
   - 键（旧文件名）必须与实际文件名完全匹配
   - 值（新文件名）必须使用Base64解码后的正确中文 ✅

2. **验证Base64编码是否正确**
   - 提供测试脚本验证解码结果 ✅

---

## 📚 相关规则文件

本次更新已同步到以下规则文件：

1. **`AI工作规则/终端命令执行规则.md`**
   - 添加了"PowerShell脚本文件编码规则"章节
   - 包含完整的问题分析、解决方案和最佳实践

2. **`AI工作规则/快速参考.md`**
   - 添加了PowerShell脚本编码的快速提示
   - 包含Base64编码示例

3. **`AI工作规则/README.md`**
   - 更新了规则索引
   - 添加了PowerShell脚本编码规则的场景映射

---

## ✅ 已完成工作

1. ✅ 分析PowerShell脚本编码问题
2. ✅ 制定Base64编码解决方案
3. ✅ 更新终端命令执行规则文档
4. ✅ 更新快速参考文档
5. ✅ 更新规则索引文件
6. ✅ 创建标准脚本模板
7. ✅ 提供故障排查指南

---

## 🎯 规则要点总结

1. **PowerShell脚本中的中文字符串必须使用Base64编码**
2. **提供编码转换工具和说明**
3. **在脚本开头设置输出编码**
4. **使用相对路径和变量避免硬编码**
5. **提供完整的故障排查指南**

---

## 📌 重要提示

- ⚠️ **这是必须遵守的规则**，违反会导致脚本执行失败
- ✅ **Base64编码方案最可靠**，兼容所有PowerShell版本
- 📝 **每次创建包含中文的PowerShell脚本时都要检查**
- 🔍 **遇到编码错误时，立即使用Base64编码方案**

---

**文件类型**: 规则更新报告  
**版本**: v1.0  
**创建者**: AI Assistant  
**最后更新**: 2025-12-19

