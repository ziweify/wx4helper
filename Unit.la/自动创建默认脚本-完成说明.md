# 自动创建默认脚本 - 完成说明

## ✅ 已修复的问题

### 问题描述
- Tab 标签显示 `main.lua`
- 但左侧脚本列表是空的
- 没有实际的 `main.lua` 文件

### 解决方案

#### 1. **自动检测空目录**
初始化时检查脚本目录是否为空（没有 `.lua` 文件）

#### 2. **自动创建默认脚本**
如果目录为空，自动创建：
- ✅ `main.lua` - 主脚本模板
- ✅ `functions.lua` - 功能库模板

#### 3. **自动加载到列表**
创建后自动刷新左侧脚本列表

#### 4. **自动打开 main.lua**
- 在默认 Tab 中显示 `main.lua` 的内容
- Tab 标题显示为 `main`（不带扩展名）
- Tab 的 Tag 关联实际的 `ScriptInfo` 对象

## 🔧 实现逻辑

```csharp
// 1. 创建脚本目录
var defaultScriptDir = Path.Combine(BaseDirectory, "Scripts", TaskName);
Directory.CreateDirectory(defaultScriptDir);

// 2. 检查是否为空目录
var existingFiles = Directory.GetFiles(defaultScriptDir, "*.lua");

if (existingFiles.Length == 0)
{
    // 3. 创建默认脚本
    File.WriteAllText("main.lua", GetScriptTemplate(Main));
    File.WriteAllText("functions.lua", GetScriptTemplate(Functions));
}

// 4. 加载脚本列表
LoadScriptsFromDirectory(defaultScriptDir, listBoxScripts);

// 5. 自动打开 main.lua 到默认 Tab
var mainScript = listBoxScripts.Items.FirstOrDefault(s => s.Name == "main.lua");
if (mainScript != null)
{
    _scriptEditor.ScriptText = mainScript.Content;
    tabPageMain.Text = mainScript.DisplayName;  // "main"
    tabPageMain.Tag = mainScript;               // 关联 ScriptInfo
}
```

## 📊 脚本模板内容

### main.lua
```lua
-- ====================================
-- 主脚本 (main.lua)
-- 控制业务逻辑流程
-- ====================================

log('主脚本开始执行')

-- 主要业务逻辑
function main()
    -- 1. 登录
    log('步骤1: 登录')
    local loginSuccess = login(config.username or 'test', config.password or 'pass')
    if not loginSuccess then
        log('登录失败，终止执行')
        return false
    end

    -- 2. 执行业务逻辑
    log('步骤2: 执行业务')
    -- 在这里调用 functions.lua 中定义的功能函数

    log('执行完成')
    return true
end

-- 执行主逻辑
local success = main()
if success then
    log('✅ 主脚本执行成功')
else
    log('❌ 主脚本执行失败')
end
```

### functions.lua
```lua
-- ====================================
-- 功能库 (functions.lua)
-- 定义所有业务功能函数
-- ====================================

log('功能库加载中...')

-- 示例：登录功能
function login(username, password)
    log('登录: ' .. username)
    
    -- 在这里实现登录逻辑
    navigate(config.url or 'https://example.com/login')
    wait(2000)
    
    -- 填写表单
    -- ...
    
    return true
end

-- 示例：获取数据功能
function getData()
    log('获取数据')
    
    -- 在这里实现数据获取逻辑
    
    return 'data'
end

-- 示例：查询订单
function queryOrder(orderId)
    log('查询订单: ' .. orderId)
    
    -- 在这里实现订单查询逻辑
    
    return {}
end

-- 示例：投注功能
function placeBet(betData)
    log('投注')
    
    -- 在这里实现投注逻辑
    
    return true
end

log('功能库加载完成')
```

## 🎯 用户体验

### 首次使用流程

1. **创建新任务**
2. **点击"启动"或"编辑"**
3. **点击"📝 脚本"标签**
4. **自动效果**：
   - ✅ 左侧列表显示：
     ```
     📄 main
     📄 functions
     ```
   - ✅ 右侧 Tab 显示：`main`
   - ✅ 编辑器中显示 main.lua 的模板内容
   - ✅ 路径栏显示：`📂 E:\...\Scripts\任务名称\`
   - ✅ 日志显示：`✅ 已创建默认脚本模板`

5. **可以直接开始编辑**
6. **按 Ctrl+S 保存**

### 再次打开时
- 脚本文件已存在
- 不会重复创建
- 直接加载现有脚本

## 📂 文件结构

```
Scripts/
└── 任务名称/
    ├── main.lua           ← 自动创建
    ├── functions.lua      ← 自动创建
    └── (用户自己创建的其他脚本)
```

## ✅ 解决的问题

| 问题 | 解决方案 |
|------|---------|
| ❌ Tab 显示 main.lua 但文件不存在 | ✅ 自动创建 main.lua 文件 |
| ❌ 左侧列表为空 | ✅ 自动加载创建的文件到列表 |
| ❌ 不知道从哪里开始 | ✅ 提供完整的脚本模板 |
| ❌ Tab 和列表不匹配 | ✅ Tab 正确关联 ScriptInfo 对象 |

## 🎉 测试步骤

1. **删除现有的 Scripts 文件夹**（如果有）
2. **关闭并重新运行程序**
3. **创建新的浏览器任务**
4. **打开任务窗口**
5. **点击"📝 脚本"标签**
6. **确认**：
   - ✅ 左侧列表显示 `main` 和 `functions`
   - ✅ 右侧 Tab 显示 `main`
   - ✅ 编辑器中有模板代码
   - ✅ 可以编辑并保存（Ctrl+S）

## 📊 编译状态

```
✅ Unit.la - 编译成功
✅ 自动创建默认脚本功能已实现
```

---

**完成时间**: 2026-01-22  
**功能状态**: ✅ 首次使用自动创建默认脚本模板
