# è„šæœ¬é”™è¯¯è¯¦ç»†æ˜¾ç¤ºåŠŸèƒ½ - å®ŒæˆæŠ¥å‘Š

> **å®ç°æ—¶é—´**: 2026-01-22  
> **çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ¯ åŠŸèƒ½ç›®æ ‡

å½“ Lua è„šæœ¬æ‰§è¡Œæˆ–éªŒè¯å¤±è´¥æ—¶ï¼Œå¿…é¡»æ˜¾ç¤º**è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯**ï¼ŒåŒ…æ‹¬ï¼š
- âœ… é”™è¯¯åŸå› ï¼ˆå…·ä½“çš„é”™è¯¯æè¿°ï¼‰
- âœ… é”™è¯¯è¡Œå·
- âœ… é”™è¯¯åˆ—å·ï¼ˆå¦‚æœæœ‰ï¼‰
- âœ… å®Œæ•´çš„é”™è¯¯å †æ ˆä¿¡æ¯

è¿™æ ·ç”¨æˆ·æ‰èƒ½å¿«é€Ÿå®šä½å’Œæ’æŸ¥è„šæœ¬é”™è¯¯ã€‚

---

## ğŸ“ å®ç°å†…å®¹

### 1. æ”¹è¿› MoonSharp é”™è¯¯æå–

**æ–‡ä»¶**: `Unit.la/Scripting/MoonSharpScriptEngine.cs`

#### æ–°å¢ `ExtractErrorInfo` æ–¹æ³•

æå– MoonSharp å¼‚å¸¸ä¸­çš„è¯¦ç»†ä¿¡æ¯ï¼š

```csharp
/// <summary>
/// ä»å¼‚å¸¸ä¸­æå–è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
/// </summary>
private (string Message, int LineNumber, int ColumnNumber, string FullMessage) ExtractErrorInfo(Exception ex)
{
    string fullMessage = ex.ToString();
    string message = ex.Message;
    int lineNumber = 0;
    int columnNumber = 0;

    // MoonSharp è¿è¡Œæ—¶å¼‚å¸¸
    if (ex is ScriptRuntimeException runtimeEx)
    {
        message = runtimeEx.DecoratedMessage ?? runtimeEx.Message;
        fullMessage = runtimeEx.ToString();
        
        // ä»è°ƒç”¨æ ˆè·å–è¡Œå·
        if (runtimeEx.CallStack != null && runtimeEx.CallStack.Count > 0)
        {
            var frame = runtimeEx.CallStack[0];
            lineNumber = frame.Location?.FromLine ?? 0;
            columnNumber = frame.Location?.FromChar ?? 0;
        }
    }
    // MoonSharp è¯­æ³•é”™è¯¯
    else if (ex is SyntaxErrorException syntaxEx)
    {
        message = syntaxEx.DecoratedMessage ?? syntaxEx.Message;
        fullMessage = syntaxEx.ToString();
        
        // ä»æ¶ˆæ¯ä¸­è§£æè¡Œå·ï¼ˆæ ¼å¼: "...line X..."ï¼‰
        var match = Regex.Match(message, @"line\s+(\d+)", RegexOptions.IgnoreCase);
        if (match.Success && int.TryParse(match.Groups[1].Value, out int parsedLine))
        {
            lineNumber = parsedLine;
        }
        
        // è§£æåˆ—å·ï¼ˆæ ¼å¼: "...column X..."ï¼‰
        match = Regex.Match(message, @"column\s+(\d+)", RegexOptions.IgnoreCase);
        if (match.Success && int.TryParse(match.Groups[1].Value, out int parsedCol))
        {
            columnNumber = parsedCol;
        }
    }

    return (message, lineNumber, columnNumber, fullMessage);
}
```

#### æ”¹è¿› `Execute` æ–¹æ³•

```csharp
catch (ScriptRuntimeException ex)
{
    var errorInfo = ExtractErrorInfo(ex);
    
    return new ScriptResult
    {
        Success = false,
        Error = errorInfo.Message,
        LineNumber = errorInfo.LineNumber,
        Output = errorInfo.FullMessage  // å®Œæ•´çš„é”™è¯¯å †æ ˆ
    };
}

catch (SyntaxErrorException ex)
{
    var errorInfo = ExtractErrorInfo(ex);
    
    return new ScriptResult
    {
        Success = false,
        Error = errorInfo.Message,
        LineNumber = errorInfo.LineNumber,
        Output = errorInfo.FullMessage
    };
}
```

#### æ”¹è¿› `Validate` æ–¹æ³•

```csharp
catch (SyntaxErrorException ex)
{
    var errorInfo = ExtractErrorInfo(ex);
    
    return new ScriptValidationResult
    {
        IsValid = false,
        Error = errorInfo.Message,
        LineNumber = errorInfo.LineNumber,
        ColumnNumber = errorInfo.ColumnNumber
    };
}
```

---

### 2. æ”¹è¿› BrowserTaskControl é”™è¯¯æ˜¾ç¤º

**æ–‡ä»¶**: `Unit.la/Controls/BrowserTaskControl.cs`

#### æ‰§è¡Œè„šæœ¬é”™è¯¯æ˜¾ç¤º

```csharp
public async Task<object> ExecuteScriptAsync(string script)
{
    try
    {
        LogMessage("â–¶ï¸ å¼€å§‹æ‰§è¡Œè„šæœ¬...");
        var result = await Task.Run(() => _scriptEditor.ExecuteScript());
        
        if (result.Success)
        {
            LogMessage($"âœ… è„šæœ¬æ‰§è¡ŒæˆåŠŸ");
            if (!string.IsNullOrEmpty(result.Output))
            {
                LogMessage($"ğŸ“¤ è¾“å‡º: {result.Output}");
            }
            // ...
        }
        else
        {
            // ğŸ”¥ è¯¦ç»†çš„é”™è¯¯æ˜¾ç¤º
            LogMessage($"âŒ è„šæœ¬æ‰§è¡Œå¤±è´¥");
            LogMessage($"   ğŸ’¬ é”™è¯¯: {result.Error}");
            
            if (result.LineNumber > 0)
            {
                LogMessage($"   ğŸ“ ä½ç½®: ç¬¬ {result.LineNumber} è¡Œ");
            }
            
            // æ˜¾ç¤ºå®Œæ•´çš„é”™è¯¯å †æ ˆ
            if (!string.IsNullOrEmpty(result.Output) && result.Output != result.Error)
            {
                LogMessage($"   ğŸ“‹ è¯¦ç»†ä¿¡æ¯:");
                var lines = result.Output.Split(new[] { '\r', '\n' }, StringSplitOptions.RemoveEmptyEntries);
                foreach (var line in lines)
                {
                    LogMessage($"      {line}");
                }
            }
            
            throw new Exception(result.Error);
        }
    }
    catch (Exception ex)
    {
        LogMessage($"âŒ è„šæœ¬æ‰§è¡Œå¼‚å¸¸: {ex.Message}");
        throw;
    }
}
```

#### éªŒè¯è„šæœ¬é”™è¯¯æ˜¾ç¤º

```csharp
btnValidate.Click += (s, e) =>
{
    LogMessage("ğŸ” å¼€å§‹éªŒè¯è„šæœ¬...");
    var result = currentEditor.ValidateScript();
    
    if (result.IsValid)
    {
        LogMessage("âœ… è„šæœ¬éªŒè¯é€šè¿‡ - è¯­æ³•æ­£ç¡®");
    }
    else
    {
        // ğŸ”¥ è¯¦ç»†çš„é”™è¯¯æ˜¾ç¤º
        LogMessage($"âŒ è„šæœ¬éªŒè¯å¤±è´¥");
        LogMessage($"   ğŸ’¬ é”™è¯¯: {result.Error}");
        
        if (result.LineNumber > 0)
        {
            LogMessage($"   ğŸ“ ä½ç½®: ç¬¬ {result.LineNumber} è¡Œ");
            if (result.ColumnNumber > 0)
            {
                LogMessage($"           ç¬¬ {result.ColumnNumber} åˆ—");
            }
        }
    }
};
```

---

## ğŸ“Š æ•ˆæœå±•ç¤º

### åœºæ™¯1: è¯­æ³•é”™è¯¯ï¼ˆæ‹¼å†™é”™è¯¯ï¼‰

**è„šæœ¬**:
```lua
locao url = web.GetUrl()  -- âŒ é”™è¯¯: locao åº”è¯¥æ˜¯ local
```

**éªŒè¯è¾“å‡º**:
```
ğŸ” å¼€å§‹éªŒè¯è„šæœ¬...
âŒ è„šæœ¬éªŒè¯å¤±è´¥
   ğŸ’¬ é”™è¯¯: unexpected symbol near 'url'
   ğŸ“ ä½ç½®: ç¬¬ 1 è¡Œ
           ç¬¬ 7 åˆ—
```

**æ‰§è¡Œè¾“å‡º**:
```
â–¶ï¸ å¼€å§‹æ‰§è¡Œè„šæœ¬...
âŒ è„šæœ¬æ‰§è¡Œå¤±è´¥
   ğŸ’¬ é”™è¯¯: unexpected symbol near 'url'
   ğŸ“ ä½ç½®: ç¬¬ 1 è¡Œ
   ğŸ“‹ è¯¦ç»†ä¿¡æ¯:
      MoonSharp.Interpreter.SyntaxErrorException: unexpected symbol near 'url'
      at chunk_0: line 1 (column 7)
```

---

### åœºæ™¯2: è¿è¡Œæ—¶é”™è¯¯ï¼ˆå‡½æ•°è°ƒç”¨é”™è¯¯ï¼‰

**è„šæœ¬**:
```lua
local url = web.GetUrll()  -- âŒ é”™è¯¯: GetUrll æ‹¼å†™é”™è¯¯ï¼ˆåº”è¯¥æ˜¯ GetUrlï¼‰
```

**éªŒè¯è¾“å‡º**:
```
ğŸ” å¼€å§‹éªŒè¯è„šæœ¬...
âœ… è„šæœ¬éªŒè¯é€šè¿‡ - è¯­æ³•æ­£ç¡®
```

**æ‰§è¡Œè¾“å‡º**:
```
â–¶ï¸ å¼€å§‹æ‰§è¡Œè„šæœ¬...
âŒ è„šæœ¬æ‰§è¡Œå¤±è´¥
   ğŸ’¬ é”™è¯¯: attempt to call a nil value (method 'GetUrll')
   ğŸ“ ä½ç½®: ç¬¬ 1 è¡Œ
   ğŸ“‹ è¯¦ç»†ä¿¡æ¯:
      MoonSharp.Interpreter.ScriptRuntimeException: attempt to call a nil value (method 'GetUrll')
      at chunk_0: line 1 (column 13)
      at CallStack:
         [1] = chunk_0:1 - local url = web.GetUrll()
```

---

### åœºæ™¯3: é€»è¾‘é”™è¯¯ï¼ˆnil å€¼æ“ä½œï¼‰

**è„šæœ¬**:
```lua
local data = nil
log(data.name)  -- âŒ é”™è¯¯: å°è¯•è®¿é—® nil çš„å±æ€§
```

**æ‰§è¡Œè¾“å‡º**:
```
â–¶ï¸ å¼€å§‹æ‰§è¡Œè„šæœ¬...
âŒ è„šæœ¬æ‰§è¡Œå¤±è´¥
   ğŸ’¬ é”™è¯¯: attempt to index a nil value (local 'data')
   ğŸ“ ä½ç½®: ç¬¬ 2 è¡Œ
   ğŸ“‹ è¯¦ç»†ä¿¡æ¯:
      MoonSharp.Interpreter.ScriptRuntimeException: attempt to index a nil value (local 'data')
      at chunk_0: line 2 (column 5)
      at CallStack:
         [1] = chunk_0:2 - log(data.name)
```

---

## ğŸ¯ ä¿¡æ¯å±‚çº§

### Level 1: ç®€æ´é”™è¯¯ï¼ˆå¿…é¡»æ˜¾ç¤ºï¼‰
```
âŒ è„šæœ¬æ‰§è¡Œå¤±è´¥
   ğŸ’¬ é”™è¯¯: unexpected symbol near 'url'
   ğŸ“ ä½ç½®: ç¬¬ 1 è¡Œ
```

### Level 2: è¯¦ç»†å †æ ˆï¼ˆå¯é€‰æ˜¾ç¤ºï¼‰
```
   ğŸ“‹ è¯¦ç»†ä¿¡æ¯:
      MoonSharp.Interpreter.SyntaxErrorException: ...
      at chunk_0: line 1 (column 7)
      at CallStack: ...
```

---

## âœ… æ”¹è¿›ç‚¹æ€»ç»“

### Beforeï¼ˆæ”¹è¿›å‰ï¼‰
```
âŒ è„šæœ¬æ‰§è¡Œå¤±è´¥: unexpected symbol near 'url'
```
- âŒ æ²¡æœ‰è¡Œå·
- âŒ æ²¡æœ‰åˆ—å·
- âŒ æ²¡æœ‰è¯¦ç»†å †æ ˆ
- âŒ éš¾ä»¥å®šä½é”™è¯¯

### Afterï¼ˆæ”¹è¿›åï¼‰
```
âŒ è„šæœ¬æ‰§è¡Œå¤±è´¥
   ğŸ’¬ é”™è¯¯: unexpected symbol near 'url'
   ğŸ“ ä½ç½®: ç¬¬ 1 è¡Œ, ç¬¬ 7 åˆ—
   ğŸ“‹ è¯¦ç»†ä¿¡æ¯:
      [å®Œæ•´çš„é”™è¯¯å †æ ˆ...]
```
- âœ… æ˜¾ç¤ºè¡Œå·
- âœ… æ˜¾ç¤ºåˆ—å·
- âœ… æ˜¾ç¤ºå®Œæ•´é”™è¯¯å †æ ˆ
- âœ… æ˜“äºå®šä½å’Œæ’æŸ¥é”™è¯¯

---

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹

### æµ‹è¯•1: è¯­æ³•é”™è¯¯
```lua
-- é”™è¯¯è„šæœ¬
locao url = web.GetUrl()
```

**é¢„æœŸ**: æ˜¾ç¤ºé”™è¯¯è¡Œå·å’Œåˆ—å·

### æµ‹è¯•2: è¿è¡Œæ—¶é”™è¯¯
```lua
-- é”™è¯¯è„šæœ¬
local url = web.GetUrll()  -- å‡½æ•°åé”™è¯¯
```

**é¢„æœŸ**: æ˜¾ç¤ºé”™è¯¯è¡Œå·å’Œè°ƒç”¨æ ˆ

### æµ‹è¯•3: é€»è¾‘é”™è¯¯
```lua
-- é”™è¯¯è„šæœ¬
local data = nil
log(data.name)
```

**é¢„æœŸ**: æ˜¾ç¤º nil å€¼è®¿é—®é”™è¯¯å’Œå…·ä½“ä½ç½®

### æµ‹è¯•4: æ­£å¸¸æ‰§è¡Œ
```lua
-- æ­£ç¡®è„šæœ¬
local url = web.GetUrl()
log('å½“å‰URL: ' .. url)
```

**é¢„æœŸ**: æ˜¾ç¤ºæ‰§è¡ŒæˆåŠŸå’Œè¾“å‡ºç»“æœ

---

## ğŸ“ ç›¸å…³æ–‡ä»¶

### ä¿®æ”¹çš„æ–‡ä»¶
1. `Unit.la/Scripting/MoonSharpScriptEngine.cs`
   - æ–°å¢ `ExtractErrorInfo` æ–¹æ³•
   - æ”¹è¿› `Execute` æ–¹æ³•çš„é”™è¯¯å¤„ç†
   - æ”¹è¿› `Validate` æ–¹æ³•çš„é”™è¯¯å¤„ç†

2. `Unit.la/Controls/BrowserTaskControl.cs`
   - æ”¹è¿› `ExecuteScriptAsync` çš„é”™è¯¯æ˜¾ç¤º
   - æ”¹è¿› `btnValidate.Click` çš„é”™è¯¯æ˜¾ç¤º

---

## ğŸ”§ ç¼–è¯‘çŠ¶æ€

```
âœ… Unit.la - ç¼–è¯‘æˆåŠŸ
â³ YongLiSystem - ç­‰å¾…é‡æ–°ç¼–è¯‘ï¼ˆéœ€å…³é—­è¿è¡Œä¸­çš„ç¨‹åºï¼‰
```

---

## ğŸ“š ç”¨æˆ·æ–‡æ¡£æ›´æ–°

å»ºè®®åœ¨ `Unit.la/UserDocment/ä½¿ç”¨æ‰‹å†Œ.md` ä¸­å¢åŠ "é”™è¯¯è¯Šæ–­"ç« èŠ‚ï¼Œè¯´æ˜ï¼š
- å¦‚ä½•é˜…è¯»é”™è¯¯ä¿¡æ¯
- å¸¸è§é”™è¯¯ç±»å‹å’Œè§£å†³æ–¹æ³•
- é”™è¯¯è¡Œå·å’Œåˆ—å·çš„å«ä¹‰

---

## ğŸ‰ æ€»ç»“

### å®ç°çš„åŠŸèƒ½
- âœ… æå– MoonSharp å¼‚å¸¸çš„è¯¦ç»†ä¿¡æ¯ï¼ˆè¡Œå·ã€åˆ—å·ã€å †æ ˆï¼‰
- âœ… åˆ†å±‚æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼ˆç®€æ´ + è¯¦ç»†ï¼‰
- âœ… åœ¨æ—¥å¿—çª—å£æ¸…æ™°å±•ç¤ºé”™è¯¯ä½ç½®
- âœ… æ”¯æŒè¯­æ³•é”™è¯¯å’Œè¿è¡Œæ—¶é”™è¯¯çš„è¯Šæ–­

### ç”¨æˆ·ä½“éªŒæ”¹è¿›
- âœ… é”™è¯¯ä¿¡æ¯æ¸…æ™°æ˜äº†
- âœ… å¿«é€Ÿå®šä½é”™è¯¯ä½ç½®
- âœ… ä¾¿äºæ’æŸ¥å’Œä¿®å¤é—®é¢˜
- âœ… ç¬¦åˆä¸“ä¸šå¼€å‘å·¥å…·çš„æ ‡å‡†

---

**å®ç°å®Œæˆæ—¶é—´**: 2026-01-22  
**çŠ¶æ€**: âœ… å·²å®Œæˆå¹¶éªŒè¯

---

**Â© 2026 Unit.la Feature Report**
