# ä¸ºä»€ä¹ˆä¹‹å‰å¯ä»¥ï¼Œç°åœ¨ä¸è¡Œï¼Ÿ- æ”¹åŠ¨åˆ†æ

> **åˆ†ææ—¶é—´**: 2026-01-22  
> **çŠ¶æ€**: ğŸ” æ ¹æœ¬åŸå› åˆ†æ

---

## ğŸ“‹ æ—¶é—´çº¿å›é¡¾

### é˜¶æ®µ 1: æœ€åˆçš„å®ç°ï¼ˆå¯ä»¥å·¥ä½œï¼‰

**WebBridge æ„é€ å‡½æ•°**ï¼š
```csharp
public WebBridge(WebView2 webView, Action<string>? logger = null)
{
    _webView = webView;
    _logger = logger ?? (msg => { });
}
```

**ScriptFunctionRegistry.RegisterDefaults**ï¼š
```csharp
public void RegisterDefaults(
    Action<string>? logCallback = null, 
    WebView2? webView = null)  // â¬…ï¸ æ¥æ”¶ WebView2 å®ä¾‹
{
    // ...
    if (webView != null)
    {
        var webBridge = new WebBridge(webView, logCallback);
        RegisterObject("web", webBridge);
    }
}
```

**BrowserTaskControl è°ƒç”¨**ï¼š
```csharp
private void RegisterDefaultFunctions()
{
    _functionRegistry.RegisterDefaults(LogMessage, _webView);  // â¬…ï¸ ä¼ é€’ WebView2 å®ä¾‹
}
```

**å…³é”®**ï¼šä¼ é€’çš„æ˜¯ `WebView2` å¯¹è±¡ï¼ˆæˆ– nullï¼‰

---

### é˜¶æ®µ 2: web å¯¹è±¡ä¸º nil é—®é¢˜

**é—®é¢˜**ï¼š
```
chunk_1:(9,4-28): attempt to index a nil value
è„šæœ¬ç¬¬9è¡Œ: local url = web.GetUrl()
```

**åŸå› **ï¼šåˆå§‹åŒ–é¡ºåºé”™è¯¯
```csharp
public BrowserTaskControl(BrowserTaskConfig config)
{
    InitializeComponent();
    RegisterDefaultFunctions();  // âŒ _webView è¿˜æ˜¯ null
    InitializeControls();
    InitializeWebView();         // â¬…ï¸ _webView åœ¨è¿™é‡Œæ‰åˆ›å»º
}
```

**ä¿®å¤**ï¼šè°ƒæ•´åˆå§‹åŒ–é¡ºåº
```csharp
public BrowserTaskControl(BrowserTaskConfig config)
{
    InitializeComponent();
    InitializeWebView();         // âœ… å…ˆåˆ›å»º _webView
    RegisterDefaultFunctions();  // âœ… ç°åœ¨ _webView æœ‰æ•ˆ
    InitializeControls();
}
```

**ç»“æœ**ï¼šâœ… web å¯¹è±¡ä¸å†æ˜¯ nil

---

### é˜¶æ®µ 3: åŠ¨æ€å¼•ç”¨æ”¹é€ ï¼ˆå¼•å…¥æ–°é—®é¢˜ï¼ï¼‰

**ç”¨æˆ·éœ€æ±‚**ï¼š
> "luaä¸­webå¯¹è±¡, è¦ä¿è¯å…³è”æ˜¯OKçš„ï¼Œä¿è¯åœ¨é‡æ–°åˆ›å»ºå¯¹è±¡æ—¶å€™, å¯¹è±¡é”€æ¯ï¼Œåˆ›å»ºæ—¶å€™èƒ½è‡ªåŠ¨å†æ¬¡å…³è”"

**æ”¹åŠ¨ 1 - WebBridge æ„é€ å‡½æ•°**ï¼š
```csharp
// Before
public WebBridge(WebView2 webView, Action<string>? logger = null)
{
    _webView = webView;  // â¬…ï¸ é™æ€å¼•ç”¨
}

// After
public WebBridge(Func<WebView2?> webViewProvider, Action<string>? logger = null)
{
    _webViewProvider = webViewProvider;  // â¬…ï¸ åŠ¨æ€å¼•ç”¨
}
```

**æ”¹åŠ¨ 2 - ScriptFunctionRegistry.RegisterDefaults**ï¼š
```csharp
// Before
public void RegisterDefaults(
    Action<string>? logCallback = null, 
    WebView2? webView = null)  // â¬…ï¸ æ¥æ”¶ WebView2 å®ä¾‹
{
    if (webView != null)
    {
        var webBridge = new WebBridge(webView, logCallback);  // â¬…ï¸ ä¼ é€’å®ä¾‹
        RegisterObject("web", webBridge);
    }
}

// After
public void RegisterDefaults(
    Action<string>? logCallback = null, 
    Func<WebView2?>? webViewProvider = null)  // â¬…ï¸ æ¥æ”¶ Func
{
    if (webViewProvider != null)
    {
        var webBridge = new WebBridge(webViewProvider, logCallback);  // â¬…ï¸ ä¼ é€’ Func
        RegisterObject("web", webBridge);
    }
}
```

**æ”¹åŠ¨ 3 - BrowserTaskControl.RegisterDefaultFunctions**ï¼š
```csharp
// Before
_functionRegistry.RegisterDefaults(LogMessage, _webView);  // â¬…ï¸ ä¼ é€’ WebView2 å®ä¾‹

// After
_functionRegistry.RegisterDefaults(LogMessage, () => _webView);  // â¬…ï¸ ä¼ é€’ Lambda (Func)
```

---

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

### ä¸ºä»€ä¹ˆä¹‹å‰å¯ä»¥å·¥ä½œï¼Ÿ

#### åŸå›  1: ä¼ é€’çš„æ˜¯ WebView2 ç±»å‹

**ä¹‹å‰**ï¼š
```csharp
var webBridge = new WebBridge(_webView, logCallback);  // _webView æ˜¯ WebView2 ç±»å‹
RegisterObject("web", webBridge);
```

**å…³é”®**ï¼š
- `WebView2` æ˜¯ Microsoft çš„å®˜æ–¹ç±»å‹
- MoonSharp **å¯èƒ½**å†…ç½®æ”¯æŒäº† `WebView2` ç±»å‹ï¼ˆæˆ–è‡ªåŠ¨è¯†åˆ«ï¼‰
- æˆ–è€…ï¼Œ`WebView2` å¸¦æœ‰ MoonSharp èƒ½è¯†åˆ«çš„å±æ€§/æ¥å£

#### åŸå›  2: webView å¯èƒ½æ˜¯ null

**ä¹‹å‰çš„åˆå§‹åŒ–é¡ºåºé—®é¢˜**ï¼š
```csharp
RegisterDefaultFunctions();  // _webView å¯èƒ½æ˜¯ null
InitializeWebView();         // _webView æ‰è¢«åˆ›å»º
```

**ç»“æœ**ï¼š
```csharp
if (webView != null)  // â¬…ï¸ falseï¼Œè·³è¿‡ï¼
{
    var webBridge = new WebBridge(webView, logCallback);  // ä¸æ‰§è¡Œ
    RegisterObject("web", webBridge);
}
```

**å¦‚æœè·³è¿‡äº†**ï¼š
- âœ… æ²¡æœ‰åˆ›å»º `WebBridge` å¯¹è±¡
- âœ… æ²¡æœ‰è°ƒç”¨ `RegisterObject("web", webBridge)`
- âœ… æ²¡æœ‰ç±»å‹è½¬æ¢é—®é¢˜ï¼ˆå› ä¸ºæ ¹æœ¬æ²¡è½¬æ¢ï¼ï¼‰

ä½†è¿™æ„å‘³ç€ `web` å¯¹è±¡åœ¨ Lua ä¸­æ˜¯ nilï¼Œä¼šå¯¼è‡´è„šæœ¬é”™è¯¯ã€‚

---

### ä¸ºä»€ä¹ˆç°åœ¨ä¸è¡Œï¼Ÿ

#### æ ¸å¿ƒå˜åŒ–ï¼šWebBridge ç°åœ¨æ˜¯è‡ªå®šä¹‰ç±»å‹

**ä¹‹å‰**ï¼š
```csharp
RegisterDefaults(LogMessage, _webView);
// _webView æ˜¯ WebView2 ç±»å‹ï¼ˆå¯èƒ½è¢« MoonSharp è¯†åˆ«ï¼‰
```

**ç°åœ¨**ï¼š
```csharp
RegisterDefaults(LogMessage, () => _webView);
// () => _webView æ˜¯ Func<WebView2?> ç±»å‹

// åœ¨ RegisterDefaults ä¸­
var webBridge = new WebBridge(webViewProvider, logCallback);
// webBridge æ˜¯ WebBridge ç±»å‹ï¼ˆè‡ªå®šä¹‰ç±»å‹ï¼ï¼‰

RegisterObject("web", webBridge);
// å°è¯•å°† WebBridge å¯¹è±¡æ³¨å†Œåˆ° MoonSharp
// âŒ MoonSharp ä¸è®¤è¯† WebBridge ç±»å‹ï¼
```

**é—®é¢˜é“¾**ï¼š
1. æ”¹ä¸ºåŠ¨æ€å¼•ç”¨ â†’ WebBridge æ„é€ å‡½æ•°æ¥æ”¶ `Func<WebView2?>`
2. æ¯æ¬¡éƒ½ä¼šåˆ›å»º `WebBridge` å®ä¾‹ï¼ˆä¸å†æœ‰ null è·³è¿‡ï¼‰
3. `WebBridge` æ˜¯**è‡ªå®šä¹‰ç±»å‹**
4. MoonSharp é»˜è®¤**ä¸è®¤è¯†**è‡ªå®šä¹‰ç±»å‹
5. `RegisterObject("web", webBridge)` å°è¯•å°†è‡ªå®šä¹‰ç±»å‹è½¬æ¢ç»™ MoonSharp
6. âŒ æŠ›å‡ºå¼‚å¸¸ï¼š`cannot convert clr type Unit.La.Scripting.WebBridge`

---

## ğŸ“Š å¯¹æ¯”åˆ†æ

### ä¹‹å‰ï¼ˆé™æ€å¼•ç”¨ï¼‰

```
BrowserTaskControl
    â†“
RegisterDefaults(LogMessage, _webView)
    â†“ (_webView å¯èƒ½æ˜¯ null æˆ– WebView2 å®ä¾‹)
    
æƒ…å†µ 1: _webView == null
    â†“
if (webView != null) â†’ false
    â†“
è·³è¿‡ WebBridge åˆ›å»º
    â†“
âœ… æ²¡æœ‰ç±»å‹è½¬æ¢é—®é¢˜ï¼ˆä½† web å¯¹è±¡æ˜¯ nilï¼‰

æƒ…å†µ 2: _webView != null
    â†“
var webBridge = new WebBridge(_webView, logCallback)
    â†“
RegisterObject("web", webBridge)
    â†“
MoonSharp è¯†åˆ« WebBridgeï¼Ÿ
    â†“
- å¯èƒ½æ˜¯å·§åˆèƒ½å·¥ä½œ
- æˆ–è€… WebBridge ç®€å•åˆ° MoonSharp èƒ½è‡ªåŠ¨å¤„ç†
- æˆ–è€…ä¹‹å‰æ²¡æœ‰çœŸæ­£æµ‹è¯• web å¯¹è±¡
```

---

### ç°åœ¨ï¼ˆåŠ¨æ€å¼•ç”¨ï¼‰

```
BrowserTaskControl
    â†“
RegisterDefaults(LogMessage, () => _webView)
    â†“ (() => _webView æ°¸è¿œä¸æ˜¯ nullï¼Œæ˜¯ Func<WebView2?>)
    
webViewProvider != null â†’ âœ… trueï¼ˆFunc ä¸æ˜¯ nullï¼‰
    â†“
var webBridge = new WebBridge(webViewProvider, logCallback)
    â†“ (åˆ›å»º WebBridge å¯¹è±¡ï¼Œæ¥æ”¶ Func)
    
RegisterObject("web", webBridge)
    â†“ (å°è¯•æ³¨å†Œ WebBridge ç±»å‹)
    
MoonSharp è¯†åˆ« WebBridgeï¼Ÿ
    â†“
âŒ ä¸è®¤è¯†ï¼è‡ªå®šä¹‰ç±»å‹éœ€è¦æ˜¾å¼æ³¨å†Œï¼
    â†“
æŠ›å‡ºå¼‚å¸¸: cannot convert clr type Unit.La.Scripting.WebBridge
```

---

## ğŸ¯ ä¸ºä»€ä¹ˆéœ€è¦ UserData.RegisterTypeï¼Ÿ

### MoonSharp çš„ç±»å‹è¯†åˆ«è§„åˆ™

#### è‡ªåŠ¨è¯†åˆ«çš„ç±»å‹
- âœ… åŸºæœ¬ç±»å‹ï¼šint, string, bool, double, float
- âœ… æ•°ç»„å’Œé›†åˆï¼šList<T>, Dictionary<K,V>, Array
- âœ… æŸäº›æ¡†æ¶ç±»å‹ï¼ˆå¯èƒ½åŒ…æ‹¬ WebView2ï¼‰

#### ä¸è‡ªåŠ¨è¯†åˆ«çš„ç±»å‹
- âŒ **ç”¨æˆ·è‡ªå®šä¹‰ç±»**ï¼ˆå¦‚ `WebBridge`ï¼‰
- âŒ è‡ªå®šä¹‰ç»“æ„ä½“
- âŒ æ²¡æœ‰æ ‡è®° `[MoonSharpUserData]` çš„ç±»å‹

### WebBridge æ˜¯è‡ªå®šä¹‰ç±»

```csharp
namespace Unit.La.Scripting
{
    public class WebBridge  // â¬…ï¸ è‡ªå®šä¹‰ç±»ï¼
    {
        private readonly Func<WebView2?> _webViewProvider;
        
        public void Navigate(string url) { ... }
        public string GetUrl() { ... }
        // ...
    }
}
```

**ç»“æœ**ï¼š
- MoonSharp ä¸çŸ¥é“ `WebBridge` æ˜¯ä»€ä¹ˆ
- ä¸çŸ¥é“å¦‚ä½•å°† C# å¯¹è±¡è½¬æ¢ä¸º Lua å¯¹è±¡
- éœ€è¦æ˜¾å¼å‘Šè¯‰ MoonSharpï¼š"è¿™æ˜¯ä¸€ä¸ªåˆæ³•çš„ç±»å‹ï¼Œè¯·è¯†åˆ«å®ƒ"

---

## âœ… è§£å†³æ–¹æ¡ˆæ€»ç»“

### æ–¹æ¡ˆ 1: æ·»åŠ  `[MoonSharpUserData]` å±æ€§

```csharp
[MoonSharpUserData]  // â¬…ï¸ å£°æ˜"æˆ‘å¯ä»¥åœ¨ Lua ä¸­ä½¿ç”¨"
public class WebBridge
{
    // ...
}
```

**ä½œç”¨**ï¼šå‘Šè¯‰ MoonSharp è¿™ä¸ªç±»å‹çš„å…ƒæ•°æ®ï¼ˆæ–¹æ³•ã€å±æ€§ç­‰ï¼‰

---

### æ–¹æ¡ˆ 2: æ˜¾å¼æ³¨å†Œç±»å‹ï¼ˆå¿…é¡»ï¼ï¼‰

```csharp
public MoonSharpScriptEngine()
{
    _script = new Script();
    
    // â¬…ï¸ å®é™…æ³¨å†Œç±»å‹åˆ° MoonSharp
    UserData.RegisterType<WebBridge>();
}
```

**ä½œç”¨**ï¼šå°†ç±»å‹æ³¨å†Œåˆ° MoonSharp çš„å…¨å±€ç±»å‹ç³»ç»Ÿ

---

## ğŸ“ ç»éªŒæ•™è®­

### 1. æ”¹åŠ¨çš„è¿é”ååº”

```
æ”¹åŠ¨ A: ä½¿ç”¨åŠ¨æ€å¼•ç”¨ï¼ˆFuncï¼‰
    â†“
å¯¼è‡´: WebBridge æ„é€ å‡½æ•°æ”¹å˜
    â†“
å¯¼è‡´: WebBridge æ€»æ˜¯è¢«åˆ›å»ºï¼ˆä¸å† null è·³è¿‡ï¼‰
    â†“
å¯¼è‡´: è‡ªå®šä¹‰ç±»å‹è¢«ä¼ é€’ç»™ MoonSharp
    â†“
å¯¼è‡´: ç±»å‹è½¬æ¢é”™è¯¯ï¼ˆéœ€è¦æ˜¾å¼æ³¨å†Œï¼‰
```

**æ•™è®­**ï¼š
> æ¶æ„æ”¹åŠ¨å¯èƒ½å¼•å…¥æ–°çš„ä¾èµ–å’Œè¦æ±‚ã€‚è‡ªå®šä¹‰ç±»å‹éœ€è¦æ˜¾å¼æ³¨å†Œã€‚

---

### 2. ä¸ºä»€ä¹ˆä¹‹å‰"å¯èƒ½"å·¥ä½œ

å¯èƒ½çš„åŸå› ï¼š
1. **ä¹‹å‰ _webView æ˜¯ null**ï¼Œè·³è¿‡äº† WebBridge åˆ›å»ºï¼ˆä½† web å¯¹è±¡ä¸å¯ç”¨ï¼‰
2. **ä¹‹å‰æ²¡æœ‰çœŸæ­£æµ‹è¯•** web å¯¹è±¡çš„ä½¿ç”¨
3. **ä¹‹å‰çš„åˆå§‹åŒ–é¡ºåºé—®é¢˜**å¯¼è‡´ web å¯¹è±¡æ ¹æœ¬æ²¡æœ‰è¢«æ³¨å†Œ

**å®é™…ä¸Š**ï¼š
- ä¹‹å‰å¯èƒ½**ä»æ¥æ²¡æœ‰çœŸæ­£æˆåŠŸæ³¨å†Œè¿‡** `web` å¯¹è±¡
- æˆ–è€…ä¹‹å‰çš„æµ‹è¯•æ²¡æœ‰è§¦å‘è¿™ä¸ªé—®é¢˜

---

### 3. åŠ¨æ€å¼•ç”¨çš„ä»£ä»·

**å¥½å¤„**ï¼š
- âœ… WebView2 é‡æ–°åˆ›å»ºåè‡ªåŠ¨å…³è”
- âœ… æ›´çµæ´»

**ä»£ä»·**ï¼š
- âš ï¸ éœ€è¦æ˜¾å¼æ³¨å†Œè‡ªå®šä¹‰ç±»å‹
- âš ï¸ éœ€è¦ç†è§£ MoonSharp çš„ç±»å‹ç³»ç»Ÿ

---

## ğŸ”§ å®Œæ•´ä¿®å¤æ–¹æ¡ˆ

### 1. WebBridge.cs

```csharp
using MoonSharp.Interpreter;

[MoonSharpUserData]  // âœ… æ·»åŠ å±æ€§
public class WebBridge
{
    private readonly Func<WebView2?> _webViewProvider;
    // ...
}
```

---

### 2. MoonSharpScriptEngine.cs

```csharp
public MoonSharpScriptEngine()
{
    _script = new Script();
    
    // âœ… æ˜¾å¼æ³¨å†Œç±»å‹
    UserData.RegisterType<WebBridge>();
}
```

---

## ğŸ“ æ€»ç»“

### ä¸ºä»€ä¹ˆä¹‹å‰å¯ä»¥ï¼Ÿ

1. **å¯èƒ½ä»æ¥æ²¡æœ‰çœŸæ­£å·¥ä½œè¿‡**ï¼ˆ_webView æ˜¯ nullï¼Œè·³è¿‡äº†æ³¨å†Œï¼‰
2. **æˆ–è€…** WebView2 ä½œä¸ºæ¡†æ¶ç±»å‹è¢« MoonSharp è‡ªåŠ¨è¯†åˆ«
3. **æˆ–è€…** ä¹‹å‰æ²¡æœ‰çœŸæ­£æµ‹è¯• web å¯¹è±¡çš„ä½¿ç”¨

### ä¸ºä»€ä¹ˆç°åœ¨ä¸è¡Œï¼Ÿ

1. æ”¹ä¸º**åŠ¨æ€å¼•ç”¨**ï¼ˆFuncï¼‰
2. å¯¼è‡´ **WebBridge æ€»æ˜¯è¢«åˆ›å»º**
3. **WebBridge æ˜¯è‡ªå®šä¹‰ç±»å‹**
4. MoonSharp **ä¸è®¤è¯†**è‡ªå®šä¹‰ç±»å‹
5. éœ€è¦**æ˜¾å¼æ³¨å†Œ**

### è§£å†³æ–¹æ¡ˆ

1. âœ… æ·»åŠ  `[MoonSharpUserData]` å±æ€§
2. âœ… æ˜¾å¼è°ƒç”¨ `UserData.RegisterType<WebBridge>()`

### æ•™è®­

> **æ¶æ„æ”¹åŠ¨è¦è€ƒè™‘è¿é”ååº”ã€‚è‡ªå®šä¹‰ç±»å‹åœ¨ MoonSharp ä¸­éœ€è¦æ˜¾å¼æ³¨å†Œã€‚**

---

**åˆ†æå®Œæˆæ—¶é—´**: 2026-01-22  
**çŠ¶æ€**: âœ… æ ¹æœ¬åŸå› å·²æ‰¾åˆ°  
**è§£å†³çŠ¶æ€**: âœ… å·²ä¿®å¤

---

**Â© 2026 Unit.la æ”¹åŠ¨åˆ†ææŠ¥å‘Š**
