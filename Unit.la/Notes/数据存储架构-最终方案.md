# 数据存储架构 - 最终方案

## 📋 架构原则

**除了本地脚本文件，其他所有数据都保存在数据库中。**

---

## 🗂️ 数据存储分类

### 1. **数据库存储**（SQLite）

**存储内容**：
- 任务配置（Name, Url, Username, Password, AutoLogin）
- 脚本目录路径（ScriptDirectory）
- 任务状态（Status, IsRunning）
- 时间戳（CreatedTime, LastRunTime）

**存储位置**：
- `C:\Users\Administrator\AppData\Local\永利系统\Data\app.db`
- 表名：`script_tasks`

**服务**：
- `DataCollectionService`：负责数据库操作

---

### 2. **本地文件存储**

**存储内容**：
- 脚本文件（`main.lua`, `functions.lua` 等）
- 脚本目录：`Scripts\Task_{taskId}\`

**存储位置**：
- 程序目录下的 `Scripts` 文件夹
- 每个任务一个独立目录

**服务**：
- `LocalScriptLoader`：负责本地脚本文件加载

---

### 3. **远程同步**（未来功能）

**用途**：
- 账号登录后，从远端服务器同步配置
- 支持多设备数据同步

**实现方式**：
- 通过 HTTP API 传输 JSON（仅用于传输，不保存到本地文件）
- 远程加载后，自动保存到数据库
- 远程保存时，从数据库读取，转换为 JSON 发送

---

## 🔄 数据流

### 启动时

```
数据库 (ScriptTask)
  → ScriptTaskAdapter.ToScriptTaskConfig()
  → BrowserTaskControl (ScriptTaskConfig)
  → 配置显示在 UI
  → 脚本从 ScriptDirectory 文件夹加载
```

### 编辑时

```
用户修改配置
  → 数据绑定自动更新 _config 对象
  → 属性变更触发 PropertyChanged
  → SetupAutoSave() 防抖（1秒后）
  → ConfigChanged 事件触发
  → DataCollectionPage 订阅事件
  → task.UpdateFromConfig(config)
  → DataCollectionService.SaveScriptTask(task)
  → 保存到数据库
```

### 远程同步时（未来）

```
从远程加载：
  远程服务器 → HTTP GET → JSON → ScriptTaskConfig
  → 更新 _config 对象
  → ConfigChanged 事件触发
  → 保存到数据库

保存到远程：
  数据库 → ScriptTask → ScriptTaskConfig
  → 转换为 JSON（内存中）
  → HTTP POST → 远程服务器
```

---

## ✅ 已完成的修改

### 1. 移除 JSON 文件自动保存

- ❌ 移除 `SaveConfig()` 方法
- ❌ 移除 `LoadConfig()` 方法
- ❌ 移除 `BrowserTaskControl_Load` 事件处理
- ✅ 配置数据只保存在数据库中

### 2. 实现数据库自动保存

- ✅ `DataCollectionPage` 订阅 `ConfigChanged` 事件
- ✅ 配置变更时自动保存到数据库
- ✅ 支持防抖自动保存（1秒无修改后保存）

### 3. 保留远程同步接口

- ✅ 保留 `LoadConfigFromRemoteAsync()` 方法
- ✅ 保留 `SaveConfigToRemoteAsync()` 方法
- ✅ 远程加载后自动触发 `ConfigChanged` 事件，保存到数据库
- ✅ 远程保存时从数据库读取配置

---

## 📝 代码位置

### BrowserTaskControl.cs

- `SetupAutoSave()`：监听配置属性变更，触发 `ConfigChanged` 事件
- `OnSaveConfig()`：手动保存按钮，触发 `ConfigChanged` 事件
- `BrowserTaskControl_FormClosing()`：窗口关闭时触发 `ConfigChanged` 事件
- `LoadConfigFromRemoteAsync()`：从远程加载配置，触发 `ConfigChanged` 事件
- `SaveConfigToRemoteAsync()`：保存配置到远程

### DataCollectionPage.cs

- `InitializeBrowserTaskControl()`：订阅 `ConfigChanged` 事件，保存到数据库

---

## 🎯 优势

1. **单一数据源**：数据库是唯一持久化存储，避免数据不一致
2. **简化架构**：移除 JSON 文件，减少维护成本
3. **自动同步**：配置变更自动保存到数据库
4. **支持远程同步**：保留接口，未来可扩展
5. **脚本文件独立**：脚本文件保存在本地文件夹，便于版本管理

---

## 🔮 未来扩展

### 账号登录功能

```
用户登录
  → 获取用户 Token
  → 从远程服务器加载所有配置
  → 批量保存到本地数据库
  → 配置自动同步
```

### 多设备同步

```
设备A修改配置
  → 保存到本地数据库
  → 同步到远程服务器

设备B启动
  → 从远程服务器拉取最新配置
  → 更新本地数据库
```

---

## 📊 总结

| 数据类型 | 存储方式 | 位置 |
|---------|---------|------|
| 任务配置 | 数据库 | `app.db` |
| 脚本文件 | 本地文件 | `Scripts\Task_{id}\` |
| 远程同步 | HTTP + JSON（传输） | 不保存本地文件 |

**原则**：除了脚本文件，其他所有数据都在数据库中。
