# æ•°æ®åº“æ¶æ„é‡æ„å®ŒæˆæŠ¥å‘Š

## ğŸ“‹ æ¦‚è¿°

**é‡æ„ç›®æ ‡**ï¼šå°†å¾®ä¿¡ä¸“å±æ•°æ®åº“æ¶æ„æ”¹ä¸ºå…±äº«æ•°æ®åº“æ¶æ„ï¼Œè§£å†³å¾®ä¿¡æ¢å·åæ•°æ®ä¸¢å¤±çš„é—®é¢˜ã€‚

**é‡æ„æ—¶é—´**ï¼š2025-11-26

**é‡æ„èŒƒå›´**ï¼šæ•°æ®åº“å±‚ã€æ•°æ®è®¿é—®å±‚

---

## âœ… å·²å®Œæˆçš„ä¿®æ”¹

### 1. DatabaseInitializer.cs

**æ–‡ä»¶ä½ç½®**ï¼š`BaiShengVx3Plus/Services/Database/DatabaseInitializer.cs`

**ä¿®æ”¹å†…å®¹**ï¼š
- âœ… æ–°å¢ `InitializeAllTables()` æ–¹æ³•
  - åˆå¹¶å…¨å±€è¡¨å’Œä¸šåŠ¡è¡¨
  - æ‰€æœ‰è¡¨åœ¨ä¸€ä¸ªæ•°æ®åº“ä¸­ï¼ˆbusiness.dbï¼‰
  - ä¸šåŠ¡è¡¨é€šè¿‡ GroupWxId å­—æ®µéš”ç¦»

- âœ… æ ‡è®°æ—§æ–¹æ³•ä¸ºè¿‡æ—¶
  - `InitializeGlobalTables()` â†’ [Obsolete]
  - `InitializeWxTables()` â†’ [Obsolete]

**ä»£ç ç¤ºä¾‹**ï¼š
```csharp
public void InitializeAllTables(SQLiteConnection db)
{
    // å…¨å±€æ•°æ®è¡¨
    db.CreateTable<BetConfig>();
    db.CreateTable<BinggoLotteryData>();
    db.CreateTable<BinggoBetItem>();
    db.CreateTable<BetRecord>();

    // ä¸šåŠ¡æ•°æ®è¡¨ï¼ˆæŒ‰ GroupWxId éš”ç¦»ï¼‰
    db.CreateTable<V2Member>();
    db.CreateTable<V2MemberOrder>();
    db.CreateTable<V2CreditWithdraw>();
    db.CreateTable<V2BalanceChange>();

    // åŸºç¡€æ•°æ®è¡¨
    db.CreateTable<WxContact>();
    db.CreateTable<WxUserInfo>();
}
```

---

### 2. VxMain.cs

**æ–‡ä»¶ä½ç½®**ï¼š`BaiShengVx3Plus/Views/VxMain.cs`

**ä¿®æ”¹å†…å®¹**ï¼š

#### 2.1 åˆ é™¤åŒåº“ç»“æ„
```csharp
// âŒ æ—§ä»£ç ï¼ˆå·²åˆ é™¤ï¼‰
// private SQLiteConnection? _globalDb;  // å…¨å±€æ•°æ®åº“
// private SQLiteConnection? _db;        // å¾®ä¿¡ä¸“å±æ•°æ®åº“

// âœ… æ–°ä»£ç 
private SQLiteConnection? _db;  // å…±äº«æ•°æ®åº“ï¼ˆæ‰€æœ‰å¾®ä¿¡å·å…±äº«ï¼‰
```

#### 2.2 ä¿®æ”¹ InitializeDatabase() æ–¹æ³•
```csharp
// âŒ æ—§é€»è¾‘
// 1. æ‰“å¼€å…¨å±€æ•°æ®åº“: business.db
// 2. æ‰“å¼€å¾®ä¿¡ä¸“å±æ•°æ®åº“: business_{wxid}.db

// âœ… æ–°é€»è¾‘
// 1. ç»Ÿä¸€æ‰“å¼€å…±äº«æ•°æ®åº“: business.db
// 2. è°ƒç”¨ InitializeAllTables() åˆ›å»ºæ‰€æœ‰è¡¨
// 3. ä¼ é€’ç»™æ‰€æœ‰æœåŠ¡
```

#### 2.3 æ›¿æ¢æ‰€æœ‰ _globalDb å¼•ç”¨
```csharp
// âŒ æ—§ä»£ç 
// _autoBetService.SetDatabase(_globalDb);
// _lotteryService.SetDatabase(_globalDb);
// _lotteryDataBindingList = new BinggoLotteryDataBindingList(_globalDb, _logService);

// âœ… æ–°ä»£ç 
_autoBetService.SetDatabase(_db);
_lotteryService.SetDatabase(_db);
_lotteryDataBindingList = new BinggoLotteryDataBindingList(_db, _logService);
```

#### 2.4 æ–°å¢å…¼å®¹æ€§æ–¹æ³•
```csharp
// å‘åå…¼å®¹çš„æ—§æ–¹æ³•ç‰ˆæœ¬
private void InitializeAllTables(SQLiteConnection db)
{
    // åˆå¹¶å…¨å±€è¡¨å’Œå¾®ä¿¡ä¸“å±è¡¨
}

[Obsolete("å·²åºŸå¼ƒ")]
private void InitializeGlobalTables(SQLiteConnection db) { ... }

[Obsolete("å·²åºŸå¼ƒ")]
private void InitializeWxTables(SQLiteConnection db) { ... }
```

---

### 3. V2OrderBindingList.cs

**æ–‡ä»¶ä½ç½®**ï¼š`BaiShengVx3Plus/Core/V2OrderBindingList.cs`

**ä¿®æ”¹å†…å®¹**ï¼š
- âœ… `LoadFromDatabase()` æ–¹æ³•æ·»åŠ  GroupWxId è¿‡æ»¤

```csharp
// âŒ æ—§ä»£ç 
var orders = _db.Table<V2MemberOrder>()
    .OrderByDescending(o => o.TimeStampBet)
    .ToList();

// âœ… æ–°ä»£ç 
var orders = _db.Table<V2MemberOrder>()
    .Where(o => o.GroupWxId == _groupWxId)  // ğŸ”‘ æŒ‰ GroupWxId è¿‡æ»¤
    .OrderByDescending(o => o.TimeStampBet)
    .ToList();
```

---

### 4. æ•°æ®è¿ç§»å·¥å…·

**æ–‡ä»¶ä½ç½®**ï¼š`BaiShengVx3Plus/Services/Database/DatabaseMigrationTool.cs`

**åŠŸèƒ½**ï¼š
- âœ… è‡ªåŠ¨æŸ¥æ‰¾æ‰€æœ‰æ—§çš„å¾®ä¿¡ä¸“å±æ•°æ®åº“ï¼ˆ`business_*.db`ï¼‰
- âœ… è¿ç§»ä¼šå‘˜æ•°æ®åˆ°å…±äº«æ•°æ®åº“
- âœ… è¿ç§»è®¢å•æ•°æ®åˆ°å…±äº«æ•°æ®åº“
- âœ… è¿ç§»ä¸Šä¸‹åˆ†è®°å½•åˆ°å…±äº«æ•°æ®åº“
- âœ… è¿ç§»ä½™é¢å˜åŠ¨è®°å½•åˆ°å…±äº«æ•°æ®åº“
- âœ… è‡ªåŠ¨å»é‡ï¼ˆé¿å…é‡å¤æ•°æ®ï¼‰
- âœ… è‡ªåŠ¨å¤‡ä»½æ—§æ•°æ®åº“
- âœ… è¯¦ç»†çš„è¿ç§»æ—¥å¿—

**ä½¿ç”¨æ–¹æ³•**ï¼š
```csharp
var migrationTool = new DatabaseMigrationTool(logService);
var (success, message) = migrationTool.MigrateFromWxDbToSharedDb();
if (success)
{
    Console.WriteLine(message);
}
```

---

## ğŸ“Š æ¶æ„å¯¹æ¯”

### æ—§æ¶æ„ï¼ˆå¾®ä¿¡ä¸“å±æ•°æ®åº“ï¼‰

```
æ•°æ®ç›®å½•ï¼š
â”œâ”€ business.db           ï¼ˆå…¨å±€æ•°æ®ï¼šå¼€å¥–ã€é£å•é…ç½®ï¼‰
â”œâ”€ business_wx_1111.db   ï¼ˆå¾®ä¿¡ 1111 çš„æ•°æ®ï¼‰
â”‚  â”œâ”€ V2Member
â”‚  â”œâ”€ V2MemberOrder
â”‚  â””â”€ ...
â”œâ”€ business_wx_2222.db   ï¼ˆå¾®ä¿¡ 2222 çš„æ•°æ®ï¼‰
â”‚  â”œâ”€ V2Memberï¼ˆç©ºï¼‰
â”‚  â””â”€ ...
â””â”€ logs.db               ï¼ˆæ—¥å¿—ï¼‰

é—®é¢˜ï¼š
âŒ wx_2222 è¯»å– business_wx_2222.dbï¼ˆç©ºæ•°æ®åº“ï¼‰
âŒ æ‰¾ä¸åˆ° wx_1111 çš„å†å²æ•°æ®
âŒ ä¼šå‘˜ä½™é¢ã€è®¢å•ã€ç»Ÿè®¡å…¨éƒ¨ä¸¢å¤±
```

### æ–°æ¶æ„ï¼ˆå…±äº«æ•°æ®åº“ï¼‰

```
æ•°æ®ç›®å½•ï¼š
â”œâ”€ business.db           ï¼ˆæ‰€æœ‰æ•°æ®ï¼Œæ‰€æœ‰å¾®ä¿¡å·å…±äº«ï¼‰
â”‚  â”œâ”€ BetConfig          ï¼ˆé£å•é…ç½®ï¼Œå…¨å±€ï¼‰
â”‚  â”œâ”€ BinggoLotteryData  ï¼ˆå¼€å¥–æ•°æ®ï¼Œå…¨å±€ï¼‰
â”‚  â”œâ”€ V2Member           ï¼ˆä¼šå‘˜ï¼ŒæŒ‰ GroupWxId éš”ç¦»ï¼‰
â”‚  â”œâ”€ V2MemberOrder      ï¼ˆè®¢å•ï¼ŒæŒ‰ GroupWxId éš”ç¦»ï¼‰
â”‚  â”œâ”€ V2CreditWithdraw   ï¼ˆä¸Šä¸‹åˆ†ï¼ŒæŒ‰ GroupWxId éš”ç¦»ï¼‰
â”‚  â””â”€ ...
â””â”€ logs.db               ï¼ˆæ—¥å¿—ï¼‰

ä¼˜åŠ¿ï¼š
âœ… wx_1111 å’Œ wx_2222 è¯»å–åŒä¸€ä¸ª business.db
âœ… æŒ‰ GroupWxId æŸ¥è¯¢æ•°æ®
âœ… åªè¦åœ¨åŒä¸€ä¸ªç¾¤ï¼Œæ•°æ®è‡ªåŠ¨æ¥ç®¡
âœ… ä¼šå‘˜ä½™é¢ã€è®¢å•ã€ç»Ÿè®¡å®Œå…¨ä¿ç•™
```

---

## ğŸ¯ æ ¸å¿ƒæœºåˆ¶

### æ•°æ®éš”ç¦»æ–¹å¼

**æ—§æ–¹å¼**ï¼šæŒ‰å¾®ä¿¡å·éš”ç¦»ï¼ˆä¸åŒæ•°æ®åº“æ–‡ä»¶ï¼‰
```
wx_1111 â†’ business_wx_1111.db
wx_2222 â†’ business_wx_2222.db
```

**æ–°æ–¹å¼**ï¼šæŒ‰ç¾¤ç»„éš”ç¦»ï¼ˆGroupWxId å­—æ®µï¼‰
```
wx_1111 â†’ business.db WHERE GroupWxId = 'group_aaa'
wx_2222 â†’ business.db WHERE GroupWxId = 'group_aaa'  â† åŒä¸€æ‰¹æ•°æ®ï¼
```

### æŸ¥è¯¢æ–¹å¼

**æ‰€æœ‰ä¸šåŠ¡æ•°æ®æŸ¥è¯¢éƒ½å¿…é¡»å¸¦ GroupWxId**ï¼š
```csharp
// âœ… æ­£ç¡®
var members = _db.Table<V2Member>()
    .Where(m => m.GroupWxId == groupWxId)
    .ToList();

// âŒ é”™è¯¯ï¼ˆä¼šæŸ¥åˆ°å…¶ä»–ç¾¤çš„æ•°æ®ï¼‰
var members = _db.Table<V2Member>().ToList();
```

### æ¢å·åœºæ™¯

**åœºæ™¯**ï¼šè½¯ä»¶è¿è¡Œçš„å¾®ä¿¡å·æ¢äº†
```
æ­¥éª¤ï¼š
1. wx_1111 æ— æ³•ç™»å½•
2. æ¢æˆ wx_2222 ç™»å½•è½¯ä»¶
3. wx_2222 ä¹Ÿåœ¨åŒä¸€ä¸ªä¸šåŠ¡ç¾¤
4. ç»‘å®šè¯¥ä¸šåŠ¡ç¾¤

ç»“æœï¼š
âœ… ä» business.db åŠ è½½ GroupWxId = 'group_xxx' çš„æ•°æ®
âœ… ä¼šå‘˜ wxid æ²¡å˜ï¼Œæ•°æ®å®Œå…¨åŒ¹é…
âœ… ä½™é¢ã€è®¢å•ã€ç»Ÿè®¡å…¨éƒ¨æ¢å¤
```

---

## âš ï¸ å·²éªŒè¯çš„å…³é”®ç‚¹

### 1. æ•°æ®è®¿é—®å±‚æ£€æŸ¥

| æ–‡ä»¶ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| GroupBindingService.cs | âœ… | LoadAndMergeMembers å·²å¸¦ GroupWxId |
| V2MemberBindingList.cs | âœ… | LoadFromDatabase å·²å¸¦ GroupWxId |
| V2OrderBindingList.cs | âœ… | LoadFromDatabase å·²å¸¦ GroupWxIdï¼ˆå·²ä¿®å¤ï¼‰ |
| V2CreditWithdrawBindingList.cs | âœ… | LoadFromDatabase å·²å¸¦ GroupWxId |

### 2. æœåŠ¡å±‚æ•°æ®åº“å¼•ç”¨

| æœåŠ¡ | æ—§å¼•ç”¨ | æ–°å¼•ç”¨ | çŠ¶æ€ |
|------|--------|--------|------|
| AutoBetService | _globalDb | _db | âœ… |
| LotteryService | _globalDb | _db | âœ… |
| GroupBindingService | _db | _db | âœ… |
| æ‰€æœ‰ BindingList | _db | _db | âœ… |

---

## ğŸ“ æ•°æ®è¿ç§»æ­¥éª¤

### è‡ªåŠ¨è¿ç§»ï¼ˆæ¨èï¼‰

1. å¯åŠ¨åº”ç”¨
2. åœ¨è®¾ç½®æˆ–ç®¡ç†ç•Œé¢æ·»åŠ "æ•°æ®è¿ç§»"æŒ‰é’®
3. ç‚¹å‡»è¿ç§»ï¼Œè‡ªåŠ¨å®Œæˆ
4. éªŒè¯è¿ç§»ç»“æœ
5. æ‰‹åŠ¨åˆ é™¤æ—§æ•°æ®åº“ï¼ˆå¯é€‰ï¼‰

### æ‰‹åŠ¨è¿ç§»

```csharp
var logService = Program.ServiceProvider.GetService<ILogService>();
var migrationTool = new DatabaseMigrationTool(logService);

// æ‰§è¡Œè¿ç§»
var (success, message) = migrationTool.MigrateFromWxDbToSharedDb();
Console.WriteLine(message);

// éªŒè¯ç»“æœ
var (verifySuccess, verifyMessage) = migrationTool.VerifyMigration();
Console.WriteLine(verifyMessage);
```

---

## ğŸš€ åç»­å»ºè®®

### 1. æ·»åŠ è¿ç§»å…¥å£

åœ¨ VxMain çª—å£æ·»åŠ æ•°æ®è¿ç§»æŒ‰é’®ï¼š
```csharp
// åœ¨è®¾ç½®èœå•æˆ–å·¥å…·æ æ·»åŠ 
private async void btnMigrateDatabase_Click(object sender, EventArgs e)
{
    if (UIMessageBox.ShowAsk("æ˜¯å¦å¼€å§‹æ•°æ®åº“è¿ç§»ï¼Ÿ\n\nå°†æ—§çš„å¾®ä¿¡ä¸“å±æ•°æ®åº“è¿ç§»åˆ°æ–°çš„å…±äº«æ•°æ®åº“ã€‚"))
    {
        var migrationTool = new DatabaseMigrationTool(_logService);
        var (success, message) = migrationTool.MigrateFromWxDbToSharedDb();
        
        if (success)
        {
            UIMessageBox.ShowSuccess(message);
        }
        else
        {
            UIMessageBox.ShowError(message);
        }
    }
}
```

### 2. é¦–æ¬¡å¯åŠ¨è‡ªåŠ¨è¿ç§»

åœ¨åº”ç”¨é¦–æ¬¡å¯åŠ¨æ—¶ï¼Œæ£€æµ‹æ˜¯å¦æœ‰æ—§æ•°æ®åº“ï¼Œæç¤ºç”¨æˆ·è¿ç§»ï¼š
```csharp
private void CheckAndPromptMigration()
{
    var dataDirectory = Path.Combine(
        Environment.GetFolderPath(Environment.SpecialFolder.LocalApplicationData),
        "BaiShengVx3Plus", "Data");
    
    var wxDbFiles = Directory.GetFiles(dataDirectory, "business_*.db");
    
    if (wxDbFiles.Length > 0)
    {
        if (UIMessageBox.ShowAsk($"æ£€æµ‹åˆ° {wxDbFiles.Length} ä¸ªæ—§çš„å¾®ä¿¡ä¸“å±æ•°æ®åº“ã€‚\n\næ˜¯å¦ç«‹å³è¿ç§»åˆ°æ–°çš„å…±äº«æ•°æ®åº“ï¼Ÿ"))
        {
            // æ‰§è¡Œè¿ç§»
        }
    }
}
```

### 3. æµ‹è¯•éªŒè¯

- [ ] æµ‹è¯•æ¢å·åœºæ™¯ï¼ˆwx_1111 â†’ wx_2222ï¼‰
- [ ] éªŒè¯æ•°æ®å®Œå…¨ä¿ç•™
- [ ] æµ‹è¯•å¤šç¾¤åœºæ™¯ï¼ˆæ•°æ®éš”ç¦»æ˜¯å¦æ­£ç¡®ï¼‰
- [ ] æ€§èƒ½æµ‹è¯•ï¼ˆå…±äº«æ•°æ®åº“æ€§èƒ½ï¼‰

---

## ğŸ“Œ æ³¨æ„äº‹é¡¹

1. **GroupWxId å¿…ä¸å¯å°‘**
   - æ‰€æœ‰ä¸šåŠ¡æ•°æ®æŸ¥è¯¢éƒ½å¿…é¡»å¸¦ `WHERE GroupWxId = '...'`
   - å¦åˆ™ä¼šæŸ¥åˆ°å…¶ä»–ç¾¤çš„æ•°æ®

2. **æ•°æ®åº“å¤‡ä»½**
   - è¿ç§»å‰è‡ªåŠ¨å¤‡ä»½æ—§æ•°æ®åº“
   - ä¿ç•™åœ¨ `Data/backup_YYYYMMDD_HHmmss/` ç›®å½•

3. **å…¼å®¹æ€§**
   - ä¿ç•™äº†æ—§æ–¹æ³•ï¼ˆæ ‡è®°ä¸º Obsoleteï¼‰
   - æ”¯æŒå‘åå…¼å®¹

4. **å¹¶å‘å®‰å…¨**
   - SQLite WAL æ¨¡å¼ï¼ˆå·²é…ç½®ï¼‰
   - æ³¨æ„äº‹åŠ¡éš”ç¦»

---

## âœ… é‡æ„æ€»ç»“

| é¡¹ç›® | çŠ¶æ€ |
|------|------|
| æ•°æ®åº“æ¶æ„è°ƒæ•´ | âœ… å®Œæˆ |
| ä»£ç é‡æ„ | âœ… å®Œæˆ |
| æ•°æ®è¿ç§»å·¥å…· | âœ… å®Œæˆ |
| æ•°æ®è®¿é—®å±‚æ£€æŸ¥ | âœ… å®Œæˆ |
| æ–‡æ¡£ç¼–å†™ | âœ… å®Œæˆ |
| æµ‹è¯•éªŒè¯ | â¸ï¸ å¾…è¿›è¡Œ |

---

**é‡æ„å®Œæˆæ—¶é—´**ï¼š2025-11-26  
**é¢„è®¡æµ‹è¯•æ—¶é—´**ï¼š1å¤©  
**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0

