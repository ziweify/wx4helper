# æ•°æ®åº“æ¶æ„é‡æ„æ–¹æ¡ˆï¼šä»å¾®ä¿¡ä¸“å±æ•°æ®åº“æ”¹ä¸ºå…±äº«æ•°æ®åº“

## ğŸ“‹ é—®é¢˜æ ¹æº

### å½“å‰æ¶æ„çš„é—®é¢˜

**å¾®ä¿¡ä¸“å±æ•°æ®åº“è®¾è®¡**ï¼š
```csharp
// VxMain.cs ç¬¬280-281è¡Œ
string wxDbPath = Path.Combine(dataDirectory, $"business_{wxid}.db");
_db = new SQLiteConnection(wxDbPath);
```

**å¯¼è‡´çš„é—®é¢˜**ï¼š
```
wx_1111 ç™»å½• â†’ ä½¿ç”¨ business_wx_1111.db
  - ç¾¤Açš„ä¼šå‘˜æ•°æ®
  - ç¾¤Açš„è®¢å•æ•°æ®
  - ç¾¤Açš„ç»Ÿè®¡æ•°æ®

wx_2222 ç™»å½• â†’ ä½¿ç”¨ business_wx_2222.dbï¼ˆç©ºçš„ï¼ï¼‰
  - âŒ æ‰¾ä¸åˆ°ç¾¤Açš„å†å²æ•°æ®
  - âŒ ä¼šå‘˜ä½™é¢ä¸¢å¤±
  - âŒ è®¢å•è®°å½•ä¸¢å¤±
  - âŒ ç»Ÿè®¡æ•°æ®å½’é›¶
```

### F5BotV2 çš„æ­£ç¡®è®¾è®¡

**å…±äº«æ•°æ®åº“è®¾è®¡**ï¼š
```csharp
// F5BotV2/Model/V2MemberBindlite.cs ç¬¬42è¡Œ
private BaseBindlite _sql = new BaseBindlite("v2.bat");

// æ‰€æœ‰å¾®ä¿¡å·å…±ç”¨åŒä¸€ä¸ªæ•°æ®åº“
string fullPath = $"{Environment.CurrentDirectory}\\v2.bat";
```

**æ•°æ®éš”ç¦»æœºåˆ¶**ï¼š
- âœ… é€šè¿‡ `GroupWxId` å­—æ®µåŒºåˆ†ä¸åŒç¾¤ç»„
- âœ… wx_1111 å’Œ wx_2222 è¯»å–åŒä¸€ä¸ªæ•°æ®åº“
- âœ… åªè¦åœ¨åŒä¸€ä¸ªç¾¤ï¼Œæ•°æ®è‡ªåŠ¨æ¥ç®¡

```
æ•°æ®åº“: v2.bat
+-----------+-----------+--------+
| GroupWxId | Wxid      | ä½™é¢   |
+-----------+-----------+--------+
| group_aaa | member_1  | 100    |  â† ç¾¤Açš„æ•°æ®
| group_aaa | member_2  | 200    |
| group_bbb | member_3  | 300    |  â† ç¾¤Bçš„æ•°æ®
+-----------+-----------+--------+

wx_1111 æŸ¥è¯¢: WHERE GroupWxId = 'group_aaa' âœ…
wx_2222 æŸ¥è¯¢: WHERE GroupWxId = 'group_aaa' âœ… (åŒä¸€æ‰¹æ•°æ®)
```

---

## ğŸ¯ é‡æ„æ–¹æ¡ˆ

### æ–¹æ¡ˆï¼šç»Ÿä¸€ä½¿ç”¨ business.dbï¼ˆæ¨èï¼‰

**ç›®æ ‡æ¶æ„**ï¼š
```
æ‰€æœ‰å¾®ä¿¡å·å…±äº«ä¸€ä¸ªæ•°æ®åº“
â””â”€ business.db
   â”œâ”€ V2Member          (GroupWxId, Wxid, Balance, ...)
   â”œâ”€ V2MemberOrder     (GroupWxId, Wxid, ...)
   â”œâ”€ V2CreditWithdraw  (GroupWxId, Wxid, ...)
   â”œâ”€ V2BalanceChange   (GroupWxId, Wxid, ...)
   â”œâ”€ BinggoLotteryData (å…¨å±€æ•°æ®)
   â”œâ”€ AutoBetConfigs    (å…¨å±€æ•°æ®)
   â””â”€ ...
```

**æ•°æ®éš”ç¦»**ï¼š
- é€šè¿‡ `GroupWxId` å­—æ®µåŒºåˆ†ä¸åŒç¾¤ç»„
- æŸ¥è¯¢æ—¶å§‹ç»ˆå¸¦ä¸Š `WHERE GroupWxId = '...'`
- ä¸åŒå¾®ä¿¡å·å¯ä»¥è®¿é—®åŒä¸€ä¸ªç¾¤çš„æ•°æ®

---

## ğŸ“ å…·ä½“ä¿®æ”¹æ­¥éª¤

### Step 1: ä¿®æ”¹æ•°æ®åº“åˆå§‹åŒ–é€»è¾‘

**ä¿®æ”¹ VxMain.cs çš„ InitializeDatabase æ–¹æ³•**ï¼š

```csharp
/// <summary>
/// åˆå§‹åŒ–æ•°æ®åº“ï¼ˆæ”¹ä¸ºå…±äº«æ•°æ®åº“ï¼‰
/// 
/// ğŸ”¥ æ–°æ¶æ„ï¼š
/// 1. åªä½¿ç”¨ä¸€ä¸ªæ•°æ®åº“: business.db
/// 2. æ‰€æœ‰å¾®ä¿¡å·å…±äº«
/// 3. é€šè¿‡ GroupWxId åŒºåˆ†æ•°æ®
/// </summary>
private void InitializeDatabase(string wxid)
{
    try
    {
        var dataDirectory = Path.Combine(
            Environment.GetFolderPath(Environment.SpecialFolder.LocalApplicationData),
            "BaiShengVx3Plus",
            "Data");
        Directory.CreateDirectory(dataDirectory);
        
        // ğŸ”¥ ç»Ÿä¸€ä½¿ç”¨ business.dbï¼ˆæ‰€æœ‰æ•°æ®ï¼‰
        string dbPath = Path.Combine(dataDirectory, "business.db");
        
        if (_db == null || _db.DatabasePath != dbPath)
        {
            _db?.Close();
            _db = new SQLiteConnection(dbPath);
            _logService.Info("VxMain", $"âœ… æ•°æ®åº“å·²æ‰“å¼€: {dbPath}");
            
            // ğŸ”¥ é…ç½®ä¸ºæœ€å¯é æ¨¡å¼
            ConfigureDatabaseReliability(_db, "å…±äº«æ•°æ®åº“");
            
            // ğŸ”¥ åˆå§‹åŒ–æ‰€æœ‰è¡¨ï¼ˆå…¨å±€è¡¨ + ä¸šåŠ¡è¡¨ï¼‰
            var databaseInitializer = Program.ServiceProvider?.GetService<Services.Database.DatabaseInitializer>();
            if (databaseInitializer != null)
            {
                // åˆå§‹åŒ–æ‰€æœ‰è¡¨ï¼ˆå…¨å±€ + å¾®ä¿¡ä¸“å±è¡¨åˆå¹¶ï¼‰
                databaseInitializer.InitializeAllTables(_db);
            }
        }
        
        // ğŸ”¥ å°†æ•°æ®åº“è¿æ¥ä¼ é€’ç»™æ‰€æœ‰æœåŠ¡
        if (_groupBindingService is Services.GroupBinding.GroupBindingService groupBindingService)
        {
            groupBindingService.SetDatabase(_db);
        }
        
        _logService.Info("VxMain", "âœ… å…±äº«æ•°æ®åº“å·²å‡†å¤‡ï¼Œæ‰€æœ‰å¾®ä¿¡å·å¯è®¿é—®");
    }
    catch (Exception ex)
    {
        _logService.Error("VxMain", $"åˆå§‹åŒ–æ•°æ®åº“å¤±è´¥: {ex.Message}", ex);
        throw;
    }
}
```

### Step 2: ä¿®æ”¹ DatabaseInitializer

**æ–°å¢ InitializeAllTables æ–¹æ³•**ï¼š

```csharp
namespace BaiShengVx3Plus.Services.Database
{
    public class DatabaseInitializer
    {
        /// <summary>
        /// ğŸ”¥ åˆå§‹åŒ–æ‰€æœ‰è¡¨ï¼ˆå…±äº«æ•°æ®åº“æ¨¡å¼ï¼‰
        /// </summary>
        public void InitializeAllTables(SQLiteConnection db)
        {
            try
            {
                Log("info", "ğŸ—„ï¸ åˆå§‹åŒ–å…±äº«æ•°æ®åº“è¡¨...");

                // ========================================
                // ğŸ”¥ å…¨å±€æ•°æ®è¡¨
                // ========================================
                db.CreateTable<AutoBetConfig>();
                Log("debug", "âœ“ å…¨å±€è¡¨: AutoBetConfig");

                db.CreateTable<BinggoLotteryData>();
                Log("debug", "âœ“ å…¨å±€è¡¨: BinggoLotteryData");

                db.CreateTable<BinggoBetItem>();
                Log("debug", "âœ“ å…¨å±€è¡¨: BinggoBetItem");

                // ========================================
                // ğŸ”¥ ä¸šåŠ¡æ•°æ®è¡¨ï¼ˆé€šè¿‡ GroupWxId éš”ç¦»ï¼‰
                // ========================================
                db.CreateTable<V2Member>();
                Log("debug", "âœ“ ä¸šåŠ¡è¡¨: V2Member (æŒ‰ GroupWxId éš”ç¦»)");

                db.CreateTable<V2MemberOrder>();
                Log("debug", "âœ“ ä¸šåŠ¡è¡¨: V2MemberOrder (æŒ‰ GroupWxId éš”ç¦»)");

                db.CreateTable<V2CreditWithdraw>();
                Log("debug", "âœ“ ä¸šåŠ¡è¡¨: V2CreditWithdraw (æŒ‰ GroupWxId éš”ç¦»)");

                db.CreateTable<V2BalanceChange>();
                Log("debug", "âœ“ ä¸šåŠ¡è¡¨: V2BalanceChange (æŒ‰ GroupWxId éš”ç¦»)");

                db.CreateTable<BetRecord>();
                Log("debug", "âœ“ ä¸šåŠ¡è¡¨: BetRecord (æŒ‰ GroupWxId éš”ç¦»)");

                // ========================================
                // ğŸ”¥ åŸºç¡€æ•°æ®è¡¨
                // ========================================
                db.CreateTable<WxContact>();
                Log("debug", "âœ“ åŸºç¡€è¡¨: WxContact");

                db.CreateTable<WxUserInfo>();
                Log("debug", "âœ“ åŸºç¡€è¡¨: WxUserInfo");

                Log("info", "âœ… å…±äº«æ•°æ®åº“è¡¨åˆå§‹åŒ–å®Œæˆ");
            }
            catch (Exception ex)
            {
                Log("error", $"åˆå§‹åŒ–æ•°æ®åº“è¡¨å¤±è´¥: {ex.Message}");
                throw;
            }
        }
    }
}
```

### Step 3: ç¡®ä¿æ‰€æœ‰æŸ¥è¯¢éƒ½å¸¦ GroupWxId

**æ£€æŸ¥æ‰€æœ‰æ•°æ®è®¿é—®ä»£ç **ï¼š

```csharp
// âœ… æ­£ç¡®ï¼šå¸¦ GroupWxId æŸ¥è¯¢
var members = _db.Table<V2Member>()
    .Where(m => m.GroupWxId == groupWxId)
    .ToList();

// âœ… æ­£ç¡®ï¼šå¸¦ GroupWxId æŸ¥è¯¢
var orders = _db.Table<V2MemberOrder>()
    .Where(o => o.GroupWxId == groupWxId && o.IssueId == issueId)
    .ToList();

// âŒ é”™è¯¯ï¼šä¸å¸¦ GroupWxIdï¼ˆä¼šæŸ¥åˆ°å…¶ä»–ç¾¤çš„æ•°æ®ï¼‰
var members = _db.Table<V2Member>().ToList();
```

**éœ€è¦æ£€æŸ¥çš„æ–‡ä»¶**ï¼š
- `GroupBindingService.cs`ï¼šâœ… å·²ç»å¸¦äº† GroupWxId
- `BinggoOrderService.cs`ï¼šæ£€æŸ¥è®¢å•æŸ¥è¯¢
- `CreditWithdrawService.cs`ï¼šæ£€æŸ¥ä¸Šä¸‹åˆ†æŸ¥è¯¢
- `V2MemberBindingList.cs`ï¼šæ£€æŸ¥ä¼šå‘˜æ“ä½œ

### Step 4: åˆ é™¤æ—§çš„å¾®ä¿¡ä¸“å±æ•°æ®åº“ä»£ç 

**åˆ é™¤æˆ–æ³¨é‡Šä»¥ä¸‹ä»£ç **ï¼š

```csharp
// VxMain.cs ä¸­åˆ é™¤
// âŒ åˆ é™¤å¾®ä¿¡ä¸“å±æ•°æ®åº“é€»è¾‘
// string wxDbPath = Path.Combine(dataDirectory, $"business_{wxid}.db");
// _db = new SQLiteConnection(wxDbPath);

// âŒ åˆ é™¤å…¨å±€æ•°æ®åº“å’Œå¾®ä¿¡ä¸“å±æ•°æ®åº“çš„åˆ†ç¦»
// _globalDb = new SQLiteConnection(globalDbPath);
```

### Step 5: æ•°æ®è¿ç§»

**è¿ç§»ç°æœ‰æ•°æ®åˆ°æ–°æ•°æ®åº“**ï¼š

```csharp
/// <summary>
/// æ•°æ®è¿ç§»å·¥å…·ï¼šä»å¾®ä¿¡ä¸“å±æ•°æ®åº“è¿ç§»åˆ°å…±äº«æ•°æ®åº“
/// </summary>
public class DatabaseMigrationTool
{
    public void MigrateFromWxDbToSharedDb()
    {
        var dataDirectory = Path.Combine(
            Environment.GetFolderPath(Environment.SpecialFolder.LocalApplicationData),
            "BaiShengVx3Plus",
            "Data");
        
        // 1. æ‰“å¼€æ–°çš„å…±äº«æ•°æ®åº“
        string sharedDbPath = Path.Combine(dataDirectory, "business.db");
        using var sharedDb = new SQLiteConnection(sharedDbPath);
        
        // åˆå§‹åŒ–è¡¨ç»“æ„
        InitializeAllTables(sharedDb);
        
        // 2. æŸ¥æ‰¾æ‰€æœ‰æ—§çš„å¾®ä¿¡ä¸“å±æ•°æ®åº“
        var wxDbFiles = Directory.GetFiles(dataDirectory, "business_*.db");
        
        foreach (var wxDbFile in wxDbFiles)
        {
            Console.WriteLine($"æ­£åœ¨è¿ç§»: {wxDbFile}");
            
            using var wxDb = new SQLiteConnection(wxDbFile);
            
            // è¿ç§»ä¼šå‘˜æ•°æ®
            var members = wxDb.Table<V2Member>().ToList();
            foreach (var member in members)
            {
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                var existing = sharedDb.Table<V2Member>()
                    .FirstOrDefault(m => m.GroupWxId == member.GroupWxId && m.Wxid == member.Wxid);
                
                if (existing == null)
                {
                    sharedDb.Insert(member);
                }
                else
                {
                    // åˆå¹¶æ•°æ®ï¼ˆä¿ç•™ä½™é¢æ›´å¤§çš„ï¼‰
                    if (member.Balance > existing.Balance)
                    {
                        existing.Balance = member.Balance;
                        sharedDb.Update(existing);
                    }
                }
            }
            
            // è¿ç§»è®¢å•æ•°æ®
            var orders = wxDb.Table<V2MemberOrder>().ToList();
            foreach (var order in orders)
            {
                var existing = sharedDb.Table<V2MemberOrder>()
                    .FirstOrDefault(o => o.Id == order.Id);
                
                if (existing == null)
                {
                    sharedDb.Insert(order);
                }
            }
            
            // è¿ç§»ä¸Šä¸‹åˆ†è®°å½•
            var credits = wxDb.Table<V2CreditWithdraw>().ToList();
            foreach (var credit in credits)
            {
                var existing = sharedDb.Table<V2CreditWithdraw>()
                    .FirstOrDefault(c => c.Id == credit.Id);
                
                if (existing == null)
                {
                    sharedDb.Insert(credit);
                }
            }
            
            // è¿ç§»ä½™é¢å˜åŠ¨è®°å½•
            var balanceChanges = wxDb.Table<V2BalanceChange>().ToList();
            foreach (var change in balanceChanges)
            {
                var existing = sharedDb.Table<V2BalanceChange>()
                    .FirstOrDefault(c => c.Id == change.Id);
                
                if (existing == null)
                {
                    sharedDb.Insert(change);
                }
            }
            
            Console.WriteLine($"âœ… è¿ç§»å®Œæˆ: {wxDbFile}");
        }
        
        Console.WriteLine("âœ… æ‰€æœ‰æ•°æ®è¿ç§»å®Œæˆï¼");
    }
}
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ•°æ®éš”ç¦»

**å¿…é¡»ç¡®ä¿**ï¼š
- æ‰€æœ‰æŸ¥è¯¢éƒ½å¸¦ `WHERE GroupWxId = '...'`
- ä¸åŒç¾¤çš„æ•°æ®å®Œå…¨éš”ç¦»
- ä¸èƒ½å‡ºç°è·¨ç¾¤æŸ¥è¯¢

### 2. å¹¶å‘æ§åˆ¶

**å…±äº«æ•°æ®åº“çš„å¹¶å‘é—®é¢˜**ï¼š
- å¤šä¸ªå¾®ä¿¡å·å¯èƒ½åŒæ—¶è®¿é—®æ•°æ®åº“
- ä½¿ç”¨ SQLite çš„ WAL æ¨¡å¼ï¼ˆå·²é…ç½®ï¼‰
- æ³¨æ„äº‹åŠ¡éš”ç¦»

### 3. æ•°æ®å¤‡ä»½

**é‡æ„å‰å¿…é¡»å¤‡ä»½**ï¼š
```bash
cp -r Data/ Data_backup_$(date +%Y%m%d_%H%M%S)/
```

### 4. å…¼å®¹æ€§

**å‘åå…¼å®¹**ï¼š
- æä¾›æ•°æ®è¿ç§»å·¥å…·
- ä¿ç•™æ—§æ•°æ®åº“æ–‡ä»¶ï¼ˆä¸åˆ é™¤ï¼‰
- è¿ç§»å®Œæˆåå¯ä»¥åˆ é™¤æ—§æ–‡ä»¶

---

## ğŸ“Š é‡æ„å‰åå¯¹æ¯”

| ç‰¹æ€§ | é‡æ„å‰ï¼ˆå¾®ä¿¡ä¸“å±æ•°æ®åº“ï¼‰ | é‡æ„åï¼ˆå…±äº«æ•°æ®åº“ï¼‰ |
|------|------------------------|---------------------|
| æ•°æ®åº“æ–‡ä»¶ | business_wx_1111.db<br>business_wx_2222.db | business.db |
| æ¢å·åæ•°æ® | âŒ ä¸¢å¤± | âœ… ä¿ç•™ |
| æ•°æ®éš”ç¦» | å¾®ä¿¡å·éš”ç¦» | ç¾¤IDéš”ç¦» |
| æŸ¥è¯¢æ•ˆç‡ | é«˜ï¼ˆæ•°æ®å°‘ï¼‰ | é«˜ï¼ˆæœ‰ç´¢å¼•ï¼‰ |
| æ•°æ®ä¸€è‡´æ€§ | ç®€å• | éœ€è¦æ³¨æ„ GroupWxId |
| æ¶æ„å¤æ‚åº¦ | ä¸­ç­‰ | ç®€å• |
| ç¬¦åˆä¸šåŠ¡é€»è¾‘ | âŒ ä¸ç¬¦åˆ | âœ… ç¬¦åˆ |

---

## ğŸ¯ å®æ–½è®¡åˆ’

### é˜¶æ®µä¸€ï¼šå‡†å¤‡ï¼ˆ1å¤©ï¼‰
1. âœ… å¤‡ä»½æ‰€æœ‰æ•°æ®åº“æ–‡ä»¶
2. âœ… åˆ›å»ºæ•°æ®è¿ç§»å·¥å…·
3. âœ… æµ‹è¯•è¿ç§»å·¥å…·

### é˜¶æ®µäºŒï¼šé‡æ„ä»£ç ï¼ˆ2å¤©ï¼‰
1. âœ… ä¿®æ”¹ VxMain.cs çš„æ•°æ®åº“åˆå§‹åŒ–
2. âœ… ä¿®æ”¹ DatabaseInitializer.cs
3. âœ… æ£€æŸ¥æ‰€æœ‰æŸ¥è¯¢ä»£ç ï¼ˆç¡®ä¿å¸¦ GroupWxIdï¼‰
4. âœ… åˆ é™¤å¾®ä¿¡ä¸“å±æ•°æ®åº“é€»è¾‘

### é˜¶æ®µä¸‰ï¼šæµ‹è¯•éªŒè¯ï¼ˆ1å¤©ï¼‰
1. âœ… æµ‹è¯•æ¢å·åœºæ™¯
2. âœ… æµ‹è¯•æ•°æ®éš”ç¦»
3. âœ… æµ‹è¯•å¤šç¾¤åœºæ™¯
4. âœ… æ€§èƒ½æµ‹è¯•

### é˜¶æ®µå››ï¼šä¸Šçº¿éƒ¨ç½²ï¼ˆ1å¤©ï¼‰
1. âœ… æ‰§è¡Œæ•°æ®è¿ç§»
2. âœ… å‘å¸ƒæ–°ç‰ˆæœ¬
3. âœ… ç›‘æ§è¿è¡ŒçŠ¶æ€

---

**æ–‡æ¡£åˆ›å»ºæ—¶é—´**ï¼š2025-11-26  
**é¢„è®¡å®Œæˆæ—¶é—´**ï¼š4-5å¤©  
**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0

