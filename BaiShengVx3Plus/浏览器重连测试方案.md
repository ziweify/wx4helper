# 浏览器重连测试方案

## 🎯 测试目标

验证以下场景的重连稳定性：
1. ✅ 关闭浏览器 → 自动重启
2. ✅ 关闭主程序 → 再次启动 → 重连到老浏览器
3. ✅ 关闭主程序 → 关闭浏览器 → 再次启动主程序 → 启动新浏览器

---

## 📋 测试场景

### 场景1：关闭浏览器（进程结束）

**测试步骤**：
1. 启动主程序
2. 打开飞单开关 → 浏览器启动
3. 手动关闭浏览器窗口（进程结束）
4. 观察监控任务日志

**预期结果**：
- ✅ `OnBrowserDisconnected` 触发
- ✅ 清除 `ProcessId` 和 `Browser` 引用
- ✅ 监控任务检测到 `IsEnabled=true` 且 `IsConnected=false`
- ✅ 监控任务检测到 `ProcessId=0`（进程已结束）
- ✅ **2-4秒内**启动新浏览器

**关键日志**：
```
[INFO] 🔌 浏览器连接断开事件: ConfigId=1
[INFO] 清除 ProcessId: 12345（允许重新启动）
[INFO] 📌 配置 [默认配置] 飞单已开启但未连接
[INFO] ⏳ [默认配置] 等待2秒，给老浏览器重连的机会...
[INFO] 🚀 [默认配置] 启动浏览器...
```

---

### 场景2：关闭浏览器窗口（但进程未结束）

**测试步骤**：
1. 启动主程序
2. 打开飞单开关 → 浏览器启动
3. 点击浏览器窗口的关闭按钮（某些浏览器可能只隐藏窗口，进程仍在）
4. 观察监控任务日志

**预期结果**：
- ✅ `OnBrowserDisconnected` 触发
- ✅ 清除 `ProcessId` 和 `Browser` 引用
- ✅ 监控任务检测到 `IsEnabled=true` 且 `IsConnected=false`
- ⚠️ 监控任务检测到 `ProcessId > 0` 且 `IsProcessRunning=true`
- ✅ 监控任务**等待重连**，不启动新浏览器

**关键日志**：
```
[INFO] 🔌 浏览器连接断开事件: ConfigId=1
[INFO] 清除 ProcessId: 12345（允许重新启动）
[INFO] 📌 配置 [默认配置] 飞单已开启但未连接
[INFO] ⏳ 配置 [默认配置] 浏览器进程 12345 仍在运行，等待重连...
```

**潜在问题**：
如果浏览器进程还在运行，但因为某些原因（例如崩溃）无法重连，监控任务会一直等待。

---

### 场景3：关闭主程序，保留浏览器

**测试步骤**：
1. 启动主程序
2. 打开飞单开关 → 浏览器启动
3. 关闭主程序（浏览器进程保留）
4. 再次启动主程序
5. 观察启动日志

**预期结果**：
- ✅ 主程序启动
- ✅ `SetDatabase` 检测到浏览器进程还在运行
- ✅ 等待2秒，期待老浏览器重连
- ✅ 老浏览器在2秒内重连成功
- ✅ 不启动新浏览器

**关键日志**：
```
[INFO] 🔍 检测到配置 [默认配置] 有浏览器进程 12345 在运行
[INFO] ⏳ 等待浏览器重连...
[INFO] ✅ 浏览器已重连: ConfigId=1
```

---

### 场景4：关闭主程序和浏览器

**测试步骤**：
1. 启动主程序
2. 打开飞单开关 → 浏览器启动
3. 关闭主程序
4. 手动关闭浏览器
5. 再次启动主程序
6. 观察启动日志

**预期结果**：
- ✅ 主程序启动
- ✅ `SetDatabase` 检测到浏览器进程不存在
- ✅ 清除 `ProcessId`
- ✅ 监控任务在4秒后检测到 `IsEnabled=true` 且 `IsConnected=false` 且 `ProcessId=0`
- ✅ 启动新浏览器

**关键日志**：
```
[INFO] 🔍 检测到配置 [默认配置] 有浏览器进程 12345 在运行
[INFO] ⏳ 等待浏览器重连...
[WARN] ⚠️ 配置 [默认配置] 浏览器进程未在2秒内重连
[INFO] 📌 配置 [默认配置] 飞单已开启但未连接
[INFO] 🚀 [默认配置] 启动浏览器...
```

---

## 🐛 当前问题诊断

### 问题：关闭浏览器后，不会自动重启

**可能原因1**：`OnBrowserDisconnected` 未触发

**检查方法**：
- 查看日志中是否有 `🔌 浏览器连接断开事件` 消息
- 如果没有，说明 `AutoBetSocketServer` 未正确检测到连接断开

**可能原因2**：`ProcessId` 未清除

**检查方法**：
- 查看日志中是否有 `清除 ProcessId: XXX（允许重新启动）`
- 如果没有，说明 `OnBrowserDisconnected` 中的清除逻辑未执行

**可能原因3**：监控任务检测到进程仍在运行

**检查方法**：
- 查看日志中是否有 `⏳ 配置 [默认配置] 浏览器进程 XXX 仍在运行，等待重连...`
- 如果有，说明浏览器进程虽然窗口关闭了，但进程未结束

**可能原因4**：监控任务未运行

**检查方法**：
- 查看日志中是否有监控任务的周期性日志（通常每2秒一次）
- 如果没有，说明监控线程未启动或已停止

**可能原因5**：`IsEnabled` 被错误地设置为 `false`

**检查方法**：
- 查看日志中 `OnBrowserDisconnected` 输出的 `IsEnabled` 值
- 如果是 `false`，监控任务不会尝试重启浏览器

---

## 🔧 修复建议

### 建议1：增强 `OnBrowserDisconnected` 的进程检查

**当前代码**：
```csharp
// 🔥 清除 ProcessId（让监控任务可以启动新浏览器）
if (config.ProcessId > 0)
{
    _log.Info("AutoBet", $"清除 ProcessId: {config.ProcessId}（允许重新启动）");
    config.ProcessId = 0;
}
```

**问题**：
- 直接清除 `ProcessId`，但没有检查进程是否真的结束了
- 如果进程还在运行（例如窗口关闭但进程未结束），清除 `ProcessId` 会导致监控任务无法检测到进程存在

**建议修改**：
```csharp
// 🔥 清除 ProcessId（让监控任务可以启动新浏览器）
if (config.ProcessId > 0)
{
    // 检查进程是否真的结束了
    if (IsProcessRunning(config.ProcessId))
    {
        _log.Info("AutoBet", $"⚠️ 浏览器进程 {config.ProcessId} 仍在运行，但连接已断开");
        _log.Info("AutoBet", $"   可能原因：浏览器崩溃、网络问题等");
        _log.Info("AutoBet", $"   保留 ProcessId，监控任务将等待重连");
        // 不清除 ProcessId，让监控任务继续等待
    }
    else
    {
        _log.Info("AutoBet", $"🔧 浏览器进程 {config.ProcessId} 已结束，清除 ProcessId");
        config.ProcessId = 0;
    }
}
```

### 建议2：减少监控任务的等待时间

**当前代码**：
```csharp
// 🔥 先等待2秒，给老浏览器重连的机会
_log.Info("AutoBet", $"⏳ [{configName}] 等待2秒，给老浏览器重连的机会...");
await Task.Delay(2000);
```

**问题**：
- 如果浏览器进程已经结束，等待2秒是不必要的
- 用户感知的响应时间较长

**建议修改**：
```csharp
// 🔥 如果进程已结束，立即启动；否则等待2秒
if (config.ProcessId == 0)
{
    _log.Info("AutoBet", $"💡 [{configName}] 浏览器进程已结束，立即启动新浏览器");
}
else
{
    _log.Info("AutoBet", $"⏳ [{configName}] 浏览器进程还在，等待2秒给重连机会...");
    await Task.Delay(2000);
}
```

### 建议3：增加详细的诊断日志

在监控任务中，输出更多关键信息：
- `IsEnabled` 状态
- `IsConnected` 状态
- `ProcessId` 值
- `IsProcessRunning` 结果
- `Browser` 对象状态

---

## 🧪 测试命令

### 1. 查看主程序日志
```bash
tail -f ./BaiShengVx3Plus/MyLog/app.log
```

### 2. 查看浏览器日志
```bash
tail -f ./BsBrowserClient/bin/Debug/net8.0-windows/browser.log
```

### 3. 检查浏览器进程
```powershell
# Windows
Get-Process | Where-Object { $_.ProcessName -like "*BsBrowserClient*" }
```

---

## 📝 测试结果记录模板

```
【测试场景】：关闭浏览器（进程结束）
【操作步骤】：
1. 启动主程序
2. 打开飞单开关
3. 手动关闭浏览器窗口

【实际结果】：
- OnBrowserDisconnected: [ ] 触发 / [ ] 未触发
- ProcessId清除: [ ] 已清除 / [ ] 未清除
- 监控任务检测: [ ] 检测到未连接 / [ ] 未检测
- 浏览器重启: [ ] 已重启 / [ ] 未重启
- 重启耗时: ___ 秒

【日志片段】：
（粘贴关键日志）

【问题描述】：
（如果有问题，详细描述）
```

---

**文档创建时间**：2025-11-17  
**创建人员**：AI Assistant

