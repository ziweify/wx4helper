# é…ç½®æœåŠ¡ä½¿ç”¨æŒ‡å— ğŸ“–

## æ¶æ„æ¦‚è§ˆ

```
UI Layer (VxMain)
    â†• åŒå‘ç»‘å®š
ConfigViewModel (INotifyPropertyChanged)
    â†• è°ƒç”¨æ–¹æ³• & è®¢é˜…äº‹ä»¶
ConfigurationService (IConfigurationService)
    â†• è¯»å†™
AppConfiguration (çº¯æ•°æ®æ¨¡å‹)
    â†• åºåˆ—åŒ–
appsettings.json (æ–‡ä»¶)
```

---

## 1ï¸âƒ£ åœ¨ UI ä¸­ä½¿ç”¨ï¼ˆVxMain.csï¼‰

### æ­¥éª¤ 1ï¼šæ³¨å…¥ Service å’Œ ViewModel

```csharp
public partial class VxMain : Form
{
    private readonly IConfigurationService _configService;
    private readonly ConfigViewModel _configViewModel;
    
    // ğŸ”¥ é€šè¿‡ä¾èµ–æ³¨å…¥è·å–æœåŠ¡
    public VxMain(IConfigurationService configService)
    {
        InitializeComponent();
        
        _configService = configService;
        
        // ğŸ¯ åˆ›å»º ViewModelï¼ˆç”¨äºæ•°æ®ç»‘å®šï¼‰
        _configViewModel = new ConfigViewModel(configService);
    }
}
```

---

### æ­¥éª¤ 2ï¼šæ•°æ®ç»‘å®šï¼ˆåœ¨ InitializeComponent æˆ– Load äº‹ä»¶ä¸­ï¼‰

```csharp
private void InitializeDataBindings()
{
    // âœ… æ–¹å¼ 1ï¼šç»‘å®šåˆ°å¼€å…³æ§ä»¶ï¼ˆSunny.UI çš„ UISwitchï¼‰
    swi_OrdersTasking.DataBindings.Add(
        new Binding("Active", _configViewModel, nameof(_configViewModel.IsOrdersTaskingEnabled), 
        false, DataSourceUpdateMode.OnPropertyChanged)
    );
    
    swiAutoOrdersBet.DataBindings.Add(
        new Binding("Active", _configViewModel, nameof(_configViewModel.IsAutoBetEnabled), 
        false, DataSourceUpdateMode.OnPropertyChanged)
    );
    
    // âœ… æ–¹å¼ 2ï¼šç»‘å®šåˆ°æ•°å­—è¾“å…¥æ¡†
    numSealSeconds.DataBindings.Add(
        new Binding("Value", _configViewModel, nameof(_configViewModel.SealSecondsAhead), 
        false, DataSourceUpdateMode.OnPropertyChanged)
    );
}
```

---

### æ­¥éª¤ 3ï¼šè®¢é˜…äº‹ä»¶ï¼ˆå¯é€‰ï¼Œç”¨äºæ‰§è¡Œé¢å¤–é€»è¾‘ï¼‰

```csharp
private void InitializeEventHandlers()
{
    // ğŸ”” è®¢é˜… Service äº‹ä»¶ï¼ˆå½“é…ç½®å˜æ›´æ—¶æ‰§è¡Œé¢å¤–é€»è¾‘ï¼‰
    _configService.ConfigurationChanged += OnConfigurationChanged;
}

private void OnConfigurationChanged(object? sender, ConfigurationChangedEventArgs e)
{
    // ğŸ¯ æ ¹æ®å˜æ›´æ‰§è¡Œé¢å¤–é€»è¾‘
    switch (e.PropertyName)
    {
        case nameof(_configViewModel.IsOrdersTaskingEnabled):
            _logService.Info("VxMain", $"æ”¶å•å¼€å…³å˜æ›´: {e.OldValue} â†’ {e.NewValue}");
            
            // æ›´æ–°æ¶ˆæ¯å¤„ç†å™¨çš„å…¨å±€å¼€å…³
            BinggoMessageHandler.IsOrdersTaskingEnabled = (bool)e.NewValue!;
            break;
            
        case nameof(_configViewModel.IsAutoBetEnabled):
            _logService.Info("VxMain", $"é£å•å¼€å…³å˜æ›´: {e.OldValue} â†’ {e.NewValue}");
            
            if ((bool)e.NewValue!)
            {
                // å¼€å¯è‡ªåŠ¨æŠ•æ³¨æ—¶çš„é¢å¤–é€»è¾‘
                StartAutoBet();
            }
            else
            {
                // å…³é—­è‡ªåŠ¨æŠ•æ³¨æ—¶çš„é¢å¤–é€»è¾‘
                StopAutoBet();
            }
            break;
    }
}
```

---

### æ­¥éª¤ 4ï¼šæ‰‹åŠ¨è¯»å–/è®¾ç½®é…ç½®ï¼ˆä¸é€šè¿‡ç»‘å®šï¼‰

```csharp
private void SomeMethod()
{
    // âœ… è¯»å–é…ç½®
    bool isEnabled = _configService.GetIsOrdersTaskingEnabled();
    
    // âœ… è®¾ç½®é…ç½®ï¼ˆè‡ªåŠ¨ä¿å­˜ + è§¦å‘äº‹ä»¶ï¼‰
    _configService.SetIsOrdersTaskingEnabled(true);
    
    // âœ… é€šè¿‡ ViewModel è®¾ç½®ï¼ˆä¹Ÿä¼šè‡ªåŠ¨ä¿å­˜ + è§¦å‘äº‹ä»¶ï¼‰
    _configViewModel.IsAutoBetEnabled = false;
}
```

---

## 2ï¸âƒ£ åœ¨å…¶ä»– Service ä¸­ä½¿ç”¨

### ç¤ºä¾‹ï¼šBinggoMessageHandler

```csharp
public class BinggoMessageHandler
{
    private readonly IConfigurationService _configService;
    
    public BinggoMessageHandler(IConfigurationService configService)
    {
        _configService = configService;
        
        // ğŸ”” è®¢é˜…é…ç½®å˜æ›´äº‹ä»¶
        _configService.ConfigurationChanged += OnConfigChanged;
    }
    
    private void OnConfigChanged(object? sender, ConfigurationChangedEventArgs e)
    {
        if (e.PropertyName == "IsOrdersTaskingEnabled")
        {
            bool newValue = (bool)e.NewValue!;
            _logService.Info("BinggoMessageHandler", $"æ”¶å•å¼€å…³å·²å˜æ›´: {newValue}");
            
            // æ ¹æ®æ–°å€¼æ‰§è¡Œé€»è¾‘
            if (newValue)
            {
                EnableOrderProcessing();
            }
            else
            {
                DisableOrderProcessing();
            }
        }
    }
    
    public void ProcessMessage()
    {
        // âœ… è¯»å–å½“å‰é…ç½®
        if (_configService.GetIsOrdersTaskingEnabled())
        {
            // å¤„ç†æ¶ˆæ¯...
        }
    }
}
```

---

## 3ï¸âƒ£ å·¥ä½œæµç¨‹è¯¦è§£

### åœºæ™¯ Aï¼šç”¨æˆ·ç‚¹å‡»å¼€å…³

```
1. ç”¨æˆ·ç‚¹å‡» swi_OrdersTaskingï¼ˆå¼€å…³æ§ä»¶ï¼‰
   â†“
2. WinForms æ•°æ®ç»‘å®šè‡ªåŠ¨æ›´æ–° _configViewModel.IsOrdersTaskingEnabled
   â†“
3. ConfigViewModel è°ƒç”¨ _configService.SetIsOrdersTaskingEnabled(newValue)
   â†“
4. ConfigurationService æ‰§è¡Œï¼š
   - æ›´æ–°å†…éƒ¨ Model
   - ä¿å­˜åˆ° appsettings.json
   - è§¦å‘ ConfigurationChanged äº‹ä»¶
   â†“
5. ConfigViewModel æ”¶åˆ°äº‹ä»¶ï¼Œè§¦å‘ PropertyChanged
   â†“
6. WinForms è‡ªåŠ¨æ›´æ–°æ‰€æœ‰ç»‘å®šåˆ°è¯¥å±æ€§çš„æ§ä»¶
   â†“
7. VxMain è®¢é˜…çš„äº‹ä»¶å¤„ç†å™¨æ‰§è¡Œé¢å¤–é€»è¾‘
```

### åœºæ™¯ Bï¼šä»£ç ä¿®æ”¹é…ç½®

```
1. ä»£ç è°ƒç”¨ _configService.SetIsAutoBetEnabled(true)
   â†“
2. ConfigurationService æ‰§è¡Œï¼š
   - æ›´æ–°å†…éƒ¨ Model
   - ä¿å­˜åˆ° appsettings.json
   - è§¦å‘ ConfigurationChanged äº‹ä»¶
   â†“
3. ConfigViewModel æ”¶åˆ°äº‹ä»¶ï¼Œè§¦å‘ PropertyChanged
   â†“
4. WinForms è‡ªåŠ¨æ›´æ–°ç»‘å®šçš„å¼€å…³æ§ä»¶çŠ¶æ€
   â†“
5. è®¢é˜…äº‹ä»¶çš„æ‰€æœ‰å¯¹è±¡éƒ½æ”¶åˆ°é€šçŸ¥
```

---

## 4ï¸âƒ£ ä¼˜åŠ¿æ€»ç»“

| ç‰¹æ€§ | è¯´æ˜ |
|------|------|
| **å®Œå…¨å°è£…** | å¤–éƒ¨ä¸çŸ¥é“é…ç½®å¦‚ä½•å­˜å‚¨ï¼ˆæ–‡ä»¶/æ•°æ®åº“ï¼‰ |
| **è‡ªåŠ¨ä¿å­˜** | ä»»ä½•ä¿®æ”¹éƒ½è‡ªåŠ¨ä¿å­˜ï¼Œæ— éœ€æ‰‹åŠ¨è°ƒç”¨ |
| **è‡ªåŠ¨é€šçŸ¥** | é…ç½®å˜æ›´è‡ªåŠ¨é€šçŸ¥æ‰€æœ‰è®¢é˜…è€… |
| **æ”¯æŒç»‘å®š** | ViewModel æ”¯æŒ WinForms åŒå‘ç»‘å®š |
| **æ˜“äºæµ‹è¯•** | æ¥å£è®¾è®¡ï¼Œæ–¹ä¾¿ Mock å’Œå•å…ƒæµ‹è¯• |
| **èŒè´£æ¸…æ™°** | Model=æ•°æ®, Service=é€»è¾‘, ViewModel=UIæ¡¥æ¢ |

---

## 5ï¸âƒ£ å¸¸è§é—®é¢˜

### Q1ï¼šä¸ºä»€ä¹ˆä¸ç›´æ¥ç»‘å®š Serviceï¼Ÿ

**Aï¼š** WinForms çš„æ•°æ®ç»‘å®šéœ€è¦ `INotifyPropertyChanged`ï¼Œè€Œ Service ä¸åº”è¯¥å®ç°è¿™ä¸ª UI æ¡†æ¶çš„æ¥å£ã€‚ViewModel ä½œä¸ºä¸­é—´å±‚ï¼Œè®© Service ä¿æŒçº¯ç²¹ã€‚

### Q2ï¼šä¸ºä»€ä¹ˆä¸è®© Model å®ç° INotifyPropertyChangedï¼Ÿ

**Aï¼š** Model åº”è¯¥æ˜¯çº¯æ•°æ®ç±»ï¼ˆPOCOï¼‰ï¼Œç”¨äºåºåˆ—åŒ–å’ŒæŒä¹…åŒ–ã€‚æ·»åŠ  UI ç›¸å…³çš„æ¥å£ä¼šç ´åæ¶æ„çš„æ¸…æ™°æ€§ã€‚

### Q3ï¼šViewModel å’Œ Model æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

**Aï¼š**
- **Model**ï¼šçº¯æ•°æ®ï¼Œç”¨äºåºåˆ—åŒ–ï¼ˆä¿å­˜åˆ°æ–‡ä»¶/æ•°æ®åº“ï¼‰
- **ViewModel**ï¼šUI é€‚é…å±‚ï¼Œå®ç° `INotifyPropertyChanged`ï¼Œè¿æ¥ UI å’Œ Service

### Q4ï¼šå¦‚æœæœ‰å¾ˆå¤šé…ç½®é¡¹ï¼ŒViewModel ä¼šå¾ˆè‡ƒè‚¿ï¼Ÿ

**Aï¼š** å¯ä»¥æ‹†åˆ†æˆå¤šä¸ª ViewModelï¼š
- `GeneralConfigViewModel`
- `AutoBetConfigViewModel`
- `NotificationConfigViewModel`

æ¯ä¸ª ViewModel åªæš´éœ²ç›¸å…³çš„é…ç½®é¡¹ã€‚

---

## 6ï¸âƒ£ è¿ç§»æŒ‡å—

### æ—§ä»£ç ï¼ˆå•ä¾‹æ¨¡å¼ï¼‰ï¼š

```csharp
// âŒ æ—§æ–¹å¼
ConfigurationManager.Instance.Configuration.IsAutoBetEnabled = true;
```

### æ–°ä»£ç ï¼ˆä¾èµ–æ³¨å…¥ + ViewModelï¼‰ï¼š

```csharp
// âœ… æ–°æ–¹å¼ 1ï¼šé€šè¿‡ Service
_configService.SetIsAutoBetEnabled(true);

// âœ… æ–°æ–¹å¼ 2ï¼šé€šè¿‡ ViewModelï¼ˆæ•°æ®ç»‘å®šï¼‰
_configViewModel.IsAutoBetEnabled = true;
```

---

## 7ï¸âƒ£ æœ€ä½³å®è·µ

1. **UI å±‚**ï¼šç»‘å®šåˆ° `ConfigViewModel`
2. **Service å±‚**ï¼šæ³¨å…¥ `IConfigurationService`
3. **éœ€è¦ç›‘å¬å˜åŒ–**ï¼šè®¢é˜… `ConfigurationChanged` äº‹ä»¶
4. **æ‰‹åŠ¨ä¿®æ”¹**ï¼šè°ƒç”¨ `SetXxx()` æ–¹æ³•
5. **è¯»å–å½“å‰å€¼**ï¼šè°ƒç”¨ `GetXxx()` æ–¹æ³•

---

## ğŸ‰ æ€»ç»“

è¿™ä¸ªæ¶æ„å®ç°äº†ï¼š
- âœ… **èŒè´£åˆ†ç¦»**ï¼šModel=æ•°æ®ï¼ŒService=é€»è¾‘ï¼ŒViewModel=UIæ¡¥æ¢
- âœ… **è‡ªåŠ¨ä¿å­˜**ï¼šä»»ä½•ä¿®æ”¹éƒ½è‡ªåŠ¨æŒä¹…åŒ–
- âœ… **è‡ªåŠ¨é€šçŸ¥**ï¼šUI å’Œæ‰€æœ‰è®¢é˜…è€…è‡ªåŠ¨æ›´æ–°
- âœ… **æ˜“äºæµ‹è¯•**ï¼šæ¥å£è®¾è®¡ï¼Œæ–¹ä¾¿ Mock
- âœ… **æ˜“äºæ‰©å±•**ï¼šæ·»åŠ æ–°é…ç½®åªéœ€è¦ä¸‰æ­¥ï¼šModel+Service+ViewModel

