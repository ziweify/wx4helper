# 浏览器重连问题诊断指南

## 📋 问题描述

**用户反馈**：
> 关闭了浏览器，浏览器不会自动启动。请检查，请确保重连稳定，不管关闭哪一端，都能重连成功。

---

## 🔍 预期流程

### 场景1：手动关闭浏览器（浏览器进程结束）

1. **浏览器关闭** → 进程结束
2. **Socket 连接断开** → 触发 `OnBrowserDisconnected` 事件
3. **清理资源**：
   - 清除 `config.Browser = null`
   - 清除 `config.ProcessId = 0`
   - 设置 `config.Status = "连接断开"`
4. **监控任务检测**（2秒后）：
   - 检查 `config.IsEnabled = true`
   - 检查 `config.IsConnected = false`
   - 检查 `config.ProcessId = 0`（进程不存在）
   - ✅ **启动新浏览器**

### 场景2：关闭主程序（浏览器进程保留）

1. **主程序关闭** → Socket 服务器关闭
2. **浏览器Socket断开** → 浏览器进入重连循环
3. **主程序重启**：
   - Socket 服务器重新启动
   - 检测到 `config.ProcessId > 0` 且进程存在
   - 等待浏览器重连（最多2秒）
4. **浏览器重连**：
   - 浏览器检测到端口可用
   - 发起连接握手
   - ✅ **重连成功**

---

## 🔧 诊断步骤

### 步骤1：检查日志关键字

在主程序日志中搜索以下关键字：

#### 1.1 浏览器断开事件
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔌 浏览器连接断开事件: ConfigId=1
配置信息: 默认配置
   IsEnabled: true
   IsConnected: false
清理失效的 Browser 引用
清除 ProcessId: 12345（允许重新启动）
```

**如果看到以上日志**：✅ 断开事件正常触发

**如果没有看到**：❌ 断开事件未触发（可能是Socket连接未正确关闭）

---

#### 1.2 进程检查日志
```
🔧 配置 [默认配置] 浏览器进程 12345 已结束，清除 ProcessId
```

**如果看到以上日志**：✅ 进程检查正常工作

**如果看到**：
```
⏳ 配置 [默认配置] 浏览器进程 12345 仍在运行，等待重连...
```
❌ 进程检查认为浏览器还在运行（但实际已关闭）

---

#### 1.3 监控任务启动浏览器
```
📌 配置 [默认配置] 飞单已开启但未连接
⏳ [默认配置] 等待2秒，给老浏览器重连的机会...
🚀 [默认配置] 启动浏览器...
```

**如果看到以上日志**：✅ 监控任务正常工作

**如果没有看到**：❌ 监控任务未检测到需要启动浏览器

---

### 步骤2：检查配置状态

在主程序中，打开"配置管理"窗口，查看配置的状态：

| 字段 | 预期值（浏览器关闭后） | 说明 |
|------|----------------------|------|
| `IsEnabled` | `true` | 飞单开关已打开 |
| `IsConnected` | `false` | 未连接 |
| `ProcessId` | `0` | 进程ID已清除 |
| `Status` | `"连接断开"` | 状态已更新 |

**如果 `ProcessId` 不为 `0`**：
- ❌ 进程ID未正确清除
- 原因：`OnBrowserDisconnected` 未触发，或 `IsProcessRunning` 判断错误

---

### 步骤3：手动测试重连流程

#### 测试A：关闭浏览器（进程结束）

1. **启动主程序** → 打开飞单开关 → 浏览器自动启动
2. **手动关闭浏览器**（点击X按钮，或结束进程）
3. **等待4秒**（监控任务周期2秒 + 等待2秒）
4. **预期结果**：✅ 浏览器自动重新启动

**如果浏览器未启动**：
- 查看日志，找到上述关键字
- 定位问题环节（断开事件、进程检查、监控任务）

---

#### 测试B：关闭主程序（浏览器保留）

1. **启动主程序** → 打开飞单开关 → 浏览器自动启动
2. **关闭主程序**（浏览器保持运行）
3. **再次启动主程序**
4. **预期结果**：✅ 2秒内主程序重连到老浏览器，不启动新浏览器

**如果启动了新浏览器**：
- ❌ 主程序未正确检测到老浏览器进程
- 查看日志中的 `ProcessId` 和 `IsProcessRunning` 检查

---

#### 测试C：关闭浏览器，再关闭主程序，再启动主程序

1. **启动主程序** → 打开飞单开关 → 浏览器自动启动
2. **手动关闭浏览器**
3. **立即关闭主程序**（不等待重启）
4. **再次启动主程序**
5. **预期结果**：✅ 4秒内启动新浏览器

---

## 🐛 可能的问题原因

### 原因1：`OnBrowserDisconnected` 未触发

**症状**：
- 浏览器关闭后，`ProcessId` 仍然保留旧值
- 日志中没有 `🔌 浏览器连接断开事件` 消息

**排查**：
```csharp
// 检查 AutoBetSocketServer 是否正确触发断开事件
// 文件：BaiShengVx3Plus/Services/AutoBet/AutoBetSocketServer.cs
// 查找：OnDisconnected?.Invoke(connection.ConfigId);
```

**修复**：
- 确保 Socket 连接断开时，正确调用 `OnDisconnected` 回调
- 检查 `ClientConnection.StartReceiving` 中的异常处理

---

### 原因2：`IsProcessRunning` 误判

**症状**：
- 浏览器已关闭，但日志显示"浏览器进程仍在运行"
- `ProcessId` 不为 `0`，但进程实际已结束

**排查**：
```csharp
// 检查进程检查逻辑
// 文件：BaiShengVx3Plus/Services/AutoBet/AutoBetService.cs
// 方法：IsProcessRunning(int processId)
```

**可能的问题**：
- Windows PID被回收复用（极低概率）
- 进程成为僵尸进程（`HasExited` 未更新）

**已有防护**：
```csharp
// 三重检查机制
1. GetProcessById  // 检查进程是否存在
2. HasExited       // 检查进程是否已退出
3. ProcessName     // 防止PID被回收复用
```

---

### 原因3：监控任务未运行

**症状**：
- 浏览器关闭后，没有任何日志输出
- 配置状态正确（`ProcessId=0`, `IsConnected=false`），但就是不启动

**排查**：
```csharp
// 检查监控线程是否正常运行
// 文件：BaiShengVx3Plus/Services/AutoBet/AutoBetService.cs
// 字段：_monitorThread, _monitorRunning
```

**检查**：
- `_monitorRunning` 是否为 `true`
- `_monitorThread` 是否为 `null` 或已终止
- `MonitorBrowsersLoop` 是否抛出未捕获异常

---

### 原因4：`IsEnabled` 被意外关闭

**症状**：
- 浏览器关闭后，飞单开关变成关闭状态

**排查**：
- 检查 `OnBrowserDisconnected` 是否错误地修改了 `IsEnabled`
- 检查UI是否有自动关闭逻辑

---

## 💡 调试建议

### 建议1：增加详细日志

在 `MonitorBrowsers` 方法开头添加：

```csharp
// 临时调试日志（生产环境可移除）
_log.Debug("AutoBet", $"🔍 监控任务运行: 启用配置数={enabledConfigs.Count}");
foreach (var config in enabledConfigs)
{
    _log.Debug("AutoBet", $"   [{config.ConfigName}] IsConnected={config.IsConnected}, ProcessId={config.ProcessId}");
}
```

---

### 建议2：强制清除 ProcessId

如果怀疑 `OnBrowserDisconnected` 未触发，可以在 `MonitorBrowsers` 中增强检查：

```csharp
// 🔥 增强：即使 ProcessId > 0，如果进程不存在，也清除
if (config.ProcessId > 0 && !IsProcessRunning(config.ProcessId))
{
    _log.Warning("AutoBet", $"⚠️ 配置 [{config.ConfigName}] ProcessId={config.ProcessId} 进程不存在，强制清除");
    config.ProcessId = 0;
}
```

**注意**：这个逻辑已经在第1449-1463行实现了！

---

### 建议3：检查 `_startingConfigs` 死锁

如果监控任务日志显示"正在启动中，跳过"，但浏览器确实没在启动：

```csharp
// 检查是否有配置被"卡住"
lock (_lock)
{
    if (_startingConfigs.Count > 0)
    {
        _log.Warning("AutoBet", $"⚠️ 有 {_startingConfigs.Count} 个配置标记为'正在启动'");
        foreach (var id in _startingConfigs)
        {
            _log.Warning("AutoBet", $"   - ConfigId: {id}");
        }
    }
}
```

---

## 📝 测试清单

请按以下顺序测试，并记录每一步的结果：

- [ ] **测试A**：关闭浏览器 → 等待4秒 → 浏览器自动重启？
- [ ] **测试B**：关闭主程序 → 重启主程序 → 2秒内重连老浏览器？
- [ ] **测试C**：关闭浏览器 → 关闭主程序 → 重启主程序 → 4秒内启动新浏览器？
- [ ] **日志检查**：是否看到"浏览器连接断开事件"？
- [ ] **日志检查**：是否看到"浏览器进程已结束，清除ProcessId"？
- [ ] **日志检查**：是否看到"启动浏览器"？
- [ ] **配置检查**：浏览器关闭后，`ProcessId` 是否为 `0`？

---

## 📞 请提供以下信息

如果浏览器仍然不会自动重启，请提供：

1. **完整日志**（从启动到浏览器关闭后5秒）
2. **配置状态截图**（配置管理窗口，显示 `IsEnabled`, `IsConnected`, `ProcessId`, `Status`）
3. **测试清单结果**（哪些通过✅，哪些失败❌）
4. **失败的测试步骤**（详细描述操作步骤和实际结果）

---

**诊断日期**：2025-11-17  
**诊断人员**：AI Assistant  
**关联问题**：浏览器自动重启失败

