# 资金变动查看窗口完成

## ✅ 完成功能

### 1. 资金变动查看窗口 (`BalanceChangeViewerForm`)

#### 窗口功能
- 显示指定会员的所有资金变动记录
- 支持按昵称或微信ID搜索
- 支持按变动原因筛选
- 实时统计增加、减少和净变化金额

#### 数据显示列

| 列名 | 字段 | 宽度 | 格式 | 说明 |
|-----|------|------|------|------|
| ID | Id | 60 | - | 记录ID |
| 变动时间 | TimeString | 140 | - | 格式: yyyy-MM-dd HH:mm:ss |
| 昵称 | Nickname | 100 | - | 会员昵称 |
| 变动前 | BalanceBefore | 90 | F2 | 变动前余额 |
| 变动后 | BalanceAfter | 90 | F2 | 变动后余额 |
| 变动金额 | ChangeAmount | 100 | +0.00;-0.00;0.00 | 正数绿色，负数红色 |
| 变动原因 | ReasonText | 90 | - | 文本显示原因 |
| 期号 | IssueId | 90 | - | 关联期号 |
| 订单ID | RelatedOrderId | 70 | - | 关联订单ID |
| 订单内容 | RelatedOrderInfo | 120 | - | 订单详情（如"123大10"） |
| 订单时间 | RelatedOrderTime | 140 | - | 订单时间 |
| 备注 | Notes | 150+ | - | 自动填充剩余空间 |

#### 筛选功能

**搜索框**：
- 支持按昵称搜索
- 支持按微信ID搜索
- 模糊匹配，不区分大小写
- 回车键快速搜索

**原因筛选下拉框**：
- 全部原因
- 下注
- 订单结算
- 订单取消
- 上分
- 下分
- 清空数据
- 手动调整
- 补单

**操作按钮**：
- **搜索**：应用当前筛选条件
- **重置**：清空搜索框和筛选条件

#### 统计信息
窗口底部显示统计栏：
```
共 X 条记录 | 增加: XXX.XX | 减少: XXX.XX | 净变化: ±XXX.XX
```

#### 视觉效果
- **变动金额着色**：
  - 正数（增加）：绿色 + 粗体
  - 负数（减少）：红色 + 粗体
  - 零：默认颜色
- **数据排序**：按时间戳降序（最新在上）

### 2. V2BalanceChange 模型增强

添加了 `ReasonText` 计算属性：
```csharp
public string ReasonText => Reason switch
{
    ChangeReason.未知 => "未知",
    ChangeReason.下注 => "下注",
    ChangeReason.订单结算 => "订单结算",
    ChangeReason.订单取消 => "订单取消",
    ChangeReason.上分 => "上分",
    ChangeReason.下分 => "下分",
    ChangeReason.清空数据 => "清空数据",
    ChangeReason.手动调整 => "手动调整",
    ChangeReason.补单 => "补单",
    _ => "未知"
};
```

### 3. 集成到会员右键菜单

在 `VxMain.cs` 中的 `TsmiViewBalanceChange_Click` 方法：
```csharp
private void TsmiViewBalanceChange_Click(object sender, EventArgs e)
{
    // ...
    var form = new Views.BalanceChangeViewerForm(
        selectedMember.Wxid, 
        selectedMember.Nickname, 
        _db, 
        _logService);
    form.ShowDialog();
}
```

## 📋 使用说明

### 如何打开资金变动窗口

1. **方式1：会员右键菜单**
   - 在会员列表中右键点击会员
   - 选择"资金变动"
   - 弹出该会员的资金变动窗口

2. **方式2：程序化调用**（可扩展）
   ```csharp
   var form = new BalanceChangeViewerForm(wxid, nickname, db, logService);
   form.ShowDialog();
   ```

### 如何筛选数据

**示例1：查找特定会员**
1. 在搜索框输入会员昵称或Wxid
2. 点击"搜索"按钮或按回车键
3. 显示匹配的记录

**示例2：查看订单结算记录**
1. 在"变动原因"下拉框选择"订单结算"
2. 自动刷新，只显示订单结算相关的资金变动

**示例3：组合筛选**
1. 搜索框输入"张三"
2. 原因选择"上分"
3. 显示"张三"的所有上分记录

**重置筛选**：点击"重置"按钮清空所有筛选条件

### 数据示例

| ID | 变动时间 | 昵称 | 变动前 | 变动后 | 变动金额 | 变动原因 | 期号 | 订单ID | 订单内容 | 备注 |
|----|----------|------|--------|--------|----------|----------|------|--------|----------|------|
| 123 | 2025-11-07 10:30:15 | 张三 | 1000.00 | 990.00 | -10.00 | 下注 | 114062935 | 456 | 123大10 | - |
| 124 | 2025-11-07 10:35:20 | 张三 | 990.00 | 1008.00 | +18.00 | 订单结算 | 114062935 | 456 | 123大10 | 盈利结算 |
| 125 | 2025-11-07 11:00:00 | 张三 | 1008.00 | 1508.00 | +500.00 | 上分 | 0 | 0 | - | 管理员上分 |

## 🎯 技术细节

### 数据加载
```csharp
// 按会员加载
_allChanges = _db.Table<V2BalanceChange>()
    .Where(c => c.Wxid == _wxid)
    .OrderByDescending(c => c.Timestamp)
    .ToList();
```

### 筛选逻辑
```csharp
_filteredChanges = _allChanges.Where(c =>
{
    // 文本搜索
    if (!string.IsNullOrEmpty(searchText))
    {
        if (!c.Nickname?.Contains(searchText, OrdinalIgnoreCase) &&
            !c.Wxid?.Contains(searchText, OrdinalIgnoreCase))
            return false;
    }
    
    // 原因筛选
    if (reasonIndex > 0)
    {
        if (c.Reason != targetReason)
            return false;
    }
    
    return true;
}).ToList();
```

### 统计计算
```csharp
float totalIncrease = _filteredChanges.Where(c => c.ChangeAmount > 0).Sum(c => c.ChangeAmount);
float totalDecrease = _filteredChanges.Where(c => c.ChangeAmount < 0).Sum(c => c.ChangeAmount);
float netChange = _filteredChanges.Sum(c => c.ChangeAmount);
```

### 单元格着色
```csharp
dgvBalanceChanges.CellFormatting += (s, e) =>
{
    if (e.ColumnIndex == 5 && e.Value != null) // ChangeAmount 列
    {
        if (float.TryParse(e.Value.ToString(), out float amount))
        {
            if (amount > 0)
            {
                e.CellStyle.ForeColor = Color.Green;
                e.CellStyle.Font = new Font("微软雅黑", 10F, FontStyle.Bold);
            }
            else if (amount < 0)
            {
                e.CellStyle.ForeColor = Color.Red;
                e.CellStyle.Font = new Font("微软雅黑", 10F, FontStyle.Bold);
            }
        }
    }
};
```

## 🔍 数据库表结构

### V2BalanceChange 表
```sql
CREATE TABLE V2BalanceChange (
    Id INTEGER PRIMARY KEY AUTOINCREMENT,
    GroupWxId TEXT NOT NULL,
    Wxid TEXT,
    Nickname TEXT,
    BalanceBefore REAL NOT NULL,
    BalanceAfter REAL NOT NULL,
    ChangeAmount REAL NOT NULL,
    Reason INTEGER NOT NULL,
    RelatedOrderId INTEGER DEFAULT 0,
    RelatedOrderInfo TEXT,
    RelatedOrderTime TEXT,
    IssueId INTEGER DEFAULT 0,
    TimeString TEXT NOT NULL,
    Timestamp INTEGER NOT NULL,
    Notes TEXT
);
```

## 📊 预期使用场景

### 场景1：会员查询余额变化
**需求**：会员问"为什么我的余额从1000变成900了？"
**操作**：
1. 在会员列表找到该会员
2. 右键 → "资金变动"
3. 查看变动记录，找到余额减少的原因

### 场景2：审计订单结算
**需求**：检查今天所有订单结算是否正确
**操作**：
1. 打开任意会员的资金变动窗口
2. 原因筛选选择"订单结算"
3. 逐条核对变动金额与订单盈亏

### 场景3：追溯异常操作
**需求**：发现某会员余额异常，需要追溯原因
**操作**：
1. 右键会员 → "资金变动"
2. 查看完整的资金变动历史
3. 找到异常变动记录和对应的操作原因

### 场景4：统计上下分情况
**需求**：查看某会员今日上分和下分的总额
**操作**：
1. 打开会员的资金变动窗口
2. 原因筛选选择"上分"，查看统计
3. 切换到"下分"，查看统计
4. 比较两者金额

## ⚠️ 注意事项

### 1. 数据一致性
- 所有涉及余额变动的操作都**必须**记录到 `V2BalanceChange` 表
- 包括：下注、结算、上分、下分、清分、补单等
- 目前已实现：清分

### 2. 性能考虑
- 大量记录（10000+）可能影响加载速度
- 建议定期清理或归档旧数据
- 可添加日期范围筛选功能

### 3. 数据完整性
- `RelatedOrderId`、`RelatedOrderInfo`、`RelatedOrderTime` 为关联字段
- 下注和结算相关的变动应填写这些字段
- 非订单相关的变动可留空

### 4. 权限管理（待实现）
- 当前所有人都可以查看资金变动
- 建议后续添加权限控制
- 普通会员只能查看自己的，管理员可以查看所有

## 🎉 完成状态

- ✅ 窗口UI设计完成
- ✅ 数据加载逻辑完成
- ✅ 搜索筛选功能完成
- ✅ 统计计算功能完成
- ✅ 单元格着色功能完成
- ✅ 集成到会员右键菜单完成
- ✅ V2BalanceChange 模型增强完成
- ✅ 编译测试通过
- ⏳ 等待用户测试验证

## 📝 后续优化建议

1. **日期范围筛选**
   - 添加开始日期和结束日期选择器
   - 按日期范围筛选记录

2. **导出功能**
   - 导出为Excel或CSV
   - 用于财务审计和报表生成

3. **详情查看**
   - 双击记录查看完整详情
   - 包括关联订单的完整信息

4. **图表统计**
   - 添加资金变动趋势图
   - 按原因分类的饼图

5. **批量操作**
   - 批量标记或添加备注
   - 批量导出选中记录

## 🔗 关联文件

- `BaiShengVx3Plus/Views/BalanceChangeViewerForm.cs` - 代码逻辑
- `BaiShengVx3Plus/Views/BalanceChangeViewerForm.Designer.cs` - UI设计
- `BaiShengVx3Plus/Models/V2BalanceChange.cs` - 数据模型
- `BaiShengVx3Plus/Models/Enums.cs` - `ChangeReason` 枚举
- `BaiShengVx3Plus/Views/VxMain.cs` - 右键菜单集成

