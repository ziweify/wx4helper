# åŠŸèƒ½å®ç°ï¼šè®°ä½å¯†ç  + æŠ•æ³¨æ•°æ®åº“ä¿®å¤

## ä¿®å¤å†…å®¹

### é—®é¢˜1ï¼šæŠ•æ³¨å¤±è´¥ - "æ•°æ®åº“æœªåˆå§‹åŒ–"

#### åŸå› 
`BetRecordService` ä½¿ç”¨çš„æ˜¯å¾®ä¿¡ä¸“å±æ•°æ®åº“ï¼ˆ`_db`ï¼‰ï¼Œåªæœ‰åœ¨ç»‘å®šå¾®ä¿¡åæ‰ä¼šåˆå§‹åŒ–ã€‚  
å¦‚æœç”¨æˆ·æ²¡æœ‰ç»‘å®šå¾®ä¿¡æˆ–ç»‘å®šå¤±è´¥ï¼Œ`_db` ä¸º nullï¼Œå¯¼è‡´æŠ•æ³¨æ—¶æŠ¥é”™ã€‚

#### è§£å†³æ–¹æ¡ˆ
**è®© `BetRecordService` ä½¿ç”¨å…¨å±€æ•°æ®åº“ï¼ˆ`_globalDb`ï¼‰**ï¼Œä¸ä¾èµ–å¾®ä¿¡ç»‘å®šã€‚

#### ä»£ç ä¿®æ”¹

**`BaiShengVx3Plus/Views/VxMain.cs` (ç¬¬328-343è¡Œ)**

```csharp
// ä¹‹å‰ï¼šä½¿ç”¨å¾®ä¿¡ä¸“å±æ•°æ®åº“ï¼ˆä¾èµ–ç»‘å®šï¼‰
if (_db != null)
{
    var betRecordService = Program.ServiceProvider.GetService<Services.AutoBet.BetRecordService>();
    betRecordService?.SetDatabase(_db);
}

// ä¿®æ”¹åï¼šä½¿ç”¨å…¨å±€æ•°æ®åº“ï¼ˆä¸ä¾èµ–ç»‘å®šï¼‰
var betRecordService = Program.ServiceProvider.GetService<Services.AutoBet.BetRecordService>();
betRecordService?.SetDatabase(_globalDb);
_logService.Info("VxMain", "âœ… BetRecordService å·²è®¾ç½®å…¨å±€æ•°æ®åº“ï¼ˆBetRecordï¼‰");
```

**å¥½å¤„**ï¼š
- âœ… æŠ•æ³¨è®°å½•ä¸å¾®ä¿¡ç»‘å®šè§£è€¦
- âœ… æ— éœ€ç»‘å®šå¾®ä¿¡ä¹Ÿèƒ½ä½¿ç”¨æŠ•æ³¨åŠŸèƒ½
- âœ… æ•°æ®åº“å§‹ç»ˆå¯ç”¨

---

### é—®é¢˜2ï¼šç™»å½•è®°ä½å¯†ç åŠŸèƒ½

#### éœ€æ±‚
1. ç”¨æˆ·å‹¾é€‰"è®°ä½å¯†ç "åï¼Œä¸‹æ¬¡æ‰“å¼€è½¯ä»¶è‡ªåŠ¨å¡«å……è´¦å·å¯†ç 
2. å¯†ç éœ€è¦åŠ å¯†å­˜å‚¨ï¼Œä¸èƒ½æ˜æ–‡ä¿å­˜åœ¨é…ç½®æ–‡ä»¶ä¸­
3. ç”¨æˆ·å–æ¶ˆå‹¾é€‰"è®°ä½å¯†ç "åï¼Œæ¸…ç©ºä¿å­˜çš„å¯†ç 

#### å®ç°æ–¹æ¡ˆ

##### 1. æ•°æ®æ¨¡å‹ - æ·»åŠ è®°ä½å¯†ç å±æ€§

**`BaiShengVx3Plus/Models/AppConfiguration.cs`**

```csharp
public class AppConfiguration
{
    public string BsUserName { get; set; } = string.Empty;        // ç™¾ç››ç”¨æˆ·å
    public string BsUserPwd { get; set; } = string.Empty;         // ç™¾ç››å¯†ç ï¼ˆBase64åŠ å¯†ï¼‰
    public bool IsRememberPassword { get; set; } = false;         // ğŸ”¥ æ–°å¢ï¼šè®°ä½å¯†ç 
    // ... å…¶ä»–å±æ€§
}
```

##### 2. åŠ å¯†å·¥å…· - ç®€å•çš„Base64 + XORåŠ å¯†

**`BaiShengVx3Plus/Utils/PasswordHelper.cs` (æ–°å»ºæ–‡ä»¶)**

```csharp
public static class PasswordHelper
{
    private const string Salt = "BaiSheng_Vx3Plus_2024";
    
    /// <summary>
    /// åŠ å¯†å¯†ç ï¼ˆBase64 + XORï¼‰
    /// </summary>
    public static string Encrypt(string plainText)
    {
        var plainBytes = Encoding.UTF8.GetBytes(plainText);
        var saltBytes = Encoding.UTF8.GetBytes(Salt);
        
        // XORåŠ å¯†
        var encryptedBytes = new byte[plainBytes.Length];
        for (int i = 0; i < plainBytes.Length; i++)
        {
            encryptedBytes[i] = (byte)(plainBytes[i] ^ saltBytes[i % saltBytes.Length]);
        }
        
        // Base64ç¼–ç 
        return Convert.ToBase64String(encryptedBytes);
    }
    
    /// <summary>
    /// è§£å¯†å¯†ç 
    /// </summary>
    public static string Decrypt(string encryptedText)
    {
        var encryptedBytes = Convert.FromBase64String(encryptedText);
        var saltBytes = Encoding.UTF8.GetBytes(Salt);
        
        // XORè§£å¯†
        var plainBytes = new byte[encryptedBytes.Length];
        for (int i = 0; i < encryptedBytes.Length; i++)
        {
            plainBytes[i] = (byte)(encryptedBytes[i] ^ saltBytes[i % saltBytes.Length]);
        }
        
        return Encoding.UTF8.GetString(plainBytes);
    }
}
```

**åŠ å¯†ç¤ºä¾‹**ï¼š
```
åŸå§‹å¯†ç : "123456"
åŠ å¯†å: "Y3l0cWRkZg=="
ä¿å­˜åˆ°é…ç½®æ–‡ä»¶ï¼ˆappsettings.jsonï¼‰
```

##### 3. é…ç½®æœåŠ¡ - è¯»å–å’Œä¿å­˜ç™»å½•ä¿¡æ¯

**`BaiShengVx3Plus/Services/Configuration/ConfigurationService.cs`**

```csharp
/// <summary>
/// è·å–ä¿å­˜çš„ç”¨æˆ·å
/// </summary>
public string GetBsUserName() => _configuration.BsUserName;

/// <summary>
/// è·å–ä¿å­˜çš„å¯†ç ï¼ˆè‡ªåŠ¨è§£å¯†ï¼‰
/// </summary>
public string GetBsUserPassword()
{
    if (string.IsNullOrEmpty(_configuration.BsUserPwd))
        return string.Empty;
    
    return Utils.PasswordHelper.Decrypt(_configuration.BsUserPwd);
}

/// <summary>
/// è·å–æ˜¯å¦è®°ä½å¯†ç 
/// </summary>
public bool GetIsRememberPassword() => _configuration.IsRememberPassword;

/// <summary>
/// ä¿å­˜ç™»å½•ä¿¡æ¯ï¼ˆè‡ªåŠ¨åŠ å¯†å¯†ç ï¼‰
/// </summary>
public void SaveLoginInfo(string username, string password, bool rememberPassword)
{
    _configuration.BsUserName = username;
    _configuration.IsRememberPassword = rememberPassword;
    
    if (rememberPassword && !string.IsNullOrEmpty(password))
    {
        // ğŸ”¥ åŠ å¯†ä¿å­˜å¯†ç 
        _configuration.BsUserPwd = Utils.PasswordHelper.Encrypt(password);
        _logService.Info("ConfigurationService", $"ç™»å½•ä¿¡æ¯å·²ä¿å­˜: ç”¨æˆ·å={username}, è®°ä½å¯†ç =æ˜¯");
    }
    else
    {
        // ä¸è®°ä½å¯†ç ï¼Œæ¸…ç©º
        _configuration.BsUserPwd = string.Empty;
        _logService.Info("ConfigurationService", $"ç™»å½•ä¿¡æ¯å·²ä¿å­˜: ç”¨æˆ·å={username}, è®°ä½å¯†ç =å¦");
    }
    
    SaveConfiguration();
}
```

##### 4. ç™»å½•çª—ä½“ - åŠ è½½å’Œä¿å­˜

**`BaiShengVx3Plus/Views/LoginForm.cs`**

```csharp
private void LoginForm_Load(object sender, EventArgs e)
{
    // ğŸ”¥ åŠ è½½ä¿å­˜çš„ç™»å½•ä¿¡æ¯
    LoadSavedLoginInfo();
    
    // è®¾ç½®ç„¦ç‚¹
    if (string.IsNullOrEmpty(txtUsername.Text))
        txtUsername.Focus();  // ç”¨æˆ·åä¸ºç©ºï¼Œç„¦ç‚¹åœ¨ç”¨æˆ·å
    else
        txtPassword.Focus();  // ç”¨æˆ·åå·²å¡«å……ï¼Œç„¦ç‚¹åœ¨å¯†ç 
}

/// <summary>
/// åŠ è½½ä¿å­˜çš„ç™»å½•ä¿¡æ¯
/// </summary>
private void LoadSavedLoginInfo()
{
    var configService = Program.ServiceProvider?.GetService<ConfigurationService>();
    if (configService == null) return;
    
    var isRememberPassword = configService.GetIsRememberPassword();
    
    if (isRememberPassword)
    {
        var username = configService.GetBsUserName();
        var password = configService.GetBsUserPassword();  // ğŸ”¥ è‡ªåŠ¨è§£å¯†
        
        // å¡«å……åˆ°ç•Œé¢
        txtUsername.Text = username;
        txtPassword.Text = password;
        chkRememberPassword.Checked = true;
        
        // åŒæ­¥åˆ° ViewModel
        _viewModel.BsUserName = username;
        _viewModel.BsUserPass = password;
        _viewModel.IsRememberPassword = true;
    }
}

// ç™»å½•æˆåŠŸäº‹ä»¶
_viewModel.LoginSucceeded += (s, e) =>
{
    // ğŸ”¥ ä¿å­˜ç™»å½•ä¿¡æ¯ï¼ˆå¦‚æœå‹¾é€‰äº†è®°ä½å¯†ç ï¼‰
    SaveLoginInfo();
    
    DialogResult = DialogResult.OK;
    Close();
};

/// <summary>
/// ä¿å­˜ç™»å½•ä¿¡æ¯ï¼ˆç™»å½•æˆåŠŸåè°ƒç”¨ï¼‰
/// </summary>
private void SaveLoginInfo()
{
    var configService = Program.ServiceProvider?.GetService<ConfigurationService>();
    if (configService == null) return;
    
    configService.SaveLoginInfo(
        txtUsername.Text,
        txtPassword.Text,
        chkRememberPassword.Checked  // ğŸ”¥ æ ¹æ®å¤é€‰æ¡†çŠ¶æ€å†³å®šæ˜¯å¦ä¿å­˜
    );
}
```

---

## ä½¿ç”¨æµç¨‹

### åœºæ™¯1ï¼šé¦–æ¬¡ç™»å½• + è®°ä½å¯†ç 

1. ç”¨æˆ·æ‰“å¼€è½¯ä»¶ï¼Œç™»å½•ç•Œé¢ä¸ºç©º
2. è¾“å…¥ç”¨æˆ·åï¼š`admin`
3. è¾“å…¥å¯†ç ï¼š`123456`
4. âœ… å‹¾é€‰"è®°ä½å¯†ç "
5. ç‚¹å‡»"ç™»å½•"
6. **ç™»å½•æˆåŠŸ**ï¼š
   - è‡ªåŠ¨è°ƒç”¨ `SaveLoginInfo()`
   - å¯†ç åŠ å¯†åä¿å­˜åˆ° `appsettings.json`ï¼š
     ```json
     {
       "BsUserName": "admin",
       "BsUserPwd": "Y3l0cWRkZg==",
       "IsRememberPassword": true
     }
     ```

### åœºæ™¯2ï¼šå†æ¬¡æ‰“å¼€è½¯ä»¶ï¼ˆå·²è®°ä½å¯†ç ï¼‰

1. ç”¨æˆ·æ‰“å¼€è½¯ä»¶
2. ç™»å½•ç•Œé¢è‡ªåŠ¨åŠ è½½ï¼š
   - **ç”¨æˆ·å**ï¼š`admin`ï¼ˆè‡ªåŠ¨å¡«å……ï¼‰
   - **å¯†ç **ï¼š`123456`ï¼ˆè‡ªåŠ¨è§£å¯†å¹¶å¡«å……ï¼‰
   - **è®°ä½å¯†ç **ï¼šâœ… å·²å‹¾é€‰
   - **ç„¦ç‚¹**ï¼šåœ¨å¯†ç æ¡†ï¼ˆæ–¹ä¾¿ç”¨æˆ·ç›´æ¥æŒ‰å›è½¦ç™»å½•ï¼‰
3. ç”¨æˆ·ç›´æ¥ç‚¹å‡»"ç™»å½•"æˆ–æŒ‰å›è½¦
4. **ç™»å½•æˆåŠŸ**

### åœºæ™¯3ï¼šå–æ¶ˆè®°ä½å¯†ç 

1. ç”¨æˆ·æ‰“å¼€è½¯ä»¶ï¼ˆå¯†ç å·²è‡ªåŠ¨å¡«å……ï¼‰
2. âŒ å–æ¶ˆå‹¾é€‰"è®°ä½å¯†ç "
3. ç‚¹å‡»"ç™»å½•"
4. **ç™»å½•æˆåŠŸ**ï¼š
   - è‡ªåŠ¨è°ƒç”¨ `SaveLoginInfo(rememberPassword=false)`
   - æ¸…ç©ºé…ç½®æ–‡ä»¶ä¸­çš„å¯†ç ï¼š
     ```json
     {
       "BsUserName": "admin",
       "BsUserPwd": "",
       "IsRememberPassword": false
     }
     ```
5. **ä¸‹æ¬¡æ‰“å¼€è½¯ä»¶**ï¼š
   - ç”¨æˆ·åè‡ªåŠ¨å¡«å……ï¼š`admin`
   - å¯†ç ä¸ºç©ºï¼ˆéœ€è¦é‡æ–°è¾“å…¥ï¼‰

---

## å®‰å…¨æ€§è¯´æ˜

### åŠ å¯†å¼ºåº¦
- âœ… **é˜²æ˜æ–‡æ³„éœ²**ï¼šé…ç½®æ–‡ä»¶ä¸­ä¸ä¼šå‡ºç°æ˜æ–‡å¯†ç 
- âœ… **é˜²ç®€å•æŸ¥çœ‹**ï¼šBase64ç¼–ç åçš„å­—ç¬¦ä¸²ä¸å¯ç›´æ¥è¯†åˆ«
- âš ï¸ **ç®€å•åŠ å¯†**ï¼šä½¿ç”¨XOR + Base64ï¼Œé€‚åˆä¸ªäººä½¿ç”¨ï¼Œä¸é€‚åˆé«˜å®‰å…¨åœºæ™¯
- âš ï¸ **å¯†é’¥å›ºå®š**ï¼šSaltå¯†é’¥ç¡¬ç¼–ç åœ¨ä»£ç ä¸­ï¼Œå¯è¢«é€†å‘åˆ†æ

### é€‚ç”¨åœºæ™¯
- âœ… ä¸ªäººç”µè„‘ï¼Œæœ¬åœ°ä½¿ç”¨
- âœ… é˜²æ­¢ä»–äººéšæ„æŸ¥çœ‹å¯†ç 
- âŒ ä¸é€‚åˆå¤šç”¨æˆ·å…±äº«ç”µè„‘
- âŒ ä¸é€‚åˆé«˜å®‰å…¨è¦æ±‚çš„ç”Ÿäº§ç¯å¢ƒ

### æå‡å®‰å…¨æ€§ï¼ˆå¯é€‰ï¼‰
å¦‚æœéœ€è¦æ›´é«˜å®‰å…¨æ€§ï¼Œå¯ä»¥è€ƒè™‘ï¼š
1. ä½¿ç”¨ Windows Data Protection API (DPAPI)
2. ä½¿ç”¨ AES åŠ å¯† + åŠ¨æ€å¯†é’¥
3. ä½¿ç”¨ç¡¬ä»¶åŠ å¯†ï¼ˆTPMï¼‰
4. ä½¿ç”¨ Windows Credential Manager

---

## æµ‹è¯•éªŒè¯

### æµ‹è¯•1ï¼šé¦–æ¬¡ç™»å½•å¹¶è®°ä½å¯†ç 
1. åˆ é™¤ `appsettings.json`ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
2. å¯åŠ¨ç¨‹åº
3. ç™»å½•ç•Œé¢ï¼šè¾“å…¥è´¦å·å¯†ç ï¼Œå‹¾é€‰"è®°ä½å¯†ç "
4. ç™»å½•æˆåŠŸ
5. **éªŒè¯**ï¼šæ‰“å¼€ `appsettings.json`ï¼Œæ£€æŸ¥ï¼š
   - `BsUserName` = è¾“å…¥çš„ç”¨æˆ·å
   - `BsUserPwd` = åŠ å¯†åçš„å­—ç¬¦ä¸²ï¼ˆä¸æ˜¯æ˜æ–‡ï¼‰
   - `IsRememberPassword` = true

### æµ‹è¯•2ï¼šå†æ¬¡æ‰“å¼€ï¼Œè‡ªåŠ¨å¡«å……
1. å…³é—­ç¨‹åº
2. é‡æ–°å¯åŠ¨ç¨‹åº
3. **éªŒè¯**ï¼š
   - ç”¨æˆ·åå·²è‡ªåŠ¨å¡«å……
   - å¯†ç å·²è‡ªåŠ¨å¡«å……
   - "è®°ä½å¯†ç "å·²å‹¾é€‰
   - ç„¦ç‚¹åœ¨å¯†ç æ¡†

### æµ‹è¯•3ï¼šå–æ¶ˆè®°ä½å¯†ç 
1. ç™»å½•ç•Œé¢ï¼šå–æ¶ˆå‹¾é€‰"è®°ä½å¯†ç "
2. ç™»å½•æˆåŠŸ
3. **éªŒè¯**ï¼šæ‰“å¼€ `appsettings.json`ï¼Œæ£€æŸ¥ï¼š
   - `BsUserName` = ç”¨æˆ·åï¼ˆä¿ç•™ï¼‰
   - `BsUserPwd` = ""ï¼ˆå·²æ¸…ç©ºï¼‰
   - `IsRememberPassword` = false
4. å…³é—­å¹¶é‡æ–°æ‰“å¼€ç¨‹åº
5. **éªŒè¯**ï¼š
   - ç”¨æˆ·åå·²å¡«å……
   - å¯†ç ä¸ºç©º

---

## ä¿®æ”¹æ–‡ä»¶æ¸…å•

1. **`BaiShengVx3Plus/Models/AppConfiguration.cs`**
   - æ·»åŠ  `IsRememberPassword` å±æ€§

2. **`BaiShengVx3Plus/Utils/PasswordHelper.cs`** (æ–°å»º)
   - åŠ å¯†å·¥å…·ç±»

3. **`BaiShengVx3Plus/Services/Configuration/ConfigurationService.cs`**
   - `GetBsUserName()` - è·å–ç”¨æˆ·å
   - `GetBsUserPassword()` - è·å–å¯†ç ï¼ˆè‡ªåŠ¨è§£å¯†ï¼‰
   - `GetIsRememberPassword()` - è·å–æ˜¯å¦è®°ä½å¯†ç 
   - `SaveLoginInfo()` - ä¿å­˜ç™»å½•ä¿¡æ¯ï¼ˆè‡ªåŠ¨åŠ å¯†ï¼‰
   - `ClearLoginInfo()` - æ¸…é™¤ç™»å½•ä¿¡æ¯

4. **`BaiShengVx3Plus/Views/LoginForm.cs`**
   - `LoadSavedLoginInfo()` - çª—ä½“åŠ è½½æ—¶è¯»å–é…ç½®
   - `SaveLoginInfo()` - ç™»å½•æˆåŠŸæ—¶ä¿å­˜é…ç½®
   - ç™»å½•æˆåŠŸäº‹ä»¶ï¼šè°ƒç”¨ `SaveLoginInfo()`

5. **`BaiShengVx3Plus/Views/VxMain.cs`**
   - `BetRecordService` ä½¿ç”¨å…¨å±€æ•°æ®åº“ï¼ˆ`_globalDb`ï¼‰

---

## æ€»ç»“

### æŠ•æ³¨æ•°æ®åº“ä¿®å¤
- âœ… `BetRecordService` ä¸å†ä¾èµ–å¾®ä¿¡ç»‘å®š
- âœ… ä½¿ç”¨å…¨å±€æ•°æ®åº“ï¼Œå§‹ç»ˆå¯ç”¨
- âœ… æŠ•æ³¨åŠŸèƒ½æ— éœ€ç»‘å®šå¾®ä¿¡å³å¯ä½¿ç”¨

### è®°ä½å¯†ç åŠŸèƒ½
- âœ… å¯†ç åŠ å¯†å­˜å‚¨ï¼ˆBase64 + XORï¼‰
- âœ… è‡ªåŠ¨å¡«å……ç”¨æˆ·åå’Œå¯†ç 
- âœ… æ”¯æŒè®°ä½/ä¸è®°ä½å¯†ç åˆ‡æ¢
- âœ… ç„¦ç‚¹æ™ºèƒ½å®šä½ï¼ˆç”¨æˆ·å/å¯†ç ï¼‰
- âœ… é…ç½®æ–‡ä»¶ä¸­çœ‹ä¸åˆ°æ˜æ–‡å¯†ç 

### ä½¿ç”¨å»ºè®®
1. **å…³é—­ä¸»ç¨‹åº**åå†é‡æ–°ç¼–è¯‘ï¼ˆé¿å…æ–‡ä»¶å ç”¨ï¼‰
2. **æµ‹è¯•è®°ä½å¯†ç **ï¼šå…ˆç™»å½•ä¸€æ¬¡å¹¶å‹¾é€‰ï¼Œç„¶åé‡æ–°æ‰“å¼€éªŒè¯
3. **æµ‹è¯•æŠ•æ³¨åŠŸèƒ½**ï¼šæ— éœ€ç»‘å®šå¾®ä¿¡ï¼Œç›´æ¥åœ¨é…ç½®ç®¡ç†å™¨ä¸­æµ‹è¯•æŠ•æ³¨å‘½ä»¤

