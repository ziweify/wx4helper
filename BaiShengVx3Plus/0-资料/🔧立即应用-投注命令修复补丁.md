# ğŸ”§ æŠ•æ³¨å‘½ä»¤ä¿®å¤è¡¥ä¸

**é€‚ç”¨æ–‡ä»¶ï¼š** `BaiShengVx3Plus/Views/AutoBet/BetConfigManagerForm.cs`

---

## ğŸ“ éœ€è¦æ·»åŠ çš„æ–¹æ³•

### æ–¹æ³•1ï¼šParseBetContentï¼ˆè§£ææŠ•æ³¨å†…å®¹ï¼‰

```csharp
/// <summary>
/// è§£ææŠ•æ³¨å†…å®¹ï¼š"1234å¤§10" â†’ "1å¤§10,2å¤§10,3å¤§10,4å¤§10"
/// </summary>
private string ParseBetContent(string input)
{
    try
    {
        var items = new List<string>();
        
        // æŒ‰ç©ºæ ¼æˆ–é€—å·åˆ†å‰²
        var parts = input.Split(new[] { ' ', ',' }, StringSplitOptions.RemoveEmptyEntries);
        
        foreach (var part in parts)
        {
            var trimmed = part.Trim();
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«è¿ç»­æ•°å­—ï¼ˆå¦‚ï¼š"1234å¤§20"ï¼‰
            var match = System.Text.RegularExpressions.Regex.Match(
                trimmed, 
                @"^(\d+)(å¤§|å°|å•|åŒ)(\d+)$"
            );
            
            if (match.Success)
            {
                var numbers = match.Groups[1].Value;  // "1234"
                var type = match.Groups[2].Value;      // "å¤§"
                var amount = match.Groups[3].Value;    // "10"
                
                // æ‹†åˆ†ä¸ºå•ä¸ªæŠ•æ³¨
                foreach (var num in numbers)
                {
                    items.Add($"{num}{type}{amount}");
                }
            }
            else
            {
                // å·²ç»æ˜¯æ ‡å‡†æ ¼å¼æˆ–æ— æ³•è§£æï¼Œç›´æ¥æ·»åŠ 
                items.Add(trimmed);
            }
        }
        
        return string.Join(",", items);
    }
    catch (Exception ex)
    {
        _logService.Error("CommandPanel", "è§£ææŠ•æ³¨å†…å®¹å¤±è´¥", ex);
        return input; // è§£æå¤±è´¥è¿”å›åŸå†…å®¹
    }
}
```

### æ–¹æ³•2ï¼šCalculateTotalAmountï¼ˆè®¡ç®—æ€»é‡‘é¢ï¼‰

```csharp
/// <summary>
/// è®¡ç®—æ€»é‡‘é¢ï¼š"1å¤§10,2å¤§20" â†’ 30
/// </summary>
private decimal CalculateTotalAmount(string standardContent)
{
    try
    {
        decimal total = 0;
        var items = standardContent.Split(',');
        
        foreach (var item in items)
        {
            var match = System.Text.RegularExpressions.Regex.Match(item, @"(\d+)$");
            if (match.Success && decimal.TryParse(match.Groups[1].Value, out var amount))
            {
                total += amount;
            }
        }
        
        return total;
    }
    catch
    {
        return 0;
    }
}
```

---

## ğŸ”„ éœ€è¦æ›¿æ¢çš„ä»£ç 

### åŸä»£ç ï¼ˆLine 650-660ï¼‰

```csharp
case "æŠ•æ³¨":
    // TODO: è§£ææŠ•æ³¨å†…å®¹ï¼Œç”ŸæˆBetRecordï¼Œå‘é€æŠ•æ³¨å‘½ä»¤
    // è¿™é‡Œéœ€è¦å½“å‰æœŸå·ï¼Œæš‚æ—¶ä½¿ç”¨0
    var betResult = await autoBetService.SendBetCommandAsync(_selectedConfig.Id, "0", cmdParam);
    return new CommandResponse
    {
        Success = betResult.Success,
        Message = betResult.ErrorMessage ?? "æŠ•æ³¨å®Œæˆ",
        Data = betResult,
        ErrorMessage = betResult.ErrorMessage
    };
```

### æ–°ä»£ç ï¼ˆå®Œæ•´å®ç°ï¼‰

```csharp
case "æŠ•æ³¨":
    // 1. è·å–å½“å‰æœŸå·
    var lotteryService = Program.ServiceProvider.GetService(typeof(Contracts.Games.IBinggoLotteryService)) 
        as Contracts.Games.IBinggoLotteryService;
    var currentIssueId = lotteryService?.CurrentIssueId ?? 0;
    
    if (currentIssueId == 0)
    {
        _logService.Warning("CommandPanel", "æ— æ³•è·å–å½“å‰æœŸå·ï¼Œå°†ä½¿ç”¨æœŸå·0");
    }
    
    // 2. è§£ææŠ•æ³¨å†…å®¹
    var originalContent = cmdParam; // "1234å¤§10"
    var standardContent = ParseBetContent(originalContent); // "1å¤§10,2å¤§10,3å¤§10,4å¤§10"
    var totalAmount = CalculateTotalAmount(standardContent);
    
    _logService.Info("CommandPanel", $"æŠ•æ³¨è§£æ:åŸå§‹={originalContent} æ ‡å‡†={standardContent} é‡‘é¢={totalAmount}");
    
    // 3. ç”ŸæˆBetRecord
    var betRecordService = Program.ServiceProvider.GetService(typeof(Services.AutoBet.BetRecordService)) 
        as Services.AutoBet.BetRecordService;
    
    if (betRecordService == null)
    {
        return new CommandResponse 
        { 
            Success = false, 
            Message = "BetRecordServiceæœªåˆå§‹åŒ–" 
        };
    }
    
    var betRecord = new Models.AutoBet.BetRecord
    {
        ConfigId = _selectedConfig.Id,
        IssueId = currentIssueId,
        Source = Models.AutoBet.BetRecordSource.å‘½ä»¤, // æ‰‹åŠ¨å‘½ä»¤
        OrderIds = "", // æ‰‹åŠ¨æŠ•æ³¨æ— å…³è”è®¢å•
        BetContentStandard = standardContent,
        TotalAmount = totalAmount,
        SendTime = DateTime.Now
    };
    
    betRecord = betRecordService.Create(betRecord);
    _logService.Info("CommandPanel", $"BetRecordå·²åˆ›å»º:ID={betRecord.Id}");
    
    // 4. å‘é€æŠ•æ³¨å‘½ä»¤
    var betResult = await autoBetService.SendBetCommandAsync(
        _selectedConfig.Id, 
        currentIssueId.ToString(), 
        standardContent
    );
    
    // 5. æ›´æ–°BetRecord
    betRecord.Success = betResult.Success;
    betRecord.PostStartTime = betResult.PostStartTime;
    betRecord.PostEndTime = betResult.PostEndTime;
    betRecord.DurationMs = betResult.DurationMs;
    betRecord.Result = betResult.Result;
    betRecord.ErrorMessage = betResult.ErrorMessage;
    betRecord.OrderNo = betResult.OrderNo;
    betRecordService.Update(betRecord);
    
    _logService.Info("CommandPanel", $"BetRecordå·²æ›´æ–°:æˆåŠŸ={betRecord.Success}");
    
    return new CommandResponse
    {
        Success = betResult.Success,
        Message = betResult.ErrorMessage ?? (betResult.Success ? "æŠ•æ³¨æˆåŠŸ" : "æŠ•æ³¨å¤±è´¥"),
        Data = new 
        {
            betRecordId = betRecord.Id,
            issueId = currentIssueId,
            originalContent = originalContent,
            standardContent = standardContent,
            totalAmount = totalAmount,
            betResult
        },
        ErrorMessage = betResult.ErrorMessage
    };
```

---

## ğŸ“ æ’å…¥ä½ç½®

åœ¨ `BetConfigManagerForm.cs` çš„ `#endregion` å‰é¢ï¼ˆçº¦åœ¨Line 726ä¹‹å‰ï¼‰æ·»åŠ ä¸¤ä¸ªæ–°æ–¹æ³•ã€‚

æ›¿æ¢ Line 650-660 çš„æŠ•æ³¨å‘½ä»¤å¤„ç†ä»£ç ã€‚

---

## âœ… ä¿®å¤åæ•ˆæœ

**è¾“å…¥å‘½ä»¤ï¼š** `æŠ•æ³¨(1234å¤§10)`

**æ‰§è¡Œç»“æœï¼š**
```
ğŸ“¤ å‘é€å‘½ä»¤:æŠ•æ³¨(1234å¤§10)
   æ—¶é—´:2025-11-08 13:18:08.262
ğŸ“ å‘½ä»¤:æŠ•æ³¨
   å‚æ•°:1234å¤§10
ğŸ“Š è§£æç»“æœ:
   åŸå§‹:1234å¤§10
   æ ‡å‡†:1å¤§10,2å¤§10,3å¤§10,4å¤§10
   é‡‘é¢:40å…ƒ
ğŸ“ BetRecordå·²åˆ›å»º:ID=1
âœ… è¿”å›:æˆåŠŸ=True
   æ¶ˆæ¯:æŠ•æ³¨æˆåŠŸ
   æ•°æ®:{
     "betRecordId": 1,
     "issueId": 114063156,
     "originalContent": "1234å¤§10",
     "standardContent": "1å¤§10,2å¤§10,3å¤§10,4å¤§10",
     "totalAmount": 40,
     "betResult": {
       "success": true,
       "postStartTime": "2025-11-08 13:18:08.500",
       "postEndTime": "2025-11-08 13:18:08.625",
       "durationMs": 125,
       "orderNo": "ORD123456"
     }
   }
```

---

**ç«‹å³åº”ç”¨è¿™äº›ä¿®æ”¹å—ï¼Ÿ** ğŸš€

