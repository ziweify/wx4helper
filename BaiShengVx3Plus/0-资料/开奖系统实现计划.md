# ğŸš€ å¼€å¥–ç³»ç»Ÿå®ç°è®¡åˆ’

## ğŸ“‹ å®ç°ä¼˜å…ˆçº§

æ ¹æ®æ‚¨çš„éœ€æ±‚ï¼Œæˆ‘å»ºè®®æŒ‰ä»¥ä¸‹é¡ºåºå®ç°ï¼š

### ğŸ”¥ **ä¼˜å…ˆçº§ P0**ï¼šæ ¸å¿ƒåŸºç¡€ (å¿…é¡»å…ˆå®Œæˆ)
1. âœ… ç™»å½•è®¤è¯æ¨¡å—
2. âœ… WebAPI å®¢æˆ·ç«¯å°è£…
3. âœ… å¼€å¥–æœåŠ¡æ ¸å¿ƒé€»è¾‘

### ğŸ”¥ **ä¼˜å…ˆçº§ P1**ï¼šä¸šåŠ¡é€»è¾‘ (ç´§æ¥ç€)
4. âœ… è®¢å•å¤„ç†æœåŠ¡
5. âœ… ä¸‹æ³¨è§£æå™¨
6. âœ… æ¶ˆæ¯é›†æˆ

### ğŸ”¥ **ä¼˜å…ˆçº§ P2**ï¼šUI å’Œé…ç½® (ä¸šåŠ¡é€»è¾‘å®Œæˆå)
7. âœ… UI ç”¨æˆ·æ§ä»¶
8. âœ… é…ç½®ç®¡ç†
9. âœ… ç®¡ç†åŠŸèƒ½

---

## ğŸ“‚ æ–‡ä»¶ç»“æ„è§„åˆ’

```
BaiShengVx3Plus/
â”œâ”€â”€ Contracts/
â”‚   â”œâ”€â”€ ILotteryAuthService.cs          âœ… P0
â”‚   â”œâ”€â”€ ILotteryService.cs              âœ… P0
â”‚   â”œâ”€â”€ IOrderService.cs                âœ… P1
â”‚   â”œâ”€â”€ ILotteryWebApi.cs               âœ… P0
â”‚   â””â”€â”€ ISettingsService.cs             âœ… P2
â”‚
â”œâ”€â”€ Models/
â”‚   â”œâ”€â”€ Lottery/
â”‚   â”‚   â”œâ”€â”€ LotteryUser.cs              âœ… P0 (ç”¨æˆ·ä¿¡æ¯)
â”‚   â”‚   â”œâ”€â”€ BgLotteryData.cs            âœ… P0 (å¼€å¥–æ•°æ®)
â”‚   â”‚   â”œâ”€â”€ LotterySettings.cs          âœ… P2 (é…ç½®)
â”‚   â”‚   â”œâ”€â”€ LotteryStatus.cs            âœ… P0 (çŠ¶æ€æšä¸¾)
â”‚   â”‚   â””â”€â”€ BetContent.cs               âœ… P1 (ä¸‹æ³¨å†…å®¹)
â”‚   â””â”€â”€ Events/
â”‚       â”œâ”€â”€ IssueChangedEventArgs.cs    âœ… P0
â”‚       â”œâ”€â”€ StatusChangedEventArgs.cs   âœ… P0
â”‚       â”œâ”€â”€ CountdownEventArgs.cs       âœ… P0
â”‚       â””â”€â”€ LotteryOpenedEventArgs.cs   âœ… P0
â”‚
â”œâ”€â”€ Services/
â”‚   â”œâ”€â”€ Lottery/
â”‚   â”‚   â”œâ”€â”€ LotteryAuthService.cs       âœ… P0 (ç™»å½•è®¤è¯)
â”‚   â”‚   â”œâ”€â”€ LotteryService.cs           âœ… P0 (å¼€å¥–æœåŠ¡)
â”‚   â”‚   â””â”€â”€ LotteryWebApiClient.cs      âœ… P0 (WebAPI å®¢æˆ·ç«¯)
â”‚   â”œâ”€â”€ Order/
â”‚   â”‚   â”œâ”€â”€ OrderService.cs             âœ… P1 (è®¢å•æœåŠ¡)
â”‚   â”‚   â””â”€â”€ OrderValidator.cs           âœ… P1 (è®¢å•éªŒè¯)
â”‚   â”œâ”€â”€ Settings/
â”‚   â”‚   â””â”€â”€ SettingsService.cs          âœ… P2 (é…ç½®ç®¡ç†)
â”‚   â””â”€â”€ Messages/Handlers/
â”‚       â””â”€â”€ LotteryMessageHandler.cs    âœ… P1 (æ¶ˆæ¯å¤„ç†)
â”‚
â”œâ”€â”€ Helpers/
â”‚   â””â”€â”€ BinGouHelper.cs                 âœ… P1 (ä¸‹æ³¨è§£æ)
â”‚
â”œâ”€â”€ Core/
â”‚   â””â”€â”€ BgLotteryDataBindingList.cs     âœ… P0 (ORM BindingList)
â”‚
â””â”€â”€ Views/
    â””â”€â”€ Controls/
        â”œâ”€â”€ UcLotteryDataCur.cs         âœ… P2 (å½“å‰æœŸæ§ä»¶)
        â”œâ”€â”€ UcLotteryDataLast.cs        âœ… P2 (ä¸ŠæœŸæ§ä»¶)
        â””â”€â”€ UcLotterySettings.cs        âœ… P2 (é…ç½®æ§ä»¶)
```

---

## ğŸ¯ Phase 1: æ ¸å¿ƒåŸºç¡€ (P0)

### 1.1 åˆ›å»ºæ¨¡å‹å’Œæšä¸¾

```csharp
// Models/Lottery/LotteryStatus.cs
public enum LotteryStatus
{
    ç­‰å¾…ä¸­ = 0,
    å¼€ç›˜ä¸­ = 1,
    å°ç›˜ä¸­ = 2,
    å¼€å¥–ä¸­ = 3
}

// Models/Lottery/LotteryUser.cs
public class LotteryUser
{
    public string Name { get; set; }
    public string Password { get; set; }
    public string Token { get; set; }
    public DateTime TokenExpiry { get; set; }
    public DateTime OfflineTime { get; set; }  // è´¦å·æœ‰æ•ˆæœŸ
}

// Models/Lottery/BgLotteryData.cs
[Table("BgLotteryData")]
public class BgLotteryData : INotifyPropertyChanged
{
    [PrimaryKey, AutoIncrement]
    public int Id { get; set; }
    
    [Indexed]
    public int IssueId { get; set; }  // æœŸå·ï¼šä¾‹å¦‚ 20251106001
    
    public string NumbersString { get; set; }  // "1,2,3,4,5"
    
    [Ignore]
    public int[] Numbers => ParseNumbers(NumbersString);
    
    public int P1 => Numbers.Length > 0 ? Numbers[0] : 0;
    public int P2 => Numbers.Length > 1 ? Numbers[1] : 0;
    public int P3 => Numbers.Length > 2 ? Numbers[2] : 0;
    public int P4 => Numbers.Length > 3 ? Numbers[3] : 0;
    public int P5 => Numbers.Length > 4 ? Numbers[4] : 0;
    
    public int Sum => P1 + P2 + P3 + P4 + P5;
    public string BigSmall => Sum >= 15 ? "å¤§" : "å°";
    public string OddEven => Sum % 2 == 0 ? "åŒ" : "å•";
    public string DragonTiger => P1 > P5 ? "é¾™" : "è™";
    
    public DateTime IssueStartTime { get; set; }
    public DateTime? OpenTime { get; set; }
    
    private int[] ParseNumbers(string numbersString)
    {
        if (string.IsNullOrEmpty(numbersString))
            return new int[0];
        return numbersString.Split(',').Select(int.Parse).ToArray();
    }
    
    public event PropertyChangedEventHandler PropertyChanged;
}

// Models/Events/IssueChangedEventArgs.cs
public class IssueChangedEventArgs : EventArgs
{
    public int OldIssueId { get; set; }
    public int NewIssueId { get; set; }
    public BgLotteryData LastLotteryData { get; set; }
}

// Models/Events/StatusChangedEventArgs.cs
public class StatusChangedEventArgs : EventArgs
{
    public LotteryStatus OldStatus { get; set; }
    public LotteryStatus NewStatus { get; set; }
    public int IssueId { get; set; }
    public BgLotteryData Data { get; set; }
}

// Models/Events/CountdownEventArgs.cs
public class CountdownEventArgs : EventArgs
{
    public int Seconds { get; set; }
    public int IssueId { get; set; }
}

// Models/Events/LotteryOpenedEventArgs.cs
public class LotteryOpenedEventArgs : EventArgs
{
    public BgLotteryData LotteryData { get; set; }
}
```

### 1.2 åˆ›å»ºæ¥å£

```csharp
// Contracts/ILotteryAuthService.cs
public interface ILotteryAuthService
{
    bool IsAuthenticated { get; }
    LotteryUser CurrentUser { get; }
    
    Task<bool> LoginAsync(string username, string password);
    void Logout();
    string GetLastError();
}

// Contracts/ILotteryWebApi.cs
public interface ILotteryWebApi
{
    Task<LotteryApiResponse<LotteryUser>> LoginAsync(string username, string password);
    Task<BgLotteryData> GetCurrentLotteryDataAsync();
    Task<BgLotteryData> GetLotteryDataAsync(int issueId);
    Task<List<BgLotteryData>> GetLotteryDataListAsync(DateTime date);
}

// Contracts/ILotteryService.cs
public interface ILotteryService
{
    // å±æ€§
    int CurrentIssueId { get; }
    LotteryStatus CurrentStatus { get; }
    int SecondsToSeal { get; }
    bool IsRunning { get; }
    
    // æ–¹æ³•
    Task StartAsync();
    Task StopAsync();
    
    // äº‹ä»¶
    event EventHandler<IssueChangedEventArgs> IssueChanged;
    event EventHandler<StatusChangedEventArgs> StatusChanged;
    event EventHandler<CountdownEventArgs> CountdownTick;
    event EventHandler<LotteryOpenedEventArgs> LotteryOpened;
}
```

### 1.3 å®ç° WebAPI å®¢æˆ·ç«¯

```csharp
// Services/Lottery/LotteryWebApiClient.cs
public class LotteryWebApiClient : ILotteryWebApi
{
    private readonly HttpClient _httpClient;
    private readonly ILogService _logService;
    private string _baseUrl = "http://your-api-server.com/api/";
    
    public LotteryWebApiClient(ILogService logService)
    {
        _logService = logService;
        _httpClient = new HttpClient { Timeout = TimeSpan.FromSeconds(10) };
    }
    
    public async Task<LotteryApiResponse<LotteryUser>> LoginAsync(string username, string password)
    {
        try
        {
            var request = new { username, password };
            var json = JsonSerializer.Serialize(request);
            var content = new StringContent(json, Encoding.UTF8, "application/json");
            
            var response = await _httpClient.PostAsync($"{_baseUrl}login", content);
            var responseJson = await response.Content.ReadAsStringAsync();
            
            var apiResponse = JsonSerializer.Deserialize<LotteryApiResponse<LotteryUser>>(responseJson);
            return apiResponse;
        }
        catch (Exception ex)
        {
            _logService.Error("LotteryWebApi", $"ç™»å½•å¤±è´¥: {ex.Message}", ex);
            return new LotteryApiResponse<LotteryUser> { Code = -1, Message = ex.Message };
        }
    }
    
    public async Task<BgLotteryData> GetCurrentLotteryDataAsync()
    {
        try
        {
            var response = await _httpClient.GetAsync($"{_baseUrl}lottery/current");
            var json = await response.Content.ReadAsStringAsync();
            var data = JsonSerializer.Deserialize<BgLotteryData>(json);
            return data;
        }
        catch (Exception ex)
        {
            _logService.Error("LotteryWebApi", $"è·å–å½“å‰æœŸæ•°æ®å¤±è´¥: {ex.Message}", ex);
            return null;
        }
    }
    
    public async Task<BgLotteryData> GetLotteryDataAsync(int issueId)
    {
        try
        {
            var response = await _httpClient.GetAsync($"{_baseUrl}lottery/{issueId}");
            var json = await response.Content.ReadAsStringAsync();
            var data = JsonSerializer.Deserialize<BgLotteryData>(json);
            return data;
        }
        catch (Exception ex)
        {
            _logService.Error("LotteryWebApi", $"è·å–æœŸå· {issueId} æ•°æ®å¤±è´¥: {ex.Message}", ex);
            return null;
        }
    }
}

// è¾…åŠ©ç±»
public class LotteryApiResponse<T>
{
    [JsonPropertyName("code")]
    public int Code { get; set; }
    
    [JsonPropertyName("msg")]
    public string Message { get; set; }
    
    [JsonPropertyName("data")]
    public T Data { get; set; }
}
```

### 1.4 å®ç°ç™»å½•è®¤è¯æœåŠ¡

```csharp
// Services/Lottery/LotteryAuthService.cs
public class LotteryAuthService : ILotteryAuthService
{
    private readonly ILotteryWebApi _webApi;
    private readonly ILogService _logService;
    private LotteryUser _currentUser;
    private bool _isAuthenticated;
    private string _lastError;
    
    public LotteryAuthService(ILotteryWebApi webApi, ILogService logService)
    {
        _webApi = webApi;
        _logService = logService;
    }
    
    public bool IsAuthenticated => _isAuthenticated;
    public LotteryUser CurrentUser => _currentUser;
    
    public async Task<bool> LoginAsync(string username, string password)
    {
        try
        {
            _logService.Info("LotteryAuth", $"å¼€å§‹ç™»å½•: {username}");
            
            var response = await _webApi.LoginAsync(username, password);
            
            if (response.Code == 0 && response.Data != null)
            {
                _currentUser = response.Data;
                _currentUser.Name = username;
                _currentUser.Password = password;
                _isAuthenticated = true;
                
                _logService.Info("LotteryAuth", $"ç™»å½•æˆåŠŸ: {username}, æœ‰æ•ˆæœŸ: {_currentUser.OfflineTime}");
                return true;
            }
            
            _lastError = response.Message ?? "ç™»å½•å¤±è´¥";
            _logService.Warning("LotteryAuth", $"ç™»å½•å¤±è´¥: {_lastError}");
            return false;
        }
        catch (Exception ex)
        {
            _lastError = $"ç™»å½•å¼‚å¸¸: {ex.Message}";
            _logService.Error("LotteryAuth", _lastError, ex);
            return false;
        }
    }
    
    public void Logout()
    {
        _logService.Info("LotteryAuth", $"ç”¨æˆ·ç™»å‡º: {_currentUser?.Name}");
        _currentUser = null;
        _isAuthenticated = false;
    }
    
    public string GetLastError() => _lastError;
}
```

### 1.5 å®ç°å¼€å¥–æœåŠ¡

```csharp
// Services/Lottery/LotteryService.cs
public class LotteryService : ILotteryService
{
    private readonly ILotteryWebApi _webApi;
    private readonly ILogService _logService;
    private System.Threading.Timer _timer;
    
    private int _currentIssueId;
    private LotteryStatus _currentStatus = LotteryStatus.ç­‰å¾…ä¸­;
    private int _secondsToSeal;
    private bool _isRunning;
    private readonly object _lock = new object();
    
    // äº‹ä»¶
    public event EventHandler<IssueChangedEventArgs> IssueChanged;
    public event EventHandler<StatusChangedEventArgs> StatusChanged;
    public event EventHandler<CountdownEventArgs> CountdownTick;
    public event EventHandler<LotteryOpenedEventArgs> LotteryOpened;
    
    // å±æ€§
    public int CurrentIssueId => _currentIssueId;
    public LotteryStatus CurrentStatus => _currentStatus;
    public int SecondsToSeal => _secondsToSeal;
    public bool IsRunning => _isRunning;
    
    public LotteryService(ILotteryWebApi webApi, ILogService logService)
    {
        _webApi = webApi;
        _logService = logService;
    }
    
    public async Task StartAsync()
    {
        if (_isRunning)
        {
            _logService.Warning("LotteryService", "æœåŠ¡å·²åœ¨è¿è¡Œä¸­");
            return;
        }
        
        _logService.Info("LotteryService", "å¼€å¥–æœåŠ¡å¯åŠ¨");
        _isRunning = true;
        
        // ç«‹å³æ‰§è¡Œä¸€æ¬¡
        await OnTimerTickAsync();
        
        // å¯åŠ¨å®šæ—¶å™¨ (æ¯ 1 ç§’)
        _timer = new System.Threading.Timer(
            callback: async _ => await OnTimerTickAsync(),
            state: null,
            dueTime: TimeSpan.FromSeconds(1),
            period: TimeSpan.FromSeconds(1)
        );
    }
    
    public Task StopAsync()
    {
        _logService.Info("LotteryService", "å¼€å¥–æœåŠ¡åœæ­¢");
        _isRunning = false;
        _timer?.Dispose();
        _timer = null;
        return Task.CompletedTask;
    }
    
    private async Task OnTimerTickAsync()
    {
        try
        {
            // ğŸ”¥ æ­¥éª¤1: è·å–æœ€æ–°æ•°æ®
            var data = await _webApi.GetCurrentLotteryDataAsync();
            if (data == null)
            {
                _logService.Warning("LotteryService", "è·å–å½“å‰æœŸæ•°æ®å¤±è´¥");
                return;
            }
            
            lock (_lock)
            {
                // ğŸ”¥ æ­¥éª¤2: æ£€æŸ¥æœŸå·å˜æ›´
                if (data.IssueId != _currentIssueId && _currentIssueId != 0)
                {
                    OnIssueChanged(data);
                }
                
                _currentIssueId = data.IssueId;
                
                // ğŸ”¥ æ­¥éª¤3: è®¡ç®—å€’è®¡æ—¶
                _secondsToSeal = CalculateSecondsToSeal(data);
                
                // ğŸ”¥ æ­¥éª¤4: æ£€æŸ¥çŠ¶æ€å˜æ›´
                CheckStatusChange(data);
                
                // ğŸ”¥ æ­¥éª¤5: è§¦å‘å€’è®¡æ—¶äº‹ä»¶
                CountdownTick?.Invoke(this, new CountdownEventArgs
                {
                    Seconds = _secondsToSeal,
                    IssueId = _currentIssueId
                });
            }
        }
        catch (Exception ex)
        {
            _logService.Error("LotteryService", $"å®šæ—¶å™¨æ‰§è¡Œå¼‚å¸¸: {ex.Message}", ex);
        }
    }
    
    private void OnIssueChanged(BgLotteryData newData)
    {
        _logService.Info("LotteryService", $"æœŸå·å˜æ›´: {_currentIssueId} â†’ {newData.IssueId}");
        
        // è·å–ä¸ŠæœŸå¼€å¥–æ•°æ®
        var lastData = _webApi.GetLotteryDataAsync(_currentIssueId).Result;
        
        // è§¦å‘æœŸå·å˜æ›´äº‹ä»¶
        IssueChanged?.Invoke(this, new IssueChangedEventArgs
        {
            OldIssueId = _currentIssueId,
            NewIssueId = newData.IssueId,
            LastLotteryData = lastData
        });
        
        // é‡ç½®çŠ¶æ€
        var oldStatus = _currentStatus;
        _currentStatus = LotteryStatus.å¼€ç›˜ä¸­;
        
        StatusChanged?.Invoke(this, new StatusChangedEventArgs
        {
            OldStatus = oldStatus,
            NewStatus = LotteryStatus.å¼€ç›˜ä¸­,
            IssueId = newData.IssueId,
            Data = newData
        });
    }
    
    private void CheckStatusChange(BgLotteryData data)
    {
        var oldStatus = _currentStatus;
        
        // æ£€æŸ¥å°ç›˜
        if (_secondsToSeal <= 0 && _currentStatus == LotteryStatus.å¼€ç›˜ä¸­)
        {
            _currentStatus = LotteryStatus.å°ç›˜ä¸­;
            _logService.Info("LotteryService", $"çŠ¶æ€å˜æ›´: å¼€ç›˜ä¸­ â†’ å°ç›˜ä¸­, æœŸå·: {_currentIssueId}");
            
            StatusChanged?.Invoke(this, new StatusChangedEventArgs
            {
                OldStatus = oldStatus,
                NewStatus = LotteryStatus.å°ç›˜ä¸­,
                IssueId = _currentIssueId,
                Data = data
            });
        }
        
        // æ£€æŸ¥å¼€å¥–
        if (!string.IsNullOrEmpty(data.NumbersString) && _currentStatus != LotteryStatus.å¼€å¥–ä¸­)
        {
            _currentStatus = LotteryStatus.å¼€å¥–ä¸­;
            _logService.Info("LotteryService", $"å¼€å¥–æ•°æ®åˆ°è¾¾: {data.IssueId} - {data.NumbersString}");
            
            LotteryOpened?.Invoke(this, new LotteryOpenedEventArgs
            {
                LotteryData = data
            });
        }
    }
    
    private int CalculateSecondsToSeal(BgLotteryData data)
    {
        // ğŸ”¥ æ ¹æ®æœŸå·è®¡ç®—å°ç›˜æ—¶é—´
        // å‡è®¾ï¼šæ¯æœŸ 5 åˆ†é’Ÿ (300 ç§’)
        // å®é™…å®ç°éœ€è¦æ ¹æ® WebAPI è¿”å›çš„æ—¶é—´æˆ–é…ç½®
        
        var elapsed = (DateTime.Now - data.IssueStartTime).TotalSeconds;
        var secondsRemaining = 300 - (int)elapsed;
        
        return secondsRemaining > 0 ? secondsRemaining : 0;
    }
}
```

### 1.6 åˆ›å»º ORM BindingList

```csharp
// Core/BgLotteryDataBindingList.cs
public class BgLotteryDataBindingList : BindingList<BgLotteryData>
{
    private readonly SQLiteConnection _db;
    
    public BgLotteryDataBindingList(SQLiteConnection db)
    {
        _db = db;
        _db.CreateTable<BgLotteryData>();
    }
    
    protected override void InsertItem(int index, BgLotteryData item)
    {
        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
        var existing = _db.Table<BgLotteryData>()
            .FirstOrDefault(d => d.IssueId == item.IssueId);
        
        if (existing == null)
        {
            _db.Insert(item);
            item.Id = _db.ExecuteScalar<int>("SELECT last_insert_rowid()");
        }
        else
        {
            item.Id = existing.Id;
            _db.Update(item);
        }
        
        base.InsertItem(index, item);
        
        // è®¢é˜…å±æ€§å˜åŒ–
        item.PropertyChanged += (s, e) =>
        {
            if (item.Id > 0)
            {
                _db.Update(item);
            }
        };
    }
    
    protected override void RemoveItem(int index)
    {
        var item = this[index];
        if (item.Id > 0)
        {
            _db.Delete(item);
        }
        base.RemoveItem(index);
    }
    
    public void LoadFromDatabase(int limit = 100)
    {
        var data = _db.Table<BgLotteryData>()
            .OrderByDescending(d => d.IssueId)
            .Take(limit)
            .ToList();
        
        foreach (var item in data)
        {
            base.InsertItem(Count, item);
            
            item.PropertyChanged += (s, e) =>
            {
                if (item.Id > 0)
                {
                    _db.Update(item);
                }
            };
        }
    }
}
```

### 1.7 ä¾èµ–æ³¨å…¥é…ç½®

```csharp
// Program.cs
services.AddSingleton<ILotteryWebApi, LotteryWebApiClient>();
services.AddSingleton<ILotteryAuthService, LotteryAuthService>();
services.AddSingleton<ILotteryService, LotteryService>();
```

---

## ä¸‹ä¸€æ­¥

Phase 1 å®Œæˆåï¼Œå°†å®ç°ï¼š
- **Phase 2**: è®¢å•å¤„ç†å’Œæ¶ˆæ¯é›†æˆ
- **Phase 3**: UI æ§ä»¶å’Œé…ç½®ç®¡ç†

**è¯·ç¡®è®¤æ˜¯å¦å¼€å§‹åˆ›å»ºè¿™äº›æ–‡ä»¶ï¼Ÿ** ğŸš€

