# âœ… è‡ªåŠ¨æŠ•æ³¨æµç¨‹é‡æ„å®Œæˆ

## ğŸ“… å®Œæˆæ—¶é—´

2025-11-08

## ğŸ¯ æ ¸å¿ƒæ”¹è¿›

ç”¨æˆ·è¦æ±‚ï¼š
> "ä¸ä¸ï¼Œä¸ºä»€ä¹ˆéœ€è¦ä¼ é€’åŸå§‹æ•°æ®ã€‚æˆ‘ä»¬ä¸æ˜¯æœ‰Http apiç ï¼Ÿå°ç›˜æ—¶å€™socketé€šçŸ¥å®¢æˆ·ç«¯å·²å°ç›˜:1140xxxæœŸå·ï¼Œå®¢æˆ·ç«¯è§£æå‘½ä»¤ï¼Œæ‹¿åˆ°åŠ¨ä½œå·²å°ç›˜,æ‹¿åˆ°æœŸå·1140xxxå°±å¯ä»¥ï¼Œé€šè¿‡å½“å‰æœŸå·,é€šè¿‡hpsocketçš„http apiå¯ä»¥æ‹¿åˆ°è®¢å•åˆ—è¡¨ã€‚è®¢å•åˆ—è¡¨æœ‰å¤„ç†å¥½çš„è®¢å•å•Š,æ¯”å¦‚è¯´åŸå§‹çš„æ˜¯123å¤§10ï¼Œé‚£ä¹ˆå¤„ç†å¥½çš„ä¼šæ˜¯1å¤§10,2å¤§10ï¼Œ3å¤§10ï¼Œæˆ‘ä»¬éœ€è¦æ‹¿è¿™ä¸ªå¤„ç†å¥½çš„è§£æåçš„æ•°æ®ï¼Œå†å¤„ç†å°±å¯ä»¥äº†ï¼ŒåƒF5BotV2é‚£æ ·ï¼Œç»„è£…ï¼Œåˆå¹¶è®¢å•ï¼Œç»„è£…ã€‚"

### æ”¹è¿›å‰çš„æµç¨‹ï¼ˆé”™è¯¯ï¼‰

```
1. å°ç›˜ â†’ AutoBetCoordinator æŸ¥è¯¢è®¢å• â†’ éå†è®¢å• â†’ Socketæ¨é€æ¯ä¸ªè®¢å•åˆ°BrowserClient
2. BrowserClient â†’ æ”¶åˆ°æŠ•æ³¨å‘½ä»¤ â†’ ç›´æ¥æŠ•æ³¨
```

**é—®é¢˜**ï¼š
- âŒ è®¢å•å†…å®¹æ ¼å¼ä¸æ¸…æ™°ï¼ˆ"2å¤§20" å¦‚ä½•æ‹†åˆ†ï¼Ÿï¼‰
- âŒ VxMain ç«¯æ¨é€æŠ•æ³¨å‘½ä»¤ï¼Œé€»è¾‘ä¸æ¸…æ™°
- âŒ æµè§ˆå™¨ç«¯è¢«åŠ¨æ¥æ”¶ï¼Œæ— æ³•ä¸»åŠ¨æ§åˆ¶

### æ”¹è¿›åçš„æµç¨‹ï¼ˆæ­£ç¡®ï¼‰âœ…

```
1. ç”¨æˆ·å¾®ä¿¡ä¸‹æ³¨ â†’ è®¢å•è¿›å…¥æ•°æ®åº“
   - åŸå§‹å†…å®¹: "123å¤§10"
   - æ ‡å‡†å†…å®¹: æ‹†åˆ†ä¸º "1å¤§10", "2å¤§10", "3å¤§10" (BetContentStandarå­—æ®µ)

2. å°ç›˜å€’è®¡æ—¶ â†’ Socketé€šçŸ¥ BrowserClient
   æ¶ˆæ¯: {"type": "sealing_notify", "issueId": "114063155", "secondsRemaining": 79}

3. BrowserClient æ”¶åˆ°é€šçŸ¥ â†’ HTTPæ‹‰å–è®¢å•
   è¯·æ±‚: GET http://127.0.0.1:8888/api/order?issueId=114063155
   å“åº”: {
     "success": true,
     "count": 3,
     "data": [
       {"IssueId": 114063155, "OrderType": "å¤§å°", "BetContentStandar": "1å¤§10", "Amount": 10, ...},
       {"IssueId": 114063155, "OrderType": "å¤§å°", "BetContentStandar": "2å¤§10", "Amount": 10, ...},
       {"IssueId": 114063155, "OrderType": "å¤§å°", "BetContentStandar": "3å¤§10", "Amount": 10, ...}
     ]
   }

4. BrowserClient â†’ å‚è€ƒ F5BotV2 åˆå¹¶è®¢å•
   - ç›¸åŒç©æ³•ã€ç›¸åŒå·ç çš„è®¢å• â†’ åˆå¹¶é‡‘é¢
   - ç»„è£…æˆå¹³å°éœ€è¦çš„POSTæ•°æ®æ ¼å¼

5. BrowserClient â†’ å‘ç½‘ç«™æŠ•æ³¨

6. BrowserClient â†’ POST /api/result æäº¤ç»“æœ
```

## ğŸ“ å·²å®Œæˆçš„ä¿®æ”¹

### 1. âœ… VxMain ç«¯ä¿®æ”¹

#### `BaiShengVx3Plus/Services/AutoBet/AutoBetCoordinator.cs`
- **åˆ é™¤** `ExecuteAutoBetAsync` æ–¹æ³•ï¼ˆä¸å†ä¸»åŠ¨æ¨é€æŠ•æ³¨å‘½ä»¤ï¼‰
- **ä¿®æ”¹** `LotteryService_StatusChanged`ï¼šåªæ¨é€å°ç›˜é€šçŸ¥ï¼Œä¸æ‰§è¡ŒæŠ•æ³¨

```csharp
// åªåœ¨"å³å°†å°ç›˜"çŠ¶æ€æ—¶æ¨é€é€šçŸ¥
if (e.NewStatus == BinggoLotteryStatus.å³å°†å°ç›˜)
{
    _log.Info("AutoBet", $"ğŸ¯ è§¦å‘å°ç›˜é€šçŸ¥: {e.IssueId}");
    
    // é€šè¿‡ Socket æ¨é€å°ç›˜é€šçŸ¥åˆ°æµè§ˆå™¨ï¼ˆä»…é€šçŸ¥æœŸå·ï¼Œæµè§ˆå™¨è‡ªå·±é€šè¿‡ HTTP æ‹‰å–è®¢å•ï¼‰
    int secondsRemaining = _lotteryService.SecondsToSeal;
    await _autoBetService.NotifySealingAsync(_currentConfigId, e.IssueId.ToString(), secondsRemaining);
    
    _log.Info("AutoBet", $"ğŸ“¢ å°ç›˜é€šçŸ¥å·²æ¨é€ï¼Œæµè§ˆå™¨å°†é€šè¿‡ HTTP API æ‹‰å–æœŸå· {e.IssueId} çš„è®¢å•");
}
```

#### `BaiShengVx3Plus/Services/AutoBet/AutoBetHttpServer.cs`
- **ä¿®æ”¹** `HandleGetOrderAsync`ï¼šè¿”å›è®¢å•åˆ—è¡¨ï¼ˆä¸æ˜¯å•ä¸ªè®¢å•ï¼‰
- **APIå˜åŒ–**ï¼š
  - æ—§: `GET /api/order?configId=1&issueId=114063155` â†’ è¿”å›å•ä¸ªè®¢å•
  - æ–°: `GET /api/order?issueId=114063155` â†’ è¿”å›è®¢å•åˆ—è¡¨

```csharp
private async Task HandleGetOrderAsync(HttpListenerRequest request, HttpListenerResponse response)
{
    var issueIdStr = request.QueryString["issueId"];
    
    // ä»è®¢å•æœåŠ¡è·å–å¾…æŠ•æ³¨è®¢å•
    var orders = _orderService.GetPendingOrdersForIssue(issueId);
    var orderList = orders?.ToList() ?? new List<Models.V2MemberOrder>();
    
    if (orderList.Any())
    {
        // è½¬æ¢ä¸º BrowserClient éœ€è¦çš„æ ¼å¼
        var betOrders = orderList.Select(o => new
        {
            IssueId = o.IssueId,
            OrderType = o.OrderType.ToString(),
            BetContentOriginal = o.BetContentOriginal,
            BetContentStandar = o.BetContentStandar,  // ğŸ”¥ å·²å¤„ç†å¥½çš„æ ‡å‡†å†…å®¹ï¼ˆå¦‚ "1å¤§10"ï¼‰
            Amount = o.AmountTotal,
            MemberName = o.Nickname,
            Wxid = o.Wxid
        }).ToList();
        
        await RespondJsonAsync(response, 200, new
        {
            success = true,
            count = betOrders.Count,
            data = betOrders
        });
    }
}
```

#### `BaiShengVx3Plus/Services/Games/Binggo/BinggoOrderService.cs`
- **æ·»åŠ ** `GetPendingOrdersForIssue(int issueId)` æ–¹æ³•

```csharp
public IEnumerable<V2MemberOrder> GetPendingOrdersForIssue(int issueId)
{
    if (_db == null) return Enumerable.Empty<V2MemberOrder>();
    
    try
    {
        var orders = _db.Table<V2MemberOrder>()
            .Where(o => o.IssueId == issueId && o.OrderStatus == OrderStatus.å¾…å¤„ç†)
            .ToList();
        
        _logService.Info("BinggoOrderService", $"ğŸ“‹ æŸ¥è¯¢å¾…æŠ•æ³¨è®¢å•: æœŸå·{issueId} æ‰¾åˆ°{orders.Count}ä¸ª");
        
        return orders;
    }
    catch (Exception ex)
    {
        _logService.Error("BinggoOrderService", $"è·å–å¾…æŠ•æ³¨è®¢å•å¤±è´¥: æœŸå·{issueId}", ex);
        return Enumerable.Empty<V2MemberOrder>();
    }
}
```

#### `BaiShengVx3Plus/Contracts/Games/IBinggoOrderService.cs`
- **æ·»åŠ ** æ¥å£æ–¹æ³•å®šä¹‰

#### `BaiShengVx3Plus/Services/AutoBet/AutoBetService.cs`
- **ä¿®æ”¹** æ„é€ å‡½æ•°ï¼šæ·»åŠ  `IBinggoOrderService` å‚æ•°
- **ä¼ é€’** è®¢å•æœåŠ¡ç»™ `AutoBetHttpServer`

### 2. âœ… BsBrowserClient ç«¯ä¿®æ”¹

#### `BsBrowserClient/Form1.cs`
- **ä¿®æ”¹** `sealing_notify` å‘½ä»¤å¤„ç†ï¼šè°ƒç”¨ `FetchOrdersAndBetAsync`
- **æ·»åŠ ** `FetchOrdersAndBetAsync` æ–¹æ³•ï¼š

```csharp
private async Task<(bool success, string message)> FetchOrdersAndBetAsync(string issueId)
{
    try
    {
        OnLogMessage($"ğŸ“¥ å¼€å§‹æ‹‰å–è®¢å•: æœŸå·{issueId}");
        
        // 1. é€šè¿‡ HTTP æ‹‰å–è®¢å•åˆ—è¡¨
        var httpClient = new HttpClient();
        var response = await httpClient.GetAsync($"http://127.0.0.1:8888/api/order?issueId={issueId}");
        
        var json = await response.Content.ReadAsStringAsync();
        var data = JsonConvert.DeserializeObject<JObject>(json);
        var count = data?["count"]?.ToObject<int>() ?? 0;
        
        if (count == 0)
        {
            OnLogMessage($"ğŸ“­ æ²¡æœ‰å¾…æŠ•æ³¨è®¢å•: æœŸå·{issueId}");
            return (true, "æ²¡æœ‰å¾…æŠ•æ³¨è®¢å•");
        }
        
        // 2. è§£æè®¢å•åˆ—è¡¨
        var orders = data?["data"]?.ToObject<List<JObject>>();
        OnLogMessage($"âœ… è·å–åˆ° {orders.Count} ä¸ªå¾…æŠ•æ³¨è®¢å•");
        
        // 3. è°ƒç”¨å¹³å°è„šæœ¬æŠ•æ³¨ï¼ˆå¾…å®ç°ï¼‰
        foreach (var order in orders)
        {
            var orderType = order["OrderType"]?.ToString() ?? "";
            var betContent = order["BetContentStandar"]?.ToString() ?? "";
            var amount = order["Amount"]?.ToObject<float>() ?? 0;
            var memberName = order["MemberName"]?.ToString() ?? "";
            
            OnLogMessage($"ğŸ“ è®¢å•: {memberName} {orderType} {betContent} {amount}å…ƒ");
        }
        
        OnLogMessage($"âš ï¸ æŠ•æ³¨åŠŸèƒ½å¾…å®ç°ï¼Œéœ€è¦å‚è€ƒ F5BotV2 å®ç°è®¢å•åˆå¹¶å’Œç»„è£…");
        return (true, $"æ”¶åˆ°{orders.Count}ä¸ªè®¢å•ï¼ŒæŠ•æ³¨åŠŸèƒ½å¾…å®ç°");
    }
    catch (Exception ex)
    {
        OnLogMessage($"âŒ æ‹‰å–è®¢å•å¼‚å¸¸: {ex.Message}");
        return (false, $"æ‹‰å–è®¢å•å¼‚å¸¸: {ex.Message}");
    }
}
```

## ğŸ“Š æµ‹è¯•æ­¥éª¤

### 1. æµ‹è¯•æµç¨‹

```
1. å¯åŠ¨ VxMain
2. å¾®ä¿¡å‘é€æŠ•æ³¨å‘½ä»¤ï¼š@å¯Œè´µ 123å¤§10
3. è§‚å¯Ÿæ—¥å¿—ï¼š
   âœ… è®¢å•åˆ›å»ºæˆåŠŸ: å¯Œè´µ - 123å¤§10 - 10.00å…ƒ
   âœ… BetContentStandar åŒ…å«: 1å¤§10, 2å¤§10, 3å¤§10

4. ç­‰å¾…"å³å°†å°ç›˜"çŠ¶æ€
5. è§‚å¯Ÿ VxMain æ—¥å¿—ï¼š
   âœ… ğŸ¯ è§¦å‘å°ç›˜é€šçŸ¥: 114063155
   âœ… ğŸ“¢ å°ç›˜é€šçŸ¥å·²æ¨é€ï¼Œæµè§ˆå™¨å°†é€šè¿‡ HTTP API æ‹‰å–æœŸå· 114063155 çš„è®¢å•

6. è§‚å¯Ÿ BrowserClient æ—¥å¿—ï¼š
   âœ… â° å°ç›˜é€šçŸ¥: æœŸå·114063155 å‰©ä½™79ç§’
   âœ… ğŸ“¥ å¼€å§‹æ‹‰å–è®¢å•: æœŸå·114063155
   âœ… ğŸ“¦ æ”¶åˆ°å“åº”: {"success":true,"count":3,"data":[...]}
   âœ… âœ… è·å–åˆ° 3 ä¸ªå¾…æŠ•æ³¨è®¢å•
   âœ… ğŸ“ è®¢å•: å¯Œè´µ å¤§å° 1å¤§10 10å…ƒ
   âœ… ğŸ“ è®¢å•: å¯Œè´µ å¤§å° 2å¤§10 10å…ƒ
   âœ… ğŸ“ è®¢å•: å¯Œè´µ å¤§å° 3å¤§10 10å…ƒ
   âš ï¸ æŠ•æ³¨åŠŸèƒ½å¾…å®ç°ï¼Œéœ€è¦å‚è€ƒ F5BotV2 å®ç°è®¢å•åˆå¹¶å’Œç»„è£…
```

### 2. å¯ä»¥æ‰‹åŠ¨æµ‹è¯• HTTP API

```bash
# æµ‹è¯•æ‹‰å–è®¢å•ï¼ˆç¡®ä¿æœŸå·æœ‰å¾…æŠ•æ³¨è®¢å•ï¼‰
curl http://127.0.0.1:8888/api/order?issueId=114063155
```

**é¢„æœŸå“åº”**ï¼š
```json
{
  "success": true,
  "count": 3,
  "data": [
    {
      "IssueId": 114063155,
      "OrderType": "å¤§å°",
      "BetContentOriginal": "123å¤§10",
      "BetContentStandar": "1å¤§10",
      "Amount": 10.0,
      "MemberName": "å¯Œè´µ",
      "Wxid": "wxid_xxx"
    },
    {
      "IssueId": 114063155,
      "OrderType": "å¤§å°",
      "BetContentOriginal": "123å¤§10",
      "BetContentStandar": "2å¤§10",
      "Amount": 10.0,
      "MemberName": "å¯Œè´µ",
      "Wxid": "wxid_xxx"
    },
    {
      "IssueId": 114063155,
      "OrderType": "å¤§å°",
      "BetContentOriginal": "123å¤§10",
      "BetContentStandar": "3å¤§10",
      "Amount": 10.0,
      "MemberName": "å¯Œè´µ",
      "Wxid": "wxid_xxx"
    }
  ]
}
```

## ğŸš§ å¾…å®Œæˆä»»åŠ¡

### âš ï¸ é‡è¦ï¼šå‚è€ƒ F5BotV2 å®ç°æŠ•æ³¨é€»è¾‘

**ä½ç½®**: `BsBrowserClient/PlatformScripts/YunDing28Script.cs` (æˆ–å…¶ä»–å¹³å°è„šæœ¬)

**å‚è€ƒæ–‡ä»¶**: `F5BotV2/BetSite/HongHai/TongBaoMember.cs` çš„ `Bet(BetStandardOrderList items)` æ–¹æ³•

**éœ€è¦å®ç°çš„é€»è¾‘**ï¼š

1. **è®¢å•åˆå¹¶**ï¼š
   ```csharp
   // ç›¸åŒç©æ³•ã€ç›¸åŒå·ç çš„è®¢å• â†’ åˆå¹¶é‡‘é¢
   // ä¾‹å¦‚ï¼š
   //   è®¢å•1: 1å¤§10, 10å…ƒ
   //   è®¢å•2: 1å¤§10, 20å…ƒ
   // åˆå¹¶å: 1å¤§10, 30å…ƒ
   ```

2. **ç»„è£…POSTæ•°æ®**ï¼š
   ```csharp
   // å‚è€ƒ F5BotV2 çš„æ ¼å¼
   StringBuilder postPackect = new StringBuilder(128);
   postPackect.Append($"uuid={this.Uuid}");
   postPackect.Append($"&sid={this.sid}");
   postPackect.Append($"&roomeng=twbingo");
   postPackect.Append($"&pan={this.region}");
   postPackect.Append($"&shuitype=0");
   
   // æ„é€  arrbet æ•°ç»„
   List<dynamic> bets = new List<dynamic>();
   foreach (var item in mergedOrders)
   {
       dynamic betdata = new ExpandoObject();
       betdata.id = GetOddsId(item.car, item.play);  // èµ”ç‡ID
       betdata.money = item.moneySum;
       bets.Add(betdata);
   }
   
   string arrbet = JsonConvert.SerializeObject(bets);
   string arrbet_encode = WebUtility.UrlEncode(arrbet);
   postPackect.Append($"&arrbet={arrbet_encode}");
   ```

3. **å‘é€HTTP POSTè¯·æ±‚**ï¼š
   ```csharp
   var content = new StringContent(postPackect.ToString(), Encoding.UTF8, "application/x-www-form-urlencoded");
   var response = await httpClient.PostAsync(betUrl, content);
   ```

4. **è§£ææŠ•æ³¨ç»“æœ**ï¼š
   ```csharp
   var json = await response.Content.ReadAsStringAsync();
   // è§£æå“åº”ï¼Œæ£€æŸ¥æ˜¯å¦æˆåŠŸ
   ```

## ğŸ‰ æ ¸å¿ƒä¼˜åŠ¿

### 1. **æ¸…æ™°çš„èŒè´£åˆ’åˆ†**
- **VxMain**: ç®¡ç†è®¢å•ã€æ¨é€é€šçŸ¥
- **BrowserClient**: æ‹‰å–è®¢å•ã€æ‰§è¡ŒæŠ•æ³¨

### 2. **æ˜“äºè°ƒè¯•**
- HTTP API å¯ä»¥ç›´æ¥ç”¨æµè§ˆå™¨æˆ– curl æµ‹è¯•
- è®¢å•åˆ—è¡¨æ ¼å¼æ¸…æ™°ï¼Œæ˜“äºæŸ¥çœ‹

### 3. **çµæ´»æ€§å¼º**
- BrowserClient å¯ä»¥ä¸»åŠ¨æ§åˆ¶æŠ•æ³¨æ—¶æœº
- å¯ä»¥å®ç°æ›´å¤æ‚çš„æŠ•æ³¨ç­–ç•¥ï¼ˆå¦‚å»¶è¿ŸæŠ•æ³¨ã€åˆ†æ‰¹æŠ•æ³¨ï¼‰

### 4. **æ•°æ®è§„èŒƒ**
- `BetContentStandar` å­—æ®µç»Ÿä¸€æ ‡å‡†æ ¼å¼
- é¿å…äº†å­—ç¬¦ä¸²è§£æçš„å¤æ‚æ€§å’Œé”™è¯¯

## ğŸ“Œ ç›¸å…³æ–‡ä»¶

### VxMain ç«¯
- `BaiShengVx3Plus/Services/AutoBet/AutoBetCoordinator.cs`
- `BaiShengVx3Plus/Services/AutoBet/AutoBetHttpServer.cs`
- `BaiShengVx3Plus/Services/AutoBet/AutoBetService.cs`
- `BaiShengVx3Plus/Services/Games/Binggo/BinggoOrderService.cs`
- `BaiShengVx3Plus/Contracts/Games/IBinggoOrderService.cs`

### BrowserClient ç«¯
- `BsBrowserClient/Form1.cs`
- `BsBrowserClient/PlatformScripts/YunDing28Script.cs` (å¾…å®ç°)
- `BsBrowserClient/PlatformScripts/TongBaoScript.cs` (å¾…å®ç°)

---

**ç¼–è¯‘çŠ¶æ€**: âœ… å·²æˆåŠŸç¼–è¯‘ï¼Œ0ä¸ªé”™è¯¯ï¼Œ0ä¸ªè­¦å‘Š

**ä¸‹ä¸€æ­¥**: å‚è€ƒ F5BotV2 å®ç°è®¢å•åˆå¹¶å’ŒæŠ•æ³¨é€»è¾‘ ğŸš€

