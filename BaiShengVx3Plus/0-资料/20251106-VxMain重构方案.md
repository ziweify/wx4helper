# VxMain é‡æ„æ–¹æ¡ˆ

## ğŸ¯ é‡æ„ç›®æ ‡

**åˆ é™¤å¤æ‚çš„ Service ä¾èµ–æ³¨å…¥ï¼Œä½¿ç”¨ç®€å•çš„ ORM + BindingList**

---

## âŒ ç°æœ‰é—®é¢˜

### 1. æ„é€ å‡½æ•°è¿‡äºå¤æ‚ï¼ˆ11ä¸ªå‚æ•°ï¼‰

```csharp
public VxMain(
    VxMainViewModel viewModel,
    IContactBindingService contactBindingService,   // âŒ åˆ é™¤
    ILogService logService,                         // âœ… ä¿ç•™
    IWeixinSocketClient socketClient,               // âœ… ä¿ç•™
    MessageDispatcher messageDispatcher,            // âœ… ä¿ç•™
    IContactDataService contactDataService,         // âœ… ä¿ç•™
    IUserInfoService userInfoService,               // âœ… ä¿ç•™
    IWeChatService wechatService,                   // âœ… ä¿ç•™
    IMemberService memberService,                   // âŒ åˆ é™¤
    IOrderService orderService)                     // âŒ åˆ é™¤
```

### 2. äº‹ä»¶è®¢é˜…ç¹çï¼ˆ~200è¡Œï¼‰

```csharp
_membersBindingList.ItemAdded += MembersBindingList_ItemAdded;
_membersBindingList.ItemRemoving += MembersBindingList_ItemRemoving;
_ordersBindingList.ItemAdded += OrdersBindingList_ItemAdded;
_ordersBindingList.ItemRemoving += OrdersBindingList_ItemRemoving;
```

---

## âœ… é‡æ„æ–¹æ¡ˆ

### 1. ç²¾ç®€æ„é€ å‡½æ•°ï¼ˆåˆ é™¤ 3ä¸ªServiceï¼‰

```csharp
public VxMain(
    VxMainViewModel viewModel,
    ILogService logService,
    IWeixinSocketClient socketClient,
    MessageDispatcher messageDispatcher,
    IContactDataService contactDataService,
    IUserInfoService userInfoService,
    IWeChatService wechatService)
{
    InitializeComponent();
    _logService = logService;
    _socketClient = socketClient;
    _messageDispatcher = messageDispatcher;
    _contactDataService = contactDataService;
    _userInfoService = userInfoService;
    _wechatService = wechatService;
    
    // è®¢é˜…äº‹ä»¶...
    
    // ğŸ”¥ ä½¿ç”¨ ORM ç›´æ¥æ“ä½œæ•°æ®åº“
    InitializeDatabase();
}
```

### 2. æ•°æ®åº“åˆå§‹åŒ–ï¼ˆæ–°å¢æ–¹æ³•ï¼‰

```csharp
private SQLiteConnection? _db;
private V2MemberBindingList? _membersBindingList;
private V2OrderBindingList? _ordersBindingList;

private void InitializeDatabase(string wxid)
{
    string dbPath = Path.Combine("Data", $"business_{wxid}.db");
    Directory.CreateDirectory("Data");
    
    _db = new SQLiteConnection(dbPath);
    
    // ğŸ”¥ åˆ›å»º BindingListï¼ˆè‡ªåŠ¨å»ºè¡¨ã€è‡ªåŠ¨è¿½è¸ªï¼‰
    _membersBindingList = new V2MemberBindingList(_db, _currentBoundContact?.Wxid ?? "");
    _ordersBindingList = new V2OrderBindingList(_db);
    
    // ğŸ”¥ åŠ è½½æ•°æ®
    _membersBindingList.LoadFromDatabase();
    _ordersBindingList.LoadFromDatabase();
    
    // ç»‘å®šåˆ° DataGridView
    dgvMembers.DataSource = _membersBindingList;
    dgvOrders.DataSource = _ordersBindingList;
    
    _logService.Info("VxMain", $"âœ“ æ•°æ®åº“å·²åˆå§‹åŒ–: {dbPath}");
}
```

### 3. åˆ é™¤æ‰€æœ‰äº‹ä»¶è®¢é˜…ä»£ç 

```csharp
// âŒ åˆ é™¤è¿™äº›ï¼ˆ~200è¡Œï¼‰
_membersBindingList.ItemAdded += MembersBindingList_ItemAdded;
_membersBindingList.ItemRemoving += MembersBindingList_ItemRemoving;
_ordersBindingList.ItemAdded += OrdersBindingList_ItemAdded;
_ordersBindingList.ItemRemoving += OrdersBindingList_ItemRemoving;

// âŒ åˆ é™¤è¿™äº›äº‹ä»¶å¤„ç†å™¨ï¼ˆ~200è¡Œï¼‰
private void MembersBindingList_ItemAdded(...) { ... }
private void MembersBindingList_ItemRemoving(...) { ... }
private void OrdersBindingList_ItemAdded(...) { ... }
private void OrdersBindingList_ItemRemoving(...) { ... }
```

### 4. åŠ è½½ç¾¤æˆå‘˜ï¼ˆç®€åŒ–ç‰ˆï¼‰

```csharp
private void LoadGroupMembersToDataGrid(JsonElement groupMembersJson)
{
    if (_membersBindingList == null)
    {
        _logService.Warning("VxMain", "ä¼šå‘˜åˆ—è¡¨æœªåˆå§‹åŒ–");
        return;
    }
    
    _membersBindingList.Clear();
    
    foreach (var memberElement in groupMembersJson.EnumerateArray())
    {
        var member = new V2Member
        {
            Wxid = memberElement.GetProperty("member_wxid").GetString(),
            Nickname = memberElement.GetProperty("member_nickname").GetString(),
            Balance = 0,
            State = MemberState.ä¼šå‘˜
        };
        
        // ğŸ”¥ è‡ªåŠ¨ä¿å­˜åˆ°æ•°æ®åº“ï¼ï¼ˆBindingList å¤„ç†ï¼‰
        _membersBindingList.Add(member);
    }
    
    _logService.Info("VxMain", $"âœ“ åŠ è½½ {_membersBindingList.Count} åä¼šå‘˜");
}
```

### 5. ç”¨æˆ·åˆ‡æ¢æ—¶é‡æ–°åˆå§‹åŒ–æ•°æ®åº“

```csharp
private void UserInfoService_UserInfoUpdated(object? sender, UserInfoUpdatedEventArgs e)
{
    if (_currentUserInfo != null && _currentUserInfo.WxId != e.UserInfo.WxId)
    {
        // ç”¨æˆ·åˆ‡æ¢ï¼Œå…³é—­æ—§æ•°æ®åº“
        _db?.Close();
        _db = null;
        _membersBindingList?.Clear();
        _ordersBindingList?.Clear();
    }
    
    _currentUserInfo = e.UserInfo;
    
    // é‡æ–°åˆå§‹åŒ–æ•°æ®åº“
    InitializeDatabase(e.UserInfo.WxId ?? "unknown");
    
    // è‡ªåŠ¨è·å–è”ç³»äºº
    await RefreshContactsAsync();
}
```

---

## ğŸ“Š é‡æ„æ•ˆæœ

### ä»£ç é‡å¯¹æ¯”

| éƒ¨åˆ†                 | é‡æ„å‰    | é‡æ„å   | å‡å°‘    |
|----------------------|-----------|----------|---------|
| æ„é€ å‡½æ•°å‚æ•°         | 11ä¸ª      | 7ä¸ª      | -36%    |
| åˆå§‹åŒ–ä»£ç            | 150è¡Œ     | 50è¡Œ     | -67%    |
| äº‹ä»¶è®¢é˜…ä»£ç          | 200è¡Œ     | 0è¡Œ      | -100%   |
| äº‹ä»¶å¤„ç†å™¨           | 200è¡Œ     | 0è¡Œ      | -100%   |
| Service å­—æ®µ         | 11ä¸ª      | 7ä¸ª      | -36%    |
| **VxMain æ€»ä»£ç **    | **1500è¡Œ** | **1050è¡Œ** | **-30%** |

---

## ğŸš€ é‡æ„æ­¥éª¤

### æ­¥éª¤ 1ï¼šä¿®æ”¹æ„é€ å‡½æ•°

1. åˆ é™¤å‚æ•°ï¼š`IContactBindingService`, `IMemberService`, `IOrderService`
2. åˆ é™¤å­—æ®µï¼š`_contactBindingService`, `_memberService`, `_orderService`
3. æ·»åŠ å­—æ®µï¼š`SQLiteConnection? _db`

### æ­¥éª¤ 2ï¼šæ·»åŠ  InitializeDatabase æ–¹æ³•

```csharp
private void InitializeDatabase(string wxid) { ... }
```

### æ­¥éª¤ 3ï¼šåˆ é™¤äº‹ä»¶è®¢é˜…ä»£ç 

1. åˆ é™¤ `_membersBindingList.ItemAdded += ...` (4è¡Œ)
2. åˆ é™¤äº‹ä»¶å¤„ç†å™¨ (4ä¸ªæ–¹æ³•ï¼Œ~200è¡Œ)

### æ­¥éª¤ 4ï¼šç®€åŒ–æ•°æ®åŠ è½½æ–¹æ³•

1. ä¿®æ”¹ `LoadGroupMembersToDataGrid` (åˆ é™¤ 50%ä»£ç )

### æ­¥éª¤ 5ï¼šæ›´æ–° Program.cs

åˆ é™¤ Service æ³¨å†Œï¼š
```csharp
// âŒ åˆ é™¤
services.AddSingleton<IMemberService, MemberService>();
services.AddSingleton<IOrderService, OrderService>();
services.AddSingleton<IDatabaseService, DatabaseService>();
services.AddSingleton<IPropertyChangeTracker, PropertyChangeTracker>();
services.AddSingleton<IContactBindingService, ContactBindingService>();
```

---

## ğŸ’¡ æ ¸å¿ƒä¼˜åŠ¿

### 1. ç²¾ç®€ âœ…
- åˆ é™¤ 3ä¸ªService ä¾èµ–
- åˆ é™¤ 200è¡Œäº‹ä»¶è®¢é˜…ä»£ç 
- åˆ é™¤ 200è¡Œäº‹ä»¶å¤„ç†å™¨
- VxMain ä»£ç å‡å°‘ 30%

### 2. ç°ä»£åŒ– âœ…
- ä½¿ç”¨ ORM ç›´æ¥æ“ä½œæ•°æ®åº“
- é›¶ SQL
- BindingList è‡ªåŠ¨å¤„ç†å¢åˆ æ”¹

### 3. æ˜“ç»´æŠ¤ âœ…
- é€»è¾‘æ¸…æ™°ï¼šæ•°æ®åº“æ“ä½œåœ¨ BindingList
- æ·»åŠ å­—æ®µï¼šåªéœ€åœ¨æ¨¡å‹åŠ ä¸€ä¸ªå±æ€§
- æ— éœ€ç»´æŠ¤å¤æ‚çš„ Service å±‚

---

**åˆ›å»ºæ—¥æœŸ**: 2025-11-06  
**çŠ¶æ€**: å‡†å¤‡å®æ–½

