# ç´§æ€¥ä¿®å¤æ¸…å• - é—æ¼çš„æ ¸å¿ƒåŠŸèƒ½

**æ—¶é—´**: 2025å¹´11æœˆ6æ—¥ 03:00  
**çŠ¶æ€**: ğŸš¨ ç´§æ€¥ä¿®å¤ä¸­  

---

## ğŸš¨ é—æ¼çš„æ ¸å¿ƒåŠŸèƒ½

### 1. âŒ åˆ—æ ‡é¢˜æ˜¾ç¤ºä¸ºä¸­æ–‡

**é—®é¢˜**: è™½ç„¶å·²ç»æ·»åŠ äº† `[DisplayName]` ç‰¹æ€§ï¼Œä½†éœ€è¦éªŒè¯ DataGridView æ˜¯å¦æ­£ç¡®æ˜¾ç¤ºä¸­æ–‡åˆ—å¤´ã€‚

**å½“å‰çŠ¶æ€**:
- âœ… `V2Member` å’Œ `V2MemberOrder` å·²æ·»åŠ  `[DisplayName]`
- âœ… `AutoGenerateColumns = true` å·²è®¾ç½®
- â¸ï¸ éœ€è¦æµ‹è¯•éªŒè¯

**æµ‹è¯•æ–¹æ³•**:
```
1. ç¼–è¯‘è¿è¡Œ
2. ç»‘å®šç¾¤ç»„
3. æŸ¥çœ‹ä¼šå‘˜è¡¨åˆ—å¤´æ˜¯å¦æ˜¾ç¤ºï¼š"æ˜µç§°"ã€"ä½™é¢"ã€"çŠ¶æ€" ç­‰ä¸­æ–‡
4. æŸ¥çœ‹è®¢å•è¡¨åˆ—å¤´æ˜¯å¦æ˜¾ç¤ºï¼š"æœŸå·"ã€"æ€»é‡‘é¢"ã€"ç›ˆåˆ©" ç­‰ä¸­æ–‡
```

---

### 2. âŒ åŠ¨æ€æ•°æ®åº“å‘½å `business_{wxid}.db`

**é—®é¢˜**: å½“å‰ä½¿ç”¨å›ºå®šçš„ `business.db`ï¼Œæ— æ³•ä¸ºæ¯ä¸ªç”¨æˆ·åˆ›å»ºç‹¬ç«‹çš„æ•°æ®åº“ã€‚

**è®¾è®¡ç›®æ ‡**:
```
business_{wxid}.db
â”œâ”€â”€ Members    (ä¼šå‘˜è¡¨)
â”œâ”€â”€ Orders     (è®¢å•è¡¨)
â””â”€â”€ ...        (å…¶ä»–ä¸šåŠ¡è¡¨)
```

**å½“å‰å®ç°** (`DatabaseService.cs`):
```csharp
// âŒ é”™è¯¯ï¼šå›ºå®šçš„ business.db
var dbPath = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "Data", "business.db");
```

**åº”è¯¥æ˜¯**:
```csharp
// âœ… æ­£ç¡®ï¼šåŠ¨æ€çš„ business_{wxid}.db
var dbPath = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "Data", $"business_{wxid}.db");
```

**å½±å“**:
- âŒ å¤šä¸ªç”¨æˆ·æ•°æ®ä¼šæ··åœ¨ä¸€èµ·
- âŒ æ— æ³•åŒºåˆ†ä¸åŒç”¨æˆ·çš„ä¼šå‘˜å’Œè®¢å•
- âŒ æ•°æ®å†²çªé£é™©

---

### 3. âŒ ä¼šå‘˜è¡¨ã€è®¢å•è¡¨ç«‹å³ä¿å­˜ï¼ˆå¢åˆ æ”¹ï¼‰

**é—®é¢˜**: å½“å‰çš„ `PropertyChangeTracker` åªå¤„ç†**ä¿®æ”¹**ï¼Œä¸å¤„ç†**å¢åŠ **å’Œ**åˆ é™¤**ã€‚

**è®¾è®¡è¦æ±‚**:
1. âœ… **ä¿®æ”¹**: å•ä¸ªå­—æ®µç«‹å³ä¿å­˜ï¼ˆå·²å®ç°ï¼‰
2. âŒ **å¢åŠ **: æ–°å¢è¡Œç«‹å³ä¿å­˜åˆ°æ•°æ®åº“
3. âŒ **åˆ é™¤**: åˆ é™¤è¡Œç«‹å³ä»æ•°æ®åº“åˆ é™¤

**å½“å‰å®ç°**:
- âœ… `PropertyChangeTracker` ç›‘å¬ `PropertyChanged` äº‹ä»¶ï¼ˆä¿®æ”¹ï¼‰
- âŒ æ²¡æœ‰ç›‘å¬ `BindingList` çš„ `ListChanged` äº‹ä»¶ï¼ˆå¢åŠ /åˆ é™¤ï¼‰

**åº”è¯¥å®ç°**:
```csharp
_membersBindingList.ListChanged += (s, e) =>
{
    if (e.ListChangedType == ListChangedType.ItemAdded)
    {
        // ä¿å­˜æ–°å¢çš„ä¼šå‘˜
        var member = _membersBindingList[e.NewIndex];
        _memberService.AddMember(member);
    }
    else if (e.ListChangedType == ListChangedType.ItemDeleted)
    {
        // åˆ é™¤ä¼šå‘˜ï¼ˆéœ€è¦è®°å½• IDï¼‰
        _memberService.DeleteMember(memberId);
    }
};
```

---

## ğŸ¯ ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: åŠ¨æ€æ•°æ®åº“å‘½å

#### 1.1 ä¿®æ”¹ `IDatabaseService`

æ·»åŠ æ–¹æ³•ï¼š
```csharp
void SwitchDatabase(string wxid);
string GetCurrentDatabasePath();
```

#### 1.2 ä¿®æ”¹ `DatabaseService`

```csharp
private string? _currentWxid;
private string _connectionString = "";

public void SwitchDatabase(string wxid)
{
    if (string.IsNullOrEmpty(wxid))
    {
        throw new ArgumentException("wxid ä¸èƒ½ä¸ºç©º");
    }
    
    _currentWxid = wxid;
    
    // åŠ¨æ€æ•°æ®åº“è·¯å¾„
    var dbPath = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "Data", $"business_{wxid}.db");
    var directory = Path.GetDirectoryName(dbPath);
    if (!string.IsNullOrEmpty(directory))
    {
        Directory.CreateDirectory(directory);
    }
    
    _connectionString = $"Data Source={dbPath};Version=3;Pooling=true;Max Pool Size=10;";
    
    // åˆå§‹åŒ–æ–°æ•°æ®åº“
    InitializeDatabase();
    
    _logService?.Info("DatabaseService", $"åˆ‡æ¢åˆ°æ•°æ®åº“: business_{wxid}.db");
}

public string GetCurrentDatabasePath()
{
    if (string.IsNullOrEmpty(_currentWxid))
    {
        return "æœªè¿æ¥";
    }
    return $"business_{_currentWxid}.db";
}
```

#### 1.3 åœ¨ `LoginEventHandler` ä¸­è°ƒç”¨

```csharp
public async Task HandleAsync(string messageType, JsonElement data)
{
    var wxid = data.GetProperty("Wxid").GetString() ?? "";
    var nickname = data.GetProperty("Nickname").GetString() ?? "";
    
    // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
    _userInfoService.UpdateUserInfo(new WxUserInfo
    {
        Wxid = wxid,
        Nickname = nickname,
        IsLoggedIn = true
    });
    
    // ğŸ”¥ åˆ‡æ¢åˆ°ç”¨æˆ·ä¸“å±æ•°æ®åº“
    _databaseService.SwitchDatabase(wxid);
    
    _logService.Info("LoginEventHandler", $"ç”¨æˆ· {nickname} ç™»å½•æˆåŠŸï¼Œæ•°æ®åº“: {_databaseService.GetCurrentDatabasePath()}");
}
```

---

### æ–¹æ¡ˆ 2: å¢åŠ /åˆ é™¤ç«‹å³ä¿å­˜

#### 2.1 ä¿®æ”¹ `MemberService`

æ·»åŠ äº‹ä»¶ï¼š
```csharp
public event EventHandler<V2Member>? MemberAdded;
public event EventHandler<long>? MemberDeleted;
```

å®ç°æ–¹æ³•ï¼š
```csharp
public void AddMemberImmediate(V2Member member)
{
    // ä¿å­˜åˆ°æ•°æ®åº“
    using var connection = _dbService.GetConnection();
    var sql = @"
        INSERT INTO Members (GroupWxId, Wxid, Nickname, Balance, State, ...)
        VALUES (@GroupWxId, @Wxid, @Nickname, @Balance, @State, ...)
    ";
    using var cmd = new SQLiteCommand(sql, connection);
    cmd.Parameters.AddWithValue("@GroupWxId", member.GroupWxid ?? "");
    cmd.Parameters.AddWithValue("@Wxid", member.Wxid ?? "");
    // ... å…¶ä»–å­—æ®µ
    cmd.ExecuteNonQuery();
    
    // è·å–æ’å…¥çš„ ID
    member.Id = connection.LastInsertRowId;
    
    // è§¦å‘äº‹ä»¶
    MemberAdded?.Invoke(this, member);
    
    _logService.Info("MemberService", $"ä¼šå‘˜ {member.Nickname} å·²æ·»åŠ åˆ°æ•°æ®åº“");
}

public void DeleteMemberImmediate(long memberId)
{
    using var connection = _dbService.GetConnection();
    var sql = "DELETE FROM Members WHERE Id = @Id";
    using var cmd = new SQLiteCommand(sql, connection);
    cmd.Parameters.AddWithValue("@Id", memberId);
    cmd.ExecuteNonQuery();
    
    // è§¦å‘äº‹ä»¶
    MemberDeleted?.Invoke(this, memberId);
    
    _logService.Info("MemberService", $"ä¼šå‘˜ ID:{memberId} å·²ä»æ•°æ®åº“åˆ é™¤");
}
```

#### 2.2 åœ¨ `VxMain` ä¸­ç›‘å¬

```csharp
private void InitializeDataBindings()
{
    // ... ç°æœ‰ä»£ç  ...
    
    // ğŸ”¥ ç›‘å¬ä¼šå‘˜åˆ—è¡¨çš„å¢åŠ /åˆ é™¤
    _membersBindingList.ListChanged += MembersBindingList_ListChanged;
    
    // ğŸ”¥ ç›‘å¬è®¢å•åˆ—è¡¨çš„å¢åŠ /åˆ é™¤
    _ordersBindingList.ListChanged += OrdersBindingList_ListChanged;
}

private void MembersBindingList_ListChanged(object? sender, ListChangedEventArgs e)
{
    try
    {
        if (e.ListChangedType == ListChangedType.ItemAdded)
        {
            var member = _membersBindingList[e.NewIndex];
            _memberService.AddMemberImmediate(member);
            _logService.Info("VxMain", $"æ–°å¢ä¼šå‘˜: {member.Nickname}");
        }
        else if (e.ListChangedType == ListChangedType.ItemDeleted)
        {
            // æ³¨æ„ï¼šItemDeleted æ—¶æ— æ³•è·å–è¢«åˆ é™¤çš„å¯¹è±¡
            // éœ€è¦åœ¨åˆ é™¤å‰è®°å½• ID
            _logService.Info("VxMain", "ä¼šå‘˜å·²åˆ é™¤");
        }
    }
    catch (Exception ex)
    {
        _logService.Error("VxMain", $"ä¼šå‘˜åˆ—è¡¨å˜åŒ–å¤„ç†å¤±è´¥: {ex.Message}");
        UIMessageBox.ShowError($"ä¿å­˜ä¼šå‘˜æ•°æ®å¤±è´¥: {ex.Message}");
    }
}

private void OrdersBindingList_ListChanged(object? sender, ListChangedEventArgs e)
{
    try
    {
        if (e.ListChangedType == ListChangedType.ItemAdded)
        {
            var order = _ordersBindingList[e.NewIndex];
            _orderService.AddOrderImmediate(order);
            _logService.Info("VxMain", $"æ–°å¢è®¢å•: {order.IssueId}");
        }
        else if (e.ListChangedType == ListChangedType.ItemDeleted)
        {
            _logService.Info("VxMain", "è®¢å•å·²åˆ é™¤");
        }
    }
    catch (Exception ex)
    {
        _logService.Error("VxMain", $"è®¢å•åˆ—è¡¨å˜åŒ–å¤„ç†å¤±è´¥: {ex.Message}");
        UIMessageBox.ShowError($"ä¿å­˜è®¢å•æ•°æ®å¤±è´¥: {ex.Message}");
    }
}
```

---

### æ–¹æ¡ˆ 3: åˆ é™¤æ“ä½œçš„ç‰¹æ®Šå¤„ç†

**é—®é¢˜**: `ListChangedType.ItemDeleted` äº‹ä»¶æ—¶æ— æ³•è·å–è¢«åˆ é™¤å¯¹è±¡çš„ IDã€‚

**è§£å†³æ–¹æ¡ˆ**:

#### æ–¹æ³• 1: ä½¿ç”¨ `BindingList.RemovingItem` äº‹ä»¶ï¼ˆæ¨èï¼‰

```csharp
// è‡ªå®šä¹‰ BindingList
public class TrackableBindingList<T> : BindingList<T>
{
    public event EventHandler<T>? ItemRemoving;
    
    protected override void RemoveItem(int index)
    {
        var item = this[index];
        ItemRemoving?.Invoke(this, item);
        base.RemoveItem(index);
    }
}

// ä½¿ç”¨
_membersBindingList = new TrackableBindingList<V2Member>(_memberService.GetAllMembers());
_membersBindingList.ItemRemoving += (s, member) =>
{
    _memberService.DeleteMemberImmediate(member.Id);
    _logService.Info("VxMain", $"åˆ é™¤ä¼šå‘˜: {member.Nickname}");
};
```

#### æ–¹æ³• 2: æä¾›åˆ é™¤æŒ‰é’®

```csharp
// åœ¨ DataGridView ä¸­æ·»åŠ åˆ é™¤æŒ‰é’®åˆ—
private void dgvMembers_CellClick(object sender, DataGridViewCellEventArgs e)
{
    if (e.ColumnIndex == deleteButtonColumnIndex && e.RowIndex >= 0)
    {
        var member = _membersBindingList[e.RowIndex];
        
        if (UIMessageBox.ShowConfirm($"ç¡®è®¤åˆ é™¤ä¼šå‘˜ {member.Nickname}ï¼Ÿ"))
        {
            // å…ˆä»æ•°æ®åº“åˆ é™¤
            _memberService.DeleteMemberImmediate(member.Id);
            
            // å†ä»åˆ—è¡¨åˆ é™¤
            _membersBindingList.RemoveAt(e.RowIndex);
        }
    }
}
```

---

## ğŸ“‹ å®æ–½æ­¥éª¤

### ç¬¬ä¸€ä¼˜å…ˆçº§ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰

1. âœ… **ä¿®æ”¹ `DatabaseService`** - æ”¯æŒåŠ¨æ€æ•°æ®åº“å‘½å
2. âœ… **ä¿®æ”¹ `LoginEventHandler`** - ç™»å½•æ—¶åˆ‡æ¢æ•°æ®åº“
3. âœ… **ä¿®æ”¹ `MemberService`** - å®ç°ç«‹å³å¢åŠ /åˆ é™¤
4. âœ… **ä¿®æ”¹ `OrderService`** - å®ç°ç«‹å³å¢åŠ /åˆ é™¤
5. âœ… **ä¿®æ”¹ `VxMain`** - ç›‘å¬åˆ—è¡¨å˜åŒ–

### ç¬¬äºŒä¼˜å…ˆçº§ï¼ˆæµ‹è¯•éªŒè¯ï¼‰

6. â¸ï¸ **æµ‹è¯•åˆ—æ ‡é¢˜** - éªŒè¯ä¸­æ–‡æ˜¾ç¤º
7. â¸ï¸ **æµ‹è¯•æ•°æ®åº“åˆ‡æ¢** - å¤šç”¨æˆ·åœºæ™¯
8. â¸ï¸ **æµ‹è¯•å¢åˆ æ”¹** - å³æ—¶ä¿å­˜

---

## ğŸ¯ éªŒæ”¶æ ‡å‡†

### 1. åˆ—æ ‡é¢˜

- [ ] ä¼šå‘˜è¡¨åˆ—å¤´æ˜¾ç¤ºä¸ºä¸­æ–‡ï¼š"æ˜µç§°"ã€"ä½™é¢"ã€"çŠ¶æ€" ç­‰
- [ ] è®¢å•è¡¨åˆ—å¤´æ˜¾ç¤ºä¸ºä¸­æ–‡ï¼š"æœŸå·"ã€"æ€»é‡‘é¢"ã€"ç›ˆåˆ©" ç­‰

### 2. åŠ¨æ€æ•°æ®åº“

- [ ] ç™»å½•ç”¨æˆ·Aåï¼Œæ•°æ®åº“ä¸º `business_wxid_a.db`
- [ ] ç™»å½•ç”¨æˆ·Båï¼Œæ•°æ®åº“ä¸º `business_wxid_b.db`
- [ ] ç”¨æˆ·Aå’Œç”¨æˆ·Bçš„æ•°æ®å®Œå…¨éš”ç¦»

### 3. ç«‹å³ä¿å­˜

- [ ] ä¿®æ”¹ä¼šå‘˜ä½™é¢ï¼Œç«‹å³ä¿å­˜åˆ°æ•°æ®åº“
- [ ] æ·»åŠ æ–°ä¼šå‘˜ï¼Œç«‹å³ä¿å­˜åˆ°æ•°æ®åº“
- [ ] åˆ é™¤ä¼šå‘˜ï¼Œç«‹å³ä»æ•°æ®åº“åˆ é™¤
- [ ] è®¢å•åŒç†

---

## âš ï¸ é£é™©å’Œæ³¨æ„äº‹é¡¹

1. **æ•°æ®è¿ç§»**: å¦‚æœå·²æœ‰æ•°æ®åœ¨ `business.db`ï¼Œéœ€è¦è¿ç§»
2. **å¹¶å‘æ§åˆ¶**: å¢åˆ æ”¹éƒ½éœ€è¦äº‹åŠ¡ä¿æŠ¤
3. **UI å“åº”**: å¢åˆ æ“ä½œéœ€è¦å¼‚æ­¥ï¼Œé¿å…é˜»å¡
4. **é”™è¯¯å¤„ç†**: ä¿å­˜å¤±è´¥æ—¶éœ€è¦å›æ»š UI çŠ¶æ€

---

**æ—¶é—´**: 2025å¹´11æœˆ6æ—¥ 03:00  
**çŠ¶æ€**: ğŸš¨ å¾…å®æ–½  
**é¢„è®¡å·¥ä½œé‡**: 2-3å°æ—¶

