# è·å–ç¾¤æˆå‘˜è¯¦ç»†ä¿¡æ¯åŠŸèƒ½

**å®ç°æ—¶é—´**: 2025å¹´11æœˆ6æ—¥ 01:15  
**çŠ¶æ€**: âœ… ä»£ç å·²å®Œæˆï¼Œå¾…ç¼–è¯‘æµ‹è¯•  
**åŠŸèƒ½**: `GetGroupContacts()` è¿”å›å®Œæ•´çš„æˆå‘˜å’Œç¾¤è¯¦ç»†ä¿¡æ¯

---

## ğŸ¯ éœ€æ±‚è¯´æ˜

### åŸå§‹æ•°æ®

```json
[
  {
    "member_id": "7",
    "room_id": "10"
  },
  {
    "member_id": "8",
    "room_id": "10"
  }
]
```

**é—®é¢˜**ï¼šåªæœ‰ IDï¼Œæ²¡æœ‰è¯¦ç»†ä¿¡æ¯ã€‚

---

### æœŸæœ›æ•°æ®

```json
[
  {
    "room_id": "27206515609@chatroom",
    "member_id": "wxid_abc123",
    // æˆå‘˜è¯¦ç»†ä¿¡æ¯ï¼ˆä» contact è¡¨æŸ¥è¯¢ï¼‰
    "member_nickname": "å¼ ä¸‰",
    "member_alias": "zhangsan",
    "member_remark": "è€åŒå­¦",
    "member_avatar": "http://...",
    // ç¾¤è¯¦ç»†ä¿¡æ¯ï¼ˆä» contact è¡¨æŸ¥è¯¢ï¼‰
    "room_nickname": "æŠ€æœ¯äº¤æµç¾¤",
    "room_avatar": "http://...",
    "room_remark": "å·¥ä½œç¾¤"
  }
]
```

**æ•ˆæœ**ï¼š
- âœ… **é€šè¿‡ `member_id` æŸ¥è¯¢æˆå‘˜è¯¦ç»†ä¿¡æ¯**
- âœ… **é€šè¿‡ `room_id` æŸ¥è¯¢ç¾¤è¯¦ç»†ä¿¡æ¯**
- âœ… **ä¸€æ¬¡æŸ¥è¯¢è¿”å›æ‰€æœ‰ä¿¡æ¯**

---

## ğŸ”§ å®ç°æ–¹æ¡ˆ

### SQL è”è¡¨æŸ¥è¯¢ï¼ˆJOINï¼‰

**æ–‡ä»¶**: `WeixinX/WeixinX/Features.cpp`  
**å‡½æ•°**: `string WeixinX::Core::GetGroupContacts(string wxid)`

```cpp
std::string sql = 
    "SELECT "
    // ç¾¤æˆå‘˜å…³ç³»
    "cm.room_id, "
    "cm.member_id, "
    // æˆå‘˜è¯¦ç»†ä¿¡æ¯ï¼ˆä» contact è¡¨ï¼‰
    "c_member.nick_name AS member_nickname, "
    "c_member.alias AS member_alias, "
    "c_member.remark AS member_remark, "
    "c_member.small_head_url AS member_avatar, "
    // ç¾¤è¯¦ç»†ä¿¡æ¯ï¼ˆä» contact è¡¨ï¼‰
    "c_room.nick_name AS room_nickname, "
    "c_room.small_head_url AS room_avatar, "
    "c_room.remark AS room_remark "
    "FROM chatroom_member cm "
    // LEFT JOIN æˆå‘˜ä¿¡æ¯
    "LEFT JOIN contact c_member ON cm.member_id = c_member.username "
    // LEFT JOIN ç¾¤ä¿¡æ¯
    "LEFT JOIN contact c_room ON cm.room_id = c_room.username "
    "ORDER BY cm.room_id, cm.member_id";
```

---

## ğŸ“Š æ•°æ®åº“è¡¨å…³ç³»

### è¡¨1: `chatroom_member`ï¼ˆç¾¤æˆå‘˜å…³ç³»ï¼‰

| å­—æ®µ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `room_id` | ç¾¤ ID | `27206515609@chatroom` |
| `member_id` | æˆå‘˜ ID | `wxid_abc123` |

**ä½œç”¨**ï¼šå­˜å‚¨"å“ªä¸ªç¾¤æœ‰å“ªäº›æˆå‘˜"çš„å…³ç³»ã€‚

---

### è¡¨2: `contact`ï¼ˆè”ç³»äººè¯¦ç»†ä¿¡æ¯ï¼‰

| å­—æ®µ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `username` | å¾®ä¿¡ IDï¼ˆä¸»é”®ï¼‰ | `wxid_abc123` |
| `nick_name` | æ˜µç§° | `å¼ ä¸‰` |
| `alias` | å¾®ä¿¡å· | `zhangsan` |
| `remark` | å¤‡æ³¨ | `è€åŒå­¦` |
| `small_head_url` | å¤´åƒ | `http://...` |

**ä½œç”¨**ï¼šå­˜å‚¨æ¯ä¸ªè”ç³»äººï¼ˆåŒ…æ‹¬å¥½å‹å’Œç¾¤ï¼‰çš„è¯¦ç»†ä¿¡æ¯ã€‚

---

### JOIN é€»è¾‘

```sql
FROM chatroom_member cm
LEFT JOIN contact c_member ON cm.member_id = c_member.username
LEFT JOIN contact c_room ON cm.room_id = c_room.username
```

**æ­¥éª¤**ï¼š
1. ä» `chatroom_member` è¯»å–æ‰€æœ‰ç¾¤æˆå‘˜å…³ç³»
2. **LEFT JOIN æˆå‘˜**ï¼šé€šè¿‡ `member_id` å…³è” `contact` è¡¨ï¼Œè·å–æˆå‘˜è¯¦ç»†ä¿¡æ¯
3. **LEFT JOIN ç¾¤**ï¼šé€šè¿‡ `room_id` å…³è” `contact` è¡¨ï¼Œè·å–ç¾¤è¯¦ç»†ä¿¡æ¯

**ç»“æœ**ï¼šæ¯æ¡è®°å½•åŒ…å« `room_id`, `member_id`, æˆå‘˜è¯¦ç»†ä¿¡æ¯, ç¾¤è¯¦ç»†ä¿¡æ¯ã€‚

---

## ğŸ¯ è¿”å›æ•°æ®ç¤ºä¾‹

### å®Œæ•´ JSON ç¤ºä¾‹

```json
[
  {
    "room_id": "27206515609@chatroom",
    "member_id": "wxid_abc123",
    "member_nickname": "å¼ ä¸‰",
    "member_alias": "zhangsan",
    "member_remark": "è€åŒå­¦",
    "member_avatar": "http://wx.qlogo.cn/...",
    "room_nickname": "æŠ€æœ¯äº¤æµç¾¤",
    "room_avatar": "http://wx.qlogo.cn/...",
    "room_remark": "å·¥ä½œç¾¤"
  },
  {
    "room_id": "27206515609@chatroom",
    "member_id": "wxid_xyz789",
    "member_nickname": "æå››",
    "member_alias": "lisi",
    "member_remark": "",
    "member_avatar": "http://wx.qlogo.cn/...",
    "room_nickname": "æŠ€æœ¯äº¤æµç¾¤",
    "room_avatar": "http://wx.qlogo.cn/...",
    "room_remark": "å·¥ä½œç¾¤"
  },
  {
    "room_id": "12345678@chatroom",
    "member_id": "wxid_test",
    "member_nickname": "ç‹äº”",
    "member_alias": "",
    "member_remark": "åŒäº‹",
    "member_avatar": "",
    "room_nickname": "äº§å“è®¨è®ºç»„",
    "room_avatar": "http://wx.qlogo.cn/...",
    "room_remark": ""
  }
]
```

### æ•°æ®å­—æ®µè¯´æ˜

| å­—æ®µ | æ¥æº | è¯´æ˜ |
|------|------|------|
| `room_id` | `chatroom_member.room_id` | ç¾¤ ID |
| `member_id` | `chatroom_member.member_id` | æˆå‘˜ ID |
| `member_nickname` | `contact.nick_name` | æˆå‘˜æ˜µç§° |
| `member_alias` | `contact.alias` | æˆå‘˜å¾®ä¿¡å· |
| `member_remark` | `contact.remark` | æˆå‘˜å¤‡æ³¨ |
| `member_avatar` | `contact.small_head_url` | æˆå‘˜å¤´åƒ |
| `room_nickname` | `contact.nick_name` | ç¾¤æ˜µç§° |
| `room_avatar` | `contact.small_head_url` | ç¾¤å¤´åƒ |
| `room_remark` | `contact.remark` | ç¾¤å¤‡æ³¨ |

---

## ğŸ“ ä»£ç å˜æ›´

### ä¿®æ”¹å‰

**åªè¿”å› ID**ï¼š

```cpp
std::string sql = 
    "SELECT "
    "room_id, "      // ç¾¤èŠ ID
    "member_id "     // æˆå‘˜ ID
    "FROM chatroom_member "
    "ORDER BY room_id, member_id";
```

**ç»“æœ**ï¼š
```json
[
  {"room_id": "10", "member_id": "7"}
]
```

---

### ä¿®æ”¹å

**è¿”å›å®Œæ•´ä¿¡æ¯**ï¼š

```cpp
std::string sql = 
    "SELECT "
    // ç¾¤æˆå‘˜å…³ç³»
    "cm.room_id, "
    "cm.member_id, "
    // æˆå‘˜è¯¦ç»†ä¿¡æ¯ï¼ˆä» contact è¡¨ï¼‰
    "c_member.nick_name AS member_nickname, "
    "c_member.alias AS member_alias, "
    "c_member.remark AS member_remark, "
    "c_member.small_head_url AS member_avatar, "
    // ç¾¤è¯¦ç»†ä¿¡æ¯ï¼ˆä» contact è¡¨ï¼‰
    "c_room.nick_name AS room_nickname, "
    "c_room.small_head_url AS room_avatar, "
    "c_room.remark AS room_remark "
    "FROM chatroom_member cm "
    "LEFT JOIN contact c_member ON cm.member_id = c_member.username "
    "LEFT JOIN contact c_room ON cm.room_id = c_room.username "
    "ORDER BY cm.room_id, cm.member_id";
```

**ç»“æœ**ï¼š
```json
[
  {
    "room_id": "27206515609@chatroom",
    "member_id": "wxid_abc123",
    "member_nickname": "å¼ ä¸‰",
    "member_alias": "zhangsan",
    "member_remark": "è€åŒå­¦",
    "member_avatar": "http://...",
    "room_nickname": "æŠ€æœ¯äº¤æµç¾¤",
    "room_avatar": "http://...",
    "room_remark": "å·¥ä½œç¾¤"
  }
]
```

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### 1. ç¼–è¯‘ WeixinX.dll

**åœ¨ Visual Studio ä¸­**ï¼š
```
æ‰“å¼€ï¼šWeixinX\WeixinX\WeixinX.vcxproj
é…ç½®ï¼šRelease | Win32
ç”Ÿæˆ â†’ é‡æ–°ç”Ÿæˆ
```

**æˆ–ä½¿ç”¨å‘½ä»¤è¡Œ**ï¼š
```cmd
cd D:\gitcode\wx4helper\WeixinX
"C:\Program Files (x86)\Microsoft Visual Studio\2019\Professional\MSBuild\Current\Bin\MSBuild.exe" ^
  WeixinX\WeixinX.vcxproj ^
  /p:Configuration=Release ^
  /p:Platform=Win32 ^
  /t:Rebuild ^
  /v:minimal
```

---

### 2. ç¡®è®¤ DLL ä½ç½®

**æ£€æŸ¥è·¯å¾„**ï¼š
```
D:\gitcode\wx4helper\BaiShengVx3Plus\bin\release\net8.0-windows\WeixinX.dll
```

**å¦‚æœä¸åœ¨è¿™ä¸ªè·¯å¾„**ï¼š
- æ£€æŸ¥ `WeixinX.vcxproj` çš„ PostBuildEvent
- æ‰‹åŠ¨å¤åˆ¶ DLL åˆ°è¯¥è·¯å¾„

---

### 3. è¿è¡Œ BaiShengVx3Plus

```
1. æ‰“å¼€ BaiShengVx3Plus.sln
2. F5 è¿è¡Œï¼ˆDebug æˆ– Release éƒ½å¯ä»¥ï¼‰
3. ç™»å½•
4. ç‚¹å‡»"è¿æ¥"ï¼ˆè‡ªåŠ¨å¯åŠ¨å¾®ä¿¡å¹¶æ³¨å…¥ DLLï¼‰
```

---

### 4. æµ‹è¯• GetGroupContacts å‘½ä»¤

**åœ¨è®¾ç½®çª—å£ä¸­**ï¼š

```
ç‚¹å‡»"è®¾ç½®"æŒ‰é’®
â†’ å‘½ä»¤æµ‹è¯•åŒºåŸŸ
â†’ ç‚¹å‡»"è·å–ç¾¤æˆå‘˜åˆ—è¡¨"æŒ‰é’®
```

**æˆ–æ‰‹åŠ¨è¾“å…¥å‘½ä»¤**ï¼š
```
GetGroupContacts()
```

---

### 5. æŸ¥çœ‹è¿”å›ç»“æœ

**é¢„æœŸç»“æœ**ï¼š

```json
[
  {
    "room_id": "27206515609@chatroom",
    "member_id": "wxid_abc123",
    "member_nickname": "å¼ ä¸‰",
    "member_alias": "zhangsan",
    "member_remark": "è€åŒå­¦",
    "member_avatar": "http://wx.qlogo.cn/mmhead/...",
    "room_nickname": "æŠ€æœ¯äº¤æµç¾¤",
    "room_avatar": "http://wx.qlogo.cn/mmhead/...",
    "room_remark": "å·¥ä½œç¾¤"
  },
  ...
]
```

**éªŒè¯ç‚¹**ï¼š
- [x] æ¯æ¡è®°å½•åŒ…å« `room_id` å’Œ `member_id`
- [x] åŒ…å« `member_nickname`, `member_alias` ç­‰æˆå‘˜è¯¦ç»†ä¿¡æ¯
- [x] åŒ…å« `room_nickname`, `room_avatar` ç­‰ç¾¤è¯¦ç»†ä¿¡æ¯
- [x] å¦‚æœæŸä¸ªå­—æ®µä¸ºç©ºï¼Œè¿”å›ç©ºå­—ç¬¦ä¸² `""`

---

## ğŸ”§ å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆä½¿ç”¨ LEFT JOINï¼Ÿ

**ç­”**ï¼šé˜²æ­¢æ•°æ®ç¼ºå¤±ã€‚

```sql
LEFT JOIN contact c_member ON cm.member_id = c_member.username
```

**æ•ˆæœ**ï¼š
- å¦‚æœ `contact` è¡¨ä¸­æ‰¾åˆ° `member_id` â†’ è¿”å›è¯¦ç»†ä¿¡æ¯
- å¦‚æœ `contact` è¡¨ä¸­æ‰¾ä¸åˆ° `member_id` â†’ è¿”å›ç©ºå­—ç¬¦ä¸²ï¼Œä½†è®°å½•ä»ç„¶ä¿ç•™

**å¥½å¤„**ï¼šå³ä½¿éƒ¨åˆ†æ•°æ®ç¼ºå¤±ï¼Œä¹Ÿä¸ä¼šä¸¢å¤±æ•´æ¡è®°å½•ã€‚

---

### Q2: å­—æ®µä¸º NULL æ€ä¹ˆåŠï¼Ÿ

**ç­”**ï¼šC++ ä»£ç å·²å¤„ç†ã€‚

```cpp
if (value != nullptr && strlen(value) > 0)
{
    member[columnName] = value;
}
else
{
    member[columnName] = "";  // NULL æˆ–ç©ºå­—ç¬¦ä¸²éƒ½è¿”å› ""
}
```

**ç»“æœ**ï¼šJSON ä¸­ä¸ä¼šå‡ºç° `null`ï¼Œè€Œæ˜¯ç©ºå­—ç¬¦ä¸² `""`ã€‚

---

### Q3: å¦‚ä½•åªæŸ¥è¯¢ç‰¹å®šç¾¤çš„æˆå‘˜ï¼Ÿ

**ç­”**ï¼šä¿®æ”¹ SQLï¼Œæ·»åŠ  WHERE æ¡ä»¶ã€‚

```cpp
// å½“å‰å®ç°ï¼šæŸ¥è¯¢æ‰€æœ‰ç¾¤
std::string sql = 
    "SELECT ... FROM chatroom_member cm ...";

// ä¿®æ”¹ä¸ºï¼šåªæŸ¥è¯¢ç‰¹å®šç¾¤
std::string sql = std::format(
    "SELECT ... FROM chatroom_member cm "
    "WHERE cm.room_id = '{}' ...",
    wxid  // ä¼ å…¥çš„ç¾¤ ID
);
```

**å½“å‰**ï¼š`wxid` å‚æ•°æš‚æ—¶æœªä½¿ç”¨ï¼ŒæŸ¥è¯¢æ‰€æœ‰ç¾¤æˆå‘˜ã€‚  
**å°†æ¥**ï¼šå¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ è¿‡æ»¤ã€‚

---

### Q4: æ•°æ®é‡å¤§æ€ä¹ˆåŠï¼Ÿ

**ç­”**ï¼šåˆ†æ‰¹æŸ¥è¯¢æˆ–æ·»åŠ åˆ†é¡µã€‚

```cpp
// æ–¹æ³•1ï¼šé™åˆ¶è¿”å›æ•°é‡
std::string sql = 
    "SELECT ... FROM chatroom_member cm ... LIMIT 1000";

// æ–¹æ³•2ï¼šåˆ†é¡µæŸ¥è¯¢
std::string sql = std::format(
    "SELECT ... FROM chatroom_member cm ... LIMIT {} OFFSET {}",
    pageSize, pageIndex * pageSize
);
```

---

## ğŸ¯ ä½¿ç”¨åœºæ™¯

### 1. æ˜¾ç¤ºç¾¤æˆå‘˜åˆ—è¡¨

**C# å®¢æˆ·ç«¯**ï¼š
```csharp
var result = await _socketClient.SendAsync<JsonDocument>("GetGroupContacts");
var members = result.RootElement.EnumerateArray();

foreach (var member in members)
{
    string roomId = member.GetProperty("room_id").GetString();
    string memberId = member.GetProperty("member_id").GetString();
    string memberName = member.GetProperty("member_nickname").GetString();
    string roomName = member.GetProperty("room_nickname").GetString();
    
    Console.WriteLine($"ç¾¤:{roomName}, æˆå‘˜:{memberName}");
}
```

---

### 2. ç»Ÿè®¡ç¾¤æˆå‘˜æ•°é‡

```csharp
var members = result.RootElement.EnumerateArray();
var groupCounts = members.GroupBy(m => m.GetProperty("room_id").GetString())
                         .Select(g => new { RoomId = g.Key, Count = g.Count() });

foreach (var group in groupCounts)
{
    Console.WriteLine($"ç¾¤ {group.RoomId} æœ‰ {group.Count} ä¸ªæˆå‘˜");
}
```

---

### 3. æŸ¥æ‰¾ç‰¹å®šæˆå‘˜æ‰€åœ¨çš„ç¾¤

```csharp
var targetMemberId = "wxid_abc123";
var groups = members.Where(m => m.GetProperty("member_id").GetString() == targetMemberId)
                    .Select(m => m.GetProperty("room_nickname").GetString())
                    .Distinct();

Console.WriteLine($"{targetMemberId} åœ¨ä»¥ä¸‹ç¾¤ä¸­:");
foreach (var group in groups)
{
    Console.WriteLine($"  - {group}");
}
```

---

## âœ… éªŒè¯æ¸…å•

### ç¼–è¯‘æ£€æŸ¥
- [ ] WeixinX.dll ç¼–è¯‘æˆåŠŸï¼ˆRelease | Win32ï¼‰
- [ ] DLL å¤åˆ¶åˆ° `bin\release\net8.0-windows\`

### åŠŸèƒ½æ£€æŸ¥
- [ ] è¿è¡Œ BaiShengVx3Plus æ— é”™è¯¯
- [ ] ç‚¹å‡»"è¿æ¥"æˆåŠŸå¯åŠ¨å¾®ä¿¡
- [ ] ç‚¹å‡»"è·å–ç¾¤æˆå‘˜åˆ—è¡¨"è¿”å›æ•°æ®
- [ ] è¿”å›çš„ JSON åŒ…å«æˆå‘˜è¯¦ç»†ä¿¡æ¯
- [ ] è¿”å›çš„ JSON åŒ…å«ç¾¤è¯¦ç»†ä¿¡æ¯
- [ ] å­—æ®µä¸ºç©ºæ—¶è¿”å› `""`ï¼Œè€Œä¸æ˜¯ `null`

### æ•°æ®éªŒè¯
- [ ] `room_id` å’Œ `member_id` æ­£ç¡®
- [ ] `member_nickname`, `member_alias` ç­‰å­—æ®µæœ‰å€¼
- [ ] `room_nickname`, `room_avatar` ç­‰å­—æ®µæœ‰å€¼
- [ ] å¤šä¸ªç¾¤çš„æ•°æ®éƒ½èƒ½æ­£ç¡®è¿”å›

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- `20251106-è·å–ç¾¤æˆå‘˜åˆ—è¡¨åŠŸèƒ½å®ç°.md` - åŸºç¡€åŠŸèƒ½å®ç°
- `GET_CONTACTS_IMPLEMENTATION.md` - GetContacts å®ç°å‚è€ƒ
- `SOCKET_COMMUNICATION_GUIDE.md` - Socket é€šä¿¡æŒ‡å—

---

## ğŸ¯ æŠ€æœ¯è¦ç‚¹

### 1. SQL LEFT JOIN

```sql
FROM chatroom_member cm
LEFT JOIN contact c_member ON cm.member_id = c_member.username
```

**ä½œç”¨**ï¼š
- ä» `chatroom_member` è¯»å–æ‰€æœ‰è®°å½•
- é€šè¿‡ `member_id` å…³è” `contact` è¡¨
- å¦‚æœ `contact` è¡¨ä¸­æ²¡æœ‰å¯¹åº”è®°å½•ï¼Œä»ä¿ç•™ `chatroom_member` çš„è®°å½•

---

### 2. å­—æ®µåˆ«åï¼ˆASï¼‰

```sql
c_member.nick_name AS member_nickname
```

**ä½œç”¨**ï¼š
- é¿å…å­—æ®µåå†²çªï¼ˆ`c_member.nick_name` vs `c_room.nick_name`ï¼‰
- ä½¿ JSON å­—æ®µåæ›´æ¸…æ™°ï¼ˆ`member_nickname` vs `room_nickname`ï¼‰

---

### 3. get_table è¿”å›æ ¼å¼

```
result[0...col-1]:  åˆ—å
result[col...]:     æ•°æ®ï¼ˆæŒ‰è¡Œåˆ—é¡ºåºï¼‰
```

**éå†**ï¼š
```cpp
int idx = col;  // è·³è¿‡åˆ—å
for (int x = 0; x < row; x++) {
    for (int y = 0; y < col; y++) {
        const char* columnName = result[y];
        const char* value = result[idx++];
    }
}
```

---

**å®ç°æ—¶é—´**: 2025å¹´11æœˆ6æ—¥ 01:15  
**çŠ¶æ€**: âœ… ä»£ç å·²å®Œæˆï¼Œå¾…ç¼–è¯‘æµ‹è¯•  
**ä¸‹ä¸€æ­¥**: **æ‰‹åŠ¨ç¼–è¯‘ WeixinX.dllï¼Œç„¶åè¿è¡Œæµ‹è¯•ï¼** ğŸš€

