# 数据库删除后连接问题 - 分析

## 📋 问题描述

用户反馈：**数据库删除后，重新打开程序，关闭飞单，启动飞单，弹出的浏览器，输入账号密码后，连接又不对了。在高级设置中进行投注命令，又出现未连接了。**

---

## 🔍 问题分析

### 可能的原因1：配置 ID 不匹配

```
数据库删除前：
  - 默认配置 Id = 5
  - 浏览器启动：--config-id 5
  - 连接正常 ✅

数据库删除后：
  - EnsureDefaultConfig 创建新配置
  - 新的默认配置 Id = 1 ← 重新从1开始
  - 浏览器启动：--config-id 1
  - 连接正常 ✅

但是！如果有旧浏览器还在运行：
  - 旧浏览器 configId = 5
  - 新配置 Id = 1
  - OnBrowserConnected 检查：GetConfig(5) → null
  - ❌ 连接被拒绝！
```

### 可能的原因2：浏览器进程残留

```
1. 关闭飞单
   └─ StopBrowser
        └─ browserClient.Dispose()  ← 应该关闭进程
             └─ 但进程可能没有完全关闭？

2. 启动飞单
   └─ StartBrowser
        └─ 启动新浏览器进程
             ├─ 新浏览器 configId = 1
             └─ 如果旧浏览器还在运行：
                  ├─ 旧浏览器 configId = 1 (旧的)
                  └─ 新浏览器 configId = 1 (新的)
                       └─ 冲突！
```

### 可能的原因3：Socket 连接状态不同步

```
浏览器启动流程：
1. 浏览器进程启动
2. 浏览器连接到 VxMain:19527
3. 握手成功，OnBrowserConnected 被调用
4. _browsers[configId] = browserClient ✅

用户操作流程：
1. 用户输入账号密码
2. 登录成功
3. 浏览器发送消息给 VxMain
4. VxMain 处理消息

在高级设置中投注：
1. 查找 _browsers[configId]
2. 如果找不到 → "未连接" ❌
```

---

## 🔍 日志分析建议

需要查看以下日志来确定问题：

```
1. 数据库删除后，第一次启动：
   ✅ EnsureDefaultConfig 创建配置，Id = ?
   ✅ StartBrowser 启动浏览器，configId = ?

2. 浏览器连接：
   ✅ 浏览器握手成功，配置ID: ?
   ✅ OnBrowserConnected，configId = ?
   ✅ GetConfig(configId) → 配置是否存在？
   ✅ _browsers 字典: [...]

3. 关闭飞单：
   ✅ StopBrowser，configId = ?
   ✅ browserClient.Dispose() 是否调用？
   ✅ 浏览器进程是否关闭？
   ✅ _browsers 字典: [...]

4. 再次启动飞单：
   ✅ StartBrowser，configId = ?
   ✅ 启动新浏览器进程
   ✅ 浏览器握手成功，配置ID: ?
   ✅ OnBrowserConnected，configId = ?
   ✅ _browsers 字典: [...]

5. 在高级设置中投注：
   ✅ 查找 _browsers[configId]，是否找到？
   ✅ 如果未找到，configId = ? 当前 _browsers 字典: [...]
```

---

## ✅ 临时解决方案

### 方案1：增强日志输出

在关键位置增加更详细的日志，帮助定位问题。

### 方案2：强制清理浏览器进程

在 `StopBrowser` 中，确保浏览器进程完全关闭：

```csharp
public void StopBrowser(int configId)
{
    var config = GetConfig(configId);
    
    // 标记配置为禁用状态
    if (config != null && config.IsEnabled)
    {
        config.IsEnabled = false;
        _log.Info("AutoBet", $"✅ 配置 [{config.ConfigName}] 飞单已关闭");
    }
    
    // 关闭浏览器进程
    if (_browsers.TryGetValue(configId, out var browserClient))
    {
        _log.Info("AutoBet", $"🔥 正在关闭浏览器进程...");
        _log.Info("AutoBet", $"   ConfigId: {configId}");
        _log.Info("AutoBet", $"   进程ID: {browserClient.ProcessId}");
        
        browserClient.Dispose();
        
        lock (_lock)
        {
            _browsers.Remove(configId);
        }
        
        _log.Info("AutoBet", $"✅ 浏览器进程已关闭");
        _log.Info("AutoBet", $"   更新后 _browsers 字典: [{string.Join(", ", _browsers.Keys)}]");
        
        if (config != null)
        {
            config.Status = "已停止";
        }
        
        _log.Info("AutoBet", $"⏹️ 浏览器已停止: {config?.ConfigName}");
    }
    else
    {
        _log.Warning("AutoBet", $"⚠️ _browsers 字典中未找到 configId={configId}");
        _log.Warning("AutoBet", $"   当前 _browsers 字典: [{string.Join(", ", _browsers.Keys)}]");
    }
}
```

### 方案3：在 `OnBrowserConnected` 中增强容错

如果配置不存在，尝试查找默认配置：

```csharp
private void OnBrowserConnected(int configId, TcpClient client)
{
    try
    {
        _log.Info("AutoBet", $"🔗 浏览器已通过 Socket 连接，配置ID: {configId}");
        _log.Info("AutoBet", $"   当前 _browsers 字典: [{string.Join(", ", _browsers.Keys)}]");
        
        // 检查配置是否存在
        var config = GetConfig(configId);
        if (config == null)
        {
            _log.Warning("AutoBet", $"⚠️ 配置不存在: {configId}");
            _log.Warning("AutoBet", $"   尝试查找默认配置...");
            
            // 🔥 容错：尝试使用默认配置
            config = GetConfigs().FirstOrDefault(c => c.IsDefault);
            if (config != null)
            {
                _log.Info("AutoBet", $"✅ 找到默认配置: {config.ConfigName} (Id={config.Id})");
                _log.Info("AutoBet", $"   将使用默认配置的ID替代浏览器的configId");
                configId = config.Id;  // ← 使用默认配置的ID
            }
            else
            {
                _log.Error("AutoBet", $"❌ 未找到默认配置，拒绝连接");
                return;
            }
        }
        
        _log.Info("AutoBet", $"✅ 配置信息: {config.ConfigName} ({config.Platform})");
        
        // 创建或更新 BrowserClient
        if (_browsers.TryGetValue(configId, out var existingBrowser))
        {
            _log.Info("AutoBet", $"📌 _browsers 字典中已存在该 configId，更新 Socket 连接");
            existingBrowser.AttachConnection(client);
        }
        else
        {
            _log.Info("AutoBet", $"📌 _browsers 字典中无此 configId，自动创建 BrowserClient");
            var browserClient = new BrowserClient(configId);
            browserClient.AttachConnection(client);
            _browsers[configId] = browserClient;
        }
        
        // 更新配置状态
        config.Status = "已连接";
        SaveConfig(config);
        
        _log.Info("AutoBet", $"✅ 浏览器 Socket 连接处理完成: {config.ConfigName}");
        _log.Info("AutoBet", $"   更新后 _browsers 字典: [{string.Join(", ", _browsers.Keys)}]");
    }
    catch (Exception ex)
    {
        _log.Error("AutoBet", $"❌ 处理浏览器连接失败: {configId}", ex);
    }
}
```

---

## 🎯 建议

1. **首先**：查看日志，确定问题的具体原因
2. **然后**：根据日志信息选择合适的修复方案
3. **最后**：测试修复效果

---

## 📝 待确认的问题

1. ✅ 数据库删除后，默认配置的 Id 是多少？
2. ✅ 浏览器启动时的 configId 是多少？
3. ✅ 浏览器连接时，OnBrowserConnected 接收到的 configId 是多少？
4. ✅ GetConfig(configId) 返回的是 null 还是有效配置？
5. ✅ _browsers 字典中的 key 是什么？
6. ✅ 在高级设置中投注时，查找的 configId 是多少？

**请提供日志文件，以便准确定位问题！** 🎯

