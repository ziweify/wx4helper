# ç¾¤æˆå‘˜ ID æ˜ å°„ä¿®å¤

**é—®é¢˜å‘ç°æ—¶é—´**: 2025å¹´11æœˆ6æ—¥ 01:25  
**çŠ¶æ€**: âœ… å·²ä¿®å¤  
**é—®é¢˜**: `GetGroupContacts()` è¿”å›ç©ºçš„è¯¦ç»†ä¿¡æ¯

---

## ğŸ› é—®é¢˜åˆ†æ

### å®é™…è¿”å›æ•°æ®

```json
[
  {
    "member_id": "7",      // â† æ•°å­— ID
    "room_id": "10",       // â† æ•°å­— ID
    "member_nickname": "", // â† ç©º
    "member_alias": "",    // â† ç©º
    "room_nickname": "",   // â† ç©º
    ...                    // æ‰€æœ‰è¯¦ç»†ä¿¡æ¯éƒ½æ˜¯ç©º
  }
]
```

### æœŸæœ›æ•°æ®

```json
[
  {
    "room_id": "10",
    "room_wxid": "27206515609@chatroom",
    "member_id": "7",
    "member_wxid": "wxid_5nl4ex9mz40t12",
    "member_nickname": "é±¼å„¿å®",
    "member_alias": "AYY8-8",
    "room_nickname": "ç‰©æµåŒæ­¥",
    ...
  }
]
```

---

## ğŸ” æ ¹æœ¬åŸå› 

### æ•°æ®åº“è¡¨å…³ç³»

#### è¡¨1: `chatroom_member`ï¼ˆç¾¤æˆå‘˜å…³ç³»ï¼‰

```sql
CREATE TABLE chatroom_member(
    room_id INTEGER,    -- â— å­˜å‚¨çš„æ˜¯æ•°å­— IDï¼Œä¸æ˜¯å¾®ä¿¡ ID
    member_id INTEGER,  -- â— å­˜å‚¨çš„æ˜¯æ•°å­— IDï¼Œä¸æ˜¯å¾®ä¿¡ ID
    CONSTRAINT room_member UNIQUE(room_id, member_id)
)
```

**ç¤ºä¾‹æ•°æ®**:
| room_id | member_id |
|---------|-----------|
| 10 | 7 |
| 10 | 8 |

---

#### è¡¨2: `chat_room`ï¼ˆç¾¤ ID æ˜ å°„è¡¨ï¼‰

```sql
CREATE TABLE chat_room(
    id INTEGER PRIMARY KEY,      -- âœ… æ•°å­— ID
    username TEXT,               -- âœ… å¾®ä¿¡ ID
    owner TEXT,
    ext_buffer BLOB
)
```

**ç¤ºä¾‹æ•°æ®**:
| id | username |
|----|----------|
| 10 | 27206515609@chatroom |
| 11 | 12345678@chatroom |

**ä½œç”¨**: **æ˜ å°„ `room_id` (æ•°å­—) â†’ `username` (å¾®ä¿¡ID)**

---

#### è¡¨3: `contact`ï¼ˆè”ç³»äººè¯¦ç»†ä¿¡æ¯ï¼‰

```sql
CREATE TABLE contact(
    id INTEGER PRIMARY KEY,      -- âœ… æ•°å­— ID
    username TEXT,               -- âœ… å¾®ä¿¡ ID
    nick_name TEXT,
    alias TEXT,
    ...
)
```

**ç¤ºä¾‹æ•°æ®**:
| id | username | nick_name | alias |
|----|----------|-----------|-------|
| 7 | wxid_5nl4ex9mz40t12 | é±¼å„¿å® | AYY8-8 |
| 8 | wxid_0y9nzscw4bcp12 | å¯Œè´µ | |

**ä½œç”¨**: å­˜å‚¨è”ç³»äººè¯¦ç»†ä¿¡æ¯ï¼ˆåŒ…æ‹¬å¥½å‹å’Œç¾¤ï¼‰

---

### é”™è¯¯çš„ JOIN é€»è¾‘

**ä¿®æ”¹å‰çš„ SQL**:
```sql
FROM chatroom_member cm
LEFT JOIN contact c_member ON cm.member_id = c_member.username  -- âŒ é”™è¯¯
LEFT JOIN contact c_room ON cm.room_id = c_room.username        -- âŒ é”™è¯¯
```

**é—®é¢˜**:
```
cm.member_id = "7" (æ•°å­—)
c_member.username = "wxid_5nl4ex9mz40t12" (å­—ç¬¦ä¸²)
â†’ "7" != "wxid_5nl4ex9mz40t12" âŒ
â†’ JOIN å¤±è´¥ï¼Œè¿”å›ç©ºæ•°æ®
```

---

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

### æ­£ç¡®çš„ JOIN é€»è¾‘

**ä¿®æ”¹åçš„ SQL**:
```sql
FROM chatroom_member cm
-- æ­¥éª¤1: é€šè¿‡ chat_room è¡¨æ˜ å°„ room_id (æ•°å­—) â†’ username (å¾®ä¿¡ID)
LEFT JOIN chat_room cr ON cm.room_id = cr.id

-- æ­¥éª¤2: é€šè¿‡ contact è¡¨æ˜ å°„ member_id (æ•°å­—) â†’ username (å¾®ä¿¡ID)
LEFT JOIN contact c_member ON cm.member_id = c_member.id

-- æ­¥éª¤3: é€šè¿‡ contact è¡¨è·å–ç¾¤è¯¦ç»†ä¿¡æ¯
LEFT JOIN contact c_room ON cr.username = c_room.username
```

---

### æ•°æ®æµ

```
chatroom_member
  room_id = 10
  member_id = 7
     â†“
[JOIN chat_room ON room_id = cr.id]
     â†“
  cr.id = 10
  cr.username = "27206515609@chatroom"
     â†“
[JOIN contact c_member ON member_id = c_member.id]
     â†“
  c_member.id = 7
  c_member.username = "wxid_5nl4ex9mz40t12"
  c_member.nick_name = "é±¼å„¿å®"
  c_member.alias = "AYY8-8"
     â†“
[JOIN contact c_room ON cr.username = c_room.username]
     â†“
  c_room.username = "27206515609@chatroom"
  c_room.nick_name = "ç‰©æµåŒæ­¥"
  c_room.small_head_url = "https://..."
     â†“
æœ€ç»ˆç»“æœ:
  room_id: "10"
  room_wxid: "27206515609@chatroom"
  member_id: "7"
  member_wxid: "wxid_5nl4ex9mz40t12"
  member_nickname: "é±¼å„¿å®"
  member_alias: "AYY8-8"
  room_nickname: "ç‰©æµåŒæ­¥"
  room_avatar: "https://..."
```

---

## ğŸ“ å®Œæ•´ SQL

**æ–‡ä»¶**: `WeixinX/WeixinX/Features.cpp`

```cpp
std::string sql = 
    "SELECT "
    // ç¾¤æˆå‘˜å…³ç³»ï¼ˆåŸå§‹æ•°å­— IDï¼‰
    "cm.room_id, "
    "cm.member_id, "
    // ç¾¤å¾®ä¿¡ IDï¼ˆä» chat_room è¡¨æ˜ å°„ï¼‰
    "cr.username AS room_wxid, "
    // æˆå‘˜å¾®ä¿¡ IDï¼ˆä» contact è¡¨é€šè¿‡ id æ˜ å°„ï¼‰
    "c_member.username AS member_wxid, "
    // æˆå‘˜è¯¦ç»†ä¿¡æ¯ï¼ˆä» contact è¡¨ï¼‰
    "c_member.nick_name AS member_nickname, "
    "c_member.alias AS member_alias, "
    "c_member.remark AS member_remark, "
    "c_member.small_head_url AS member_avatar, "
    // ç¾¤è¯¦ç»†ä¿¡æ¯ï¼ˆä» contact è¡¨ï¼‰
    "c_room.nick_name AS room_nickname, "
    "c_room.small_head_url AS room_avatar, "
    "c_room.remark AS room_remark "
    "FROM chatroom_member cm "
    // LEFT JOIN chat_room è¡¨ï¼šroom_id (æ•°å­—) -> username (å¾®ä¿¡ID)
    "LEFT JOIN chat_room cr ON cm.room_id = cr.id "
    // LEFT JOIN contact è¡¨ï¼ˆæˆå‘˜ï¼‰ï¼šmember_id (æ•°å­—) -> id -> username
    "LEFT JOIN contact c_member ON cm.member_id = c_member.id "
    // LEFT JOIN contact è¡¨ï¼ˆç¾¤ï¼‰ï¼šroom_wxid (å¾®ä¿¡ID) -> username
    "LEFT JOIN contact c_room ON cr.username = c_room.username "
    "ORDER BY cm.room_id, cm.member_id";
```

---

## ğŸ¯ å…³é”®æ”¹åŠ¨

### ä¿®æ”¹å‰

| JOIN | æ¡ä»¶ | ç»“æœ |
|------|------|------|
| `contact c_member` | `cm.member_id = c_member.username` | âŒ æ•°å­— != å­—ç¬¦ä¸² |
| `contact c_room` | `cm.room_id = c_room.username` | âŒ æ•°å­— != å­—ç¬¦ä¸² |

**é—®é¢˜**: ç›´æ¥ç”¨æ•°å­— ID å»åŒ¹é…å¾®ä¿¡ ID å­—ç¬¦ä¸²ï¼Œæ°¸è¿œåŒ¹é…ä¸ä¸Šã€‚

---

### ä¿®æ”¹å

| JOIN | æ¡ä»¶ | ç»“æœ |
|------|------|------|
| `chat_room cr` | `cm.room_id = cr.id` | âœ… æ•°å­— = æ•°å­— |
| `contact c_member` | `cm.member_id = c_member.id` | âœ… æ•°å­— = æ•°å­— |
| `contact c_room` | `cr.username = c_room.username` | âœ… å­—ç¬¦ä¸² = å­—ç¬¦ä¸² |

**æ•ˆæœ**: é€šè¿‡ `chat_room` å’Œ `contact.id` æ­£ç¡®æ˜ å°„æ•°å­— ID åˆ°å¾®ä¿¡ IDã€‚

---

## ğŸ“Š è¿”å›æ•°æ®ç¤ºä¾‹

### ä¿®å¤åçš„è¿”å›æ•°æ®

```json
[
  {
    "room_id": "10",
    "member_id": "7",
    "room_wxid": "27206515609@chatroom",
    "member_wxid": "wxid_5nl4ex9mz40t12",
    "member_nickname": "é±¼å„¿å®",
    "member_alias": "AYY8-8",
    "member_remark": "",
    "member_avatar": "https://wx.qlogo.cn/mmhead/...",
    "room_nickname": "ç‰©æµåŒæ­¥",
    "room_avatar": "https://mmhead.hk.wechat.com/...",
    "room_remark": ""
  },
  {
    "room_id": "10",
    "member_id": "8",
    "room_wxid": "27206515609@chatroom",
    "member_wxid": "wxid_0y9nzscw4bcp12",
    "member_nickname": "å¯Œè´µ",
    "member_alias": "",
    "member_remark": "",
    "member_avatar": "",
    "room_nickname": "ç‰©æµåŒæ­¥",
    "room_avatar": "https://mmhead.hk.wechat.com/...",
    "room_remark": ""
  }
]
```

### å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | æ¥æº | è¯´æ˜ |
|------|------|------|------|
| `room_id` | INTEGER | `chatroom_member.room_id` | ç¾¤çš„æ•°å­— ID |
| `member_id` | INTEGER | `chatroom_member.member_id` | æˆå‘˜çš„æ•°å­— ID |
| `room_wxid` | TEXT | `chat_room.username` | ç¾¤çš„å¾®ä¿¡ ID |
| `member_wxid` | TEXT | `contact.username` | æˆå‘˜çš„å¾®ä¿¡ ID |
| `member_nickname` | TEXT | `contact.nick_name` | æˆå‘˜æ˜µç§° |
| `member_alias` | TEXT | `contact.alias` | æˆå‘˜å¾®ä¿¡å· |
| `member_remark` | TEXT | `contact.remark` | æˆå‘˜å¤‡æ³¨ |
| `member_avatar` | TEXT | `contact.small_head_url` | æˆå‘˜å¤´åƒ |
| `room_nickname` | TEXT | `contact.nick_name` | ç¾¤æ˜µç§° |
| `room_avatar` | TEXT | `contact.small_head_url` | ç¾¤å¤´åƒ |
| `room_remark` | TEXT | `contact.remark` | ç¾¤å¤‡æ³¨ |

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### 1. ç¼–è¯‘ WeixinX.dll

**Visual Studio**:
```
1. æ‰“å¼€ WeixinX.vcxproj
2. Release | Win32
3. ç”Ÿæˆ â†’ é‡æ–°ç”Ÿæˆ
```

---

### 2. æµ‹è¯•å‘½ä»¤

```
GetGroupContacts()
```

---

### 3. éªŒè¯è¿”å›æ•°æ®

**æ£€æŸ¥ç‚¹**:
- [x] `room_id` å’Œ `member_id` æ˜¯æ•°å­—
- [x] `room_wxid` æ˜¯å¾®ä¿¡ ID å­—ç¬¦ä¸²ï¼ˆå¦‚ `27206515609@chatroom`ï¼‰
- [x] `member_wxid` æ˜¯å¾®ä¿¡ ID å­—ç¬¦ä¸²ï¼ˆå¦‚ `wxid_5nl4ex9mz40t12`ï¼‰
- [x] `member_nickname` ä¸ä¸ºç©ºï¼ˆå¦‚ `é±¼å„¿å®`ï¼‰
- [x] `member_alias` å¯èƒ½ä¸ºç©ºæˆ–æœ‰å€¼ï¼ˆå¦‚ `AYY8-8`ï¼‰
- [x] `room_nickname` ä¸ä¸ºç©ºï¼ˆå¦‚ `ç‰©æµåŒæ­¥`ï¼‰
- [x] `room_avatar` æ˜¯ URL

---

## ğŸ”§ å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆ `chatroom_member` å­˜å‚¨æ•°å­— ID è€Œä¸æ˜¯å¾®ä¿¡ IDï¼Ÿ

**ç­”**: èŠ‚çœç©ºé—´ï¼Œæé«˜æŸ¥è¯¢æ•ˆç‡ã€‚

**æ•°å­— ID**:
- å­˜å‚¨: 4 å­—èŠ‚ï¼ˆINTEGERï¼‰
- æŸ¥è¯¢: å¿«é€Ÿï¼ˆæ•´æ•°æ¯”è¾ƒï¼‰

**å¾®ä¿¡ ID å­—ç¬¦ä¸²**:
- å­˜å‚¨: ~30 å­—èŠ‚ï¼ˆTEXTï¼‰
- æŸ¥è¯¢: æ…¢ï¼ˆå­—ç¬¦ä¸²æ¯”è¾ƒï¼‰

**è®¾è®¡**:
- `chatroom_member`: å­˜å‚¨å…³ç³»ï¼ˆæ•°å­— IDï¼‰
- `chat_room`: æ˜ å°„è¡¨ï¼ˆæ•°å­— ID â†’ å¾®ä¿¡ IDï¼‰
- `contact`: è¯¦ç»†ä¿¡æ¯ï¼ˆå¾®ä¿¡ ID â†’ æ˜µç§°ã€å¤´åƒç­‰ï¼‰

---

### Q2: ä¸ºä»€ä¹ˆéœ€è¦ 3 æ¬¡ JOINï¼Ÿ

**ç­”**: å› ä¸ºæœ‰ä¸¤å±‚æ˜ å°„å…³ç³»ã€‚

```
chatroom_member (æ•°å­—ID)
   â†“ JOIN chat_room
chat_room (æ•°å­—ID + å¾®ä¿¡ID)
   â†“ JOIN contact
contact (å¾®ä¿¡ID + è¯¦ç»†ä¿¡æ¯)
```

**æ­¥éª¤**:
1. JOIN `chat_room`: è·å–ç¾¤çš„å¾®ä¿¡ ID
2. JOIN `contact` (æˆå‘˜): è·å–æˆå‘˜è¯¦ç»†ä¿¡æ¯
3. JOIN `contact` (ç¾¤): è·å–ç¾¤è¯¦ç»†ä¿¡æ¯

---

### Q3: å¦‚æœ `chat_room` è¡¨ä¸­æ²¡æœ‰å¯¹åº”çš„ç¾¤æ€ä¹ˆåŠï¼Ÿ

**ç­”**: ä½¿ç”¨ `LEFT JOIN`ï¼Œä¿ç•™è®°å½•ã€‚

```sql
LEFT JOIN chat_room cr ON cm.room_id = cr.id
```

**æ•ˆæœ**:
- å¦‚æœ `chat_room` è¡¨ä¸­æœ‰è®°å½• â†’ è¿”å› `room_wxid`
- å¦‚æœ `chat_room` è¡¨ä¸­æ²¡æœ‰è®°å½• â†’ `room_wxid` ä¸ºç©ºï¼Œä½†è®°å½•ä»ç„¶ä¿ç•™

---

### Q4: ä¸ºä»€ä¹ˆåŒæ—¶è¿”å›æ•°å­— ID å’Œå¾®ä¿¡ IDï¼Ÿ

**ç­”**: æ–¹ä¾¿è°ƒè¯•å’Œè¿½æº¯ã€‚

**æ•°å­— ID** (`room_id`, `member_id`):
- æ•°æ®åº“å†…éƒ¨ä½¿ç”¨
- æ–¹ä¾¿è°ƒè¯•ï¼ˆçŸ¥é“åŸå§‹æ•°æ®ï¼‰

**å¾®ä¿¡ ID** (`room_wxid`, `member_wxid`):
- å¯¹å¤–ä½¿ç”¨ï¼ˆå‘é€æ¶ˆæ¯ç­‰ï¼‰
- ç”¨æˆ·å¯è¯»

---

## ğŸ¯ ä½¿ç”¨åœºæ™¯

### 1. æ˜¾ç¤ºç¾¤æˆå‘˜åˆ—è¡¨ï¼ˆå¸¦å¤´åƒï¼‰

```csharp
var result = await _socketClient.SendAsync<JsonDocument>("GetGroupContacts");
var members = result.RootElement.EnumerateArray();

foreach (var member in members)
{
    string roomName = member.GetProperty("room_nickname").GetString();
    string memberName = member.GetProperty("member_nickname").GetString();
    string memberWxid = member.GetProperty("member_wxid").GetString();
    string avatar = member.GetProperty("member_avatar").GetString();
    
    // æ˜¾ç¤ºåœ¨ UI
    AddMemberToList(roomName, memberName, memberWxid, avatar);
}
```

---

### 2. å‘é€æ¶ˆæ¯ç»™ç¾¤æˆå‘˜

```csharp
var result = await _socketClient.SendAsync<JsonDocument>("GetGroupContacts");
var members = result.RootElement.EnumerateArray();

foreach (var member in members)
{
    string roomWxid = member.GetProperty("room_wxid").GetString();
    string memberWxid = member.GetProperty("member_wxid").GetString();
    
    // å‘é€æ¶ˆæ¯
    await _socketClient.SendAsync("SendMessage", roomWxid, "ä½ å¥½ï¼");
}
```

---

### 3. ç»Ÿè®¡æ¯ä¸ªç¾¤çš„æˆå‘˜æ•°é‡

```csharp
var result = await _socketClient.SendAsync<JsonDocument>("GetGroupContacts");
var members = result.RootElement.EnumerateArray();

var groupCounts = members.GroupBy(m => m.GetProperty("room_wxid").GetString())
                         .Select(g => new 
                         { 
                             RoomWxid = g.Key, 
                             RoomName = g.First().GetProperty("room_nickname").GetString(),
                             Count = g.Count() 
                         });

foreach (var group in groupCounts)
{
    Console.WriteLine($"{group.RoomName} ({group.RoomWxid}): {group.Count} ä¸ªæˆå‘˜");
}
```

---

## âœ… éªŒè¯æ¸…å•

### ç¼–è¯‘æ£€æŸ¥
- [ ] WeixinX.dll ç¼–è¯‘æˆåŠŸ
- [ ] æ— ç¼–è¯‘é”™è¯¯å’Œè­¦å‘Š

### æ•°æ®æ£€æŸ¥
- [ ] `room_id` å’Œ `member_id` æ˜¯æ•°å­—
- [ ] `room_wxid` å’Œ `member_wxid` æ˜¯å¾®ä¿¡ ID å­—ç¬¦ä¸²
- [ ] `member_nickname` ä¸ä¸ºç©º
- [ ] `room_nickname` ä¸ä¸ºç©º
- [ ] å¤´åƒ URL æ­£ç¡®ï¼ˆå¯èƒ½ä¸ºç©ºï¼‰

### åŠŸèƒ½æ£€æŸ¥
- [ ] èƒ½æ­£å¸¸è¿”å›ç¾¤æˆå‘˜åˆ—è¡¨
- [ ] æ‰€æœ‰å­—æ®µéƒ½æœ‰æ­£ç¡®çš„å€¼
- [ ] å¤šä¸ªç¾¤çš„æ•°æ®éƒ½èƒ½æ­£ç¡®æ˜¾ç¤º

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- `20251106-è·å–ç¾¤æˆå‘˜è¯¦ç»†ä¿¡æ¯åŠŸèƒ½.md` - åŠŸèƒ½å®ç°
- `20251106-è·å–ç¾¤æˆå‘˜åˆ—è¡¨åŠŸèƒ½å®ç°.md` - åŸºç¡€å®ç°
- `GET_CONTACTS_IMPLEMENTATION.md` - GetContacts å‚è€ƒ

---

## ğŸ¯ æŠ€æœ¯è¦ç‚¹

### 1. æ•°å­— ID vs å¾®ä¿¡ ID

```
æ•°å­— ID (INTEGER):
  - chatroom_member.room_id
  - chatroom_member.member_id
  - chat_room.id
  - contact.id

å¾®ä¿¡ ID (TEXT):
  - chat_room.username
  - contact.username
```

**æ˜ å°„å…³ç³»**:
```
chatroom_member.room_id â†’ chat_room.id â†’ chat_room.username
chatroom_member.member_id â†’ contact.id â†’ contact.username
```

---

### 2. LEFT JOIN çš„ä½œç”¨

```sql
LEFT JOIN chat_room cr ON cm.room_id = cr.id
```

**æ•ˆæœ**:
- ä¿ç•™æ‰€æœ‰ `chatroom_member` çš„è®°å½•
- å¦‚æœ `chat_room` è¡¨ä¸­æ²¡æœ‰å¯¹åº”è®°å½•ï¼Œå³ä¾§å­—æ®µä¸º NULL
- å¦‚æœ `chat_room` è¡¨ä¸­æœ‰å¯¹åº”è®°å½•ï¼Œè¿”å›å®Œæ•´æ•°æ®

---

### 3. å­—æ®µåˆ«åï¼ˆASï¼‰

```sql
c_member.nick_name AS member_nickname
c_room.nick_name AS room_nickname
```

**ä½œç”¨**:
- é¿å…å­—æ®µåå†²çª
- ä½¿ JSON å­—æ®µåæ›´æ¸…æ™°

---

**ä¿®å¤æ—¶é—´**: 2025å¹´11æœˆ6æ—¥ 01:25  
**çŠ¶æ€**: âœ… å·²ä¿®å¤ï¼Œå¾…ç¼–è¯‘æµ‹è¯•  
**ä¸‹ä¸€æ­¥**: **ç¼–è¯‘ WeixinX.dllï¼Œæµ‹è¯• GetGroupContacts() å‘½ä»¤ï¼** ğŸš€

