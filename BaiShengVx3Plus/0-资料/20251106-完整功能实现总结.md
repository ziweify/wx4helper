# å®Œæ•´åŠŸèƒ½å®ç°æ€»ç»“

**å®ç°æ—¶é—´**: 2025å¹´11æœˆ6æ—¥ 01:40  
**çŠ¶æ€**: âœ… ä»£ç å·²å®Œæˆï¼Œå¾…ç¼–è¯‘æµ‹è¯•  

---

## ğŸ¯ æœ¬æ¬¡å®ç°çš„åŠŸèƒ½

### 1. DLL è·¯å¾„ä¿®å¤

**é—®é¢˜**: æ‰¾ä¸åˆ° `WeixinX.dll` å’Œ `Loader.dll`

**è§£å†³æ–¹æ¡ˆ**:
- âœ… `WeChatService.cs`: ä½¿ç”¨å›ºå®šè·¯å¾„ `bin\release\net8.0-windows\WeixinX.dll`
- âœ… `LoaderNative.cs`: ä½¿ç”¨é™æ€æ„é€ å‡½æ•°é¢„åŠ è½½ `Loader.dll`

**æ–‡æ¡£**: `20251106-DLLè·¯å¾„ä¿®å¤.md`, `20251106-Loader-DLLè·¯å¾„ä¿®å¤.md`

---

### 2. è·å–ç¾¤æˆå‘˜è¯¦ç»†ä¿¡æ¯

**é—®é¢˜**: `GetGroupContacts()` åªè¿”å›æ•°å­— IDï¼Œæ²¡æœ‰è¯¦ç»†ä¿¡æ¯

**è§£å†³æ–¹æ¡ˆ**:
- âœ… é€šè¿‡ `chat_room` è¡¨æ˜ å°„ `room_id` (æ•°å­—) â†’ `username` (å¾®ä¿¡ID)
- âœ… é€šè¿‡ `contact.id` æ˜ å°„ `member_id` (æ•°å­—) â†’ `username` (å¾®ä¿¡ID)
- âœ… ä½¿ç”¨å¤šè¡¨ JOIN æŸ¥è¯¢ï¼Œè¿”å›å®Œæ•´çš„æˆå‘˜å’Œç¾¤è¯¦ç»†ä¿¡æ¯

**è¿”å›å­—æ®µ**:
- `room_id`, `member_id` (æ•°å­— ID)
- `room_wxid`, `member_wxid` (å¾®ä¿¡ ID)
- `member_nickname`, `member_alias`, `member_remark`, `member_avatar` (æˆå‘˜ä¿¡æ¯)
- `room_nickname`, `room_avatar`, `room_remark` (ç¾¤ä¿¡æ¯)

**æ–‡æ¡£**: `20251106-ç¾¤æˆå‘˜IDæ˜ å°„ä¿®å¤.md`, `20251106-è·å–ç¾¤æˆå‘˜è¯¦ç»†ä¿¡æ¯åŠŸèƒ½.md`

---

### 3. ç¾¤ç»‘å®šä¸šåŠ¡æµç¨‹

**åŠŸèƒ½**:
1. ç”¨æˆ·é€‰æ‹©è”ç³»äºº â†’ ç‚¹å‡»"ç»‘å®š"
2. åˆ¤æ–­æ˜¯å¦ä¸ºç¾¤ç»„ï¼ˆé€šè¿‡ `@` ç¬¦å·ï¼‰
   - âœ… æ˜¯ç¾¤ç»„ â†’ ç»§ç»­
   - âŒ ä¸æ˜¯ç¾¤ç»„ â†’ å¼¹å‡ºæç¤ºï¼š"è¯·é€‰æ‹©æ­£ç¡®çš„ç¾¤ç»„"
3. è°ƒç”¨ `GetGroupContacts(ç¾¤ID)` è·å–ç¾¤æˆå‘˜
4. è§£æ JSON æ•°æ®
5. åˆ›å»º `V2Member` å¯¹è±¡å¹¶å¡«å……åˆ° `dgvMembers`

**å®ç°æ–‡ä»¶**:
- `BaiShengVx3Plus/Views/VxMain.cs`
  - ä¿®æ”¹ `btnBindingContacts_Click` æ–¹æ³•
  - æ–°å¢ `LoadGroupMembersToDataGridAsync` æ–¹æ³•

**æ–‡æ¡£**: `20251106-ç¾¤ç»‘å®šä¸šåŠ¡æµç¨‹å®ç°.md`

---

## ğŸ“Š æ•°æ®æµ

```
ç”¨æˆ·ç‚¹å‡»"è¿æ¥"
    â†“
å¯åŠ¨å¾®ä¿¡å¹¶æ³¨å…¥ WeixinX.dll
    â†“
è¿æ¥ Socket (ç«¯å£ 6328)
    â†“
è‡ªåŠ¨è·å– UserInfo å’Œ Contacts
    â†“
ç”¨æˆ·é€‰æ‹©ç¾¤ç»„ â†’ ç‚¹å‡»"ç»‘å®š"
    â†“
åˆ¤æ–­æ˜¯å¦ä¸ºç¾¤ç»„ï¼ˆåŒ…å« '@'ï¼‰
    â†“ æ˜¯ç¾¤ç»„
è°ƒç”¨ GetGroupContacts(ç¾¤ID)
    â†“
WeixinX æŸ¥è¯¢æ•°æ®åº“ï¼ˆchat_room + contactï¼‰
    â†“
è¿”å› JSON æ•°æ®ï¼ˆåŒ…å«æˆå‘˜å’Œç¾¤è¯¦ç»†ä¿¡æ¯ï¼‰
    â†“
è§£æ JSON â†’ åˆ›å»º V2Member å¯¹è±¡
    â†“
æ·»åŠ åˆ° _membersBindingList
    â†“
dgvMembers è‡ªåŠ¨æ˜¾ç¤ºæ•°æ®
```

---

## ğŸ”§ æŠ€æœ¯è¦ç‚¹

### 1. æ•°å­— ID æ˜ å°„

**æ•°æ®åº“è¡¨å…³ç³»**:
```
chatroom_member:
  room_id (INTEGER) = 10
  member_id (INTEGER) = 7
     â†“
chat_room:
  id (INTEGER) = 10
  username (TEXT) = "27206515609@chatroom"
     â†“
contact:
  id (INTEGER) = 7
  username (TEXT) = "wxid_5nl4ex9mz40t12"
  nick_name (TEXT) = "é±¼å„¿å®"
```

**SQL JOIN**:
```sql
FROM chatroom_member cm
LEFT JOIN chat_room cr ON cm.room_id = cr.id
LEFT JOIN contact c_member ON cm.member_id = c_member.id
LEFT JOIN contact c_room ON cr.username = c_room.username
```

---

### 2. å›ºå®š DLL è·¯å¾„

**åŸç†**: æ— è®ºè¿è¡Œ Debug è¿˜æ˜¯ Releaseï¼Œéƒ½ä»å›ºå®šä½ç½®è¯»å– DLL

```csharp
// WeChatService.cs
var basePath = Path.GetDirectoryName(AppDomain.CurrentDomain.BaseDirectory.TrimEnd(Path.DirectorySeparatorChar));
basePath = Path.GetDirectoryName(basePath); // å›åˆ° bin ç›®å½•
var dllPath = Path.Combine(basePath, "release", "net8.0-windows", "WeixinX.dll");
```

```csharp
// LoaderNative.cs é™æ€æ„é€ å‡½æ•°
static LoaderNative()
{
    var dllPath = Path.Combine(basePath, "release", "net8.0-windows", "Loader.dll");
    var handle = LoadLibrary(dllPath);  // é¢„åŠ è½½
}
```

---

### 3. ç¾¤ç»„åˆ¤æ–­

**åŸç†**: å¾®ä¿¡ç¾¤ç»„çš„ `wxid` åŒ…å« `@` ç¬¦å·

```csharp
if (!contact.Wxid.Contains("@"))
{
    UIMessageBox.ShowWarning("è¯·é€‰æ‹©æ­£ç¡®çš„ç¾¤ç»„ï¼");
    return;
}
```

**ç¤ºä¾‹**:
- ç¾¤ç»„: `27206515609@chatroom` âœ…
- ä¸ªäºº: `wxid_5nl4ex9mz40t12` âŒ
- ç³»ç»Ÿ: `filehelper` âŒ

---

### 4. JSON è§£æ

```csharp
var result = await _socketClient.SendAsync<JsonDocument>("GetGroupContacts", contact.Wxid);

foreach (var memberElement in result.RootElement.EnumerateArray())
{
    string memberWxid = memberElement.TryGetProperty("member_wxid", out var mwxid) 
        ? mwxid.GetString() ?? "" : "";
    string memberNickname = memberElement.TryGetProperty("member_nickname", out var mnick) 
        ? mnick.GetString() ?? "" : "";
    ...
}
```

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

### C++ æ–‡ä»¶

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|---------|
| `WeixinX/WeixinX/Features.cpp` | ä¿®æ”¹ `GetGroupContacts` SQLï¼Œä½¿ç”¨å¤šè¡¨ JOIN æ˜ å°„ ID |

---

### C# æ–‡ä»¶

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|---------|
| `BaiShengVx3Plus/Services/WeChat/WeChatService.cs` | ä½¿ç”¨å›ºå®šè·¯å¾„åŠ è½½ `WeixinX.dll` |
| `BaiShengVx3Plus/Native/LoaderNative.cs` | é™æ€æ„é€ å‡½æ•°é¢„åŠ è½½ `Loader.dll` |
| `BaiShengVx3Plus/Views/VxMain.cs` | ä¿®æ”¹ `btnBindingContacts_Click`ï¼Œæ–°å¢ `LoadGroupMembersToDataGridAsync` |

---

## ğŸ§ª ç¼–è¯‘å’Œæµ‹è¯•

### 1. ç¼–è¯‘ WeixinX.dll

**æ–¹æ³•1: Visual Studio**
```
1. æ‰“å¼€ WeixinX\WeixinX\WeixinX.vcxproj
2. é€‰æ‹© Release | Win32
3. å³é”®é¡¹ç›® â†’ é‡æ–°ç”Ÿæˆ
4. DLL ä¼šè‡ªåŠ¨å¤åˆ¶åˆ° bin\release\net8.0-windows\
```

**æ–¹æ³•2: MSBuild å‘½ä»¤è¡Œ**
```cmd
cd D:\gitcode\wx4helper\WeixinX
"C:\Program Files (x86)\Microsoft Visual Studio\2019\Professional\MSBuild\Current\Bin\MSBuild.exe" ^
  WeixinX\WeixinX.vcxproj ^
  /p:Configuration=Release ^
  /p:Platform=Win32 ^
  /t:Rebuild
```

---

### 2. ç¼–è¯‘ BaiShengVx3Plus

**æ–¹æ³•1: Visual Studio**
```
1. æ‰“å¼€ Vx3Plus.sln
2. ç”Ÿæˆ â†’ é‡æ–°ç”Ÿæˆè§£å†³æ–¹æ¡ˆ
```

**æ–¹æ³•2: dotnet CLI**
```cmd
cd D:\gitcode\wx4helper\BaiShengVx3Plus
dotnet build --configuration Debug
```

---

### 3. æµ‹è¯•æµç¨‹

#### æ­¥éª¤1: å¯åŠ¨ç¨‹åº
```
1. è¿è¡Œ BaiShengVx3Plusï¼ˆF5ï¼‰
2. ç™»å½•
3. ç‚¹å‡»"è¿æ¥"æŒ‰é’®
4. ç­‰å¾…å¾®ä¿¡å¯åŠ¨ã€æ³¨å…¥ã€è¿æ¥å®Œæˆ
5. è”ç³»äººåˆ—è¡¨è‡ªåŠ¨åŠ è½½
```

#### æ­¥éª¤2: æµ‹è¯•ç¾¤ç»‘å®šï¼ˆæ­£å¸¸æµç¨‹ï¼‰
```
1. åœ¨è”ç³»äººåˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªç¾¤ç»„ï¼ˆå¦‚"ç‰©æµåŒæ­¥"ï¼‰
2. ç‚¹å‡»"ç»‘å®š"æŒ‰é’®
3. è§‚å¯ŸçŠ¶æ€æ æç¤ºï¼š"æ­£åœ¨è·å–ç¾¤æˆå‘˜..."
4. è§‚å¯Ÿ dgvMembers è‡ªåŠ¨å¡«å……æ•°æ®
5. è§‚å¯ŸçŠ¶æ€æ æç¤ºï¼š"ç¾¤æˆå‘˜åŠ è½½å®Œæˆ"
```

**é¢„æœŸç»“æœ**:
- âœ… è”ç³»äººæ–‡æœ¬æ¡†æ˜¾ç¤ºç¾¤åå’Œ IDï¼Œç»¿è‰²èƒŒæ™¯
- âœ… è”ç³»äººåˆ—è¡¨ä¸­è¯¥è¡Œæ˜¾ç¤ºä¸ºç»¿è‰²
- âœ… `dgvMembers` æ˜¾ç¤ºè¯¥ç¾¤çš„æ‰€æœ‰æˆå‘˜
- âœ… æˆå‘˜ä¿¡æ¯åŒ…æ‹¬ï¼šå¾®ä¿¡IDã€æ˜µç§°ã€å¾®ä¿¡å·

#### æ­¥éª¤3: æµ‹è¯•ç¾¤ç»‘å®šï¼ˆé”™è¯¯åœºæ™¯ï¼‰
```
1. åœ¨è”ç³»äººåˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªä¸ªäººï¼ˆå¦‚"é±¼å„¿å®"ï¼‰
2. ç‚¹å‡»"ç»‘å®š"æŒ‰é’®
```

**é¢„æœŸç»“æœ**:
- âœ… å¼¹å‡ºæç¤ºæ¡†ï¼š"è¯·é€‰æ‹©æ­£ç¡®çš„ç¾¤ç»„ï¼"
- âœ… ä¸æ‰§è¡Œåç»­æ“ä½œ

#### æ­¥éª¤4: æµ‹è¯• GetGroupContacts å‘½ä»¤ï¼ˆè®¾ç½®çª—å£ï¼‰
```
1. ç‚¹å‡»"è®¾ç½®"æŒ‰é’®
2. ç‚¹å‡»"è·å–ç¾¤æˆå‘˜åˆ—è¡¨"æŒ‰é’®
3. æŸ¥çœ‹è¿”å›çš„ JSON æ•°æ®
```

**é¢„æœŸç»“æœ**:
```json
[
  {
    "room_id": "10",
    "member_id": "7",
    "room_wxid": "27206515609@chatroom",
    "member_wxid": "wxid_5nl4ex9mz40t12",
    "member_nickname": "é±¼å„¿å®",
    "member_alias": "AYY8-8",
    "member_remark": "",
    "member_avatar": "https://...",
    "room_nickname": "ç‰©æµåŒæ­¥",
    "room_avatar": "https://...",
    "room_remark": ""
  }
]
```

---

## âœ… éªŒè¯æ¸…å•

### ç¼–è¯‘æ£€æŸ¥
- [ ] WeixinX.dll ç¼–è¯‘æˆåŠŸï¼ˆRelease | Win32ï¼‰
- [ ] BaiShengVx3Plus ç¼–è¯‘æˆåŠŸï¼ˆDebugï¼‰
- [ ] æ— ç¼–è¯‘é”™è¯¯å’Œè­¦å‘Š
- [ ] DLL æ–‡ä»¶å­˜åœ¨äº `bin\release\net8.0-windows\`

### DLL è·¯å¾„æ£€æŸ¥
- [ ] WeixinX.dll åœ¨ `bin\release\net8.0-windows\`
- [ ] Loader.dll åœ¨ `bin\release\net8.0-windows\`
- [ ] æ—¥å¿—æ˜¾ç¤º DLL åŠ è½½æˆåŠŸ

### åŠŸèƒ½æ£€æŸ¥
- [ ] ç¨‹åºå¯åŠ¨æ— é”™è¯¯
- [ ] ç‚¹å‡»"è¿æ¥"æˆåŠŸå¯åŠ¨å¾®ä¿¡
- [ ] å¾®ä¿¡æ³¨å…¥æˆåŠŸ
- [ ] Socket è¿æ¥æˆåŠŸ
- [ ] è‡ªåŠ¨è·å– UserInfo
- [ ] è‡ªåŠ¨è·å– Contacts

### ç¾¤ç»‘å®šæ£€æŸ¥
- [ ] ç»‘å®šç¾¤ç»„æˆåŠŸ
- [ ] ç»‘å®šä¸ªäººæ—¶å¼¹å‡ºé”™è¯¯æç¤º
- [ ] ç»‘å®šç³»ç»Ÿè´¦å·æ—¶å¼¹å‡ºé”™è¯¯æç¤º
- [ ] dgvMembers è‡ªåŠ¨å¡«å……ç¾¤æˆå‘˜æ•°æ®

### æ•°æ®æ£€æŸ¥
- [ ] GetGroupContacts è¿”å›å®Œæ•´çš„ JSON æ•°æ®
- [ ] åŒ…å« `room_wxid` å’Œ `member_wxid` å­—æ®µ
- [ ] åŒ…å«æˆå‘˜è¯¦ç»†ä¿¡æ¯ï¼ˆæ˜µç§°ã€å¾®ä¿¡å·ã€å¤´åƒï¼‰
- [ ] åŒ…å«ç¾¤è¯¦ç»†ä¿¡æ¯ï¼ˆç¾¤åã€ç¾¤å¤´åƒï¼‰
- [ ] dgvMembers æ˜¾ç¤ºæ­£ç¡®çš„æˆå‘˜ä¿¡æ¯

---

## ğŸ“š ç”Ÿæˆçš„æ–‡æ¡£

| æ–‡æ¡£ | è¯´æ˜ |
|------|------|
| `20251106-DLLè·¯å¾„ä¿®å¤.md` | WeixinX.dll è·¯å¾„ä¿®å¤ |
| `20251106-Loader-DLLè·¯å¾„ä¿®å¤.md` | Loader.dll è·¯å¾„ä¿®å¤ |
| `20251106-è·å–ç¾¤æˆå‘˜è¯¦ç»†ä¿¡æ¯åŠŸèƒ½.md` | GetGroupContacts åŠŸèƒ½å®ç° |
| `20251106-ç¾¤æˆå‘˜IDæ˜ å°„ä¿®å¤.md` | æ•°å­— ID æ˜ å°„åˆ°å¾®ä¿¡ ID |
| `20251106-ç¾¤ç»‘å®šä¸šåŠ¡æµç¨‹å®ç°.md` | ç¾¤ç»‘å®šä¸šåŠ¡æµç¨‹ |
| `20251106-å®Œæ•´åŠŸèƒ½å®ç°æ€»ç»“.md` | æœ¬æ–‡æ¡£ï¼ˆæ€»ç»“ï¼‰ |

---

## ğŸ”§ å¸¸è§é—®é¢˜

### Q1: ç¼–è¯‘æ—¶æ‰¾ä¸åˆ° WeixinX.dll

**ç­”**: ç¡®ä¿å…ˆç¼–è¯‘ WeixinX é¡¹ç›®ï¼ˆRelease | Win32ï¼‰

```
1. æ‰“å¼€ WeixinX.vcxproj
2. Release | Win32
3. é‡æ–°ç”Ÿæˆ
```

---

### Q2: è¿è¡Œæ—¶æ‰¾ä¸åˆ° Loader.dll

**ç­”**: ç¼–è¯‘ Loader é¡¹ç›®

```
1. æ‰“å¼€ Loader.vcxproj
2. Release | Win32
3. é‡æ–°ç”Ÿæˆ
```

---

### Q3: GetGroupContacts è¿”å›ç©ºæ•°æ®

**ç­”**: æ£€æŸ¥æ•°æ®åº“è¡¨

```sql
-- æ£€æŸ¥ chat_room è¡¨æ˜¯å¦æœ‰æ•°æ®
SELECT * FROM chat_room;

-- æ£€æŸ¥ chatroom_member è¡¨æ˜¯å¦æœ‰æ•°æ®
SELECT * FROM chatroom_member;

-- æ£€æŸ¥ contact è¡¨æ˜¯å¦æœ‰æ•°æ®
SELECT * FROM contact;
```

---

### Q4: dgvMembers ä¸æ˜¾ç¤ºæ•°æ®

**ç­”**: æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹

1. **JSON è§£æ**: æŸ¥çœ‹æ—¥å¿—ï¼Œç¡®è®¤ JSON æ•°æ®æ­£ç¡®
2. **BindingList**: ç¡®è®¤ `_membersBindingList.Clear()` å’Œ `Add()` è¢«è°ƒç”¨
3. **UI åˆ·æ–°**: ç¡®è®¤ `dgvMembers.Refresh()` è¢«è°ƒç”¨
4. **æ•°æ®ç»‘å®š**: ç¡®è®¤ `dgvMembers.DataSource = _membersBindingList;`

---

### Q5: ç»‘å®šä¸ªäººè´¦å·æ—¶æ²¡æœ‰æç¤º

**ç­”**: æ£€æŸ¥ `Contains("@")` é€»è¾‘

```csharp
if (!contact.Wxid.Contains("@"))
{
    UIMessageBox.ShowWarning("è¯·é€‰æ‹©æ­£ç¡®çš„ç¾¤ç»„ï¼");
    return;
}
```

ç¡®è®¤ `contact.Wxid` çš„å€¼æ˜¯å¦æ­£ç¡®ã€‚

---

## ğŸ¯ ä¸‹ä¸€æ­¥

### ç«‹å³æ‰§è¡Œ
1. **æ‰‹åŠ¨ç¼–è¯‘ WeixinX.dll** (Release | Win32)
2. **æ‰‹åŠ¨ç¼–è¯‘ BaiShengVx3Plus** (Visual Studio ç”Ÿæˆ)
3. **è¿è¡Œç¨‹åºå¹¶æµ‹è¯•**

### åç»­åŠŸèƒ½
- [ ] ä¼šå‘˜æ•°æ®æŒä¹…åŒ–ï¼ˆä¿å­˜åˆ°æ•°æ®åº“ï¼‰
- [ ] è®¢å•ç®¡ç†åŠŸèƒ½
- [ ] æŠ•æ³¨åŠŸèƒ½
- [ ] ç»“ç®—åŠŸèƒ½
- [ ] æŠ¥è¡¨åŠŸèƒ½

---

**å®ç°æ—¶é—´**: 2025å¹´11æœˆ6æ—¥ 01:40  
**çŠ¶æ€**: âœ… ä»£ç å·²å®Œæˆï¼Œå¾…ç¼–è¯‘æµ‹è¯•  
**ä¸‹ä¸€æ­¥**: **æ‰‹åŠ¨ç¼–è¯‘ WeixinX.dll å’Œ BaiShengVx3Plusï¼Œç„¶åæµ‹è¯•ï¼** ğŸš€

