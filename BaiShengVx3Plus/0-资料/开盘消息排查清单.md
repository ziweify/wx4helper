# 开盘消息排查清单

## 📋 用户情况

- **开发模式**：✅ 已启用
- **绑定群组**：模拟群 n111111 (wxid_111111@wx.com)
- **已收到的消息**：
  - ✅ 第604期结算消息（中~名单、留~名单）
  - ❌ 第605期开盘消息（缺失）

---

## 🔍 需要检查的日志

请在日志中搜索以下关键字，并提供相关的日志内容：

### 1. 期号变更日志

**搜索**：`期号变更`

**预期日志**：
```
🔄 期号变更: 604 → 605
📢 期号变更事件: 当期=605, 上期=604
   当期开奖时间: 21:55:00
   上期开奖时间: 21:50:00
```

**请提供**：最近一次期号变更的完整日志

---

### 2. 状态变更日志

**搜索**：`状态变更` 或 `状态从.*变为.*开盘中`

**预期日志**：
```
✅ 上一期已开奖，状态从'等待中'变为'开盘中'，允许投注
🔔 状态变更: 等待中 → 开盘中
```

**请提供**：第605期的状态变更日志

---

### 3. 开盘处理日志

**搜索**：`开盘处理` 或 `OnOpeningAsync`

**预期日志**：
```
📢 开盘处理: 期号 605
🔧 开发模式：已通知消息模拟器显示开盘消息 - 第605队...
```

**可能的警告日志**：
```
⚠️ 期号 605 的'线下开始'消息已发送过，跳过重复发送
⚠️ 上一期 604 尚未结算完成（已结算期号：xxx）
```

**请提供**：第605期的开盘处理日志

---

### 4. 上一期开奖日志

**搜索**：`_lastOpenedIssueId` 或 `上一期已开奖`

**预期日志**：
```
🎰 开奖数据: 期号 604, 号码: 72,30,62,78,13, 和值: 255, 大小: 大, 单双: 单
✅ 期号 604 开奖完成，允许下一期开盘
```

---

### 5. 上一期结算日志

**搜索**：`_lastSettledIssueId` 或 `结算完成`

**预期日志**：
```
✅ 期号 604 结算完成，已发送中~名单和留~名单
```

---

### 6. 开发模式通知日志

**搜索**：`🔧 开发模式`

**预期日志**：
```
🔧 开发模式：已通知消息模拟器显示开盘消息 - 第605队...
🔧 开发模式：已通知消息模拟器显示封盘提醒 - 605 还剩30秒
🔧 开发模式：已通知消息模拟器显示封盘消息
🔧 开发模式：已通知消息模拟器显示中奖名单
🔧 开发模式：已通知消息模拟器显示留分名单
```

**请检查**：是否有"开盘消息"的通知日志？

---

## 🎯 快速诊断

### 情况A：日志中有 "状态从'等待中'变为'开盘中'"

如果日志中有这条记录，说明状态正常变更，问题可能在 `OnOpeningAsync` 内部。

**请提供**：
- `📢 开盘处理: 期号 605` 之后的所有日志
- 是否有 `⚠️ 上一期 604 尚未结算完成` 的警告？
- 是否有 `🔧 开发模式：已通知消息模拟器显示开盘消息`？

---

### 情况B：日志中没有 "状态从'等待中'变为'开盘中'"

如果日志中没有这条记录，说明状态根本没有变为"开盘中"。

**可能的原因**：
1. 上一期（604）未开奖（`_lastOpenedIssueId < 604`）
2. 倒计时不在正确的范围内（应该是 30-300 秒）
3. 当前状态不是"等待中"

**请提供**：
- 第605期的所有状态日志
- `_lastOpenedIssueId` 的值
- 当前倒计时的值

---

### 情况C：日志中有 "期号 605 的'线下开始'消息已发送过"

如果日志中有这条记录，说明开盘消息已经发送过一次了，被防重复机制拦截。

**可能的原因**：
- 消息模拟器打开较晚，错过了开盘消息
- 或者开盘消息确实发送了，但消息模拟器未收到

**解决方法**：
- 等待下一期（606）的开盘消息
- 或者重启软件

---

## 📝 日志收集模板

请按照以下格式提供日志：

```
=== 期号变更日志 ===
[时间] 🔄 期号变更: xxx → xxx
...

=== 状态变更日志 ===
[时间] 🔔 状态变更: xxx → xxx
...

=== 开盘处理日志 ===
[时间] 📢 开盘处理: 期号 xxx
...

=== 开发模式通知日志 ===
[时间] 🔧 开发模式：已通知消息模拟器...
...
```

---

## 🔧 临时解决方案

如果您急需测试开盘消息，可以：

1. **重启软件**
   - 关闭软件
   - 重新打开
   - 在开盘前打开消息模拟器
   - 等待下一期开盘

2. **手动触发开盘**（如果有管理员权限）
   - 发送管理员命令 "开盘"
   - 但这可能不会触发开盘消息

3. **等待下一期**
   - 第606期的开盘消息应该能正常显示
   - 前提是第605期正常开奖并结算

---

**创建时间**：2025-12-09
**文档版本**：v1.0

