# 开发模式 - 模拟群使用说明

## 📋 问题描述

**用户疑问**：为什么我已经绑定了模拟群，但系统还是说"未绑定群或微信未登录"？

**答案**：这是系统设计的一个细节问题，现已修复。

---

## 🔍 问题原因

### 修复前的逻辑

系统原来的判断逻辑是：

```csharp
if (!string.IsNullOrEmpty(groupWxId) && _socketClient != null && _socketClient.IsConnected)
{
    // 发送结算消息
}
```

这个条件有**三个检查**：
1. ✅ 群已绑定（`groupWxId` 不为空）
2. ✅ WebSocket 客户端对象存在（`_socketClient != null`）
3. ❌ **微信已连接**（`_socketClient.IsConnected`）

### 问题所在

在**开发模式 + 模拟群**的场景下：
- ✅ 您确实绑定了模拟群 `n111111 (wxid_111111@wx.com)`
- ❌ 但没有真实的微信在运行，所以 `_socketClient.IsConnected = false`
- ❌ 结果：条件判断失败，系统认为"未绑定群或微信未登录"

### 日志证据

```
21:50:20.642 📍 开始绑定群: n111111 (wxid_111111@wx.com)  ← 群已绑定
21:50:20.647 绑定群组: n111111 (wxid_111111@wx.com)
...
21:50:18.051 Failed to connect  ← 微信连接失败（因为没有真实微信）
...
21:51:32.988 未绑定群或微信未登录，跳过发送结算消息  ← 错误判断
```

---

## ✅ 修复方案

### 新的判断逻辑

现在系统会区分**开发模式**和**正常模式**：

```csharp
// 🔥 检查是否应该发送结算消息
// 开发模式：只要绑定了群就发送（忽略微信连接状态）
// 正常模式：需要绑定群且微信已连接
bool shouldSendSettlement = !string.IsNullOrEmpty(groupWxId) && 
    (isDevMode || (_socketClient != null && _socketClient.IsConnected));
```

### 修复对比

| 场景 | 修复前 | 修复后 |
|------|--------|--------|
| **开发模式 + 模拟群** | ❌ 判定为"未绑定"，不发送 | ✅ 正常发送结算消息 |
| **开发模式 + 模拟群 + 无微信** | ❌ 不显示开盘消息 | ✅ 显示开盘消息 |
| **正常模式 + 真实群 + 微信连接** | ✅ 正常发送 | ✅ 正常发送 |
| **正常模式 + 真实群 + 微信断开** | ✅ 不发送（正确） | ✅ 不发送（正确） |

---

## 🎯 开发模式的设计原则

### 核心思想

**开发模式应该独立于真实微信环境**，只需要模拟数据即可完成测试。

### 实现方式

系统在以下场景下会忽略微信连接状态：

1. **结算消息发送** ✅
   - 开发模式：只检查是否绑定群
   - 正常模式：检查群绑定 + 微信连接

2. **开盘消息发送** ✅
   - 开发模式：单独处理，不检查微信连接
   - 正常模式：检查微信连接

3. **倒计时提醒** ✅
   - 开发模式：单独通知消息模拟器
   - 正常模式：检查微信连接

4. **封盘消息** ✅
   - 开发模式：单独通知消息模拟器
   - 正常模式：检查微信连接

---

## 📝 使用流程

### 开发模式 + 模拟群的正确使用方式

#### 1. 启用开发模式

```
设置 → 勾选 "开发模式" ✅
```

#### 2. 绑定模拟群

```
群组选择器 → 选择模拟群 → 点击"绑定群"
例如：n111111 (wxid_111111@wx.com)
```

#### 3. 打开消息模拟器

```
选择会员 → 右键 → 开发选项 → 发送消息
```

#### 4. 观察系统消息

现在您应该能看到：
- ✅ 倒计时提醒（30秒/15秒）
- ✅ 封盘消息
- ✅ 结算消息（中~名单、留~名单）
- ✅ **开盘消息**（修复后）
- ✅ 历史记录图片

---

## 🔬 技术细节

### 修复涉及的文件

| 文件 | 修改内容 |
|------|----------|
| `BinggoLotteryService.cs` | 结算消息发送逻辑 |
| `BinggoLotteryService.cs` | 开盘消息发送逻辑 |
| `BinggoLotteryService.cs` | `_lastSettledIssueId` 更新逻辑 |

### 关键代码变更

#### 修复前（错误）

```csharp
// ❌ 即使开发模式，也需要检查微信连接
if (!string.IsNullOrEmpty(groupWxId) && _socketClient != null && _socketClient.IsConnected)
{
    await SendSettlementMessagesAsync(...);
    _lastSettledIssueId = issueId;
}
else
{
    // 开发模式下虽然会通知消息模拟器，但不更新 _lastSettledIssueId
    if (isDevMode)
    {
        NotifySystemMessage(...);
        // ❌ _lastSettledIssueId 没有更新！
    }
}
```

#### 修复后（正确）

```csharp
// ✅ 开发模式忽略微信连接状态
bool shouldSendSettlement = !string.IsNullOrEmpty(groupWxId) && 
    (isDevMode || (_socketClient != null && _socketClient.IsConnected));

if (shouldSendSettlement)
{
    await SendSettlementMessagesAsync(...);
    _lastSettledIssueId = issueId;  // ✅ 开发模式下也会更新
}
```

---

## 🐛 常见问题

### Q1：为什么开盘消息还是不显示？

**A1**：请确保：
1. ✅ 开发模式已启用
2. ✅ 模拟群已绑定
3. ✅ 上一期已经完整开奖并结算
4. ✅ 代码已重新编译

### Q2：是否需要真实的微信在运行？

**A2**：
- **开发模式**：❌ 不需要，只需要模拟群和模拟数据
- **正常模式**：✅ 需要，必须有真实的微信连接

### Q3：为什么日志中还在尝试连接微信？

**A3**：这是正常的。系统会持续尝试连接微信（每5秒一次），但**开发模式下这不影响功能**。

日志示例：
```
21:50:18.051 Failed to connect  ← 正常，不影响开发模式
21:51:32.988 🔧 开发模式：已通知消息模拟器...  ← 功能正常工作
```

### Q4：模拟群和真实群有什么区别？

| 特性 | 模拟群 | 真实群 |
|------|--------|--------|
| 需要微信 | ❌ 不需要 | ✅ 需要 |
| 群成员 | 📝 手动添加测试数据 | 🌐 从微信实时获取 |
| 消息发送 | 💬 仅消息模拟器 | 📱 发送到真实微信群 |
| 适用场景 | 🔧 开发测试 | 🚀 正式运营 |

---

## ✅ 验证清单

修复后，请验证以下功能：

- [ ] 开发模式已启用
- [ ] 模拟群已绑定
- [ ] 消息模拟器已打开
- [ ] 能收到倒计时提醒（30秒/15秒）
- [ ] 能收到封盘消息
- [ ] 能收到结算消息（中~名单、留~名单）
- [ ] **能收到开盘消息**（本次修复重点）
- [ ] 能收到历史记录图片

---

## 📊 系统流程对比

### 修复前

```
开奖 → 结算
  ├─ 检查：群绑定 ✅
  ├─ 检查：微信连接 ❌
  └─ 结果：跳过发送
      └─ _lastSettledIssueId = 0（未更新）

下一期
  ├─ 检查：上一期是否结算？
  ├─ _lastSettledIssueId = 0 < 上一期期号
  └─ 结果：跳过开盘消息 ❌
```

### 修复后

```
开奖 → 结算
  ├─ 检查：群绑定 ✅
  ├─ 检查：开发模式 ✅
  └─ 结果：发送结算消息
      └─ _lastSettledIssueId = 当前期号（已更新）✅

下一期
  ├─ 检查：上一期是否结算？
  ├─ _lastSettledIssueId = 上一期期号 ✅
  └─ 结果：发送开盘消息 ✅
```

---

**创建时间**：2025-12-09  
**修复版本**：v3.2.1  
**文档版本**：v1.0

