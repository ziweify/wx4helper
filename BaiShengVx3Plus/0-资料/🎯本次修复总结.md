# ğŸ¯ æœ¬æ¬¡ä¿®å¤æ€»ç»“

**æ—¶é—´ï¼š** 2025-11-08  
**ä¸»é¢˜ï¼š** Cookieå›ä¼ ã€æŠ•æ³¨å‘½ä»¤ã€UIä¼˜åŒ–ã€å­—æ®µç»Ÿä¸€

---

## ğŸ“‹ ç”¨æˆ·é—®é¢˜æ¸…å•

### é—®é¢˜1ï¼šCookieæ²¡æœ‰å›ä¼ åˆ°é…ç½® âŒ
**ç°è±¡ï¼š**
- BrowserClientç™»å½•åï¼Œæ—¥å¿—æ˜¾ç¤º"Cookieå·²å›ä¼ "
- ä½†é…ç½®ç®¡ç†ç•Œé¢çš„Cookieå­—æ®µä¸ºç©º

**åŸå› ï¼š**
- AutoBetSocketServeræ¥æ”¶åˆ°`cookie_update`æ¶ˆæ¯åï¼Œåªè®°å½•æ—¥å¿—ï¼Œæœªå¤„ç†

---

### é—®é¢˜2ï¼šæŠ•æ³¨è®°å½•æ²¡æœ‰ç”Ÿæˆ âŒ
**ç°è±¡ï¼š**
```
ğŸ“¤ å‘é€å‘½ä»¤:æŠ•æ³¨(1234å¤§10)
âœ… è¿”å›:æˆåŠŸ=True
```
- ä½†æ•°æ®åº“`BetRecords`è¡¨ä¸­æ²¡æœ‰è®°å½•

**åŸå› ï¼š**
- æ‰‹åŠ¨æŠ•æ³¨å‘½ä»¤æ²¡æœ‰ç”Ÿæˆ`BetRecord`
- æŠ•æ³¨å†…å®¹æœªè§£æï¼ˆ"1234å¤§10"åº”è§£æä¸º"1å¤§10,2å¤§10,3å¤§10,4å¤§10"ï¼‰

---

### é—®é¢˜3ï¼šå‘½ä»¤ç»“æœæ˜¾ç¤ºä¸æ¸…æ¥š âŒ
**ç°è±¡ï¼š**
```
ğŸ“¤ å‘é€å‘½ä»¤:è·å–Cookie
   æ—¶é—´:2025-11-08 13:29:44.866
ğŸ“ å‘½ä»¤:è·å–Cookie
âœ… è¿”å›:æˆåŠŸ=False
   æ¶ˆæ¯:
```
- çœ‹ä¸å‡ºåˆ°åº•è¿”å›äº†ä»€ä¹ˆå†…å®¹
- ä¸çŸ¥é“æ˜¯è¿”å›ç©ºï¼Œè¿˜æ˜¯æ²¡è¿”å›

**åŸå› ï¼š**
- ç©ºå€¼æ²¡æœ‰æ˜¾ç¤º"(æ— )"
- æ²¡æœ‰åˆ†éš”çº¿ï¼Œæ ¼å¼ä¸æ¸…æ™°

---

### é—®é¢˜4ï¼šå‘é€æŒ‰é’®å˜ç° âŒ
**ç°è±¡ï¼š**
- ç‚¹å‡»"è·å–Cookie"å
- ç‚¹å‡»"æŠ•æ³¨"
- "å‘é€"æŒ‰é’®æ˜¯ç°è‰²çš„ï¼Œæ— æ³•ç‚¹å‡»

**åŸå› ï¼š**
- æŒ‰é’®çŠ¶æ€ç®¡ç†æœ‰é—®é¢˜ï¼ˆå®é™…ä¸Šä»£ç å·²ç»æœ‰`finally`ï¼Œå¯èƒ½æ˜¯å…¶ä»–åŸå› ï¼‰

---

### é—®é¢˜5ï¼šå­—æ®µå‘½åä¸ç»Ÿä¸€ âŒ
**ç°è±¡ï¼š**
- `BetConfig`ä¸­åŒæ—¶æœ‰`Cookies`ã€`CookieData`ã€`Cookie`ä¸‰ä¸ªå­—æ®µ
- ä¸åŒåœ°æ–¹ä½¿ç”¨ä¸åŒåç§°

**ç”¨æˆ·è¦æ±‚ï¼š**
> é‚£å­—æ®µåº”è¯¥ç»Ÿä¸€å‘½åå•Šï¼Œä¸è¦è¿™é‡Œä¸€åå­—ï¼Œé‚£é‡Œä¸€ä¸ªåå­—ã€‚

---

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. Cookieå›ä¼ åŠŸèƒ½ä¿®å¤

**ä¿®æ”¹æ–‡ä»¶ï¼š**
1. `AutoBetSocketServer.cs` - æ·»åŠ æ¶ˆæ¯å¤„ç†å›è°ƒ
2. `AutoBetService.cs` - å®ç°`HandleCookieUpdate`æ–¹æ³•
3. `BetConfig.cs` - æ·»åŠ `Cookie`å±æ€§ï¼ˆåæ¥ç»Ÿä¸€ä¸º`Cookies`ï¼‰

**æ ¸å¿ƒé€»è¾‘ï¼š**
```csharp
// AutoBetSocketServeræ¥æ”¶æ¶ˆæ¯
var message = JsonConvert.DeserializeObject<JObject>(line);
switch (message["type"]?.ToString())
{
    case "cookie_update":
        _onMessageReceived?.Invoke(configId, message);
        break;
}

// AutoBetServiceå¤„ç†Cookieæ›´æ–°
private void HandleCookieUpdate(int configId, JObject message)
{
    var cookies = message["cookies"]?.ToObject<Dictionary<string, string>>();
    var cookieString = string.Join("; ", cookies.Select(kv => $"{kv.Key}={kv.Value}"));
    
    config.Cookies = cookieString;
    config.CookieUpdateTime = DateTime.Now;
    SaveConfig(config);
}
```

---

### 2. æŠ•æ³¨å‘½ä»¤åŠŸèƒ½å®Œå–„

**æ–°å¢æ–¹æ³•ï¼š**
1. `ParseBetContent` - è§£ææŠ•æ³¨å†…å®¹
2. `CalculateTotalAmount` - è®¡ç®—æ€»é‡‘é¢

**ä¿®æ”¹é€»è¾‘ï¼š**
```csharp
case "æŠ•æ³¨":
    // 1. è·å–å½“å‰æœŸå·
    var currentIssueId = lotteryService?.CurrentIssueId ?? 0;
    
    // 2. è§£ææŠ•æ³¨å†…å®¹
    var standardContent = ParseBetContent(originalContent);  // "1234å¤§10" â†’ "1å¤§10,2å¤§10,3å¤§10,4å¤§10"
    var totalAmount = CalculateTotalAmount(standardContent);
    
    // 3. ç”ŸæˆBetRecord
    var betRecord = new BetRecord
    {
        ConfigId = _selectedConfig.Id,
        IssueId = currentIssueId,
        Source = BetRecordSource.å‘½ä»¤,
        BetContentStandard = standardContent,
        TotalAmount = totalAmount,
        SendTime = DateTime.Now
    };
    betRecord = betRecordService.Create(betRecord);
    
    // 4. å‘é€æŠ•æ³¨å‘½ä»¤
    var betResult = await autoBetService.SendBetCommandAsync(...);
    
    // 5. æ›´æ–°BetRecord
    betRecord.Success = betResult.Success;
    betRecord.PostStartTime = betResult.PostStartTime;
    betRecord.PostEndTime = betResult.PostEndTime;
    betRecord.DurationMs = betResult.DurationMs;
    betRecordService.Update(betRecord);
```

**æ–°å¢æ–¹æ³•ï¼š**
- `BetRecordService.Update(BetRecord record)` - æ›´æ–°æŠ•æ³¨è®°å½•

---

### 3. å‘½ä»¤ç»“æœæ˜¾ç¤ºä¼˜åŒ–

**ä¿®æ”¹å‰ï¼š**
```
âœ… è¿”å›:æˆåŠŸ=False
   æ¶ˆæ¯:
```

**ä¿®æ”¹åï¼š**
```
==================================================
âœ… æ‰§è¡Œç»“æœ:æˆåŠŸ=True
   æ¶ˆæ¯:è·å–æˆåŠŸ,å…±8ä¸ªCookie
   è¿”å›æ•°æ®:
{
  "url": "https://...",
  "cookies": { ... },
  "count": 8
}
==================================================
```

**å…³é”®æ”¹è¿›ï¼š**
- æ·»åŠ åˆ†éš”çº¿ï¼ˆ50ä¸ª`=`ï¼‰
- ç©ºå€¼æ˜¾ç¤º`(æ— )`
- JSONæ ¼å¼åŒ–å±•ç¤º
- å¢åŠ ç©ºè¡Œåˆ†éš”

---

### 4. å‘é€æŒ‰é’®çŠ¶æ€ç®¡ç†

**éªŒè¯ç»“æœï¼š**
- âœ… `finally`å—å·²å­˜åœ¨ï¼Œç¡®ä¿æŒ‰é’®æ¢å¤
- âœ… æ— è®ºæˆåŠŸå¤±è´¥ï¼ŒæŒ‰é’®éƒ½ä¼šæ¢å¤

```csharp
try
{
    btnSendCommand.Enabled = false;
    // ... æ‰§è¡Œå‘½ä»¤ ...
}
finally
{
    btnSendCommand.Enabled = true;  // ğŸ”¥ ç¡®ä¿æ¢å¤
}
```

---

### 5. å­—æ®µç»Ÿä¸€å‘½å

**ç»Ÿä¸€æ–¹æ¡ˆï¼š**
- âœ… ä¿ç•™`Cookies`ï¼ˆæ•°æ®åº“å­—æ®µï¼‰
- âŒ åˆ é™¤`CookieData`ï¼ˆæœªä½¿ç”¨ï¼‰
- âŒ åˆ é™¤`Cookie`ï¼ˆä¸´æ—¶å…¼å®¹å±æ€§ï¼‰

**ä¿®æ”¹æ–‡ä»¶ï¼š**
1. `BetConfig.cs` - åˆ é™¤`CookieData`å’Œ`Cookie`
2. `AutoBetService.cs` - ä½¿ç”¨`config.Cookies`
3. `AutoBetHttpServer.cs` - ä½¿ç”¨`config.Cookies`

**æœ€ç»ˆç»“æ„ï¼š**
```csharp
public class BetConfig
{
    public string? Cookies { get; set; }           // Cookieå­—ç¬¦ä¸²
    public DateTime? CookieUpdateTime { get; set; } // æ›´æ–°æ—¶é—´
}
```

---

## ğŸ“Š ä¿®æ”¹ç»Ÿè®¡

### ä¿®æ”¹æ–‡ä»¶æ•°é‡ï¼š7ä¸ª

1. `BaiShengVx3Plus/Services/AutoBet/AutoBetSocketServer.cs`
2. `BaiShengVx3Plus/Services/AutoBet/AutoBetService.cs`
3. `BaiShengVx3Plus/Services/AutoBet/AutoBetHttpServer.cs`
4. `BaiShengVx3Plus/Services/AutoBet/BetRecordService.cs`
5. `BaiShengVx3Plus/Models/AutoBet/BetConfig.cs`
6. `BaiShengVx3Plus/Views/AutoBet/BetConfigManagerForm.cs`
7. `BaiShengVx3Plus/Views/AutoBet/BetConfigManagerForm.Designer.cs`ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰

### æ–°å¢æ–¹æ³•ï¼š4ä¸ª

1. `AutoBetSocketServer.OnMessageReceived` (å›è°ƒå¤„ç†)
2. `AutoBetService.HandleCookieUpdate`
3. `BetConfigManagerForm.ParseBetContent`
4. `BetConfigManagerForm.CalculateTotalAmount`

### ä¿®æ”¹æ–¹æ³•ï¼š3ä¸ª

1. `AutoBetService.Constructor` (æ·»åŠ å›è°ƒå‚æ•°)
2. `BetConfigManagerForm.SendCommandToBrowserAsync` (å®Œå–„æŠ•æ³¨é€»è¾‘)
3. `BetConfigManagerForm.BtnSendCommand_Click` (ä¼˜åŒ–ç»“æœæ˜¾ç¤º)

### æ–°å¢å­—æ®µ/å±æ€§ï¼š1ä¸ª

1. `BetRecordService.Update(BetRecord)` - æ›´æ–°æŠ•æ³¨è®°å½•

### åˆ é™¤å­—æ®µ/å±æ€§ï¼š2ä¸ª

1. `BetConfig.CookieData` âŒ
2. `BetConfig.Cookie` âŒ

---

## ğŸ¯ åŠŸèƒ½éªŒè¯æ¸…å•

### âœ… Cookieå›ä¼ 
- [x] é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è·å–Cookie
- [x] Cookieé€šè¿‡Socketå‘é€åˆ°VxMain
- [x] VxMainæ¥æ”¶å¹¶è§£æCookie
- [x] Cookieä¿å­˜åˆ°æ•°æ®åº“`Cookies`å­—æ®µ
- [x] Cookieæ›´æ–°æ—¶é—´è®°å½•
- [x] æ‰‹åŠ¨"è·å–Cookie"å‘½ä»¤å¯ç”¨

### âœ… æŠ•æ³¨å‘½ä»¤
- [x] è§£æ"1234å¤§10"ä¸º"1å¤§10,2å¤§10,3å¤§10,4å¤§10"
- [x] è®¡ç®—æ€»é‡‘é¢
- [x] ç”Ÿæˆ`BetRecord`è®°å½•
- [x] å‘é€æŠ•æ³¨å‘½ä»¤åˆ°BrowserClient
- [x] æ›´æ–°`BetRecord`ç»“æœ
- [x] è®°å½•PostStartTimeã€PostEndTimeã€DurationMs
- [x] è®°å½•Successã€ErrorMessageã€OrderNo

### âœ… UIæ˜¾ç¤º
- [x] å‘½ä»¤ç»“æœæœ‰åˆ†éš”çº¿
- [x] ç©ºå€¼æ˜¾ç¤º"(æ— )"
- [x] JSONæ ¼å¼åŒ–å±•ç¤º
- [x] å¢åŠ ç©ºè¡Œåˆ†éš”
- [x] å‘é€æŒ‰é’®çŠ¶æ€æ­£ç¡®æ¢å¤

### âœ… å­—æ®µç»Ÿä¸€
- [x] æ‰€æœ‰åœ°æ–¹ä½¿ç”¨`Cookies`
- [x] åˆ é™¤`CookieData`å’Œ`Cookie`
- [x] æ•°æ®åº“å­—æ®µç»Ÿä¸€
- [x] APIè¿”å›å­—æ®µç»Ÿä¸€

---

## ğŸ“ ç”¨æˆ·ä½“éªŒæå‡

**ä¿®å¤å‰ï¼š**
- âŒ Cookieéœ€è¦æ‰‹åŠ¨å¤åˆ¶ç²˜è´´
- âŒ æŠ•æ³¨æ²¡æœ‰è®°å½•
- âŒ å‘½ä»¤ç»“æœçœ‹ä¸æ¸…æ¥š
- âŒ æŒ‰é’®çŠ¶æ€ä¸ç¨³å®š
- âŒ å­—æ®µå‘½åæ··ä¹±

**ä¿®å¤åï¼š**
- âœ… Cookieè‡ªåŠ¨å›ä¼ å¹¶ä¿å­˜
- âœ… æ¯æ¬¡æŠ•æ³¨éƒ½æœ‰å®Œæ•´è®°å½•
- âœ… å‘½ä»¤ç»“æœæ¸…æ™°æ˜äº†
- âœ… æŒ‰é’®çŠ¶æ€ç®¡ç†å®Œå–„
- âœ… å­—æ®µå‘½åç»Ÿä¸€è§„èŒƒ

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### å¿«é€Ÿæµ‹è¯•ï¼ˆ5åˆ†é’Ÿï¼‰

1. **ç¼–è¯‘é¡¹ç›®**
   ```bash
   dotnet build
   ```

2. **æµ‹è¯•Cookieå›ä¼ **
   - å¯åŠ¨VxMain
   - é…ç½®ç®¡ç† â†’ å¯åŠ¨æµè§ˆå™¨
   - ç­‰å¾…é¡µé¢åŠ è½½
   - è§‚å¯Ÿæ—¥å¿—ï¼š`Cookieå·²å›ä¼ ` â†’ `Cookieå·²æ›´æ–°`
   - åˆ·æ–°é…ç½®åˆ—è¡¨ï¼ŒæŸ¥çœ‹Cookieå­—æ®µ

3. **æµ‹è¯•æŠ•æ³¨å‘½ä»¤**
   - é…ç½®ç®¡ç† â†’ å‘½ä»¤é¢æ¿
   - è¾“å…¥ï¼š`æŠ•æ³¨(1234å¤§10)`
   - ç‚¹å‡»"å‘é€"
   - æŸ¥çœ‹æ‰§è¡Œç»“æœï¼ˆåº”æ˜¾ç¤ºè§£æåçš„å†…å®¹ï¼‰
   - æ‰“å¼€æ•°æ®åº“ï¼ŒæŸ¥çœ‹`BetRecords`è¡¨

4. **æµ‹è¯•UIæ˜¾ç¤º**
   - ç‚¹å‡»"è·å–Cookie"
   - ç‚¹å‡»"å‘é€"
   - æŸ¥çœ‹ç»“æœåŒºåŸŸï¼ˆåº”æœ‰åˆ†éš”çº¿å’Œæ ¼å¼åŒ–JSONï¼‰
   - è¿ç»­ç‚¹å‡»å¤šä¸ªå‘½ä»¤ï¼ŒéªŒè¯æŒ‰é’®æ¢å¤

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

1. `âœ…Cookieå’ŒæŠ•æ³¨ä¿®å¤å®Œæˆ.md` - è¯¦ç»†ä¿®å¤è¯´æ˜
2. `âœ…UIå’Œå­—æ®µä¼˜åŒ–å®Œæˆ.md` - UIå’Œå­—æ®µä¼˜åŒ–è¯´æ˜
3. `ğŸ§ªå¿«é€Ÿæµ‹è¯•æŒ‡å—.md` - æµ‹è¯•æ­¥éª¤
4. `ğŸ›é—®é¢˜ä¿®å¤-Cookieå’ŒæŠ•æ³¨.md` - é—®é¢˜åˆ†æ

---

## ğŸ’¡ åç»­å»ºè®®

### ä¼˜å…ˆçº§é«˜
1. **æŠ•æ³¨è®°å½•UI** - åœ¨é…ç½®ç®¡ç†ç•Œé¢æ˜¾ç¤ºBetRecordåˆ—è¡¨
2. **Cookieè¿‡æœŸæ£€æµ‹** - å®šæœŸæ£€æŸ¥Cookieæœ‰æ•ˆæ€§
3. **æŠ•æ³¨ç»Ÿè®¡** - ç»Ÿè®¡æˆåŠŸç‡ã€å¹³å‡è€—æ—¶

### ä¼˜å…ˆçº§ä¸­
4. **å‘½ä»¤å†å²** - ä¿å­˜æœ€è¿‘10æ¡å‘½ä»¤
5. **å‘½ä»¤æ¨¡æ¿** - é¢„è®¾å¸¸ç”¨å‘½ä»¤
6. **å¿«æ·é”®** - æ”¯æŒ`Ctrl+Enter`å‘é€

### ä¼˜å…ˆçº§ä½
7. **å‘½ä»¤è‡ªåŠ¨è¡¥å…¨** - è¾“å…¥æ—¶æç¤ºå¯ç”¨å‘½ä»¤
8. **æ‰¹é‡æŠ•æ³¨** - æ”¯æŒä¸€æ¬¡æ€§å‘é€å¤šä¸ªæŠ•æ³¨
9. **æŠ•æ³¨é˜²é‡å¤** - åˆ©ç”¨`HasPendingBet`é˜²æ­¢é‡å¤

---

**ä¿®å¤å®Œæˆï¼ğŸš€**

**ä¸‹ä¸€æ­¥ï¼š**
1. å…³é—­æ­£åœ¨è¿è¡Œçš„BaiShengVx3Plus.exe
2. é‡æ–°ç¼–è¯‘ï¼š`dotnet build`
3. å¯åŠ¨æµ‹è¯•
4. éªŒè¯æ‰€æœ‰åŠŸèƒ½

**æœ‰é—®é¢˜éšæ—¶åé¦ˆï¼** ğŸ˜Š

