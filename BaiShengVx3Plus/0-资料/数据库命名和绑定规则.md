# æ•°æ®åº“å‘½åå’Œç»‘å®šè§„åˆ™

## ğŸ“‹ æ•°æ®åº“å‘½åè§„åˆ™

### 1. **é»˜è®¤æ•°æ®åº“** `business.db`
- **ç”¨é€”**: ç¨‹åºå¯åŠ¨æ—¶ä½¿ç”¨çš„å ä½ç¬¦æ•°æ®åº“
- **ä½ç½®**: `Data/business.db`
- **å†…å®¹**: ç©ºçš„ï¼Œä¸å­˜å‚¨ä»»ä½•ä¸šåŠ¡æ•°æ®
- **ç”Ÿå‘½å‘¨æœŸ**: ä»…åœ¨ç¨‹åºå¯åŠ¨ä¸”æœªç™»å½•å¾®ä¿¡æ—¶ä½¿ç”¨

### 2. **å¾®ä¿¡ä¸“å±æ•°æ®åº“** `business_{wxid}.db`
- **ç”¨é€”**: å­˜å‚¨ç‰¹å®šå¾®ä¿¡è´¦å·çš„æ‰€æœ‰ä¸šåŠ¡æ•°æ®
- **ä½ç½®**: `Data/business_{wxid}.db`
- **å‘½åè§„åˆ™**: `business_` + `UserInfo.Wxid` + `.db`
- **ç¤ºä¾‹**: 
  - å¾®ä¿¡ID: `wxid_abc123`
  - æ•°æ®åº“å: `business_wxid_abc123.db`
- **å†…å®¹**: 
  - âœ… **ä¼šå‘˜æ•°æ®** (`V2Member` è¡¨)
  - âœ… **è®¢å•æ•°æ®** (`V2MemberOrder` è¡¨)
  - âœ… **å…¶ä»–ä¸šåŠ¡æ•°æ®**
- **ç”Ÿå‘½å‘¨æœŸ**: å¾®ä¿¡ç™»å½•æˆåŠŸååˆ›å»ºï¼Œè´¦å·åˆ‡æ¢æ—¶è‡ªåŠ¨åˆ‡æ¢

### 3. **æ—¥å¿—æ•°æ®åº“** `logs.db`
- **ç”¨é€”**: å­˜å‚¨æ‰€æœ‰å¾®ä¿¡è´¦å·çš„æ—¥å¿—
- **ä½ç½®**: `Data/logs.db`
- **å†…å®¹**: 
  - âœ… **æ—¥å¿—è®°å½•** (`LogEntry` è¡¨)
- **ç‰¹ç‚¹**: 
  - âœ… å…¨å±€å…±äº«
  - âœ… æ‰€æœ‰å¾®ä¿¡è´¦å·çš„æ—¥å¿—éƒ½å­˜å‚¨åœ¨è¿™é‡Œ
  - âœ… ä¸éšè´¦å·åˆ‡æ¢è€Œæ”¹å˜

---

## ğŸ”„ æ•°æ®åº“ç»‘å®šæµç¨‹

### åœºæ™¯1: ç¨‹åºå¯åŠ¨ï¼ˆæœªç™»å½•ï¼‰

```
ç¨‹åºå¯åŠ¨
    â†“
åŠ è½½ business.dbï¼ˆç©ºæ•°æ®åº“ï¼‰
    â†“
æ˜¾ç¤ºç©ºçš„ä¼šå‘˜è¡¨å’Œè®¢å•è¡¨
    â†“
ç­‰å¾…ç”¨æˆ·ç™»å½•å¾®ä¿¡
```

**æ•°æ®åº“çŠ¶æ€**:
- `business.db` - å·²åŠ è½½ï¼ˆç©ºï¼‰
- `logs.db` - å·²åŠ è½½ï¼ˆå…¨å±€å…±äº«ï¼‰

---

### åœºæ™¯2: å¾®ä¿¡ç™»å½•æˆåŠŸ

```
å¾®ä¿¡ç™»å½•æˆåŠŸ
    â†“
æ”¶åˆ° UserInfoï¼ˆåŒ…å« wxidï¼‰
    â†“
è§¦å‘ UserInfoService_UserInfoUpdated äº‹ä»¶
    â†“
æ£€æŸ¥ wxid æ˜¯å¦å˜åŒ–
    â†“
é‡æ–°ç»‘å®šæ•°æ®åº“: business_{wxid}.db
    â†“
åŠ è½½è¯¥å¾®ä¿¡çš„ä¼šå‘˜å’Œè®¢å•æ•°æ®
    â†“
è‡ªåŠ¨è·å–è”ç³»äººåˆ—è¡¨
```

**æ•°æ®åº“çŠ¶æ€**:
- `business_{wxid}.db` - å·²åŠ è½½ï¼ˆè¯¥å¾®ä¿¡çš„ä¸šåŠ¡æ•°æ®ï¼‰
- `logs.db` - å·²åŠ è½½ï¼ˆå…¨å±€å…±äº«ï¼‰

**ä»£ç ä½ç½®**: `VxMain.cs` â†’ `UserInfoService_UserInfoUpdated`

```csharp
private async void UserInfoService_UserInfoUpdated(object? sender, UserInfoUpdatedEventArgs e)
{
    // æ£€æµ‹ç”¨æˆ·åˆ‡æ¢
    bool isUserChanged = (_currentUserInfo?.Wxid != e.UserInfo.Wxid);
    
    // æ›´æ–°å½“å‰ç”¨æˆ·ä¿¡æ¯
    _currentUserInfo = e.UserInfo;
    
    // ğŸ”¥ é‡æ–°ç»‘å®šæ•°æ®åº“ï¼ˆå¾®ä¿¡ä¸“å±æ•°æ®åº“ï¼‰
    if (!string.IsNullOrEmpty(e.UserInfo.Wxid))
    {
        InitializeDatabase(e.UserInfo.Wxid);  // business_{wxid}.db
    }
}
```

---

### åœºæ™¯3: ç»‘å®šç¾¤ç»„

```
ç”¨æˆ·ç‚¹å‡» "ç»‘å®š" æŒ‰é’®
    â†“
é€‰æ‹©ä¸€ä¸ªç¾¤ç»„ï¼ˆwxid åŒ…å« '@'ï¼‰
    â†“
ä¿å­˜ _currentBoundContact
    â†“
æ¸…ç©ºä¼šå‘˜è¡¨å’Œè®¢å•è¡¨ï¼ˆUIæ˜¾ç¤ºï¼‰
    â†“
è°ƒç”¨ GetGroupContacts(groupWxid)
    â†“
åŠ è½½è¯¥ç¾¤çš„æˆå‘˜æ•°æ®åˆ°ä¼šå‘˜è¡¨
    â†“
ä¼šå‘˜æ•°æ®ä¿å­˜åˆ° business_{UserInfo.Wxid}.db
```

**é‡è¦**:
- âŒ **ä¸åˆ›å»ºæ–°æ•°æ®åº“**ï¼
- âœ… **ç»§ç»­ä½¿ç”¨** `business_{UserInfo.Wxid}.db`
- âœ… æ‰€æœ‰ç¾¤çš„ä¼šå‘˜æ•°æ®éƒ½å­˜å‚¨åœ¨å½“å‰å¾®ä¿¡çš„æ•°æ®åº“ä¸­
- âœ… é€šè¿‡ `GroupWxId` å­—æ®µåŒºåˆ†ä¸åŒç¾¤çš„ä¼šå‘˜

**æ•°æ®åº“çŠ¶æ€**:
- `business_{wxid}.db` - ç»§ç»­ä½¿ç”¨ï¼ˆä¸å˜ï¼‰
- `logs.db` - ç»§ç»­ä½¿ç”¨ï¼ˆä¸å˜ï¼‰

**ä»£ç ä½ç½®**: `VxMain.cs` â†’ `btnBindingContacts_Click`

```csharp
private async void btnBindingContacts_Click(object sender, EventArgs e)
{
    // ä¿å­˜ç»‘å®šçš„ç¾¤ç»„
    _currentBoundContact = contact;
    
    // ğŸ”¥ æ¸…ç©ºå½“å‰ä¼šå‘˜å’Œè®¢å•åˆ—è¡¨ï¼ˆä¸åˆ›å»ºæ–°æ•°æ®åº“ï¼ï¼‰
    UpdateUIThreadSafe(() =>
    {
        _membersBindingList?.Clear();
        _ordersBindingList?.Clear();
    });
    
    // ğŸ”¥ è·å–ç¾¤æˆå‘˜
    var result = await _socketClient.SendAsync<JsonDocument>("GetGroupContacts", contact.Wxid);
    
    // ğŸ”¥ åŠ è½½åˆ°ä¼šå‘˜è¡¨ï¼ˆè‡ªåŠ¨ä¿å­˜åˆ° business_{UserInfo.Wxid}.dbï¼‰
    await LoadGroupMembersToDataGridAsync(result.RootElement, contact.Wxid);
}
```

---

### åœºæ™¯4: ç”¨æˆ·åˆ‡æ¢å¾®ä¿¡è´¦å·

```
ç”¨æˆ·ç™»å‡ºå½“å‰å¾®ä¿¡
    â†“
ç™»å½•å¦ä¸€ä¸ªå¾®ä¿¡è´¦å·
    â†“
æ”¶åˆ°æ–°çš„ UserInfoï¼ˆä¸åŒçš„ wxidï¼‰
    â†“
è§¦å‘ UserInfoService_UserInfoUpdated äº‹ä»¶
    â†“
æ£€æµ‹åˆ° wxid å˜åŒ–
    â†“
æ¸…ç©ºè”ç³»äººåˆ—è¡¨å’Œç»‘å®šä¿¡æ¯
    â†“
å…³é—­æ—§æ•°æ®åº“ business_{old_wxid}.db
    â†“
é‡æ–°ç»‘å®šæ–°æ•°æ®åº“ business_{new_wxid}.db
    â†“
åŠ è½½æ–°å¾®ä¿¡çš„ä¼šå‘˜å’Œè®¢å•æ•°æ®
```

**æ•°æ®åº“çŠ¶æ€**:
- `business_{old_wxid}.db` - å·²å…³é—­
- `business_{new_wxid}.db` - å·²åŠ è½½ï¼ˆæ–°å¾®ä¿¡çš„ä¸šåŠ¡æ•°æ®ï¼‰
- `logs.db` - ç»§ç»­ä½¿ç”¨ï¼ˆä¸å˜ï¼Œå…¨å±€å…±äº«ï¼‰

**ä»£ç ä½ç½®**: `VxMain.cs` â†’ `UserInfoService_UserInfoUpdated`

```csharp
// æ£€æµ‹ç”¨æˆ·åˆ‡æ¢
if (_currentUserInfo?.Wxid != e.UserInfo.Wxid)
{
    _logService.Warning("VxMain", 
        $"âš ï¸ æ£€æµ‹åˆ°ç”¨æˆ·åˆ‡æ¢: {_currentUserInfo.Wxid} â†’ {e.UserInfo.Wxid}");
    
    // æ¸…ç©ºè”ç³»äººåˆ—è¡¨å’Œç»‘å®šä¿¡æ¯
    UpdateUIThreadSafe(() =>
    {
        _contactsBindingList.Clear();
        _currentBoundContact = null;
        txtCurrentContact.Text = "æœªç»‘å®š";
    });
}

// ğŸ”¥ é‡æ–°ç»‘å®šæ•°æ®åº“
InitializeDatabase(e.UserInfo.Wxid);
```

---

## ğŸ“Š æ•°æ®å­˜å‚¨ç¤ºä¾‹

### ç¤ºä¾‹1: å•ä¸ªå¾®ä¿¡è´¦å·ï¼Œå¤šä¸ªç¾¤

**å¾®ä¿¡è´¦å·**: `wxid_abc123`

**æ•°æ®åº“**: `business_wxid_abc123.db`

**ä¼šå‘˜è¡¨æ•°æ®**:
| Id | GroupWxId | Wxid | Nickname | Balance | ... |
|----|-----------|------|----------|---------|-----|
| 1 | 12345@chatroom | wxid_user1 | å¼ ä¸‰ | 1000 | ... |
| 2 | 12345@chatroom | wxid_user2 | æå›› | 2000 | ... |
| 3 | 67890@chatroom | wxid_user3 | ç‹äº” | 1500 | ... |
| 4 | 67890@chatroom | wxid_user4 | èµµå…­ | 3000 | ... |

**è¯´æ˜**:
- æ‰€æœ‰ç¾¤çš„ä¼šå‘˜æ•°æ®éƒ½å­˜å‚¨åœ¨åŒä¸€ä¸ªæ•°æ®åº“ä¸­
- é€šè¿‡ `GroupWxId` å­—æ®µåŒºåˆ†ä¸åŒç¾¤çš„ä¼šå‘˜
- åˆ‡æ¢ç¾¤æ—¶ï¼Œåªéœ€è¦ç­›é€‰æ˜¾ç¤ºå¯¹åº”çš„ä¼šå‘˜æ•°æ®

---

### ç¤ºä¾‹2: å¤šä¸ªå¾®ä¿¡è´¦å·

**å¾®ä¿¡è´¦å·1**: `wxid_abc123`
- **æ•°æ®åº“**: `business_wxid_abc123.db`
- **ä¼šå‘˜æ•°**: 100 äºº
- **è®¢å•æ•°**: 500 æ¡

**å¾®ä¿¡è´¦å·2**: `wxid_def456`
- **æ•°æ®åº“**: `business_wxid_def456.db`
- **ä¼šå‘˜æ•°**: 80 äºº
- **è®¢å•æ•°**: 300 æ¡

**æ—¥å¿—æ•°æ®åº“**: `logs.db`ï¼ˆå…¨å±€å…±äº«ï¼‰
- **æ—¥å¿—æ•°**: 10000 æ¡ï¼ˆåŒ…å«æ‰€æœ‰å¾®ä¿¡è´¦å·çš„æ—¥å¿—ï¼‰

**è¯´æ˜**:
- æ¯ä¸ªå¾®ä¿¡è´¦å·çš„ä¸šåŠ¡æ•°æ®å®Œå…¨éš”ç¦»
- æ—¥å¿—æ•°æ®å…¨å±€å…±äº«ï¼Œä¾¿äºç»Ÿä¸€æŸ¥çœ‹å’Œç®¡ç†

---

## ğŸ”’ æ•°æ®éš”ç¦»åŸåˆ™

### 1. **è´¦å·çº§éš”ç¦»**
- âœ… ä¸åŒå¾®ä¿¡è´¦å·çš„ä¸šåŠ¡æ•°æ®å®Œå…¨éš”ç¦»
- âœ… é€šè¿‡æ•°æ®åº“å‘½åå®ç°ï¼š`business_{wxid}.db`
- âœ… è´¦å·åˆ‡æ¢æ—¶è‡ªåŠ¨åˆ‡æ¢æ•°æ®åº“

### 2. **ç¾¤çº§ç­›é€‰**
- âœ… åŒä¸€å¾®ä¿¡è´¦å·çš„å¤šä¸ªç¾¤æ•°æ®å­˜å‚¨åœ¨åŒä¸€æ•°æ®åº“
- âœ… é€šè¿‡ `GroupWxId` å­—æ®µç­›é€‰æ˜¾ç¤º
- âœ… åˆ‡æ¢ç¾¤æ—¶åªéœ€è¦æ›´æ–°æ˜¾ç¤ºç­›é€‰æ¡ä»¶

### 3. **æ—¥å¿—å…¨å±€å…±äº«**
- âœ… æ‰€æœ‰å¾®ä¿¡è´¦å·çš„æ—¥å¿—å­˜å‚¨åœ¨ `logs.db`
- âœ… ä¾¿äºç»Ÿä¸€æŸ¥çœ‹å’Œç®¡ç†
- âœ… ä¸éšè´¦å·åˆ‡æ¢è€Œæ”¹å˜

---

## ğŸš€ å®ç°ä»£ç 

### 1. åˆå§‹åŒ–æ•°æ®åº“

**ä½ç½®**: `VxMain.cs` â†’ `InitializeDatabase`

```csharp
private void InitializeDatabase(string wxid)
{
    try
    {
        // å…³é—­æ—§æ•°æ®åº“è¿æ¥
        _db?.Close();
        _db = null;
        
        // ğŸ”¥ æ•°æ®åº“å‘½åè§„åˆ™
        string dbPath = wxid == "default" 
            ? Path.Combine("Data", "business.db")           // é»˜è®¤ç©ºæ•°æ®åº“
            : Path.Combine("Data", $"business_{wxid}.db");  // å¾®ä¿¡ä¸“å±æ•°æ®åº“
            
        Directory.CreateDirectory("Data");
        
        _logService.Info("VxMain", $"åˆå§‹åŒ–æ•°æ®åº“: {dbPath}");
        
        // ğŸ”¥ åˆ›å»º ORM æ•°æ®åº“è¿æ¥
        _db = new SQLiteConnection(dbPath);
        
        // ğŸ”¥ åˆ›å»º BindingListï¼ˆè‡ªåŠ¨å»ºè¡¨ï¼‰
        _membersBindingList = new V2MemberBindingList(_db, "");
        _ordersBindingList = new V2OrderBindingList(_db);
        
        // ğŸ”¥ åŠ è½½æ•°æ®
        _membersBindingList.LoadFromDatabase();
        _ordersBindingList.LoadFromDatabase();
        
        // ğŸ”¥ ç»‘å®šåˆ° UI
        UpdateUIThreadSafe(() =>
        {
            dgvMembers.DataSource = _membersBindingList;
            dgvOrders.DataSource = _ordersBindingList;
            UpdateStatistics();
        });
        
        _logService.Info("VxMain", $"âœ… æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ: {dbPath}");
    }
    catch (Exception ex)
    {
        _logService.Error("VxMain", "åˆå§‹åŒ–æ•°æ®åº“å¤±è´¥", ex);
        UIMessageBox.ShowError($"åˆå§‹åŒ–æ•°æ®åº“å¤±è´¥ï¼š{ex.Message}");
    }
}
```

---

### 2. ç”¨æˆ·ä¿¡æ¯æ›´æ–°å¤„ç†

**ä½ç½®**: `VxMain.cs` â†’ `UserInfoService_UserInfoUpdated`

```csharp
private async void UserInfoService_UserInfoUpdated(object? sender, UserInfoUpdatedEventArgs e)
{
    // æ£€æµ‹ç”¨æˆ·åˆ‡æ¢
    bool isUserChanged = false;
    if (_currentUserInfo != null && !string.IsNullOrEmpty(_currentUserInfo.Wxid))
    {
        if (_currentUserInfo.Wxid != e.UserInfo.Wxid)
        {
            isUserChanged = true;
            _logService.Warning("VxMain", 
                $"âš ï¸ æ£€æµ‹åˆ°ç”¨æˆ·åˆ‡æ¢: {_currentUserInfo.Wxid} â†’ {e.UserInfo.Wxid}");
            
            // æ¸…ç©ºè”ç³»äººåˆ—è¡¨å’Œç»‘å®šä¿¡æ¯
            UpdateUIThreadSafe(() =>
            {
                _contactsBindingList.Clear();
                _currentBoundContact = null;
                txtCurrentContact.Text = "æœªç»‘å®š";
                txtCurrentContact.FillColor = Color.White;
                txtCurrentContact.RectColor = Color.Silver;
            });
        }
    }
    
    // æ›´æ–°å½“å‰ç”¨æˆ·ä¿¡æ¯
    _currentUserInfo = e.UserInfo;
    
    // ğŸ”¥ é‡æ–°ç»‘å®šæ•°æ®åº“ï¼ˆå¾®ä¿¡ä¸“å±æ•°æ®åº“ï¼‰
    if (!string.IsNullOrEmpty(e.UserInfo.Wxid))
    {
        _logService.Info("VxMain", 
            isUserChanged 
                ? $"ğŸ”„ ç”¨æˆ·åˆ‡æ¢ï¼Œé‡æ–°ç»‘å®šæ•°æ®åº“: business_{e.UserInfo.Wxid}.db"
                : $"ğŸ“‚ åˆå§‹åŒ–æ•°æ®åº“: business_{e.UserInfo.Wxid}.db");
        
        InitializeDatabase(e.UserInfo.Wxid);
    }
}
```

---

### 3. ç»‘å®šç¾¤ç»„å¤„ç†

**ä½ç½®**: `VxMain.cs` â†’ `btnBindingContacts_Click`

```csharp
private async void btnBindingContacts_Click(object sender, EventArgs e)
{
    // ä¿å­˜ç»‘å®šçš„ç¾¤ç»„
    _currentBoundContact = contact;
    
    // ğŸ”¥ æ¸…ç©ºå½“å‰ä¼šå‘˜å’Œè®¢å•åˆ—è¡¨ï¼ˆä¸åˆ›å»ºæ–°æ•°æ®åº“ï¼ï¼‰
    // âš ï¸ é‡è¦ï¼šæ•°æ®åº“å·²ç»åœ¨ç™»å½•æ—¶åˆå§‹åŒ–ä¸º business_{UserInfo.Wxid}.db
    // è¿™é‡Œåªéœ€è¦æ¸…ç©ºåˆ—è¡¨ï¼Œå‡†å¤‡åŠ è½½æ–°ç¾¤çš„æˆå‘˜æ•°æ®
    UpdateUIThreadSafe(() =>
    {
        _membersBindingList?.Clear();
        _ordersBindingList?.Clear();
        UpdateStatistics();
    });
    
    // ğŸ”¥ è·å–ç¾¤æˆå‘˜
    var result = await _socketClient.SendAsync<JsonDocument>("GetGroupContacts", contact.Wxid);
    
    // ğŸ”¥ åŠ è½½åˆ°ä¼šå‘˜è¡¨ï¼ˆè‡ªåŠ¨ä¿å­˜åˆ° business_{UserInfo.Wxid}.dbï¼‰
    await LoadGroupMembersToDataGridAsync(result.RootElement, contact.Wxid);
}
```

---

## âœ… æ€»ç»“

### æ•°æ®åº“å‘½åè§„åˆ™
1. âœ… **`business.db`**: é»˜è®¤ç©ºæ•°æ®åº“ï¼ˆç¨‹åºå¯åŠ¨æ—¶ä½¿ç”¨ï¼‰
2. âœ… **`business_{wxid}.db`**: å¾®ä¿¡ä¸“å±æ•°æ®åº“ï¼ˆå­˜å‚¨æ‰€æœ‰ä¸šåŠ¡æ•°æ®ï¼‰
3. âœ… **`logs.db`**: æ—¥å¿—æ•°æ®åº“ï¼ˆå…¨å±€å…±äº«ï¼‰

### æ•°æ®éš”ç¦»åŸåˆ™
1. âœ… **è´¦å·çº§éš”ç¦»**: ä¸åŒå¾®ä¿¡è´¦å·çš„æ•°æ®åº“å®Œå…¨ç‹¬ç«‹
2. âœ… **ç¾¤çº§ç­›é€‰**: åŒä¸€å¾®ä¿¡è´¦å·çš„å¤šä¸ªç¾¤æ•°æ®å­˜å‚¨åœ¨åŒä¸€æ•°æ®åº“ä¸­ï¼Œé€šè¿‡ `GroupWxId` ç­›é€‰
3. âœ… **æ—¥å¿—å…¨å±€å…±äº«**: æ‰€æœ‰å¾®ä¿¡è´¦å·çš„æ—¥å¿—å­˜å‚¨åœ¨ `logs.db`

### å…³é”®å®ç°
1. âœ… **ç¨‹åºå¯åŠ¨**: åŠ è½½ `business.db`ï¼ˆç©ºï¼‰
2. âœ… **å¾®ä¿¡ç™»å½•**: é‡æ–°ç»‘å®š `business_{wxid}.db`
3. âœ… **ç»‘å®šç¾¤ç»„**: ç»§ç»­ä½¿ç”¨ `business_{wxid}.db`ï¼Œä¸åˆ›å»ºæ–°æ•°æ®åº“
4. âœ… **ç”¨æˆ·åˆ‡æ¢**: è‡ªåŠ¨åˆ‡æ¢åˆ°æ–°ç”¨æˆ·çš„ `business_{new_wxid}.db`

---

**âœ… æ•°æ®åº“å‘½åå’Œç»‘å®šè§„åˆ™å·²å®Œå–„ï¼**

2025-11-06

