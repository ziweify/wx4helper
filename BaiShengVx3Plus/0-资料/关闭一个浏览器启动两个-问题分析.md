# å…³é—­ä¸€ä¸ªæµè§ˆå™¨å¯åŠ¨ä¸¤ä¸ª - é—®é¢˜åˆ†æ

## ğŸ› é—®é¢˜ç°è±¡

**ç”¨æˆ·åé¦ˆ**ï¼šå…³é—­äº†ä¸€ä¸ªæµè§ˆå™¨ï¼Œç»“æœå¯åŠ¨äº†ä¸¤ä¸ªï¼

---

## ğŸ” é—®é¢˜æ ¹æºï¼ˆå®Œæ•´æµç¨‹ï¼‰

### åœºæ™¯ï¼šç”¨æˆ·æ‰‹åŠ¨å…³é—­æµè§ˆå™¨çª—å£

```
[T+0s] ç”¨æˆ·æ‰‹åŠ¨å…³é—­æµè§ˆå™¨çª—å£
    â†“
[æµè§ˆå™¨è¿›ç¨‹] è¿›ç¨‹è¢« Kill
    â†“
[AutoBetSocketServer] Socket è¿æ¥æ–­å¼€
    â†“ (ä½†æ˜¯ï¼_browsers å­—å…¸ä¸­çš„ BrowserClient ä»ç„¶å­˜åœ¨ï¼)
    â†“
[MonitorBrowsers] ç¬¬1æ¬¡æ‰§è¡Œï¼ˆæ¯3ç§’ï¼‰
    â”œâ”€ æ£€æŸ¥: config.IsEnabled = trueï¼ˆâŒ è¿˜æ˜¯ trueï¼ï¼‰
    â”œâ”€ æ£€æŸ¥: _browsers.ContainsKey(configId) = trueï¼ˆâŒ è¿˜åœ¨å­—å…¸é‡Œï¼ï¼‰
    â”œâ”€ æ£€æŸ¥: browserClient.IsConnected = falseï¼ˆâœ… Socket å·²æ–­å¼€ï¼‰
    â”‚
    â”œâ”€ âš ï¸ å‘ç° IsConnected=falseï¼Œåˆ¤æ–­ä¸ºå¤±æ•ˆè¿æ¥
    â”œâ”€ ç§»é™¤ _browsers[configId]
    â”‚
    â”œâ”€ æ£€æŸ¥: isConnected = falseï¼ˆæœªè¿æ¥ï¼‰
    â”œâ”€ æ£€æŸ¥: config.IsEnabled = trueï¼ˆâŒ é—®é¢˜ï¼ç”¨æˆ·æ‰‹åŠ¨å…³é—­ï¼Œä½† IsEnabled è¿˜æ˜¯ trueï¼ï¼‰
    â”‚
    â”œâ”€ ğŸ”¥ åˆ¤æ–­ï¼šéœ€è¦å¯åŠ¨æµè§ˆå™¨ï¼ˆâŒ é”™è¯¯åˆ¤æ–­ï¼ï¼‰
    â”‚
    â”œâ”€ ç­‰å¾…2ç§’ï¼ˆç»™è€æµè§ˆå™¨é‡è¿çš„æœºä¼šï¼‰
    â”‚
    â”œâ”€ å†æ¬¡æ£€æŸ¥: isConnected = false
    â”‚
    â””â”€ ğŸš€ å¯åŠ¨æµè§ˆå™¨1  âŒâŒâŒ
    
[T+3s] MonitorBrowsers ç¬¬2æ¬¡æ‰§è¡Œ
    â”œâ”€ æ£€æŸ¥: config.IsEnabled = trueï¼ˆâŒ è¿˜æ˜¯ trueï¼ï¼‰
    â”œâ”€ æ£€æŸ¥: _browsers.ContainsKey(configId) = falseï¼ˆåˆšåˆšè¢«ç§»é™¤ï¼‰
    â”‚
    â”œâ”€ åˆ¤æ–­ï¼šéœ€è¦å¯åŠ¨æµè§ˆå™¨ï¼ˆâŒ åˆä¸€æ¬¡é”™è¯¯åˆ¤æ–­ï¼ï¼‰
    â”‚
    â”œâ”€ ç­‰å¾…2ç§’
    â”‚
    â”œâ”€ å†æ¬¡æ£€æŸ¥: isConnected = false
    â”‚
    â””â”€ ğŸš€ å¯åŠ¨æµè§ˆå™¨2  âŒâŒâŒ
```

---

## ğŸ’¥ æ ¸å¿ƒé—®é¢˜

### é—®é¢˜ 1ï¼šç”¨æˆ·æ‰‹åŠ¨å…³é—­æµè§ˆå™¨ï¼Œä½† `config.IsEnabled` ä»ç„¶æ˜¯ `true`

```csharp
// ç›‘æ§ä»»åŠ¡çš„é€»è¾‘
if (_configs == null) return;

var enabledConfigs = _configs.Where(c => c.IsEnabled).ToList();
// âŒ ç”¨æˆ·æ‰‹åŠ¨å…³é—­æµè§ˆå™¨çª—å£ï¼Œä½† config.IsEnabled ä»ç„¶æ˜¯ true
// âŒ ç›‘æ§ä»»åŠ¡è®¤ä¸º"ç”¨æˆ·æƒ³è¦å¯åŠ¨æµè§ˆå™¨"ï¼Œæ‰€ä»¥åˆå¯åŠ¨äº†
```

**é—®é¢˜**ï¼š
- ç”¨æˆ·**æ‰‹åŠ¨å…³é—­æµè§ˆå™¨çª—å£**ï¼ˆè¿›ç¨‹è¢«Killï¼‰
- ä½† `config.IsEnabled` **æ²¡æœ‰åŒæ­¥æ›´æ–°ä¸º false**
- ç›‘æ§ä»»åŠ¡çœ‹åˆ° `IsEnabled=true` + `IsConnected=false`
- åˆ¤æ–­ä¸º"éœ€è¦å¯åŠ¨æµè§ˆå™¨" â†’ è‡ªåŠ¨å¯åŠ¨
- **è¿™ä¸æ˜¯ç”¨æˆ·çš„æ„å›¾ï¼**

---

### é—®é¢˜ 2ï¼šæµè§ˆå™¨è¿›ç¨‹å…³é—­ï¼Œä½† `_browsers` å­—å…¸æ²¡æœ‰ç«‹å³æ¸…ç†

```csharp
// ç”¨æˆ·æ‰‹åŠ¨å…³é—­æµè§ˆå™¨çª—å£
[æµè§ˆå™¨è¿›ç¨‹] Kill

// âŒ _browsers å­—å…¸ä¸­çš„ BrowserClient ä»ç„¶å­˜åœ¨
// âŒ åªæœ‰ Socket è¿æ¥æ–­å¼€ï¼Œä½†å¯¹è±¡è¿˜åœ¨

// ä¸‹ä¸€æ¬¡ MonitorBrowsers æ‰§è¡Œæ—¶
if (_browsers.TryGetValue(config.Id, out var browserClient))
{
    isConnected = browserClient.IsConnected;  // âŒ è¿”å› false
    
    if (!isConnected)
    {
        _browsers.Remove(config.Id);  // ğŸ”¥ è¿™é‡Œæ‰ç§»é™¤
        // âŒ ä½†ä¸ºæ—¶å·²æ™šï¼Œç›‘æ§ä»»åŠ¡å·²ç»åˆ¤æ–­éœ€è¦å¯åŠ¨æµè§ˆå™¨äº†
    }
}
```

**é—®é¢˜**ï¼š
- æµè§ˆå™¨è¿›ç¨‹è¢« Killï¼Œä½† `_browsers` å­—å…¸æ²¡æœ‰ç«‹å³æ¸…ç†
- ç›‘æ§ä»»åŠ¡ç¬¬1æ¬¡æ‰§è¡Œæ—¶æ‰å‘ç°è¿æ¥æ–­å¼€
- ç§»é™¤åï¼Œç›‘æ§ä»»åŠ¡åˆ¤æ–­"éœ€è¦å¯åŠ¨æµè§ˆå™¨"
- **é‡å¤å¯åŠ¨ï¼**

---

### é—®é¢˜ 3ï¼šç›‘æ§ä»»åŠ¡çš„"ç­‰å¾…2ç§’"é€»è¾‘æœ‰ç«æ€æ¡ä»¶

```csharp
// ç›‘æ§ä»»åŠ¡é€»è¾‘
if (!isConnected)
{
    // ç­‰å¾…2ç§’ï¼Œç»™è€æµè§ˆå™¨é‡è¿çš„æœºä¼š
    _ = Task.Run(async () =>
    {
        try
        {
            await Task.Delay(2000);
            
            // å†æ¬¡æ£€æŸ¥æ˜¯å¦å·²è¿æ¥
            bool stillNotConnected;
            lock (_lock)
            {
                stillNotConnected = !_browsers.ContainsKey(configId);
            }
            
            if (stillNotConnected)
            {
                // ğŸ”¥ å¯åŠ¨æµè§ˆå™¨
                await StartBrowserInternal(configId);
            }
        }
        finally
        {
            _startingConfigs.Remove(configId);
        }
    });
}
```

**é—®é¢˜**ï¼š
- ç›‘æ§ä»»åŠ¡æ¯3ç§’æ‰§è¡Œä¸€æ¬¡
- ç¬¬1æ¬¡æ‰§è¡Œï¼šå‘ç°æœªè¿æ¥ï¼Œå¯åŠ¨ `Task.Run` â†’ ç­‰å¾…2ç§’ â†’ å¯åŠ¨æµè§ˆå™¨1
- **ç¬¬2æ¬¡æ‰§è¡Œï¼ˆ3ç§’åï¼‰**ï¼šåˆå‘ç°æœªè¿æ¥ï¼Œåˆå¯åŠ¨ `Task.Run` â†’ ç­‰å¾…2ç§’ â†’ å¯åŠ¨æµè§ˆå™¨2
- `_startingConfigs` çš„æ£€æŸ¥**åœ¨ `Task.Run` é‡Œé¢**ï¼Œè€Œä¸æ˜¯åœ¨å¤–é¢
- **ç«æ€æ¡ä»¶ï¼**

---

## ğŸ¯ æ ¹æœ¬åŸå› æ€»ç»“

1. **ç”¨æˆ·æ„å›¾æœªåŒæ­¥**ï¼š
   - ç”¨æˆ·æ‰‹åŠ¨å…³é—­æµè§ˆå™¨çª—å£
   - ä½† `config.IsEnabled` æ²¡æœ‰åŒæ­¥æ›´æ–°ä¸º `false`
   - ç›‘æ§ä»»åŠ¡è®¤ä¸º"ç”¨æˆ·æƒ³è¦å¯åŠ¨æµè§ˆå™¨"

2. **çŠ¶æ€æ¸…ç†ä¸åŠæ—¶**ï¼š
   - æµè§ˆå™¨è¿›ç¨‹è¢« Kill
   - `_browsers` å­—å…¸æ²¡æœ‰ç«‹å³æ¸…ç†
   - ç›‘æ§ä»»åŠ¡å‘ç°è¿æ¥æ–­å¼€åæ‰æ¸…ç†ï¼Œä½†å·²ç»åˆ¤æ–­éœ€è¦å¯åŠ¨

3. **å¹¶å‘æ§åˆ¶ä¸è¶³**ï¼š
   - ç›‘æ§ä»»åŠ¡æ¯3ç§’æ‰§è¡Œä¸€æ¬¡
   - `_startingConfigs` æ£€æŸ¥åœ¨ `Task.Run` é‡Œé¢
   - ä¸¤æ¬¡ç›‘æ§ä»»åŠ¡ä¹‹é—´æœ‰ç«æ€æ¡ä»¶
   - å¯èƒ½åŒæ—¶å¯åŠ¨å¤šä¸ªæµè§ˆå™¨

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ 1ï¼šç›‘å¬æµè§ˆå™¨è¿›ç¨‹é€€å‡ºäº‹ä»¶

```csharp
// BrowserClient.cs
public async Task<bool> StartAsync(int port, string configName, string platform, string platformUrl)
{
    // ... å¯åŠ¨è¿›ç¨‹ ...
    
    _process.Start();
    
    // ğŸ”¥ ç›‘å¬è¿›ç¨‹é€€å‡ºäº‹ä»¶
    _process.EnableRaisingEvents = true;
    _process.Exited += (s, e) =>
    {
        Console.WriteLine($"[BrowserClient] æµè§ˆå™¨è¿›ç¨‹å·²é€€å‡º: ConfigId={_configId}");
        
        // ğŸ”¥ é€šçŸ¥ AutoBetService æµè§ˆå™¨å·²å…³é—­
        OnProcessExited?.Invoke(_configId);
    };
    
    return true;
}

// æ–°å¢äº‹ä»¶
public event Action<int>? OnProcessExited;
```

```csharp
// AutoBetService.cs
var newBrowserClient = new BrowserClient(configId);

// ğŸ”¥ è®¢é˜…è¿›ç¨‹é€€å‡ºäº‹ä»¶
newBrowserClient.OnProcessExited += (closedConfigId) =>
{
    _log.Info("AutoBet", $"âš ï¸ æµè§ˆå™¨è¿›ç¨‹å·²é€€å‡º: ConfigId={closedConfigId}");
    
    // ğŸ”¥ ç«‹å³æ¸…ç†
    lock (_lock)
    {
        _browsers.Remove(closedConfigId);
    }
    
    // ğŸ”¥ å¦‚æœ IsEnabled=trueï¼Œè¯´æ˜ä¸æ˜¯ç”¨æˆ·ä¸»åŠ¨å…³é—­ï¼Œå¯èƒ½æ˜¯å´©æºƒ
    var config = GetConfig(closedConfigId);
    if (config != null && config.IsEnabled)
    {
        _log.Warning("AutoBet", $"   æµè§ˆå™¨æ„å¤–é€€å‡ºï¼ˆIsEnabled=trueï¼‰ï¼Œç›‘æ§ä»»åŠ¡å°†è‡ªåŠ¨é‡å¯");
    }
    else
    {
        _log.Info("AutoBet", $"   ç”¨æˆ·ä¸»åŠ¨å…³é—­æµè§ˆå™¨ï¼ˆIsEnabled=falseï¼‰ï¼Œä¸ä¼šè‡ªåŠ¨é‡å¯");
    }
};

await newBrowserClient.StartAsync(...);
```

---

### ä¿®å¤ 2ï¼š`StopBrowser` å…ˆè®¾ç½® `IsEnabled=false`

```csharp
public void StopBrowser(int configId)
{
    var config = GetConfig(configId);
    
    // ğŸ”¥ å…ˆè®¾ç½® IsEnabled=falseï¼ˆé˜²æ­¢ç›‘æ§ä»»åŠ¡é‡å¯ï¼‰
    if (config != null)
    {
        config.IsEnabled = false;  // è‡ªåŠ¨ä¿å­˜
        _log.Info("AutoBet", $"âœ… é…ç½® [{config.ConfigName}] é£å•å·²å…³é—­");
    }
    
    // ç„¶åå…³é—­æµè§ˆå™¨è¿›ç¨‹
    if (_browsers.TryGetValue(configId, out var browserClient))
    {
        browserClient.Dispose();
        
        lock (_lock)
        {
            _browsers.Remove(configId);
        }
        
        // ... æ›´æ–°çŠ¶æ€ ...
    }
}
```

---

### ä¿®å¤ 3ï¼šç›‘æ§ä»»åŠ¡çš„å¹¶å‘æ§åˆ¶å‰ç½®

```csharp
private void MonitorBrowsers(object? state)
{
    try
    {
        if (_configs == null) return;
        
        var enabledConfigs = _configs.Where(c => c.IsEnabled).ToList();
        if (enabledConfigs.Count == 0) return;
        
        foreach (var config in enabledConfigs)
        {
            // ğŸ”¥ æ£€æŸ¥è¿æ¥çŠ¶æ€
            bool isConnected = false;
            lock (_lock)
            {
                if (_browsers.TryGetValue(config.Id, out var browserClient))
                {
                    isConnected = browserClient.IsConnected;
                    
                    if (!isConnected)
                    {
                        // ç§»é™¤å¤±æ•ˆçš„
                        _browsers.Remove(config.Id);
                    }
                }
            }
            
            if (isConnected)
            {
                continue;  // å·²è¿æ¥ï¼Œè·³è¿‡
            }
            
            // ğŸ”¥ æ£€æŸ¥æ˜¯å¦æ­£åœ¨å¯åŠ¨ï¼ˆå‰ç½®æ£€æŸ¥ï¼Œé¿å…ç«æ€ï¼‰
            bool shouldStart = false;
            lock (_lock)
            {
                if (!_startingConfigs.Contains(config.Id))
                {
                    _startingConfigs.Add(config.Id);  // ğŸ”¥ ç«‹å³æ ‡è®°
                    shouldStart = true;
                }
            }
            
            if (!shouldStart)
            {
                // å…¶ä»–ä»»åŠ¡æ­£åœ¨å¯åŠ¨ï¼Œè·³è¿‡
                continue;
            }
            
            // ğŸ”¥ å¯åŠ¨æµè§ˆå™¨ï¼ˆå·²ç»æ ‡è®°ï¼Œä¸ä¼šé‡å¤ï¼‰
            _ = Task.Run(async () =>
            {
                try
                {
                    await Task.Delay(2000);  // ç­‰å¾…2ç§’
                    
                    // å†æ¬¡æ£€æŸ¥
                    bool stillNotConnected;
                    lock (_lock)
                    {
                        stillNotConnected = !_browsers.ContainsKey(config.Id);
                    }
                    
                    if (stillNotConnected)
                    {
                        await StartBrowserInternal(config.Id);
                    }
                }
                catch (Exception ex)
                {
                    _log.Error("AutoBet", $"ç›‘æ§ä»»åŠ¡å¯åŠ¨æµè§ˆå™¨å¤±è´¥: ConfigId={config.Id}", ex);
                }
                finally
                {
                    lock (_lock)
                    {
                        _startingConfigs.Remove(config.Id);  // ğŸ”¥ ç§»é™¤æ ‡è®°
                    }
                }
            });
        }
    }
    catch (Exception ex)
    {
        _log.Error("AutoBet", "ç›‘æ§ä»»åŠ¡å¼‚å¸¸", ex);
    }
}
```

---

## ğŸ“Š ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰ï¼ˆâŒï¼‰ï¼š

```
[T+0s] ç”¨æˆ·å…³é—­æµè§ˆå™¨çª—å£
[T+3s] ç›‘æ§ä»»åŠ¡1: IsEnabled=true, IsConnected=false â†’ å¯åŠ¨æµè§ˆå™¨1 âŒ
[T+6s] ç›‘æ§ä»»åŠ¡2: IsEnabled=true, IsConnected=false â†’ å¯åŠ¨æµè§ˆå™¨2 âŒ
```

### ä¿®å¤åï¼ˆâœ…ï¼‰ï¼š

```
[T+0s] ç”¨æˆ·å…³é—­æµè§ˆå™¨çª—å£
[T+0s] è¿›ç¨‹é€€å‡ºäº‹ä»¶è§¦å‘ â†’ IsEnabled=false â†’ æ¸…ç† _browsers
[T+3s] ç›‘æ§ä»»åŠ¡: IsEnabled=false â†’ è·³è¿‡ï¼ˆä¸å¯åŠ¨ï¼‰ âœ…
```

---

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

1. **ç”¨æˆ·æ„å›¾ä¼˜å…ˆ**ï¼š
   - ç”¨æˆ·æ‰‹åŠ¨å…³é—­æµè§ˆå™¨ â†’ ç«‹å³è®¾ç½® `IsEnabled=false`
   - æµè§ˆå™¨æ„å¤–å´©æºƒ â†’ `IsEnabled=true`ï¼Œç›‘æ§ä»»åŠ¡è‡ªåŠ¨é‡å¯

2. **çŠ¶æ€åŒæ­¥åŠæ—¶**ï¼š
   - ç›‘å¬è¿›ç¨‹é€€å‡ºäº‹ä»¶ï¼Œç«‹å³æ¸…ç†çŠ¶æ€
   - ä¸è¦ç­‰åˆ°ä¸‹ä¸€æ¬¡ç›‘æ§ä»»åŠ¡æ‰æ¸…ç†

3. **å¹¶å‘æ§åˆ¶å‰ç½®**ï¼š
   - `_startingConfigs` æ£€æŸ¥åœ¨ `Task.Run` **ä¹‹å‰**
   - é¿å…ç«æ€æ¡ä»¶

---

## ğŸš€ ä¸‹ä¸€æ­¥

ç«‹å³å®æ–½è¿™ä¸‰ä¸ªä¿®å¤ï¼

