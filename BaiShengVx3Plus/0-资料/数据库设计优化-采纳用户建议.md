# æ•°æ®åº“è®¾è®¡ä¼˜åŒ– - é‡‡çº³ç”¨æˆ·å»ºè®®

## ğŸ¯ ç”¨æˆ·å»ºè®®ï¼ˆé¡¹ç›®ç»ç†è§†è§’ï¼‰

### åŸé—®é¢˜

1. **çª—å£å¡æ­»**ï¼šåŠ è½½è”ç³»äººæ—¶çª—å£æ˜¾ç¤º"æœªå“åº”"
2. **è¡¨æ˜¾ç¤º"æœªåŠ è½½"**ï¼šä¼šå‘˜è¡¨ã€è®¢å•è¡¨ä¸€ç›´æ˜¾ç¤º"æœªåŠ è½½"
3. **è®¾è®¡ä¸åˆç†**ï¼šæ•°æ®åº“åˆå§‹åŒ–ä¾èµ– `wxid`ï¼Œä½† `wxid` è¦ç™»å½•åæ‰èƒ½è·å–

### ç”¨æˆ·å»ºè®®çš„è®¾è®¡æµç¨‹

```
ç¨‹åºå¯åŠ¨
  â†“
ç«‹å³åˆå§‹åŒ– business.dbï¼ˆé€šç”¨æ•°æ®åº“ï¼‰
  â†“
ä¼šå‘˜è¡¨ã€è®¢å•è¡¨ç«‹å³å¯ç”¨ï¼ˆæ˜¾ç¤º "å…±0äºº"/"å…±0å•"ï¼‰
  â†“
ç”¨æˆ·é€‰æ‹©ç¾¤å¹¶ç»‘å®š
  â†“
åˆ‡æ¢åˆ° business_{group_wxid}.dbï¼ˆç¾¤ä¸“å±æ•°æ®åº“ï¼‰
  â†“
ä¼šå‘˜è¡¨åªæ˜¾ç¤ºè¯¥ç¾¤çš„ä¼šå‘˜ï¼Œå®ç°æ•°æ®éš”ç¦»
```

### ç”¨æˆ·è§‚ç‚¹

> "ä»–ä»¬å¯ä»¥åˆå§‹åŒ–æˆ business.db ç»‘å®šï¼Œé€‰æ‹©ç¾¤ä¹‹åï¼Œå°±ç»‘å®š business+wxid.dbã€‚è¿™æ ·ä¹Ÿå’Œæˆ‘ä»¬è®¾è®¡æµç¨‹ä¸€è‡´ã€‚"

**âœ… è¿™ä¸ªå»ºè®®éå¸¸åˆç†ï¼**

---

## âœ… é‡‡çº³çš„ä¼˜åŒ–æ–¹æ¡ˆ

### ä¼˜åŒ–1: ç«‹å³åˆå§‹åŒ–é»˜è®¤æ•°æ®åº“

**ä¿®æ”¹å‰**ï¼š
```csharp
public VxMain(...)
{
    // ...
    // âŒ ä¸åˆå§‹åŒ–æ•°æ®åº“ï¼Œç­‰å¾… wxid
    InitializeDataBindings();
}
```

**ä¿®æ”¹å**ï¼š
```csharp
public VxMain(...)
{
    // ...
    // âœ… ç«‹å³åˆå§‹åŒ–é»˜è®¤æ•°æ®åº“ business.db
    InitializeDatabase("default");
    InitializeDataBindings();
}
```

### ä¼˜åŒ–2: æ•°æ®åº“è·¯å¾„è®¾è®¡

**ä¿®æ”¹å‰**ï¼š
```csharp
private void InitializeDatabase(string wxid)
{
    // âŒ æ€»æ˜¯ä½¿ç”¨ business_{wxid}.db
    string dbPath = Path.Combine("Data", $"business_{wxid}.db");
}
```

**ä¿®æ”¹å**ï¼š
```csharp
private void InitializeDatabase(string identifier)
{
    // âœ… æ ¹æ®æ ‡è¯†ç¬¦å†³å®šæ•°æ®åº“è·¯å¾„
    string dbPath = identifier == "default" 
        ? Path.Combine("Data", "business.db")          // é€šç”¨æ•°æ®åº“
        : Path.Combine("Data", $"business_{identifier}.db");  // ç¾¤ä¸“å±æ•°æ®åº“
}
```

### ä¼˜åŒ–3: ç»‘å®šç¾¤æ—¶åˆ‡æ¢æ•°æ®åº“

**ä¿®æ”¹å‰**ï¼š
```csharp
private async void btnBindingContacts_Click(...)
{
    // âŒ åªè·å–ç¾¤æˆå‘˜ï¼Œä¸åˆ‡æ¢æ•°æ®åº“
    var result = await _socketClient.SendAsync<JsonDocument>("GetGroupContacts", contact.Wxid);
    await LoadGroupMembersToDataGridAsync(result.RootElement, contact.Wxid);
}
```

**ä¿®æ”¹å**ï¼š
```csharp
private async void btnBindingContacts_Click(...)
{
    // âœ… å…ˆåˆ‡æ¢åˆ°ç¾¤ä¸“å±æ•°æ®åº“
    InitializeDatabase(contact.Wxid);  // business_{contact.Wxid}.db
    
    // ç„¶åè·å–ç¾¤æˆå‘˜
    var result = await _socketClient.SendAsync<JsonDocument>("GetGroupContacts", contact.Wxid);
    await LoadGroupMembersToDataGridAsync(result.RootElement, contact.Wxid);
}
```

### ä¼˜åŒ–4: å¼‚æ­¥å¤„ç†è”ç³»äººæ•°æ®

**ä¿®æ”¹å‰**ï¼š
```csharp
private void ContactDataService_ContactsUpdated(...)
{
    // âŒ åŒæ­¥è°ƒç”¨ï¼Œé˜»å¡ UI çº¿ç¨‹
    Invoke(new Action(() => UpdateContactsList(e.Contacts)));
}
```

**ä¿®æ”¹å**ï¼š
```csharp
private async void ContactDataService_ContactsUpdated(...)
{
    // âœ… å¼‚æ­¥å¤„ç†ï¼Œä¸é˜»å¡ UI
    await Task.Run(() => { /* åå°å¤„ç† */ });
    await Task.Factory.StartNew(() =>
    {
        Invoke(new Action(() => UpdateContactsList(e.Contacts)));
    });
}
```

---

## ğŸ“Š æ–°çš„æ•°æ®æµç¨‹

### æµç¨‹1: ç¨‹åºå¯åŠ¨

```
VxMain æ„é€ å‡½æ•°
  â†“
InitializeDatabase("default")
  â†“
åˆ›å»º Data/business.db
  â†“
åˆ›å»º V2MemberBindingList å’Œ V2OrderBindingList
  â†“
LoadFromDatabase() â†’ 0ä¸ªä¼šå‘˜ï¼Œ0ä¸ªè®¢å•
  â†“
UpdateStatistics()
  â†“
æ˜¾ç¤º "ä¼šå‘˜åˆ—è¡¨ (å…±0äºº)" âœ…
æ˜¾ç¤º "è®¢å•åˆ—è¡¨ (å…±0å•)" âœ…
```

### æµç¨‹2: ç»‘å®šç¾¤

```
ç”¨æˆ·é€‰æ‹©ç¾¤ â†’ ç‚¹å‡»"ç»‘å®š"
  â†“
btnBindingContacts_Click
  â†“
InitializeDatabase(group_wxid)
  â†“
åˆ‡æ¢åˆ° Data/business_{group_wxid}.db
  â†“
é‡æ–°åˆ›å»º BindingListï¼ˆæ–°æ•°æ®åº“ï¼‰
  â†“
LoadFromDatabase() â†’ åŠ è½½è¯¥ç¾¤çš„ä¼šå‘˜å’Œè®¢å•
  â†“
UpdateStatistics()
  â†“
æ˜¾ç¤º "ä¼šå‘˜åˆ—è¡¨ (å…±Xäºº)" âœ…
æ˜¾ç¤º "è®¢å•åˆ—è¡¨ (å…±Xå•)" âœ…
```

### æµç¨‹3: åˆ‡æ¢ç¾¤

```
ç”¨æˆ·é€‰æ‹©å¦ä¸€ä¸ªç¾¤ â†’ ç‚¹å‡»"ç»‘å®š"
  â†“
InitializeDatabase(new_group_wxid)
  â†“
å…³é—­æ—§æ•°æ®åº“è¿æ¥
  â†“
åˆ‡æ¢åˆ° Data/business_{new_group_wxid}.db
  â†“
é‡æ–°åŠ è½½æ•°æ®
  â†“
æ˜¾ç¤ºæ–°ç¾¤çš„ä¼šå‘˜å’Œè®¢å• âœ…
```

---

## ğŸ¯ æ•°æ®åº“æ–‡ä»¶ç»“æ„

```
Data/
â”œâ”€â”€ logs.db                           # æ—¥å¿—æ•°æ®åº“ï¼ˆå…¨å±€ï¼‰
â”œâ”€â”€ business.db                       # é€šç”¨ä¸šåŠ¡æ•°æ®åº“ï¼ˆå¯åŠ¨æ—¶ï¼‰âœ…
â”œâ”€â”€ business_27206515609@chatroom.db  # ç¾¤1ä¸“å±æ•°æ®åº“ âœ…
â”œâ”€â”€ business_38917284561@chatroom.db  # ç¾¤2ä¸“å±æ•°æ®åº“ âœ…
â””â”€â”€ business_49182736450@chatroom.db  # ç¾¤3ä¸“å±æ•°æ®åº“ âœ…
```

**ä¼˜ç‚¹**ï¼š
- âœ… æ¯ä¸ªç¾¤çš„æ•°æ®å®Œå…¨éš”ç¦»
- âœ… åˆ‡æ¢ç¾¤æ—¶æ•°æ®ä¸ä¼šæ··æ·†
- âœ… å¯ä»¥ç‹¬ç«‹å¤‡ä»½æˆ–åˆ é™¤æŸä¸ªç¾¤çš„æ•°æ®
- âœ… ç¬¦åˆå¤šç§Ÿæˆ·æ•°æ®éš”ç¦»çš„æœ€ä½³å®è·µ

---

## âœ… è§£å†³çš„é—®é¢˜

### é—®é¢˜1: çª—å£å¡æ­» âœ…

**åŸå› **: åŒæ­¥è°ƒç”¨é˜»å¡ UI çº¿ç¨‹

**è§£å†³**:
```csharp
// ä¿®æ”¹ä¸ºå¼‚æ­¥å¤„ç†
private async void ContactDataService_ContactsUpdated(...)
{
    await Task.Run(() => { /* åå°å¤„ç† */ });
    // UI æ›´æ–°åœ¨åå°ä»»åŠ¡å®Œæˆåæ‰§è¡Œ
}
```

### é—®é¢˜2: è¡¨æ˜¾ç¤º"æœªåŠ è½½" âœ…

**åŸå› **: æ•°æ®åº“æœªåˆå§‹åŒ–ï¼ˆç­‰å¾… wxidï¼‰

**è§£å†³**:
```csharp
// æ„é€ å‡½æ•°ä¸­ç«‹å³åˆå§‹åŒ–
InitializeDatabase("default");  // business.db

// ç«‹å³æ˜¾ç¤º "å…±0äºº"ã€"å…±0å•"
UpdateStatistics();
```

### é—®é¢˜3: ç»‘å®šç¾¤åä»æ˜¾ç¤º"æœªåŠ è½½" âœ…

**åŸå› **: æœªåˆ‡æ¢æ•°æ®åº“ï¼Œæœªæ›´æ–°ç»Ÿè®¡

**è§£å†³**:
```csharp
// ç»‘å®šç¾¤æ—¶åˆ‡æ¢æ•°æ®åº“
InitializeDatabase(contact.Wxid);  // business_{wxid}.db

// è‡ªåŠ¨è°ƒç”¨ UpdateStatistics()
// æ˜¾ç¤ºçœŸå®çš„ä¼šå‘˜å’Œè®¢å•æ•°é‡
```

---

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”

| åœºæ™¯             | ä¿®æ”¹å‰                  | ä¿®æ”¹å                |
|------------------|------------------------|-----------------------|
| å¯åŠ¨æ—¶é—´         | å¿«é€Ÿï¼ˆä¸åˆå§‹åŒ–æ•°æ®åº“ï¼‰  | å¿«é€Ÿï¼ˆåˆå§‹åŒ–ç©ºæ•°æ®åº“ï¼‰ |
| å¯åŠ¨åUIçŠ¶æ€     | æ˜¾ç¤º"æœªåŠ è½½"ï¼ˆä½“éªŒå·®ï¼‰  | æ˜¾ç¤º"å…±0äºº"ï¼ˆä½“éªŒå¥½ï¼‰  |
| åŠ è½½è”ç³»äºº       | çª—å£å¡æ­»ï¼ˆåŒæ­¥è°ƒç”¨ï¼‰    | æµç•…ï¼ˆå¼‚æ­¥å¤„ç†ï¼‰       |
| ç»‘å®šç¾¤           | æ•°æ®ä¸åˆ‡æ¢ï¼ˆæ··ä¹±ï¼‰      | åˆ‡æ¢æ•°æ®åº“ï¼ˆæ¸…æ™°ï¼‰     |
| åˆ‡æ¢ç¾¤           | æ•°æ®æ··æ·†ï¼ˆBugï¼‰         | æ•°æ®éš”ç¦»ï¼ˆæ­£ç¡®ï¼‰       |

---

## ğŸ‰ ç”¨æˆ·å»ºè®®è¯„ä»·

### ä»é¡¹ç›®ç»ç†è§†è§’

âœ… **ç”¨æˆ·çš„å»ºè®®éå¸¸ä¸“ä¸šä¸”å®ç”¨ï¼**

1. **ç¬¦åˆä¸šåŠ¡é€»è¾‘**ï¼šå…ˆæœ‰é»˜è®¤çŠ¶æ€ï¼Œå†æ ¹æ®ä¸šåŠ¡é€‰æ‹©åˆ‡æ¢
2. **ç”¨æˆ·ä½“éªŒå¥½**ï¼šç«‹å³å¯ç”¨ï¼Œä¸ä¼šæ˜¾ç¤º"æœªåŠ è½½"
3. **æ•°æ®éš”ç¦»æ¸…æ™°**ï¼šæ¯ä¸ªç¾¤ç‹¬ç«‹æ•°æ®åº“ï¼Œé¿å…æ··æ·†
4. **æ˜“äºç»´æŠ¤**ï¼šæ•°æ®åº“æ–‡ä»¶ç»“æ„æ¸…æ™°ï¼Œä¾¿äºç®¡ç†

### è®¾è®¡åŸåˆ™

âœ… **éµå¾ªä»¥ä¸‹åŸåˆ™**ï¼š

1. **ç«‹å³å¯ç”¨åŸåˆ™**ï¼šç¨‹åºå¯åŠ¨åæ‰€æœ‰UIå…ƒç´ ç«‹å³å¯ç”¨
2. **æ•°æ®éš”ç¦»åŸåˆ™**ï¼šä¸åŒä¸šåŠ¡å®ä½“ä½¿ç”¨ç‹¬ç«‹æ•°æ®åº“
3. **å¼‚æ­¥ä¼˜å…ˆåŸåˆ™**ï¼šIOæ“ä½œä½¿ç”¨å¼‚æ­¥ï¼Œä¸é˜»å¡UI
4. **æ¸è¿›å¢å¼ºåŸåˆ™**ï¼šå…ˆæœ‰åŸºç¡€åŠŸèƒ½ï¼Œå†æ ¹æ®ä¸šåŠ¡æ‰©å±•

---

## ğŸ“ åç»­ä¼˜åŒ–å»ºè®®

### 1. æ•°æ®åº“è¿ç§»

å¦‚æœç¾¤IDå˜åŒ–æˆ–é‡å‘½åï¼Œéœ€è¦æ•°æ®è¿ç§»ï¼š
```csharp
private void MigrateDatabase(string oldGroupId, string newGroupId)
{
    var oldPath = Path.Combine("Data", $"business_{oldGroupId}.db");
    var newPath = Path.Combine("Data", $"business_{newGroupId}.db");
    File.Copy(oldPath, newPath, overwrite: true);
}
```

### 2. æ•°æ®åº“æ¸…ç†

å®šæœŸæ¸…ç†ä¸å†ä½¿ç”¨çš„ç¾¤æ•°æ®åº“ï¼š
```csharp
private void CleanupUnusedDatabases()
{
    // è·å–æ‰€æœ‰ç¾¤ID
    var activeGroupIds = _contactsBindingList
        .Where(c => c.Wxid.Contains("@"))
        .Select(c => c.Wxid)
        .ToHashSet();
    
    // åˆ é™¤ä¸å†ä½¿ç”¨çš„æ•°æ®åº“
    foreach (var dbFile in Directory.GetFiles("Data", "business_*.db"))
    {
        var groupId = Path.GetFileNameWithoutExtension(dbFile).Replace("business_", "");
        if (!activeGroupIds.Contains(groupId))
        {
            File.Delete(dbFile);
        }
    }
}
```

### 3. æ•°æ®å¤‡ä»½

æ¯å¤©è‡ªåŠ¨å¤‡ä»½æ•°æ®åº“ï¼š
```csharp
private void BackupDatabase(string groupId)
{
    var srcPath = Path.Combine("Data", $"business_{groupId}.db");
    var backupPath = Path.Combine("Backup", $"business_{groupId}_{DateTime.Now:yyyyMMdd}.db");
    Directory.CreateDirectory("Backup");
    File.Copy(srcPath, backupPath, overwrite: true);
}
```

---

**ä¿®æ”¹æ—¥æœŸ**: 2025-11-06  
**çŠ¶æ€**: âœ… å·²å®æ–½ç”¨æˆ·å»ºè®®ï¼Œä¼˜åŒ–å®Œæˆ  
**è´¡çŒ®è€…**: ç”¨æˆ·ï¼ˆé¡¹ç›®ç»ç†è§†è§’çš„ä¸“ä¸šå»ºè®®ï¼‰

