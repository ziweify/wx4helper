# ç®¡ç†å‘˜å‘½ä»¤ - å®ç°éœ€æ±‚ï¼ˆå‚è€ƒ F5BotV2ï¼‰

## ğŸ“‹ å½“å‰çŠ¶æ€

å½“å‰ç³»ç»Ÿ**æ²¡æœ‰**ç®¡ç†å‘˜ä¸“å±å‘½ä»¤çš„å®ç°ã€‚éœ€è¦æ ¹æ® F5BotV2 å®Œå…¨ä¸€è‡´åœ°å®ç°ã€‚

---

## ğŸ¯ F5BotV2 ç®¡ç†å‘˜å‘½ä»¤åˆ†æ

### æƒé™åˆ¤æ–­é€»è¾‘

```csharp
// F5BotV2/Boter/BoterServices.cs Line 2014-2075
var m = v2Memberbindlite.FirstOrDefault((p) => p.wxid == groupMsg.from_wxid);
bool bManger = false;

if (m != null)
{
    // ğŸ“Œ éç®¡ç†å‘˜ï¼šå¤„ç†æ™®é€šä¼šå‘˜å‘½ä»¤
    if (m.State != MemBerState.ç®¡ç† && groupMsg.from_wxid != this.wxHelper.wxid)
    {
        // ä¸Šä¸‹åˆ†ã€æŸ¥æµæ°´ã€æŠ•æ³¨ã€æ’¤å•ç­‰æ™®é€šå‘½ä»¤
        if (this.LexicalMemberä¸Šä¸‹åˆ†(groupMsg, m) != -1)
            return true;
        if (this.LexicalMemberæŸ¥æµæ°´(groupMsg, m) != -1)
            return true;
        if (this.LexicalMemberBet(groupMsg, issueid, m) != -1)
            return true;
        if (this.LexicalMemberOrderCencel(groupMsg, issueid, m) != -1)
            return true;
    }
    else
    {
        // ğŸ“Œ æ˜¯ç®¡ç†å‘˜
        bManger = true;
    }
}

// ğŸ“Œ ç‰¹æ®Šæƒ…å†µï¼šfrom_wxid == "NULL"ï¼ˆç³»ç»Ÿæ¶ˆæ¯ï¼‰ä¹Ÿè§†ä¸ºç®¡ç†
if(groupMsg.from_wxid == "NULL")
{
    bManger = true;
}

// ğŸ“Œ å¤„ç†ç®¡ç†å‘˜å‘½ä»¤
if(bManger)
{
    if (LexicalAdminä¸Šä¸‹åˆ†(groupMsg) != -1)
        return true;
    if (LexicalAdminåˆ·æ–°(groupMsg) != -1)
        return true;
}
```

### ç®¡ç†å‘˜åˆ¤æ–­æ¡ä»¶

1. **`m.State == MemBerState.ç®¡ç†`**ï¼šä¼šå‘˜çŠ¶æ€æ˜¯"ç®¡ç†"
2. **`from_wxid == wxHelper.wxid`**ï¼šå‘é€è€…æ˜¯æœºå™¨äººè‡ªå·±
3. **`from_wxid == "NULL"`**ï¼šç³»ç»Ÿæ¶ˆæ¯

---

## ğŸ“ éœ€è¦å®ç°çš„å‘½ä»¤

### 1. åˆ·æ–°å‘½ä»¤

**è§¦å‘æ¡ä»¶**ï¼š
```
æ¶ˆæ¯å†…å®¹ == "åˆ·æ–°"ï¼ˆå»é™¤ç©ºæ ¼åï¼‰
```

**åŠŸèƒ½**ï¼š
- è°ƒç”¨å¾®ä¿¡APIè·å–ç¾¤æˆå‘˜åˆ—è¡¨
- å¯¹æ¯”æ•°æ®åº“ä¸­çš„æˆå‘˜
- æ·»åŠ æ–°æˆå‘˜åˆ°æ•°æ®åº“
- å¯¹æ¯ä¸ªæ–°æˆå‘˜å›å¤æ¬¢è¿æ¶ˆæ¯

**å›å¤æ ¼å¼**ï¼š
```
^æ¬¢è¿:[ID]æ˜µç§°
^æ¬¢è¿:[ID]æ˜µç§°
...
^åˆ·æ–°å®Œæˆ
```

**F5BotV2 æºç **ï¼š
```csharp
// Line 2613-2708
private int LexicalAdminåˆ·æ–°(BoterWxGroupMessage msgpack)
{
    if (msgpack.msg.Replace(" ", "") == "åˆ·æ–°")
    {
        Subåˆ·æ–°(msgpack.room_wxid);
        wxHelper.CallSendText_11036(msgpack.room_wxid, $"^åˆ·æ–°å®Œæˆ");
    }
    return response;
}

private void Subåˆ·æ–°(string room_wxid)
{
    var wret = wxHelper.wxServices.GetMemberList(room_wxid);
    // éå†æˆå‘˜
    foreach (var mem in memarry)
    {
        var memonline = v2Memberbindlite.FirstOrDefault(p => p.wxid == mem);
        if (memonline == null)
        {
            // æ–°æˆå‘˜ï¼Œæ·»åŠ åˆ°æ•°æ®åº“
            v2Memberbindlite.Add(room_wxid, new V2Member(m), ...);
            
            // å›å¤æ¬¢è¿æ¶ˆæ¯
            wxHelper.CallSendText_11036(room_wxid, $"^æ¬¢è¿:[{memok.id}]{m.nickname}");
        }
    }
}
```

---

### 2. ç®¡ç†ä¸Šä¸‹åˆ†å‘½ä»¤

#### æ ¼å¼1ï¼š@æ˜µç§° ä¸Š/ä¸‹é‡‘é¢

**è§¦å‘æ¡ä»¶**ï¼š
```regex
@([^ ]+).(ä¸Š|ä¸‹){1}(\d+)(.*)
```

**ç¤ºä¾‹**ï¼š
```
@é£æ‰¬ğŸ  ä¸Š10000
@å°æ˜ ä¸‹500
```

**åŠŸèƒ½**ï¼š
1. è§£ææ˜µç§°ã€åŠ¨ä½œï¼ˆä¸Š/ä¸‹ï¼‰ã€é‡‘é¢
2. æ ¹æ®æ˜µç§°æŸ¥æ‰¾ä¼šå‘˜ï¼ˆå¦‚æœé‡åæˆ–ä¸å­˜åœ¨ï¼Œè¿”å›è­¦å‘Šï¼‰
3. åˆ›å»ºä¸Šä¸‹åˆ†è®¢å•
4. æ‰§è¡Œä¸Šä¸‹åˆ†æ“ä½œ
5. å›å¤æ“ä½œç»“æœ

**å›å¤æ ¼å¼**ï¼š
```
@æ˜µç§°
IDä¸Š/ä¸‹é‡‘é¢|ä½™:ä½™é¢
```

**ç¤ºä¾‹**ï¼š
```
@é£æ‰¬ğŸ 
7ä¸Š10000|ä½™:15000
```

**F5BotV2 æºç **ï¼š
```csharp
// Line 2711-2782
private int LexicalAdminä¸Šä¸‹åˆ†(BoterWxGroupMessage msgpack)
{
    string regexStr = @"@([^ ]+).(ä¸Š|ä¸‹){1}(\d+)(.*)";
    bool brgx = Regex.IsMatch(msgpack.msg, regexStr);
    if(brgx)
    {
        var ss = Regex.Match(msgpack.msg, regexStr);
        string s1 = ss.Groups[1].Value; //åå­—
        string s2 = ss.Groups[2].Value; //åŠ¨ä½œ:ä¸Š|ä¸‹
        string s3 = ss.Groups[3].Value; //é‡‘é¢
        string s4 = ss.Groups[4].Value; //å‡ºé”™çš„å­—ç¬¦
        
        // ğŸ”¥ ç‰¹æ®Šåˆ¤æ–­ï¼šå¦‚æœs4åŒ…å«"ç•™"æˆ–"ä½™"ï¼Œä¸å¤„ç†ï¼ˆé¿å…ä¸ç»“ç®—æ¶ˆæ¯å†²çªï¼‰
        if (s4.Contains("ç•™") || s4.Contains("ä½™"))
        {
            return 0;
        }
        
        // æ ¹æ®æ˜µç§°æŸ¥æ‰¾ä¼šå‘˜
        var items = v2Memberbindlite.Where(p => p.nickname == s1).ToList();
        if(items == null || items.Count == 0)
        {
            throw new Exception($"#[è­¦å‘Š]æ²¡æ‰¾åˆ°,{s1}");
        }
        if(items.Count > 1)
        {
            throw new Exception($"#[è­¦å‘Š]é‡å,{s1}");
        }
        
        // è§£æé‡‘é¢
        int money = Convert.ToInt32(s3);
        
        // æ‰§è¡Œä¸Šä¸‹åˆ†
        if(s2 == "ä¸Š")
        {
            V2MemberCoinsBuySell order = new V2MemberCoinsBuySell(items[0], ..., money, V2MemberPayAction.ä¸Šåˆ†, ...);
            order.Note = $"ç®¡ç†ç›´ä¸Š:{s1}";
            this.OnActionMemberCredit(order);
        }
        else if(s2 == "ä¸‹")
        {
            V2MemberCoinsBuySell order = new V2MemberCoinsBuySell(items[0], ..., money, V2MemberPayAction.ä¸‹åˆ†, ...);
            order.Note = $"ç®¡ç†ç›´ä¸‹:{s1}";
            this.OnActionMemberWithdraw(order);
        }
        
        // å›å¤
        wxHelper.CallSendText_11036(msgpack.room_wxid, 
            $"@{items[0].nickname}\r{items[0].id}{s2}{money}|ä½™:{items[0].Balance}");
        return 0;
    }
}
```

#### æ ¼å¼2ï¼šIDä¸Š/ä¸‹é‡‘é¢

**è§¦å‘æ¡ä»¶**ï¼š
```regex
(\d+)(ä¸Š|ä¸‹){1}(\d+)(.*)
```

**ç¤ºä¾‹**ï¼š
```
7ä¸Š1000
15ä¸‹500
```

**åŠŸèƒ½**ï¼š
1. è§£æIDã€åŠ¨ä½œï¼ˆä¸Š/ä¸‹ï¼‰ã€é‡‘é¢
2. æ ¹æ®IDæŸ¥æ‰¾ä¼šå‘˜ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼Œè¿”å›è­¦å‘Šï¼‰
3. åˆ›å»ºä¸Šä¸‹åˆ†è®¢å•
4. æ‰§è¡Œä¸Šä¸‹åˆ†æ“ä½œ
5. å›å¤æ“ä½œç»“æœ

**å›å¤æ ¼å¼**ï¼šï¼ˆä¸æ ¼å¼1ç›¸åŒï¼‰
```
@æ˜µç§°
IDä¸Š/ä¸‹é‡‘é¢|ä½™:ä½™é¢
```

**F5BotV2 æºç **ï¼š
```csharp
// Line 2784-2830
regexStr = @"(\d+)(ä¸Š|ä¸‹){1}(\d+)(.*)";
brgx = Regex.IsMatch(msgpack.msg, regexStr);
if (brgx)
{
    var ss = Regex.Match(msgpack.msg, regexStr);
    string s1 = ss.Groups[1].Value;  //ID
    string s2 = ss.Groups[2].Value;  //åŠ¨ä½œ:ä¸Š|ä¸‹
    string s3 = ss.Groups[3].Value;  //é‡‘é¢
    string s4 = ss.Groups[4].Value;
    
    // æ ¹æ®IDæŸ¥æ‰¾ä¼šå‘˜
    int id = Convert.ToInt32(s1);
    var item = v2Memberbindlite.FirstOrDefault(p=>p.id == id);
    if(item == null)
    {
        throw new Exception("#[è­¦å‘Š]IDé”™è¯¯, IDä¸å­˜åœ¨");
    }
    
    // è§£æé‡‘é¢
    int money = Convert.ToInt32(s3);
    
    // æ‰§è¡Œä¸Šä¸‹åˆ†ï¼ˆä¸æ ¼å¼1ç›¸åŒï¼‰
    if (s2 == "ä¸Š")
    {
        V2MemberCoinsBuySell order = new V2MemberCoinsBuySell(item, ..., money, V2MemberPayAction.ä¸Šåˆ†, ...);
        order.Note = $"ç®¡ç†ç›´ä¸Š:{id}";
        this.OnActionMemberCredit(order);
    }
    else if (s2 == "ä¸‹")
    {
        V2MemberCoinsBuySell order = new V2MemberCoinsBuySell(item, ..., money, V2MemberPayAction.ä¸‹åˆ†, ...);
        order.Note = $"ç®¡ç†ç›´ä¸‹:{id}";
        this.OnActionMemberWithdraw(order);
    }
    
    // å›å¤
    wxHelper.CallSendText_11036(msgpack.room_wxid, 
        $"@{item.nickname}\r{item.id}{s2}{money}|ä½™:{item.Balance}");
    return 0;
}
```

---

## ğŸ¯ å®ç°è¦æ±‚

### 1. å®Œå…¨ä¸€è‡´çš„è¡Œä¸º
- æ­£åˆ™è¡¨è¾¾å¼**å®Œå…¨ç›¸åŒ**
- å›å¤æ ¼å¼**å®Œå…¨ç›¸åŒ**ï¼ˆåŒ…æ‹¬æ¢è¡Œç¬¦ `\r`ï¼‰
- é”™è¯¯å¤„ç†**å®Œå…¨ç›¸åŒ**
- ç‰¹æ®Šåˆ¤æ–­ï¼ˆå¦‚ `s4.Contains("ç•™") || s4.Contains("ä½™")`ï¼‰**å®Œå…¨ç›¸åŒ**

### 2. æƒé™æ£€æŸ¥
åœ¨å½“å‰ç³»ç»Ÿä¸­ï¼Œä¼šå‘˜è¡¨ `V2Member` æœ‰ `State` å­—æ®µï¼š
```csharp
public enum MemberState
{
    éä¼šå‘˜ = 0,
    ä¼šå‘˜ = 1,
    ç®¡ç† = 2,
    å†»ç»“ = 3
}
```

éœ€è¦åœ¨æ¶ˆæ¯å¤„ç†é€»è¾‘ä¸­æ·»åŠ ï¼š
```csharp
if (member.State == MemberState.ç®¡ç† || fromWxid == currentUserWxid)
{
    // å¤„ç†ç®¡ç†å‘˜å‘½ä»¤
    if (HandleAdminCreditWithdrawCommand(...) != -1)
        return true;
    if (HandleAdminRefreshCommand(...) != -1)
        return true;
}
else
{
    // å¤„ç†æ™®é€šä¼šå‘˜å‘½ä»¤
    // ä¸Šä¸‹åˆ†ã€æŸ¥æµæ°´ã€æŠ•æ³¨ç­‰
}
```

### 3. å¼‚å¸¸å¤„ç†
F5BotV2 ä¸­ï¼Œå¼‚å¸¸æ¶ˆæ¯ä»¥ `#` å¼€å¤´è¡¨ç¤ºå·²å¤„ç†çš„å¼‚å¸¸ï¼š
```csharp
throw new Exception("#[è­¦å‘Š]æ²¡æ‰¾åˆ°,{s1}");
throw new Exception("#[è­¦å‘Š]é‡å,{s1}");
throw new Exception("#[è­¦å‘Š]é‡‘é¢é”™è¯¯");
throw new Exception("#[è­¦å‘Š]IDé”™è¯¯, IDä¸å­˜åœ¨");
```

åœ¨æ•è·å¼‚å¸¸åï¼Œç›´æ¥è¾“å‡ºå¼‚å¸¸æ¶ˆæ¯ï¼ˆå»é™¤ `#` åï¼‰ã€‚

---

## ğŸ“ å®ç°ä½ç½®

### å»ºè®®çš„æ–‡ä»¶ç»“æ„

**`BaiShengVx3Plus/Services/Messages/Handlers/AdminCommandHandler.cs`**ï¼ˆæ–°å»ºï¼‰
```csharp
public class AdminCommandHandler
{
    // åˆ·æ–°å‘½ä»¤
    public async Task<(int code, string? replyMessage)> HandleRefreshCommand(string groupWxid, ...);
    
    // ç®¡ç†ä¸Šä¸‹åˆ†å‘½ä»¤ï¼ˆæ ¼å¼1å’Œæ ¼å¼2ï¼‰
    public async Task<(int code, string? replyMessage)> HandleCreditWithdrawCommand(string groupWxid, string message, ...);
}
```

### ä¿®æ”¹ç°æœ‰æ–‡ä»¶

**`BaiShengVx3Plus/Services/Games/Binggo/BinggoLotteryService.cs`**
- åœ¨ `HandleMemberMessageAsync` ä¸­æ·»åŠ ç®¡ç†å‘˜æƒé™æ£€æŸ¥
- è°ƒç”¨ `AdminCommandHandler` çš„æ–¹æ³•å¤„ç†ç®¡ç†å‘˜å‘½ä»¤

---

## ğŸ” å…³é”®ç»†èŠ‚

### 1. å›å¤æ ¼å¼ä¸­çš„æ¢è¡Œç¬¦
F5BotV2 ä½¿ç”¨ `\r`ï¼ˆä¸æ˜¯ `\r\n`ï¼‰ä½œä¸ºæ¢è¡Œç¬¦ï¼š
```csharp
$"@{items[0].nickname}\r{items[0].id}{s2}{money}|ä½™:{items[0].Balance}"
```

### 2. ç‰¹æ®Šåˆ¤æ–­ï¼šé¿å…ä¸ç»“ç®—æ¶ˆæ¯å†²çª
```csharp
// "@å°æ˜ ä¸Š1000ç•™" æˆ– "@å°æ˜ ä¸Š1000ä½™" ä¸å¤„ç†
if (s4.Contains("ç•™") || s4.Contains("ä½™"))
{
    return 0;
}
```

è¿™æ˜¯ä¸ºäº†é¿å…ä¸å¼€å¥–ç»“ç®—æ¶ˆæ¯ï¼ˆå¦‚"@å°æ˜ 100ç•™"ï¼‰å†²çªã€‚

### 3. ç®¡ç†ç›´ä¸Š/ç›´ä¸‹çš„å¤‡æ³¨
```csharp
order.Note = $"ç®¡ç†ç›´ä¸Š:{s1}";  // æˆ– $"ç®¡ç†ç›´ä¸Š:{id}"
order.Note = $"ç®¡ç†ç›´ä¸‹:{s1}";  // æˆ– $"ç®¡ç†ç›´ä¸‹:{id}"
```

### 4. åˆ·æ–°å‘½ä»¤çš„æ¶ˆæ¯å‰ç¼€
æ‰€æœ‰åˆ·æ–°å‘½ä»¤çš„å›å¤éƒ½ä»¥ `^` å¼€å¤´ï¼š
```
^æ¬¢è¿:[7]å°æ˜
^åˆ·æ–°å®Œæˆ
```

---

## ğŸ¯ æ€»ç»“

éœ€è¦å®ç°ï¼š
1. âœ… **åˆ·æ–°å‘½ä»¤**ï¼š`åˆ·æ–°` â†’ åˆ·æ–°ç¾¤æˆå‘˜åˆ—è¡¨
2. âœ… **ç®¡ç†ä¸Šä¸‹åˆ†ï¼ˆæ ¼å¼1ï¼‰**ï¼š`@æ˜µç§° ä¸Š/ä¸‹é‡‘é¢`
3. âœ… **ç®¡ç†ä¸Šä¸‹åˆ†ï¼ˆæ ¼å¼2ï¼‰**ï¼š`IDä¸Š/ä¸‹é‡‘é¢`
4. âœ… **æƒé™æ£€æŸ¥**ï¼š`State == ç®¡ç†` æˆ–å‘é€è€…æ˜¯è‡ªå·±
5. âœ… **å®Œå…¨ä¸€è‡´çš„å›å¤æ ¼å¼**

**è¦æ±‚**ï¼šä¸ F5BotV2 çš„å®ç°**å®Œå…¨ä¸€è‡´**ï¼ˆå­—èŠ‚çº§åˆ«ï¼‰ã€‚

