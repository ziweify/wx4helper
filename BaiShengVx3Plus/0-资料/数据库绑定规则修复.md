# æ•°æ®åº“ç»‘å®šè§„åˆ™ä¿®å¤

## ğŸ“… ä¿®å¤æ—¥æœŸ: 2025-11-06

---

## ğŸ› é—®é¢˜æè¿°

### ä¹‹å‰çš„é”™è¯¯ç†è§£

ä¹‹å‰é”™è¯¯åœ°è®¤ä¸ºï¼š
- âŒ ç»‘å®šç¾¤æ—¶ï¼Œåº”è¯¥åˆ›å»ºæ–°æ•°æ®åº“ `business_{groupWxid}.db`
- âŒ æ¯ä¸ªç¾¤æœ‰è‡ªå·±ç‹¬ç«‹çš„æ•°æ®åº“

**é—®é¢˜ä»£ç **ï¼ˆä¹‹å‰ï¼‰:
```csharp
// âŒ é”™è¯¯ï¼šç»‘å®šç¾¤æ—¶åˆ›å»ºæ–°æ•°æ®åº“
private async void btnBindingContacts_Click(object sender, EventArgs e)
{
    // ...
    InitializeDatabase(contact.Wxid);  // âŒ ç”¨ç¾¤IDåˆ›å»ºæ•°æ®åº“
    // ...
}
```

---

## âœ… æ­£ç¡®çš„ç†è§£

### æ­£ç¡®çš„æ•°æ®åº“å‘½åè§„åˆ™

1. **é»˜è®¤æ•°æ®åº“** `business.db`
   - ç¨‹åºå¯åŠ¨æ—¶ä½¿ç”¨
   - ç©ºçš„ï¼Œä¸å­˜å‚¨ä»»ä½•æ•°æ®

2. **å¾®ä¿¡ä¸“å±æ•°æ®åº“** `business_{UserInfo.Wxid}.db`
   - å½“è¿æ¥å¾®ä¿¡æˆåŠŸåç”Ÿæˆ
   - `{UserInfo.Wxid}` æ˜¯ç™»å½•å¾®ä¿¡çš„ wxid
   - **æ‰€æœ‰ä¸šåŠ¡æ•°æ®éƒ½å­˜å‚¨åœ¨è¿™é‡Œ**ï¼š
     - âœ… ä¼šå‘˜æ•°æ®ï¼ˆæ‰€æœ‰ç¾¤çš„ä¼šå‘˜ï¼‰
     - âœ… è®¢å•æ•°æ®ï¼ˆæ‰€æœ‰ç¾¤çš„è®¢å•ï¼‰
     - âœ… å…¶ä»–ä¸šåŠ¡æ•°æ®

3. **æ—¥å¿—æ•°æ®åº“** `logs.db`
   - å…¨å±€å…±äº«
   - æ‰€æœ‰å¾®ä¿¡è´¦å·çš„æ—¥å¿—éƒ½å­˜å‚¨åœ¨è¿™é‡Œ

---

## ğŸ”§ ä¿®å¤å†…å®¹

### 1. ä¿®æ”¹ `InitializeDatabase` æ–¹æ³•

**ä½ç½®**: `BaiShengVx3Plus/Views/VxMain.cs`

**ä¿®æ”¹å‰**:
```csharp
/// <param name="identifier">æ•°æ®åº“æ ‡è¯†ï¼Œ"default" è¡¨ç¤ºé€šç”¨æ•°æ®åº“ï¼Œç¾¤IDè¡¨ç¤ºç¾¤ä¸“å±æ•°æ®åº“</param>
private void InitializeDatabase(string identifier)
{
    // ...
    string dbPath = identifier == "default" 
        ? Path.Combine("Data", "business.db")  // é€šç”¨æ•°æ®åº“
        : Path.Combine("Data", $"business_{identifier}.db");  // ç¾¤ä¸“å±æ•°æ®åº“ âŒ
    
    // ...
    string groupWxId = identifier == "default" ? "" : identifier;  // âŒ
    _membersBindingList = new V2MemberBindingList(_db, groupWxId);
    // ...
}
```

**ä¿®æ”¹å**:
```csharp
/// <param name="wxid">å¾®ä¿¡IDï¼Œ"default" è¡¨ç¤ºé»˜è®¤ç©ºæ•°æ®åº“ï¼Œå…¶ä»–ä¸ºå®é™…å¾®ä¿¡ID</param>
private void InitializeDatabase(string wxid)
{
    // ğŸ”¥ æ•°æ®åº“å‘½åè§„åˆ™ï¼š
    // - default â†’ business.dbï¼ˆç©ºæ•°æ®åº“ï¼‰
    // - wxid_xxx â†’ business_wxid_xxx.dbï¼ˆå¾®ä¿¡ä¸“å±æ•°æ®åº“ï¼Œå­˜å‚¨æ‰€æœ‰ä¸šåŠ¡æ•°æ®ï¼‰
    string dbPath = wxid == "default" 
        ? Path.Combine("Data", "business.db")           // é»˜è®¤ç©ºæ•°æ®åº“
        : Path.Combine("Data", $"business_{wxid}.db");  // å¾®ä¿¡ä¸“å±æ•°æ®åº“ âœ…
        
    _logService.Info("VxMain", $"åˆå§‹åŒ–æ•°æ®åº“: {dbPath}");
    
    // ğŸ”¥ åˆ›å»º ORM æ•°æ®åº“è¿æ¥
    _db = new SQLiteConnection(dbPath);
    
    // âš ï¸ æ³¨æ„ï¼šè¿™é‡Œä¸ä¼  groupWxIdï¼Œå› ä¸ºä¼šå‘˜æ•°æ®å±äºå½“å‰å¾®ä¿¡ï¼Œä¸åŒºåˆ†ç¾¤
    _membersBindingList = new V2MemberBindingList(_db, "");  // âœ… ç©ºå­—ç¬¦ä¸²è¡¨ç¤ºåŠ è½½æ‰€æœ‰ä¼šå‘˜
    _ordersBindingList = new V2OrderBindingList(_db);
    // ...
}
```

---

### 2. ä¿®æ”¹ `btnBindingContacts_Click` æ–¹æ³•

**ä½ç½®**: `BaiShengVx3Plus/Views/VxMain.cs`

**ä¿®æ”¹å‰**:
```csharp
private async void btnBindingContacts_Click(object sender, EventArgs e)
{
    // ...
    
    // âŒ é”™è¯¯ï¼šç»‘å®šç¾¤æ—¶åˆ›å»ºæ–°æ•°æ®åº“
    InitializeDatabase(contact.Wxid);
    
    // ...
}
```

**ä¿®æ”¹å**:
```csharp
private async void btnBindingContacts_Click(object sender, EventArgs e)
{
    // ä¿å­˜ç»‘å®šçš„ç¾¤ç»„
    _currentBoundContact = contact;
    
    // ğŸ”¥ æ¸…ç©ºå½“å‰ä¼šå‘˜å’Œè®¢å•åˆ—è¡¨ï¼ˆä¸åˆ›å»ºæ–°æ•°æ®åº“ï¼ï¼‰
    // âš ï¸ é‡è¦ï¼šæ•°æ®åº“å·²ç»åœ¨ç™»å½•æ—¶åˆå§‹åŒ–ä¸º business_{UserInfo.Wxid}.db
    // æ‰€æœ‰ä¼šå‘˜å’Œè®¢å•æ•°æ®éƒ½å­˜å‚¨åœ¨å½“å‰å¾®ä¿¡çš„æ•°æ®åº“ä¸­
    // è¿™é‡Œåªéœ€è¦æ¸…ç©ºåˆ—è¡¨ï¼Œå‡†å¤‡åŠ è½½æ–°ç¾¤çš„æˆå‘˜æ•°æ®
    UpdateUIThreadSafe(() =>
    {
        _membersBindingList?.Clear();
        _ordersBindingList?.Clear();
        UpdateStatistics();
    });
    
    // ğŸ”¥ è·å–ç¾¤æˆå‘˜
    var result = await _socketClient.SendAsync<JsonDocument>("GetGroupContacts", contact.Wxid);
    
    // ğŸ”¥ åŠ è½½åˆ°ä¼šå‘˜è¡¨ï¼ˆè‡ªåŠ¨ä¿å­˜åˆ° business_{UserInfo.Wxid}.dbï¼‰
    await LoadGroupMembersToDataGridAsync(result.RootElement, contact.Wxid);
}
```

---

### 3. å®Œå–„ `UserInfoService_UserInfoUpdated` æ–¹æ³•

**ä½ç½®**: `BaiShengVx3Plus/Views/VxMain.cs`

**ä¿®æ”¹å**:
```csharp
private async void UserInfoService_UserInfoUpdated(object? sender, UserInfoUpdatedEventArgs e)
{
    // ğŸ”¥ æ£€æµ‹ç”¨æˆ·åˆ‡æ¢
    bool isUserChanged = false;
    if (_currentUserInfo != null && !string.IsNullOrEmpty(_currentUserInfo.Wxid))
    {
        if (_currentUserInfo.Wxid != e.UserInfo.Wxid)
        {
            isUserChanged = true;
            _logService.Warning("VxMain", 
                $"âš ï¸ æ£€æµ‹åˆ°ç”¨æˆ·åˆ‡æ¢: {_currentUserInfo.Wxid} â†’ {e.UserInfo.Wxid}ï¼Œå‡†å¤‡é‡æ–°ç»‘å®šæ•°æ®åº“...");
            
            // æ¸…ç©ºè”ç³»äººåˆ—è¡¨å’Œç»‘å®šä¿¡æ¯
            UpdateUIThreadSafe(() =>
            {
                _contactsBindingList.Clear();
                _currentBoundContact = null;
                txtCurrentContact.Text = "æœªç»‘å®š";
                txtCurrentContact.FillColor = Color.White;
                txtCurrentContact.RectColor = Color.Silver;
            });
        }
    }
    
    // æ›´æ–°å½“å‰ç”¨æˆ·ä¿¡æ¯
    _currentUserInfo = e.UserInfo;
    
    // ğŸ”¥ é‡æ–°ç»‘å®šæ•°æ®åº“ï¼ˆå¾®ä¿¡ä¸“å±æ•°æ®åº“ï¼šbusiness_{wxid}.dbï¼‰
    // âš ï¸ é‡è¦ï¼šåªè¦ wxid æœ‰æ•ˆï¼Œå°±é‡æ–°ç»‘å®šæ•°æ®åº“
    // è¿™æ ·å¯ä»¥ç¡®ä¿ç”¨æˆ·åˆ‡æ¢åï¼Œæ•°æ®åº“ä¹Ÿæ­£ç¡®åˆ‡æ¢
    if (!string.IsNullOrEmpty(e.UserInfo.Wxid))
    {
        _logService.Info("VxMain", 
            isUserChanged 
                ? $"ğŸ”„ ç”¨æˆ·åˆ‡æ¢ï¼Œé‡æ–°ç»‘å®šæ•°æ®åº“: business_{e.UserInfo.Wxid}.db"
                : $"ğŸ“‚ åˆå§‹åŒ–æ•°æ®åº“: business_{e.UserInfo.Wxid}.db");
        
        InitializeDatabase(e.UserInfo.Wxid);  // âœ… ä½¿ç”¨ UserInfo.Wxid
    }
    else
    {
        _logService.Warning("VxMain", "âš ï¸ UserInfo.Wxid ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤æ•°æ®åº“");
        InitializeDatabase("unknown");
    }
    
    // ...
}
```

---

## ğŸ“Š æ•°æ®æµç¨‹å›¾

### æ­£ç¡®çš„æ•°æ®æµç¨‹

```
ç¨‹åºå¯åŠ¨
    â†“
åŠ è½½ business.dbï¼ˆç©ºï¼‰
    â†“
å¾®ä¿¡ç™»å½•æˆåŠŸ
    â†“
æ”¶åˆ° UserInfoï¼ˆwxid: wxid_abc123ï¼‰
    â†“
InitializeDatabase("wxid_abc123")
    â†“
åˆ›å»º/åŠ è½½ business_wxid_abc123.db
    â†“
ç»‘å®šç¾¤ç»„ï¼ˆgroupWxid: 12345@chatroomï¼‰
    â†“
æ¸…ç©ºä¼šå‘˜è¡¨å’Œè®¢å•è¡¨ï¼ˆUIæ˜¾ç¤ºï¼‰
    â†“
GetGroupContacts("12345@chatroom")
    â†“
åŠ è½½ç¾¤æˆå‘˜åˆ°ä¼šå‘˜è¡¨
    â†“
ä¿å­˜åˆ° business_wxid_abc123.dbï¼ˆGroupWxId = "12345@chatroom"ï¼‰
    â†“
ç»‘å®šå¦ä¸€ä¸ªç¾¤ï¼ˆgroupWxid: 67890@chatroomï¼‰
    â†“
æ¸…ç©ºä¼šå‘˜è¡¨å’Œè®¢å•è¡¨ï¼ˆUIæ˜¾ç¤ºï¼‰
    â†“
GetGroupContacts("67890@chatroom")
    â†“
åŠ è½½ç¾¤æˆå‘˜åˆ°ä¼šå‘˜è¡¨
    â†“
ä¿å­˜åˆ° business_wxid_abc123.dbï¼ˆGroupWxId = "67890@chatroom"ï¼‰
```

**å…³é”®ç‚¹**:
- âœ… å§‹ç»ˆä½¿ç”¨ `business_wxid_abc123.db`
- âœ… ä¸åŒç¾¤çš„ä¼šå‘˜é€šè¿‡ `GroupWxId` å­—æ®µåŒºåˆ†
- âœ… åˆ‡æ¢ç¾¤æ—¶åªéœ€è¦æ¸…ç©ºæ˜¾ç¤ºå¹¶é‡æ–°åŠ è½½

---

### ç”¨æˆ·åˆ‡æ¢æµç¨‹

```
å½“å‰å¾®ä¿¡: wxid_abc123
    â†“
å½“å‰æ•°æ®åº“: business_wxid_abc123.db
    â†“
ç”¨æˆ·ç™»å‡º
    â†“
ç™»å½•æ–°å¾®ä¿¡ï¼ˆwxid: wxid_def456ï¼‰
    â†“
UserInfoService_UserInfoUpdated è§¦å‘
    â†“
æ£€æµ‹åˆ° wxid å˜åŒ–ï¼ˆwxid_abc123 â†’ wxid_def456ï¼‰
    â†“
æ¸…ç©ºè”ç³»äººåˆ—è¡¨å’Œç»‘å®šä¿¡æ¯
    â†“
å…³é—­æ—§æ•°æ®åº“ business_wxid_abc123.db
    â†“
InitializeDatabase("wxid_def456")
    â†“
åˆ›å»º/åŠ è½½ business_wxid_def456.db
    â†“
æ–°å¾®ä¿¡çš„ä¸šåŠ¡æ•°æ®å·²åŠ è½½
```

**å…³é”®ç‚¹**:
- âœ… è‡ªåŠ¨æ£€æµ‹ wxid å˜åŒ–
- âœ… è‡ªåŠ¨åˆ‡æ¢æ•°æ®åº“
- âœ… æ¸…ç©ºæ—§æ•°æ®æ˜¾ç¤º
- âœ… æ—¥å¿—æ•°æ®åº“ `logs.db` ä¸å˜ï¼ˆå…¨å±€å…±äº«ï¼‰

---

## ğŸ“ æ•°æ®åº“è¡¨ç»“æ„

### V2Member è¡¨ï¼ˆä¼šå‘˜è¡¨ï¼‰

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| Id | long | ä¸»é”®ï¼ˆè‡ªå¢ï¼‰ |
| **GroupWxId** | string | **ç¾¤ID**ï¼ˆç”¨äºåŒºåˆ†ä¸åŒç¾¤çš„ä¼šå‘˜ï¼‰ |
| Wxid | string | ä¼šå‘˜å¾®ä¿¡ID |
| Nickname | string | æ˜µç§° |
| Balance | float | ä½™é¢ |
| ... | ... | å…¶ä»–å­—æ®µ |

**ç¤ºä¾‹æ•°æ®**:
```
Id | GroupWxId           | Wxid         | Nickname | Balance
---+---------------------+--------------+----------+--------
1  | 12345@chatroom      | wxid_user1   | å¼ ä¸‰     | 1000
2  | 12345@chatroom      | wxid_user2   | æå››     | 2000
3  | 67890@chatroom      | wxid_user3   | ç‹äº”     | 1500
4  | 67890@chatroom      | wxid_user4   | èµµå…­     | 3000
```

**è¯´æ˜**:
- æ‰€æœ‰ç¾¤çš„ä¼šå‘˜æ•°æ®éƒ½å­˜å‚¨åœ¨åŒä¸€ä¸ªæ•°æ®åº“ä¸­
- é€šè¿‡ `GroupWxId` å­—æ®µåŒºåˆ†ä¸åŒç¾¤çš„ä¼šå‘˜
- åˆ‡æ¢ç¾¤æ—¶ï¼Œåªéœ€è¦ç­›é€‰æ˜¾ç¤ºå¯¹åº”çš„ä¼šå‘˜æ•°æ®

---

## âœ… ä¿®å¤éªŒè¯

### æµ‹è¯•åœºæ™¯1: ç»‘å®šç¾¤ç»„

1. ç™»å½•å¾®ä¿¡ï¼ˆwxid: `wxid_abc123`ï¼‰
2. æ•°æ®åº“ï¼š`business_wxid_abc123.db`ï¼ˆå·²åˆ›å»ºï¼‰
3. ç»‘å®šç¾¤ç»„1ï¼ˆgroupWxid: `12345@chatroom`ï¼‰
4. âœ… ä¸åˆ›å»ºæ–°æ•°æ®åº“
5. âœ… ä¼šå‘˜æ•°æ®ä¿å­˜åˆ° `business_wxid_abc123.db`
6. ç»‘å®šç¾¤ç»„2ï¼ˆgroupWxid: `67890@chatroom`ï¼‰
7. âœ… ä¸åˆ›å»ºæ–°æ•°æ®åº“
8. âœ… ä¼šå‘˜æ•°æ®ä¿å­˜åˆ° `business_wxid_abc123.db`

**éªŒè¯æ–¹æ³•**:
```bash
# æŸ¥çœ‹ Data ç›®å½•ï¼Œåº”è¯¥åªæœ‰ä»¥ä¸‹æ–‡ä»¶ï¼š
ls Data/
# business.db               ï¼ˆç©ºæ•°æ®åº“ï¼‰
# business_wxid_abc123.db   ï¼ˆå¾®ä¿¡ä¸“å±æ•°æ®åº“ï¼‰
# logs.db                   ï¼ˆæ—¥å¿—æ•°æ®åº“ï¼‰

# âŒ ä¸åº”è¯¥æœ‰è¿™äº›æ–‡ä»¶ï¼š
# business_12345@chatroom.db  ï¼ˆé”™è¯¯çš„ç¾¤ä¸“å±æ•°æ®åº“ï¼‰
# business_67890@chatroom.db  ï¼ˆé”™è¯¯çš„ç¾¤ä¸“å±æ•°æ®åº“ï¼‰
```

---

### æµ‹è¯•åœºæ™¯2: ç”¨æˆ·åˆ‡æ¢

1. ç™»å½•å¾®ä¿¡1ï¼ˆwxid: `wxid_abc123`ï¼‰
2. æ•°æ®åº“ï¼š`business_wxid_abc123.db`
3. ç»‘å®šç¾¤ç»„ï¼Œæ·»åŠ ä¼šå‘˜æ•°æ®
4. ç™»å‡ºå¾®ä¿¡1ï¼Œç™»å½•å¾®ä¿¡2ï¼ˆwxid: `wxid_def456`ï¼‰
5. âœ… è‡ªåŠ¨æ£€æµ‹ wxid å˜åŒ–
6. âœ… è‡ªåŠ¨åˆ‡æ¢åˆ° `business_wxid_def456.db`
7. âœ… æ¸…ç©ºè”ç³»äººåˆ—è¡¨å’Œç»‘å®šä¿¡æ¯
8. âœ… æ˜¾ç¤ºå¾®ä¿¡2çš„ä¸šåŠ¡æ•°æ®

**éªŒè¯æ–¹æ³•**:
```bash
# æŸ¥çœ‹ Data ç›®å½•ï¼Œåº”è¯¥æœ‰ä»¥ä¸‹æ–‡ä»¶ï¼š
ls Data/
# business.db                ï¼ˆç©ºæ•°æ®åº“ï¼‰
# business_wxid_abc123.db    ï¼ˆå¾®ä¿¡1çš„æ•°æ®åº“ï¼‰
# business_wxid_def456.db    ï¼ˆå¾®ä¿¡2çš„æ•°æ®åº“ï¼‰
# logs.db                    ï¼ˆæ—¥å¿—æ•°æ®åº“ï¼Œå…¨å±€å…±äº«ï¼‰
```

---

## ğŸ¯ å…³é”®æ”¹è¿›

### 1. æ•°æ®åº“å‘½åæ›´æ¸…æ™°
- âœ… `business_{UserInfo.Wxid}.db` è€Œé `business_{GroupWxid}.db`
- âœ… å‚æ•°åä» `identifier` æ”¹ä¸º `wxid`ï¼Œæ›´æ¸…æ™°

### 2. ç»‘å®šç¾¤ç»„ä¸åˆ›å»ºæ•°æ®åº“
- âœ… ç§»é™¤ `InitializeDatabase(contact.Wxid)` è°ƒç”¨
- âœ… åªæ¸…ç©ºæ˜¾ç¤ºï¼Œä¸é‡æ–°ç»‘å®šæ•°æ®åº“

### 3. ç”¨æˆ·åˆ‡æ¢è‡ªåŠ¨å¤„ç†
- âœ… æ£€æµ‹ wxid å˜åŒ–
- âœ… è‡ªåŠ¨åˆ‡æ¢æ•°æ®åº“
- âœ… æ¸…ç©ºæ—§æ•°æ®

### 4. æ—¥å¿—æ›´æ¸…æ™°
- âœ… æ˜ç¡®åŒºåˆ†"åˆå§‹åŒ–"å’Œ"ç”¨æˆ·åˆ‡æ¢"æ—¥å¿—
- âœ… è®°å½•æ•°æ®åº“è·¯å¾„

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æ•°æ®åº“å‘½åå’Œç»‘å®šè§„åˆ™.md](./æ•°æ®åº“å‘½åå’Œç»‘å®šè§„åˆ™.md) - å®Œæ•´çš„æ•°æ®åº“è§„åˆ™è¯´æ˜

---

## âœ… æ€»ç»“

### ä¿®å¤å‰ï¼ˆé”™è¯¯ï¼‰
- âŒ ç»‘å®šç¾¤æ—¶åˆ›å»ºæ–°æ•°æ®åº“ `business_{groupWxid}.db`
- âŒ æ¯ä¸ªç¾¤æœ‰ç‹¬ç«‹æ•°æ®åº“
- âŒ æ•°æ®åˆ†æ•£ï¼Œéš¾ä»¥ç®¡ç†

### ä¿®å¤åï¼ˆæ­£ç¡®ï¼‰
- âœ… å¾®ä¿¡ä¸“å±æ•°æ®åº“ `business_{UserInfo.Wxid}.db`
- âœ… æ‰€æœ‰ç¾¤çš„æ•°æ®å­˜å‚¨åœ¨åŒä¸€æ•°æ®åº“
- âœ… é€šè¿‡ `GroupWxId` å­—æ®µåŒºåˆ†
- âœ… ç”¨æˆ·åˆ‡æ¢è‡ªåŠ¨å¤„ç†
- âœ… æ—¥å¿—å…¨å±€å…±äº«

---

**âœ… æ•°æ®åº“ç»‘å®šè§„åˆ™ä¿®å¤å®Œæˆï¼**

2025-11-06

