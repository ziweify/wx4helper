# æœŸå·è®¡ç®—ä¿®å¤ - éªŒè¯æµ‹è¯•

æ—¥æœŸ: 2025-11-06
çŠ¶æ€: âœ… å·²ä¿®å¤
é—®é¢˜: æœŸå·è®¡ç®—é”™è¯¯ï¼Œå°ç›˜æ—¶é—´ç¡¬ç¼–ç 

---

## ğŸ› å‘ç°çš„é—®é¢˜

### é—®é¢˜ 1: æœŸå·è®¡ç®—é”™è¯¯

**ç”¨æˆ·åé¦ˆ**ï¼š
- æ­£ç¡®æœŸå·ï¼š`114062885`
- è®¡ç®—æœŸå·ï¼š`114062728` âŒ
- å·®å€¼ï¼š157 æœŸ
- å€’è®¡æ—¶æ˜¾ç¤ºï¼š229 åˆ†é’Ÿï¼ˆä¸åˆç†ï¼‰

**æ ¹æœ¬åŸå› **ï¼š
`GetIssueNumber` æ–¹æ³•è®¡ç®—é”™è¯¯ï¼Œç¼ºå°‘ `+ 1` é€»è¾‘

```csharp
// âŒ é”™è¯¯å®ç°
result = value % 203;  // ç¼ºå°‘ +1

// âœ… æ­£ç¡®å®ç°ï¼ˆå‚è€ƒ F5BotV2ï¼‰
result = value % 203 + 1;  // å…³é”®çš„ +1
```

### é—®é¢˜ 2: å°ç›˜æ—¶é—´ç¡¬ç¼–ç 

**ç”¨æˆ·åé¦ˆ**ï¼š
- å°ç›˜åˆ¤æ–­ä½¿ç”¨ç¡¬ç¼–ç  `-45` ç§’
- åº”è¯¥ä½¿ç”¨é…ç½®å˜é‡ `SealSecondsAhead`
- F5BotV2 ä½¿ç”¨ `reduceCloseSeconds`ï¼Œé»˜è®¤ 49 ç§’

**æ ¹æœ¬åŸå› **ï¼š
çŠ¶æ€åˆ¤æ–­ä¸­ç¡¬ç¼–ç äº† `-45`

```csharp
// âŒ é”™è¯¯å®ç°
else if (secondsToSeal > -45)

// âœ… æ­£ç¡®å®ç°ï¼ˆå‚è€ƒ F5BotV2ï¼‰
else if (secondsToSeal > -_settings.SealSecondsAhead)
```

---

## âœ… ä¿®å¤å†…å®¹

### ä¿®å¤ 1: GetCurrentIssueIdï¼ˆå®Œå…¨å‚è€ƒ F5BotV2ï¼‰

**æ–‡ä»¶**ï¼š`BaiShengVx3Plus/Helpers/BinggoTimeHelper.cs`

**å…³é”®æ”¹è¿›**ï¼š
1. ä½¿ç”¨ `GetIssueOpenTimestamp` è·å–æ—¶é—´æˆ³
2. æ¯”è¾ƒé€»è¾‘ï¼š`currentTime > issueTime`ï¼ˆä¸æ˜¯ `>=`ï¼‰
3. ç¡®ä¿ä¸ F5BotV2 å®Œå…¨ä¸€è‡´

```csharp
public static int GetCurrentIssueId(DateTime? time = null)
{
    var currentTime = time ?? DateTime.Now;
    var firstTime = DateTimeOffset.FromUnixTimeSeconds(FIRST_TIMESTAMP).LocalDateTime;
    
    // è®¡ç®—å¤©æ•°å·®
    var timeSpan = currentTime - firstTime;
    var days = timeSpan.Days;
    
    // å½“å¤©çš„åŸºç¡€æœŸå·
    int baseDayIssueId = FIRST_ISSUE_ID + days * ISSUES_PER_DAY;
    
    // ğŸ”¥ å…³é”®ï¼šè®¡ç®—å½“å¤©å·²ç»è¿‡äº†å¤šå°‘æœŸ
    int issueCount = 0;
    for (int i = 0; i < ISSUES_PER_DAY; i++)
    {
        var issueTimestamp = GetIssueOpenTimestamp(baseDayIssueId + i);
        var issueTime = DateTimeOffset.FromUnixTimeSeconds(issueTimestamp).LocalDateTime;
        
        // ğŸ”¥ å…³é”®åˆ¤æ–­ï¼šå¦‚æœå½“å‰æ—¶é—´ > è¯¥æœŸå¼€å¥–æ—¶é—´ï¼Œè¯´æ˜è¯¥æœŸå·²è¿‡
        if (currentTime > issueTime)
        {
            issueCount++;
        }
        else
        {
            break;
        }
    }
    
    return baseDayIssueId + issueCount;
}
```

### ä¿®å¤ 2: GetIssueNumberï¼ˆå®Œå…¨å‚è€ƒ F5BotV2ï¼‰

**å…³é”®æ”¹è¿›**ï¼šæ·»åŠ  `+ 1` é€»è¾‘

```csharp
private static int GetIssueNumber(int issueId)
{
    int result = 0;
    int value = issueId - FIRST_ISSUE_ID;
    
    if (value >= 0)
    {
        // ğŸ”¥ å…³é”®ï¼šresult = value % 203 + 1
        // ä¾‹å¦‚ï¼švalue = 0, result = 1 (ç¬¬1æœŸ)
        //      value = 202, result = 203 (ç¬¬203æœŸ)
        //      value = 203, result = 1 (ç¬¬2å¤©ç¬¬1æœŸ)
        result = value % ISSUES_PER_DAY + 1;
    }
    else
    {
        // å¤„ç†è´Ÿæ•°ï¼ˆå†å²æœŸå·ï¼‰
        result = value % ISSUES_PER_DAY + 1;
        result = ISSUES_PER_DAY - Math.Abs(result);
    }
    
    return result;
}
```

**éªŒè¯**ï¼š
```
æœŸå· 114000001: ç¬¬ 1 æœŸï¼ˆç¬¬1å¤©ç¬¬1æœŸï¼‰
æœŸå· 114000203: ç¬¬ 203 æœŸï¼ˆç¬¬1å¤©ç¬¬203æœŸï¼‰
æœŸå· 114000204: ç¬¬ 1 æœŸï¼ˆç¬¬2å¤©ç¬¬1æœŸï¼‰
æœŸå· 114062885: ç¬¬ ? æœŸï¼ˆéœ€è¦éªŒè¯ï¼‰
```

è®¡ç®—ï¼š
```
value = 114062885 - 114000001 = 62884
days = 62884 / 203 = 309 å¤©
number = 62884 % 203 + 1 = 170 + 1 = 171ï¼ˆç¬¬171æœŸï¼‰
```

### ä¿®å¤ 3: GetIssueOpenTimestampï¼ˆæ–°å¢ï¼‰

**å‚è€ƒ F5BotV2 çš„ `getOpenTimestamp` æ–¹æ³•**

```csharp
public static long GetIssueOpenTimestamp(int issueId)
{
    var firstTime = DateTimeOffset.FromUnixTimeSeconds(FIRST_TIMESTAMP).LocalDateTime;
    
    // è®¡ç®—å¤©æ•°å·®
    int days = GetDaysDiff(issueId);
    
    // è®¡ç®—å½“å¤©ç¬¬å‡ æœŸï¼ˆ1-203ï¼‰
    int number = GetIssueNumber(issueId);
    
    // è®¡ç®—å¼€å¥–æ—¶é—´
    var nowDay = firstTime.AddDays(days);
    var openTime = nowDay.AddMinutes(MINUTES_PER_ISSUE * (number - 1));
    
    // è½¬æ¢ä¸º Unix æ—¶é—´æˆ³
    return new DateTimeOffset(openTime).ToUnixTimeSeconds();
}
```

### ä¿®å¤ 4: å°ç›˜æ—¶é—´é…ç½®åŒ–

**æ–‡ä»¶**ï¼š`BaiShengVx3Plus/Models/Games/Binggo/BinggoGameSettings.cs`

```csharp
/// <summary>
/// æå‰å°ç›˜ç§’æ•°ï¼ˆå‚è€ƒ F5BotV2: reduceCloseSecondsï¼Œé»˜è®¤ 49 ç§’ï¼‰
/// </summary>
public int SealSecondsAhead { get; set; } = 49;
```

**æ–‡ä»¶**ï¼š`BaiShengVx3Plus/Services/Games/Binggo/BinggoLotteryService.cs`

```csharp
// âŒ ä¹‹å‰ï¼šç¡¬ç¼–ç 
else if (secondsToSeal > -45)

// âœ… ç°åœ¨ï¼šé…ç½®åŒ–
else if (secondsToSeal > -_settings.SealSecondsAhead)
```

---

## ğŸ“Š éªŒè¯æµ‹è¯•

### æµ‹è¯•ç”¨ä¾‹ 1: åŸºå‡†æœŸå·

```csharp
æœŸå·: 114000001
é¢„æœŸ: 2025-01-01 07:05:00ï¼ˆç¬¬1æœŸï¼‰

éªŒè¯ï¼š
var time = BinggoTimeHelper.GetIssueOpenTime(114000001);
// åº”è¯¥è¿”å›: 2025-01-01 07:05:00
```

### æµ‹è¯•ç”¨ä¾‹ 2: å½“å¤©æœ€åä¸€æœŸ

```csharp
æœŸå·: 114000203
é¢„æœŸ: 2025-01-01 23:55:00ï¼ˆç¬¬203æœŸï¼‰

éªŒè¯ï¼š
var time = BinggoTimeHelper.GetIssueOpenTime(114000203);
// åº”è¯¥è¿”å›: 2025-01-01 23:55:00
```

### æµ‹è¯•ç”¨ä¾‹ 3: ç¬¬äºŒå¤©ç¬¬ä¸€æœŸ

```csharp
æœŸå·: 114000204
é¢„æœŸ: 2025-01-02 07:05:00ï¼ˆç¬¬1æœŸï¼‰

éªŒè¯ï¼š
var time = BinggoTimeHelper.GetIssueOpenTime(114000204);
// åº”è¯¥è¿”å›: 2025-01-02 07:05:00
```

### æµ‹è¯•ç”¨ä¾‹ 4: ç”¨æˆ·åé¦ˆçš„æœŸå·

```csharp
æœŸå·: 114062885
é¢„æœŸ: éœ€è¦æ ¹æ®å½“å‰æ—¶é—´éªŒè¯

è®¡ç®—ï¼š
days = (114062885 - 114000001) / 203 = 309 å¤©
number = (114062885 - 114000001) % 203 + 1 = 171

å¼€å¥–æ—¶é—´ = 2025-01-01 + 309å¤© + (171-1)*5åˆ†é’Ÿ
         = 2025-11-06 + 850åˆ†é’Ÿ
         = 2025-11-06 21:10:00

éªŒè¯ï¼š
var time = BinggoTimeHelper.GetIssueOpenTime(114062885);
var issueId = BinggoTimeHelper.GetCurrentIssueId();
Console.WriteLine($"æœŸå·: {issueId}");
Console.WriteLine($"å¼€å¥–æ—¶é—´: {time}");
```

### æµ‹è¯•ç”¨ä¾‹ 5: å€’è®¡æ—¶éªŒè¯

```csharp
å‡è®¾å½“å‰æ—¶é—´: 2025-11-06 21:00:00
æœŸå·: 114062885
å¼€å¥–æ—¶é—´: 2025-11-06 21:10:00
å°ç›˜æå‰: 49 ç§’

å€’è®¡æ—¶ = 21:10:00 - 21:00:00 - 49ç§’
       = 10åˆ†é’Ÿ - 49ç§’
       = 551 ç§’

éªŒè¯ï¼š
var seconds = BinggoTimeHelper.GetSecondsToSeal(114062885, 49);
// åº”è¯¥è¿”å›: 551 ç§’
```

---

## ğŸ”¬ å¯¹æ¯”éªŒè¯

### F5BotV2 vs BaiShengVx3Plus

| æ–¹æ³• | F5BotV2 | BaiShengVx3Plus | çŠ¶æ€ |
|------|---------|----------------|------|
| è®¡ç®—æœŸå· | `getNextIssueId()` | `GetCurrentIssueId()` | âœ… |
| æœŸå· â†’ æ—¶é—´æˆ³ | `getOpenTimestamp()` | `GetIssueOpenTimestamp()` | âœ… |
| æœŸå· â†’ æ—¶é—´ | `getOpenDatetime()` | `GetIssueOpenTime()` | âœ… |
| å½“å¤©ç¬¬å‡ æœŸ | `getNumber()` | `GetIssueNumber()` | âœ… |
| å¤©æ•°å·® | `getDays()` | `GetDaysDiff()` | âœ… |
| å°ç›˜é…ç½® | `reduceCloseSeconds` | `SealSecondsAhead` | âœ… |

### å…³é”®é€»è¾‘å¯¹æ¯”

| é€»è¾‘ | F5BotV2 | BaiShengVx3Plus | åŒ¹é… |
|------|---------|----------------|------|
| åŸºå‡†æœŸå· | `114000001` | `114000001` | âœ… |
| åŸºå‡†æ—¶é—´æˆ³ | `1735686300` | `1735686300` | âœ… |
| æ¯å¤©æœŸæ•° | `203` | `203` | âœ… |
| æ¯æœŸé—´éš” | `5 åˆ†é’Ÿ` | `5 åˆ†é’Ÿ` | âœ… |
| æœŸå·è®¡ç®— | `value % 203 + 1` | `value % 203 + 1` | âœ… |
| å°ç›˜æå‰ | `49 ç§’ï¼ˆé»˜è®¤ï¼‰` | `49 ç§’ï¼ˆé»˜è®¤ï¼‰` | âœ… |

---

## ğŸš€ æµ‹è¯•æ­¥éª¤

### 1. ç¼–è¯‘é¡¹ç›®

```bash
cd D:\gitcode\wx4helper\BaiShengVx3Plus
dotnet build
```

### 2. è¿è¡Œæµ‹è¯•

```bash
dotnet run
```

### 3. è§‚å¯Ÿè¾“å‡º

**é¢„æœŸçœ‹åˆ°**ï¼š
```
âœ… åˆå§‹åŒ–å½“å‰æœŸå·: 114062885ï¼ˆæˆ–å½“å‰æ­£ç¡®æœŸå·ï¼‰
âœ… è·ç¦»å°ç›˜: X ç§’ï¼ˆåˆç†çš„ç§’æ•°ï¼Œä¸æ˜¯ 229 åˆ†é’Ÿï¼‰
âœ… çŠ¶æ€: å¼€ç›˜ä¸­/å³å°†å°ç›˜/å°ç›˜ä¸­/ç­‰å¾…ä¸­
```

### 4. éªŒè¯æœŸå·

**æ‰‹åŠ¨éªŒè¯**ï¼š
```csharp
var now = DateTime.Now;
var issueId = BinggoTimeHelper.GetCurrentIssueId();
var openTime = BinggoTimeHelper.GetIssueOpenTime(issueId);
var seconds = BinggoTimeHelper.GetSecondsToSeal(issueId, 49);

Console.WriteLine($"å½“å‰æ—¶é—´: {now}");
Console.WriteLine($"å½“å‰æœŸå·: {issueId}");
Console.WriteLine($"å¼€å¥–æ—¶é—´: {openTime}");
Console.WriteLine($"å€’è®¡æ—¶: {seconds} ç§’");
Console.WriteLine($"å€’è®¡æ—¶: {BinggoTimeHelper.FormatCountdown(seconds)}");
```

**éªŒè¯è¦ç‚¹**ï¼š
1. âœ… æœŸå·ä¸å®é™…æœŸå·ä¸€è‡´
2. âœ… å¼€å¥–æ—¶é—´æ˜¯ 5 åˆ†é’Ÿé—´éš”
3. âœ… å€’è®¡æ—¶åœ¨ 0-300 ç§’èŒƒå›´
4. âœ… å€’è®¡æ—¶é€’å‡æµç•…

---

## ğŸ“‹ æ£€æŸ¥æ¸…å•

### æœŸå·è®¡ç®—

- [ ] å½“å‰æœŸå·ä¸å®é™…ä¸€è‡´
- [ ] å¼€å¥–æ—¶é—´æ­£ç¡®ï¼ˆ5åˆ†é’Ÿé—´éš”ï¼‰
- [ ] å¤©æ•°è®¡ç®—æ­£ç¡®
- [ ] æœŸå·åºå·æ­£ç¡®ï¼ˆ1-203ï¼‰

### å€’è®¡æ—¶è®¡ç®—

- [ ] å€’è®¡æ—¶åœ¨åˆç†èŒƒå›´ï¼ˆ0-300ç§’ï¼‰
- [ ] å€’è®¡æ—¶æ¯ç§’é€’å‡
- [ ] å°ç›˜æ—¶é—´å¯é…ç½®
- [ ] çŠ¶æ€åˆ‡æ¢æ­£å¸¸

### é…ç½®éªŒè¯

- [ ] `SealSecondsAhead` å¯ä¿®æ”¹
- [ ] ä¿®æ”¹åç«‹å³ç”Ÿæ•ˆ
- [ ] çŠ¶æ€åˆ¤æ–­ä½¿ç”¨é…ç½®å€¼
- [ ] æ— ç¡¬ç¼–ç å€¼

---

## ğŸ¯ ä¿®å¤æ€»ç»“

### æ ¸å¿ƒé—®é¢˜

1. âœ… **æœŸå·è®¡ç®—** - `GetIssueNumber` ç¼ºå°‘ `+ 1`
2. âœ… **å°ç›˜æ—¶é—´** - ç¡¬ç¼–ç  `-45` æ”¹ä¸ºé…ç½® `_settings.SealSecondsAhead`

### å‚è€ƒæ ‡å‡†

- âœ… å®Œå…¨å‚è€ƒ F5BotV2 çš„å®ç°
- âœ… ç®—æ³•é€»è¾‘å®Œå…¨ä¸€è‡´
- âœ… å˜é‡åå’Œæ³¨é‡Šæ¸…æ™°

### ä»£ç è´¨é‡

- âœ… æ³¨é‡Šè¯¦ç»†ï¼Œè¯´æ˜å‚è€ƒæ¥æº
- âœ… å˜é‡å‘½åæ¸…æ™°
- âœ… é€»è¾‘æ˜“äºç†è§£
- âœ… æ˜“äºç»´æŠ¤

---

## ğŸ”§ åç»­ä¼˜åŒ–

### å»ºè®® 1: æ·»åŠ å¿«é€Ÿè®¾ç½®é¢æ¿

åœ¨ `pnl_fastsetting` ä¸­æ·»åŠ ï¼š
- å°ç›˜æå‰ç§’æ•°è®¾ç½®
- æœ€å°/æœ€å¤§æŠ•æ³¨è®¾ç½®
- èµ”ç‡è®¾ç½®

### å»ºè®® 2: æ·»åŠ æœŸå·éªŒè¯å·¥å…·

```csharp
public static bool ValidateIssueId(int issueId)
{
    var openTime = GetIssueOpenTime(issueId);
    var calculatedId = GetCurrentIssueId(openTime);
    return issueId == calculatedId;
}
```

### å»ºè®® 3: æ·»åŠ è°ƒè¯•æ—¥å¿—

```csharp
_logService.Info("BinggoTimeHelper", 
    $"æœŸå·: {issueId}, å¤©æ•°: {days}, åºå·: {number}, å¼€å¥–: {openTime}");
```

---

## âœ… éªŒè¯ç»“æœ

ä¿®å¤åï¼ŒæœŸå·è®¡ç®—åº”è¯¥ï¼š
- âœ… ä¸å®é™…æœŸå·ä¸€è‡´
- âœ… å€’è®¡æ—¶åˆç†ï¼ˆ0-300ç§’ï¼‰
- âœ… çŠ¶æ€åˆ‡æ¢æ­£å¸¸
- âœ… å°ç›˜æ—¶é—´å¯é…ç½®

**ç°åœ¨å¯ä»¥æµ‹è¯•éªŒè¯äº†ï¼** ğŸš€

