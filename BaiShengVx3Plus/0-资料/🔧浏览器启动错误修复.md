# ğŸ”§ æµè§ˆå™¨å¯åŠ¨é”™è¯¯ä¿®å¤

## ğŸ“… ä¿®å¤æ—¶é—´

2025-11-08

## ğŸ› é—®é¢˜æè¿°

### é”™è¯¯æ—¥å¿—

```
2025-11-08 07:56:18.889  é”™è¯¯  AutoBet      å¯åŠ¨æµè§ˆå™¨å¤±è´¥: 1
2025-11-08 07:56:18.889  é”™è¯¯  VxMain       å¯åŠ¨æµè§ˆå™¨å¤±è´¥
2025-11-08 07:56:18.902  é”™è¯¯  AutoBetServer å¤„ç†å®¢æˆ·ç«¯è¿æ¥å¤±è´¥ (é…ç½®ID: 1)
2025-11-08 07:56:18.903  ä¿¡æ¯  AutoBetServer âŒ é…ç½® 1 è¿æ¥å·²å…³é—­
```

### æ ¹æœ¬åŸå› 

**æ¶æ„ä¸åŒ¹é…**ï¼š`BrowserClient.StartAsync` æ–¹æ³•çš„é€»è¾‘ä¸æ–°çš„ Socket æ¶æ„ä¸åŒ¹é…ã€‚

#### æ—§é€»è¾‘ï¼ˆé”™è¯¯ï¼‰

```csharp
public async Task<bool> StartAsync(int port, string platform, string platformUrl)
{
    // 1. å¯åŠ¨æµè§ˆå™¨è¿›ç¨‹
    _process.Start();
    
    // 2. ç­‰å¾…2ç§’
    await Task.Delay(2000);
    
    // 3. ä¸»åŠ¨è¿æ¥åˆ°æµè§ˆå™¨çš„ Socketï¼ˆâŒ é”™è¯¯ï¼ï¼‰
    _socket = new TcpClient();
    await _socket.ConnectAsync("127.0.0.1", port);  // âŒ æµè§ˆå™¨ä¸åœ¨ç›‘å¬è¿™ä¸ªç«¯å£
    
    return true;
}
```

**é—®é¢˜**ï¼š
1. æµè§ˆå™¨å¯åŠ¨åä¸ä¼šç›‘å¬ä»»ä½•ç«¯å£
2. VxMain å°è¯•è¿æ¥åˆ°ä¸€ä¸ªä¸å­˜åœ¨çš„ Socket æœåŠ¡å™¨
3. è¿æ¥å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼Œè¿”å› `false`ï¼ˆå®é™…ä¸Šä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œè¢« catch åé‡æ–° throwï¼‰

#### æ–°æ¶æ„ï¼ˆæ­£ç¡®ï¼‰

åœ¨æ–°çš„æ¶æ„ä¸­ï¼š
- **VxMain** è¿è¡Œ `AutoBetSocketServer`ï¼Œç›‘å¬å›ºå®šç«¯å£ **19527**
- **BsBrowserClient** å¯åŠ¨åï¼Œä¸»åŠ¨è¿æ¥åˆ° `127.0.0.1:19527`
- **BsBrowserClient** å‘é€æ¡æ‰‹æ¶ˆæ¯ï¼ˆåŒ…å« `configId`ï¼‰
- **VxMain** çš„ `OnBrowserConnected` å›è°ƒè¢«è§¦å‘
- **VxMain** è°ƒç”¨ `BrowserClient.AttachConnection(socket)` é™„åŠ è¿æ¥

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®æ”¹ `BrowserClient.StartAsync` æ–¹æ³•

**æ–‡ä»¶**ï¼š`BaiShengVx3Plus/Services/AutoBet/BrowserClient.cs`

**ä¿®æ”¹å‰**ï¼š
```csharp
public async Task<bool> StartAsync(int port, string platform, string platformUrl)
{
    try
    {
        // 1. å¯åŠ¨æµè§ˆå™¨è¿›ç¨‹
        _process = new Process { /* ... */ };
        _process.Start();
        
        // 2. ç­‰å¾…ä¸€ä¸‹è®©æµè§ˆå™¨å¯åŠ¨
        await Task.Delay(2000);
        
        // 3. è¿æ¥ Socket âŒ é”™è¯¯ï¼æµè§ˆå™¨ä¸åœ¨ç›‘å¬
        _socket = new TcpClient();
        await _socket.ConnectAsync("127.0.0.1", port);
        
        var stream = _socket.GetStream();
        _reader = new StreamReader(stream, Encoding.UTF8);
        _writer = new StreamWriter(stream, Encoding.UTF8) { AutoFlush = true };
        
        return true;
    }
    catch (Exception)
    {
        Dispose();
        throw;
    }
}
```

**ä¿®æ”¹å**ï¼š
```csharp
public async Task<bool> StartAsync(int port, string platform, string platformUrl)
{
    try
    {
        // 1. å¯åŠ¨æµè§ˆå™¨è¿›ç¨‹
        var browserDirectory = Path.Combine(
            AppDomain.CurrentDomain.BaseDirectory,
            "BrowserClient");
        
        var browserExePath = Path.Combine(browserDirectory, "BsBrowserClient.exe");
        
        if (!File.Exists(browserExePath))
        {
            throw new FileNotFoundException($"æµè§ˆå™¨ç¨‹åºä¸å­˜åœ¨: {browserExePath}");
        }
        
        _process = new Process
        {
            StartInfo = new ProcessStartInfo
            {
                FileName = browserExePath,
                Arguments = $"--config-id {_configId} --port {port} --platform {platform} --url {platformUrl}",
                WorkingDirectory = browserDirectory,
                UseShellExecute = false,
                CreateNoWindow = false
            }
        };
        
        _process.Start();
        
        // 2. ç­‰å¾…è¿›ç¨‹å¯åŠ¨ï¼ˆæµè§ˆå™¨ä¼šä¸»åŠ¨è¿æ¥åˆ° VxMain:19527ï¼‰
        await Task.Delay(1000);
        
        // 3. æ£€æŸ¥è¿›ç¨‹æ˜¯å¦æˆåŠŸå¯åŠ¨
        if (_process.HasExited)
        {
            throw new Exception($"æµè§ˆå™¨è¿›ç¨‹å¯åŠ¨å¤±è´¥ï¼Œé€€å‡ºä»£ç : {_process.ExitCode}");
        }
        
        // âœ… è¿›ç¨‹å¯åŠ¨æˆåŠŸï¼ŒSocket è¿æ¥ç”± AutoBetSocketServer.OnBrowserConnected å¤„ç†
        return true;
    }
    catch (Exception)
    {
        Dispose();
        throw;
    }
}
```

### å…³é”®å˜åŒ–

1. **ç§»é™¤äº† Socket è¿æ¥é€»è¾‘**
   - ä¸å†å°è¯•è¿æ¥åˆ°æµè§ˆå™¨çš„ Socket
   - æµè§ˆå™¨ä¼šä¸»åŠ¨è¿æ¥åˆ° VxMain

2. **æ·»åŠ äº†è¿›ç¨‹å¯åŠ¨æ£€æŸ¥**
   - æ£€æŸ¥ `_process.HasExited`
   - å¦‚æœè¿›ç¨‹é€€å‡ºï¼ŒæŠ›å‡ºå¼‚å¸¸å¹¶åŒ…å«é€€å‡ºä»£ç 

3. **å‡å°‘ç­‰å¾…æ—¶é—´**
   - ä» 2000ms å‡å°‘åˆ° 1000ms
   - å› ä¸ºä¸éœ€è¦ç­‰å¾… Socket è¿æ¥

## ğŸ”„ å®Œæ•´è¿æ¥æµç¨‹

### æ­£ç¡®çš„è¿æ¥å»ºç«‹æµç¨‹

```
1. VxMain å¯åŠ¨ AutoBetSocketServer
   ç›‘å¬ç«¯å£: 19527
   â†“
2. ç”¨æˆ·ç‚¹å‡»"å¯åŠ¨æµè§ˆå™¨"
   â†“
3. VxMain è°ƒç”¨ AutoBetService.StartBrowser(configId)
   â†“
4. AutoBetService åˆ›å»º BrowserClient
   â†“
5. BrowserClient.StartAsync() å¯åŠ¨è¿›ç¨‹
   âœ… åªå¯åŠ¨è¿›ç¨‹ï¼Œä¸è¿æ¥ Socket
   â†“
6. BsBrowserClient.exe å¯åŠ¨
   â†“
7. BsBrowserClient åˆå§‹åŒ–å®Œæˆ
   â†“
8. BsBrowserClient çš„ SocketServer å¯åŠ¨
   ä¸»åŠ¨è¿æ¥åˆ° 127.0.0.1:19527
   â†“
9. BsBrowserClient å‘é€æ¡æ‰‹æ¶ˆæ¯
   { type: "hello", configId: 1 }
   â†“
10. VxMain çš„ AutoBetSocketServer æ¥æ”¶è¿æ¥
    â†“
11. OnBrowserConnected(configId, socket) è¢«è°ƒç”¨
    â†“
12. AutoBetService æ‰¾åˆ°å¯¹åº”çš„ BrowserClient
    â†“
13. BrowserClient.AttachConnection(socket) é™„åŠ è¿æ¥
    âœ… Socket è¿æ¥å»ºç«‹å®Œæˆ
    â†“
14. VxMain å‘é€æ¬¢è¿æ¶ˆæ¯
    { type: "welcome", message: "æ¬¢è¿è¿æ¥" }
```

## ğŸ“Š ä¿®å¤å‰åå¯¹æ¯”

### ä¿®å¤å‰

```
VxMain.StartBrowser()
  â†“
BrowserClient.StartAsync()
  â†“
å¯åŠ¨è¿›ç¨‹
  â†“
ç­‰å¾… 2 ç§’
  â†“
å°è¯•è¿æ¥åˆ°æµè§ˆå™¨çš„ Socket âŒ å¤±è´¥ï¼
  â†“
æŠ›å‡ºå¼‚å¸¸
  â†“
è¿”å› false
  â†“
æ—¥å¿—ï¼šå¯åŠ¨æµè§ˆå™¨å¤±è´¥: 1
```

### ä¿®å¤å

```
VxMain.StartBrowser()
  â†“
BrowserClient.StartAsync()
  â†“
å¯åŠ¨è¿›ç¨‹
  â†“
ç­‰å¾… 1 ç§’
  â†“
æ£€æŸ¥è¿›ç¨‹æ˜¯å¦é€€å‡º âœ… æˆåŠŸ
  â†“
è¿”å› true
  â†“
ç­‰å¾…æµè§ˆå™¨ä¸»åŠ¨è¿æ¥...
  â†“
OnBrowserConnected() è§¦å‘
  â†“
AttachConnection() é™„åŠ è¿æ¥ âœ… æˆåŠŸ
  â†“
æ—¥å¿—ï¼šâœ… æµè§ˆå™¨ Socket è¿æ¥æˆåŠŸ
```

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### 1. é‡æ–°ç¼–è¯‘

```powershell
# 1. å…³é—­æ‰€æœ‰ VxMain å’Œ BsBrowserClient è¿›ç¨‹
taskkill /IM BaiShengVx3Plus.exe /F
taskkill /IM BsBrowserClient.exe /F

# 2. é‡æ–°ç¼–è¯‘
cd D:\gitcode\wx4helper
dotnet build BaiShengVx3Plus/BaiShengVx3Plus.csproj
```

### 2. æµ‹è¯•å¯åŠ¨æµè§ˆå™¨

```
1. å¯åŠ¨ VxMain
2. é…ç½®é»˜è®¤æŠ•æ³¨è´¦å·ï¼ˆå¿«é€Ÿè®¾ç½®é¢æ¿ï¼‰
   - å¹³å°ï¼šäº‘é¡¶
   - è´¦å·ï¼štest123
   - å¯†ç ï¼š******
3. ç‚¹å‡»"å¯åŠ¨æµè§ˆå™¨"æŒ‰é’®
4. è§‚å¯Ÿæ—¥å¿—ï¼š
   âœ… ğŸš€ å¯åŠ¨æµè§ˆå™¨: é»˜è®¤é…ç½®
   âœ… ğŸ”— æµè§ˆå™¨å·²é€šè¿‡ Socket è¿æ¥ï¼Œé…ç½®ID: 1
   âœ… âœ… æµè§ˆå™¨ Socket è¿æ¥æˆåŠŸ: é»˜è®¤é…ç½®
   âœ… âœ… é¡µé¢åŠ è½½å®Œæˆ: https://yd28.vip
   âœ… ğŸ” æ£€æµ‹é¡µé¢çŠ¶æ€ï¼Œå‡†å¤‡è‡ªåŠ¨ç™»å½•...
   âœ… ğŸ” å¼€å§‹è‡ªåŠ¨ç™»å½•: test123
   âœ… âœ… è‡ªåŠ¨ç™»å½•æˆåŠŸï¼
```

### 3. é¢„æœŸæ—¥å¿—è¾“å‡º

**VxMain ç«¯**ï¼š
```
[æ—¶é—´] [AutoBet] ğŸš€ å¯åŠ¨æµè§ˆå™¨: é»˜è®¤é…ç½®
[æ—¶é—´] [AutoBetServer] â³ ç­‰å¾…æµè§ˆå™¨è¿æ¥...
[æ—¶é—´] [AutoBetServer] ğŸ”— æµè§ˆå™¨å·²è¿æ¥ï¼Œå¤„ç†æ¡æ‰‹...
[æ—¶é—´] [AutoBetServer] âœ… æ”¶åˆ°æµè§ˆå™¨æ¡æ‰‹ï¼Œé…ç½®ID: 1
[æ—¶é—´] [AutoBet] ğŸ”— æµè§ˆå™¨å·²é€šè¿‡ Socket è¿æ¥ï¼Œé…ç½®ID: 1
[æ—¶é—´] [AutoBet] âœ… æµè§ˆå™¨ Socket è¿æ¥æˆåŠŸ: é»˜è®¤é…ç½®
[æ—¶é—´] [HTTP] ğŸ“© GET /api/config?configId=1
[æ—¶é—´] [HTTP] âœ… è¿”å›é…ç½®: é»˜è®¤é…ç½®
```

**BsBrowserClient ç«¯**ï¼š
```
[æ—¶é—´] ğŸ”— è¿æ¥åˆ° VxMain:19527
[æ—¶é—´] âœ… æ¡æ‰‹æˆåŠŸï¼Œæ”¶åˆ°æ¬¢è¿æ¶ˆæ¯
[æ—¶é—´] âœ… é¡µé¢åŠ è½½å®Œæˆ: https://yd28.vip
[æ—¶é—´] ğŸ” æ£€æµ‹é¡µé¢çŠ¶æ€ï¼Œå‡†å¤‡è‡ªåŠ¨ç™»å½•...
[æ—¶é—´] âœ… è·å–åˆ°é…ç½®: test123
[æ—¶é—´] ğŸ” å¼€å§‹è‡ªåŠ¨ç™»å½•: test123
[æ—¶é—´] [äº‘é¡¶] ğŸ” å¼€å§‹æ™ºèƒ½ç™»å½•æµç¨‹...
[æ—¶é—´] [äº‘é¡¶] æ£€æµ‹åˆ°ç™»å½•é¡µé¢ï¼Œå°è¯•è‡ªåŠ¨å¡«å……...
[æ—¶é—´] [äº‘é¡¶] âœ… ç™»å½•æˆåŠŸï¼
[æ—¶é—´] âœ… è‡ªåŠ¨ç™»å½•æˆåŠŸï¼
```

## ğŸ¯ ä¿®å¤éªŒè¯

### æˆåŠŸæ ‡å¿—

1. âœ… ç‚¹å‡»"å¯åŠ¨æµè§ˆå™¨"åï¼Œæµè§ˆå™¨çª—å£å¼¹å‡º
2. âœ… æ—¥å¿—æ˜¾ç¤º"æµè§ˆå™¨ Socket è¿æ¥æˆåŠŸ"
3. âœ… æ—¥å¿—æ˜¾ç¤º"é¡µé¢åŠ è½½å®Œæˆ"
4. âœ… æ—¥å¿—æ˜¾ç¤º"è‡ªåŠ¨ç™»å½•æˆåŠŸ"
5. âœ… æµè§ˆå™¨æ­£å¸¸æ˜¾ç¤ºç™»å½•åçš„é¡µé¢

### å¤±è´¥æ ‡å¿—ï¼ˆå¦‚æœè¿˜æœ‰é—®é¢˜ï¼‰

1. âŒ æ—¥å¿—æ˜¾ç¤º"å¯åŠ¨æµè§ˆå™¨å¤±è´¥"
   - æ£€æŸ¥ `BsBrowserClient.exe` æ˜¯å¦å­˜åœ¨
   - æ£€æŸ¥å·¥ä½œç›®å½•æ˜¯å¦æ­£ç¡®
   - æ£€æŸ¥å‘½ä»¤è¡Œå‚æ•°æ˜¯å¦æ­£ç¡®

2. âŒ æ—¥å¿—æ˜¾ç¤º"æµè§ˆå™¨è¿›ç¨‹å¯åŠ¨å¤±è´¥ï¼Œé€€å‡ºä»£ç : X"
   - æ‰‹åŠ¨è¿è¡Œ `BsBrowserClient.exe` æŸ¥çœ‹é”™è¯¯
   - æ£€æŸ¥ä¾èµ–æ–‡ä»¶ï¼ˆWebView2 è¿è¡Œæ—¶ï¼‰

3. âŒ æ—¥å¿—æ˜¾ç¤º"å¤„ç†å®¢æˆ·ç«¯è¿æ¥å¤±è´¥"
   - æ£€æŸ¥ Socket æœåŠ¡å™¨æ˜¯å¦æ­£å¸¸å¯åŠ¨
   - æ£€æŸ¥ç«¯å£ 19527 æ˜¯å¦è¢«å ç”¨
   - æ£€æŸ¥é˜²ç«å¢™è®¾ç½®

## ğŸ“ æ€»ç»“

### ä¿®å¤å†…å®¹

âœ… ä¿®æ”¹ `BrowserClient.StartAsync` æ–¹æ³•
- ç§»é™¤äº†é”™è¯¯çš„ Socket è¿æ¥é€»è¾‘
- åªè´Ÿè´£å¯åŠ¨æµè§ˆå™¨è¿›ç¨‹
- Socket è¿æ¥ç”± `AutoBetSocketServer.OnBrowserConnected` å¤„ç†

### å…³é”®ç‚¹

1. **èŒè´£åˆ†ç¦»**
   - `BrowserClient.StartAsync`ï¼šå¯åŠ¨è¿›ç¨‹
   - `AutoBetSocketServer`ï¼šç­‰å¾…è¿æ¥
   - `OnBrowserConnected`ï¼šé™„åŠ è¿æ¥

2. **è¿æ¥æ–¹å‘**
   - âŒ æ—§ï¼šVxMain â†’ BsBrowserClient
   - âœ… æ–°ï¼šBsBrowserClient â†’ VxMain

3. **çŠ¶æ€æ£€æŸ¥**
   - æ£€æŸ¥è¿›ç¨‹æ˜¯å¦æˆåŠŸå¯åŠ¨
   - æ£€æŸ¥è¿›ç¨‹é€€å‡ºä»£ç 
   - ç­‰å¾… Socket è¿æ¥å»ºç«‹

### ä¸‹ä¸€æ­¥

1. **å…³é—­åº”ç”¨**ï¼š`taskkill /IM BaiShengVx3Plus.exe /F`
2. **é‡æ–°ç¼–è¯‘**ï¼š`dotnet build`
3. **å¯åŠ¨æµ‹è¯•**ï¼šç‚¹å‡»"å¯åŠ¨æµè§ˆå™¨"
4. **è§‚å¯Ÿæ—¥å¿—**ï¼šç¡®è®¤è¿æ¥æˆåŠŸ

**ä¿®å¤å·²å®Œæˆï¼Œè¯·å…³é—­åº”ç”¨åé‡æ–°ç¼–è¯‘æµ‹è¯•ï¼** ğŸš€

