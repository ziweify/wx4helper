# é£å•å¼€å…³å…³é—­å†å¼€å¯ - è¿æ¥é—®é¢˜

## ğŸ“‹ é—®é¢˜æµç¨‹

1. **é»˜è®¤å¼€å¯é£å•** â†’ æµè§ˆå™¨å¯åŠ¨ï¼Œè¿æ¥æˆåŠŸ âœ…
2. **å…³é—­é£å•** â†’ `StopBrowser` â†’ `browserClient.Dispose()` â†’ **æµè§ˆå™¨çª—å£å…³é—­** â†’ `_browsers.Remove(configId)` â†’ `_browsers` å­—å…¸ä¸ºç©º
3. **å¼€å¯é£å•** â†’ `StartBrowser` â†’ å¯åŠ¨æ–°æµè§ˆå™¨ â†’ æµè§ˆå™¨è¿æ¥ â†’ `OnBrowserConnected` è¢«è°ƒç”¨
4. **ç™»å½•è´¦å·** â†’ è¾“å…¥è´¦å·å¯†ç  â†’ ç™»å½•æˆåŠŸ
5. **æŠ•æ³¨** â†’ é«˜çº§è®¾ç½®ä¸­ç‚¹å‡»æŠ•æ³¨ â†’ **é”™è¯¯ï¼šæœªè¿æ¥åˆ°æµè§ˆå™¨** âŒ

## ğŸ” é—®é¢˜åˆ†æ

###åœºæ™¯1ï¼š`OnBrowserConnected` æ²¡è¢«è°ƒç”¨

```
å¼€å¯é£å•:
  â”œâ”€ StartBrowser(configId=1)
  â”œâ”€ å¯åŠ¨æµè§ˆå™¨è¿›ç¨‹
  â”œâ”€ ç­‰å¾…æµè§ˆå™¨è¿æ¥ï¼ˆ6ç§’ï¼‰
  â””â”€ è¿”å› true

æµè§ˆå™¨å¯åŠ¨:
  â”œâ”€ è¿æ¥åˆ° VxMain:19527
  â”œâ”€ å‘é€æ¡æ‰‹ï¼š{ "configId": 1, "configName": "é»˜è®¤é…ç½®" }
  â””â”€ AutoBetSocketServer.HandleClientAsync
       â”œâ”€ è§£ææ¡æ‰‹æ¶ˆæ¯
       â”œâ”€ ä¿å­˜è¿æ¥åˆ° _connections[1]
       â””â”€ è°ƒç”¨ï¼š_onBrowserConnected("é»˜è®¤é…ç½®", 1)
            â””â”€ AutoBetService.OnBrowserConnected
                 â”œâ”€ æŸ¥æ‰¾é…ç½®ï¼šconfig = _configs.FirstOrDefault(c => c.ConfigName == "é»˜è®¤é…ç½®")
                 â”œâ”€ è·å–è¿æ¥ï¼šconnection = _socketServer.GetConnection(1)
                 â””â”€ åˆ›å»º BrowserClient å¹¶é™„åŠ è¿æ¥
                      â”œâ”€ _browsers[configId] = browserClient
                      â””â”€ browserClient.AttachConnection(connection)

æŠ•æ³¨:
  â”œâ”€ æŸ¥æ‰¾ _browsers[configId]
  â”œâ”€ âœ… æ‰¾åˆ° BrowserClient
  â””â”€ browserClient.SendCommandAsync("bet", data)
       â”œâ”€ æ£€æŸ¥ï¼šIsConnected
       â”‚    â””â”€ _connection != null && _connection.IsConnected
       â””â”€ âŒ è¿”å›ï¼šfalse
```

### åœºæ™¯2ï¼š`connection.IsConnected` æ˜¯ `false`

```csharp
// ClientConnection.cs
public class ClientConnection
{
    public TcpClient Client { get; set; }
    public StreamReader Reader { get; set; }
    public StreamWriter Writer { get; set; }
    public int ConfigId { get; set; }
    
    public bool IsConnected => Client != null && Client.Connected;  // â† æ£€æŸ¥è¿™ä¸ª
}
```

**å¯èƒ½çš„åŸå› **ï¼š
1. `Client.Connected` è¿”å› `false`ï¼ˆSocket å®é™…å·²æ–­å¼€ï¼‰
2. `Client` æ˜¯ `null`ï¼ˆè¿æ¥ä¸¢å¤±ï¼‰

### åœºæ™¯3ï¼šæ—¶åºé—®é¢˜

```
æ—¶åˆ» 0s: å¼€å¯é£å•
  â””â”€ StartBrowser â†’ å¯åŠ¨æµè§ˆå™¨è¿›ç¨‹ â†’ _browsers[1] = new BrowserClient(1)
  
æ—¶åˆ» 1s: æµè§ˆå™¨å¯åŠ¨
  â””â”€ è¿æ¥åˆ° VxMain â†’ OnBrowserConnected
       â””â”€ _browsers[1].AttachConnection(connection)  â† é™„åŠ è¿æ¥
  
æ—¶åˆ» 2s: ç”¨æˆ·ç™»å½•
  â””â”€ è¾“å…¥è´¦å·å¯†ç  â†’ ç™»å½•æˆåŠŸ
  
æ—¶åˆ» 3s: ç”¨æˆ·æŠ•æ³¨
  â””â”€ SendCommandAsync â†’ IsConnected
       â””â”€ æ£€æŸ¥ _connection.IsConnected
            â”œâ”€ å¦‚æœæ˜¯ trueï¼šâœ… å‘é€å‘½ä»¤
            â””â”€ å¦‚æœæ˜¯ falseï¼šâŒ è¿”å›é”™è¯¯
```

---

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šå¢å¼ºæ—¥å¿—è¾“å‡ºï¼ˆå½“å‰å·²å®ç°ï¼‰

å·²åœ¨ä»¥ä¸‹ä½ç½®æ·»åŠ è¯¦ç»†æ—¥å¿—ï¼š

1. **`BrowserClient.AttachConnection`**ï¼š
   ```csharp
   Console.WriteLine($"[BrowserClient] AttachConnection è°ƒç”¨:");
   Console.WriteLine($"  - ConfigId: {_configId}");
   Console.WriteLine($"  - ä¼ å…¥çš„ connection == null: {connection == null}");
   Console.WriteLine($"  - ä¼ å…¥çš„ connection.IsConnected: {connection?.IsConnected}");
   // ...
   Console.WriteLine($"[BrowserClient] AttachConnection å®Œæˆ:");
   Console.WriteLine($"  - _connection == null: {_connection == null}");
   Console.WriteLine($"  - _connection.IsConnected: {_connection?.IsConnected}");
   Console.WriteLine($"  - IsConnected: {IsConnected}");
   ```

2. **`BrowserClient.SendCommandAsync`**ï¼š
   ```csharp
   Console.WriteLine($"[BrowserClient] SendCommandAsync è°ƒç”¨:");
   Console.WriteLine($"  - ConfigId: {_configId}");
   Console.WriteLine($"  - _connection == null: {_connection == null}");
   Console.WriteLine($"  - _connection?.IsConnected: {_connection?.IsConnected}");
   Console.WriteLine($"  - IsConnected: {IsConnected}");
   ```

### æ–¹æ¡ˆ2ï¼šç¡®ä¿ `StartBrowserInternal` ç­‰å¾…è¿æ¥

åœ¨ `AutoBetService.StartBrowserInternal` ä¸­ï¼Œå¯åŠ¨æµè§ˆå™¨åï¼Œåº”è¯¥ç­‰å¾… `OnBrowserConnected` è¢«è°ƒç”¨ï¼Œè€Œä¸æ˜¯ä»…ä»…ç­‰å¾…è¿›ç¨‹å¯åŠ¨ã€‚

```csharp
// å½“å‰ä»£ç ï¼šå¯åŠ¨æµè§ˆå™¨åç«‹å³è¿”å›
var newBrowserClient = new BrowserClient(configId);
await newBrowserClient.StartAsync(0, config.ConfigName, config.Platform, config.PlatformUrl);

lock (_lock)
{
    _browsers[configId] = newBrowserClient;  // â† æ­¤æ—¶ _connection è¿˜æ˜¯ nullï¼
}

// ç­‰å¾…2ç§’è®©æµè§ˆå™¨è¿æ¥
await Task.Delay(2000);

// æ£€æŸ¥è¿æ¥çŠ¶æ€
var (connected, pid) = await newBrowserClient.PingAsync();
// ...
```

**é—®é¢˜**ï¼š`_browsers[configId] = newBrowserClient` æ—¶ï¼Œ`newBrowserClient._connection` è¿˜æ˜¯ `null`ï¼Œå› ä¸º `OnBrowserConnected` è¿˜æ²¡è¢«è°ƒç”¨ï¼

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. å…ˆåˆ›å»º `BrowserClient` ä½†ä¸æ·»åŠ åˆ° `_browsers`
2. ç­‰å¾… `OnBrowserConnected` è¢«è°ƒç”¨
3. `OnBrowserConnected` ä¸­æ£€æŸ¥ `_browsers` æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™æ·»åŠ 

æˆ–è€…ï¼š

1. å…ˆæ·»åŠ åˆ° `_browsers`ï¼ˆ`_connection` ä¸º `null`ï¼‰
2. `OnBrowserConnected` è¢«è°ƒç”¨æ—¶ï¼Œé™„åŠ è¿æ¥
3. æŠ•æ³¨å‰æ£€æŸ¥ `IsConnected`

**å½“å‰çš„å®ç°åº”è¯¥æ˜¯æ­£ç¡®çš„**ï¼Œå› ä¸ºï¼š
- `StartBrowserInternal` åˆ›å»º `BrowserClient` å¹¶æ·»åŠ åˆ° `_browsers`
- `OnBrowserConnected` è¢«è°ƒç”¨æ—¶ï¼Œä» `_browsers` ä¸­æ‰¾åˆ° `BrowserClient`ï¼Œç„¶åé™„åŠ è¿æ¥
- æŠ•æ³¨æ—¶ï¼Œ`IsConnected` åº”è¯¥è¿”å› `true`

### æ–¹æ¡ˆ3ï¼š`StartBrowser` ç­‰å¾…è¿æ¥æˆåŠŸ

```csharp
public async Task<bool> StartBrowser(int configId)
{
    // ... æ ‡è®°é…ç½®ä¸ºå¯ç”¨ ...
    
    // ç­‰å¾…æµè§ˆå™¨è¿æ¥ï¼ˆæœ€å¤š6ç§’ï¼‰
    for (int i = 1; i <= 6; i++)
    {
        await Task.Delay(1000);
        
        // ğŸ”¥ æ£€æŸ¥ IsConnectedï¼Œè€Œä¸ä»…ä»…æ˜¯ _browsers.ContainsKey
        bool connected;
        lock (_lock)
        {
            connected = _browsers.TryGetValue(configId, out var browser) && browser.IsConnected;
        }
        
        if (connected)
        {
            _log.Info("AutoBet", $"âœ… æµè§ˆå™¨å·²è¿æ¥ï¼ï¼ˆç­‰å¾…äº† {i} ç§’ï¼‰");
            return true;
        }
    }
    
    _log.Warning("AutoBet", $"âš ï¸ ç­‰å¾…6ç§’åæµè§ˆå™¨ä»æœªè¿æ¥");
    return false;
}
```

---

## ğŸ¯ éœ€è¦ç¡®è®¤çš„é—®é¢˜

æ ¹æ®æ—¥å¿—è¾“å‡ºï¼Œéœ€è¦ç¡®è®¤ï¼š

1. **`OnBrowserConnected` æ˜¯å¦è¢«è°ƒç”¨ï¼Ÿ**
   - å¦‚æœè¢«è°ƒç”¨ï¼Œåº”è¯¥æœ‰æ—¥å¿—ï¼š`ğŸ”— æµè§ˆå™¨å·²é€šè¿‡ Socket è¿æ¥ï¼Œé…ç½®å: é»˜è®¤é…ç½®`
   - å¦‚æœæ²¡æœ‰ï¼Œè¯´æ˜æµè§ˆå™¨æ²¡æœ‰è¿æ¥æˆåŠŸ

2. **`AttachConnection` æ˜¯å¦è¢«è°ƒç”¨ï¼Ÿ**
   - å¦‚æœè¢«è°ƒç”¨ï¼Œåº”è¯¥æœ‰æ—¥å¿—ï¼š`[BrowserClient] AttachConnection è°ƒç”¨:`
   - `connection == null` åº”è¯¥æ˜¯ `false`
   - `connection.IsConnected` åº”è¯¥æ˜¯ `true`

3. **`SendCommandAsync` è°ƒç”¨æ—¶ï¼Œ`IsConnected` çš„å€¼æ˜¯ä»€ä¹ˆï¼Ÿ**
   - å¦‚æœæ˜¯ `false`ï¼Œéœ€è¦ç¡®è®¤ï¼š
     - `_connection == null` ï¼Ÿ
     - `_connection.IsConnected == false` ï¼Ÿ

4. **`_browsers` å­—å…¸çš„çŠ¶æ€**
   - å¼€å¯é£å•åï¼Œ`_browsers` æ˜¯å¦åŒ…å« `configId`ï¼Ÿ
   - æŠ•æ³¨æ—¶ï¼Œæ˜¯å¦æ‰¾åˆ°äº† `BrowserClient`ï¼Ÿ

---

## ğŸ“ æµ‹è¯•æ­¥éª¤

1. **ç¼–è¯‘ç¨‹åº**
2. **æ¸…ç©ºæ—¥å¿—**
3. **æŒ‰ç”¨æˆ·æµç¨‹æµ‹è¯•**ï¼š
   - é»˜è®¤å¼€å¯é£å• â†’ å…³é—­é£å• â†’ å¼€å¯é£å• â†’ ç™»å½• â†’ æŠ•æ³¨
4. **æŸ¥çœ‹æ—¥å¿—è¾“å‡º**ï¼š
   - æŸ¥æ‰¾ `[BrowserClient] AttachConnection`
   - æŸ¥æ‰¾ `[BrowserClient] SendCommandAsync`
   - ç¡®è®¤ `IsConnected` çš„å€¼

---

## ğŸ”§ ä¸´æ—¶è§£å†³æ–¹æ¡ˆ

å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œå¯ä»¥æ·»åŠ æ›´è¯¦ç»†çš„æ—¥å¿—ï¼š

```csharp
// åœ¨ AutoBetService.SendCommandToBrowser ä¸­
public async Task<BetResult> SendCommandToBrowser(int configId, string command, object? data = null)
{
    _log.Info("AutoBet", $"ğŸ“¤ å°è¯•å‘é€æŠ•æ³¨å‘½ä»¤: configId={configId}");
    _log.Info("AutoBet", $"   å½“å‰ _browsers å­—å…¸åŒ…å«çš„ configId: [{string.Join(", ", _browsers.Keys)}]");
    
    if (!_browsers.TryGetValue(configId, out var browserClient))
    {
        _log.Error("AutoBet", $"âŒ æœªæ‰¾åˆ°æµè§ˆå™¨å®¢æˆ·ç«¯: configId={configId}");
        return new BetResult { Success = false, ErrorMessage = "æœªæ‰¾åˆ°æµè§ˆå™¨å®¢æˆ·ç«¯" };
    }
    
    _log.Info("AutoBet", $"âœ… æ‰¾åˆ°æµè§ˆå™¨å®¢æˆ·ç«¯: configId={configId}");
    _log.Info("AutoBet", $"   BrowserClient.IsConnected: {browserClient.IsConnected}");  // â† æ·»åŠ è¿™ä¸ª
    
    var result = await browserClient.SendCommandAsync(command, data);
    
    _log.Info("AutoBet", $"ğŸ“¥ æŠ•æ³¨ç»“æœ:é…ç½®{configId} æˆåŠŸ={result.Success}");
    
    return result;
}
```

**è¯·é‡æ–°ç¼–è¯‘å¹¶æŒ‰æµç¨‹æµ‹è¯•ï¼Œç„¶åæä¾›å®Œæ•´çš„æ—¥å¿—è¾“å‡ºï¼** ğŸ¯

