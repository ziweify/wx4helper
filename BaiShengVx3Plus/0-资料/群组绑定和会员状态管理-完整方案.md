# ç¾¤ç»„ç»‘å®šå’Œä¼šå‘˜çŠ¶æ€ç®¡ç† - å®Œæ•´æ–¹æ¡ˆ

## ğŸ“‹ éœ€æ±‚æ¦‚è¿°

### 1. **æ•°æ®åº“ç»‘å®šæœåŠ¡åŒ–**
- âœ… åˆ›å»º `IGroupBindingService` æœåŠ¡
- âœ… ç®¡ç†å½“å‰ç»‘å®šçš„ç¾¤ç»„
- âœ… ä¸€ä¸ªå¾®ä¿¡è´¦å·å¯ä»¥ç»‘å®šå¤šä¸ªä¸åŒçš„ç¾¤

### 2. **æ™ºèƒ½æ•°æ®åŠ è½½å’Œåˆå¹¶**
```
ç»‘å®šç¾¤ â†’ GetGroupContacts(ç¾¤wxid)
    â†“
å¯¹æ¯”æ•°æ®åº“ä¸­ GroupWxId == ç¾¤wxid çš„æ•°æ®
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æƒ…å†µ1: æ•°æ®åº“ä¸­å­˜åœ¨             â”‚
â”‚ â†’ åŠ è½½å¹¶ä¿ç•™ï¼ˆä¿ç•™å†å²ç»Ÿè®¡æ•°æ®ï¼‰â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æƒ…å†µ2: æ•°æ®åº“ä¸­ä¸å­˜åœ¨           â”‚
â”‚ â†’ æ–°å¢ä¼šå‘˜                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æƒ…å†µ3: æ•°æ®åº“æœ‰ä½†æœåŠ¡å™¨æ²¡è¿”å›   â”‚
â”‚ â†’ è®¾ç½®çŠ¶æ€ä¸º"å·²é€€ç¾¤"            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. **ä¼šå‘˜çŠ¶æ€èƒŒæ™¯è‰²**
| çŠ¶æ€ | æšä¸¾å€¼ | å›¾æ ‡ | èƒŒæ™¯è‰² |
|------|--------|------|--------|
| ç®¡ç† | 3 | ğŸ‘‘ | é‡‘è‰² `Color.FromArgb(255, 215, 0)` |
| æ‰˜ | 2 | ğŸ¤– | æ©™è‰² `Color.FromArgb(255, 165, 0)` |
| å·²é€€ç¾¤ | 4 | ğŸšª | ç°è‰² `Color.FromArgb(192, 192, 192)` |
| å·²åˆ é™¤ | -1 | âŒ | çº¢è‰² `Color.FromArgb(255, 99, 71)` |
| æ™®ä¼š | 5 | ğŸ‘¤ | ç™½è‰² `Color.White` |
| è“ä¼š | 6 | ğŸ’ | è“è‰² `Color.FromArgb(135, 206, 250)` |
| ç´«ä¼š | 7 | ğŸ’œ | ç´«è‰² `Color.FromArgb(221, 160, 221)` |

### 4. **åº•å±‚ä¿æŒä¸å˜**
- âœ… ä¿®æ”¹ç«‹å³ä¿å­˜ï¼ˆåŒæ­¥ä¿å­˜ï¼‰
- âœ… ORM è‡ªåŠ¨ä¿å­˜
- âœ… `INotifyPropertyChanged` è‡ªåŠ¨è§¦å‘ä¿å­˜

---

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. æœåŠ¡æ¥å£

**æ–‡ä»¶**: `BaiShengVx3Plus/Contracts/IGroupBindingService.cs`

```csharp
public interface IGroupBindingService
{
    /// <summary>å½“å‰ç»‘å®šçš„ç¾¤ç»„</summary>
    WxContact? CurrentBoundGroup { get; }
    
    /// <summary>ç»‘å®šç¾¤ç»„</summary>
    void BindGroup(WxContact group);
    
    /// <summary>å–æ¶ˆç»‘å®š</summary>
    void UnbindGroup();
    
    /// <summary>
    /// æ™ºèƒ½åŠ è½½ç¾¤æˆå‘˜
    /// 
    /// é€»è¾‘ï¼š
    /// 1. å¯¹æ¯”æœåŠ¡å™¨è¿”å›çš„æ•°æ®å’Œæ•°æ®åº“ä¸­çš„æ•°æ®
    /// 2. æ•°æ®åº“ä¸­å­˜åœ¨ â†’ åŠ è½½ï¼ˆä¿ç•™å†å²æ•°æ®ï¼‰
    /// 3. æ•°æ®åº“ä¸­ä¸å­˜åœ¨ â†’ æ–°å¢
    /// 4. æ•°æ®åº“æœ‰ä½†æœåŠ¡å™¨æ²¡è¿”å› â†’ æ ‡è®°ä¸º"å·²é€€ç¾¤"
    /// </summary>
    List<V2Member> LoadAndMergeMembers(List<V2Member> serverMembers, string groupWxId);
}
```

---

### 2. æœåŠ¡å®ç°

**æ–‡ä»¶**: `BaiShengVx3Plus/Services/GroupBinding/GroupBindingService.cs`

#### æ ¸å¿ƒæ–¹æ³•ï¼šLoadAndMergeMembers

```csharp
public List<V2Member> LoadAndMergeMembers(List<V2Member> serverMembers, string groupWxId)
{
    // æ­¥éª¤1: ä»æ•°æ®åº“åŠ è½½å½“å‰ç¾¤çš„æ‰€æœ‰ä¼šå‘˜
    var dbMembers = _db.Table<V2Member>()
        .Where(m => m.GroupWxId == groupWxId)
        .ToList();
    
    // æ­¥éª¤2: åˆ›å»ºæœåŠ¡å™¨ä¼šå‘˜çš„ Wxid é›†åˆï¼ˆç”¨äºå¿«é€ŸæŸ¥æ‰¾ï¼‰
    var serverWxids = new HashSet<string>(
        serverMembers.Where(m => !string.IsNullOrEmpty(m.Wxid))
                     .Select(m => m.Wxid!)
    );
    
    var mergedMembers = new List<V2Member>();
    
    // æ­¥éª¤3: å¤„ç†æœåŠ¡å™¨è¿”å›çš„ä¼šå‘˜
    foreach (var serverMember in serverMembers)
    {
        var dbMember = dbMembers.FirstOrDefault(m => m.Wxid == serverMember.Wxid);
        
        if (dbMember != null)
        {
            // æƒ…å†µ1: æ•°æ®åº“ä¸­å­˜åœ¨ â†’ ä½¿ç”¨æ•°æ®åº“æ•°æ®ï¼ˆä¿ç•™å†å²ç»Ÿè®¡ï¼‰
            dbMember.Nickname = serverMember.Nickname; // æ›´æ–°æ˜µç§°
            dbMember.DisplayName = serverMember.DisplayName; // æ›´æ–°ç¾¤æ˜µç§°
            
            // å¦‚æœä¹‹å‰æ˜¯"å·²é€€ç¾¤"ï¼Œç°åœ¨æ¢å¤
            if (dbMember.State == MemberState.å·²é€€ç¾¤)
            {
                dbMember.State = MemberState.ä¼šå‘˜;
            }
            
            mergedMembers.Add(dbMember);
        }
        else
        {
            // æƒ…å†µ2: æ•°æ®åº“ä¸­ä¸å­˜åœ¨ â†’ æ–°å¢ä¼šå‘˜
            serverMember.GroupWxId = groupWxId;
            serverMember.State = MemberState.ä¼šå‘˜;
            mergedMembers.Add(serverMember);
        }
    }
    
    // æ­¥éª¤4: å¤„ç†å·²é€€ç¾¤çš„ä¼šå‘˜ï¼ˆæ•°æ®åº“æœ‰ä½†æœåŠ¡å™¨æ²¡è¿”å›ï¼‰
    foreach (var dbMember in dbMembers)
    {
        if (!serverWxids.Contains(dbMember.Wxid))
        {
            // æƒ…å†µ3: æ ‡è®°ä¸º"å·²é€€ç¾¤"
            if (dbMember.State != MemberState.å·²é€€ç¾¤ && 
                dbMember.State != MemberState.å·²åˆ é™¤)
            {
                dbMember.State = MemberState.å·²é€€ç¾¤;
                mergedMembers.Add(dbMember);
            }
            else if (dbMember.State == MemberState.å·²é€€ç¾¤)
            {
                // ä»ç„¶æ˜¯å·²é€€ç¾¤çŠ¶æ€ï¼Œä¿ç•™
                mergedMembers.Add(dbMember);
            }
        }
    }
    
    return mergedMembers;
}
```

---

### 3. åœ¨ VxMain ä¸­ä½¿ç”¨æœåŠ¡

**ä¿®æ”¹ç»‘å®šç¾¤ç»„çš„æ–¹æ³•**:

```csharp
private async void btnBindingContacts_Click(object sender, EventArgs e)
{
    if (dgvContacts.CurrentRow?.DataBoundItem is WxContact contact)
    {
        // åˆ¤æ–­æ˜¯å¦ä¸ºç¾¤
        if (!contact.Wxid.Contains("@"))
        {
            UIMessageBox.ShowWarning("è¯·é€‰æ‹©æ­£ç¡®çš„ç¾¤ç»„ï¼");
            return;
        }
        
        // ğŸ”¥ ä½¿ç”¨æœåŠ¡ç»‘å®šç¾¤ç»„
        _groupBindingService.BindGroup(contact);
        
        // æ›´æ–°æ–‡æœ¬æ¡†æ˜¾ç¤º
        txtCurrentContact.Text = $"{contact.Nickname} ({contact.Wxid})";
        txtCurrentContact.FillColor = Color.FromArgb(240, 255, 240);
        txtCurrentContact.RectColor = Color.FromArgb(82, 196, 26);
        
        // åˆ·æ–° DataGridView
        dgvContacts.Refresh();
        
        lblStatus.Text = $"âœ“ å·²ç»‘å®š: {contact.Nickname} - æ­£åœ¨è·å–ç¾¤æˆå‘˜...";
        _logService.Info("VxMain", $"ç»‘å®šç¾¤ç»„: {contact.Nickname} ({contact.Wxid})");
        
        // ğŸ”¥ æ¸…ç©ºå½“å‰ä¼šå‘˜å’Œè®¢å•åˆ—è¡¨
        UpdateUIThreadSafe(() =>
        {
            _membersBindingList?.Clear();
            _ordersBindingList?.Clear();
            UpdateStatistics();
        });
        
        // ğŸ”¥ è·å–ç¾¤æˆå‘˜
        try
        {
            var result = await _socketClient.SendAsync<JsonDocument>("GetGroupContacts", contact.Wxid);
            
            if (result == null || result.RootElement.ValueKind != JsonValueKind.Array)
            {
                _logService.Error("VxMain", "è·å–ç¾¤æˆå‘˜å¤±è´¥");
                UIMessageBox.ShowError("è·å–ç¾¤æˆå‘˜å¤±è´¥ï¼");
                return;
            }
            
            // ğŸ”¥ è§£ææœåŠ¡å™¨è¿”å›çš„ä¼šå‘˜æ•°æ®
            var serverMembers = ParseGroupMembers(result.RootElement, contact.Wxid);
            
            // ğŸ”¥ ä½¿ç”¨æœåŠ¡è¿›è¡Œæ™ºèƒ½åˆå¹¶
            var mergedMembers = _groupBindingService.LoadAndMergeMembers(serverMembers, contact.Wxid);
            
            // ğŸ”¥ åŠ è½½åˆ° UIï¼ˆè‡ªåŠ¨ä¿å­˜åˆ°æ•°æ®åº“ï¼‰
            UpdateUIThreadSafe(() =>
            {
                _membersBindingList?.Clear();
                foreach (var member in mergedMembers)
                {
                    _membersBindingList?.Add(member);  // è‡ªåŠ¨ä¿å­˜
                }
                UpdateStatistics();
            });
            
            lblStatus.Text = $"âœ“ å·²ç»‘å®š: {contact.Nickname} - åŠ è½½äº† {mergedMembers.Count} ä¸ªä¼šå‘˜";
            _logService.Info("VxMain", $"ç¾¤æˆå‘˜åŠ è½½å®Œæˆ: {mergedMembers.Count} ä¸ªä¼šå‘˜");
        }
        catch (Exception ex)
        {
            _logService.Error("VxMain", $"è·å–ç¾¤æˆå‘˜å¼‚å¸¸: {ex.Message}", ex);
            UIMessageBox.ShowError($"è·å–ç¾¤æˆå‘˜å¤±è´¥ï¼\n\n{ex.Message}");
        }
    }
}
```

---

### 4. ä¼šå‘˜çŠ¶æ€èƒŒæ™¯è‰²å®ç°

**åœ¨ `dgvMembers` çš„ `CellPainting` äº‹ä»¶ä¸­å®ç°**:

```csharp
private void dgvMembers_CellPainting(object? sender, DataGridViewCellPaintingEventArgs e)
{
    if (e.RowIndex < 0 || e.ColumnIndex < 0) return;
    
    if (dgvMembers.Rows[e.RowIndex].DataBoundItem is V2Member member)
    {
        // ğŸ”¥ æ ¹æ®ä¼šå‘˜çŠ¶æ€è®¾ç½®èƒŒæ™¯è‰²
        Color backgroundColor = member.State switch
        {
            MemberState.ç®¡ç† => Color.FromArgb(255, 215, 0),    // é‡‘è‰²
            MemberState.æ‰˜ => Color.FromArgb(255, 165, 0),       // æ©™è‰²
            MemberState.å·²é€€ç¾¤ => Color.FromArgb(192, 192, 192),  // ç°è‰²
            MemberState.å·²åˆ é™¤ => Color.FromArgb(255, 99, 71),    // çº¢è‰²
            MemberState.æ™®ä¼š => Color.White,                     // ç™½è‰²
            MemberState.è“ä¼š => Color.FromArgb(135, 206, 250),   // è“è‰²
            MemberState.ç´«ä¼š => Color.FromArgb(221, 160, 221),   // ç´«è‰²
            _ => Color.White                                     // é»˜è®¤ç™½è‰²
        };
        
        // ç»˜åˆ¶èƒŒæ™¯
        using (var backBrush = new SolidBrush(backgroundColor))
        {
            e.Graphics.FillRectangle(backBrush, e.CellBounds);
        }
        
        // ç»˜åˆ¶è¾¹æ¡†
        e.Graphics.DrawRectangle(Pens.Silver, e.CellBounds);
        
        // ç»˜åˆ¶æ–‡æœ¬
        if (e.Value != null)
        {
            var textColor = Color.Black;
            // ç°è‰²èƒŒæ™¯ç”¨æ·±è‰²æ–‡å­—ï¼Œå…¶ä»–ç”¨é»‘è‰²
            if (member.State == MemberState.å·²é€€ç¾¤)
            {
                textColor = Color.DarkGray;
            }
            
            TextRenderer.DrawText(
                e.Graphics,
                e.Value.ToString(),
                e.CellStyle.Font,
                e.CellBounds,
                textColor,
                TextFormatFlags.VerticalCenter | TextFormatFlags.Left
            );
        }
        
        e.Handled = true;
    }
}
```

---

## ğŸ“Š æ•°æ®æµç¨‹å›¾

### å®Œæ•´çš„ç»‘å®šå’ŒåŠ è½½æµç¨‹

```
ç”¨æˆ·ç‚¹å‡»"ç»‘å®š"æŒ‰é’®
    â†“
_groupBindingService.BindGroup(contact)
    â†“
GetGroupContacts(ç¾¤wxid) â†’ æœåŠ¡å™¨è¿”å›æ•°æ®
    â†“
ParseGroupMembers() â†’ è§£æä¸º List<V2Member>
    â†“
_groupBindingService.LoadAndMergeMembers()
    â”œâ”€ ä»æ•°æ®åº“åŠ è½½ GroupWxId == ç¾¤wxid çš„ä¼šå‘˜
    â”œâ”€ å¯¹æ¯”æœåŠ¡å™¨æ•°æ®
    â”œâ”€ æ•°æ®åº“å­˜åœ¨ â†’ ä¿ç•™ï¼ˆæ›´æ–°æ˜µç§°ï¼‰
    â”œâ”€ æ•°æ®åº“ä¸å­˜åœ¨ â†’ æ–°å¢
    â””â”€ æ•°æ®åº“æœ‰ä½†æœåŠ¡å™¨æ²¡è¿”å› â†’ æ ‡è®°"å·²é€€ç¾¤"
    â†“
è¿”å›åˆå¹¶åçš„ä¼šå‘˜åˆ—è¡¨
    â†“
_membersBindingList.Add(member) Ã— N
    â†“
è‡ªåŠ¨è§¦å‘ INotifyPropertyChanged
    â†“
V2MemberBindingList ç›‘å¬åˆ°å˜åŒ–
    â†“
SQLite ORM è‡ªåŠ¨ä¿å­˜åˆ°æ•°æ®åº“
    â†“
UI è‡ªåŠ¨åˆ·æ–°æ˜¾ç¤º
```

---

## âœ… ä¼˜åŠ¿æ€»ç»“

### 1. **æœåŠ¡åŒ–è®¾è®¡**
- âœ… å•ä¸€èŒè´£ï¼š`IGroupBindingService` åªè´Ÿè´£ç¾¤ç»„ç»‘å®šå’Œæ•°æ®åˆå¹¶
- âœ… æ˜“æµ‹è¯•ï¼šæœåŠ¡é€»è¾‘ä¸ UI åˆ†ç¦»
- âœ… æ˜“ç»´æŠ¤ï¼šä¸šåŠ¡é€»è¾‘é›†ä¸­åœ¨æœåŠ¡ä¸­

### 2. **æ™ºèƒ½æ•°æ®åˆå¹¶**
- âœ… è‡ªåŠ¨æ£€æµ‹æ–°æˆå‘˜å’Œé€€ç¾¤æˆå‘˜
- âœ… ä¿ç•™å†å²ç»Ÿè®¡æ•°æ®
- âœ… æ— éœ€æ‰‹åŠ¨å¯¹æ¯”å’Œå¤„ç†

### 3. **çŠ¶æ€å¯è§†åŒ–**
- âœ… ä¸åŒçŠ¶æ€ä¸åŒèƒŒæ™¯è‰²
- âœ… ä¸€çœ¼çœ‹å‡ºä¼šå‘˜çŠ¶æ€
- âœ… æå‡ç”¨æˆ·ä½“éªŒ

### 4. **åº•å±‚ç¨³å®š**
- âœ… ä¸å½±å“ç°æœ‰çš„ ORM è‡ªåŠ¨ä¿å­˜é€»è¾‘
- âœ… ä¸å½±å“ `INotifyPropertyChanged` æœºåˆ¶
- âœ… ä¿®æ”¹ç«‹å³ä¿å­˜ï¼ˆåŒæ­¥ä¿å­˜ï¼‰

---

## ğŸ¯ å¾…å®ç°æ¸…å•

### Phase 1: æœåŠ¡å±‚ï¼ˆå·²å®Œæˆï¼‰
- âœ… `IGroupBindingService` æ¥å£
- âœ… `GroupBindingService` å®ç°
- âœ… æ³¨å†Œåˆ° DI å®¹å™¨

### Phase 2: VxMain é›†æˆï¼ˆè¿›è¡Œä¸­ï¼‰
- âœ… æ³¨å…¥ `IGroupBindingService`
- âœ… å°†æ•°æ®åº“è¿æ¥ä¼ é€’ç»™æœåŠ¡
- â³ ä¿®æ”¹ `btnBindingContacts_Click` æ–¹æ³•
- â³ å®ç° `ParseGroupMembers` æ–¹æ³•
- â³ æ›´æ–° `LoadGroupMembersToDataGridAsync` æ–¹æ³•

### Phase 3: UI ä¼˜åŒ–ï¼ˆå¾…å®ç°ï¼‰
- â³ å®ç° `dgvMembers_CellPainting` äº‹ä»¶
- â³ æ ¹æ®ä¼šå‘˜çŠ¶æ€è®¾ç½®èƒŒæ™¯è‰²
- â³ æµ‹è¯•ä¸åŒçŠ¶æ€çš„æ˜¾ç¤ºæ•ˆæœ

---

## ğŸ”¥ å…³é”®æŠ€æœ¯ç‚¹

### 1. **HashSet å¿«é€ŸæŸ¥æ‰¾**
```csharp
var serverWxids = new HashSet<string>(serverMembers.Select(m => m.Wxid));
if (!serverWxids.Contains(dbMember.Wxid))
{
    // å·²é€€ç¾¤
}
```

### 2. **Pattern Matching (Switch Expression)**
```csharp
Color backgroundColor = member.State switch
{
    MemberState.ç®¡ç† => Color.FromArgb(255, 215, 0),
    MemberState.æ‰˜ => Color.FromArgb(255, 165, 0),
    _ => Color.White
};
```

### 3. **ORM è‡ªåŠ¨ä¿å­˜**
```csharp
_membersBindingList.Add(member);  // è‡ªåŠ¨è§¦å‘ä¿å­˜
member.State = MemberState.å·²é€€ç¾¤;  // è‡ªåŠ¨è§¦å‘ä¿å­˜
```

---

**âœ… å®Œæ•´æ–¹æ¡ˆæ–‡æ¡£å·²åˆ›å»ºï¼**

æ¥ä¸‹æ¥å°†å®ç°å‰©ä½™çš„é›†æˆä»£ç ã€‚

2025-11-06

