# ğŸš€ å¼€å¥–ç³»ç»Ÿå®ç°è¿›åº¦

## âœ… å·²å®Œæˆ

### P0: æ ¸å¿ƒæ¨¡å‹å’Œæ¥å£
- âœ… `Models/Api/BsApiUser.cs` - API ç”¨æˆ·æ¨¡å‹
- âœ… `Models/Api/BsApiResponse.cs` - API å“åº”æ¨¡å‹
- âœ… `Models/Games/Binggo/BinggoLotteryStatus.cs` - çŠ¶æ€æšä¸¾
- âœ… `Models/Games/Binggo/BinggoLotteryData.cs` - å¼€å¥–æ•°æ®æ¨¡å‹ï¼ˆå«å¤§å°å•åŒé¾™è™è®¡ç®—ï¼‰
- âœ… `Models/Games/Binggo/BinggoBetContent.cs` - ä¸‹æ³¨å†…å®¹æ¨¡å‹
- âœ… `Models/Games/Binggo/BinggoGameSettings.cs` - æ¸¸æˆé…ç½®æ¨¡å‹
- âœ… `Models/Games/Binggo/Events/BinggoIssueChangedEventArgs.cs` - æœŸå·å˜æ›´äº‹ä»¶
- âœ… `Models/Games/Binggo/Events/BinggoStatusChangedEventArgs.cs` - çŠ¶æ€å˜æ›´äº‹ä»¶
- âœ… `Models/Games/Binggo/Events/BinggoCountdownEventArgs.cs` - å€’è®¡æ—¶äº‹ä»¶
- âœ… `Models/Games/Binggo/Events/BinggoLotteryOpenedEventArgs.cs` - å¼€å¥–äº‹ä»¶
- âœ… `Contracts/IBsWebApiService.cs` - WebAPI æœåŠ¡æ¥å£
- âœ… `Contracts/IBsWebApiClient.cs` - HTTP å®¢æˆ·ç«¯æ¥å£
- âœ… `Contracts/Games/IBinggoLotteryService.cs` - å¼€å¥–æœåŠ¡æ¥å£ï¼ˆå«ç¼“å­˜ç­–ç•¥ï¼‰
- âœ… `Contracts/Games/IBinggoOrderService.cs` - è®¢å•æœåŠ¡æ¥å£ï¼ˆå«è¡¥å•é€»è¾‘ï¼‰

## ğŸ”„ è¿›è¡Œä¸­

### P0: WebAPI å®ç°
- â³ `Services/Api/BsWebApiClient.cs` - HTTP å®¢æˆ·ç«¯å®ç°
- â³ `Services/Api/BsWebApiService.cs` - WebAPI æœåŠ¡å®ç°

### P0: å¼€å¥–æœåŠ¡å®ç°
- â³ `Services/Games/Binggo/BinggoLotteryService.cs` - å¼€å¥–æœåŠ¡å®ç°ï¼ˆå«ç¼“å­˜ç­–ç•¥ï¼‰

### P0: æ•°æ®ç»‘å®š
- â³ `Core/BinggoLotteryDataBindingList.cs` - ORM BindingList

## â¸ï¸ å¾…å®ç°

### P1: è®¢å•å¤„ç†
- â³ `Services/Games/Binggo/BinggoOrderService.cs` - è®¢å•æœåŠ¡å®ç°
- â³ `Services/Games/Binggo/BinggoOrderValidator.cs` - è®¢å•éªŒè¯å™¨
- â³ `Helpers/BinggoHelper.cs` - ä¸‹æ³¨è§£æå™¨

### P1: æ¶ˆæ¯å¤„ç†
- â³ `Services/Messages/Handlers/BinggoMessageHandler.cs` - æ¶ˆæ¯å¤„ç†å™¨
- â³ æ›´æ–° `MessageDispatcher` é›†æˆ

### P2: UI æ§ä»¶
- â³ `Views/Controls/UcBinggoDataCur.cs` - å½“å‰æœŸæ§ä»¶
- â³ `Views/Controls/UcBinggoDataLast.cs` - ä¸ŠæœŸæ§ä»¶
- â³ `Views/Controls/UcBinggoSettings.cs` - é…ç½®æ§ä»¶

### P2: é…ç½®ç®¡ç†
- â³ `Services/Settings/GameSettingsService.cs` - é…ç½®æœåŠ¡

### é›†æˆ
- â³ æ›´æ–° `Program.cs` - ä¾èµ–æ³¨å…¥
- â³ æ›´æ–° `VxMain.cs` - äº‹ä»¶è®¢é˜…å’Œ UI ç»‘å®š

---

## ğŸ“ æ ¸å¿ƒè®¾è®¡è¦ç‚¹

### 1. å¼€å¥–æ•°æ®ç¼“å­˜ç­–ç•¥
```csharp
// å…ˆæŸ¥æœ¬åœ°ï¼Œæ²¡æœ‰å†è¯·æ±‚ç½‘ç»œ
public async Task<BinggoLotteryData?> GetLotteryDataAsync(int issueId, bool forceRefresh = false)
{
    // 1. å¦‚æœä¸å¼ºåˆ¶åˆ·æ–°ï¼Œå…ˆæŸ¥æœ¬åœ°æ•°æ®åº“
    if (!forceRefresh)
    {
        var local = _db.Table<BinggoLotteryData>()
            .FirstOrDefault(d => d.IssueId == issueId && d.IsOpened);
        
        if (local != null)
        {
            _logService.Info("BinggoLottery", $"ä»æœ¬åœ°ç¼“å­˜è·å–æœŸå· {issueId} æ•°æ®");
            return local;
        }
    }
    
    // 2. æœ¬åœ°æ²¡æœ‰ï¼Œä»ç½‘ç»œè·å–
    var response = await _webApiClient.GetBinggoDataAsync(issueId);
    if (response.IsSuccess && response.Data != null)
    {
        // 3. ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜
        await SaveLotteryDataAsync(response.Data);
        return response.Data;
    }
    
    return null;
}
```

### 2. è¡¥å•é€»è¾‘
```csharp
// è¡¥å•æ—¶è‡ªåŠ¨è·å–å¼€å¥–æ•°æ®å¹¶ç»“ç®—
public async Task<V2MemberOrder?> CreateManualOrderAsync(V2Member member, int issueId, string betContent, float amount)
{
    // 1. è·å–å¼€å¥–æ•°æ®ï¼ˆå…ˆæŸ¥æœ¬åœ°ï¼‰
    var lotteryData = await _lotteryService.GetLotteryDataAsync(issueId, forceRefresh: false);
    if (lotteryData == null || !lotteryData.IsOpened)
    {
        _logService.Warning("BinggoOrder", $"è¡¥å•å¤±è´¥: æœŸå· {issueId} æœªå¼€å¥–æˆ–æ•°æ®ä¸å­˜åœ¨");
        return null;
    }
    
    // 2. åˆ›å»ºè®¢å•
    var order = new V2MemberOrder { /* ... */ };
    _db.Insert(order);
    
    // 3. ç«‹å³ç»“ç®—
    await SettleOrderAsync(order, lotteryData);
    
    // 4. æ›´æ–°ä¼šå‘˜ä½™é¢
    member.Balance += order.Profit;
    _db.Update(member);
    
    return order;
}
```

### 3. ç»“ç®—é€»è¾‘
```csharp
// ç»“ç®—æ—¶å…ˆè·å–å¼€å¥–æ•°æ®
public async Task<int> SettleOrdersAsync(int issueId, BinggoLotteryData? lotteryData = null)
{
    // 1. è·å–å¼€å¥–æ•°æ®ï¼ˆä¼˜å…ˆä½¿ç”¨ä¼ å…¥çš„ï¼Œå¦åˆ™æŸ¥è¯¢ï¼‰
    if (lotteryData == null)
    {
        lotteryData = await _lotteryService.GetLotteryDataAsync(issueId, forceRefresh: false);
    }
    
    if (lotteryData == null || !lotteryData.IsOpened)
    {
        _logService.Warning("BinggoOrder", $"ç»“ç®—å¤±è´¥: æœŸå· {issueId} æœªå¼€å¥–");
        return 0;
    }
    
    // 2. æŸ¥è¯¢æ‰€æœ‰æœªç»“ç®—è®¢å•
    var pendingOrders = _db.Table<V2MemberOrder>()
        .Where(o => o.IssueId == issueId && o.OrderStatus == OrderStatus.æœªç»“ç®—)
        .ToList();
    
    // 3. é€ä¸ªç»“ç®—
    foreach (var order in pendingOrders)
    {
        await SettleOrderAsync(order, lotteryData);
    }
    
    return pendingOrders.Count;
}
```

---

## ä¸‹ä¸€æ­¥

ç»§ç»­å®ç° Services å±‚çš„ä»£ç ...

