# è‡ªåŠ¨æŠ•æ³¨æ¨¡å—è®¾è®¡æ–¹æ¡ˆ

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

è®¾è®¡ä¸€ä¸ªç°ä»£åŒ–çš„è‡ªåŠ¨æŠ•æ³¨ç³»ç»Ÿï¼Œæ ¸å¿ƒæ˜¯å°è£…ä¸€ä¸ªåŠŸèƒ½å®Œå–„çš„æµè§ˆå™¨æ§ä»¶åº“ï¼Œæ”¯æŒå¤šå®ä¾‹ã€Cookieéš”ç¦»ã€è„šæœ¬æ³¨å…¥ï¼Œä¸ºä¸åŒæ¸¸æˆå¹³å°æä¾›ç»Ÿä¸€çš„è‡ªåŠ¨åŒ–æ¥å£ã€‚

---

## ğŸ¯ æ ¸å¿ƒéœ€æ±‚

### 1. æµè§ˆå™¨å°è£…ï¼ˆç‹¬ç«‹åº“ï¼‰
- åŸºäº CEF (Chromium Embedded Framework)
- æ”¯æŒè„šæœ¬æ³¨å…¥
- æ”¯æŒCookieç®¡ç†
- æ”¯æŒè¿›ç¨‹éš”ç¦»
- æä¾›ç»Ÿä¸€çš„APIæ¥å£

### 2. å¹³å°é€‚é…ï¼ˆç­–ç•¥æ¨¡å¼ï¼‰
- ä¸åŒæ¸¸æˆå¹³å°ä¸åŒè„šæœ¬
- ç»Ÿä¸€çš„æŠ•æ³¨æ¥å£
- å¿«é€Ÿè®¾ç½®ä¸­é€‰æ‹©å¹³å°

### 3. å¤šå®ä¾‹æ”¯æŒï¼ˆå¯æ‰©å±•ï¼‰
- æ¯ä¸ªæµè§ˆå™¨å®ä¾‹ç‹¬ç«‹Cookie
- è¿›ç¨‹çº§éš”ç¦»
- å½“å‰ç‰ˆæœ¬ï¼š1ä¸ªå®ä¾‹
- é¢„ç•™æ‰©å±•èƒ½åŠ›

### 4. é€šä¿¡æœºåˆ¶
- ä¸»ç¨‹åº â†” æµè§ˆå™¨è¿›ç¨‹
- JavaScript â†” C# äº’è°ƒ
- å¼‚æ­¥äº‹ä»¶é€šçŸ¥

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ€»ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              BaiShengVx3Plus (ä¸»ç¨‹åº)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚           è‡ªåŠ¨æŠ•æ³¨ç®¡ç†å™¨ (AutoBetManager)          â”‚ â”‚
â”‚  â”‚   â€¢ å¹³å°é€‰æ‹©                                        â”‚ â”‚
â”‚  â”‚   â€¢ å®ä¾‹ç®¡ç†                                        â”‚ â”‚
â”‚  â”‚   â€¢ è®¢å•åˆ†å‘                                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚               â”‚                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚ IPC é€šä¿¡ (å‘½åç®¡é“/WebSocket)
                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               â–¼                                          â”‚
â”‚     BaiShengBrowser.exe (ç‹¬ç«‹æµè§ˆå™¨è¿›ç¨‹)                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚           æµè§ˆå™¨ä¸»æœº (BrowserHost)                  â”‚ â”‚
â”‚  â”‚   â€¢ CEF åˆå§‹åŒ–                                      â”‚ â”‚
â”‚  â”‚   â€¢ è¿›ç¨‹ç®¡ç†                                        â”‚ â”‚
â”‚  â”‚   â€¢ Cookie éš”ç¦»                                     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚               â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚         JavaScript æ¡¥æ¥ (JSBridge)                  â”‚ â”‚
â”‚  â”‚   â€¢ C# â†” JS äº’è°ƒ                                    â”‚ â”‚
â”‚  â”‚   â€¢ äº‹ä»¶é€šçŸ¥                                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚               â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚     å¹³å°è„šæœ¬å¼•æ“ (PlatformScriptEngine)            â”‚ â”‚
â”‚  â”‚   â”œâ”€ YunDing28Script  (äº‘é¡¶28)                     â”‚ â”‚
â”‚  â”‚   â”œâ”€ BingGo28Script   (ç‚³ç‹—28)                     â”‚ â”‚
â”‚  â”‚   â”œâ”€ KuaiLe8Script    (å¿«ä¹8)                      â”‚ â”‚
â”‚  â”‚   â””â”€ ...              (å¯æ‰©å±•)                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¦ é¡¹ç›®ç»“æ„

### è§£å†³æ–¹æ¡ˆç»“æ„

```
Solution: BaiShengVx3Plus.sln
â”‚
â”œâ”€â”€ BaiShengVx3Plus/                    # ä¸»ç¨‹åºï¼ˆç°æœ‰ï¼‰
â”‚   â”œâ”€â”€ Services/
â”‚   â”‚   â””â”€â”€ AutoBet/
â”‚   â”‚       â”œâ”€â”€ IAutoBetService.cs           # è‡ªåŠ¨æŠ•æ³¨æœåŠ¡æ¥å£
â”‚   â”‚       â”œâ”€â”€ AutoBetService.cs            # è‡ªåŠ¨æŠ•æ³¨æœåŠ¡å®ç°
â”‚   â”‚       â”œâ”€â”€ AutoBetManager.cs            # å®ä¾‹ç®¡ç†å™¨
â”‚   â”‚       â””â”€â”€ BrowserHostClient.cs         # æµè§ˆå™¨è¿›ç¨‹å®¢æˆ·ç«¯
â”‚   â””â”€â”€ Models/
â”‚       â””â”€â”€ AutoBet/
â”‚           â”œâ”€â”€ BetOrder.cs                  # æŠ•æ³¨è®¢å•
â”‚           â”œâ”€â”€ PlatformType.cs              # å¹³å°ç±»å‹æšä¸¾
â”‚           â””â”€â”€ BrowserInstance.cs           # æµè§ˆå™¨å®ä¾‹ä¿¡æ¯
â”‚
â”œâ”€â”€ BaiShengBrowser/                    # ğŸ”¥ æ–°å»ºï¼šç‹¬ç«‹æµè§ˆå™¨åº“ï¼ˆ.NET 8ï¼‰
â”‚   â”œâ”€â”€ BaiShengBrowser.csproj              # é¡¹ç›®æ–‡ä»¶
â”‚   â”œâ”€â”€ Program.cs                          # å…¥å£ï¼ˆæ§åˆ¶å°/WinFormsï¼‰
â”‚   â”œâ”€â”€ Core/
â”‚   â”‚   â”œâ”€â”€ BrowserHost.cs                  # CEF æµè§ˆå™¨ä¸»æœº
â”‚   â”‚   â”œâ”€â”€ BrowserSettings.cs              # æµè§ˆå™¨é…ç½®
â”‚   â”‚   â”œâ”€â”€ CookieManager.cs                # Cookie ç®¡ç†
â”‚   â”‚   â””â”€â”€ ProcessIsolation.cs             # è¿›ç¨‹éš”ç¦»ç®¡ç†
â”‚   â”œâ”€â”€ Bridge/
â”‚   â”‚   â”œâ”€â”€ JSBridge.cs                     # JavaScript æ¡¥æ¥
â”‚   â”‚   â”œâ”€â”€ CefMessageRouter.cs             # CEF æ¶ˆæ¯è·¯ç”±
â”‚   â”‚   â””â”€â”€ IPCHandler.cs                   # IPC é€šä¿¡å¤„ç†
â”‚   â”œâ”€â”€ Scripts/
â”‚   â”‚   â”œâ”€â”€ IPlatformScript.cs              # å¹³å°è„šæœ¬æ¥å£
â”‚   â”‚   â”œâ”€â”€ BasePlatformScript.cs           # è„šæœ¬åŸºç±»
â”‚   â”‚   â”œâ”€â”€ YunDing28Script.cs              # äº‘é¡¶28 è„šæœ¬
â”‚   â”‚   â”œâ”€â”€ BingGo28Script.cs               # ç‚³ç‹—28 è„šæœ¬
â”‚   â”‚   â””â”€â”€ ...                             # å…¶ä»–å¹³å°è„šæœ¬
â”‚   â””â”€â”€ Resources/
â”‚       â””â”€â”€ js/
â”‚           â”œâ”€â”€ common.js                   # é€šç”¨ JS åº“
â”‚           â”œâ”€â”€ yunding28.js                # äº‘é¡¶28 è„šæœ¬
â”‚           â”œâ”€â”€ binggo28.js                 # ç‚³ç‹—28 è„šæœ¬
â”‚           â””â”€â”€ ...
â”‚
â””â”€â”€ BaiShengBrowser.Communication/      # ğŸ”¥ æ–°å»ºï¼šé€šä¿¡åè®®åº“ï¼ˆå…±äº«ï¼‰
    â”œâ”€â”€ IPC/
    â”‚   â”œâ”€â”€ IIPCClient.cs                   # IPC å®¢æˆ·ç«¯æ¥å£
    â”‚   â”œâ”€â”€ IIPCServer.cs                   # IPC æœåŠ¡ç«¯æ¥å£
    â”‚   â”œâ”€â”€ NamedPipeClient.cs              # å‘½åç®¡é“å®¢æˆ·ç«¯
    â”‚   â””â”€â”€ NamedPipeServer.cs              # å‘½åç®¡é“æœåŠ¡ç«¯
    â””â”€â”€ Messages/
        â”œâ”€â”€ BrowserCommand.cs               # æµè§ˆå™¨å‘½ä»¤
        â”œâ”€â”€ BrowserEvent.cs                 # æµè§ˆå™¨äº‹ä»¶
        â””â”€â”€ MessageSerializer.cs            # æ¶ˆæ¯åºåˆ—åŒ–
```

---

## ğŸ”Œ æ ¸å¿ƒæ¥å£è®¾è®¡

### 1. ä¸»ç¨‹åºç«¯æ¥å£

#### IAutoBetServiceï¼ˆè‡ªåŠ¨æŠ•æ³¨æœåŠ¡ï¼‰

```csharp
namespace BaiShengVx3Plus.Services.AutoBet
{
    /// <summary>
    /// è‡ªåŠ¨æŠ•æ³¨æœåŠ¡æ¥å£
    /// </summary>
    public interface IAutoBetService
    {
        /// <summary>
        /// å¯åŠ¨æµè§ˆå™¨å®ä¾‹
        /// </summary>
        Task<bool> StartBrowserAsync(PlatformType platform, string instanceId = "default");
        
        /// <summary>
        /// åœæ­¢æµè§ˆå™¨å®ä¾‹
        /// </summary>
        Task StopBrowserAsync(string instanceId = "default");
        
        /// <summary>
        /// ç™»å½•å¹³å°
        /// </summary>
        Task<bool> LoginAsync(string instanceId, string username, string password);
        
        /// <summary>
        /// è·å–ä½™é¢
        /// </summary>
        Task<decimal> GetBalanceAsync(string instanceId);
        
        /// <summary>
        /// æäº¤æŠ•æ³¨è®¢å•
        /// </summary>
        Task<BetResult> PlaceBetAsync(string instanceId, BetOrder order);
        
        /// <summary>
        /// è·å–æŠ•æ³¨è®°å½•
        /// </summary>
        Task<List<BetRecord>> GetBetRecordsAsync(string instanceId);
        
        /// <summary>
        /// æµè§ˆå™¨å°±ç»ªäº‹ä»¶
        /// </summary>
        event EventHandler<BrowserReadyEventArgs> BrowserReady;
        
        /// <summary>
        /// ç™»å½•çŠ¶æ€å˜åŒ–äº‹ä»¶
        /// </summary>
        event EventHandler<LoginStatusChangedEventArgs> LoginStatusChanged;
        
        /// <summary>
        /// ä½™é¢å˜åŒ–äº‹ä»¶
        /// </summary>
        event EventHandler<BalanceChangedEventArgs> BalanceChanged;
    }
}
```

#### AutoBetManagerï¼ˆå®ä¾‹ç®¡ç†å™¨ï¼‰

```csharp
public class AutoBetManager
{
    private readonly Dictionary<string, BrowserInstance> _instances;
    private readonly IIPCClient _ipcClient;
    
    /// <summary>
    /// åˆ›å»ºæµè§ˆå™¨å®ä¾‹
    /// </summary>
    public async Task<BrowserInstance> CreateInstanceAsync(
        PlatformType platform, 
        string instanceId,
        BrowserSettings? settings = null)
    {
        // 1. å¯åŠ¨ç‹¬ç«‹æµè§ˆå™¨è¿›ç¨‹
        var process = StartBrowserProcess(instanceId, settings);
        
        // 2. å»ºç«‹ IPC è¿æ¥
        await _ipcClient.ConnectAsync($"BaiShengBrowser_{instanceId}");
        
        // 3. å‘é€å¹³å°åˆå§‹åŒ–å‘½ä»¤
        await _ipcClient.SendCommandAsync(new InitializePlatformCommand 
        { 
            Platform = platform 
        });
        
        // 4. åˆ›å»ºå®ä¾‹å¯¹è±¡
        var instance = new BrowserInstance
        {
            InstanceId = instanceId,
            Platform = platform,
            Process = process,
            IPCClient = _ipcClient
        };
        
        _instances[instanceId] = instance;
        return instance;
    }
    
    /// <summary>
    /// å¯åŠ¨æµè§ˆå™¨è¿›ç¨‹ï¼ˆéš”ç¦»ï¼‰
    /// </summary>
    private Process StartBrowserProcess(string instanceId, BrowserSettings? settings)
    {
        var startInfo = new ProcessStartInfo
        {
            FileName = "BaiShengBrowser.exe",
            Arguments = $"--instance-id={instanceId} " +
                       $"--user-data-dir={GetUserDataDir(instanceId)} " +
                       $"--cache-dir={GetCacheDir(instanceId)}",
            UseShellExecute = false,
            RedirectStandardOutput = true,
            RedirectStandardError = true,
            CreateNoWindow = settings?.ShowWindow != true
        };
        
        return Process.Start(startInfo);
    }
    
    /// <summary>
    /// è·å–å®ä¾‹ç‹¬ç«‹çš„ç”¨æˆ·æ•°æ®ç›®å½•ï¼ˆCookie éš”ç¦»ï¼‰
    /// </summary>
    private string GetUserDataDir(string instanceId)
    {
        return Path.Combine(
            Environment.GetFolderPath(Environment.SpecialFolder.LocalApplicationData),
            "BaiShengBrowser",
            "UserData",
            instanceId);
    }
}
```

---

### 2. æµè§ˆå™¨è¿›ç¨‹ç«¯æ¥å£

#### BrowserHostï¼ˆCEF ä¸»æœºï¼‰

```csharp
namespace BaiShengBrowser.Core
{
    /// <summary>
    /// æµè§ˆå™¨ä¸»æœºï¼ˆCEF å°è£…ï¼‰
    /// </summary>
    public class BrowserHost : IDisposable
    {
        private CefSharp.WinForms.ChromiumWebBrowser _browser;
        private readonly BrowserSettings _settings;
        private readonly JSBridge _jsBridge;
        private readonly IIPCServer _ipcServer;
        
        public BrowserHost(string instanceId, BrowserSettings settings)
        {
            _settings = settings;
            
            // ğŸ”¥ 1. åˆå§‹åŒ– CEFï¼ˆç‹¬ç«‹é…ç½®ï¼‰
            InitializeCef(instanceId);
            
            // ğŸ”¥ 2. åˆ›å»ºæµè§ˆå™¨å®ä¾‹
            _browser = CreateBrowser();
            
            // ğŸ”¥ 3. è®¾ç½® JavaScript æ¡¥æ¥
            _jsBridge = new JSBridge(_browser);
            RegisterJSBindings();
            
            // ğŸ”¥ 4. å¯åŠ¨ IPC æœåŠ¡å™¨
            _ipcServer = new NamedPipeServer($"BaiShengBrowser_{instanceId}");
            _ipcServer.CommandReceived += OnCommandReceived;
            await _ipcServer.StartAsync();
        }
        
        /// <summary>
        /// åˆå§‹åŒ– CEFï¼ˆCookie éš”ç¦»ï¼‰
        /// </summary>
        private void InitializeCef(string instanceId)
        {
            var settings = new CefSettings
            {
                CachePath = _settings.CacheDir,
                UserDataPath = _settings.UserDataDir,
                PersistSessionCookies = true,
                PersistUserPreferences = true,
                LogSeverity = LogSeverity.Warning,
                MultiThreadedMessageLoop = true,
                // ğŸ”¥ å…³é”®ï¼šæ¯ä¸ªå®ä¾‹ç‹¬ç«‹çš„æ•°æ®ç›®å½•
                RootCachePath = Path.Combine(_settings.CacheDir, instanceId)
            };
            
            Cef.Initialize(settings);
        }
        
        /// <summary>
        /// æ³¨å†Œ JavaScript ç»‘å®š
        /// </summary>
        private void RegisterJSBindings()
        {
            // C# æ–¹æ³•æš´éœ²ç»™ JavaScript
            _jsBridge.RegisterObject("bsbridge", new 
            {
                // é€šçŸ¥ä¸»ç¨‹åº
                notifyEvent = (Func<string, object, Task>)NotifyEventAsync,
                
                // æ—¥å¿—è¾“å‡º
                log = (Action<string>)LogToConsole,
                
                // è¯·æ±‚ä¸»ç¨‹åºæ•°æ®
                requestData = (Func<string, Task<object>>)RequestDataAsync
            });
        }
        
        /// <summary>
        /// åŠ è½½å¹³å°è„šæœ¬
        /// </summary>
        public async Task LoadPlatformScriptAsync(PlatformType platform)
        {
            var script = PlatformScriptFactory.Create(platform);
            
            // 1. å¯¼èˆªåˆ°å¹³å°URL
            _browser.Load(script.PlatformUrl);
            
            // 2. ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆ
            await WaitForPageLoadAsync();
            
            // 3. æ³¨å…¥é€šç”¨åº“
            await InjectScriptAsync(GetCommonScript());
            
            // 4. æ³¨å…¥å¹³å°ä¸“ç”¨è„šæœ¬
            await InjectScriptAsync(script.GetInitScript());
            
            // 5. é€šçŸ¥ä¸»ç¨‹åºå‡†å¤‡å°±ç»ª
            await NotifyEventAsync("BrowserReady", new { Platform = platform });
        }
    }
}
```

#### IPlatformScriptï¼ˆå¹³å°è„šæœ¬æ¥å£ï¼‰

```csharp
namespace BaiShengBrowser.Scripts
{
    /// <summary>
    /// å¹³å°è„šæœ¬æ¥å£
    /// </summary>
    public interface IPlatformScript
    {
        /// <summary>
        /// å¹³å°ç±»å‹
        /// </summary>
        PlatformType Platform { get; }
        
        /// <summary>
        /// å¹³å°URL
        /// </summary>
        string PlatformUrl { get; }
        
        /// <summary>
        /// è·å–åˆå§‹åŒ–è„šæœ¬
        /// </summary>
        string GetInitScript();
        
        /// <summary>
        /// è·å–ç™»å½•è„šæœ¬
        /// </summary>
        string GetLoginScript(string username, string password);
        
        /// <summary>
        /// è·å–ä½™é¢è„šæœ¬
        /// </summary>
        string GetBalanceScript();
        
        /// <summary>
        /// è·å–æŠ•æ³¨è„šæœ¬
        /// </summary>
        string GetPlaceBetScript(BetOrder order);
        
        /// <summary>
        /// è·å–æŠ•æ³¨è®°å½•è„šæœ¬
        /// </summary>
        string GetBetRecordsScript();
    }
    
    /// <summary>
    /// å¹³å°è„šæœ¬åŸºç±»
    /// </summary>
    public abstract class BasePlatformScript : IPlatformScript
    {
        public abstract PlatformType Platform { get; }
        public abstract string PlatformUrl { get; }
        
        public virtual string GetInitScript()
        {
            // é€šç”¨åˆå§‹åŒ–é€»è¾‘
            return @"
                // è®¾ç½®å…¨å±€å¯¹è±¡
                window.bsAutoBet = {
                    ready: false,
                    platform: '" + Platform + @"',
                    
                    // é€šçŸ¥ C# ç«¯
                    notify: function(event, data) {
                        bsbridge.notifyEvent(event, JSON.stringify(data));
                    },
                    
                    // æ—¥å¿—è¾“å‡º
                    log: function(message) {
                        bsbridge.log('[' + this.platform + '] ' + message);
                    }
                };
                
                // å¹³å°ç‰¹å®šåˆå§‹åŒ–
                " + GetPlatformSpecificInit() + @"
                
                // æ ‡è®°å°±ç»ª
                window.bsAutoBet.ready = true;
                window.bsAutoBet.notify('InitComplete', {});
            ";
        }
        
        protected abstract string GetPlatformSpecificInit();
        
        public abstract string GetLoginScript(string username, string password);
        public abstract string GetBalanceScript();
        public abstract string GetPlaceBetScript(BetOrder order);
        public abstract string GetBetRecordsScript();
    }
}
```

---

## ğŸ”„ é€šä¿¡åè®®è®¾è®¡

### IPC æ¶ˆæ¯æ ¼å¼

```csharp
namespace BaiShengBrowser.Communication.Messages
{
    /// <summary>
    /// æµè§ˆå™¨å‘½ä»¤ï¼ˆä¸»ç¨‹åº â†’ æµè§ˆå™¨ï¼‰
    /// </summary>
    public class BrowserCommand
    {
        public string CommandId { get; set; }      // å‘½ä»¤ID
        public string CommandType { get; set; }    // å‘½ä»¤ç±»å‹
        public object? Payload { get; set; }       // å‘½ä»¤å‚æ•°
        public DateTime Timestamp { get; set; }
    }
    
    /// <summary>
    /// æµè§ˆå™¨äº‹ä»¶ï¼ˆæµè§ˆå™¨ â†’ ä¸»ç¨‹åºï¼‰
    /// </summary>
    public class BrowserEvent
    {
        public string EventId { get; set; }        // äº‹ä»¶ID
        public string EventType { get; set; }      // äº‹ä»¶ç±»å‹
        public object? Data { get; set; }          // äº‹ä»¶æ•°æ®
        public DateTime Timestamp { get; set; }
    }
    
    /// <summary>
    /// å‘½ä»¤å“åº”
    /// </summary>
    public class CommandResponse
    {
        public string CommandId { get; set; }
        public bool Success { get; set; }
        public object? Result { get; set; }
        public string? ErrorMessage { get; set; }
    }
}
```

### å‘½ä»¤ç±»å‹å®šä¹‰

```csharp
public static class CommandTypes
{
    // æµè§ˆå™¨æ§åˆ¶
    public const string InitializePlatform = "InitializePlatform";
    public const string Navigate = "Navigate";
    public const string ExecuteScript = "ExecuteScript";
    public const string GetCookie = "GetCookie";
    public const string SetCookie = "SetCookie";
    
    // å¹³å°æ“ä½œ
    public const string Login = "Login";
    public const string GetBalance = "GetBalance";
    public const string PlaceBet = "PlaceBet";
    public const string GetBetRecords = "GetBetRecords";
    
    // ç”Ÿå‘½å‘¨æœŸ
    public const string Shutdown = "Shutdown";
}

public static class EventTypes
{
    // æµè§ˆå™¨äº‹ä»¶
    public const string BrowserReady = "BrowserReady";
    public const string PageLoaded = "PageLoaded";
    public const string ScriptError = "ScriptError";
    
    // å¹³å°äº‹ä»¶
    public const string LoginStatusChanged = "LoginStatusChanged";
    public const string BalanceChanged = "BalanceChanged";
    public const string BetPlaced = "BetPlaced";
    public const string BetResult = "BetResult";
}
```

---

## ğŸ“ å¹³å°è„šæœ¬ç¤ºä¾‹

### äº‘é¡¶28 è„šæœ¬ç¤ºä¾‹

```csharp
public class YunDing28Script : BasePlatformScript
{
    public override PlatformType Platform => PlatformType.YunDing28;
    public override string PlatformUrl => "https://www.yunding28.com";
    
    protected override string GetPlatformSpecificInit()
    {
        return @"
            // äº‘é¡¶28 ç‰¹å®šåˆå§‹åŒ–
            window.bsAutoBet.yd28 = {
                // å½“å‰æœŸå·
                currentIssue: null,
                
                // ç›‘å¬æœŸå·å˜åŒ–
                watchIssue: function() {
                    const observer = new MutationObserver(() => {
                        const issue = document.querySelector('.issue-number')?.textContent;
                        if (issue && issue !== this.currentIssue) {
                            this.currentIssue = issue;
                            window.bsAutoBet.notify('IssueChanged', { issue });
                        }
                    });
                    observer.observe(document.body, { childList: true, subtree: true });
                },
                
                // ç›‘å¬ä½™é¢å˜åŒ–
                watchBalance: function() {
                    const observer = new MutationObserver(() => {
                        const balance = document.querySelector('.user-balance')?.textContent;
                        if (balance) {
                            window.bsAutoBet.notify('BalanceChanged', { 
                                balance: parseFloat(balance.replace(/[^0-9.]/g, '')) 
                            });
                        }
                    });
                    const balanceEl = document.querySelector('.user-balance');
                    if (balanceEl) {
                        observer.observe(balanceEl, { childList: true, characterData: true, subtree: true });
                    }
                }
            };
            
            // å¯åŠ¨ç›‘å¬
            window.bsAutoBet.yd28.watchIssue();
            window.bsAutoBet.yd28.watchBalance();
        ";
    }
    
    public override string GetLoginScript(string username, string password)
    {
        return $@"
            (function() {{
                // å¡«å†™ç”¨æˆ·å
                document.querySelector('input[name=""username""]').value = '{username}';
                
                // å¡«å†™å¯†ç 
                document.querySelector('input[name=""password""]').value = '{password}';
                
                // ç‚¹å‡»ç™»å½•æŒ‰é’®
                document.querySelector('button.login-btn').click();
                
                // ç­‰å¾…ç™»å½•ç»“æœ
                setTimeout(() => {{
                    const isLoggedIn = document.querySelector('.user-info') !== null;
                    window.bsAutoBet.notify('LoginComplete', {{ success: isLoggedIn }});
                }}, 2000);
            }})();
        ";
    }
    
    public override string GetBalanceScript()
    {
        return @"
            (function() {
                const balanceText = document.querySelector('.user-balance')?.textContent;
                const balance = parseFloat(balanceText?.replace(/[^0-9.]/g, '') || '0');
                return balance;
            })();
        ";
    }
    
    public override string GetPlaceBetScript(BetOrder order)
    {
        return $@"
            (function() {{
                // 1. é€‰æ‹©ç©æ³•
                document.querySelector('[data-play=""{order.PlayType}""]').click();
                
                // 2. å¡«å†™é‡‘é¢
                document.querySelector('input.bet-amount').value = {order.Amount};
                
                // 3. é€‰æ‹©å·ç ï¼ˆæ ¹æ®ç©æ³•ï¼‰
                {GenerateNumberSelectionScript(order)}
                
                // 4. ç¡®è®¤æŠ•æ³¨
                document.querySelector('button.confirm-bet').click();
                
                // 5. ç­‰å¾…ç»“æœ
                setTimeout(() => {{
                    const success = document.querySelector('.bet-success') !== null;
                    const orderId = document.querySelector('.order-id')?.textContent;
                    window.bsAutoBet.notify('BetComplete', {{ 
                        success, 
                        orderId,
                        order: {JsonConvert.SerializeObject(order)}
                    }});
                }}, 1000);
            }})();
        ";
    }
    
    private string GenerateNumberSelectionScript(BetOrder order)
    {
        // æ ¹æ®ä¸åŒçš„ç©æ³•ç”Ÿæˆé€‰å·è„šæœ¬
        return order.PlayType switch
        {
            "å¤§å°" => $@"document.querySelector('[data-option=""{order.BetContent}""]').click();",
            "å•åŒ" => $@"document.querySelector('[data-option=""{order.BetContent}""]').click();",
            "ç‰¹ç " => $@"document.querySelector('[data-number=""{order.BetContent}""]').click();",
            _ => ""
        };
    }
    
    public override string GetBetRecordsScript()
    {
        return @"
            (function() {
                const records = [];
                document.querySelectorAll('.bet-record-item').forEach(item => {
                    records.push({
                        orderId: item.querySelector('.order-id')?.textContent,
                        issue: item.querySelector('.issue')?.textContent,
                        playType: item.querySelector('.play-type')?.textContent,
                        amount: parseFloat(item.querySelector('.amount')?.textContent || '0'),
                        status: item.querySelector('.status')?.textContent
                    });
                });
                return records;
            })();
        ";
    }
}
```

---

## ğŸ” Cookie éš”ç¦»æœºåˆ¶

### è¿›ç¨‹çº§éš”ç¦»

```csharp
// æ¯ä¸ªå®ä¾‹ç‹¬ç«‹çš„æ•°æ®ç›®å½•
UserDataDir: C:\Users\{User}\AppData\Local\BaiShengBrowser\UserData\{InstanceId}\
CacheDir:    C:\Users\{User}\AppData\Local\BaiShengBrowser\Cache\{InstanceId}\

// å®ä¾‹1
--user-data-dir="...\UserData\instance_1"
--cache-dir="...\Cache\instance_1"

// å®ä¾‹2
--user-data-dir="...\UserData\instance_2"
--cache-dir="...\Cache\instance_2"
```

### Cookie ç®¡ç†å™¨

```csharp
public class CookieManager
{
    private readonly ICookieManager _cefCookieManager;
    
    /// <summary>
    /// å¯¼å‡º Cookieï¼ˆä¿å­˜åˆ°æ•°æ®åº“ï¼‰
    /// </summary>
    public async Task<List<BrowserCookie>> ExportCookiesAsync(string url)
    {
        var visitor = new CookieVisitor();
        _cefCookieManager.VisitUrlCookies(url, true, visitor);
        return await visitor.GetCookiesAsync();
    }
    
    /// <summary>
    /// å¯¼å…¥ Cookieï¼ˆä»æ•°æ®åº“æ¢å¤ï¼‰
    /// </summary>
    public async Task ImportCookiesAsync(List<BrowserCookie> cookies)
    {
        foreach (var cookie in cookies)
        {
            await _cefCookieManager.SetCookieAsync(
                cookie.Url,
                new Cookie
                {
                    Name = cookie.Name,
                    Value = cookie.Value,
                    Domain = cookie.Domain,
                    Path = cookie.Path,
                    Expires = cookie.Expires,
                    HttpOnly = cookie.HttpOnly,
                    Secure = cookie.Secure
                });
        }
    }
}
```

---

## ğŸ¨ UI é›†æˆ

### å¿«é€Ÿè®¾ç½®é¢æ¿

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         å¿«é€Ÿè®¾ç½® - è‡ªåŠ¨æŠ•æ³¨              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  æ¸¸æˆå¹³å°: [ä¸‹æ‹‰é€‰æ‹©â–¼]                   â”‚
â”‚            â”œâ”€ äº‘é¡¶28                     â”‚
â”‚            â”œâ”€ ç‚³ç‹—28                     â”‚
â”‚            â”œâ”€ å¿«ä¹8                      â”‚
â”‚            â””â”€ ...                       â”‚
â”‚                                         â”‚
â”‚  è‡ªåŠ¨æŠ•æ³¨: [å¼€å¯] [å…³é—­]                 â”‚
â”‚                                         â”‚
â”‚  æµè§ˆå™¨çª—å£: [ ] æ˜¾ç¤ºæµè§ˆå™¨              â”‚
â”‚                                         â”‚
â”‚  æŠ•æ³¨è®¾ç½®:                               â”‚
â”‚    è·Ÿå•æ¨¡å¼: [ ] è‡ªåŠ¨è·Ÿå•                â”‚
â”‚    æœ€å°é‡‘é¢: [____]                     â”‚
â”‚    æœ€å¤§é‡‘é¢: [____]                     â”‚
â”‚                                         â”‚
â”‚  [å¯åŠ¨æµè§ˆå™¨] [åœæ­¢æµè§ˆå™¨]               â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š æ•°æ®æµå›¾

```
ä¸»ç¨‹åº (BaiShengVx3Plus)
   â”‚
   â”‚ 1. ç”¨æˆ·é€‰æ‹©å¹³å°å¹¶å¯åŠ¨
   â–¼
AutoBetManager.CreateInstance()
   â”‚
   â”‚ 2. å¯åŠ¨ç‹¬ç«‹æµè§ˆå™¨è¿›ç¨‹
   â–¼
BaiShengBrowser.exe --instance-id=xxx
   â”‚
   â”‚ 3. åˆå§‹åŒ– CEF + IPC æœåŠ¡å™¨
   â–¼
BrowserHost.Initialize()
   â”‚
   â”‚ 4. å»ºç«‹ IPC è¿æ¥
   â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
   â”‚                        â”‚
ä¸»ç¨‹åº                   æµè§ˆå™¨è¿›ç¨‹
   â”‚                        â”‚
   â”‚ 5. å‘é€åˆå§‹åŒ–å‘½ä»¤       â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚  InitializePlatform    â”‚
   â”‚                        â”‚
   â”‚                        â”‚ 6. åŠ è½½å¹³å°è„šæœ¬
   â”‚                        â–¼
   â”‚              LoadPlatformScript()
   â”‚                        â”‚
   â”‚                        â”‚ 7. æ³¨å…¥ JavaScript
   â”‚                        â–¼
   â”‚               InjectScript(yd28.js)
   â”‚                        â”‚
   â”‚ 8. æµè§ˆå™¨å°±ç»ªé€šçŸ¥       â”‚
   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚  BrowserReady Event    â”‚
   â”‚                        â”‚
   â”‚ 9. å‘é€ç™»å½•å‘½ä»¤         â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚  Login Command         â”‚
   â”‚                        â”‚
   â”‚                        â”‚ 10. æ‰§è¡Œç™»å½•è„šæœ¬
   â”‚                        â–¼
   â”‚               ExecuteScript(login)
   â”‚                        â”‚
   â”‚ 11. ç™»å½•å®Œæˆé€šçŸ¥        â”‚
   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚  LoginComplete Event   â”‚
   â”‚                        â”‚
   â”‚ 12. å‘é€æŠ•æ³¨å‘½ä»¤        â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚  PlaceBet Command      â”‚
   â”‚                        â”‚
   â”‚                        â”‚ 13. æ‰§è¡ŒæŠ•æ³¨è„šæœ¬
   â”‚                        â–¼
   â”‚               ExecuteScript(bet)
   â”‚                        â”‚
   â”‚ 14. æŠ•æ³¨ç»“æœé€šçŸ¥        â”‚
   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚  BetComplete Event     â”‚
   â”‚                        â”‚
   â”‚ 15. ä½™é¢å˜åŒ–é€šçŸ¥        â”‚
   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚  BalanceChanged Event  â”‚
```

---

## âœ… å®ç°ä¼˜å…ˆçº§

### Phase 1: åŸºç¡€æ¶æ„ (Week 1-2)
- [x] åˆ›å»ºé¡¹ç›®ç»“æ„
- [ ] å®ç° BaiShengBrowser.exe åŸºç¡€æ¡†æ¶
- [ ] å®ç° CEF å°è£… (BrowserHost)
- [ ] å®ç° IPC é€šä¿¡ (NamedPipe)
- [ ] å®ç° JavaScript æ¡¥æ¥ (JSBridge)

### Phase 2: å¹³å°è„šæœ¬ (Week 3)
- [ ] å®ç°å¹³å°è„šæœ¬æ¥å£ (IPlatformScript)
- [ ] å®ç°äº‘é¡¶28è„šæœ¬ (YunDing28Script)
- [ ] å®ç°ç‚³ç‹—28è„šæœ¬ (BingGo28Script)
- [ ] æµ‹è¯•è„šæœ¬æ³¨å…¥å’Œæ‰§è¡Œ

### Phase 3: ä¸»ç¨‹åºé›†æˆ (Week 4)
- [ ] å®ç° AutoBetService
- [ ] å®ç° AutoBetManager
- [ ] UI é›†æˆï¼ˆå¿«é€Ÿè®¾ç½®é¢æ¿ï¼‰
- [ ] æµ‹è¯•ç«¯åˆ°ç«¯æµç¨‹

### Phase 4: å¤šå®ä¾‹æ”¯æŒ (Week 5)
- [ ] å®Œå–„è¿›ç¨‹éš”ç¦»æœºåˆ¶
- [ ] å®ç° Cookie ç®¡ç†
- [ ] å¤šå®ä¾‹å¹¶å‘æµ‹è¯•

### Phase 5: ä¼˜åŒ–å’Œæ‰©å±• (Week 6+)
- [ ] æ€§èƒ½ä¼˜åŒ–
- [ ] é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
- [ ] æ›´å¤šå¹³å°è„šæœ¬
- [ ] æ–‡æ¡£å’Œç¤ºä¾‹

---

## ğŸ”§ æŠ€æœ¯é€‰å‹

| ç»„ä»¶ | æŠ€æœ¯é€‰æ‹© | åŸå›  |
|------|---------|------|
| æµè§ˆå™¨å†…æ ¸ | CEF (CefSharp) | æˆç†Ÿç¨³å®šï¼ŒChromium å†…æ ¸ï¼Œè„šæœ¬æ³¨å…¥å®¹æ˜“ |
| IPC é€šä¿¡ | Named Pipes | è·¨è¿›ç¨‹é€šä¿¡ï¼Œæ€§èƒ½å¥½ï¼Œé€‚åˆæœ¬åœ°è¿›ç¨‹ |
| åºåˆ—åŒ– | JSON (Newtonsoft.Json) | é€šç”¨ã€æ˜“è¯»ã€è°ƒè¯•æ–¹ä¾¿ |
| è„šæœ¬è¯­è¨€ | JavaScript | æµè§ˆå™¨åŸç”Ÿï¼Œæ“ä½œ DOM æ–¹ä¾¿ |
| æ¡†æ¶ç‰ˆæœ¬ | .NET 8 | æœ€æ–°ã€æ€§èƒ½æœ€ä½³ |

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **å®¡æ ¸è®¾è®¡æ–¹æ¡ˆ**ï¼šç¡®è®¤æ¶æ„è®¾è®¡æ˜¯å¦ç¬¦åˆéœ€æ±‚
2. **åˆ›å»ºé¡¹ç›®ç»“æ„**ï¼šå»ºç«‹è§£å†³æ–¹æ¡ˆå’Œé¡¹ç›®
3. **å®ç°åŸºç¡€æ¡†æ¶**ï¼šBrowserHost + IPC + JSBridge
4. **å¼€å‘ç¬¬ä¸€ä¸ªå¹³å°è„šæœ¬**ï¼šäº‘é¡¶28 ä½œä¸ºç¤ºä¾‹
5. **é›†æˆåˆ°ä¸»ç¨‹åº**ï¼šUI + æœåŠ¡

---

## ğŸ“š å‚è€ƒèµ„æ–™

- **CEF æ–‡æ¡£**: https://bitbucket.org/chromiumembedded/cef/wiki/Home
- **CefSharp æ–‡æ¡£**: https://github.com/cefsharp/CefSharp
- **Named Pipes**: https://learn.microsoft.com/en-us/dotnet/standard/io/pipe-operations
- **NPlans é¡¹ç›®**: å‚è€ƒå…¶æµè§ˆå™¨éš”ç¦»å’Œè¿›ç¨‹é€šä¿¡æœºåˆ¶

---

**è¿™ä¸ªè®¾è®¡æ–¹æ¡ˆæ˜¯ç°ä»£åŒ–ã€æ¨¡å—åŒ–ã€æ˜“æ‰©å±•çš„ï¼Œè¯·å®¡æ ¸åæˆ‘ä»¬å¼€å§‹å®æ–½ï¼** ğŸš€

