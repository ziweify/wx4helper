# 📋 剩余任务清单

## 当前进度：70%

### ✅ 已完成 (20个文件)
- P0: 核心模型、接口、服务、数据绑定

### ⏳ 剩余任务 (18个文件)

---

## 🔥 P1: 业务逻辑 (7个文件)

### 1. BinggoHelper.cs (下注解析器)
**参考**: `F5BotV2/Boter/BoterBetContent.cs`

**功能**:
- 解析下注文本 (例如: "123大单100", "1尾大50尾小60")
- 支持的玩法: 大、小、单、双、尾大、尾小、合单、合双、龙、虎
- 支持的车号: P1-P6 (总和)
- 中文数字转换: 一二三四五六总和
- 组合下注解析: "123大4小5单龙100"
- 正则表达式匹配
- 结算逻辑: 判断是否中奖

**关键方法**:
```csharp
public static BinggoBetContent ParseBetContent(string message, int issueId)
public static bool IsWin(BinggoBetContent bet, BinggoLotteryData lotteryData)
public static float CalculateProfit(BinggoBetContent bet, BinggoLotteryData lotteryData, float odds)
```

### 2. BinggoOrderValidator.cs (订单验证器)
**功能**:
- 验证余额是否充足
- 验证金额是否在限额范围内 (MinBet - MaxBet)
- 验证单期总投注是否超限
- 验证下注内容格式是否正确

### 3. BinggoOrderService.cs (订单服务)
**功能**:
- 创建订单
- 补单（手动创建+自动结算）
- 结算订单（批量+单个）
- 查询订单
- 生成结算汇总

**关键方法**:
```csharp
public async Task<V2MemberOrder?> CreateOrderAsync(...)
public async Task<V2MemberOrder?> CreateManualOrderAsync(...)  // 补单
public async Task<int> SettleOrdersAsync(int issueId, BinggoLotteryData? lotteryData)
public async Task<string> GetSettlementSummaryAsync(int issueId)
```

### 4. BinggoMessageHandler.cs (消息处理器)
**功能**:
- 处理微信下注消息
- 检查是否封盘
- 调用 OrderService 创建订单
- 生成回复消息

**集成**: 
- 更新 `MessageDispatcher.cs` 路由下注消息

---

## 🎨 P2: UI 和配置 (7个文件)

### 5. UcBinggoDataCur (当前期控件)
**布局**:
```
┌─────────────────────────────────────┐
│  当前期号: 20251106-001             │
│  状态: 🟢 开盘中                     │
│  倒计时: ⏱️ 245 秒                  │
│  ────────────────────────────       │
│  开奖号码: 待开奖...                 │
│  或: 🎲 1  2  3  4  5              │
│  总和: 15  大单  龙                │
└─────────────────────────────────────┘
```

**数据绑定**:
- 订阅 `BinggoLotteryService` 事件
- 倒计时每秒更新
- 状态颜色变化（绿=开盘，红=封盘，黄=开奖）

### 6. UcBinggoDataLast (上期控件)
**布局**:
```
┌─────────────────────────────────────┐
│  上期期号: 20251106-000             │
│  开奖号码: 🎲 3  5  7  9  11       │
│  总和: 35  大单  龙                │
│  ────────────────────────────       │
│  本期盈亏: +1,234.56                │
└─────────────────────────────────────┘
```

### 7. UcBinggoSettings (配置控件)
**UI 布局**:
```
┌─────────────────────────────────────┐
│  📊 赔率配置                         │
│  ├─ 大/小/单/双: [1.95]            │
│  ├─ 尾大/尾小: [1.95]              │
│  ├─ 合单/合双: [1.95]              │
│  └─ 龙/虎: [1.95]                  │
│                                      │
│  💰 限额配置                         │
│  ├─ 最小单注: [1]                   │
│  ├─ 最大单注: [10000]              │
│  └─ 单期最大: [50000]              │
│                                      │
│  ⏰ 封盘配置                         │
│  └─ 提前封盘: [30] 秒              │
│                                      │
│  💬 回复消息配置                     │
│  ├─ 下注成功: [已进仓！]            │
│  ├─ 余额不足: [客官你的荷包...]    │
│  └─ 已封盘: [已封盘，请等待下期！]  │
│                                      │
│  [💾 保存配置]  [🔄 恢复默认]       │
└─────────────────────────────────────┘
```

### 8. GameSettingsService (配置服务)
**功能**:
- 加载配置 (从 JSON 或数据库)
- 保存配置
- 提供默认配置
- 配置验证

---

## 🔗 集成 (2个文件)

### 9. Program.cs (依赖注入)
```csharp
// 注册服务
services.AddSingleton<IBsWebApiClient, BsWebApiClient>();
services.AddSingleton<IBsWebApiService, BsWebApiService>();
services.AddSingleton<IBinggoLotteryService, BinggoLotteryService>();
services.AddSingleton<IBinggoOrderService, BinggoOrderService>();

// 注册配置
services.AddSingleton(new BinggoGameSettings());
```

### 10. VxMain.cs (UI 集成)
**功能**:
- 初始化开奖服务
- 创建 BinggoLotteryDataBindingList
- 添加开奖数据 DataGridView
- 添加当前期/上期控件
- 订阅开奖事件
- 处理自动结算

**UI 布局调整**:
```
VxMain (980x762)
├─ ucUserInfo (顶部)
├─ 按钮组 (连接、日志、设置等)
├─ pnl_opendata (350x200)
│  ├─ UcBinggoDataCur (170x190)
│  └─ UcBinggoDataLast (170x190)
├─ dgvContacts (联系人列表)
├─ dgvMembers (会员表)
├─ dgvOrders (订单表)
└─ dgvLotteryData (开奖数据表) 🔥 新增
```

---

## 📝 文档 (2个文件)

### 11. 下注解析说明.md
- 解析规则说明
- 支持的格式示例
- 正则表达式说明

### 12. 完整功能测试指南.md
- 登录测试
- 开奖数据获取测试
- 下注处理测试
- 结算测试
- UI 功能测试

---

## ⏱️ 预计时间

- **P1 业务逻辑**: 2-3 个回复 (约 1500 行代码)
- **P2 UI 和配置**: 2-3 个回复 (约 800 行代码 + Designer)
- **集成**: 1 个回复 (约 200 行代码)
- **文档**: 包含在上述回复中

**总计**: 约 5-7 个回复完成

---

## 🚀 继续策略

由于回复长度限制，建议分批完成：

### 批次 1: 下注核心 (本回复)
- ✅ BinggoHelper.cs (基础版本)
- ✅ BinggoOrderValidator.cs
- ✅ BinggoOrderService.cs (基础版本)

### 批次 2: 消息处理
- BinggoMessageHandler.cs
- 更新 MessageDispatcher.cs

### 批次 3: UI 控件
- UcBinggoDataCur
- UcBinggoDataLast
- UcBinggoSettings

### 批次 4: 配置和集成
- GameSettingsService
- 更新 Program.cs
- 更新 VxMain.cs

### 批次 5: 完善和文档
- 完善所有功能
- 创建文档
- 测试

---

**准备继续批次 1...** 🚀

