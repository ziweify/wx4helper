# 命令系统实现完成

## ✅ 已完成功能

### 1. "查"命令（查询会员统计）✅
**命令格式**：`查` / `流水` / `货单`

**回复格式**：
```
@张三
流~~记录
今日/本轮进货:150.00/50.00
今日上/下:1000.00/500.00
今日盈亏:85.50
```

**实现位置**：
- `BinggoMessageHandler.HandleQueryCommand()`
- 直接读取会员的统计数据返回

### 2. "上分"命令（创建上分申请）✅
**命令格式**：`上` / `上1000` / `上分1000`

**回复格式**：
```
@张三
上分申请已提交
金额：1000.00
请等待管理员处理
```

**实现逻辑**：
1. 使用正则表达式解析金额：`@"^上(分)?(\d+)?$"`
2. 验证金额有效性（必须大于0）
3. 创建 `V2CreditWithdraw` 记录
   - Action = 上分
   - Status = 等待处理
4. 保存到数据库
5. 返回确认消息

**实现位置**：
- `BinggoMessageHandler.HandleCreditCommandAsync()`

### 3. "下分"命令（创建下分申请）✅
**命令格式**：`下` / `下500` / `下分500`

**回复格式**：
```
@张三
下分申请已提交
金额：500.00
当前余额：2250.00
请等待管理员处理
```

**实现逻辑**：
1. 使用正则表达式解析金额：`@"^下(分)?(\d+)?$"`
2. 验证金额有效性（必须大于0）
3. 检查余额是否足够
4. 创建 `V2CreditWithdraw` 记录
   - Action = 下分
   - Status = 等待处理
5. 保存到数据库
6. 返回确认消息

**实现位置**：
- `BinggoMessageHandler.HandleWithdrawCommandAsync()`

## 🔧 技术实现细节

### 命令优先级
在 `HandleMessageAsync()` 中按以下顺序处理：
1. 基础检查（null检查）
2. 过滤系统消息
3. ✅ 查询命令（优先级最高）
4. ✅ 上分命令
5. ✅ 下分命令
6. 下注命令（最后处理）

```csharp
// 🔥 3. 优先处理查询命令（查、流水、货单）
if (IsQueryCommand(messageContent))
{
    return (true, HandleQueryCommand(member));
}

// 🔥 4. 处理上分命令
if (IsCreditCommand(messageContent))
{
    return (true, await HandleCreditCommandAsync(member, messageContent));
}

// 🔥 5. 处理下分命令
if (IsWithdrawCommand(messageContent))
{
    return (true, await HandleWithdrawCommandAsync(member, messageContent));
}

// 6. 简单判断是否可能是下注消息
if (!LooksLikeBetMessage(messageContent))
{
    return (false, null);
}
```

### 数据库连接
- 添加了 `SQLiteConnection? _db` 字段到 `BinggoMessageHandler`
- 提供 `SetDatabase()` 方法供外部设置
- 构造函数支持可选参数 `db`

### 正则表达式
- **上分命令**：`@"^上(分)?(\d+)?$"`
  - 匹配：`上`、`上1000`、`上分1000`
- **下分命令**：`@"^下(分)?(\d+)?$"`
  - 匹配：`下`、`下500`、`下分500`

### 错误处理
- 所有命令都有try-catch异常处理
- 记录详细日志
- 返回友好的错误消息

## 📋 数据模型

### V2CreditWithdraw（上下分申请）
```csharp
public class V2CreditWithdraw
{
    public long Id { get; set; }                // 主键
    public string GroupWxId { get; set; }       // 群ID
    public string? Wxid { get; set; }           // 微信ID
    public string? Nickname { get; set; }       // 昵称
    public float Amount { get; set; }           // 金额
    public CreditWithdrawAction Action { get; set; }  // 上分/下分
    public CreditWithdrawStatus Status { get; set; }  // 等待/同意/拒绝
    public string TimeString { get; set; }      // 申请时间
    public long Timestamp { get; set; }         // 时间戳
    public string? Notes { get; set; }          // 备注
    public string? ProcessedBy { get; set; }    // 处理人
    public string? ProcessedTime { get; set; }  // 处理时间
}
```

### 枚举
```csharp
public enum CreditWithdrawAction 
{ 
    未知 = 0, 
    上分 = 1, 
    下分 = 2 
}

public enum CreditWithdrawStatus 
{ 
    等待处理 = 0, 
    已同意 = 1, 
    已拒绝 = 2 
}
```

## 🎯 测试用例

### 测试1：查询命令
**输入**：`查`
**预期输出**：
```
@张三
流~~记录
今日/本轮进货:150.00/50.00
今日上/下:1000.00/500.00
今日盈亏:85.50
```

### 测试2：上分命令（完整）
**输入**：`上1000`
**预期输出**：
```
@张三
上分申请已提交
金额：1000.00
请等待管理员处理
```
**数据库**：应该有一条Status=等待处理的记录

### 测试3：上分命令（无金额）
**输入**：`上`
**预期输出**：`请输入上分金额，例如：上1000`

### 测试4：下分命令（完整）
**输入**：`下500`
**前提**：余额 >= 500
**预期输出**：
```
@张三
下分申请已提交
金额：500.00
当前余额：2250.00
请等待管理员处理
```

### 测试5：下分命令（余额不足）
**输入**：`下5000`
**前提**：余额 < 5000
**预期输出**：
```
@张三
余额不足！
当前余额：1250.00
```

### 测试6：命令优先级
**输入**：`123查大10`（包含"查"和下注内容）
**预期**：优先识别为查询命令，不会作为下注处理

## 📊 修改文件清单

### 修改的文件
1. **BaiShengVx3Plus/Services/Messages/Handlers/BinggoMessageHandler.cs**
   - 添加 `_db` 字段
   - 添加 `SetDatabase()` 方法
   - 修改 `HandleMessageAsync()` 方法，添加命令优先处理
   - 添加 `IsQueryCommand()` 方法
   - 添加 `HandleQueryCommand()` 方法
   - 添加 `IsCreditCommand()` 方法
   - 添加 `HandleCreditCommandAsync()` 方法
   - 添加 `IsWithdrawCommand()` 方法
   - 添加 `HandleWithdrawCommandAsync()` 方法
   - 添加 using 引用：`System.Text.RegularExpressions`、`SQLite`

## ⏳ 待完成功能

### 1. 在VxMain中设置数据库
需要在 `VxMain.cs` 的初始化方法中添加：
```csharp
_binggoMessageHandler.SetDatabase(_db);
```

### 2. 上下分管理窗口
- ❌ 创建 `CreditWithdrawManageForm.cs` 和 `.Designer.cs`
- ❌ 实现UI布局（DataGridView + 按钮）
- ❌ 实现数据加载和筛选
- ❌ 实现"同意"按钮逻辑
- ❌ 实现"拒绝"按钮逻辑

### 3. 在VxMain添加按钮
- ❌ 在开奖结果按钮旁边添加"上下分管理"按钮
- ❌ 点击打开 `CreditWithdrawManageForm` 窗口

### 4. 上下分处理逻辑
同意上分：
1. 增加会员余额
2. 更新 `CreditToday`、`CreditTotal`
3. 记录到资金变动表
4. 发送微信通知

同意下分：
1. 减少会员余额
2. 更新 `WithdrawToday`、`WithdrawTotal`
3. 记录到资金变动表
4. 发送微信通知

### 5. 资金变动记录集成
- ❌ 在下注时记录（`CreateOrderAsync`）
- ❌ 在结算时记录（`SettleSingleOrderAsync`）
- ❌ 在上分处理时记录
- ❌ 在下分处理时记录

## ✅ 编译状态
- 编译成功，0个错误
- 10个警告（可忽略的null引用警告）

## 🎉 完成进度

| 任务 | 状态 |
|------|------|
| "查"命令 | ✅ 已完成 |
| "上分"命令 | ✅ 已完成 |
| "下分"命令 | ✅ 已完成 |
| 上下分管理窗口 | ⏳ 待实现 |
| 处理逻辑 | ⏳ 待实现 |
| 资金变动集成 | ⏳ 待实现 |
| **总体进度** | **50%** |

## 📝 使用说明

### 会员使用
1. **查询统计**：在群里发送 `查`
2. **申请上分**：在群里发送 `上1000`
3. **申请下分**：在群里发送 `下500`
4. 等待管理员在上下分管理窗口处理

### 管理员使用（待实现）
1. 打开"上下分管理"窗口
2. 查看待处理申请列表
3. 点击"同意"或"拒绝"
4. 系统自动：
   - 更新会员余额
   - 记录资金变动
   - 发送微信通知

## ⚠️ 注意事项

1. **数据库初始化**：确保 `V2CreditWithdraw` 表已创建
2. **线程安全**：数据库操作在消息处理线程中执行
3. **错误处理**：所有命令都有异常捕获和日志记录
4. **余额检查**：下分时必须检查余额
5. **命令优先级**：查询和上下分命令优先于下注命令

