# âœ… æµè§ˆå™¨çª—å£ç”Ÿå‘½å‘¨æœŸç®¡ç†å®Œå–„

## ğŸ“… 2025-11-07

## ğŸ¯ æ ¸å¿ƒæ”¹è¿›

### 1ï¸âƒ£ çª—å£å…³é—­ = éšè—ï¼ˆä¸é€€å‡ºè¿›ç¨‹ï¼‰

**ä¹‹å‰çš„é—®é¢˜**ï¼š
- âŒ ç”¨æˆ·ç‚¹å‡»å…³é—­æŒ‰é’® â†’ è¿›ç¨‹ç›´æ¥é€€å‡º
- âŒ å†æ¬¡ç‚¹å‡»"å¯åŠ¨æµè§ˆå™¨"â†’ æç¤º"æµè§ˆå™¨å·²å­˜åœ¨"ï¼ˆä½†å®é™…å·²é€€å‡ºï¼‰
- âŒ é€»è¾‘æ··ä¹±ï¼Œç”¨æˆ·ä½“éªŒå·®

**ç°åœ¨çš„å®ç°**ï¼š
```csharp
// BsBrowserClient/Form1.cs
private void Form1_FormClosing(object sender, FormClosingEventArgs e)
{
    // æ‹¦æˆªå…³é—­äº‹ä»¶ï¼Œæ”¹ä¸ºéšè—çª—å£
    if (e.CloseReason == CloseReason.UserClosing)
    {
        e.Cancel = true; // å–æ¶ˆå…³é—­
        this.Hide();     // éšè—çª—å£
        OnLogMessage($"çª—å£å·²éšè—ï¼ˆè¿›ç¨‹ä»åœ¨è¿è¡Œï¼‰");
    }
    else
    {
        // ç¨‹åºé€€å‡ºæ—¶æ‰çœŸæ­£æ¸…ç†èµ„æº
        _socketServer?.Stop();
        _webView?.Dispose();
    }
}
```

### 2ï¸âƒ£ çª—å£æ ‡é¢˜åŒ…å«é…ç½®IDï¼ˆç”¨äºè¯†åˆ«ï¼‰

**ä¹‹å‰**ï¼š
```csharp
this.Text = $"ç™¾ç››æµè§ˆå™¨ - {platform} (é…ç½®: {configId}, ç«¯å£: {port})";
```

**ç°åœ¨**ï¼š
```csharp
// è®¾ç½®çª—å£æ ‡é¢˜ï¼ˆåŒ…å«é…ç½®IDç”¨äºè¯†åˆ«ï¼‰
this.Text = $"BsBrowser-{configId}";

// çŠ¶æ€æ æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
lblPort.Text = $"ç«¯å£: {port} | å¹³å°: {platform} | é…ç½®: {configId}";
```

**ä½œç”¨**ï¼š
- âœ… çª—å£æ ‡é¢˜æ ¼å¼ç»Ÿä¸€ï¼š`BsBrowser-{configId}`
- âœ… å¯ä»¥é€šè¿‡çª—å£æ ‡é¢˜å¿«é€Ÿè¯†åˆ«é…ç½®
- âœ… ä¸ºåç»­"å­¤å„¿è¿›ç¨‹"æ¢å¤æœºåˆ¶å¥ å®šåŸºç¡€

### 3ï¸âƒ£ æ–°å¢å‘½ä»¤ï¼šShow / Hide / Ping

```csharp
// BsBrowserClient/Form1.cs - OnCommandReceived()

case "show":
    // æ˜¾ç¤ºçª—å£
    this.Show();
    this.WindowState = FormWindowState.Normal;
    this.Activate();
    response.Success = true;
    response.Message = "çª—å£å·²æ˜¾ç¤º";
    break;
    
case "hide":
    // éšè—çª—å£
    this.Hide();
    response.Success = true;
    response.Message = "çª—å£å·²éšè—";
    break;
    
case "ping":
    // å¿ƒè·³æ£€æµ‹
    response.Success = true;
    response.Message = "Pong";
    response.Data = new 
    { 
        configId = _configId,
        platform = _platform,
        processId = Environment.ProcessId
    };
    break;
```

### 4ï¸âƒ£ å®Œå–„çš„çŠ¶æ€æ£€æµ‹é€»è¾‘

```csharp
// BaiShengVx3Plus/Services/AutoBet/AutoBetService.cs

public async Task<bool> StartBrowser(int configId)
{
    // æ£€æŸ¥æ˜¯å¦å·²æœ‰æµè§ˆå™¨å®ä¾‹
    if (_browsers.TryGetValue(configId, out var existingBrowserClient))
    {
        // 1. Ping æ£€æµ‹ï¼ˆSocketè¿æ¥ + è¿›ç¨‹çŠ¶æ€ï¼‰
        var (isAlive, processId) = await existingBrowserClient.PingAsync();
        
        if (isAlive && existingBrowserClient.IsProcessRunning)
        {
            // âœ… æµè§ˆå™¨åœ¨çº¿ä¸”è¿›ç¨‹è¿è¡Œä¸­ï¼Œæ˜¾ç¤ºçª—å£
            _log.Info("AutoBet", $"æµè§ˆå™¨å·²è¿è¡Œï¼ˆPID: {processId}ï¼‰ï¼Œæ˜¾ç¤ºçª—å£");
            await existingBrowserClient.ShowWindowAsync();
            return true;
        }
        else if (existingBrowserClient.IsProcessRunning)
        {
            // âš ï¸ è¿›ç¨‹è¿è¡Œä½†è¿æ¥æ–­å¼€ï¼Œå°è¯•é‡æ–°è¿æ¥
            _log.Warning("AutoBet", $"æµè§ˆå™¨è¿›ç¨‹è¿è¡Œä½†è¿æ¥æ–­å¼€ï¼Œå°è¯•é‡æ–°è¿æ¥");
            var reconnected = await existingBrowserClient.ReconnectAsync(port);
            
            if (reconnected)
            {
                _log.Info("AutoBet", $"âœ… é‡æ–°è¿æ¥æˆåŠŸ");
                await existingBrowserClient.ShowWindowAsync();
                return true;
            }
        }
        
        // âŒ è¿›ç¨‹å·²é€€å‡ºæˆ–æ— æ³•æ¢å¤ï¼Œæ¸…ç†å¹¶é‡å¯
        _log.Warning("AutoBet", $"æµè§ˆå™¨è¿›ç¨‹å·²é€€å‡ºï¼Œé‡æ–°å¯åŠ¨");
        existingBrowserClient.Dispose();
        _browsers.Remove(configId);
    }
    
    // å¯åŠ¨æ–°çš„æµè§ˆå™¨è¿›ç¨‹...
}
```

### 5ï¸âƒ£ BrowserClient æ–°å¢æ–¹æ³•

```csharp
// BaiShengVx3Plus/Services/AutoBet/BrowserClient.cs

/// <summary>
/// æ˜¾ç¤ºçª—å£ï¼ˆé€šè¿‡ Socket å‘½ä»¤ï¼‰
/// </summary>
public async Task<bool> ShowWindowAsync()
{
    // ä¼˜å…ˆä½¿ç”¨ Socket å‘½ä»¤
    // å¤±è´¥åˆ™ä½¿ç”¨ Windows APIï¼ˆå¤‡ç”¨ï¼‰
}

/// <summary>
/// æ£€æŸ¥æµè§ˆå™¨çŠ¶æ€ï¼ˆPingï¼‰
/// </summary>
public async Task<(bool IsAlive, int ProcessId)> PingAsync()
{
    // å‘é€ Ping å‘½ä»¤ï¼Œè¿”å›è¿›ç¨‹ID
}

/// <summary>
/// é‡æ–°è¿æ¥ï¼ˆç”¨äº VxMain é‡å¯åæ¢å¤è¿æ¥ï¼‰
/// </summary>
public async Task<bool> ReconnectAsync(int port)
{
    // é‡æ–°å»ºç«‹ Socket è¿æ¥
}
```

## ğŸ“‹ å·¥ä½œæµç¨‹å›¾

### ç”¨æˆ·ç‚¹å‡»"å¯åŠ¨æµè§ˆå™¨"

```
[ç”¨æˆ·ç‚¹å‡»"å¯åŠ¨æµè§ˆå™¨"]
        â†“
[AutoBetService.StartBrowser(configId)]
        â†“
[æ£€æŸ¥ _browsers æ˜¯å¦å­˜åœ¨ configId]
        â†“
    â”Œâ”€â”€â”€YESâ”€â”€â”€â”
    â†“         â†“
[Ping æ£€æµ‹]  [ä¸å­˜åœ¨]
    â†“         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ping æˆåŠŸ + è¿›ç¨‹è¿è¡Œï¼Ÿ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“YES     â†“NO
[ShowWindow] [è¿›ç¨‹è¿è¡Œä½†è¿æ¥æ–­å¼€ï¼Ÿ]
    â†“         â†“YES        â†“NO
[ç»“æŸ]    [Reconnect]  [Dispose + é‡å¯]
            â†“æˆåŠŸ
        [ShowWindow]
            â†“
          [ç»“æŸ]
```

### ç”¨æˆ·å…³é—­æµè§ˆå™¨çª—å£

```
[ç”¨æˆ·ç‚¹å‡» X å…³é—­çª—å£]
        â†“
[Form1_FormClosing]
        â†“
[CloseReason == UserClosing?]
        â†“YES
    [e.Cancel = true]
        â†“
    [this.Hide()]
        â†“
[è¿›ç¨‹ç»§ç»­è¿è¡Œï¼ŒSocket ä¿æŒè¿æ¥]
        â†“
[ç”¨æˆ·å†æ¬¡ç‚¹å‡»"å¯åŠ¨æµè§ˆå™¨"]
        â†“
    [Ping æˆåŠŸ]
        â†“
  [ShowWindow]
        â†“
  [çª—å£é‡æ–°æ˜¾ç¤º]
```

## ğŸ”„ VxMain é‡å¯åçš„æ¢å¤æœºåˆ¶ï¼ˆå¾…å®ç°ï¼‰

### åœºæ™¯
1. ç”¨æˆ·å¯åŠ¨æµè§ˆå™¨ï¼ˆBsBrowserClientï¼‰
2. å…³é—­ VxMain ä¸»ç¨‹åº
3. BsBrowserClient è¿›ç¨‹ä»åœ¨è¿è¡Œ
4. é‡æ–°å¯åŠ¨ VxMain

### é¢„æœŸè¡Œä¸º
- VxMain å¯åŠ¨æ—¶ï¼Œæ‰«ææ‰€æœ‰è¿è¡Œä¸­çš„ `BsBrowser-*` çª—å£
- é€šè¿‡çª—å£æ ‡é¢˜æå– `configId`
- å°è¯•é‡æ–°è¿æ¥ï¼ˆ`ReconnectAsync`ï¼‰
- æ›´æ–°é…ç½®è¡¨ä¸­çš„è¿›ç¨‹IDã€çŠ¶æ€ç­‰ä¿¡æ¯

### å®ç°æ–¹æ¡ˆï¼ˆå¾…å¼€å‘ï¼‰
```csharp
// VxMain å¯åŠ¨æ—¶è°ƒç”¨
public async Task ScanAndRecoverBrowsers()
{
    // 1. ä½¿ç”¨ Windows API æšä¸¾æ‰€æœ‰çª—å£
    // 2. ç­›é€‰æ ‡é¢˜åŒ¹é… "BsBrowser-*" çš„çª—å£
    // 3. æå– configId
    // 4. è°ƒç”¨ BrowserClient.ReconnectAsync()
    // 5. æ›´æ–°é…ç½®çŠ¶æ€
}
```

## ğŸ’¾ æ•°æ®åº“è¡¨æ›´æ–°ï¼ˆå»ºè®®ï¼‰

### BetConfig è¡¨å»ºè®®æ–°å¢å­—æ®µ
```sql
-- è¿›ç¨‹IDï¼ˆç”¨äºéªŒè¯è¿›ç¨‹æ˜¯å¦å­˜åœ¨ï¼‰
ProcessId INTEGER

-- çª—å£å¥æŸ„ï¼ˆç”¨äº Windows API æ“ä½œï¼‰
WindowHandle INTEGER

-- æœ€åå¿ƒè·³æ—¶é—´ï¼ˆç”¨äºåˆ¤æ–­æ˜¯å¦åœ¨çº¿ï¼‰
LastPingTime TEXT
```

## âœ… ç¼–è¯‘ç»“æœ

```
å·²æˆåŠŸç”Ÿæˆã€‚
  BaiShengVx3Plus.Shared -> BaiShengVx3Plus.Shared.dll
  BsBrowserClient -> BsBrowserClient.dll
  BaiShengVx3Plus -> BaiShengVx3Plus.dll
  
  å¢é‡å¤åˆ¶å®Œæˆ: 10 ä¸ªæ–‡ä»¶
  
  12 ä¸ªè­¦å‘Š
  0 ä¸ªé”™è¯¯ âœ…
```

## ğŸŠ æ€»ç»“

### å·²å®Œæˆ

1. âœ… **çª—å£å…³é—­æ”¹ä¸ºéšè—**ï¼šç”¨æˆ·ç‚¹å‡»å…³é—­æŒ‰é’®ä¸å†é€€å‡ºè¿›ç¨‹
2. âœ… **çª—å£æ ‡é¢˜è§„èŒƒåŒ–**ï¼š`BsBrowser-{configId}` æ ¼å¼
3. âœ… **æ–°å¢ Show/Hide/Ping å‘½ä»¤**ï¼šSocket è¿œç¨‹æ§åˆ¶çª—å£
4. âœ… **å®Œå–„çŠ¶æ€æ£€æµ‹é€»è¾‘**ï¼šPing + è¿›ç¨‹æ£€æµ‹ + é‡è¿æœºåˆ¶
5. âœ… **åŒé‡æ˜¾ç¤ºçª—å£æ–¹æ³•**ï¼šSocket å‘½ä»¤ + Windows API å¤‡ç”¨

### å¾…å®Œæˆ

1. â³ **VxMain é‡å¯åçš„æµè§ˆå™¨æ¢å¤æœºåˆ¶**
   - æ‰«æè¿è¡Œä¸­çš„ `BsBrowser-*` çª—å£
   - é€šè¿‡æ ‡é¢˜åŒ¹é…é…ç½®
   - é‡æ–°å»ºç«‹è¿æ¥

2. â³ **é…ç½®è¡¨å­—æ®µæ‰©å±•**
   - `ProcessId`ï¼šè¿›ç¨‹ID
   - `WindowHandle`ï¼šçª—å£å¥æŸ„
   - `LastPingTime`ï¼šæœ€åå¿ƒè·³æ—¶é—´

3. â³ **å®šæ—¶å¿ƒè·³æ£€æµ‹**
   - æ¯éš”ä¸€æ®µæ—¶é—´ Ping æ‰€æœ‰æµè§ˆå™¨
   - æ›´æ–°åœ¨çº¿çŠ¶æ€
   - è‡ªåŠ¨æ¸…ç†å¤±æ•ˆçš„è¿æ¥

### ç”¨æˆ·ä½“éªŒæå‡

- âœ… **å…³é—­çª—å£ä¸å†é€€å‡ºè¿›ç¨‹**ï¼Œé¿å…æ„å¤–å…³é—­
- âœ… **å†æ¬¡ç‚¹å‡»"å¯åŠ¨æµè§ˆå™¨"ç›´æ¥æ˜¾ç¤ºçª—å£**ï¼Œå“åº”æ›´å¿«
- âœ… **æ™ºèƒ½çŠ¶æ€æ£€æµ‹**ï¼Œå‡†ç¡®åˆ¤æ–­æµè§ˆå™¨æ˜¯å¦åœ¨çº¿
- âœ… **æ–­çº¿é‡è¿**ï¼ŒVxMain é‡å¯åå¯æ¢å¤è¿æ¥

---

**ç°ä»£åŒ–ã€ç®€çº¦ã€å¯é ï¼** ğŸš€

