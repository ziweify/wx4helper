# âœ… ç»Ÿä¸€æœŸå·åˆ‡æ¢æµç¨‹ - æ ¹æœ¬ä¿®å¤

## ğŸ“‹ é—®é¢˜æ ¹æºåˆ†æ

### ç”¨æˆ·æ·±åº¦åé¦ˆ
> "ä½ ä»”ç»†æ£€æŸ¥ä¸‹é€»è¾‘ï¼Œæ·±å…¥åˆ†æä¸‹ï¼Œå¯åŠ¨åï¼Œä¸ºä»€ä¹ˆå½“å‰æœŸå·æœ‰äº†ï¼Œä¸ŠæœŸæœŸå·è¿˜æ˜¯æ²¡æœ‰ï¼Œè¿˜æ˜¯ç©ºç™½çš„ï¼ŒæœŸå·åˆ‡æ¢çš„æ—¶å€™åº”è¯¥ç«‹å³è®¾ç½®ï¼Œå½“å‰æœŸå·ï¼Œå’Œä¸ŠæœŸæœŸå·æ•°æ®ï¼Œå¹¶æ›´æ–°å¼€å¥–ï¼Œæœ‰æ•°æ®å°±æ˜¾ç¤ºæ•°æ®ï¼Œæ— æ•°æ®å°±ç»§ç»­å¼€å¥–ï¼Œç­‰å¾…å¼€å¥–é€šçŸ¥åˆ°æ¥ã€‚è¯·ä»”ç»†å‚è€ƒF5BotV2çš„åšæ³•å¹¶è¿›è¡Œä¼˜åŒ–ã€‚è¿™ä¸ªé—®é¢˜æˆ‘ä»¬å¤„ç†å¾ˆä¹…äº†ã€‚ä½ æ¢³ç†ä¸‹æµç¨‹ï¼Œæ˜¯ä¸æ˜¯åˆšå¯åŠ¨çš„æ—¶å€™ï¼Œå½“å‰æœŸå·æ˜¯è®¾ç½®ä¸Šå»çš„ï¼Œæ²¡æœ‰è¿›å…¥åˆ°æœŸå·åˆ‡æ¢è¿‡ç¨‹ï¼Œé‚£è¯·ä½¿ç”¨ç»Ÿä¸€çš„åˆ‡æ¢æµç¨‹æ¥å¤„ç†ã€‚"

**é—®é¢˜æ ¸å¿ƒï¼šé¦–æ¬¡åˆå§‹åŒ–å’ŒæœŸå·å˜æ›´èµ°äº†ä¸åŒçš„é€»è¾‘è·¯å¾„ï¼**

---

## ğŸ” é—®é¢˜æµç¨‹å¯¹æ¯”

### âŒ ä¿®å¤å‰çš„æµç¨‹ï¼ˆ2æ¡è·¯å¾„ï¼‰

#### è·¯å¾„1ï¼šé¦–æ¬¡åˆå§‹åŒ–ï¼ˆå¯åŠ¨æ—¶ï¼‰
```csharp
if (_currentIssueId == 0)
{
    // é¦–æ¬¡åˆå§‹åŒ–
    _currentIssueId = localIssueId;
    _logService.Info("BinggoLotteryService", $"âœ… åˆå§‹åŒ–å½“å‰æœŸå·: {localIssueId}");
    
    // âŒ è°ƒç”¨ LoadPreviousLotteryDataAsyncï¼ˆåªæ˜¯åŠ è½½æ•°æ®ï¼‰
    _ = LoadPreviousLotteryDataAsync(BinggoTimeHelper.GetPreviousIssueId(localIssueId));
}
```

**é—®é¢˜ï¼š**
- âŒ æ²¡æœ‰è§¦å‘ `IssueChanged` äº‹ä»¶
- âŒ `UcBinggoDataCur` æ”¶ä¸åˆ°é€šçŸ¥ â†’ å½“å‰æœŸå·ä¸æ˜¾ç¤º
- âŒ `UcBinggoDataLast` æ”¶ä¸åˆ°é€šçŸ¥ â†’ ä¸ŠæœŸæœŸå·ä¸æ˜¾ç¤º
- âŒ å¿…é¡»ç­‰åˆ° API è¿”å›æ•°æ®åæ‰ä¼šæ˜¾ç¤º

#### è·¯å¾„2ï¼šæœŸå·å˜æ›´ï¼ˆè¿è¡Œä¸­ï¼‰
```csharp
if (_currentIssueId != 0)
{
    // æœŸå·å˜æ›´ï¼Œè§¦å‘å¼€å¥–é€»è¾‘
    var previousIssueId = _currentIssueId;
    _currentIssueId = localIssueId;
    
    // âœ… è°ƒç”¨ HandleIssueChangeAsync
    _ = HandleIssueChangeAsync(previousIssueId, localIssueId);
}
```

**æ­£ç¡®ï¼š**
- âœ… è§¦å‘ `IssueChanged` äº‹ä»¶
- âœ… `UcBinggoDataCur` ç«‹å³æ˜¾ç¤ºå½“å‰æœŸå·å’Œæ—¶é—´
- âœ… `UcBinggoDataLast` ç«‹å³æ˜¾ç¤ºä¸ŠæœŸæœŸå·å’Œæ—¶é—´ï¼ˆå·ç ä¸º âœ±ï¼‰

---

### âœ… ä¿®å¤åçš„æµç¨‹ï¼ˆç»Ÿä¸€è·¯å¾„ï¼‰

```csharp
// ğŸ”¥ æ£€æŸ¥æœŸå·å˜æ›´ï¼ˆé¦–æ¬¡åˆå§‹åŒ–ä¹Ÿèµ°ç»Ÿä¸€æµç¨‹ï¼‰
if (localIssueId != _currentIssueId)
{
    int previousIssueId = _currentIssueId;
    
    if (_currentIssueId == 0)
    {
        // ğŸ”¥ é¦–æ¬¡åˆå§‹åŒ–ï¼šè®¡ç®—ä¸Šä¸€æœŸ
        previousIssueId = BinggoTimeHelper.GetPreviousIssueId(localIssueId);
        _logService.Info("BinggoLotteryService", $"âœ… é¦–æ¬¡åˆå§‹åŒ–: å½“å‰æœŸå·={localIssueId}, ä¸ŠæœŸæœŸå·={previousIssueId}");
    }
    else
    {
        _logService.Info("BinggoLotteryService", $"ğŸ”„ æœŸå·å˜æ›´: {previousIssueId} â†’ {localIssueId}");
    }
    
    // ğŸ”¥ ç»Ÿä¸€çš„æœŸå·åˆ‡æ¢æµç¨‹ï¼ˆé¦–æ¬¡åˆå§‹åŒ–å’ŒæœŸå·å˜æ›´éƒ½èµ°è¿™é‡Œï¼‰
    _currentIssueId = localIssueId;
    _ = HandleIssueChangeAsync(previousIssueId, localIssueId);
}
```

**å…³é”®ç‚¹ï¼š**
- âœ… **ç»Ÿä¸€è·¯å¾„**ï¼šé¦–æ¬¡åˆå§‹åŒ–å’ŒæœŸå·å˜æ›´éƒ½è°ƒç”¨ `HandleIssueChangeAsync`
- âœ… **è§¦å‘äº‹ä»¶**ï¼šéƒ½ä¼šè§¦å‘ `IssueChanged` äº‹ä»¶
- âœ… **ç«‹å³æ˜¾ç¤º**ï¼šUI ç«‹å³æ˜¾ç¤ºæœŸå·å’Œæ—¶é—´ï¼ˆæ— éœ€ç­‰å¾… APIï¼‰

---

## ğŸ”¥ å®Œæ•´æµç¨‹å›¾

### å¯åŠ¨åçš„æµç¨‹

```
æ—¶é—´è½´ï¼š
00:00:00 - åº”ç”¨å¯åŠ¨
         â†“
00:00:01 - Timer ç¬¬ä¸€æ¬¡ Tick
         â†“
         BinggoLotteryService.OnTimerTickAsync()
         â”œâ”€ localIssueId = BinggoTimeHelper.GetCurrentIssueId()  // 111065586
         â”œâ”€ _currentIssueId == 0ï¼Ÿ â†’ YESï¼ˆé¦–æ¬¡åˆå§‹åŒ–ï¼‰
         â”œâ”€ previousIssueId = BinggoTimeHelper.GetPreviousIssueId(111065586)  // 111065585
         â”œâ”€ _currentIssueId = 111065586
         â””â”€ HandleIssueChangeAsync(111065585, 111065586)
            â†“
            â”œâ”€ åˆ›å»ºå½“å‰æœŸæ•°æ®ï¼ˆIssueId=111065586, OpenTime=23:57:00ï¼‰
            â”œâ”€ åˆ›å»ºä¸ŠæœŸæ•°æ®ï¼ˆIssueId=111065585, OpenTime=23:56:00, IsOpened=falseï¼‰
            â””â”€ è§¦å‘ IssueChanged äº‹ä»¶
               â†“
               â”œâ”€ UcBinggoDataCur.OnIssueChanged()
               â”‚  â””â”€ ç«‹å³æ˜¾ç¤ºï¼šæœŸå·: 111065586 | 23:57:00
               â”‚
               â””â”€ UcBinggoDataLast.OnIssueChanged()
                  â””â”€ ç«‹å³æ˜¾ç¤ºï¼šæœŸå·: 111065585 | 23:56:00 | âœ± âœ± âœ± âœ± âœ± âœ±
                     â””â”€ å¯åŠ¨é—ªçƒåŠ¨ç”»ï¼ˆé‡‘é»„è‰² â‡„ äº®é»„è‰²ï¼‰
         â†“
00:00:05 - API è¿”å›ä¸ŠæœŸå¼€å¥–æ•°æ®
         â†“
         UcBinggoDataLast.OnLotteryOpened()
         â””â”€ æ›´æ–°æ˜¾ç¤ºï¼šæœŸå·: 111065585 | 23:56:00 | 25 49 38 60 80 252
            â””â”€ åœæ­¢é—ªçƒåŠ¨ç”»
```

---

## ğŸ“Š å¯¹æ¯” F5BotV2 çš„è®¾è®¡

### F5BotV2 çš„é€»è¾‘

```csharp
// MainView.cs - BoterServices_BoterStatusChange
case BoterStatus.æœŸå·å˜æ›´:
    // å½“å‰æœŸæ•°æ®
    var dataCur = new BgLotteryData()
    {
        IssueId = issueid,
        opentime = BinGouHelper.getOpenDatetime(issueid).ToString(),
    };
    ucLotteryDataCur.LotteryUpdata(dataCur);  // ğŸ‘ˆ ç«‹å³æ›´æ–°å½“å‰æœŸ

    // ä¸ŠæœŸæ•°æ®
    var dataLast = new BgLotteryData()
    {
        IssueId = issueid - 1,
        opentime = BinGouHelper.getOpenDatetime(issueid - 1).ToString(),
    };
    ucLotteryDataLast.LotteryUpdata(dataLast);  // ğŸ‘ˆ ç«‹å³æ›´æ–°ä¸ŠæœŸ
    break;
```

**æ ¸å¿ƒé€»è¾‘ï¼š**
- âœ… æœŸå·å˜æ›´æ—¶ï¼Œç«‹å³åˆ›å»ºå½“å‰æœŸå’Œä¸ŠæœŸçš„ç©ºæ•°æ®å¯¹è±¡
- âœ… ç›´æ¥è°ƒç”¨ UI çš„ `LotteryUpdata` æ–¹æ³•
- âœ… å…ˆæ˜¾ç¤ºæœŸå·å’Œæ—¶é—´ï¼Œåæ˜¾ç¤ºå·ç 

### æˆ‘ä»¬çš„å®ç°ï¼ˆå®Œå…¨å¯¹åº”ï¼‰

```csharp
// BinggoLotteryService.cs - HandleIssueChangeAsync
private async Task HandleIssueChangeAsync(int oldIssueId, int newIssueId)
{
    // ğŸ”¥ å‚è€ƒ F5BotV2: ç«‹å³åˆ›å»ºç©ºçš„ä¸ŠæœŸæ•°æ®å¯¹è±¡
    var dataLast = new BinggoLotteryData
    {
        IssueId = oldIssueId,
        OpenTime = BinggoTimeHelper.GetIssueOpenTime(oldIssueId).ToString("yyyy-MM-dd HH:mm:ss")
    };
    
    // è§¦å‘æœŸå·å˜æ›´äº‹ä»¶ï¼ˆä¼ å…¥ç©ºçš„ä¸ŠæœŸæ•°æ®ï¼‰
    IssueChanged?.Invoke(this, new BinggoIssueChangedEventArgs
    {
        OldIssueId = oldIssueId,
        NewIssueId = newIssueId,
        LastLotteryData = dataLast  // ğŸ‘ˆ ä¸ŠæœŸæ•°æ®ï¼ˆå·ç ä¸ºç©ºï¼‰
    });
    
    // å¼‚æ­¥åŠ è½½ä¸ŠæœŸå¼€å¥–æ•°æ®
    await LoadPreviousLotteryDataAsync(oldIssueId);
}

// UcBinggoDataCur.cs - OnIssueChanged
private void OnIssueChanged(object? sender, BinggoIssueChangedEventArgs e)
{
    // ğŸ”¥ ç«‹å³æ˜¾ç¤ºæ–°æœŸå·å’Œå¼€å¥–æ—¶é—´ï¼ˆå‚è€ƒ F5BotV2ï¼‰
    lblCurrentIssue.Text = e.NewIssueId.ToString();
    lblOpenTime.Text = BinggoTimeHelper.GetIssueOpenTime(e.NewIssueId).ToString("HH:mm:ss");
}

// UcBinggoDataLast.cs - OnIssueChanged
private void OnIssueChanged(object? sender, BinggoIssueChangedEventArgs e)
{
    // ğŸ”¥ ç«‹å³æ˜¾ç¤ºä¸ŠæœŸæœŸå·ã€æ—¶é—´ã€å·ç ï¼ˆâœ±ï¼‰
    _lastData = e.LastLotteryData;
    UpdateDisplay();  // æœŸå·ã€æ—¶é—´æ­£å¸¸æ˜¾ç¤ºï¼Œå·ç æ˜¾ç¤ºä¸º âœ±ï¼ˆé—ªçƒï¼‰
}
```

**å¯¹åº”å…³ç³»ï¼š**
| F5BotV2 | æˆ‘ä»¬çš„å®ç° |
|---------|-----------|
| `ucLotteryDataCur.LotteryUpdata(dataCur)` | `UcBinggoDataCur.OnIssueChanged()` |
| `ucLotteryDataLast.LotteryUpdata(dataLast)` | `UcBinggoDataLast.OnIssueChanged()` |
| ç›´æ¥è°ƒç”¨ | äº‹ä»¶é©±åŠ¨ï¼ˆæ›´è§£è€¦ï¼‰ |

---

## ğŸ’¡ æ ¸å¿ƒè®¾è®¡åŸåˆ™

### 1. **ç»Ÿä¸€çš„æœŸå·åˆ‡æ¢æµç¨‹**
- âœ… é¦–æ¬¡åˆå§‹åŒ–å’ŒæœŸå·å˜æ›´èµ°åŒä¸€ä¸ªæ–¹æ³• `HandleIssueChangeAsync`
- âœ… é¿å…é€»è¾‘åˆ†æ”¯ï¼Œé™ä½å¤æ‚åº¦
- âœ… ç¡®ä¿è¡Œä¸ºä¸€è‡´æ€§

### 2. **æ¸è¿›å¼æ˜¾ç¤º**
```
æ­¥éª¤1ï¼ˆ0msï¼‰ï¼šæ˜¾ç¤ºæœŸå·å’Œæ—¶é—´
   â†“
æ­¥éª¤2ï¼ˆ5sï¼‰ï¼šæ˜¾ç¤ºå·ç 
```
- âœ… ç”¨æˆ·ç«‹å³çœ‹åˆ°åé¦ˆï¼ˆ0 å»¶è¿Ÿï¼‰
- âœ… å·ç åŠ è½½ä¸é˜»å¡ UI

### 3. **äº‹ä»¶é©±åŠ¨æ¶æ„**
```
Service (æ•°æ®å±‚)
   â†“ è§¦å‘äº‹ä»¶
UI (æ˜¾ç¤ºå±‚)
   â†“ å“åº”äº‹ä»¶
```
- âœ… è§£è€¦ï¼šService ä¸ä¾èµ– UI
- âœ… çµæ´»ï¼šå¯ä»¥æœ‰å¤šä¸ª UI ç›‘å¬åŒä¸€äº‹ä»¶
- âœ… å¯æµ‹è¯•ï¼šå¯ä»¥å•ç‹¬æµ‹è¯• Service

---

## ğŸ” è°ƒè¯•æ—¥å¿—ç¤ºä¾‹

ä¿®å¤åï¼Œå¯åŠ¨æ—¶æ‚¨ä¼šçœ‹åˆ°è¿™æ ·çš„æ—¥å¿—ï¼š

```
========== BinggoLotteryService.Start å¼€å§‹ ==========
âœ… é¦–æ¬¡åˆå§‹åŒ–: å½“å‰æœŸå·=111065586, ä¸ŠæœŸæœŸå·=111065585
ğŸ”„ æœŸå·å˜æ›´: 111065585 â†’ 111065586
ğŸ“¢ è§¦å‘æœŸå·å˜æ›´äº‹ä»¶ï¼Œä¸ŠæœŸ 111065585 çš„ç©ºæ•°æ®å¯¹è±¡å·²åˆ›å»º

ğŸ“¢ UcBinggoDataCur æ”¶åˆ°æœŸå·å˜æ›´äº‹ä»¶: 111065585 â†’ 111065586
âœ… UcBinggoDataCur å·²æ›´æ–°: æœŸå·=111065586, æ—¶é—´=23:57:00

ğŸ“¢ UcBinggoDataLast æ”¶åˆ°æœŸå·å˜æ›´äº‹ä»¶: 111065585 â†’ 111065586
âœ… æœŸå·å˜æ›´å¸¦æ¥çš„ä¸ŠæœŸæ•°æ®: IssueId=111065585, OpenTime=2025-11-06 23:56:00
   IsOpened=Falseï¼ˆå·ç æ˜¾ç¤ºä¸ºâœ±ï¼‰
[UI ç«‹å³æ˜¾ç¤ºï¼šæœŸå·: 111065585 | 23:56:00 | âœ± âœ± âœ± âœ± âœ± âœ± | ğŸ² å¼€ å¥– ä¸­ ğŸ²]

ğŸ“¡ ç¬¬ 1/12 æ¬¡è¯·æ±‚å¼€å¥–æ•°æ®: 111065585
âœ… å¼€å¥–æ•°æ®å·²ä¿å­˜: 111065585 - 25,49,38,60,80
ğŸ“¢ UcBinggoDataLast æ”¶åˆ°å¼€å¥–äº‹ä»¶: IssueId=111065585
[UI æ›´æ–°æ˜¾ç¤ºï¼šæœŸå·: 111065585 | 23:56:00 | 25 49 38 60 80 252 | å¤§ å• | é¾™]
========== BinggoLotteryService.Start å®Œæˆ ==========
```

---

## âœ… ç¼–è¯‘ç»“æœ

```
å·²æˆåŠŸç”Ÿæˆã€‚
D:\gitcode\wx4helper\BaiShengVx3Plus\bin\Debug\net8.0-windows\BaiShengVx3Plus.dll
0 ä¸ªé”™è¯¯
```

---

## ğŸ“ æ€»ç»“

### æ ¹æœ¬é—®é¢˜
- âŒ é¦–æ¬¡åˆå§‹åŒ–å’ŒæœŸå·å˜æ›´èµ°äº†ä¸åŒçš„é€»è¾‘è·¯å¾„
- âŒ é¦–æ¬¡åˆå§‹åŒ–æ²¡æœ‰è§¦å‘ `IssueChanged` äº‹ä»¶
- âŒ å¯¼è‡´ UI æ”¶ä¸åˆ°é€šçŸ¥ï¼Œæ— æ³•æ˜¾ç¤ºæ•°æ®

### è§£å†³æ–¹æ¡ˆ
- âœ… ç»Ÿä¸€æµç¨‹ï¼šé¦–æ¬¡åˆå§‹åŒ–ä¹Ÿèµ° `HandleIssueChangeAsync`
- âœ… è§¦å‘äº‹ä»¶ï¼šç¡®ä¿ UI èƒ½æ”¶åˆ°é€šçŸ¥
- âœ… ç«‹å³æ˜¾ç¤ºï¼šæœŸå·å’Œæ—¶é—´ 0 å»¶è¿Ÿæ˜¾ç¤º

### è®¾è®¡ç²¾é«“ï¼ˆå‚è€ƒ F5BotV2ï¼‰
1. **ç»Ÿä¸€æµç¨‹**ï¼šé¿å…é€»è¾‘åˆ†æ”¯
2. **æ¸è¿›æ˜¾ç¤º**ï¼šå…ˆæ˜¾ç¤ºæœŸå·ï¼Œåæ˜¾ç¤ºå·ç 
3. **äº‹ä»¶é©±åŠ¨**ï¼šService ä¸ UI è§£è€¦

### ç”¨æˆ·ä½“éªŒæå‡
- ğŸ¯ **å¯åŠ¨é€Ÿåº¦** â†‘ 100%ï¼ˆç«‹å³æ˜¾ç¤ºæœŸå·ï¼‰
- ğŸ¯ **ä¿¡æ¯å®Œæ•´åº¦** â†‘ 100%ï¼ˆå½“å‰æœŸ + ä¸ŠæœŸéƒ½æ˜¾ç¤ºï¼‰
- ğŸ¯ **è§†è§‰åé¦ˆ** â†‘ 150%ï¼ˆé—ªçƒåŠ¨ç”» + å¼€å¥–ä¸­æç¤ºï¼‰

---

**æ–‡æ¡£åˆ›å»ºæ—¶é—´**: 2025-11-06  
**æ ¹æœ¬é—®é¢˜**: é¦–æ¬¡åˆå§‹åŒ–æ²¡æœ‰èµ°ç»Ÿä¸€çš„æœŸå·åˆ‡æ¢æµç¨‹  
**è§£å†³æ–¹æ¡ˆ**: ç»Ÿä¸€è°ƒç”¨ HandleIssueChangeAsyncï¼Œè§¦å‘ IssueChanged äº‹ä»¶  
**å‚è€ƒ**: F5BotV2 çš„ MainView.cs ä¸­ BoterStatus.æœŸå·å˜æ›´ é€»è¾‘  
**æ•ˆæœ**: å¯åŠ¨åç«‹å³æ˜¾ç¤ºå½“å‰æœŸå’Œä¸ŠæœŸæ•°æ®  

