# æ ¸å¿ƒåŠŸèƒ½ä¿®å¤è¿›åº¦

**æ—¶é—´**: 2025å¹´11æœˆ6æ—¥ 03:30  
**çŠ¶æ€**: ğŸš§ è¿›è¡Œä¸­  

---

## âœ… å·²å®Œæˆçš„åŠŸèƒ½

### 1. âœ… åŠ¨æ€æ•°æ®åº“å‘½å `business_{wxid}.db`

#### ä¿®æ”¹çš„æ–‡ä»¶

1. **`BaiShengVx3Plus/Contracts/IDatabaseService.cs`**
   - âœ… æ·»åŠ  `SwitchDatabase(string wxid)` æ–¹æ³•
   - âœ… æ·»åŠ  `GetCurrentDatabasePath()` æ–¹æ³•
   - âœ… æ·»åŠ  `GetCurrentWxid()` æ–¹æ³•

2. **`BaiShengVx3Plus/Services/Database/DatabaseService.cs`**
   - âœ… ç§»é™¤å›ºå®šçš„ `business.db` è·¯å¾„
   - âœ… å®ç° `SwitchDatabase(string wxid)` - åŠ¨æ€åˆ‡æ¢æ•°æ®åº“
   - âœ… å®ç° `GetCurrentDatabasePath()` - è·å–å½“å‰æ•°æ®åº“è·¯å¾„
   - âœ… å®ç° `GetCurrentWxid()` - è·å–å½“å‰ç”¨æˆ· wxid
   - âœ… åœ¨ `GetConnection()` ä¸­æ·»åŠ ç©ºè¿æ¥å­—ç¬¦ä¸²æ£€æŸ¥

3. **`BaiShengVx3Plus/Services/Messages/Handlers/LoginEventHandler.cs`**
   - âœ… åœ¨ç”¨æˆ·ç™»å½•æ—¶è°ƒç”¨ `_databaseService.SwitchDatabase(loginData.Wxid)`
   - âœ… æ·»åŠ æ—¥å¿—è®°å½•å½“å‰æ•°æ®åº“è·¯å¾„

#### æ•ˆæœ

ç°åœ¨æ¯ä¸ªç”¨æˆ·éƒ½æœ‰ç‹¬ç«‹çš„æ•°æ®åº“ï¼š
```
Data/
â”œâ”€â”€ business_wxid_user1.db    â† ç”¨æˆ·1çš„æ•°æ®
â”‚   â”œâ”€â”€ Members (ä¼šå‘˜è¡¨)
â”‚   â”œâ”€â”€ Orders (è®¢å•è¡¨)
â”‚   â””â”€â”€ contacts_wxid_user1 (è”ç³»äººè¡¨)
â”‚
â”œâ”€â”€ business_wxid_user2.db    â† ç”¨æˆ·2çš„æ•°æ®
â”‚   â”œâ”€â”€ Members (ä¼šå‘˜è¡¨)
â”‚   â”œâ”€â”€ Orders (è®¢å•è¡¨)
â”‚   â””â”€â”€ contacts_wxid_user2 (è”ç³»äººè¡¨)
â”‚
â””â”€â”€ logs.db                    â† æ—¥å¿—æ•°æ®åº“ï¼ˆå…¨å±€å…±äº«ï¼‰
```

---

## â¸ï¸ å¾…å®Œæˆçš„åŠŸèƒ½

### 2. âŒ ä¼šå‘˜è¡¨ã€è®¢å•è¡¨ç«‹å³ä¿å­˜ï¼ˆå¢åŠ /åˆ é™¤ï¼‰

**é—®é¢˜**: å½“å‰åªå®ç°äº†**ä¿®æ”¹**çš„ç«‹å³ä¿å­˜ï¼Œè¿˜éœ€è¦å®ç°**å¢åŠ **å’Œ**åˆ é™¤**ã€‚

#### éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶

##### 2.1 ä¿®æ”¹ `IMemberService.cs`

æ·»åŠ æ–¹æ³•ï¼š
```csharp
/// <summary>
/// ç«‹å³æ·»åŠ ä¼šå‘˜åˆ°æ•°æ®åº“
/// </summary>
void AddMemberImmediate(V2Member member);

/// <summary>
/// ç«‹å³ä»æ•°æ®åº“åˆ é™¤ä¼šå‘˜
/// </summary>
void DeleteMemberImmediate(long memberId);
```

##### 2.2 ä¿®æ”¹ `MemberService.cs`

å®ç°æ–¹æ³•ï¼š
```csharp
public void AddMemberImmediate(V2Member member)
{
    try
    {
        using var connection = _dbService.GetConnection();
        using var transaction = connection.BeginTransaction();

        var sql = @"
            INSERT INTO Members (
                GroupWxId, Wxid, Nickname, Balance, State,
                BetCur, BetWait, IncomeToday, CreditToday, BetToday,
                WithdrawToday, BetTotal, CreditTotal, WithdrawTotal, IncomeTotal,
                CreatedAt, UpdatedAt
            ) VALUES (
                @GroupWxId, @Wxid, @Nickname, @Balance, @State,
                @BetCur, @BetWait, @IncomeToday, @CreditToday, @BetToday,
                @WithdrawToday, @BetTotal, @CreditTotal, @WithdrawTotal, @IncomeTotal,
                datetime('now'), datetime('now')
            )
        ";

        using var cmd = new SQLiteCommand(sql, connection, transaction);
        cmd.Parameters.AddWithValue("@GroupWxId", member.GroupWxId ?? "");
        cmd.Parameters.AddWithValue("@Wxid", member.Wxid ?? "");
        cmd.Parameters.AddWithValue("@Nickname", member.Nickname ?? "");
        cmd.Parameters.AddWithValue("@Balance", member.Balance);
        cmd.Parameters.AddWithValue("@State", (int)member.State);
        cmd.Parameters.AddWithValue("@BetCur", member.BetCur);
        cmd.Parameters.AddWithValue("@BetWait", member.BetWait);
        cmd.Parameters.AddWithValue("@IncomeToday", member.IncomeToday);
        cmd.Parameters.AddWithValue("@CreditToday", member.CreditToday);
        cmd.Parameters.AddWithValue("@BetToday", member.BetToday);
        cmd.Parameters.AddWithValue("@WithdrawToday", member.WithdrawToday);
        cmd.Parameters.AddWithValue("@BetTotal", member.BetTotal);
        cmd.Parameters.AddWithValue("@CreditTotal", member.CreditTotal);
        cmd.Parameters.AddWithValue("@WithdrawTotal", member.WithdrawTotal);
        cmd.Parameters.AddWithValue("@IncomeTotal", member.IncomeTotal);

        cmd.ExecuteNonQuery();

        // è·å–æ’å…¥çš„ ID
        member.Id = connection.LastInsertRowId;

        transaction.Commit();

        _logService.Info("MemberService", $"âœ“ ä¼šå‘˜å·²æ·»åŠ : {member.Nickname} (ID:{member.Id})");
    }
    catch (Exception ex)
    {
        _logService.Error("MemberService", $"æ·»åŠ ä¼šå‘˜å¤±è´¥: {ex.Message}");
        throw;
    }
}

public void DeleteMemberImmediate(long memberId)
{
    try
    {
        using var connection = _dbService.GetConnection();
        var sql = "DELETE FROM Members WHERE Id = @Id";
        using var cmd = new SQLiteCommand(sql, connection);
        cmd.Parameters.AddWithValue("@Id", memberId);
        cmd.ExecuteNonQuery();

        _logService.Info("MemberService", $"âœ“ ä¼šå‘˜å·²åˆ é™¤: ID:{memberId}");
    }
    catch (Exception ex)
    {
        _logService.Error("MemberService", $"åˆ é™¤ä¼šå‘˜å¤±è´¥: {ex.Message}");
        throw;
    }
}
```

##### 2.3 åŒç†ä¿®æ”¹ `IOrderService.cs` å’Œ `OrderService.cs`

æ·»åŠ  `AddOrderImmediate` å’Œ `DeleteOrderImmediate` æ–¹æ³•ã€‚

##### 2.4 ä¿®æ”¹ `VxMain.cs`

ç›‘å¬ `BindingList` çš„ `ListChanged` äº‹ä»¶ï¼š

```csharp
private void InitializeDataBindings()
{
    // ... ç°æœ‰ä»£ç  ...

    // ğŸ”¥ ç›‘å¬ä¼šå‘˜åˆ—è¡¨çš„å¢åŠ /åˆ é™¤
    _membersBindingList.ListChanged += MembersBindingList_ListChanged;

    // ğŸ”¥ ç›‘å¬è®¢å•åˆ—è¡¨çš„å¢åŠ /åˆ é™¤
    _ordersBindingList.ListChanged += OrdersBindingList_ListChanged;
}

private void MembersBindingList_ListChanged(object? sender, ListChangedEventArgs e)
{
    try
    {
        if (e.ListChangedType == ListChangedType.ItemAdded)
        {
            var member = _membersBindingList[e.NewIndex];
            
            // ç«‹å³ä¿å­˜åˆ°æ•°æ®åº“
            _memberService.AddMemberImmediate(member);
            
            _logService.Info("VxMain", $"âœ“ æ–°å¢ä¼šå‘˜: {member.Nickname}");
        }
        // åˆ é™¤æ“ä½œéœ€è¦ç‰¹æ®Šå¤„ç†ï¼ˆè§ä¸‹æ–‡ï¼‰
    }
    catch (Exception ex)
    {
        _logService.Error("VxMain", $"ä¼šå‘˜åˆ—è¡¨å˜åŒ–å¤„ç†å¤±è´¥: {ex.Message}");
        Sunny.UI.UIMessageBox.ShowError($"ä¿å­˜ä¼šå‘˜æ•°æ®å¤±è´¥: {ex.Message}");
    }
}
```

##### 2.5 åˆ é™¤æ“ä½œçš„ç‰¹æ®Šå¤„ç†

**é—®é¢˜**: `ListChangedType.ItemDeleted` äº‹ä»¶è§¦å‘æ—¶ï¼Œæ— æ³•è·å–è¢«åˆ é™¤å¯¹è±¡çš„ IDã€‚

**è§£å†³æ–¹æ¡ˆ**:

**æ–¹æ³•1: è‡ªå®šä¹‰ BindingListï¼ˆæ¨èï¼‰**

```csharp
public class TrackableBindingList<T> : BindingList<T>
{
    public event EventHandler<T>? ItemRemoving;

    protected override void RemoveItem(int index)
    {
        var item = this[index];
        ItemRemoving?.Invoke(this, item);
        base.RemoveItem(index);
    }
}

// ä½¿ç”¨
_membersBindingList = new TrackableBindingList<V2Member>(_memberService.GetAllMembers());
_membersBindingList.ItemRemoving += (s, member) =>
{
    _memberService.DeleteMemberImmediate(member.Id);
    _logService.Info("VxMain", $"âœ“ åˆ é™¤ä¼šå‘˜: {member.Nickname}");
};
```

**æ–¹æ³•2: æ·»åŠ åˆ é™¤æŒ‰é’®åˆ—**

åœ¨ DataGridView ä¸­æ·»åŠ åˆ é™¤æŒ‰é’®ï¼Œç‚¹å‡»æ—¶å…ˆåˆ é™¤æ•°æ®åº“ï¼Œå†åˆ é™¤åˆ—è¡¨ã€‚

---

### 3. â¸ï¸ éªŒè¯åˆ—æ ‡é¢˜æ˜¾ç¤ºä¸ºä¸­æ–‡

**å½“å‰çŠ¶æ€**:
- âœ… å·²æ·»åŠ  `[DisplayName]` ç‰¹æ€§
- âœ… å·²è®¾ç½® `AutoGenerateColumns = true`
- â¸ï¸ éœ€è¦æµ‹è¯•éªŒè¯

**æµ‹è¯•æ­¥éª¤**:
1. ç¼–è¯‘è¿è¡Œ BaiShengVx3Plus
2. ç™»å½•å¹¶ç»‘å®šç¾¤ç»„
3. æŸ¥çœ‹ä¼šå‘˜è¡¨åˆ—å¤´æ˜¯å¦æ˜¾ç¤ºä¸ºä¸­æ–‡
4. æŸ¥çœ‹è®¢å•è¡¨åˆ—å¤´æ˜¯å¦æ˜¾ç¤ºä¸ºä¸­æ–‡

**å¦‚æœåˆ—å¤´ä¸æ˜¯ä¸­æ–‡**:

å¯èƒ½éœ€è¦åœ¨ `ConfigureMembersDataGridView()` ä¸­æ‰‹åŠ¨è®¾ç½®ï¼š
```csharp
private void ConfigureMembersDataGridView()
{
    // ... ç°æœ‰ä»£ç  ...

    // ğŸ”¥ å¦‚æœ AutoGenerateColumns ä¸ç”Ÿæ•ˆï¼Œæ‰‹åŠ¨è®¾ç½®åˆ—å¤´
    if (dgvMembers.Columns["Nickname"] != null)
    {
        dgvMembers.Columns["Nickname"].HeaderText = "æ˜µç§°";
    }
    if (dgvMembers.Columns["Balance"] != null)
    {
        dgvMembers.Columns["Balance"].HeaderText = "ä½™é¢";
    }
    // ... å…¶ä»–åˆ—
}
```

---

## ğŸ“Š å½“å‰è¿›åº¦

| åŠŸèƒ½ | çŠ¶æ€ | è¿›åº¦ |
|------|------|------|
| åŠ¨æ€æ•°æ®åº“å‘½å | âœ… å®Œæˆ | 100% |
| åˆ—æ ‡é¢˜æ˜¾ç¤ºä¸­æ–‡ | â¸ï¸ å¾…éªŒè¯ | 90% |
| ä¼šå‘˜è¡¨å¢åˆ ç«‹å³ä¿å­˜ | âŒ å¾…å®ç° | 0% |
| è®¢å•è¡¨å¢åˆ ç«‹å³ä¿å­˜ | âŒ å¾…å®ç° | 0% |

---

## ğŸ¯ ä¸‹ä¸€æ­¥

### é€‰é¡¹1: å®ç°å¢åˆ ç«‹å³ä¿å­˜ï¼ˆæ¨èï¼‰

è¿™æ˜¯æ ¸å¿ƒä¸šåŠ¡åŠŸèƒ½ï¼Œéœ€è¦ä¼˜å…ˆå®Œæˆã€‚

**é¢„è®¡æ—¶é—´**: 1-2å°æ—¶

### é€‰é¡¹2: å…ˆæµ‹è¯•åˆ—æ ‡é¢˜å’Œæ•°æ®åº“åˆ‡æ¢

å…ˆéªŒè¯å·²å®Œæˆçš„åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚

**é¢„è®¡æ—¶é—´**: 30åˆ†é’Ÿ

---

## âš ï¸ é‡è¦æç¤º

### æ•°æ®è¿ç§»

å¦‚æœä¹‹å‰å·²ç»æœ‰æ•°æ®åœ¨ `business.db` ä¸­ï¼Œéœ€è¦æ‰‹åŠ¨è¿ç§»ï¼š

```sql
-- 1. å¤‡ä»½æ—§æ•°æ®
cp Data/business.db Data/business_backup.db

-- 2. ç”¨æˆ·ç™»å½•åï¼Œæ•°æ®ä¼šè‡ªåŠ¨ä¿å­˜åˆ° business_{wxid}.db
-- 3. æ—§æ•°æ®éœ€è¦æ‰‹åŠ¨å¯¼å…¥ï¼ˆå¦‚æœéœ€è¦ï¼‰
```

---

**æ—¶é—´**: 2025å¹´11æœˆ6æ—¥ 03:30  
**çŠ¶æ€**: ğŸš§ è¿›è¡Œä¸­  
**å®Œæˆåº¦**: 33% (1/3)

