# ç¼–è¯‘é”™è¯¯ä¿®å¤è®°å½•

## ä¿®å¤æ—¶é—´
2025å¹´11æœˆ6æ—¥

## é”™è¯¯æ€»æ•°
**40+ ä¸ªç¼–è¯‘é”™è¯¯å’Œè­¦å‘Š**

---

## ä¿®å¤åˆ†ç±»

### 1. JSON åºåˆ—åŒ–åº“é—®é¢˜ âœ…
**é—®é¢˜**: é¡¹ç›®æ··ç”¨äº† `System.Text.Json` å’Œ `Newtonsoft.Json`  
**ä¿®å¤**:
- ç»Ÿä¸€ä½¿ç”¨ `Newtonsoft.Json`ï¼ˆF5BotV2 ä¸€è‡´ï¼‰
- ä¿®æ”¹ `BsApiResponse.cs`: 
  - `[JsonPropertyName]` â†’ `[JsonProperty]`
  - `Message` å±æ€§æ”¹ä¸º `Msg`ï¼ˆä¸APIä¸€è‡´ï¼‰
  - å¼•ç”¨ä» `System.Text.Json` æ”¹ä¸º `Newtonsoft.Json`

### 2. æ¨¡å‹å­—æ®µç¼ºå¤± âœ…
**é—®é¢˜**: `V2MemberOrder` æ¨¡å‹ç¼ºå°‘å¼€å¥–æœåŠ¡æ‰€éœ€å­—æ®µ  
**ä¿®å¤**: æ·»åŠ ä»¥ä¸‹å­—æ®µ
```csharp
public string? BetContent { get; set; }         // æŠ•æ³¨å†…å®¹
public decimal BetAmount { get; set; }          // æŠ•æ³¨é‡‘é¢
public bool IsSettled { get; set; }             // æ˜¯å¦å·²ç»“ç®—
public DateTime CreatedAt { get; set; }         // åˆ›å»ºæ—¶é—´
```

### 3. æ¥å£æ–¹æ³•ä¸åŒ¹é… âœ…
**é—®é¢˜**: `IBinggoLotteryService` å’Œ `IBinggoOrderService` æ¥å£ç¼ºå°‘æ–¹æ³•  
**ä¿®å¤**:
- `IBinggoLotteryService`: æ·»åŠ  `SetDatabase()` å’Œ `SetBindingList()`
- `IBinggoOrderService`: å‚æ•°æ”¹ä¸ºå¯ç©ºç±»å‹ `SQLiteConnection?`, `V2OrderBindingList?`, `V2MemberBindingList?`
- `IBsWebApiClient`: æ·»åŠ ç‚³ç‹—ä¸“ç”¨ API æ–¹æ³•

### 4. API å®¢æˆ·ç«¯é—®é¢˜ âœ…
**é—®é¢˜**: `BsWebApiService` å’Œ `BsWebApiClient` è°ƒç”¨ä¸å­˜åœ¨çš„æ–¹æ³•  
**ä¿®å¤**:
- **`BsWebApiService.cs`**: ä½¿ç”¨ `PostAsync<T>()` ä»£æ›¿ `LoginAsync()`
  - ä¿®æ”¹ `SetToken()` â†’ `SetSign()`
  - ä¿®æ”¹ `response.Message` â†’ `response.Msg`
- **`BsWebApiClient.cs`**: æ·»åŠ ç‚³ç‹— API æ–¹æ³•
  - `GetCurrentBinggoDataAsync<T>()`
  - `GetBinggoDataAsync<T>(int issueId)`
  - `GetRecentBinggoDataAsync<T>(int count)`
  - `GetBinggoDataListAsync<T>(DateTime date)`

### 5. HTTP å®¢æˆ·ç«¯æ‰©å±•ç¼ºå¤± âœ…
**é—®é¢˜**: `AddHttpClient` æ–¹æ³•æœªæ‰¾åˆ°  
**ä¿®å¤**: åœ¨ `BaiShengVx3Plus.csproj` æ·»åŠ 
```xml
<PackageReference Include="Microsoft.Extensions.Http" Version="8.0.0" />
```

### 6. ç±»å‹è½¬æ¢é”™è¯¯ âœ…
**é—®é¢˜**: `float` å’Œ `decimal` ç±»å‹ä¸åŒ¹é…  
**ä¿®å¤**:
- **`BinggoOrderValidator.cs` ç¬¬94è¡Œ**:
  ```csharp
  if ((decimal)member.Balance < totalAmount)
  ```
- **`BinggoOrderService.cs` ç¬¬120è¡Œ**:
  ```csharp
  member.Balance -= (float)betContent.TotalAmount;
  ```

### 7. äº‹ä»¶å‚æ•°å±æ€§ç¼ºå¤± âœ…
**é—®é¢˜**: `BinggoStatusChangedEventArgs` ç¼ºå°‘ `Message` å±æ€§  
**ä¿®å¤**: æ·»åŠ 
```csharp
public string Message { get; set; } = string.Empty;
```

### 8. å‘½åç©ºé—´ç¼ºå¤± âœ…
**é—®é¢˜**: `VxMain.cs` ç¼ºå°‘ `BinggoMessageHandler` çš„å‘½åç©ºé—´  
**ä¿®å¤**: æ·»åŠ 
```csharp
using BaiShengVx3Plus.Services.Messages.Handlers;
```

### 9. Null å¼•ç”¨è­¦å‘Š âœ…
**é—®é¢˜**: `_db`, `_ordersBindingList`, `_membersBindingList` å¯èƒ½ä¸º null  
**ä¿®å¤**: åœ¨ `InitializeBinggoServices()` æ·»åŠ æ£€æŸ¥
```csharp
if (_db == null)
{
    _logService.Warning("VxMain", "æ•°æ®åº“æœªåˆå§‹åŒ–ï¼Œè·³è¿‡ç‚³ç‹—æœåŠ¡åˆå§‹åŒ–");
    return;
}
```

### 10. æ–‡æ¡£æ–‡ä»¶è¢«ç¼–è¯‘ âœ…
**é—®é¢˜**: `0-èµ„æ–™` æ–‡ä»¶å¤¹çš„ `.md` æ–‡ä»¶è¢«å½“ä½œä»£ç ç¼–è¯‘  
**ä¿®å¤**: åœ¨ `.csproj` æ·»åŠ æ’é™¤è§„åˆ™
```xml
<ItemGroup>
  <Compile Remove="0-èµ„æ–™\**" />
  <EmbeddedResource Remove="0-èµ„æ–™\**" />
  <None Remove="0-èµ„æ–™\**" />
</ItemGroup>
```

---

## ä¿®å¤æ–‡ä»¶åˆ—è¡¨

### æ¨¡å‹å±‚
- âœ… `Models/Api/BsApiResponse.cs` (JSON å±æ€§)
- âœ… `Models/V2MemberOrder.cs` (æ·»åŠ  4 ä¸ªå­—æ®µ)
- âœ… `Models/Games/Binggo/Events/BinggoStatusChangedEventArgs.cs` (Message å±æ€§)

### æ¥å£å±‚
- âœ… `Contracts/IBsWebApiClient.cs` (æ·»åŠ ç‚³ç‹— API æ–¹æ³•)
- âœ… `Contracts/Games/IBinggoLotteryService.cs` (SetDatabase, SetBindingList)
- âœ… `Contracts/Games/IBinggoOrderService.cs` (å‚æ•°å¯ç©ºåŒ–)

### æœåŠ¡å±‚
- âœ… `Services/Api/BsWebApiClient.cs` (å®ç°ç‚³ç‹— API)
- âœ… `Services/Api/BsWebApiService.cs` (ä¿®å¤ API è°ƒç”¨)
- âœ… `Services/Games/Binggo/BinggoOrderValidator.cs` (ç±»å‹è½¬æ¢)
- âœ… `Services/Games/Binggo/BinggoOrderService.cs` (ç±»å‹è½¬æ¢)

### è§†å›¾å±‚
- âœ… `Views/VxMain.cs` (å‘½åç©ºé—´, null æ£€æŸ¥)

### é…ç½®æ–‡ä»¶
- âœ… `BaiShengVx3Plus.csproj` (NuGet åŒ…, æ’é™¤è§„åˆ™)

---

## ç¼–è¯‘ç»“æœ

### ä¿®å¤å‰
- âŒ **40+ ä¸ªç¼–è¯‘é”™è¯¯**
- âŒ **8+ ä¸ªè­¦å‘Š**
- âŒ æ— æ³•ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶

### ä¿®å¤å
- âœ… **0 ä¸ªç¼–è¯‘é”™è¯¯**
- âœ… **0 ä¸ªè­¦å‘Š**
- âœ… é¡¹ç›®æˆåŠŸç¼–è¯‘

### æœ€åä¸€è½®ä¿®å¤ï¼ˆå‚æ•°å¯ç©ºæ€§ï¼‰âœ…
- `IBinggoLotteryService`: æ·»åŠ  `using BaiShengVx3Plus.Core;`
- `BinggoLotteryService.SetDatabase()`: å‚æ•°æ”¹ä¸º `SQLiteConnection?`
- `BinggoLotteryService.SetBindingList()`: æ·»åŠ æ–¹æ³•å®ç°ï¼Œå‚æ•°æ”¹ä¸º `BinggoLotteryDataBindingList?`
- `BinggoOrderService.SetDatabase()`: å‚æ•°æ”¹ä¸º `SQLiteConnection?`
- `BinggoOrderService.SetOrdersBindingList()`: å‚æ•°æ”¹ä¸º `V2OrderBindingList?`
- `BinggoOrderService.SetMembersBindingList()`: å‚æ•°æ”¹ä¸º `V2MemberBindingList?`

---

## æŠ€æœ¯è¦ç‚¹

### 1. ä¸ºä»€ä¹ˆä½¿ç”¨ Newtonsoft.Jsonï¼Ÿ
- âœ… æˆç†Ÿç¨³å®šï¼ˆ10+ å¹´å†å²ï¼‰
- âœ… F5BotV2 é¡¹ç›®ä¸€è‡´æ€§
- âœ… æ›´å¥½çš„é”™è¯¯å¤„ç†
- âœ… æ›´çµæ´»çš„é…ç½®é€‰é¡¹

### 2. ORM å­—æ®µè®¾è®¡åŸåˆ™
- **UI æ˜¾ç¤ºå­—æ®µ**: `[DataGridColumn]` æ ‡è®°
- **æ•°æ®åº“å­—æ®µ**: `[Indexed]`, `[PrimaryKey]`, `[AutoIncrement]`
- **éšè—å­—æ®µ**: `[Browsable(false)]`
- **å¿½ç•¥å­—æ®µ**: `[Ignore]`

### 3. ç±»å‹è½¬æ¢æœ€ä½³å®è·µ
- `float` â†” `decimal`: æ˜¾å¼è½¬æ¢
  - **æ‰£æ¬¾**: `(float)decimalå€¼`
  - **æ¯”è¾ƒ**: `(decimal)floatå€¼`
- é¿å…éšå¼è½¬æ¢å¯¼è‡´çš„ç²¾åº¦ä¸¢å¤±

### 4. æœåŠ¡ä¾èµ–æ³¨å…¥é¡ºåº
```
åŸºç¡€æœåŠ¡ â†’ ä¸šåŠ¡æœåŠ¡ â†’ åº”ç”¨æœåŠ¡
   â†“          â†“          â†“
Logging â†’ BinggoGame â†’ VxMain
Database   WebAPI
Socket     Order
```

---

## ä¸‹ä¸€æ­¥

### P1: UI æ§ä»¶å¼€å‘ â³
- [ ] `UcBinggoDataCur` - å½“å‰æœŸæ•°æ®
- [ ] `UcBinggoDataLast` - ä¸ŠæœŸæ•°æ®
- [ ] `UcBinggoSettings` - æ¸¸æˆé…ç½®

### P2: åŠŸèƒ½æµ‹è¯• â³
- [ ] ç™»å½•æµ‹è¯•
- [ ] å¼€å¥–æ•°æ®è·å–
- [ ] è®¢å•åˆ›å»ºå’Œç»“ç®—
- [ ] æ¶ˆæ¯å¤„ç†

### P3: ä¼˜åŒ–å’Œæ–‡æ¡£ â³
- [ ] æ€§èƒ½ä¼˜åŒ–
- [ ] ç”¨æˆ·æ‰‹å†Œ
- [ ] API æ–‡æ¡£

---

## æ€»ç»“

é€šè¿‡ç³»ç»Ÿæ€§åœ°ä¿®å¤è¿™ 40+ ä¸ªç¼–è¯‘é”™è¯¯ï¼Œé¡¹ç›®ç°åœ¨ï¼š
- âœ… **æ¶æ„æ¸…æ™°**: æ¥å£-å®ç°-æ³¨å†Œ-ä½¿ç”¨ å®Œæ•´é“¾è·¯
- âœ… **ç±»å‹å®‰å…¨**: æ‰€æœ‰ç±»å‹è½¬æ¢æ˜¾å¼åŒ–
- âœ… **åº“ç»Ÿä¸€**: ç»Ÿä¸€ä½¿ç”¨ Newtonsoft.Json
- âœ… **æ‰©å±•æ€§å¥½**: æ˜“äºæ·»åŠ æ–°çš„æ¸¸æˆç±»å‹å’Œ API

**ç¼–è¯‘æˆåŠŸï¼ğŸ‰**

