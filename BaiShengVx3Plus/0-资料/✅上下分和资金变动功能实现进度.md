# 上下分和资金变动功能实现进度

## ✅ 已完成

### 1. 数据模型层
- ✅ **V2BalanceChange.cs** - 资金变动记录模型
  - 记录所有会员的资金变动情况
  - 包含字段：ID、微信ID、昵称、变动前余额、变动后余额、变动金额
  - 变动原因：下注、订单结算、订单取消、上分、下分、清空数据、手动调整、补单
  - **冗余记录订单信息**：订单ID、订单信息（如"123大10"）、**订单时间**
  - 期号、时间戳、备注

- ✅ **V2CreditWithdraw.cs** - 上下分申请记录模型（参考F5BotV2）
  - 上分/下分动作枚举
  - 状态枚举：等待处理、同意、忽略
  - 包含字段：ID、微信ID、昵称、动作、金额、申请时间、状态、备注

### 2. BindingList 层
- ✅ **V2BalanceChangeBindingList.cs** - 线程安全的资金变动BindingList
- ✅ **V2CreditWithdrawBindingList.cs** - 线程安全的上下分申请BindingList

### 3. 订单表字段
- ✅ 订单模型已包含 `BetFronMoney`（注前金额）和 `BetAfterMoney`（注后金额）
- ✅ 订单创建时已正确设置这两个字段
- ✅ DataGridView 列配置已设置（Order=6和7）

## 🔄 进行中

### 需要实现的功能

#### 1. 上下分管理窗口（CreditWithdrawForm）
- [ ] 创建 WinForms 窗口
- [ ] 显示上下分申请列表
- [ ] 提供同意/忽略操作按钮
- [ ] 手动添加上下分记录
- [ ] 查询和筛选功能

#### 2. 上下分服务逻辑
- [ ] 创建 `ICreditWithdrawService` 接口
- [ ] 实现 `CreditWithdrawService` 服务
- [ ] 实现上分逻辑：会员余额增加，记录CreditToday/CreditTotal
- [ ] 实现下分逻辑：会员余额减少，记录WithdrawToday/WithdrawTotal
- [ ] 自动记录资金变动

#### 3. 资金变动记录服务
- [ ] 创建 `IBalanceChangeService` 接口
- [ ] 实现 `BalanceChangeService` 服务
- [ ] 提供统一的资金变动记录方法

#### 4. 集成资金变动记录
需要在以下场景记录资金变动：
- [ ] **下注时**：余额减少，原因=下注，记录订单ID和信息
- [ ] **订单结算时**：余额增加/减少，原因=订单结算，记录订单ID和信息
- [ ] **订单取消时**：余额增加，原因=订单取消，记录订单ID和信息
- [ ] **上分时**：余额增加，原因=上分
- [ ] **下分时**：余额减少，原因=下分
- [ ] **清空数据时**：余额归零，原因=清空数据
- [ ] **手动调整时**：余额变化，原因=手动调整
- [ ] **补单时**：余额变化，原因=补单

#### 5. UI 集成
- [ ] 在 VxMain 添加"上下分管理"按钮
- [ ] 创建资金变动查看窗口
- [ ] 在会员详情中显示资金变动历史

#### 6. 数据库初始化
- [ ] 在 VxMain.InitializeDatabase 中创建表
  - CreateTable<V2BalanceChange>()
  - CreateTable<V2CreditWithdraw>()

## 📋 数据结构

### 资金变动记录表（V2BalanceChange）

| 字段 | 类型 | 说明 | 示例 |
|-----|------|------|-----|
| Id | long | 主键 | 1 |
| GroupWxId | string | 群ID | wxid_xxx |
| Wxid | string | 微信ID | wxid_yyy |
| Nickname | string | 昵称 | 张三 |
| BalanceBefore | float | 变动前余额 | 1000.00 |
| BalanceAfter | float | 变动后余额 | 980.00 |
| ChangeAmount | float | 变动金额 | -20.00 |
| Reason | enum | 变动原因 | 订单结算 |
| RelatedOrderId | long | 关联订单ID | 123 |
| RelatedOrderInfo | string | 订单信息 | 6,大,10 |
| RelatedOrderTime | string | 订单时间 | 2025-11-07 12:00:00 |
| IssueId | int | 期号 | 114062936 |
| TimeString | string | 变动时间 | 2025-11-07 12:05:00 |
| Timestamp | long | 时间戳 | 1699334700 |
| Notes | string | 备注 | 结算赢利 |

### 上下分申请表（V2CreditWithdraw）

| 字段 | 类型 | 说明 | 示例 |
|-----|------|------|-----|
| Id | long | 主键 | 1 |
| GroupWxId | string | 群ID | wxid_xxx |
| Wxid | string | 微信ID | wxid_yyy |
| Nickname | string | 会员名 | 张三 |
| Action | enum | 动作 | 上分/下分 |
| Amount | float | 金额 | 1000.00 |
| TimeString | string | 申请时间 | 2025-11-07 12:00:00 |
| Timestamp | long | 时间戳 | 1699334400 |
| Status | enum | 状态 | 等待处理/同意/忽略 |
| Notes | string | 备注 | 微信转账 |

## 🎯 下一步工作

1. **创建上下分管理窗口**
2. **实现上下分服务逻辑**
3. **实现资金变动记录服务**
4. **集成到所有金额变动操作**
5. **UI集成和测试**

## 📝 注意事项

1. 所有资金变动都必须记录到 `V2BalanceChange` 表
2. 订单相关的变动必须冗余记录订单ID、信息和时间
3. 清空数据时也要记录，从多少变到多少
4. 上下分操作要同时更新会员的 CreditTotal/WithdrawTotal 字段
5. 线程安全：所有 BindingList 操作都使用 SynchronizationContext

