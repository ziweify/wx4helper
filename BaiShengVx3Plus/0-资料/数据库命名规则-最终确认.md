# ğŸ¯ æ•°æ®åº“å‘½åè§„åˆ™ - æœ€ç»ˆç¡®è®¤

## âœ… æ­£ç¡®çš„ç†è§£

### 1. æ•°æ®åº“åˆ›å»ºæ—¶æœº

| æ—¶æœº | æ•°æ®åº“åç§° | è¯´æ˜ |
|------|-----------|------|
| **ç¨‹åºå¯åŠ¨** | `business.db` | é»˜è®¤ç©ºæ•°æ®åº“ï¼Œæœªè¿æ¥å¾®ä¿¡æ—¶ä½¿ç”¨ |
| **è¿æ¥å¾®ä¿¡æˆåŠŸ** | `business_{UserInfo.Wxid}.db` | ä¾‹å¦‚ï¼š`business_wxid_u0yqog83yfuj22.db` |

### 2. æ•°æ®åº“å­˜å‚¨å†…å®¹

**ä¸€ä¸ªå¾®ä¿¡è´¦å· = ä¸€ä¸ªä¸“å±æ•°æ®åº“**

`business_wxid_u0yqog83yfuj22.db` å­˜å‚¨ï¼š
- âœ… **æ‰€æœ‰ç¾¤ç»„çš„ä¼šå‘˜æ•°æ®**ï¼ˆé€šè¿‡ `GroupWxId` å­—æ®µåŒºåˆ†ï¼‰
- âœ… **æ‰€æœ‰ç¾¤ç»„çš„è®¢å•æ•°æ®**ï¼ˆé€šè¿‡ `GroupWxId` å­—æ®µåŒºåˆ†ï¼‰
- âœ… **è”ç³»äººæ•°æ®**ï¼ˆå¦‚æœéœ€è¦æœ¬åœ°å­˜å‚¨ï¼‰

### 3. ç¾¤ç»„ç»‘å®šé€»è¾‘

```
æ­¥éª¤1: è¿æ¥å¾®ä¿¡ wxid_u0yqog83yfuj22
  â†“
  åˆ›å»º/æ‰“å¼€æ•°æ®åº“: business_wxid_u0yqog83yfuj22.db
  â†“
æ­¥éª¤2: ç»‘å®šç¾¤ç»„ 27206515609@chatroom
  â†“
  âŒ ä¸åˆ›å»ºæ–°æ•°æ®åº“ï¼
  âœ… åœ¨åŒä¸€ä¸ªæ•°æ®åº“ä¸­æ’å…¥ä¼šå‘˜ï¼Œè®¾ç½® GroupWxId = "27206515609@chatroom"
  â†“
æ­¥éª¤3: åˆ‡æ¢ç»‘å®šåˆ°å¦ä¸€ä¸ªç¾¤ 12345678@chatroom
  â†“
  âŒ ä¸åˆ›å»ºæ–°æ•°æ®åº“ï¼
  âœ… ä»ç„¶ä½¿ç”¨ business_wxid_u0yqog83yfuj22.db
  âœ… ç­›é€‰æ˜¾ç¤º GroupWxId = "12345678@chatroom" çš„ä¼šå‘˜
```

---

## ğŸ”´ ä¹‹å‰é”™è¯¯çš„ç†è§£

### âŒ é”™è¯¯1ï¼šæŒ‰ç¾¤IDåˆ›å»ºæ•°æ®åº“
```
business_27206515609@chatroom.db  â† âŒ é”™è¯¯ï¼
business_12345678@chatroom.db     â† âŒ é”™è¯¯ï¼
```

### âŒ é”™è¯¯2ï¼šç»‘å®šç¾¤æ—¶åˆ‡æ¢æ•°æ®åº“
```csharp
// âŒ é”™è¯¯çš„åšæ³•
InitializeDatabase(contact.Wxid);  // ä½¿ç”¨ç¾¤IDåˆå§‹åŒ–æ•°æ®åº“
```

### âœ… æ­£ç¡®ï¼šå§‹ç»ˆä½¿ç”¨å¾®ä¿¡ID
```csharp
// âœ… æ­£ç¡®çš„åšæ³•
InitializeDatabase(userInfo.Wxid);  // ä½¿ç”¨å¾®ä¿¡IDåˆå§‹åŒ–æ•°æ®åº“
```

---

## ğŸ“Š æ•°æ®è¡¨ç»“æ„

### V2Member è¡¨
```sql
CREATE TABLE V2Member (
    Id INTEGER PRIMARY KEY AUTOINCREMENT,
    Wxid TEXT,              -- ä¼šå‘˜å¾®ä¿¡ID
    GroupWxId TEXT,         -- ğŸ”¥ æ‰€å±ç¾¤IDï¼ˆç”¨äºåŒºåˆ†ä¸åŒç¾¤çš„ä¼šå‘˜ï¼‰
    Nickname TEXT,
    Balance REAL,
    State INTEGER,
    ...
)
```

### æ•°æ®ç¤ºä¾‹
```
Id | Wxid              | GroupWxId                | Nickname | Balance | State
---|-------------------|--------------------------|----------|---------|------
1  | wxid_5nl4ex9mz40t12 | 27206515609@chatroom   | é±¼å„¿å®   | 100.00  | 1
2  | wxid_0y9nzscw4bcp12 | 27206515609@chatroom   | å¯Œè´µ     | 200.00  | 1
3  | wxid_abc123        | 12345678@chatroom       | å¼ ä¸‰     | 150.00  | 1
4  | wxid_def456        | 12345678@chatroom       | æå››     | 300.00  | 2
```

**åŒä¸€ä¸ªæ•°æ®åº“ï¼Œä¸åŒç¾¤çš„ä¼šå‘˜é€šè¿‡ `GroupWxId` åŒºåˆ†ï¼**

---

## ğŸ”§ ä»£ç å®ç°è¦ç‚¹

### 1. æ•°æ®åº“åˆå§‹åŒ–ï¼ˆVxMain.csï¼‰

```csharp
private void InitializeDatabase(string wxid)
{
    // ğŸ”¥ å…³é”®ï¼šwxid æ˜¯ UserInfo.Wxidï¼Œä¸æ˜¯ç¾¤IDï¼
    string dbPath = wxid == "default" 
        ? Path.Combine("Data", "business.db")
        : Path.Combine("Data", $"business_{wxid}.db");  // å¾®ä¿¡ä¸“å±æ•°æ®åº“
        
    _db = new SQLiteConnection(dbPath);
    
    // ğŸ”¥ åˆ›å»º BindingListï¼Œä¼ å…¥ç©ºå­—ç¬¦ä¸²è¡¨ç¤ºåŠ è½½æ‰€æœ‰ä¼šå‘˜
    _membersBindingList = new V2MemberBindingList(_db, "");
    _ordersBindingList = new V2OrderBindingList(_db);
}
```

### 2. ç»‘å®šç¾¤ç»„ï¼ˆVxMain.csï¼‰

```csharp
private async void btnBindingContacts_Click(object sender, EventArgs e)
{
    // ğŸ”¥ éªŒè¯æ˜¯å¦ä¸ºç¾¤
    if (!contact.Wxid.Contains("@")) return;
    
    // ğŸ”¥ æ¸…ç©ºå½“å‰æ˜¾ç¤º
    _membersBindingList?.Clear();
    
    // ğŸ”¥ è·å–æœåŠ¡å™¨æ•°æ®
    var result = await _socketClient.SendAsync<JsonDocument>("GetGroupContacts", contact.Wxid);
    
    // ğŸ”¥ è§£æå¹¶è®¾ç½® GroupWxId
    var serverMembers = ParseServerMembers(result.RootElement, contact.Wxid);
    
    // ğŸ”¥ æ™ºèƒ½åˆå¹¶ï¼ˆä¿ç•™æ•°æ®åº“ä¸­çš„å†å²æ•°æ®ï¼‰
    var mergedMembers = _groupBindingService.LoadAndMergeMembers(serverMembers, contact.Wxid);
    
    // ğŸ”¥ æ·»åŠ åˆ° BindingListï¼ˆè‡ªåŠ¨ä¿å­˜åˆ°æ•°æ®åº“ï¼‰
    foreach (var member in mergedMembers)
    {
        _membersBindingList?.Add(member);  // âœ… ä¼šä¿ç•™ member.GroupWxId
    }
}
```

### 3. V2MemberBindingList ä¿®å¤ï¼ˆCore/V2MemberBindingList.csï¼‰

```csharp
protected override void InsertItem(int index, V2Member item)
{
    // ğŸ”¥ ä¿®å¤ï¼šåªåœ¨ GroupWxId ä¸ºç©ºæ—¶æ‰è®¾ç½®ï¼Œå¦åˆ™ä¿ç•™åŸå€¼
    // è¿™æ ·å¯ä»¥æ”¯æŒåœ¨åŒä¸€ä¸ªæ•°æ®åº“ä¸­å­˜å‚¨å¤šä¸ªç¾¤çš„ä¼šå‘˜
    if (string.IsNullOrEmpty(item.GroupWxId))
    {
        item.GroupWxId = _groupWxId;
    }
    
    // ğŸ”¥ æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼ˆå»é‡ï¼‰
    var existing = _db.Table<V2Member>()
        .FirstOrDefault(m => m.GroupWxId == item.GroupWxId && m.Wxid == item.Wxid);
    
    if (existing == null)
    {
        _db.Insert(item);  // æ’å…¥æ–°è®°å½•
    }
    else
    {
        // æ›´æ–°ç°æœ‰è®°å½•ï¼ˆä¿ç•™ä¸šåŠ¡æ•°æ®ï¼‰
        item.Id = existing.Id;
        item.Balance = existing.Balance;
        // ... ä¿ç•™å…¶ä»–ä¸šåŠ¡å­—æ®µ
        _db.Update(item);
    }
    
    base.InsertItem(index, item);
}
```

---

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

1. **ä¸€ä¸ªå¾®ä¿¡ = ä¸€ä¸ªæ•°æ®åº“**  
   `business_{UserInfo.Wxid}.db`

2. **ä¸€ä¸ªæ•°æ®åº“ = å¤šä¸ªç¾¤**  
   é€šè¿‡ `GroupWxId` å­—æ®µåŒºåˆ†

3. **ç»‘å®šç¾¤ â‰  åˆ‡æ¢æ•°æ®åº“**  
   ç»‘å®šç¾¤åªæ˜¯ç­›é€‰æ˜¾ç¤ºï¼Œä¸åˆ‡æ¢æ•°æ®åº“

4. **é‡æ–°è¿æ¥å¾®ä¿¡ = åˆ‡æ¢æ•°æ®åº“**  
   åªæœ‰å¾®ä¿¡è´¦å·å˜åŒ–æ‰åˆ‡æ¢æ•°æ®åº“

---

## ğŸ› æœ¬æ¬¡ä¿®å¤çš„ Bug

### é—®é¢˜æè¿°
ç”¨æˆ·åé¦ˆï¼šè¿æ¥å¾®ä¿¡åï¼Œæ•°æ®åº“åº”è¯¥æ˜¯ `business_wxid_u0yqog83yfuj22.db`ï¼Œä½†ç»‘å®šç¾¤åï¼Œåˆç”Ÿæˆäº† `business_27206515609@chatroom.db`ã€‚

### æ ¹æœ¬åŸå› 
`V2MemberBindingList.InsertItem` æ–¹æ³•åœ¨æ·»åŠ ä¼šå‘˜æ—¶ï¼Œå¼ºåˆ¶è¦†ç›–äº† `item.GroupWxId = _groupWxId`ï¼ˆç©ºå­—ç¬¦ä¸²ï¼‰ï¼Œå¯¼è‡´ç¾¤IDä¸¢å¤±ã€‚

### ä¿®å¤æ–¹æ³•
ä¿®æ”¹ `InsertItem` é€»è¾‘ï¼š
- âœ… å¦‚æœ `item.GroupWxId` å·²æœ‰å€¼ â†’ ä¿ç•™
- âœ… å¦‚æœ `item.GroupWxId` ä¸ºç©º â†’ ä½¿ç”¨ `_groupWxId`

---

## âœ… éªŒè¯æ¸…å•

æµ‹è¯•æ­¥éª¤ï¼š

1. âœ… å¯åŠ¨ç¨‹åº â†’ åº”ä½¿ç”¨ `business.db`ï¼ˆç©ºï¼‰
2. âœ… è¿æ¥å¾®ä¿¡ `wxid_u0yqog83yfuj22` â†’ åº”åˆ›å»º `business_wxid_u0yqog83yfuj22.db`
3. âœ… ç»‘å®šç¾¤ `27206515609@chatroom` â†’ åº”ä»ç„¶ä½¿ç”¨ `business_wxid_u0yqog83yfuj22.db`
4. âœ… æŸ¥çœ‹ä¼šå‘˜è¡¨ â†’ `GroupWxId` åº”ä¸º `27206515609@chatroom`
5. âœ… ç»‘å®šå¦ä¸€ä¸ªç¾¤ `12345678@chatroom` â†’ åº”ä»ç„¶ä½¿ç”¨åŒä¸€ä¸ªæ•°æ®åº“
6. âœ… æŸ¥çœ‹ä¼šå‘˜è¡¨ â†’ æ–°ä¼šå‘˜çš„ `GroupWxId` åº”ä¸º `12345678@chatroom`

---

**æ–‡æ¡£æ›´æ–°æ—¥æœŸ**: 2025-11-06  
**ä¿®å¤çŠ¶æ€**: âœ… å·²ä¿®å¤  
**æµ‹è¯•çŠ¶æ€**: å¾…ç”¨æˆ·éªŒè¯  

