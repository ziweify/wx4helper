# âœ… æŠ•æ³¨æµç¨‹é‡æ„è®¾è®¡

## ğŸ“… è®¾è®¡æ—¶é—´

2025-11-08

## ğŸ¯ æ ¸å¿ƒè¦ç‚¹

### 1. **BetContentStandard ç»Ÿä¸€å‘½å**

**è§„åˆ™**ï¼š
- âœ… **BetContentStandard**ï¼šå·²è§£æã€å·²æ‹†åˆ†çš„æ ‡å‡†æ ¼å¼ï¼ˆå¯ç›´æ¥æŠ•æ³¨ï¼‰
  - æ ¼å¼ï¼š`1å¤§50,2å¤§30,3å¤§60`
  - ç‰¹ç‚¹ï¼šæ¯ä¸€é¡¹éƒ½æ˜¯ç‹¬ç«‹çš„ã€å¯ç›´æ¥æŠ•æ³¨çš„å•å…ƒ
  
- âŒ **BetContentOriginal**ï¼šåŸå§‹æ ¼å¼ï¼ˆéœ€è¦è§£æï¼‰
  - æ ¼å¼ï¼š`123å¤§20`
  - ç‰¹ç‚¹ï¼šéœ€è¦æ‹†åˆ†ä¸º `1å¤§20,2å¤§20,3å¤§20`

**é‡è¦**ï¼šæ‰€æœ‰æŠ•æ³¨å¯¹è±¡çš„ `BetContentStandard` å­—æ®µå¿…é¡»æ˜¯å·²è§£æçš„æ ‡å‡†æ ¼å¼ï¼

### 2. **æ‰‹åŠ¨æŠ•æ³¨ä¸ç”Ÿæˆè®¢å•è®°å½•**

**æµç¨‹**ï¼š
```
æ‰‹åŠ¨è¾“å…¥ï¼šæŠ•æ³¨(1234å¤§10)
â†“
è§£æå‘½ä»¤ â†’ æ‹†åˆ†ä¸ºæ ‡å‡†æ ¼å¼ï¼š1å¤§10,2å¤§10,3å¤§10,4å¤§10
â†“
ç”Ÿæˆ BetRecordï¼ˆæ¥æº=å‘½ä»¤ï¼ŒOrderIds=nullï¼‰
â†“
å‘é€æŠ•æ³¨å‘½ä»¤ â†’ è¿”å›ç»“æœ â†’ æ›´æ–° BetRecord
â†“
âŒ ä¸æ›´æ–°è®¢å•è¡¨ï¼ˆå› ä¸ºæ²¡æœ‰è®¢å•ï¼‰
```

**åŸå› **ï¼š
- è®¢å•è¡¨åªè®°å½•çœŸå®çš„å®¢æˆ·ä¸‹æ³¨ï¼ˆæ¥è‡ªå¾®ä¿¡ï¼‰
- æ‰‹åŠ¨æŠ•æ³¨åªè®°å½•åœ¨æŠ•æ³¨è®°å½•è¡¨
- é€šè¿‡ `Source` æšä¸¾åŒºåˆ†æ¥æº

### 3. **æŠ•æ³¨è¶…æ—¶å¤„ç†**

**ä¸è®¾å›ºå®šè¶…æ—¶ï¼Œç­‰å¾…å®é™…è¿”å›**

```csharp
// Client ç«¯
try
{
    recordPostStartTime();
    var response = await httpClient.PostAsync(betUrl, content);
    // æ— è¶…æ—¶é™åˆ¶ï¼Œç­‰å¾…å®é™…è¿”å›
    recordPostEndTime();
    return parseResult(response);
}
catch (Exception ex)
{
    recordPostEndTime();
    return (false, ex.Message);
}
```

**VxMain ç«¯**ï¼š
- ç­‰å¾… Client è¿”å›ï¼ˆæ— è®ºå¤šä¹…ï¼‰
- å¦‚æœçœŸçš„è¶…æ—¶äº†ï¼ŒClient ä¼šæŠ›å¼‚å¸¸å¹¶è¿”å›

### 4. **ä¸éœ€è¦é˜²é‡å¤æœºåˆ¶**

**åŸå› **ï¼š
- å°ç›˜äº‹ä»¶åªæ´¾å‘ä¸€æ¬¡ï¼ˆæµç¨‹æ§åˆ¶ï¼‰
- æ‰‹åŠ¨æŠ•æ³¨æ˜¯ç”¨æˆ·ä¸»åŠ¨è§¦å‘ï¼Œç”¨æˆ·è‡ªå·±æ§åˆ¶

### 5. **æŠ•æ³¨å¹¶å‘å¤„ç†ï¼ˆå…³é”®ï¼‰** ğŸ”¥

**é—®é¢˜**ï¼šå¤šä¸ªæŠ•æ³¨è¯·æ±‚ä¼šäº’ç›¸é˜»å¡å—ï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**ï¼š**å¼‚æ­¥éé˜»å¡ï¼Œæ¯ä¸ªé…ç½®ç‹¬ç«‹é˜Ÿåˆ—**

```csharp
// æ¯ä¸ªé…ç½®æœ‰ç‹¬ç«‹çš„æŠ•æ³¨é˜Ÿåˆ—
private readonly Dictionary<int, Queue<BetTask>> _betQueues = new();
private readonly Dictionary<int, bool> _isProcessing = new();

// æŠ•æ³¨ä»»åŠ¡
public class BetTask
{
    public BetRecord Record { get; set; }
    public TaskCompletionSource<BetResult> CompletionSource { get; set; }
}

// æäº¤æŠ•æ³¨ä»»åŠ¡ï¼ˆç«‹å³è¿”å›ï¼Œä¸é˜»å¡ï¼‰
public async Task<BetResult> SubmitBetAsync(int configId, BetRecord record)
{
    var tcs = new TaskCompletionSource<BetResult>();
    var task = new BetTask 
    { 
        Record = record, 
        CompletionSource = tcs 
    };
    
    // åŠ å…¥é˜Ÿåˆ—
    if (!_betQueues.ContainsKey(configId))
    {
        _betQueues[configId] = new Queue<BetTask>();
    }
    _betQueues[configId].Enqueue(task);
    
    // å¯åŠ¨å¤„ç†ï¼ˆå¦‚æœæœªåœ¨å¤„ç†ä¸­ï¼‰
    _ = ProcessBetQueueAsync(configId);
    
    // ç­‰å¾…ç»“æœï¼ˆå¼‚æ­¥ç­‰å¾…ï¼Œä¸é˜»å¡ï¼‰
    return await tcs.Task;
}

// å¤„ç†æŠ•æ³¨é˜Ÿåˆ—ï¼ˆæ¯ä¸ªé…ç½®ç‹¬ç«‹ï¼‰
private async Task ProcessBetQueueAsync(int configId)
{
    // å¦‚æœå·²ç»åœ¨å¤„ç†ï¼Œç›´æ¥è¿”å›
    if (_isProcessing.ContainsKey(configId) && _isProcessing[configId])
    {
        return;
    }
    
    _isProcessing[configId] = true;
    
    try
    {
        while (_betQueues[configId].Count > 0)
        {
            var task = _betQueues[configId].Dequeue();
            
            try
            {
                // å‘é€æŠ•æ³¨å‘½ä»¤ï¼Œç­‰å¾…è¿”å›
                var result = await SendBetCommandAndWaitAsync(configId, task.Record);
                
                // æ›´æ–°æŠ•æ³¨è®°å½•
                await UpdateBetRecordAsync(task.Record, result);
                
                // å¦‚æœæ¥æºæ˜¯è®¢å•ï¼Œæ›´æ–°è®¢å•çŠ¶æ€
                if (task.Record.Source == BetRecordSource.è®¢å•)
                {
                    await UpdateOrderStatusAsync(task.Record, result.Success);
                }
                
                // å®Œæˆä»»åŠ¡
                task.CompletionSource.SetResult(result);
            }
            catch (Exception ex)
            {
                task.CompletionSource.SetException(ex);
            }
        }
    }
    finally
    {
        _isProcessing[configId] = false;
    }
}
```

**æ•ˆæœ**ï¼š
- âœ… é…ç½®1çš„æŠ•æ³¨ä¸ä¼šé˜»å¡é…ç½®2
- âœ… åŒä¸€é…ç½®çš„æŠ•æ³¨æŒ‰é¡ºåºæ‰§è¡Œï¼ˆå…ˆè¿›å…ˆå‡ºï¼‰
- âœ… æ‰‹åŠ¨æŠ•æ³¨ç«‹å³åŠ å…¥é˜Ÿåˆ—ï¼Œä¸ä¼šè¢«å‰é¢çš„æŠ•æ³¨é˜»å¡
- âœ… æ¯ä¸ªæŠ•æ³¨éƒ½ç­‰å¾…å®é™…ç»“æœè¿”å›ï¼ˆæ— è®ºå¤šä¹…ï¼‰

**ç¤ºä¾‹æµç¨‹**ï¼š
```
æ—¶é—´çº¿ï¼š
T1: å°ç›˜äº‹ä»¶ â†’ ç”ŸæˆæŠ•æ³¨1ï¼ˆé…ç½®1ï¼Œè®¢å•æ¥æºï¼‰â†’ åŠ å…¥é˜Ÿåˆ— â†’ å¼€å§‹å¤„ç†
T2: ç”¨æˆ·ç‚¹å‡»æ‰‹åŠ¨æŠ•æ³¨ â†’ ç”ŸæˆæŠ•æ³¨2ï¼ˆé…ç½®1ï¼Œå‘½ä»¤æ¥æºï¼‰â†’ åŠ å…¥é˜Ÿåˆ— â†’ ç­‰å¾…æŠ•æ³¨1å®Œæˆ
T3: æŠ•æ³¨1å®Œæˆï¼ˆè€—æ—¶5ç§’ï¼‰â†’ å¼€å§‹å¤„ç†æŠ•æ³¨2
T4: æŠ•æ³¨2å®Œæˆ
```

### 6. **å‘½ä»¤æŠ•æ³¨ä¸è€ƒè™‘ä¸šåŠ¡é€»è¾‘**

**æ‰‹åŠ¨æŠ•æ³¨**ï¼š
- âŒ ä¸æ£€æŸ¥æœŸå·
- âŒ ä¸æ£€æŸ¥å°ç›˜çŠ¶æ€
- âŒ ä¸æ£€æŸ¥ä½™é¢
- âœ… åªç®¡è§£æå‘½ä»¤ â†’ ç”ŸæˆæŠ•æ³¨è®°å½• â†’ å‘é€ â†’ ç­‰å¾…ç»“æœ

**åŸå› **ï¼šç”¨æˆ·è‡ªå·±è´Ÿè´£ï¼Œç”¨äºæµ‹è¯•å’Œç´§æ€¥è¡¥å•

## ğŸ“Š å®Œæ•´æ•°æ®æ¨¡å‹

### BetRecordï¼ˆæŠ•æ³¨è®°å½•è¡¨ï¼‰

```csharp
[Table("BetRecords")]
public class BetRecord
{
    [PrimaryKey, AutoIncrement]
    public int Id { get; set; }
    
    public int ConfigId { get; set; }          // é…ç½®ID
    public int IssueId { get; set; }           // æœŸå·
    public BetRecordSource Source { get; set; } // æ¥æºï¼šè®¢å•|å‘½ä»¤
    
    // è®¢å•ä¿¡æ¯ï¼ˆä»…å½“æ¥æº=è®¢å•æ—¶æœ‰å€¼ï¼‰
    public string? OrderIds { get; set; }      // å…³è”çš„è®¢å•IDåˆ—è¡¨ï¼š"1,2,3"
    
    // æŠ•æ³¨å†…å®¹ï¼ˆæ ‡å‡†æ ¼å¼ï¼‰
    public string BetContentStandard { get; set; } // "1å¤§50,2å¤§30,3å¤§60"
    public decimal TotalAmount { get; set; }   // æ€»é‡‘é¢
    
    // æ—¶é—´è®°å½•
    public DateTime SendTime { get; set; }         // VxMainå‘é€å‘½ä»¤æ—¶é—´
    public DateTime? PostStartTime { get; set; }   // Client POSTå‰æ—¶é—´
    public DateTime? PostEndTime { get; set; }     // Client POSTåæ—¶é—´
    public int? DurationMs { get; set; }           // è€—æ—¶ï¼ˆæ¯«ç§’ï¼‰
    
    // ç»“æœ
    public bool? Success { get; set; }         // æ˜¯å¦æˆåŠŸï¼ˆnull=æœªè¿”å›ï¼‰
    public string? Result { get; set; }        // è¿”å›ç»“æœï¼ˆå¹³å°è¿”å›çš„åŸå§‹æ•°æ®ï¼‰
    public string? ErrorMessage { get; set; }  // å¼‚å¸¸ä¿¡æ¯
    public string? OrderNo { get; set; }       // å¹³å°è®¢å•å·
    
    public DateTime CreateTime { get; set; }
    public DateTime? UpdateTime { get; set; }
}

public enum BetRecordSource
{
    è®¢å•,  // æ¥æºäºè®¢å•è¡¨ï¼Œä¼šæ›´æ–°è®¢å•çŠ¶æ€
    å‘½ä»¤   // æ¥æºäºæ‰‹åŠ¨å‘½ä»¤ï¼Œä¸æ›´æ–°è®¢å•çŠ¶æ€
}
```

### OrderStatus æ‰©å±•

```csharp
public enum OrderStatus
{
    æœªçŸ¥ = -1,
    å¾…å¤„ç† = 0,     // è®¢å•å·²åˆ›å»ºï¼Œç­‰å¾…æŠ•æ³¨
    å¾…ç»“ç®— = 1,     // å·²æŠ•æ³¨æˆåŠŸï¼ˆç›˜å†…ï¼‰ï¼Œç­‰å¾…å¼€å¥–ç»“ç®—
    å·²å®Œæˆ = 2,     // å·²ç»“ç®—
    å·²å–æ¶ˆ = 3,     // å·²å–æ¶ˆ
    ç›˜å¤– = 4        // æŠ•æ³¨å¤±è´¥ï¼ˆæœªè¿›å…¥ç›˜å†…ï¼‰
}
```

**ä¿®æ”¹ç‚¹**ï¼š
- æ–°å¢ `ç›˜å¤–` çŠ¶æ€ï¼Œè¡¨ç¤ºæŠ•æ³¨å¤±è´¥
- `å¾…ç»“ç®—` = æŠ•æ³¨æˆåŠŸï¼ˆç›˜å†…ï¼‰

## ğŸ”„ å®Œæ•´æµç¨‹

### æµç¨‹1ï¼šè®¢å•ç”Ÿæˆ

```
å¾®ä¿¡æ¶ˆæ¯ â†’ BinggoMessageHandler.ProcessOrderAsync
â†“
è§£æ "123å¤§20" â†’ æ ‡å‡†æ ¼å¼ "1å¤§20,2å¤§20,3å¤§20"
â†“
åˆ›å»ºè®¢å•ï¼š
  - BetContentOriginal = "123å¤§20"
  - BetContentStandar = "1å¤§20" (ç¬¬ä¸€ä¸ªè®¢å•)
  - BetContentStandar = "2å¤§20" (ç¬¬äºŒä¸ªè®¢å•)
  - BetContentStandar = "3å¤§20" (ç¬¬ä¸‰ä¸ªè®¢å•)
  - OrderStatus = å¾…å¤„ç†
â†“
ä¿å­˜åˆ°è®¢å•è¡¨ï¼ˆ3æ¡è®°å½•ï¼‰
```

### æµç¨‹2ï¼šè‡ªåŠ¨æŠ•æ³¨ï¼ˆæ¥æº=è®¢å•ï¼‰

```
1. å°ç›˜äº‹ä»¶ â†’ AutoBetCoordinator.LotteryService_StatusChanged
   â†“
2. æŸ¥è¯¢è®¢å•è¡¨ï¼šWHERE IssueId=xxx AND OrderStatus=å¾…å¤„ç† AND OrderType!=æ‰˜
   â†“
3. OrderMerger.Merge(orders) åˆå¹¶è®¢å•
   è¾“å…¥ï¼š[{1å¤§20}, {1å¤§30}, {2å¤§10}]
   è¾“å‡ºï¼š[{1å¤§50}, {2å¤§10}]  // BetContentStandardæ ¼å¼
   â†“
4. ç”Ÿæˆ BetRecord
   - Source = è®¢å•
   - OrderIds = "1,2,3"
   - BetContentStandard = "1å¤§50,2å¤§10"
   - SendTime = DateTime.Now
   â†“
5. ä¿å­˜åˆ° BetRecords è¡¨
   â†“
6. AutoBetService.SubmitBetAsync(configId, record)
   â†“
7. åŠ å…¥é˜Ÿåˆ—ï¼Œå¼‚æ­¥å¤„ç†
   â†“
8. å‘é€Socketå‘½ä»¤ï¼šæŠ•æ³¨(1å¤§50,2å¤§10)
   â†“
9. Clientæ”¶åˆ°å‘½ä»¤
   â†“
10. Clientè§£æ "1å¤§50,2å¤§10" â†’ List<BetItem>
    â†“
11. è®°å½• PostStartTime
    â†“
12. ç»„è£…POSTæ•°æ®ï¼ˆå‚è€ƒF5BotV2ï¼‰â†’ HTTP POSTæŠ•æ³¨
    â†“
13. ç­‰å¾…è¿”å›ï¼ˆæ— è¶…æ—¶é™åˆ¶ï¼‰
    â†“
14. è®°å½• PostEndTime
    â†“
15. Clientè¿”å›ç»“æœï¼š
    {
      "success": true/false,
      "postStartTime": "2025-11-08 08:48:41.123",
      "postEndTime": "2025-11-08 08:48:41.248",
      "result": "æŠ•æ³¨æˆåŠŸ",
      "orderNo": "ORD123456",
      "errorMessage": null
    }
    â†“
16. VxMainæ”¶åˆ°è¿”å› â†’ æ›´æ–° BetRecord
    - Success = true/false
    - PostStartTime = ...
    - PostEndTime = ...
    - DurationMs = 125
    - Result = ...
    - OrderNo = ...
    â†“
17. æ›´æ–°è®¢å•è¡¨çŠ¶æ€ï¼ˆWHERE Id IN (1,2,3)ï¼‰
    - å¦‚æœ Success=true: OrderStatus = å¾…ç»“ç®—ï¼ˆç›˜å†…ï¼‰
    - å¦‚æœ Success=false: OrderStatus = ç›˜å¤–
```

### æµç¨‹3ï¼šæ‰‹åŠ¨æŠ•æ³¨ï¼ˆæ¥æº=å‘½ä»¤ï¼‰

```
1. é…ç½®ç®¡ç† â†’ é«˜çº§è®¾ç½® â†’ è¾“å…¥ "æŠ•æ³¨(1234å¤§10)"
   â†“
2. ç‚¹å‡» [å‘é€] â†’ BetConfigManagerForm.SendCommandAsync
   â†“
3. è§£æå‘½ä»¤ "æŠ•æ³¨(1234å¤§10)"
   â†“
4. æ‹†åˆ†ä¸ºæ ‡å‡†æ ¼å¼ï¼š"1å¤§10,2å¤§10,3å¤§10,4å¤§10"
   â†“
5. ç”Ÿæˆ BetRecord
   - Source = å‘½ä»¤
   - OrderIds = null
   - IssueId = 0ï¼ˆæˆ–å½“å‰æœŸå·ï¼‰
   - BetContentStandard = "1å¤§10,2å¤§10,3å¤§10,4å¤§10"
   - SendTime = DateTime.Now
   â†“
6. ä¿å­˜åˆ° BetRecords è¡¨
   â†“
7. AutoBetService.SubmitBetAsync(configId, record)
   â†“
8. åŠ å…¥é˜Ÿåˆ—ï¼Œå¼‚æ­¥å¤„ç†ï¼ˆåç»­æµç¨‹åŒä¸Šï¼‰
   â†“
9. è¿”å›ç»“æœæ˜¾ç¤ºåœ¨UI
   â†“
10. âŒ ä¸æ›´æ–°è®¢å•è¡¨ï¼ˆå› ä¸º Source=å‘½ä»¤ï¼‰
```

## ğŸ¨ UI è®¾è®¡

### é…ç½®ç®¡ç† - é«˜çº§è®¾ç½®é¢æ¿

```csharp
// ç§»é™¤ï¼štxtBetScript (å¤šè¡Œæ–‡æœ¬æ¡†)
// ç§»é™¤ï¼šlblBetScript

// æ–°å¢ï¼šå‘é€æŒ‡ä»¤é¢æ¿
private UIPanel pnlCommandPanel;
private UILabel lblCommandTitle;

// å¿«æ·æŒ‡ä»¤æŒ‰é’®
private UIButton btnQuickBet;          // "æŠ•æ³¨"
private UIButton btnQuickGetBalance;   // "è·å–ç›˜å£é¢åº¦"
private UIButton btnQuickGetCookie;    // "è·å–Cookie"

// å‘½ä»¤è¾“å…¥
private UILabel lblCommandInput;
private UITextBox txtCommandInput;     // "æŠ•æ³¨(1234å¤§10)"
private UIButton btnSendCommand;       // [å‘é€]

// ç»“æœæ˜¾ç¤º
private UILabel lblCommandResult;
private UIRichTextBox txtCommandResult;  // å¤šè¡Œï¼Œåªè¯»ï¼Œæ˜¾ç¤ºæ‰§è¡Œç»“æœ
```

### å¸ƒå±€

```
â”Œâ”€ é«˜çº§è®¾ç½® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                             â”‚
â”‚ å‘é€æŒ‡ä»¤:                                   â”‚
â”‚                                             â”‚
â”‚ å¿«æ·æŒ‡ä»¤:                                   â”‚
â”‚ [æŠ•æ³¨] [è·å–ç›˜å£é¢åº¦] [è·å–Cookie]          â”‚
â”‚                                             â”‚
â”‚ å‘½ä»¤è¾“å…¥:                                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚ â”‚ æŠ•æ³¨(1234å¤§10)                    â”‚       â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                  [å‘é€]     â”‚
â”‚                                             â”‚
â”‚ æ‰§è¡Œç»“æœ:                                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ [2025-11-08 08:48:41.123]           â”‚   â”‚
â”‚ â”‚ â†’ å‘é€å‘½ä»¤: æŠ•æ³¨(1234å¤§10)          â”‚   â”‚
â”‚ â”‚ â†’ è§£æç»“æœ: 1å¤§10,2å¤§10,3å¤§10,4å¤§10 â”‚   â”‚
â”‚ â”‚ â†’ æŠ•æ³¨è®°å½•ID: 123                   â”‚   â”‚
â”‚ â”‚ [2025-11-08 08:48:41.248]           â”‚   â”‚
â”‚ â”‚ â† æŠ•æ³¨æˆåŠŸ                          â”‚   â”‚
â”‚ â”‚ â† è€—æ—¶: 125ms                       â”‚   â”‚
â”‚ â”‚ â† è®¢å•å·: ORD123456                 â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ æŠ€æœ¯å®ç°è¦ç‚¹

### 1. å‘½ä»¤è§£æ

```csharp
public class CommandParser
{
    public static (string command, string args) Parse(string input)
    {
        // "æŠ•æ³¨(1234å¤§10)" â†’ ("æŠ•æ³¨", "1234å¤§10")
        var match = Regex.Match(input, @"^(\w+)\((.*)\)$");
        if (match.Success)
        {
            return (match.Groups[1].Value, match.Groups[2].Value);
        }
        throw new Exception("å‘½ä»¤æ ¼å¼é”™è¯¯");
    }
    
    public static string ParseBetContent(string args)
    {
        // "1234å¤§10" â†’ "1å¤§10,2å¤§10,3å¤§10,4å¤§10"
        // å¤ç”¨ BinggoOrderService çš„è§£æé€»è¾‘
    }
}
```

### 2. æŠ•æ³¨é˜Ÿåˆ—ç®¡ç†

```csharp
public class BetQueueManager
{
    private readonly Dictionary<int, Queue<BetTask>> _queues = new();
    private readonly Dictionary<int, SemaphoreSlim> _semaphores = new();
    
    public async Task<BetResult> EnqueueAsync(int configId, BetRecord record)
    {
        // è·å–æˆ–åˆ›å»ºé˜Ÿåˆ—
        if (!_queues.ContainsKey(configId))
        {
            _queues[configId] = new Queue<BetTask>();
            _semaphores[configId] = new SemaphoreSlim(1, 1);
        }
        
        var tcs = new TaskCompletionSource<BetResult>();
        _queues[configId].Enqueue(new BetTask 
        { 
            Record = record, 
            CompletionSource = tcs 
        });
        
        // è§¦å‘å¤„ç†
        _ = ProcessQueueAsync(configId);
        
        // ç­‰å¾…ç»“æœ
        return await tcs.Task;
    }
    
    private async Task ProcessQueueAsync(int configId)
    {
        await _semaphores[configId].WaitAsync();
        try
        {
            while (_queues[configId].Count > 0)
            {
                var task = _queues[configId].Dequeue();
                // å¤„ç†æŠ•æ³¨...
                await ProcessBetAsync(task);
            }
        }
        finally
        {
            _semaphores[configId].Release();
        }
    }
}
```

### 3. Client è¿”å›æ•°æ®æ ¼å¼

```csharp
public class BetCommandResponse
{
    public bool Success { get; set; }
    public string? PostStartTime { get; set; }  // ISO 8601æ ¼å¼
    public string? PostEndTime { get; set; }
    public string? Result { get; set; }
    public string? OrderNo { get; set; }
    public string? ErrorMessage { get; set; }
}
```

## âœ… æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹
1. âœ… `BetContentStandard` ç»Ÿä¸€æ ‡å‡†æ ¼å¼
2. âœ… æ‰‹åŠ¨æŠ•æ³¨ä¸ç”Ÿæˆè®¢å•ï¼Œåªç”ŸæˆæŠ•æ³¨è®°å½•
3. âœ… æŠ•æ³¨æ— è¶…æ—¶é™åˆ¶ï¼Œç­‰å¾…å®é™…è¿”å›
4. âœ… æ¯ä¸ªé…ç½®ç‹¬ç«‹é˜Ÿåˆ—ï¼Œå¼‚æ­¥éé˜»å¡
5. âœ… æ‰‹åŠ¨æŠ•æ³¨ä¸æ£€æŸ¥ä¸šåŠ¡é€»è¾‘
6. âœ… é€šè¿‡ `Source` æšä¸¾åŒºåˆ†æŠ•æ³¨æ¥æº

### ä¸‹ä¸€æ­¥
1. åˆ›å»º `BetRecord` æ¨¡å‹
2. åˆ›å»º `BetRecordService`
3. åˆ›å»º `OrderMerger`
4. ä¿®æ”¹ `AutoBetCoordinator`
5. åˆ›å»º `BetQueueManager`
6. ä¿®æ”¹é…ç½®ç®¡ç†UI
7. ä¿®æ”¹ Client å‘½ä»¤å¤„ç†

**å‡†å¤‡å¼€å§‹å®ç°ï¼** ğŸš€

