# ğŸŠ åŒé€šé“æ¶æ„å®ç°å®Œæˆ - HTTP + Socket

## ğŸ“… å®Œæˆæ—¶é—´

2025-11-07

## ğŸ¯ æ¶æ„æ€»è§ˆ

### åŒé€šé“åˆ†å·¥

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         VxMain                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  AutoBetSocketServer â”‚    â”‚  AutoBetHttpServer       â”‚  â”‚
â”‚  â”‚  ç«¯å£: 19527         â”‚    â”‚  ç«¯å£: 8888               â”‚  â”‚
â”‚  â”‚  (åŒå‘å®æ—¶é€šä¿¡)       â”‚    â”‚  (æ•°æ®äº¤äº’/è°ƒè¯•)          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚             â”‚                             â”‚                  â”‚
â”‚             â”‚ Socket æ¨é€/æ¥æ”¶            â”‚ HTTP è¯·æ±‚/å“åº”    â”‚
â”‚             â”‚ - å°ç›˜é€šçŸ¥                  â”‚ - è·å–è®¢å•        â”‚
â”‚             â”‚ - æŠ•æ³¨å‘½ä»¤                  â”‚ - æäº¤ç»“æœ        â”‚
â”‚             â”‚ - Cookie æ›´æ–°               â”‚ - æ›´æ–° Cookie    â”‚
â”‚             â”‚ - è¿œç¨‹æ§åˆ¶                  â”‚ - è·å–é…ç½®        â”‚
â”‚             â”‚ - å¿ƒè·³ä¿æ´»                  â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                             â”‚
              â”‚                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             â–¼                             â–¼                  â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚      â”‚ SocketClient â”‚            â”‚ HttpClient   â”‚           â”‚
â”‚      â”‚ (ä¸»åŠ¨è¿æ¥)    â”‚            â”‚ (ä¸»åŠ¨æ‹‰å–)    â”‚           â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                      BsBrowserClient                         â”‚
â”‚                      (WebView2 + å¹³å°è„šæœ¬)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ æ ¸å¿ƒåŠŸèƒ½

### 1. Socket é€šé“ï¼ˆ`AutoBetSocketServer` - ç«¯å£ 19527ï¼‰

#### âœ… åŠŸèƒ½åˆ—è¡¨

| åŠŸèƒ½ | æ–¹å‘ | è¯´æ˜ |
|-----|------|------|
| **æ¡æ‰‹è¿æ¥** | BrowserClient â†’ VxMain | æµè§ˆå™¨å¯åŠ¨åä¸»åŠ¨è¿æ¥ï¼Œå‘é€ configId |
| **å°ç›˜é€šçŸ¥** | VxMain â†’ BrowserClient | å®æ—¶æ¨é€å°ç›˜å€’è®¡æ—¶ |
| **æŠ•æ³¨å‘½ä»¤** | VxMain â†’ BrowserClient | å®æ—¶æ¨é€æŠ•æ³¨è®¢å• |
| **Cookie æ›´æ–°** | BrowserClient â†’ VxMain | ç™»å½•çŠ¶æ€å˜æ›´æ—¶æ¨é€ |
| **è¿œç¨‹æ§åˆ¶** | VxMain â†’ BrowserClient | show/hide çª—å£ï¼Œping æ£€æµ‹ |
| **å¿ƒè·³ä¿æ´»** | åŒå‘ | ä¿æŒè¿æ¥æ´»è·ƒ |

#### ğŸ’¡ å®ç°ç»†èŠ‚

**VxMain ç«¯ï¼ˆæœåŠ¡å™¨ï¼‰**ï¼š
```csharp
// å¯åŠ¨ Socket æœåŠ¡å™¨ï¼ˆç«¯å£ 19527ï¼Œç”¨äºåŒå‘é€šä¿¡ï¼‰
_socketServer = new AutoBetSocketServer(log, OnBrowserConnected);
_socketServer.Start();

// æ¨é€å°ç›˜é€šçŸ¥
await _autoBetService.NotifySealingAsync(configId, issueId, secondsRemaining);

// æ¨é€æŠ•æ³¨å‘½ä»¤
await _autoBetService.SendBetCommandAsync(configId, order);
```

**BrowserClient ç«¯ï¼ˆå®¢æˆ·ç«¯ï¼‰**ï¼š
```csharp
// ä¸»åŠ¨è¿æ¥åˆ° VxMain
_socketServer = new SocketServer(configIdInt, OnCommandReceived, OnLogMessage);
_socketServer.Start();

// å‘é€æ¡æ‰‹
var handshake = new { type = "hello", configId = _configId };
await _writer.WriteLineAsync(JsonConvert.SerializeObject(handshake));

// ç›‘å¬å‘½ä»¤
switch (cmd["type"]?.ToString())
{
    case "sealing_notify":  // å°ç›˜é€šçŸ¥
    case "place_bet":       // æŠ•æ³¨å‘½ä»¤
    case "show":            // æ˜¾ç¤ºçª—å£
    case "hide":            // éšè—çª—å£
    case "ping":            // å¿ƒè·³æ£€æµ‹
}
```

### 2. HTTP é€šé“ï¼ˆ`AutoBetHttpServer` - ç«¯å£ 8888ï¼‰

#### âœ… API åˆ—è¡¨

| è·¯ç”± | æ–¹æ³• | åŠŸèƒ½ | è°ƒç”¨æ–¹ |
|------|------|------|--------|
| `/api/config?configId=1` | GET | è·å–é…ç½®å’Œ Cookie | BrowserClient |
| `/api/order?configId=1` | GET | è·å–å¾…æŠ•æ³¨è®¢å• | BrowserClient |
| `/api/result` | POST | æäº¤æŠ•æ³¨ç»“æœ | BrowserClient |
| `/api/cookie` | POST | æ›´æ–° Cookie | BrowserClient |
| `/api/ping` | GET | å¿ƒè·³æ£€æµ‹ | ä»»ä½•è°ƒè¯•å·¥å…· |

#### ğŸ’¡ å®ç°ç»†èŠ‚

**VxMain ç«¯ï¼ˆHTTP æœåŠ¡å™¨ï¼‰**ï¼š
```csharp
// å¯åŠ¨ HTTP æœåŠ¡å™¨ï¼ˆç«¯å£ 8888ï¼Œç”¨äºæ•°æ®äº¤äº’å’Œè°ƒè¯•ï¼‰
_httpServer = new AutoBetHttpServer(
    log: log,
    port: 8888,
    getConfig: GetConfig,
    saveConfig: SaveConfig,
    getOrder: GetPendingOrder,
    handleResult: HandleBetResult
);
_httpServer.Start();
```

**BrowserClient ç«¯ï¼ˆHTTP å®¢æˆ·ç«¯ï¼‰**ï¼š
```csharp
// æ‹‰å–è®¢å•
var response = await _httpClient.GetAsync(
    $"http://127.0.0.1:8888/api/order?configId={_configId}");

// æäº¤ç»“æœ
var result = new { configId = _configId, success = true, orderId = "xxx" };
await _httpClient.PostAsync(
    "http://127.0.0.1:8888/api/result", 
    new StringContent(JsonConvert.SerializeObject(result)));
```

#### ğŸ” è°ƒè¯•æ”¯æŒ

**æµè§ˆå™¨ç›´æ¥è®¿é—®**ï¼š
```bash
# æŸ¥çœ‹è®¢å•
http://127.0.0.1:8888/api/order?configId=1

# æŸ¥çœ‹é…ç½®
http://127.0.0.1:8888/api/config?configId=1

# å¿ƒè·³æ£€æµ‹
http://127.0.0.1:8888/api/ping
```

**Postman æµ‹è¯•**ï¼š
```http
POST http://127.0.0.1:8888/api/result
Content-Type: application/json

{
  "configId": 1,
  "success": true,
  "orderId": "ORDER123456",
  "errorMessage": null
}
```

## ğŸ”„ å·¥ä½œæµç¨‹

### å°ç›˜æŠ•æ³¨æµç¨‹ï¼ˆåŒé€šé“åä½œï¼‰

```
1. å½©ç¥¨å¼€å¥–æœåŠ¡æ£€æµ‹åˆ°"å³å°†å°ç›˜"
   â†“
2. AutoBetCoordinator è§¦å‘
   â†“
3. ğŸ“¡ Socket æ¨é€å°ç›˜é€šçŸ¥
   VxMain â†’ BrowserClient: { type: "sealing_notify", secondsRemaining: 30 }
   â†“
4. ğŸ“¡ Socket æ¨é€æŠ•æ³¨å‘½ä»¤ï¼ˆæ–¹å¼1ï¼‰
   VxMain â†’ BrowserClient: { type: "place_bet", order: {...} }
   â†“
5. ğŸŒ è®¢å•åŠ å…¥ HTTP é˜Ÿåˆ—ï¼ˆæ–¹å¼2ï¼Œå…œåº•ï¼‰
   VxMain.QueueBetOrder(configId, order)
   â†“
6. BrowserClient æ”¶åˆ°å‘½ä»¤ï¼ˆæˆ–ä¸»åŠ¨æ‹‰å–ï¼‰
   - Socket æ–¹å¼ï¼šç«‹å³æ”¶åˆ°æ¨é€
   - HTTP æ–¹å¼ï¼šGET /api/order?configId=1
   â†“
7. BrowserClient æ‰§è¡ŒæŠ•æ³¨
   â†“
8. ğŸŒ æäº¤ç»“æœï¼ˆHTTPï¼‰
   BrowserClient â†’ VxMain: POST /api/result
   â†“
9. VxMain è®°å½•ç»“æœåˆ°æ•°æ®åº“
```

## ğŸ“Š åŒé€šé“ä¼˜åŠ¿

### Socket é€šé“

| ä¼˜åŠ¿ | è¯´æ˜ |
|------|------|
| âœ… **å®æ—¶æ€§å¼º** | å»¶è¿Ÿ < 10ms |
| âœ… **åŒå‘é€šä¿¡** | æœåŠ¡ç«¯å¯ä¸»åŠ¨æ¨é€ |
| âœ… **ä¿æŒè¿æ¥** | é•¿è¿æ¥ï¼Œå¿ƒè·³ä¿æ´» |
| âœ… **é€‚åˆæ¨é€** | å°ç›˜é€šçŸ¥ã€ç´§æ€¥å‘½ä»¤ |

| åŠ£åŠ¿ | è¯´æ˜ |
|------|------|
| âŒ **è°ƒè¯•ä¸ä¾¿** | éœ€è¦æŠ“åŒ…å·¥å…· |
| âŒ **åè®®è‡ªå®šä¹‰** | éœ€è¦è®¾è®¡æ¶ˆæ¯æ ¼å¼ |
| âŒ **çŠ¶æ€ç®¡ç†** | éœ€è¦å¤„ç†æ–­çº¿é‡è¿ |

### HTTP é€šé“

| ä¼˜åŠ¿ | è¯´æ˜ |
|------|------|
| âœ… **è°ƒè¯•æ–¹ä¾¿** | æµè§ˆå™¨ç›´æ¥è®¿é—® |
| âœ… **æ ‡å‡†åè®®** | RESTful é£æ ¼ |
| âœ… **æ— çŠ¶æ€** | ä¸éœ€è¦è¿æ¥ç®¡ç† |
| âœ… **å·¥å…·ä¸°å¯Œ** | Postmanã€curl ç­‰ |

| åŠ£åŠ¿ | è¯´æ˜ |
|------|------|
| âŒ **è¢«åŠ¨æ‹‰å–** | å®¢æˆ·ç«¯ä¸»åŠ¨è¯·æ±‚ |
| âŒ **å¼€é”€ç¨å¤§** | æ¯æ¬¡è¯·æ±‚æœ‰ HTTP å¤´ |
| âŒ **è½®è¯¢æ¶ˆè€—** | éœ€è¦å®šæ—¶æ‹‰å– |

### ğŸ¯ åˆ†å·¥ç­–ç•¥

| åœºæ™¯ | æ¨èé€šé“ | åŸå›  |
|------|---------|------|
| **å°ç›˜é€šçŸ¥** | Socket | å®æ—¶æ¨é€ï¼Œä½å»¶è¿Ÿ |
| **æŠ•æ³¨å‘½ä»¤** | Socket + HTTPï¼ˆå…œåº•ï¼‰ | åŒé‡ä¿é™© |
| **ç»“æœæäº¤** | HTTP | æ— çŠ¶æ€ï¼Œæ˜“è°ƒè¯• |
| **Cookie æ›´æ–°** | Socketï¼ˆå®æ—¶ï¼‰æˆ– HTTPï¼ˆæ‰¹é‡ï¼‰ | çœ‹åœºæ™¯éœ€æ±‚ |
| **é…ç½®æŸ¥è¯¢** | HTTP | ä¸€æ¬¡æ€§æŸ¥è¯¢ |
| **è¿œç¨‹æ§åˆ¶** | Socket | åŒå‘é€šä¿¡ |

## ğŸ—‚ï¸ æ ¸å¿ƒä»£ç æ–‡ä»¶

### VxMain ç«¯

| æ–‡ä»¶ | åŠŸèƒ½ |
|------|------|
| `Services/AutoBet/AutoBetService.cs` | æ ¸å¿ƒæœåŠ¡ï¼Œç®¡ç†åŒé€šé“ |
| `Services/AutoBet/AutoBetSocketServer.cs` | Socket æœåŠ¡å™¨ï¼ˆç«¯å£ 19527ï¼‰ |
| `Services/AutoBet/AutoBetHttpServer.cs` | HTTP æœåŠ¡å™¨ï¼ˆç«¯å£ 8888ï¼‰ |
| `Services/AutoBet/AutoBetCoordinator.cs` | åè°ƒå™¨ï¼Œè§¦å‘æŠ•æ³¨ |
| `Services/AutoBet/BrowserClient.cs` | æµè§ˆå™¨å®¢æˆ·ç«¯å°è£… |

### BrowserClient ç«¯

| æ–‡ä»¶ | åŠŸèƒ½ |
|------|------|
| `BsBrowserClient/Services/SocketServer.cs` | Socket å®¢æˆ·ç«¯ï¼ˆè¿æ¥ VxMain:19527ï¼‰ |
| `BsBrowserClient/Form1.cs` | ä¸»çª—ä½“ï¼Œå¤„ç†å‘½ä»¤ |
| `BsBrowserClient/PlatformScripts/YunDing28Script.cs` | äº‘é¡¶å¹³å°è„šæœ¬ |
| `BsBrowserClient/PlatformScripts/TongBaoScript.cs` | é€šå®å¹³å°è„šæœ¬ |

## ğŸ› å·²ä¿®å¤çš„é—®é¢˜

### 1. å¿«é€Ÿè®¾ç½®æ•°æ®åŠ è½½é—®é¢˜ âœ…

**é—®é¢˜**ï¼šç›˜å£ã€è´¦å·ã€å¯†ç æ˜¾ç¤ºç©ºç™½

**åŸå› **ï¼š`LoadAutoBetSettings()` åœ¨æ•°æ®åº“è®¾ç½®ä¹‹å‰è°ƒç”¨

**ä¿®å¤**ï¼šåœ¨ `_autoBetService.SetDatabase(_db)` ä¹‹åé‡æ–°è°ƒç”¨ `LoadAutoBetSettings()`

```csharp
// InitializeBinggoServices() ä¸­
_autoBetService.SetDatabase(_db);  // è®¾ç½®æ•°æ®åº“
LoadAutoBetSettings();  // âœ… é‡æ–°åŠ è½½é…ç½®
```

### 2. é…ç½®ä¿å­˜é—®é¢˜ âœ…

**é—®é¢˜**ï¼šè¾“å…¥è´¦å·å¯†ç åæ²¡æœ‰ä¿å­˜

**åŸå› **ï¼šé˜²æŠ–æœºåˆ¶å·²ç»å®ç°ï¼Œä½†æ•°æ®åº“æœªè®¾ç½®å¯¼è‡´ä¿å­˜å¤±è´¥

**ä¿®å¤**ï¼šåŒä¸Šï¼Œç¡®ä¿æ•°æ®åº“è®¾ç½®åå†åŠ è½½å’Œä¿å­˜

### 3. ç«¯å£å†²çªé—®é¢˜ âœ…

**é—®é¢˜**ï¼š`_nextPort` å˜é‡ä¸å­˜åœ¨

**åŸå› **ï¼šæ”¹ç”¨ Socket å›ºå®šç«¯å£ï¼ˆ19527ï¼‰ï¼Œç§»é™¤äº†åŠ¨æ€ç«¯å£åˆ†é…

**ä¿®å¤**ï¼šåˆ é™¤ `_nextPort` ç›¸å…³é€»è¾‘ï¼Œæµè§ˆå™¨ä¸»åŠ¨è¿æ¥åˆ°å›ºå®šç«¯å£

## ğŸ“ åç»­ä¼˜åŒ–

### 1. Socket æ–­çº¿é‡è¿

**å½“å‰çŠ¶æ€**ï¼šåŸºç¡€å®ç°

**ä¼˜åŒ–æ–¹å‘**ï¼š
- è‡ªåŠ¨é‡è¿æœºåˆ¶ï¼ˆæŒ‡æ•°é€€é¿ï¼‰
- å¿ƒè·³è¶…æ—¶æ£€æµ‹ï¼ˆ30ç§’æ— å¿ƒè·³è§†ä¸ºæ–­çº¿ï¼‰
- é‡è¿åçŠ¶æ€åŒæ­¥

### 2. HTTP æ€§èƒ½ä¼˜åŒ–

**å½“å‰çŠ¶æ€**ï¼šåŸºç¡€å®ç°

**ä¼˜åŒ–æ–¹å‘**ï¼š
- è¿æ¥æ± å¤ç”¨ï¼ˆ`HttpClient` å•ä¾‹ï¼‰
- å“åº”å‹ç¼©ï¼ˆgzipï¼‰
- è¯·æ±‚ç¼“å­˜ï¼ˆGET è¯·æ±‚ï¼‰

### 3. å®‰å…¨æ€§å¢å¼º

**å½“å‰çŠ¶æ€**ï¼šæœ¬åœ°é€šä¿¡ï¼Œæ— åŠ å¯†

**ä¼˜åŒ–æ–¹å‘**ï¼š
- Token è®¤è¯ï¼ˆé˜²æ­¢éæ³•è¿æ¥ï¼‰
- æ•°æ®ç­¾åï¼ˆé˜²æ­¢ç¯¡æ”¹ï¼‰
- HTTPS æ”¯æŒï¼ˆå¦‚éœ€å¤–ç½‘è®¿é—®ï¼‰

### 4. ç›‘æ§å’Œæ—¥å¿—

**å½“å‰çŠ¶æ€**ï¼šåŸºç¡€æ—¥å¿—

**ä¼˜åŒ–æ–¹å‘**ï¼š
- é€šé“å¥åº·åº¦ç›‘æ§
- è¯·æ±‚æˆåŠŸç‡ç»Ÿè®¡
- å»¶è¿Ÿç›‘æ§ï¼ˆSocket/HTTPï¼‰
- å¼‚å¸¸å‘Šè­¦

## ğŸ‰ æ€»ç»“

âœ… **åŒé€šé“æ¶æ„å®ç°å®Œæˆ**ï¼

**Socketï¼ˆç«¯å£ 19527ï¼‰**ï¼š
- å®æ—¶æ¨é€
- åŒå‘é€šä¿¡
- å¿ƒè·³ä¿æ´»
- é€‚åˆç´§æ€¥é€šçŸ¥

**HTTPï¼ˆç«¯å£ 8888ï¼‰**ï¼š
- æ˜“äºè°ƒè¯•
- æ ‡å‡†åè®®
- æ— çŠ¶æ€è®¾è®¡
- é€‚åˆæ•°æ®äº¤äº’

**äº’ä¸ºè¡¥å……ï¼ŒåŒé‡ä¿é™©**ï¼š
- Socket æ¨é€ + HTTP å…œåº•
- å¼€å‘é«˜æ•ˆ + è¿è¡Œç¨³å®š
- è°ƒè¯•æ–¹ä¾¿ + æ€§èƒ½ä¼˜ç§€

ğŸš€ **å‡†å¤‡æŠ•å…¥ä½¿ç”¨ï¼**

