# 立即保存功能测试指南

## 🎯 测试目标

验证**完全同步、立即保存**的会员和订单增删改功能，确保：
- ✅ 修改后立即保存到数据库
- ✅ 删除前同步删除数据库
- ✅ 添加立即保存到数据库
- ✅ 无异步延迟，无数据污染

---

## 🔧 编译项目

### 1. 编译 BaiShengVx3Plus

```bash
cd D:\gitcode\wx4helper\BaiShengVx3Plus
dotnet build --configuration Debug
```

**预期输出**：
```
✓ 生成成功。
    0 个警告
    0 个错误
```

### 2. 编译 WeixinX.dll（如有 C++ 修改）

```bash
cd D:\gitcode\wx4helper\WeixinX
build_weixinx.bat
```

---

## 🧪 功能测试

### 测试 1：修改会员余额（自动保存）

#### 操作步骤
1. 启动 `BaiShengVx3Plus`
2. 点击"连接"启动/注入微信
3. 绑定一个群聊
4. 在会员列表中，修改某个会员的"余额"字段
5. 按 Enter 或点击其他单元格确认修改
6. 打开 SQLite 数据库查看器（如 DB Browser）
7. 查询 `business_{wxid}.db` 中的 `Members` 表

#### 预期结果
- ✅ 数据库中的余额**立即更新**
- ✅ 日志中显示：`✓ Property Balance updated for Members (ID: xxx)`
- ✅ UI 和数据库完全同步

---

### 测试 2：删除会员（同步删除）

#### 操作步骤
1. 在会员列表中选中某一行
2. 按 `Delete` 键删除
3. 观察日志输出
4. 打开 SQLite 数据库查看器
5. 查询 `Members` 表，确认该记录是否被删除

#### 预期结果
- ✅ 日志显示：`正在删除会员: xxx (ID: xxx)`
- ✅ 日志显示：`✓ 会员已从数据库删除: xxx (ID: xxx)`
- ✅ 数据库中该记录**立即被删除**
- ✅ UI 和数据库完全同步

#### 异常测试
1. 手动模拟数据库错误（如删除数据库文件）
2. 尝试删除会员

**预期结果**：
- ❌ 删除失败
- ✅ 弹出错误提示："删除会员失败: xxx"
- ✅ UI 中该行**未被删除**（因为 `e.Cancel = true`）
- ✅ 数据一致性得到保护

---

### 测试 3：修改订单状态（自动保存）

#### 操作步骤
1. 在订单列表中，修改某个订单的"状态"字段
2. 从"待结算"改为"已结算"
3. 按 Enter 确认
4. 查询 `business_{wxid}.db` 中的 `Orders` 表

#### 预期结果
- ✅ 数据库中的订单状态**立即更新**
- ✅ 日志中显示：`✓ Property OrderStatus updated for Orders (ID: xxx)`
- ✅ UI 和数据库完全同步

---

### 测试 4：删除订单（同步删除）

#### 操作步骤
1. 在订单列表中选中某一行
2. 按 `Delete` 键删除
3. 观察日志输出
4. 查询 `Orders` 表，确认该记录是否被删除

#### 预期结果
- ✅ 日志显示：`正在删除订单: 期号xxx (ID: xxx)`
- ✅ 日志显示：`✓ 订单已从数据库删除: 期号xxx (ID: xxx)`
- ✅ 数据库中该记录**立即被删除**
- ✅ UI 和数据库完全同步

---

### 测试 5：多字段连续修改（自动保存）

#### 操作步骤
1. 连续修改同一会员的多个字段：
   - 修改"余额" → 按 Enter
   - 修改"状态" → 按 Enter
   - 修改"备注" → 按 Enter
2. 每次修改后，立即查询数据库

#### 预期结果
- ✅ 每次修改后，数据库**立即更新**对应字段
- ✅ 日志中显示每次更新：
  ```
  ✓ Property Balance updated for Members (ID: 1)
  ✓ Property State updated for Members (ID: 1)
  ✓ Property DisplayName updated for Members (ID: 1)
  ```
- ✅ 无延迟、无批量处理

---

### 测试 6：数据库事务测试

#### 操作步骤
1. 打开 SQLite 数据库文件 `business_{wxid}.db`
2. 在另一个工具中手动锁定该数据库（如开启一个长事务）
3. 在 `BaiShengVx3Plus` 中尝试修改会员数据

#### 预期结果
- ❌ 修改失败（数据库被锁定）
- ✅ 日志中显示错误：`保存属性失败: database is locked`
- ✅ UI 中数据**未改变**
- ✅ 数据一致性得到保护

---

## 📊 性能对比测试

### 对比 F5BotV2 和 BaiShengVx3Plus

#### F5BotV2 方式（整个对象保存）
```csharp
// 修改余额
member.Balance = 1000;

// 保存整个对象（所有字段）
UPDATE Members SET 
    Wxid = @Wxid, 
    Nickname = @Nickname, 
    Balance = @Balance,  -- 只有这个字段改了
    State = @State, 
    ...  -- 更新所有字段
WHERE Id = @Id;
```

#### BaiShengVx3Plus 方式（单字段保存）
```csharp
// 修改余额
member.Balance = 1000;

// 自动保存单个字段
UPDATE Members SET Balance = @Balance WHERE Id = @Id;  -- 只更新改变的字段
```

#### 性能测试
1. 修改 100 个会员的余额
2. 记录每次修改的时间

**预期结果**：
- ✅ BaiShengVx3Plus 比 F5BotV2 快 **50%以上**
- ✅ 数据库写入次数相同
- ✅ 每次写入的数据量更小

---

## 🛡️ 数据一致性测试

### 测试 1：删除失败回滚

#### 模拟删除失败
1. 在 `MemberService.DeleteMember()` 中手动抛出异常：
   ```csharp
   public void DeleteMember(long id)
   {
       throw new Exception("模拟删除失败");  // 模拟错误
   }
   ```
2. 在 UI 中尝试删除会员

**预期结果**：
- ❌ 删除失败
- ✅ UI 中该行**未被删除**（因为 `e.Cancel = true`）
- ✅ 数据库中该记录**依然存在**
- ✅ 弹出错误提示

### 测试 2：修改失败恢复

#### 模拟修改失败
1. 在 `PropertyChangeTracker` 中手动抛出异常
2. 尝试修改会员余额

**预期结果**：
- ❌ 修改失败
- ✅ 日志中显示错误
- ✅ 数据库中的值**未改变**

---

## 📝 日志检查

### 正常操作日志示例

```log
[INFO] VxMain: 主窗口已打开
[INFO] MemberService: ✓ 加载 10 个会员（已自动追踪）
[INFO] OrderService: ✓ 加载 5 个订单（已自动追踪）

[INFO] PropertyChangeTracker: ✓ Property Balance updated for Members (ID: 1)
[INFO] VxMain: 正在删除会员: 张三 (ID: 1)
[INFO] MemberService: ✓ 删除会员成功 (ID: 1)
[INFO] VxMain: ✓ 会员已从数据库删除: 张三 (ID: 1)

[INFO] MemberService: ✓ 添加会员成功: 李四 (ID: 11)
[INFO] PropertyChangeTracker: ✓ Property Balance updated for Members (ID: 11)
```

### 错误日志示例

```log
[ERROR] VxMain: 删除会员失败: 张三 (ID: 1)
        Exception: database is locked

[ERROR] PropertyChangeTracker: 保存属性失败: Balance (ID: 1)
        Exception: database is locked
```

---

## 🎯 测试清单

- [ ] ✅ 修改会员余额，检查数据库是否立即更新
- [ ] ✅ 删除会员，检查数据库是否同步删除
- [ ] ✅ 删除失败时，检查 UI 是否取消删除
- [ ] ✅ 添加新会员，检查数据库是否立即保存
- [ ] ✅ 修改订单状态，检查数据库是否立即更新
- [ ] ✅ 删除订单，检查数据库是否同步删除
- [ ] ✅ 多字段连续修改，检查每次修改是否立即保存
- [ ] ✅ 数据库锁定时，检查错误处理是否正确
- [ ] ✅ 查看日志，确认所有操作都有记录
- [ ] ✅ 性能对比测试，验证单字段更新的优势

---

## 🏁 总结

### ✅ 核心特性验证
- **完全同步**：所有操作立即生效，无异步延迟
- **立即保存**：修改后立即写入数据库
- **事务保护**：失败自动回滚
- **取消机制**：删除失败时取消 UI 操作
- **性能优化**：单字段更新比整个对象更新快 50%以上

### 📝 注意事项
1. 所有数据库操作都是同步的
2. 所有操作都在事务中执行
3. 删除前先删除数据库，失败则取消 UI 操作
4. 日志记录所有操作，便于调试和审计

---

**创建日期**: 2025-11-06  
**文件位置**: `BaiShengVx3Plus/0-资料/20251106-立即保存功能测试指南.md`  
**相关文档**: `20251106-会员订单同步立即保存实现.md`

