# âœ… æµè§ˆå™¨çª—å£æ¶ˆå¤±é—®é¢˜ä¿®å¤

## ğŸ“… ä¿®å¤æ—¶é—´

2025-11-08

## ğŸ› é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆï¼š
> "æˆ‘ç‚¹å‡»é£å•ï¼Œçœ‹åˆ°æµè§ˆå™¨å¯åŠ¨äº†ï¼Œå¯æ˜¯çª—å£åˆç«‹å³æ¶ˆå¤±äº†ï¼Œæˆ‘ä¸çŸ¥é“æ˜¯å…³é—­äº†ï¼Œè¿˜æ˜¯éšè—äº†ï¼Œè¿˜æ˜¯é€€å‡ºäº†ã€‚ç„¶åæˆ‘ç‚¹å‡»'å¯åŠ¨æµè§ˆå™¨'å°±çœ‹åˆ°æµè§ˆå™¨çª—å£äº†ï¼Œè´¦å·å¯†ç ä¹Ÿå·²è¾“å…¥äº†ã€‚"

### é”™è¯¯æ—¥å¿—

```
2025-11-08 08:13:45.613  ä¿¡æ¯  AutoBet        âœ… æµè§ˆå™¨ Socket è¿æ¥æˆåŠŸ: é»˜è®¤é…ç½®
2025-11-08 08:13:45.623  é”™è¯¯  AutoBetServer  å¤„ç†å®¢æˆ·ç«¯è¿æ¥å¤±è´¥ (é…ç½®ID: 1)
2025-11-08 08:13:45.624  ä¿¡æ¯  AutoBetServer  âŒ é…ç½® 1 è¿æ¥å·²å…³é—­
```

## ğŸ” é—®é¢˜æ ¹å› 

### é—®é¢˜ 1ï¼šæµè§ˆå™¨è¿›ç¨‹è¢«æ„å¤–æ€æ­»

**ä»£ç ä½ç½®**ï¼š`BaiShengVx3Plus/Services/AutoBet/AutoBetService.cs` - `OnBrowserConnected()` æ–¹æ³•

**é—®é¢˜ä»£ç **ï¼š

```csharp
private void OnBrowserConnected(int configId, System.Net.Sockets.TcpClient client)
{
    // ...
    
    // åˆ›å»ºæˆ–æ›´æ–° BrowserClientï¼ˆä½¿ç”¨å·²å»ºç«‹çš„è¿æ¥ï¼‰
    if (_browsers.ContainsKey(configId))
    {
        _log.Info("AutoBet", $"æ›´æ–°ç°æœ‰æµè§ˆå™¨è¿æ¥: {config.ConfigName}");
        _browsers[configId].Dispose();  // âŒ è¿™é‡Œä¼šæ€æ­»æµè§ˆå™¨è¿›ç¨‹ï¼
    }
    
    var browserClient = new BrowserClient(configId);
    browserClient.AttachConnection(client);
    _browsers[configId] = browserClient;
    // ...
}
```

**é—®é¢˜æµç¨‹**ï¼š

```
1. ç”¨æˆ·ç‚¹å‡»"é£å•"ï¼ˆswiAutoOrdersBetï¼‰
   â†“
2. AutoBetService.StartBrowser() å¯åŠ¨æµè§ˆå™¨è¿›ç¨‹
   - åˆ›å»º BrowserClient å®ä¾‹
   - è°ƒç”¨ StartAsync() å¯åŠ¨ BsBrowserClient.exe
   - å°† BrowserClient å­˜å…¥ _browsers å­—å…¸
   â†“
3. BsBrowserClient.exe å¯åŠ¨å®Œæˆ
   â†“
4. BsBrowserClient ä¸»åŠ¨è¿æ¥åˆ° VxMain:19527
   â†“
5. AutoBetSocketServer æ¥æ”¶è¿æ¥
   â†“
6. OnBrowserConnected(configId, client) è¢«è°ƒç”¨
   â†“
7. âŒ æ£€æµ‹åˆ° _browsers å·²æœ‰è¯¥ configId
   â†“
8. âŒ è°ƒç”¨ _browsers[configId].Dispose()
   â†“
9. âŒ Dispose() æ–¹æ³•æ€æ­»æµè§ˆå™¨è¿›ç¨‹
   â†“
10. ğŸ”´ æµè§ˆå™¨çª—å£æ¶ˆå¤±ï¼
```

### é—®é¢˜ 2ï¼šAttachConnection æœªå…³é—­æ—§è¿æ¥

**ä»£ç ä½ç½®**ï¼š`BaiShengVx3Plus/Services/AutoBet/BrowserClient.cs` - `AttachConnection()` æ–¹æ³•

**é—®é¢˜ä»£ç **ï¼š

```csharp
public void AttachConnection(TcpClient socket)
{
    _socket = socket;  // âŒ ç›´æ¥è¦†ç›–ï¼Œæ²¡æœ‰å…³é—­æ—§è¿æ¥
    var stream = _socket.GetStream();
    _reader = new StreamReader(stream, Encoding.UTF8);
    _writer = new StreamWriter(stream, Encoding.UTF8) { AutoFlush = true };
}
```

**é—®é¢˜**ï¼š
- å¦‚æœå·²æœ‰æ—§çš„ Socket è¿æ¥ï¼Œç›´æ¥è¦†ç›–ä¼šå¯¼è‡´æ—§è¿æ¥æ³„æ¼
- æ—§çš„ `_reader` å’Œ `_writer` æœªé‡Šæ”¾

### é—®é¢˜ 3ï¼šSaveSwitchSettings æ–¹æ³•é”™è¯¯

**ä»£ç ä½ç½®**ï¼š`BaiShengVx3Plus/Views/VxMain.cs` - `SaveSwitchSettings()` æ–¹æ³•

**é—®é¢˜ä»£ç **ï¼š

```csharp
private void SaveSwitchSettings()
{
    // ...
    _db.Execute("INSERT OR REPLACE INTO AppSettings (Key, Value) VALUES (?, ?)", 
        "AutoOrdersBet", swiAutoOrdersBet.Active ? "1" : "0");
    // ...
}
```

**é—®é¢˜**ï¼š
- ä½¿ç”¨åŸç”Ÿ SQL `INSERT OR REPLACE` æ—¶ï¼Œåªæä¾›äº† `Key` å’Œ `Value`
- `UpdateTime` å­—æ®µç¼ºå¤±ï¼Œå¯èƒ½å¯¼è‡´ SQL é”™è¯¯

**é”™è¯¯æ—¥å¿—**ï¼š
```
2025-11-08 08:13:45.330  é”™è¯¯  VxMain  ä¿å­˜å¼€å…³çŠ¶æ€å¤±è´¥
```

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ 1ï¼šåªæ›´æ–° Socket è¿æ¥ï¼Œä¸æ€è¿›ç¨‹

**æ–‡ä»¶**ï¼š`BaiShengVx3Plus/Services/AutoBet/AutoBetService.cs`

**ä¿®æ”¹å‰**ï¼š
```csharp
if (_browsers.ContainsKey(configId))
{
    _log.Info("AutoBet", $"æ›´æ–°ç°æœ‰æµè§ˆå™¨è¿æ¥: {config.ConfigName}");
    _browsers[configId].Dispose();  // âŒ æ€æ­»è¿›ç¨‹
}

var browserClient = new BrowserClient(configId);
browserClient.AttachConnection(client);
_browsers[configId] = browserClient;
```

**ä¿®æ”¹å**ï¼š
```csharp
if (_browsers.TryGetValue(configId, out var existingBrowser))
{
    _log.Info("AutoBet", $"æ›´æ–°ç°æœ‰æµè§ˆå™¨çš„ Socket è¿æ¥: {config.ConfigName}");
    // âœ… åªé™„åŠ æ–°è¿æ¥ï¼Œä¸è¦ Dispose æ•´ä¸ª BrowserClientï¼ˆä¼šæ€æ­»è¿›ç¨‹ï¼‰
    existingBrowser.AttachConnection(client);
}
else
{
    _log.Info("AutoBet", $"åˆ›å»ºæ–°çš„æµè§ˆå™¨å®¢æˆ·ç«¯: {config.ConfigName}");
    var browserClient = new BrowserClient(configId);
    browserClient.AttachConnection(client);
    _browsers[configId] = browserClient;
}
```

**å…³é”®å˜åŒ–**ï¼š
- ä½¿ç”¨ `TryGetValue` æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
- å¦‚æœå­˜åœ¨ï¼Œ**åªè°ƒç”¨ `AttachConnection`**ï¼Œä¸è°ƒç”¨ `Dispose()`
- å¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°çš„ `BrowserClient`

### ä¿®å¤ 2ï¼šAttachConnection å…ˆå…³é—­æ—§è¿æ¥

**æ–‡ä»¶**ï¼š`BaiShengVx3Plus/Services/AutoBet/BrowserClient.cs`

**ä¿®æ”¹å‰**ï¼š
```csharp
public void AttachConnection(TcpClient socket)
{
    _socket = socket;
    var stream = _socket.GetStream();
    _reader = new StreamReader(stream, Encoding.UTF8);
    _writer = new StreamWriter(stream, Encoding.UTF8) { AutoFlush = true };
}
```

**ä¿®æ”¹å**ï¼š
```csharp
public void AttachConnection(TcpClient socket)
{
    // å…ˆå…³é—­æ—§çš„ Socket è¿æ¥ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    try
    {
        _reader?.Dispose();
        _writer?.Dispose();
        _socket?.Close();
    }
    catch { /* å¿½ç•¥å…³é—­æ—§è¿æ¥çš„é”™è¯¯ */ }
    
    // é™„åŠ æ–°è¿æ¥
    _socket = socket;
    var stream = _socket.GetStream();
    _reader = new StreamReader(stream, Encoding.UTF8);
    _writer = new StreamWriter(stream, Encoding.UTF8) { AutoFlush = true };
}
```

**å…³é”®å˜åŒ–**ï¼š
- åœ¨é™„åŠ æ–°è¿æ¥å‰ï¼Œå…ˆå…³é—­æ—§çš„ `_reader`ã€`_writer` å’Œ `_socket`
- ä½¿ç”¨ `try-catch` å¿½ç•¥å…³é—­é”™è¯¯
- é¿å…è¿æ¥æ³„æ¼

### ä¿®å¤ 3ï¼šä½¿ç”¨ ORM æ–¹æ³•ä¿å­˜è®¾ç½®

**æ–‡ä»¶**ï¼š`BaiShengVx3Plus/Views/VxMain.cs`

**ä¿®æ”¹å‰**ï¼š
```csharp
private void SaveSwitchSettings()
{
    // ...
    _db.Execute("INSERT OR REPLACE INTO AppSettings (Key, Value) VALUES (?, ?)", 
        "AutoOrdersBet", swiAutoOrdersBet.Active ? "1" : "0");
    
    _db.Execute("INSERT OR REPLACE INTO AppSettings (Key, Value) VALUES (?, ?)", 
        "OrdersTasking", swi_OrdersTasking.Active ? "1" : "0");
    // ...
}
```

**ä¿®æ”¹å**ï¼š
```csharp
private void SaveSwitchSettings()
{
    try
    {
        if (_db == null) return;
        
        // ä½¿ç”¨ SaveAppSettings æ–¹æ³•ä¿å­˜ï¼ˆæ›´å®‰å…¨ï¼‰
        SaveAppSettings("AutoOrdersBet", swiAutoOrdersBet.Active, "è‡ªåŠ¨æŠ•æ³¨å¼€å…³");
        SaveAppSettings("OrdersTasking", swi_OrdersTasking.Active, "è®¢å•ä»»åŠ¡å¼€å…³");
        
        _logService.Info("VxMain", $"âœ… å¼€å…³çŠ¶æ€å·²ä¿å­˜: é£å•={swiAutoOrdersBet.Active}, æ”¶å•={swi_OrdersTasking.Active}");
    }
    catch (Exception ex)
    {
        _logService.Error("VxMain", "ä¿å­˜å¼€å…³çŠ¶æ€å¤±è´¥", ex);
    }
}
```

**å…³é”®å˜åŒ–**ï¼š
- ä½¿ç”¨ `SaveAppSettings` æ–¹æ³•ï¼ˆå·²å®ç°çš„ ORM æ–¹æ³•ï¼‰
- è‡ªåŠ¨å¤„ç† `UpdateTime` å­—æ®µ
- ä»£ç æ›´ç®€æ´ã€æ›´å®‰å…¨

## ğŸ“Š ä¿®å¤å‰åå¯¹æ¯”

### ä¿®å¤å‰ï¼ˆé”™è¯¯æµç¨‹ï¼‰

```
ç”¨æˆ·ç‚¹å‡»"é£å•"
  â†“
StartBrowser() å¯åŠ¨è¿›ç¨‹
  â†“
åˆ›å»º BrowserClientï¼Œå­˜å…¥ _browsers
  â†“
BsBrowserClient.exe å¯åŠ¨
  â†“
æµè§ˆå™¨ä¸»åŠ¨è¿æ¥åˆ° VxMain
  â†“
OnBrowserConnected() è¢«è°ƒç”¨
  â†“
æ£€æµ‹åˆ° _browsers å·²å­˜åœ¨ âŒ
  â†“
è°ƒç”¨ Dispose() æ€æ­»è¿›ç¨‹ âŒ
  â†“
ğŸ”´ æµè§ˆå™¨çª—å£æ¶ˆå¤±ï¼
```

### ä¿®å¤åï¼ˆæ­£ç¡®æµç¨‹ï¼‰

```
ç”¨æˆ·ç‚¹å‡»"é£å•"
  â†“
StartBrowser() å¯åŠ¨è¿›ç¨‹
  â†“
åˆ›å»º BrowserClientï¼Œå­˜å…¥ _browsers
  â†“
BsBrowserClient.exe å¯åŠ¨
  â†“
æµè§ˆå™¨ä¸»åŠ¨è¿æ¥åˆ° VxMain
  â†“
OnBrowserConnected() è¢«è°ƒç”¨
  â†“
æ£€æµ‹åˆ° _browsers å·²å­˜åœ¨ âœ…
  â†“
åªæ›´æ–° Socket è¿æ¥ âœ…
ï¼ˆè°ƒç”¨ AttachConnectionï¼Œå…³é—­æ—§è¿æ¥ï¼Œé™„åŠ æ–°è¿æ¥ï¼‰
  â†“
ğŸŸ¢ æµè§ˆå™¨çª—å£ä¿æŒæ˜¾ç¤ºï¼
  â†“
é¡µé¢åŠ è½½å®Œæˆ
  â†“
è‡ªåŠ¨ç™»å½•æˆåŠŸ
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•æ­¥éª¤

1. **å¯åŠ¨åº”ç”¨**
   ```
   .\BaiShengVx3Plus\bin\Debug\net8.0-windows\BaiShengVx3Plus.exe
   ```

2. **è¾“å…¥è´¦å·å¯†ç **
   - åœ¨å¿«é€Ÿè®¾ç½®é¢æ¿è¾“å…¥ç”¨æˆ·åå’Œå¯†ç 
   - ç­‰å¾… 2 ç§’ï¼ˆç¡®ä¿é˜²æŠ–å®Œæˆï¼‰

3. **ç‚¹å‡»"é£å•"å¼€å…³**
   - æ‰“å¼€ `swiAutoOrdersBet` å¼€å…³

4. **è§‚å¯Ÿæµè§ˆå™¨çª—å£**
   - âœ… æµè§ˆå™¨çª—å£åº”è¯¥ä¿æŒæ˜¾ç¤º
   - âœ… ä¸åº”è¯¥çªç„¶æ¶ˆå¤±

5. **è§‚å¯Ÿæ—¥å¿—**
   ```
   âœ… ğŸš€ å¯åŠ¨è‡ªåŠ¨æŠ•æ³¨ï¼ˆé£å•ï¼‰...
   âœ… ğŸš€ å¯åŠ¨æµè§ˆå™¨: é»˜è®¤é…ç½®
   âœ… ğŸ”— æµè§ˆå™¨å·²é€šè¿‡ Socket è¿æ¥ï¼Œé…ç½®ID: 1
   âœ… æ›´æ–°ç°æœ‰æµè§ˆå™¨çš„ Socket è¿æ¥: é»˜è®¤é…ç½®
   âœ… âœ… æµè§ˆå™¨ Socket è¿æ¥æˆåŠŸ: é»˜è®¤é…ç½®
   âœ… ğŸ“© GET /api/config?configId=1
   âœ… âœ… è¿”å›é…ç½®: é»˜è®¤é…ç½®
   âœ… âœ… é¡µé¢åŠ è½½å®Œæˆ
   âœ… ğŸ” å¼€å§‹è‡ªåŠ¨ç™»å½•
   âœ… âœ… è‡ªåŠ¨ç™»å½•æˆåŠŸï¼
   ```

6. **ä¸åº”è¯¥å†å‡ºç°ä»¥ä¸‹é”™è¯¯**
   ```
   âŒ å¤„ç†å®¢æˆ·ç«¯è¿æ¥å¤±è´¥ (é…ç½®ID: 1)
   âŒ é…ç½® 1 è¿æ¥å·²å…³é—­
   âŒ ä¿å­˜å¼€å…³çŠ¶æ€å¤±è´¥
   ```

### é¢„æœŸç»“æœ

| æµ‹è¯•é¡¹ | ä¿®å¤å‰ | ä¿®å¤å |
|--------|--------|--------|
| æµè§ˆå™¨çª—å£ | å¯åŠ¨åç«‹å³æ¶ˆå¤± | ä¿æŒæ˜¾ç¤º |
| Socket è¿æ¥ | è¿æ¥å¤±è´¥ | è¿æ¥æˆåŠŸ |
| è‡ªåŠ¨ç™»å½• | æ— æ³•æ‰§è¡Œ | æ­£å¸¸æ‰§è¡Œ |
| å¼€å…³çŠ¶æ€ä¿å­˜ | å¤±è´¥ | æˆåŠŸ |

## ğŸ“ ä¿®æ”¹æ–‡ä»¶æ¸…å•

### 1. BaiShengVx3Plus/Services/AutoBet/AutoBetService.cs

**ä¿®æ”¹å†…å®¹**ï¼š
- `OnBrowserConnected()` æ–¹æ³•ï¼šåŒºåˆ†æ–°å»ºå’Œæ›´æ–°ï¼Œé¿å… Dispose æ€æ­»è¿›ç¨‹

**å½±å“**ï¼š
- âœ… æµè§ˆå™¨è¿›ç¨‹ä¸ä¼šè¢«æ„å¤–æ€æ­»
- âœ… Socket è¿æ¥å¯ä»¥æ­£å¸¸æ›´æ–°

### 2. BaiShengVx3Plus/Services/AutoBet/BrowserClient.cs

**ä¿®æ”¹å†…å®¹**ï¼š
- `AttachConnection()` æ–¹æ³•ï¼šå…ˆå…³é—­æ—§è¿æ¥å†é™„åŠ æ–°è¿æ¥

**å½±å“**ï¼š
- âœ… é¿å… Socket è¿æ¥æ³„æ¼
- âœ… è¿æ¥æ›´æ–°æ›´å®‰å…¨

### 3. BaiShengVx3Plus/Views/VxMain.cs

**ä¿®æ”¹å†…å®¹**ï¼š
- `SaveSwitchSettings()` æ–¹æ³•ï¼šä½¿ç”¨ `SaveAppSettings` ä»£æ›¿åŸç”Ÿ SQL

**å½±å“**ï¼š
- âœ… é¿å… SQL é”™è¯¯
- âœ… ä»£ç æ›´ç®€æ´

## ğŸ¯ æ€»ç»“

### æ ¸å¿ƒé—®é¢˜

**æµè§ˆå™¨å¯åŠ¨åç«‹å³è¢«æ€æ­»**ï¼Œå› ä¸º `OnBrowserConnected` åœ¨æ¥æ”¶åˆ° Socket è¿æ¥æ—¶ï¼Œè¯¯åˆ¤ä¸ºé‡å¤è¿æ¥ï¼Œè°ƒç”¨ `Dispose()` æ€æ­»äº†åˆšå¯åŠ¨çš„è¿›ç¨‹ã€‚

### æ ¸å¿ƒä¿®å¤

**åªæ›´æ–° Socket è¿æ¥ï¼Œä¸æ€è¿›ç¨‹**ï¼š
- å¦‚æœ `BrowserClient` å·²å­˜åœ¨ï¼Œåªè°ƒç”¨ `AttachConnection()` æ›´æ–°è¿æ¥
- ä¸è°ƒç”¨ `Dispose()` æ€æ­»è¿›ç¨‹
- `AttachConnection()` å†…éƒ¨å…ˆå…³é—­æ—§è¿æ¥ï¼Œé¿å…æ³„æ¼

### é™„åŠ ä¿®å¤

**ä¿®å¤å¼€å…³çŠ¶æ€ä¿å­˜é”™è¯¯**ï¼š
- ä½¿ç”¨ ORM æ–¹æ³• `SaveAppSettings` ä»£æ›¿åŸç”Ÿ SQL
- è‡ªåŠ¨å¤„ç†æ‰€æœ‰å­—æ®µï¼Œé¿å… SQL é”™è¯¯

---

**ä¿®å¤å·²å®Œæˆï¼Œç¼–è¯‘æˆåŠŸï¼è¯·é‡æ–°æµ‹è¯•ï¼Œæµè§ˆå™¨çª—å£åº”è¯¥ä¸ä¼šå†æ¶ˆå¤±äº†ã€‚** ğŸ‰

