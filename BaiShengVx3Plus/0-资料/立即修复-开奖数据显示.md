# ç«‹å³ä¿®å¤ - å¼€å¥–æ•°æ®æ˜¾ç¤º

## ğŸ¯ ç›®æ ‡

è®©ç”¨æˆ·ç«‹å³çœ‹åˆ°ï¼š
1. âœ… å½“å‰æœŸå·
2. âœ… å®æ—¶å€’è®¡æ—¶
3. âœ… å½“å‰çŠ¶æ€
4. âœ… ä¸ŠæœŸå¼€å¥–æ•°æ®

## ğŸ”§ ä¿®å¤æ­¥éª¤

### æ­¥éª¤1: ä¿®å¤ `BinggoLotteryService` æ ¸å¿ƒé€»è¾‘

**æ–‡ä»¶**ï¼š`BaiShengVx3Plus/Services/Games/Binggo/BinggoLotteryService.cs`

**ä¿®æ”¹ç‚¹**ï¼š`OnTimerTickAsync()` æ–¹æ³•

**åŸé€»è¾‘ï¼ˆé”™è¯¯ï¼‰**ï¼š
```csharp
// å®Œå…¨ä¾èµ– API
var response = await _apiClient.GetCurrentBinggoDataAsync<BinggoLotteryData>();
if (!response.IsSuccess) return;  // API å¤±è´¥å°±æ²¡æ•°æ®
```

**æ–°é€»è¾‘ï¼ˆæ­£ç¡®ï¼‰**ï¼š
```csharp
// ä¼˜å…ˆæœ¬åœ°è®¡ç®—
int localIssueId = BinggoTimeHelper.GetCurrentIssueId();
int secondsToSeal = BinggoTimeHelper.GetSecondsToSeal(localIssueId);

// ç«‹å³æ›´æ–° UI
_currentIssueId = localIssueId;
_secondsToSeal = secondsToSeal;
CountdownTick?.Invoke(this, new BinggoCountdownEventArgs { ... });
```

### æ­¥éª¤2: ä¿®å¤æœŸå·å˜æ›´é€»è¾‘

**æ·»åŠ å¼‚æ­¥å¼€å¥–æ•°æ®è·å–**ï¼š
```csharp
if (localIssueId != _lastIssueId)
{
    if (_lastIssueId != 0)
    {
        // æœŸå·å˜æ›´ï¼Œå¼‚æ­¥è·å–ä¸ŠæœŸæ•°æ®
        _ = FetchAndSaveLotteryDataAsync(_lastIssueId);
    }
    _lastIssueId = localIssueId;
}
```

### æ­¥éª¤3: æ·»åŠ æ•°æ®åº“åŠ è½½é€»è¾‘

**åœ¨ `StartAsync()` ä¸­æ·»åŠ **ï¼š
```csharp
public async Task StartAsync()
{
    // ... ç°æœ‰ä»£ç  ...
    
    // ç«‹å³åŠ è½½ä¸ŠæœŸæ•°æ®
    int currentIssue = BinggoTimeHelper.GetCurrentIssueId();
    int previousIssue = BinggoTimeHelper.GetPreviousIssueId(currentIssue);
    await LoadLotteryDataFromDatabaseOrApi(previousIssue);
}
```

### æ­¥éª¤4: ä¿®å¤ç”¨æˆ·æ§ä»¶æ•°æ®ç»‘å®š

**`UcBinggoDataCur.cs`**ï¼š
```csharp
private void OnCountdownTick(object? sender, BinggoCountdownEventArgs e)
{
    UpdateUIThreadSafe(() =>
    {
        lblIssueId.Text = $"{BinggoTimeHelper.FormatIssueId(e.IssueId)}";
        lblCountdown.Text = BinggoTimeHelper.FormatCountdown(e.Seconds);
        lblStatus.Text = GetStatusText(e.Seconds);
        
        // å€’è®¡æ—¶é¢œè‰²
        lblCountdown.ForeColor = e.Seconds > 30 ? Color.Green :
                                  e.Seconds > 10 ? Color.Orange : Color.Red;
    });
}
```

**`UcBinggoDataLast.cs`**ï¼š
```csharp
public void SetLotteryService(IBinggoLotteryService lotteryService)
{
    _lotteryService = lotteryService;
    _lotteryService.LotteryOpened += OnLotteryOpened;
    
    // ç«‹å³ä»æ•°æ®åº“åŠ è½½æœ€è¿‘ä¸€æœŸ
    LoadLastDataFromDatabase();
}

private void LoadLastDataFromDatabase()
{
    // è·å–æœ€è¿‘ä¸€æœŸæ•°æ®
    var lastData = _db?.Table<BinggoLotteryData>()
        .OrderByDescending(d => d.IssueId)
        .FirstOrDefault();
    
    if (lastData != null && !string.IsNullOrEmpty(lastData.NumbersString))
    {
        _lastData = lastData;
        UpdateDisplay();
    }
}
```

## ğŸš€ å®æ–½

å·²åˆ›å»ºï¼š
- âœ… `BinggoTimeHelper.cs` - æœ¬åœ°æ—¶é—´è®¡ç®—å·¥å…·
- âœ… é—®é¢˜åˆ†ææ–‡æ¡£

å¾…å®æ–½ï¼š
- ğŸ”´ ä¿®æ”¹ `BinggoLotteryService.cs`
- ğŸ”´ ä¿®æ”¹ `UcBinggoDataCur.cs`
- ğŸ”´ ä¿®æ”¹ `UcBinggoDataLast.cs`
- ğŸ”´ æ·»åŠ æ•°æ®åº“åˆå§‹åŒ–é€»è¾‘

## âš ï¸ å…³é”®ç‚¹

1. **ä¸è¦åˆ é™¤ API ç›¸å…³ä»£ç ** - åªæ˜¯æ”¹å˜è°ƒç”¨æ—¶æœº
2. **å…ˆæ˜¾ç¤ºï¼Œå†è·å–** - UI ä¼˜å…ˆï¼Œæ•°æ®åå°è¡¥å……
3. **å¼‚æ­¥éé˜»å¡** - API è°ƒç”¨ä¸èƒ½é˜»å¡å€’è®¡æ—¶æ›´æ–°
4. **æ•°æ®åº“ç¼“å­˜** - ä¼˜å…ˆä»æ•°æ®åº“åŠ è½½å†å²æ•°æ®

## ğŸ“‹ æµ‹è¯•éªŒè¯

ä¿®å¤åç«‹å³æµ‹è¯•ï¼š
1. [ ] å¯åŠ¨ç¨‹åºï¼Œ2ç§’å†…çœ‹åˆ°å½“å‰æœŸå·
2. [ ] å€’è®¡æ—¶æ¯ç§’æ›´æ–°ï¼Œä¸å¡é¡¿
3. [ ] æ–­å¼€ç½‘ç»œï¼Œå€’è®¡æ—¶ä»æ­£å¸¸
4. [ ] æœ‰ä¸ŠæœŸæ•°æ®æ—¶ï¼Œè‡ªåŠ¨æ˜¾ç¤º
5. [ ] æœŸå·å˜æ›´åï¼Œè‡ªåŠ¨æ›´æ–°

