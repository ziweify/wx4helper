# ✅ BrowserClient测试按钮功能说明

**添加时间：** 2025-11-08  
**功能：** 在BrowserClient界面添加Cookie测试和投注测试按钮

---

## 🎯 新增按钮

### 按钮布局

```
[URL:] [_____文本框_____] [C] [投] [Go] [刷新]
```

- **C按钮** - 测试Cookie获取
- **投按钮** - 测试投注（固定投注"1大10"）

---

## 🍪 C按钮 - Cookie测试

### 功能说明

点击"C"按钮会执行三种方法获取Cookie，并对比结果：

#### 方法1：WebView2 API
```csharp
var cookies = await _webView.CoreWebView2.CookieManager.GetCookiesAsync(url);
```

**输出：**
```
📋 方法1：WebView2 API
   获取到8个Cookie:
   - PHPSESSID=abc123...
   - token=xyz789...
   - ...
```

#### 方法2：JavaScript document.cookie
```csharp
var jsCookie = await _webView.CoreWebView2.ExecuteScriptAsync("return document.cookie");
```

**输出：**
```
📋 方法2：JavaScript document.cookie
   document.cookie=PHPSESSID=abc123; token=xyz789; ...
```

#### 方法3：拦截到的关键参数
通过HTTP请求拦截获取的关键参数（最可靠）：

**输出：**
```
📋 方法3：拦截到的关键参数
   sid=9cbc377084ec37b28bc... (32字符)
   uuid=10014139
   token=640006705068482b6ca... (32字符)
✅ 关键参数已拦截，可以进行投注
```

**如果未拦截到：**
```
⚠️ 警告：关键参数未拦截到！请刷新页面或执行操作触发拦截。
```

---

## 🎲 投按钮 - 投注测试

### 功能说明

点击"投"按钮会：
1. 固定投注内容："1大10"
2. 调用`PlaceBetAsync`方法
3. 记录开始时间和结束时间
4. 输出投注结果和耗时

### 成功输出示例

```
🎲 【测试】开始投注测试...
   固定投注内容:1大10
📤 调用PlaceBetAsync:内容=1大10
🎲 开始投注: 1大10
   解析:1大 金额:10 ID:1
📦 投注包:arrbet=[{"id":1,"money":10}], userdata=1大
📤 发送投注请求: https://xxx/frcomgame/createmainorder
📥 投注响应: {"status":true,"msg":"下注成功!","BettingNumber":7692}
✅ 投注成功: 7692
✅ 【测试】投注成功！
   订单号:7692
   耗时:125ms
🎲 【测试】投注测试完成
```

### 失败输出示例

```
🎲 【测试】开始投注测试...
   固定投注内容:1大10
📤 调用PlaceBetAsync:内容=1大10
❌ 未登录，无法下注
❌ 【测试】投注失败
   耗时:5ms
🎲 【测试】投注测试完成
```

---

## 🔍 Cookie获取方法对比

### WebView2 API
- ✅ **优点：** 官方API，使用简单
- ❌ **缺点：** 可能不包含HttpOnly的Cookie，不够可靠
- **适用：** 一般网站

### JavaScript document.cookie
- ✅ **优点：** 直接从页面读取
- ❌ **缺点：** 无法获取HttpOnly的Cookie
- **适用：** 非安全Cookie

### HTTP拦截（F5BotV2方式）
- ✅ **优点：** 最可靠，能获取所有请求参数
- ✅ **优点：** 不依赖Cookie，直接拿关键参数（sid, uuid, token）
- ✅ **优点：** 符合F5BotV2的设计
- **适用：** 生产环境推荐

---

## 📝 代码实现

### 文件修改

1. **`BsBrowserClient/Form1.Designer.cs`**
   - 添加`btnTestCookie`按钮
   - 添加`btnTestBet`按钮
   - 调整URL文本框宽度

2. **`BsBrowserClient/Form1.cs`**
   - 添加`btnTestCookie_Click`事件处理
   - 添加`btnTestBet_Click`事件处理
   - 使用反射获取`TongBaoScript`的私有字段

### 关键代码：反射获取私有字段

```csharp
var tongBaoScript = _platformScript as PlatformScripts.TongBaoScript;
if (tongBaoScript != null)
{
    var typeInfo = tongBaoScript.GetType();
    var sidField = typeInfo.GetField("_sid", BindingFlags.NonPublic | BindingFlags.Instance);
    var uuidField = typeInfo.GetField("_uuid", BindingFlags.NonPublic | BindingFlags.Instance);
    var tokenField = typeInfo.GetField("_token", BindingFlags.NonPublic | BindingFlags.Instance);
    
    var sid = sidField?.GetValue(tongBaoScript)?.ToString() ?? "";
    var uuid = uuidField?.GetValue(tongBaoScript)?.ToString() ?? "";
    var token = tokenField?.GetValue(tongBaoScript)?.ToString() ?? "";
}
```

---

## 🧪 使用场景

### 场景1：验证Cookie获取

**问题：** 不确定Cookie是否正确获取

**操作：**
1. 启动BrowserClient
2. 登录平台
3. 点击"C"按钮
4. 查看日志输出

**验证：**
- 方法1和方法2应该能看到Cookie
- 方法3应该看到sid、uuid、token
- 如果方法3没有数据，说明拦截未生效

### 场景2：测试投注逻辑

**问题：** 投注代码是否正确

**操作：**
1. 确保已登录
2. 点击"C"按钮，确认关键参数已拦截
3. 点击"投"按钮
4. 查看投注结果

**验证：**
- 查看投注包是否正确组装：`arrbet=[{"id":1,"money":10}]`
- 查看POST请求是否发送
- 查看平台响应是否成功
- 查看是否拿到订单号

### 场景3：调试拦截问题

**问题：** 拦截未生效，sid/uuid/token为空

**排查：**
1. 点击"C"按钮，查看方法3输出
2. 如果显示"⚠️ 警告：关键参数未拦截到！"
3. 刷新页面或执行任意操作（如：点击余额查询）
4. 再次点击"C"按钮
5. 确认是否成功拦截

---

## 💡 技术细节

### 为什么需要HTTP拦截？

F5BotV2的设计中，通宝平台的投注需要三个关键参数：
- `sid` - Session ID
- `uuid` - User ID
- `token` - 验证令牌

这些参数不是存储在Cookie中，而是在每次HTTP请求中动态传递。因此：

**WebView2 API或JavaScript获取的Cookie：**
```
PHPSESSID=abc123; path=/; domain=.yunding28.com
token=xyz789; path=/; domain=.yunding28.com
```
❌ 这些Cookie**不能直接用于投注**

**通过拦截获取的参数：**
```
uuid=10014139
sid=9cbc377084ec37b28bc1d1d64a55210d0034174
token=640006705068482b6ca1b089c29a8eb1
```
✅ 这些参数**可以直接用于投注**

### 拦截的触发时机

拦截器监听的URL：`/gettodaywinlost`

这个请求会在以下情况触发：
- 页面加载完成后
- 查询余额时
- 执行任何平台操作时

如果刚打开页面，拦截器可能还没有捕获到请求。此时需要：
- 刷新页面
- 点击平台上的任意按钮
- 等待页面自动刷新余额

---

## 🎯 预期效果

### 正常流程

1. **启动BrowserClient**
2. **登录通宝平台**
3. **点击"C"按钮**
   - 应该看到3种方法的输出
   - 方法3应该显示关键参数
   - 如果方法3为空，执行任意操作后再点击
4. **点击"投"按钮**
   - 应该看到投注成功
   - 拿到平台订单号
   - 耗时约100-300ms

### 异常情况

**情况1：未登录**
```
❌ 未登录，无法下注
```
**解决：** 手动登录平台

**情况2：关键参数未拦截**
```
⚠️ 警告：关键参数未拦截到！
```
**解决：** 刷新页面或执行操作

**情况3：投注失败**
```
❌ 投注失败: 无注单可投!
```
**解决：** 检查期号、检查平台状态

---

## 📋 修改文件清单

1. ✅ `BsBrowserClient/Form1.Designer.cs` - 添加按钮布局
2. ✅ `BsBrowserClient/Form1.cs` - 添加按钮事件处理

---

**功能已完成！🚀 请重新编译测试！**

**测试步骤：**
1. 编译：`dotnet build BsBrowserClient/BsBrowserClient.csproj`
2. 启动BrowserClient
3. 登录通宝平台
4. 点击"C"测试Cookie
5. 点击"投"测试投注
6. 查看日志输出

**提示：**
- 如果方法3显示"关键参数未拦截"，请刷新页面
- 投注测试会实际发送请求到平台，请确保测试环境
- 测试投注固定为"1大10"，金额较小

**祝测试顺利！** 😊

