# æ€§èƒ½ä¼˜åŒ–è¯´æ˜ - æ—¥å¿—å’Œæ¨¡æ¿è·¯å¾„ä¿®å¤

## ä¿®å¤æ—¥æœŸ
2025-11-14

## é—®é¢˜1ï¼šæ¨¡æ¿æ–‡ä»¶è·¯å¾„é”™è¯¯

### é—®é¢˜æè¿°
```
2025-11-14 09:31:09.259 é”™è¯¯ BinggoLotteryService æ¨¡æ¿æ–‡ä»¶ä¸å­˜åœ¨: C:\Program Files (x86)\BaiSheng\v3plus\bgzst.png
```

æ¨¡æ¿æ–‡ä»¶å®é™…è·¯å¾„åº”è¯¥æ˜¯ `./libs/bgzst.png`ï¼Œä½†ä»£ç ä¸­é…ç½®çš„è·¯å¾„é”™è¯¯ã€‚

### ä¿®å¤ä½ç½®
**æ–‡ä»¶ï¼š** `BaiShengVx3Plus/Services/Games/Binggo/BinggoLotteryService.cs`

**è¡Œå·ï¼š** çº¦ç¬¬1446-1453è¡Œ

**ä¿®å¤å‰ï¼š**
```csharp
string templatePath = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "bgzst.png");
```

**ä¿®å¤åï¼š**
```csharp
// ğŸ”¥ æ¨¡æ¿å›¾ç‰‡è·¯å¾„ï¼ˆåœ¨ libs ç›®å½•ä¸‹ï¼‰
string templatePath = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "libs", "bgzst.png");
if (!File.Exists(templatePath))
{
    _logService.Error("BinggoLotteryService", $"æ¨¡æ¿æ–‡ä»¶ä¸å­˜åœ¨: {templatePath}");
    _logService.Error("BinggoLotteryService", $"è¯·ç¡®ä¿ libs/bgzst.png æ–‡ä»¶å­˜åœ¨");
    return false;
}
```

### éªŒè¯
ç¡®ä¿ä»¥ä¸‹æ–‡ä»¶å­˜åœ¨ï¼š
- `./libs/bgzst.png`ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
- ç¼–è¯‘åä¼šè‡ªåŠ¨å¤åˆ¶åˆ°è¾“å‡ºç›®å½•çš„ `libs/bgzst.png`ï¼ˆç”± .csproj é…ç½®ï¼‰

---

## é—®é¢˜2ï¼šæ—¥å¿—æ€§èƒ½é—®é¢˜ï¼ˆ100ä¸‡+æ¡æ•°æ®å¯¼è‡´å¡é¡¿ï¼‰

### é—®é¢˜æè¿°
æ—¥å¿—ç»Ÿè®¡æŸ¥è¯¢æ—¶ï¼Œä½¿ç”¨äº† `connection.Table<LogEntry>().ToList()`ï¼Œä¼šå°†**æ‰€æœ‰æ—¥å¿—æ•°æ®**ï¼ˆ100å¤šä¸‡æ¡ï¼‰åŠ è½½åˆ°å†…å­˜ï¼Œå¯¼è‡´ä¸¥é‡å¡é¡¿ã€‚

### ä¿®å¤ä½ç½®
**æ–‡ä»¶ï¼š** `BaiShengVx3Plus/Services/Logging/LogService.cs`

**æ–¹æ³•ï¼š** `GetStatistics()`ï¼ˆçº¦ç¬¬149-174è¡Œï¼‰

**ä¿®å¤å‰ï¼š**
```csharp
public LogStatistics GetStatistics()
{
    try
    {
        using var connection = new SQLiteConnection(_dbPath);
        var allLogs = connection.Table<LogEntry>().ToList();  // âŒ åŠ è½½æ‰€æœ‰æ•°æ®åˆ°å†…å­˜ï¼

        return new LogStatistics
        {
            TotalCount = allLogs.Count,
            TraceCount = allLogs.Count(l => l.Level == LogLevel.Trace),
            DebugCount = allLogs.Count(l => l.Level == LogLevel.Debug),
            // ... æ›´å¤šç»Ÿè®¡
        };
    }
    catch
    {
        return new LogStatistics();
    }
}
```

**ä¿®å¤åï¼š**
```csharp
public LogStatistics GetStatistics()
{
    try
    {
        using var connection = new SQLiteConnection(_dbPath);
        
        // ğŸ”¥ æ€§èƒ½ä¼˜åŒ–ï¼šä½¿ç”¨ SQL COUNT è€Œä¸æ˜¯åŠ è½½æ‰€æœ‰æ•°æ®åˆ°å†…å­˜
        // é¿å…åŠ è½½100ä¸‡+æ¡æ•°æ®å¯¼è‡´å¡é¡¿
        return new LogStatistics
        {
            TotalCount = connection.ExecuteScalar<int>("SELECT COUNT(*) FROM LogEntry"),
            TraceCount = connection.ExecuteScalar<int>("SELECT COUNT(*) FROM LogEntry WHERE Level = ?", (int)LogLevel.Trace),
            DebugCount = connection.ExecuteScalar<int>("SELECT COUNT(*) FROM LogEntry WHERE Level = ?", (int)LogLevel.Debug),
            InfoCount = connection.ExecuteScalar<int>("SELECT COUNT(*) FROM LogEntry WHERE Level = ?", (int)LogLevel.Info),
            WarningCount = connection.ExecuteScalar<int>("SELECT COUNT(*) FROM LogEntry WHERE Level = ?", (int)LogLevel.Warning),
            ErrorCount = connection.ExecuteScalar<int>("SELECT COUNT(*) FROM LogEntry WHERE Level = ?", (int)LogLevel.Error),
            FatalCount = connection.ExecuteScalar<int>("SELECT COUNT(*) FROM LogEntry WHERE Level = ?", (int)LogLevel.Fatal),
            FirstLogTime = connection.ExecuteScalar<DateTime?>("SELECT MIN(Timestamp) FROM LogEntry"),
            LastLogTime = connection.ExecuteScalar<DateTime?>("SELECT MAX(Timestamp) FROM LogEntry")
        };
    }
    catch
    {
        return new LogStatistics();
    }
}
```

### æ€§èƒ½æå‡
- **ä¿®å¤å‰ï¼š** åŠ è½½100ä¸‡æ¡æ•°æ®åˆ°å†…å­˜ â†’ è€—æ—¶æ•°ç§’ï¼Œå†…å­˜å ç”¨æ•°ç™¾MB
- **ä¿®å¤åï¼š** SQL COUNT ç›´æ¥åœ¨æ•°æ®åº“ä¸­ç»Ÿè®¡ â†’ è€—æ—¶å‡ æ¯«ç§’ï¼Œæ— å†…å­˜å ç”¨

---

## æ—¥å¿—ç³»ç»Ÿç°æœ‰ä¼˜åŒ–

æ—¥å¿—ç³»ç»Ÿå·²ç»å®ç°äº†ä»¥ä¸‹ä¼˜åŒ–ï¼š

### 1. å†…å­˜æ—¥å¿—é™åˆ¶
- å†…å­˜ä¸­æœ€å¤šä¿ç•™ **1000 æ¡**æœ€æ–°æ—¥å¿—ï¼ˆ`MaxMemoryLogs = 1000`ï¼‰
- è¶…å‡ºéƒ¨åˆ†è‡ªåŠ¨åˆ é™¤æ—§æ—¥å¿—
- é¿å…å†…å­˜æ— é™å¢é•¿

### 2. å®æ—¶æ˜¾ç¤ºä¼˜åŒ–
- æ—¥å¿—æŸ¥çœ‹ç•Œé¢æœ€å¤šæ˜¾ç¤º **1000 æ¡**æ—¥å¿—
- è¶…å‡ºéƒ¨åˆ†è‡ªåŠ¨åˆ é™¤é¡¶éƒ¨æ—§æ•°æ®
- æ™ºèƒ½æ»šåŠ¨ï¼šåªæœ‰ç”¨æˆ·åœ¨åº•éƒ¨æ—¶æ‰è‡ªåŠ¨æ»šåŠ¨

### 3. æŸ¥è¯¢ä¼˜åŒ–
- æŸ¥è¯¢æ—¶é»˜è®¤é™åˆ¶ **1000 æ¡**ï¼ˆ`QueryLogs` æ–¹æ³•çš„ `limit` å‚æ•°ï¼‰
- æ”¯æŒæŒ‰æ—¶é—´ã€çº§åˆ«ã€æ¥æºã€å…³é”®è¯è¿‡æ»¤
- ä½¿ç”¨ SQL ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½

### 4. æ‰¹é‡å†™å…¥ä¼˜åŒ–
- ä½¿ç”¨åå°çº¿ç¨‹å¼‚æ­¥æ‰¹é‡å†™å…¥æ•°æ®åº“
- æ‰¹é‡å¤§å°ï¼š100 æ¡ï¼ˆ`BatchSize = 100`ï¼‰
- å®šæ—¶åˆ·æ–°ï¼š1ç§’ï¼ˆ`FlushIntervalMs = 1000`ï¼‰

---

## å»ºè®®ï¼šå®šæœŸæ¸…ç†æ—¥å¿—æ•°æ®åº“

å¦‚æœæ—¥å¿—æ•°æ®åº“å·²ç»ç§¯ç´¯äº†100ä¸‡+æ¡æ•°æ®ï¼Œå»ºè®®å®šæœŸæ¸…ç†ï¼š

### æ–¹æ³•1ï¼šæ‰‹åŠ¨æ¸…ç†ï¼ˆé€šè¿‡ç•Œé¢ï¼‰
1. æ‰“å¼€"ç³»ç»Ÿæ—¥å¿—"çª—å£
2. ç‚¹å‡»"æ¸…ç©ºæ•°æ®åº“æ—¥å¿—"æŒ‰é’®
3. ç¡®è®¤æ¸…ç©º

### æ–¹æ³•2ï¼šè‡ªåŠ¨æ¸…ç†ï¼ˆå»ºè®®å®ç°ï¼‰

å¯ä»¥åœ¨ `LogService` ä¸­æ·»åŠ è‡ªåŠ¨æ¸…ç†åŠŸèƒ½ï¼š

```csharp
// å»ºè®®æ·»åŠ åˆ° LogService çš„åˆå§‹åŒ–ä¸­
private void AutoCleanOldLogs()
{
    try
    {
        using var connection = new SQLiteConnection(_dbPath);
        
        // åªä¿ç•™æœ€è¿‘30å¤©çš„æ—¥å¿—
        var cutoffDate = DateTime.Now.AddDays(-30);
        connection.Execute("DELETE FROM LogEntry WHERE Timestamp < ?", cutoffDate);
        
        // æˆ–è€…ï¼šåªä¿ç•™æœ€è¿‘10ä¸‡æ¡æ—¥å¿—
        connection.Execute(@"
            DELETE FROM LogEntry 
            WHERE Id NOT IN (
                SELECT Id FROM LogEntry 
                ORDER BY Timestamp DESC 
                LIMIT 100000
            )
        ");
    }
    catch (Exception ex)
    {
        Console.WriteLine($"è‡ªåŠ¨æ¸…ç†æ—¥å¿—å¤±è´¥: {ex.Message}");
    }
}
```

### æ–¹æ³•3ï¼šæ•°æ®åº“ä¼˜åŒ–ï¼ˆå®šæœŸæ‰§è¡Œï¼‰

```csharp
// ä¼˜åŒ–æ•°æ®åº“ï¼ˆå‡å°‘ç¢ç‰‡ï¼Œæé«˜æ€§èƒ½ï¼‰
using var connection = new SQLiteConnection(_dbPath);
connection.Execute("VACUUM");  // å‹ç¼©æ•°æ®åº“
connection.Execute("ANALYZE"); // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
```

---

## æ€»ç»“

### å·²ä¿®å¤
1. âœ… æ¨¡æ¿æ–‡ä»¶è·¯å¾„ä» `bgzst.png` ä¿®æ”¹ä¸º `libs/bgzst.png`
2. âœ… æ—¥å¿—ç»Ÿè®¡æŸ¥è¯¢ä¼˜åŒ–ï¼Œä½¿ç”¨ SQL COUNT ä»£æ›¿åŠ è½½æ‰€æœ‰æ•°æ®

### æ€§èƒ½æå‡
- æ—¥å¿—ç»Ÿè®¡æŸ¥è¯¢ï¼šä»**æ•°ç§’**ä¼˜åŒ–åˆ°**å‡ æ¯«ç§’**
- å†…å­˜å ç”¨ï¼šä»**æ•°ç™¾MB**ä¼˜åŒ–åˆ°**å‡ ä¹ä¸º0**
- ç•Œé¢å“åº”ï¼šä¸å†å¡é¡¿

### å»ºè®®
- å»ºè®®å®ç°è‡ªåŠ¨æ¸…ç†åŠŸèƒ½ï¼Œå®šæœŸæ¸…ç†è¶…è¿‡30å¤©æˆ–è¶…è¿‡10ä¸‡æ¡çš„æ—§æ—¥å¿—
- å»ºè®®å®šæœŸæ‰§è¡Œ `VACUUM` å’Œ `ANALYZE` ä¼˜åŒ–æ•°æ®åº“æ€§èƒ½

