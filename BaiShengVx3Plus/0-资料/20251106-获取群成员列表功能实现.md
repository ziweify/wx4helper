# è·å–ç¾¤æˆå‘˜åˆ—è¡¨åŠŸèƒ½å®ç°

**å®Œæˆæ—¶é—´**: 2025å¹´11æœˆ6æ—¥ 00:30  
**çŠ¶æ€**: âœ… ä»£ç å®ç°å®Œæˆï¼Œç­‰å¾…ç¼–è¯‘æµ‹è¯•  
**åŠŸèƒ½**: æŸ¥è¯¢ `chatroom_member` è¡¨æ•°æ®

---

## ğŸ¯ å®ç°å†…å®¹

### 1. C++ ç«¯å®ç° âœ…

#### Features.cpp - `Core::GetGroupContacts()`

**æ–‡ä»¶**: `WeixinX/WeixinX/Features.cpp`  
**è¡Œæ•°**: 737-869 (133 è¡Œ)

**åŠŸèƒ½**:
- æŸ¥è¯¢ `contact.db` æ•°æ®åº“ä¸­çš„ `chatroom_member` è¡¨
- æš‚æ—¶è·å–æ‰€æœ‰æ•°æ®ï¼ˆä¸è¿‡æ»¤ `wxid`ï¼‰
- è¿”å› JSON æ ¼å¼çš„ç¾¤æˆå‘˜åˆ—è¡¨

**SQL æŸ¥è¯¢**:
```sql
SELECT room_id, member_id 
FROM chatroom_member 
ORDER BY room_id, member_id
```

**è¿”å›æ ¼å¼**:
```json
[
  {
    "room_id": "1",
    "member_id": "2"
  },
  {
    "room_id": "1",
    "member_id": "3"
  }
]
```

**é˜²å¾¡æ€§ç¼–ç¨‹**:
- âœ… æ£€æŸ¥æ•°æ®åº“å¥æŸ„æ˜¯å¦å­˜åœ¨
- âœ… æ£€æŸ¥æ•°æ®åº“å¥æŸ„å€¼æ˜¯å¦ä¸ºç©ºï¼ˆ0ï¼‰
- âœ… æ­£ç¡®é‡Šæ”¾èµ„æºï¼ˆ`free_table`ï¼‰
- âœ… è¯¦ç»†çš„æ—¥å¿—è®°å½•

---

#### SocketCommands.cpp - `HandleGetGroupContacts()`

**æ–‡ä»¶**: `WeixinX/WeixinX/SocketCommands.cpp`  
**è¡Œæ•°**: 60-106 (47 è¡Œ)

**åŠŸèƒ½**:
- å¤„ç†å®¢æˆ·ç«¯å‘é€çš„ `GetGroupContacts` å‘½ä»¤
- è°ƒç”¨ `Core::GetGroupContacts()` æŸ¥è¯¢æ•°æ®åº“
- è§£æ JSON å­—ç¬¦ä¸²å¹¶è¿”å›ç»“æœ

**å‚æ•°** (å¯é€‰):
- `groupId` (string): ç¾¤ IDï¼Œæš‚æ—¶ä¸ä½¿ç”¨è¿‡æ»¤

**è°ƒç”¨ç¤ºä¾‹**:
```csharp
// æ— å‚æ•°ï¼ˆè·å–æ‰€æœ‰ç¾¤æˆå‘˜ï¼‰
GetGroupContacts()

// å¸¦å‚æ•°ï¼ˆå°†æ¥ç”¨äºè¿‡æ»¤ï¼‰
GetGroupContacts("27206515609@chatroom")
```

**é”™è¯¯å¤„ç†**:
- âœ… Try-catch å¼‚å¸¸æ•è·
- âœ… JSON è§£æé”™è¯¯å¤„ç†
- âœ… è¯¦ç»†çš„æ—¥å¿—è®°å½•

---

### 2. C# ç«¯å®ç° âœ…

#### SettingsForm.Designer.cs - æŒ‰é’®å®šä¹‰

**æ–‡ä»¶**: `BaiShengVx3Plus/Views/SettingsForm.Designer.cs`  
**è¡Œæ•°**: 504-516

**æ§ä»¶**:
- **åç§°**: `btnQuickGetGroupContacts`
- **æ–‡æœ¬**: "è·å–ç¾¤æˆå‘˜åˆ—è¡¨"
- **Tag**: `"GetGroupContacts()"`
- **ä½ç½®**: (280, 35)
- **å¤§å°**: (131, 29)
- **äº‹ä»¶**: `btnQuickCommand_Click`

**å¸ƒå±€**:
```
å¿«æ·å‘½ä»¤
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [è·å–ç”¨æˆ·ä¿¡æ¯] [è·å–è”ç³»äººåˆ—è¡¨] [è·å–ç¾¤æˆå‘˜åˆ—è¡¨] â”‚
â”‚ [å‘é€æ¶ˆæ¯]     [å‘é€å›¾ç‰‡]                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š æ•°æ®åº“è¡¨ç»“æ„

### chatroom_member è¡¨

```sql
CREATE TABLE chatroom_member(
    room_id INTEGER, 
    member_id INTEGER, 
    CONSTRAINT room_member UNIQUE(room_id, member_id)
)
```

**å­—æ®µè¯´æ˜**:
- `room_id`: ç¾¤èŠ IDï¼ˆINTEGERï¼‰
- `member_id`: æˆå‘˜ IDï¼ˆINTEGERï¼‰

**ç´¢å¼•**:
- `chatroom_member_room_id ON chatroom_member(room_id)`
- `chatroom_member_member_id ON chatroom_member(member_id)`

**çº¦æŸ**:
- UNIQUE(`room_id`, `member_id`): ç¡®ä¿åŒä¸€ç¾¤èŠä¸­åŒä¸€æˆå‘˜åªæœ‰ä¸€æ¡è®°å½•

---

### ç›¸å…³è¡¨

#### chat_room è¡¨
```sql
CREATE TABLE chat_room(
    id INTEGER PRIMARY KEY, 
    username TEXT, 
    owner TEXT, 
    ext_buffer BLOB
)
```

**ç”¨é€”**: è·å–ç¾¤èŠè¯¦ç»†ä¿¡æ¯ï¼ˆç¾¤åã€ç¾¤ä¸»ç­‰ï¼‰

#### contact è¡¨
```sql
CREATE TABLE contact(
    id INTEGER PRIMARY KEY, 
    username TEXT, 
    nick_name TEXT, 
    ...
)
```

**ç”¨é€”**: è·å–æˆå‘˜è¯¦ç»†ä¿¡æ¯ï¼ˆæ˜µç§°ã€å¤´åƒç­‰ï¼‰

---

## ğŸ”§ ç¼–è¯‘å’Œæµ‹è¯•

### 1. ç¼–è¯‘ WeixinX.dll

**åœ¨ Visual Studio ä¸­**:
```
1. æ‰“å¼€ WeixinX.sln
2. é€‰æ‹© Release | Win32 é…ç½®
3. ç”Ÿæˆ â†’ ç”Ÿæˆ WeixinX é¡¹ç›®
```

**ä½¿ç”¨æ‰¹å¤„ç†**:
```cmd
cd D:\gitcode\wx4helper\WeixinX
build_weixinx.bat
```

**è¾“å‡º**:
- `D:\gitcode\wx4helper\bin\release\net8.0-windows\WeixinX.dll`

---

### 2. ç¼–è¯‘ BaiShengVx3Plus

**åœ¨ Visual Studio ä¸­**:
```
1. æ‰“å¼€ Vx3Plus.sln
2. é€‰æ‹© Debug é…ç½®
3. ç”Ÿæˆ â†’ ç”Ÿæˆ BaiShengVx3Plus é¡¹ç›®
```

**ä½¿ç”¨ dotnet CLI**:
```cmd
cd D:\gitcode\wx4helper\BaiShengVx3Plus
dotnet build -c Debug
```

---

### 3. æµ‹è¯•æ­¥éª¤

#### â‘  å¯åŠ¨ç¨‹åº
```
1. è¿è¡Œ BaiShengVx3Plus.exe
2. ç™»å½•
3. ç‚¹å‡» VxMain çš„"é‡‡é›†"æŒ‰é’®
4. ç­‰å¾…å¾®ä¿¡å¯åŠ¨å¹¶æ³¨å…¥ DLL
5. ç­‰å¾…è¿æ¥æˆåŠŸ
```

#### â‘¡ æ‰“å¼€è®¾ç½®çª—å£
```
1. ç‚¹å‡» VxMain çš„"è®¾ç½®"æŒ‰é’®
2. åˆ‡æ¢åˆ°"å‘½ä»¤æµ‹è¯•"æ ‡ç­¾é¡µ
3. ç¡®è®¤è¿æ¥çŠ¶æ€ä¸º"å·²è¿æ¥ âœ“"
```

#### â‘¢ æµ‹è¯•è·å–ç¾¤æˆå‘˜åˆ—è¡¨
```
1. ç‚¹å‡»"è·å–ç¾¤æˆå‘˜åˆ—è¡¨"æŒ‰é’®
2. è§‚å¯Ÿæ‰§è¡Œç»“æœæ¡†
3. åº”è¯¥æ˜¾ç¤ºï¼š
   >>> å‘é€å‘½ä»¤: GetGroupContacts()
   <<< å“åº”: [
     {
       "room_id": "1",
       "member_id": "2"
     },
     ...
   ]
```

#### â‘£ è§‚å¯Ÿæ—¥å¿—
```
1. æ‰“å¼€æ—¥å¿—çª—å£
2. æŸ¥çœ‹ç›¸å…³æ—¥å¿—ï¼š
   - GetGroupContacts: Starting to query chatroom_member database
   - GetGroupContacts: Executing SQL
   - GetGroupContacts: Query successful, rows=X, cols=2
   - GetGroupContacts: Parsed X members
   - GetGroupContacts: Returning X bytes of JSON
```

---

## ğŸ“ æµ‹è¯•ç”¨ä¾‹

### æµ‹è¯•ç”¨ä¾‹ 1: è·å–æ‰€æœ‰ç¾¤æˆå‘˜

**å‘½ä»¤**:
```
GetGroupContacts()
```

**é¢„æœŸç»“æœ**:
```json
[
  {
    "room_id": "1",
    "member_id": "101"
  },
  {
    "room_id": "1",
    "member_id": "102"
  },
  {
    "room_id": "2",
    "member_id": "201"
  }
]
```

**éªŒè¯**:
- âœ… è¿”å›æ•°ç»„æ ¼å¼
- âœ… åŒ…å« `room_id` å’Œ `member_id` å­—æ®µ
- âœ… æŒ‰ `room_id` å’Œ `member_id` æ’åº

---

### æµ‹è¯•ç”¨ä¾‹ 2: æ•°æ®åº“æœªç™»å½•

**åœºæ™¯**: å¾®ä¿¡æœªç™»å½•

**é¢„æœŸç»“æœ**:
```json
{
  "error": "contact.db handle is null, WeChat may not be logged in"
}
```

**éªŒè¯**:
- âœ… è¿”å›é”™è¯¯å¯¹è±¡
- âœ… åŒ…å« `error` å­—æ®µ
- âœ… æç¤ºç”¨æˆ·ç™»å½•å¾®ä¿¡

---

### æµ‹è¯•ç”¨ä¾‹ 3: ç©ºæ•°æ®

**åœºæ™¯**: æ²¡æœ‰ç¾¤æˆå‘˜æ•°æ®

**é¢„æœŸç»“æœ**:
```json
[]
```

**éªŒè¯**:
- âœ… è¿”å›ç©ºæ•°ç»„
- âœ… ä¸è¿”å›é”™è¯¯

---

## ğŸš€ åç»­ä¼˜åŒ–

### 1. æ·»åŠ  wxid è¿‡æ»¤

**å½“å‰**:
```cpp
std::string sql = 
    "SELECT room_id, member_id "
    "FROM chatroom_member "
    "ORDER BY room_id, member_id";
```

**ä¼˜åŒ–å** (å¸¦è¿‡æ»¤):
```cpp
std::string sql = 
    "SELECT "
    "cm.room_id, "
    "cm.member_id, "
    "c.username, "
    "c.nick_name, "
    "c.small_head_url "
    "FROM chatroom_member cm "
    "LEFT JOIN contact c ON c.id = cm.member_id "
    "WHERE cm.room_id = (SELECT id FROM chat_room WHERE username = ?) "
    "ORDER BY cm.member_id";
```

**å¥½å¤„**:
- âœ… åªè¿”å›æŒ‡å®šç¾¤èŠçš„æˆå‘˜
- âœ… åŒ…å«æˆå‘˜è¯¦ç»†ä¿¡æ¯ï¼ˆæ˜µç§°ã€å¤´åƒï¼‰
- âœ… å‡å°‘æ•°æ®ä¼ è¾“é‡

---

### 2. æ·»åŠ æˆå‘˜è¯¦ç»†ä¿¡æ¯

**å½“å‰è¿”å›**:
```json
{
  "room_id": "1",
  "member_id": "2"
}
```

**ä¼˜åŒ–å** (åŒ…å«è¯¦ç»†ä¿¡æ¯):
```json
{
  "room_id": "1",
  "member_id": "2",
  "username": "wxid_abc123",
  "nick_name": "å¼ ä¸‰",
  "small_head_url": "https://...",
  "display_name": "ç¾¤æ˜µç§°"
}
```

---

### 3. æ·»åŠ ç¾¤èŠä¿¡æ¯

**æ‰©å±•è¿”å›**:
```json
{
  "group_info": {
    "username": "27206515609@chatroom",
    "owner": "wxid_owner",
    "member_count": 10
  },
  "members": [
    {
      "member_id": "2",
      "username": "wxid_abc123",
      "nick_name": "å¼ ä¸‰"
    }
  ]
}
```

---

## ğŸ¯ æ ¸å¿ƒå®ç°ç‚¹

### 1. å‚è€ƒ `GetContacts` çš„å®ç°

âœ… **å·²å®Œæˆ**:
- æ•°æ®åº“å¥æŸ„æ£€æŸ¥
- SQL æŸ¥è¯¢æ‰§è¡Œ
- JSON ç»“æœæ„å»º
- èµ„æºé‡Šæ”¾
- é”™è¯¯å¤„ç†

### 2. ä½¿ç”¨ `get_table` æŸ¥è¯¢

```cpp
rc = util::invokeCdecl<int>(
    (void*)(base + WeixinX::weixin_dll::v41021::offset::db::get_table),
    dbHandle,  // æ•°æ®åº“å¥æŸ„
    sql.c_str(),  // SQL è¯­å¥
    &result,  // ç»“æœæŒ‡é’ˆ
    &row,  // è¡Œæ•°
    &col,  // åˆ—æ•°
    &err  // é”™è¯¯ä¿¡æ¯
);
```

**ç»“æœæ ¼å¼**:
```
result[0] = "room_id"        â† åˆ—å
result[1] = "member_id"      â† åˆ—å
result[2] = "1"              â† ç¬¬1è¡Œç¬¬1åˆ—
result[3] = "101"            â† ç¬¬1è¡Œç¬¬2åˆ—
result[4] = "1"              â† ç¬¬2è¡Œç¬¬1åˆ—
result[5] = "102"            â† ç¬¬2è¡Œç¬¬2åˆ—
...
```

### 3. éå†ç»“æœå¹¶æ„å»º JSON

```cpp
int idx = col;  // ä» col å¼€å§‹ï¼Œè·³è¿‡åˆ—åè¡Œ

for (int x = 0; x < row; x++)
{
    Json::Value member;
    
    for (int y = 0; y < col; y++)
    {
        const char* columnName = result[y];       // åˆ—å
        const char* value = result[idx++];        // æ•°æ®å€¼
        
        if (value != nullptr && strlen(value) > 0)
        {
            member[columnName] = value;
        }
        else
        {
            member[columnName] = "";
        }
    }
    
    members.append(member);
}
```

---

## âœ… å®Œæˆæ¸…å•

### C++ ç«¯
- [x] å®ç° `Core::GetGroupContacts()` æ–¹æ³•
- [x] æ·»åŠ æ•°æ®åº“å¥æŸ„æ£€æŸ¥
- [x] æ‰§è¡Œ SQL æŸ¥è¯¢
- [x] æ„å»º JSON ç»“æœ
- [x] é‡Šæ”¾èµ„æº
- [x] æ·»åŠ è¯¦ç»†æ—¥å¿—
- [x] å®ç° `HandleGetGroupContacts()` æ–¹æ³•
- [x] è§£æ JSON å­—ç¬¦ä¸²
- [x] é”™è¯¯å¤„ç†
- [ ] ç¼–è¯‘ WeixinX.dll

### C# ç«¯
- [x] æ·»åŠ "è·å–ç¾¤æˆå‘˜åˆ—è¡¨"æŒ‰é’®
- [x] ç»‘å®š Tag ä¸º `"GetGroupContacts()"`
- [x] ç»‘å®šç‚¹å‡»äº‹ä»¶
- [ ] ç¼–è¯‘ BaiShengVx3Plus
- [ ] æµ‹è¯•åŠŸèƒ½

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- `GET_CONTACTS_IMPLEMENTATION.md` - GetContacts å®ç°å‚è€ƒ
- `DEFENSIVE_PROGRAMMING_GUIDE.md` - é˜²å¾¡æ€§ç¼–ç¨‹æŒ‡å—
- `SOCKET_TESTING_GUIDE.md` - Socket å‘½ä»¤æµ‹è¯•æŒ‡å—

---

**å®Œæˆæ—¶é—´**: 2025å¹´11æœˆ6æ—¥ 00:30  
**çŠ¶æ€**: âœ… ä»£ç å®ç°å®Œæˆ  
**ä¸‹ä¸€æ­¥**: **åœ¨ Visual Studio ä¸­ç¼–è¯‘ WeixinX.dll å’Œ BaiShengVx3Plusï¼Œç„¶åæµ‹è¯•åŠŸèƒ½ï¼** ğŸš€

