# 会员右键菜单实现完成

## ✅ 已完成功能

### 1. 会员类型枚举更新
```csharp
public enum OrderType
{
    待定 = 0,
    普会 = 1,       // 新增
    盘内 = 2,       // 会员（正式会员）
    盘外 = 3,       // 蓝会
    托 = 4,
    黄会 = 5        // 新增
}
```

### 2. 右键菜单功能

#### 2.1 清分功能 ✅
- **功能**：清空会员余额
- **实现**：
  - 记录清分前余额
  - 将余额设为0
  - 记录到资金变动表（`V2BalanceChange`）
  - 详细日志记录（操作人、群、会员、金额变化）
  - 更新数据库和UI
- **日志格式**：
  ```
  清分操作
  操作人：admin
  群：wxid_xxx
  会员：张三 (wxid_yyy)
  清分前余额：1250.50
  清分后余额：0.00
  清分金额：-1250.50
  ```

#### 2.2 删除会员功能 ✅（硬删除）
- **功能**：物理删除会员（不可恢复）
- **实现**：
  - 警告对话框提示硬删除
  - 详细日志记录所有会员数据
  - 从数据库物理删除
  - 从BindingList移除
  - 更新统计数据
- **日志格式**：
  ```
  删除会员操作
  操作人：admin
  群：wxid_xxx
  被删除会员信息：
    - 昵称：张三
    - 微信ID：wxid_yyy
    - 账号：account123
    - 当前余额：1250.50
    - 今日下注：150.00
    - 今日盈亏：85.50
    - 总下注：5280.00
    - 总盈亏：450.30
    - 今日上分：1000.00
    - 今日下分：500.00
    - 总上分：10000.00
    - 总下分：5000.00
  ```

#### 2.3 设置会员类型功能 ✅
- **功能**：设置会员为5种类型之一
- **类型**：
  - 普会
  - 会员（盘内）
  - 托
  - 蓝会（盘外）
  - 黄会
- **实现**：
  - 根据菜单项确定类型
  - 记录操作日志
  - 更新UI显示
- **备注**：目前V2Member暂未添加MemberType字段，后续可完善

#### 2.4 查看资金变动功能 ✅（UI已实现）
- **功能**：打开资金变动查看窗口
- **实现**：获取选中会员，准备打开窗口
- **状态**：事件已实现，等待窗口创建

### 3. 数据模型

#### 资金变动记录（V2BalanceChange）
| 字段 | 类型 | 说明 |
|-----|------|------|
| Id | long | 主键 |
| GroupWxId | string | 群ID |
| Wxid | string | 微信ID |
| Nickname | string | 昵称 |
| BalanceBefore | float | 变动前余额 |
| BalanceAfter | float | 变动后余额 |
| ChangeAmount | float | 变动金额 |
| Reason | enum | 变动原因 |
| RelatedOrderId | long | 关联订单ID |
| RelatedOrderInfo | string | 订单信息 |
| RelatedOrderTime | string | 订单时间（冗余） |
| IssueId | int | 期号 |
| TimeString | string | 变动时间 |
| Timestamp | long | 时间戳 |
| Notes | string | 备注 |

#### 变动原因枚举
```csharp
public enum ChangeReason
{
    未知 = 0,
    下注 = 1,
    订单结算 = 2,
    订单取消 = 3,
    上分 = 4,
    下分 = 5,
    清空数据 = 6,
    手动调整 = 7,
    补单 = 8
}
```

## 🔄 下一步工作

### 1. 创建资金变动查看窗口（进行中）
- 文件：`Views/BalanceChangeViewerForm.cs`
- 功能：
  - DataGridView显示资金变动记录
  - 按会员名字或Wxid查询
  - 按时间、原因筛选
  - 显示详细信息

### 2. 完善"查"命令
- 实现查询会员统计信息
- 回复格式与F5BotV2一致

### 3. 数据库初始化
- 在VxMain.InitializeDatabase中添加：
  ```csharp
  _db.CreateTable<V2BalanceChange>();
  _db.CreateTable<V2CreditWithdraw>();
  ```

### 4. 集成资金变动记录
需要在以下操作中记录资金变动：
- ✅ 清分（已实现）
- ⏳ 下注（待集成）
- ⏳ 订单结算（待集成）
- ⏳ 订单取消（待集成）
- ⏳ 上分（待实现）
- ⏳ 下分（待实现）
- ⏳ 清空数据（待集成）
- ⏳ 补单（待实现）

## 📝 使用说明

### 如何使用右键菜单

1. **清分会员**
   - 在会员列表中右键点击会员
   - 选择"清分"
   - 确认操作
   - 会员余额归零，记录到资金变动表

2. **删除会员**
   - 在会员列表中右键点击会员
   - 选择"删除会员"
   - 阅读警告信息，确认删除
   - 会员从系统中物理删除（不可恢复）
   - 详细日志已记录

3. **设置会员类型**
   - 在会员列表中右键点击会员
   - 选择"设置会员类型"
   - 选择类型：普会、会员、托、蓝会、黄会
   - 操作已记录到日志

4. **查看资金变动**
   - 在会员列表中右键点击会员
   - 选择"资金变动"
   - 打开资金变动查看窗口（开发中）

## ⚠️ 注意事项

1. **删除会员是硬删除**
   - 数据无法恢复
   - 所有操作都有详细日志
   - 资金变动表可追溯历史

2. **清分操作**
   - 会清空会员余额
   - 记录到资金变动表
   - 不影响其他统计数据

3. **日志记录**
   - 所有操作都记录操作人
   - 记录完整的数据变化
   - 可在日志系统中查询

## 🎯 测试清单

- [ ] 测试清分功能
- [ ] 测试删除会员功能
- [ ] 测试设置会员类型
- [ ] 检查日志记录是否完整
- [ ] 检查资金变动表数据
- [ ] 测试UI刷新
- [ ] 测试统计数据更新

