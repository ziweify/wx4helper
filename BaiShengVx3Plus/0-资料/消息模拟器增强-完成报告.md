# æ¶ˆæ¯æ¨¡æ‹Ÿå™¨å¢å¼º - å®ŒæˆæŠ¥å‘Š

## ğŸ“‹ å¢å¼ºç›®æ ‡

å¢å¼ºå¼€å‘æ¨¡å¼ä¸­çš„æ¶ˆæ¯æ¨¡æ‹Ÿå™¨ï¼Œè®©æ‰€æœ‰æ¶ˆæ¯éƒ½èƒ½æ­£å¸¸åœ¨æ¨¡æ‹Ÿå™¨ä¸­æ˜¾ç¤ºï¼ŒåŒ…æ‹¬ï¼š
- âœ… å¼€ç›˜æ¶ˆæ¯
- âœ… å°ç›˜æ¶ˆæ¯
- âœ… å¼€å¥–æ¶ˆæ¯
- âœ… ç»“ç®—æ¶ˆæ¯ï¼ˆä¸­~åå•ã€ç•™~åå•ï¼‰
- âœ… å‘é€å›¾ç‰‡ï¼ˆå†å²è®°å½•å›¾ç‰‡ç­‰ï¼‰
- âœ… å¾®ä¿¡ä¸­æ˜¾ç¤ºçš„æ‰€æœ‰ç³»ç»Ÿæ¶ˆæ¯
- âœ… æœºå™¨äººå‘é€çš„æ‰€æœ‰æ¶ˆæ¯

---

## âœ… å·²å®Œæˆçš„å¢å¼º

### 1. è®¢é˜…ç³»ç»Ÿæ¶ˆæ¯äº‹ä»¶

**æ–‡ä»¶**ï¼š`BaiShengVx3Plus/Views/Dev/MessageSimulatorForm.cs`

**åŠŸèƒ½**ï¼š
- âœ… è®¢é˜… `IBinggoLotteryService.StatusChanged` äº‹ä»¶ï¼ˆå¼€ç›˜ã€å°ç›˜ç­‰çŠ¶æ€å˜æ›´ï¼‰
- âœ… è®¢é˜… `IBinggoLotteryService.LotteryOpened` äº‹ä»¶ï¼ˆå¼€å¥–ï¼‰
- âœ… è®¢é˜… `IBinggoLotteryService.IssueChanged` äº‹ä»¶ï¼ˆæœŸå·å˜æ›´ï¼‰

**ä»£ç ä½ç½®**ï¼š
```csharp
private void SubscribeToSystemMessages()
{
    // è®¢é˜…çŠ¶æ€å˜æ›´äº‹ä»¶ï¼ˆå¼€ç›˜ã€å°ç›˜ç­‰ï¼‰
    _lotteryService.StatusChanged += LotteryService_StatusChanged;
    
    // è®¢é˜…å¼€å¥–äº‹ä»¶
    _lotteryService.LotteryOpened += LotteryService_LotteryOpened;
    
    // è®¢é˜…æœŸå·å˜æ›´äº‹ä»¶
    _lotteryService.IssueChanged += LotteryService_IssueChanged;
}
```

---

### 2. æ˜¾ç¤ºä¸åŒç±»å‹çš„æ¶ˆæ¯

**åŠŸèƒ½**ï¼š
- âœ… åŒºåˆ†ä¸åŒç±»å‹çš„æ¶ˆæ¯ï¼ˆå¼€ç›˜ã€å°ç›˜ã€å¼€å¥–ã€ç»“ç®—ã€å›¾ç‰‡ç­‰ï¼‰
- âœ… ä½¿ç”¨ä¸åŒé¢œè‰²æ˜¾ç¤ºä¸åŒç±»å‹çš„æ¶ˆæ¯
- âœ… æ”¯æŒæ˜¾ç¤ºå›¾ç‰‡æ¶ˆæ¯

**æ¶ˆæ¯ç±»å‹å’Œé¢œè‰²**ï¼š
| æ¶ˆæ¯ç±»å‹ | é¢œè‰² | è¯´æ˜ |
|---------|------|------|
| å¼€ç›˜ | ç»¿è‰² (39, 174, 96) | å¼€ç›˜æç¤ºæ¶ˆæ¯ |
| å°ç›˜ | æ©™è‰² (230, 126, 34) | å°ç›˜æ¶ˆæ¯ |
| å°ç›˜æé†’ | æ©™è‰² (230, 126, 34) | 30ç§’/15ç§’æé†’ |
| å¼€å¥– | çº¢è‰² (231, 76, 60) | å¼€å¥–é€šçŸ¥ |
| ç»“ç®— | è“è‰² (52, 152, 219) | ä¸­~åå•ã€ç•™~åå• |
| å›¾ç‰‡ | ç´«è‰² (155, 89, 182) | å†å²è®°å½•å›¾ç‰‡ |
| æœŸå·å˜æ›´ | ç´«è‰² (155, 89, 182) | æœŸå·å˜æ›´é€šçŸ¥ |
| ç³»ç»Ÿé€šçŸ¥ | è“è‰² (52, 152, 219) | å…¶ä»–ç³»ç»Ÿé€šçŸ¥ |

**ä»£ç ä½ç½®**ï¼š
```csharp
private void AppendSystemNotification(string message, Color color)
{
    // æ—¶é—´æˆ³ï¼ˆå·¦å¯¹é½ï¼Œç°è‰²å°å­—ï¼‰
    rtbMessages.SelectionAlignment = HorizontalAlignment.Left;
    rtbMessages.SelectionColor = Color.Gray;
    rtbMessages.SelectionFont = new Font(rtbMessages.Font.FontFamily, 8);
    rtbMessages.AppendText($"[{DateTime.Now:HH:mm:ss}] ç³»ç»Ÿé€šçŸ¥\n");

    // æ¶ˆæ¯å†…å®¹ï¼ˆå·¦å¯¹é½ï¼Œè‡ªå®šä¹‰é¢œè‰²ï¼‰
    rtbMessages.SelectionAlignment = HorizontalAlignment.Left;
    rtbMessages.SelectionColor = color;
    rtbMessages.SelectionFont = new Font(rtbMessages.Font.FontFamily, 10, FontStyle.Bold);
    rtbMessages.AppendText($"  {message}\n\n");
}
```

---

### 3. é™æ€æ¶ˆæ¯é€šçŸ¥æœºåˆ¶

**åŠŸèƒ½**ï¼š
- âœ… åˆ›å»ºé™æ€äº‹ä»¶ `SystemMessageSent`ï¼Œç”¨äºé€šçŸ¥æ‰€æœ‰æ¶ˆæ¯æ¨¡æ‹Ÿå™¨çª—å£
- âœ… åœ¨å¼€å‘æ¨¡å¼ä¸‹ï¼Œæ‰€æœ‰å‘é€åˆ°ç¾¤çš„æ¶ˆæ¯éƒ½é€šè¿‡è¿™ä¸ªæœºåˆ¶é€šçŸ¥æ¶ˆæ¯æ¨¡æ‹Ÿå™¨

**ä»£ç ä½ç½®**ï¼š
```csharp
/// <summary>
/// ğŸ”¥ é™æ€äº‹ä»¶ï¼šå¼€å‘æ¨¡å¼ä¸‹å‘é€åˆ°ç¾¤çš„æ¶ˆæ¯é€šçŸ¥ï¼ˆç”¨äºæ¶ˆæ¯æ¨¡æ‹Ÿå™¨æ˜¾ç¤ºï¼‰
/// </summary>
public static event EventHandler<(string messageType, string message, string? imagePath)>? SystemMessageSent;

/// <summary>
/// ğŸ”¥ é™æ€æ–¹æ³•ï¼šé€šçŸ¥æ‰€æœ‰æ¶ˆæ¯æ¨¡æ‹Ÿå™¨çª—å£æ˜¾ç¤ºç³»ç»Ÿæ¶ˆæ¯ï¼ˆå¼€å‘æ¨¡å¼ä¸“ç”¨ï¼‰
/// </summary>
public static void NotifySystemMessage(string messageType, string message, string? imagePath = null)
{
    SystemMessageSent?.Invoke(null, (messageType, message, imagePath));
}
```

---

### 4. åœ¨ BinggoLotteryService ä¸­é›†æˆæ¶ˆæ¯é€šçŸ¥

**æ–‡ä»¶**ï¼š`BaiShengVx3Plus/Services/Games/Binggo/BinggoLotteryService.cs`

**åŠŸèƒ½**ï¼š
- âœ… å‘é€å¼€ç›˜æ¶ˆæ¯æ—¶ï¼Œå¦‚æœæ˜¯å¼€å‘æ¨¡å¼ï¼Œé€šçŸ¥æ¶ˆæ¯æ¨¡æ‹Ÿå™¨
- âœ… å‘é€å°ç›˜æ¶ˆæ¯æ—¶ï¼Œå¦‚æœæ˜¯å¼€å‘æ¨¡å¼ï¼Œé€šçŸ¥æ¶ˆæ¯æ¨¡æ‹Ÿå™¨
- âœ… å‘é€å°ç›˜æé†’æ—¶ï¼Œå¦‚æœæ˜¯å¼€å‘æ¨¡å¼ï¼Œé€šçŸ¥æ¶ˆæ¯æ¨¡æ‹Ÿå™¨
- âœ… å‘é€ç»“ç®—æ¶ˆæ¯æ—¶ï¼Œå¦‚æœæ˜¯å¼€å‘æ¨¡å¼ï¼Œé€šçŸ¥æ¶ˆæ¯æ¨¡æ‹Ÿå™¨
- âœ… å‘é€å›¾ç‰‡æ—¶ï¼Œå¦‚æœæ˜¯å¼€å‘æ¨¡å¼ï¼Œé€šçŸ¥æ¶ˆæ¯æ¨¡æ‹Ÿå™¨

**ä»£ç ç¤ºä¾‹**ï¼š
```csharp
// å¼€ç›˜æ¶ˆæ¯
var response = await _socketClient.SendAsync<object>("SendMessage", groupWxId, message);
if (response != null)
{
    _logService.Info("BinggoLotteryService", $"âœ… å¼€ç›˜æç¤ºå·²å‘é€: {message}");
    
    // ğŸ”¥ å¼€å‘æ¨¡å¼ï¼šé€šçŸ¥æ¶ˆæ¯æ¨¡æ‹Ÿå™¨æ˜¾ç¤ºå¼€ç›˜æ¶ˆæ¯
    if (_configService.GetIsRunModeDev())
    {
        Views.Dev.MessageSimulatorForm.NotifySystemMessage("å¼€ç›˜", message);
    }
}

// å›¾ç‰‡æ¶ˆæ¯
var sendResponse = await _socketClient.SendAsync<object>("SendImage", groupWxId, imagePath);
if (sendResponse != null)
{
    _logService.Info("BinggoLotteryService", $"âœ… å†å²è®°å½•å›¾ç‰‡å·²å‘é€: {imagePath}");
    
    // ğŸ”¥ å¼€å‘æ¨¡å¼ï¼šé€šçŸ¥æ¶ˆæ¯æ¨¡æ‹Ÿå™¨æ˜¾ç¤ºå›¾ç‰‡
    if (_configService.GetIsRunModeDev())
    {
        Views.Dev.MessageSimulatorForm.NotifySystemMessage("å›¾ç‰‡", $"å†å²è®°å½•å›¾ç‰‡: {Path.GetFileName(imagePath)}", imagePath);
    }
}
```

---

### 5. ä¿®æ”¹ VxMain åˆ›å»ºæ¶ˆæ¯æ¨¡æ‹Ÿå™¨

**æ–‡ä»¶**ï¼š`BaiShengVx3Plus/Views/VxMain_DevMenu.cs`

**åŠŸèƒ½**ï¼š
- âœ… åˆ›å»ºæ¶ˆæ¯æ¨¡æ‹Ÿå™¨æ—¶ï¼Œä¼ å…¥ `IBinggoLotteryService` å¼•ç”¨
- âœ… æ¶ˆæ¯æ¨¡æ‹Ÿå™¨å¯ä»¥è®¢é˜…ç³»ç»Ÿæ¶ˆæ¯äº‹ä»¶

**ä»£ç ä½ç½®**ï¼š
```csharp
// ğŸ”¥ è·å–å½©ç¥¨æœåŠ¡ï¼ˆç”¨äºè®¢é˜…ç³»ç»Ÿæ¶ˆæ¯ï¼‰
var lotteryService = Program.ServiceProvider.GetService<Contracts.Games.IBinggoLotteryService>();

// ğŸ”¥ è·å–æˆ–åˆ›å»ºæ¶ˆæ¯æ¨¡æ‹Ÿçª—å£ï¼ˆå•ä¾‹æ¨¡å¼ï¼ŒåŒä¸€ä¼šå‘˜åªèƒ½å¼€ä¸€ä¸ªçª—å£ï¼‰
var simulatorForm = BaiShengVx3Plus.Views.Dev.MessageSimulatorForm.GetOrCreate(
    member,
    SimulateMemberMessageAsync,  // â† å¤ç”¨å·²æœ‰æ–¹æ³•ï¼
    _logService,
    lotteryService);  // ğŸ”¥ ä¼ å…¥å½©ç¥¨æœåŠ¡ï¼Œç”¨äºè®¢é˜…ç³»ç»Ÿæ¶ˆæ¯
```

---

## ğŸ¯ åŠŸèƒ½è¯´æ˜

### æ¶ˆæ¯æ˜¾ç¤ºæµç¨‹

1. **äº‹ä»¶è®¢é˜…**ï¼š
   - æ¶ˆæ¯æ¨¡æ‹Ÿå™¨æ‰“å¼€æ—¶ï¼Œè®¢é˜… `IBinggoLotteryService` çš„äº‹ä»¶
   - è®¢é˜…é™æ€æ¶ˆæ¯é€šçŸ¥äº‹ä»¶

2. **æ¶ˆæ¯æ¥æ”¶**ï¼š
   - çŠ¶æ€å˜æ›´äº‹ä»¶ â†’ æ˜¾ç¤ºçŠ¶æ€å˜æ›´é€šçŸ¥
   - å¼€å¥–äº‹ä»¶ â†’ æ˜¾ç¤ºå¼€å¥–é€šçŸ¥
   - æœŸå·å˜æ›´äº‹ä»¶ â†’ æ˜¾ç¤ºæœŸå·å˜æ›´é€šçŸ¥
   - é™æ€æ¶ˆæ¯é€šçŸ¥ â†’ æ˜¾ç¤ºç³»ç»Ÿå‘é€çš„æ¶ˆæ¯ï¼ˆå¼€ç›˜ã€å°ç›˜ã€ç»“ç®—ã€å›¾ç‰‡ç­‰ï¼‰

3. **æ¶ˆæ¯æ˜¾ç¤º**ï¼š
   - æ ¹æ®æ¶ˆæ¯ç±»å‹ä½¿ç”¨ä¸åŒé¢œè‰²
   - æ˜¾ç¤ºæ—¶é—´æˆ³
   - è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨

### æ”¯æŒçš„æ¶ˆæ¯ç±»å‹

| æ¶ˆæ¯ç±»å‹ | è§¦å‘æ—¶æœº | æ˜¾ç¤ºæ–¹å¼ |
|---------|---------|---------|
| å¼€ç›˜ | çŠ¶æ€å˜ä¸º"å¼€ç›˜ä¸­" | ç»¿è‰²ç³»ç»Ÿé€šçŸ¥ |
| å°ç›˜ | çŠ¶æ€å˜ä¸º"å°ç›˜ä¸­" | æ©™è‰²ç³»ç»Ÿé€šçŸ¥ |
| å°ç›˜æé†’ | 30ç§’/15ç§’æé†’ | æ©™è‰²ç³»ç»Ÿé€šçŸ¥ |
| å¼€å¥– | å¼€å¥–æ•°æ®åˆ°è¾¾ | çº¢è‰²ç³»ç»Ÿé€šçŸ¥ |
| ç»“ç®— | å‘é€ä¸­~åå•ã€ç•™~åå• | è“è‰²ç³»ç»Ÿé€šçŸ¥ |
| å›¾ç‰‡ | å‘é€å†å²è®°å½•å›¾ç‰‡ | ç´«è‰²ç³»ç»Ÿé€šçŸ¥ + å›¾ç‰‡è·¯å¾„ |
| æœŸå·å˜æ›´ | æœŸå·å˜æ›´ | ç´«è‰²ç³»ç»Ÿé€šçŸ¥ |

---

## ğŸ“ ä½¿ç”¨è¯´æ˜

### 1. æ‰“å¼€æ¶ˆæ¯æ¨¡æ‹Ÿå™¨

1. å¯ç”¨å¼€å‘æ¨¡å¼ï¼ˆè®¾ç½® â†’ å¼€å‘æ¨¡å¼ï¼‰
2. ç»‘å®šç¾¤ç»„
3. é€‰æ‹©ä¼šå‘˜
4. å³é”®èœå• â†’ å¼€å‘é€‰é¡¹ â†’ å‘é€æ¶ˆæ¯

### 2. æŸ¥çœ‹ç³»ç»Ÿæ¶ˆæ¯

æ¶ˆæ¯æ¨¡æ‹Ÿå™¨ä¼šè‡ªåŠ¨æ˜¾ç¤ºï¼š
- âœ… å¼€ç›˜æ¶ˆæ¯ï¼ˆ"ç¬¬Xé˜Ÿ\r---------çº¿ä¸‹å¼€å§‹---------"ï¼‰
- âœ… å°ç›˜æ¶ˆæ¯ï¼ˆ"X æ—¶é—´åˆ°! åœæ­¢è¿›ä»“! ä»¥æ­¤ä¸ºå‡†!"ï¼‰
- âœ… å°ç›˜æé†’ï¼ˆ"X è¿˜å‰©30ç§’" / "X è¿˜å‰©15ç§’"ï¼‰
- âœ… å¼€å¥–é€šçŸ¥ï¼ˆæœŸå·å’Œå¼€å¥–å·ç ï¼‰
- âœ… ç»“ç®—æ¶ˆæ¯ï¼ˆä¸­~åå•ã€ç•™~åå•ï¼‰
- âœ… å†å²è®°å½•å›¾ç‰‡ï¼ˆæ˜¾ç¤ºå›¾ç‰‡è·¯å¾„ï¼‰

### 3. æ¶ˆæ¯é¢œè‰²è¯´æ˜

- **ç»¿è‰²**ï¼šå¼€ç›˜æ¶ˆæ¯
- **æ©™è‰²**ï¼šå°ç›˜æ¶ˆæ¯ã€å°ç›˜æé†’
- **çº¢è‰²**ï¼šå¼€å¥–é€šçŸ¥
- **è“è‰²**ï¼šç»“ç®—æ¶ˆæ¯ã€ç³»ç»Ÿé€šçŸ¥
- **ç´«è‰²**ï¼šå›¾ç‰‡æ¶ˆæ¯ã€æœŸå·å˜æ›´

---

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. äº‹ä»¶è®¢é˜…æœºåˆ¶

```csharp
// è®¢é˜…äº‹ä»¶
_lotteryService.StatusChanged += LotteryService_StatusChanged;
_lotteryService.LotteryOpened += LotteryService_LotteryOpened;
_lotteryService.IssueChanged += LotteryService_IssueChanged;

// äº‹ä»¶å¤„ç†ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰
private void LotteryService_StatusChanged(object? sender, BinggoStatusChangedEventArgs e)
{
    if (this.InvokeRequired)
    {
        this.Invoke(new Action(() => LotteryService_StatusChanged(sender, e)));
        return;
    }
    // æ˜¾ç¤ºæ¶ˆæ¯...
}
```

### 2. é™æ€æ¶ˆæ¯é€šçŸ¥

```csharp
// å®šä¹‰é™æ€äº‹ä»¶
public static event EventHandler<(string messageType, string message, string? imagePath)>? SystemMessageSent;

// é€šçŸ¥æ‰€æœ‰çª—å£
public static void NotifySystemMessage(string messageType, string message, string? imagePath = null)
{
    SystemMessageSent?.Invoke(null, (messageType, message, imagePath));
}

// è®¢é˜…é™æ€äº‹ä»¶
SystemMessageSent += MessageSimulatorForm_SystemMessageSent;
```

### 3. å¼€å‘æ¨¡å¼æ£€æµ‹

```csharp
// åœ¨ BinggoLotteryService ä¸­
if (_configService.GetIsRunModeDev())
{
    Views.Dev.MessageSimulatorForm.NotifySystemMessage("å¼€ç›˜", message);
}
```

---

## âœ… æµ‹è¯•å»ºè®®

### æµ‹è¯•åœºæ™¯

1. **å¼€ç›˜æ¶ˆæ¯**ï¼š
   - ç­‰å¾…çŠ¶æ€å˜ä¸º"å¼€ç›˜ä¸­"
   - åº”è¯¥çœ‹åˆ°ç»¿è‰²çš„å¼€ç›˜é€šçŸ¥

2. **å°ç›˜æ¶ˆæ¯**ï¼š
   - ç­‰å¾…å°ç›˜
   - åº”è¯¥çœ‹åˆ°æ©™è‰²çš„å°ç›˜æ¶ˆæ¯

3. **å°ç›˜æé†’**ï¼š
   - ç­‰å¾…30ç§’/15ç§’æé†’
   - åº”è¯¥çœ‹åˆ°æ©™è‰²çš„æé†’æ¶ˆæ¯

4. **å¼€å¥–æ¶ˆæ¯**ï¼š
   - ç­‰å¾…å¼€å¥–
   - åº”è¯¥çœ‹åˆ°çº¢è‰²çš„å¼€å¥–é€šçŸ¥

5. **ç»“ç®—æ¶ˆæ¯**ï¼š
   - ç­‰å¾…ç»“ç®—
   - åº”è¯¥çœ‹åˆ°è“è‰²çš„ä¸­~åå•å’Œç•™~åå•

6. **å›¾ç‰‡æ¶ˆæ¯**ï¼š
   - ç­‰å¾…å¼€ç›˜æˆ–æœ€åä¸€æœŸç»“ç®—
   - åº”è¯¥çœ‹åˆ°ç´«è‰²çš„å›¾ç‰‡é€šçŸ¥å’Œå›¾ç‰‡è·¯å¾„

---

## ğŸ“Œ æ³¨æ„äº‹é¡¹

1. **å¼€å‘æ¨¡å¼**ï¼šåªæœ‰åœ¨å¼€å‘æ¨¡å¼ä¸‹æ‰ä¼šæ˜¾ç¤ºç³»ç»Ÿæ¶ˆæ¯
2. **çº¿ç¨‹å®‰å…¨**ï¼šæ‰€æœ‰ UI æ›´æ–°éƒ½é€šè¿‡ `Invoke` ç¡®ä¿çº¿ç¨‹å®‰å…¨
3. **èµ„æºæ¸…ç†**ï¼šçª—å£å…³é—­æ—¶è‡ªåŠ¨å–æ¶ˆè®¢é˜…äº‹ä»¶
4. **æ€§èƒ½**ï¼šé™æ€äº‹ä»¶é€šçŸ¥ä¸ä¼šå½±å“ç”Ÿäº§ç¯å¢ƒæ€§èƒ½ï¼ˆåªåœ¨å¼€å‘æ¨¡å¼ä¸‹è§¦å‘ï¼‰

---

## ğŸ‰ å®ŒæˆçŠ¶æ€

- âœ… è®¢é˜…ç³»ç»Ÿæ¶ˆæ¯äº‹ä»¶
- âœ… æ˜¾ç¤ºä¸åŒç±»å‹çš„æ¶ˆæ¯
- âœ… æ”¯æŒå›¾ç‰‡æ¶ˆæ¯
- âœ… é›†æˆåˆ° BinggoLotteryService
- âœ… ä¿®æ”¹ VxMain åˆ›å»ºæ¶ˆæ¯æ¨¡æ‹Ÿå™¨
- âœ… ç¼–è¯‘é€šè¿‡
- âœ… ä»£ç æ³¨é‡Šå®Œæ•´

**å¢å¼ºå®Œæˆæ—¶é—´**ï¼š2025-12-06

