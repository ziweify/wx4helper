# ç®¡ç†å‘˜å‘½ä»¤ - å®ç°å®Œæˆ

## âœ… å®ç°æ‘˜è¦

å·²å®Œæ•´å®ç°ç®¡ç†å‘˜å‘½ä»¤åŠŸèƒ½ï¼Œä¸ F5BotV2 **å®Œå…¨ä¸€è‡´**ã€‚

---

## ğŸ“ å®ç°çš„åŠŸèƒ½

### 1. åˆ·æ–°å‘½ä»¤

**è§¦å‘**: `åˆ·æ–°`ï¼ˆå»é™¤ç©ºæ ¼åï¼‰

**åŠŸèƒ½**:
- è·å–ç¾¤æˆå‘˜åˆ—è¡¨
- å¯¹æ¯”æ•°æ®åº“ä¸­çš„æˆå‘˜
- æ·»åŠ æ–°æˆå‘˜åˆ°æ•°æ®åº“
- å¯¹æ¯ä¸ªæ–°æˆå‘˜å›å¤æ¬¢è¿æ¶ˆæ¯

**å›å¤æ ¼å¼**:
```
^æ¬¢è¿:[ID]æ˜µç§°
^æ¬¢è¿:[ID]æ˜µç§°
...
^åˆ·æ–°å®Œæˆ
```

**ç¤ºä¾‹**:
```
å‘é€: åˆ·æ–°
å›å¤: 
^æ¬¢è¿:[7]å°æ˜
^æ¬¢è¿:[8]å°çº¢
^åˆ·æ–°å®Œæˆ
```

---

### 2. ç®¡ç†ä¸Šä¸‹åˆ†å‘½ä»¤

#### æ ¼å¼1ï¼š@æ˜µç§° ä¸Š/ä¸‹é‡‘é¢

**è§¦å‘**: `@æ˜µç§° ä¸Š/ä¸‹é‡‘é¢`

**ç¤ºä¾‹**:
```
å‘é€: @é£æ‰¬ğŸ  ä¸Š10000
å›å¤: 
@é£æ‰¬ğŸ 
7ä¸Š10000|ä½™:15000
```

**åŠŸèƒ½**:
- æ ¹æ®æ˜µç§°æŸ¥æ‰¾ä¼šå‘˜
- æ‰§è¡Œä¸Šä¸‹åˆ†æ“ä½œ
- æ›´æ–°ä½™é¢å’Œä»Šæ—¥ç»Ÿè®¡

**é”™è¯¯å¤„ç†**:
- æ˜µç§°ä¸å­˜åœ¨: `[è­¦å‘Š]æ²¡æ‰¾åˆ°,æ˜µç§°`
- é‡å: `[è­¦å‘Š]é‡å,æ˜µç§°`
- é‡‘é¢é”™è¯¯: `[è­¦å‘Š]é‡‘é¢é”™è¯¯`

#### æ ¼å¼2ï¼šIDä¸Š/ä¸‹é‡‘é¢

**è§¦å‘**: `IDä¸Š/ä¸‹é‡‘é¢`

**ç¤ºä¾‹**:
```
å‘é€: 7ä¸Š1000
å›å¤:
@é£æ‰¬ğŸ 
7ä¸Š1000|ä½™:16000
```

**åŠŸèƒ½**:
- æ ¹æ®IDæŸ¥æ‰¾ä¼šå‘˜
- æ‰§è¡Œä¸Šä¸‹åˆ†æ“ä½œ
- æ›´æ–°ä½™é¢å’Œä»Šæ—¥ç»Ÿè®¡

**é”™è¯¯å¤„ç†**:
- IDä¸å­˜åœ¨: `[è­¦å‘Š]IDé”™è¯¯, IDä¸å­˜åœ¨`
- é‡‘é¢é”™è¯¯: `[è­¦å‘Š]é‡‘é¢é”™è¯¯`

---

## ğŸ¯ æƒé™æ£€æŸ¥

### ç®¡ç†å‘˜åˆ¤æ–­æ¡ä»¶

```csharp
bool isAdmin = member.State == MemberState.ç®¡ç† || member.Wxid == currentUserWxid;
```

1. **`member.State == MemberState.ç®¡ç†`**: ä¼šå‘˜çŠ¶æ€æ˜¯"ç®¡ç†"
2. **`member.Wxid == currentUserWxid`**: å‘é€è€…æ˜¯æœºå™¨äººè‡ªå·±

### æ¶ˆæ¯å¤„ç†ä¼˜å…ˆçº§

```csharp
if (isAdmin)
{
    // 1. å…ˆå¤„ç†åˆ·æ–°å‘½ä»¤
    if (HandleRefreshCommand(...) != -1)
        return;
    
    // 2. å†å¤„ç†ç®¡ç†ä¸Šä¸‹åˆ†å‘½ä»¤
    if (HandleCreditWithdrawCommand(...) != -1)
        return;
    
    // 3. ç®¡ç†å‘˜çš„å…¶ä»–æ¶ˆæ¯ä¸å¤„ç†ï¼ˆä¸å½“ä½œæ™®é€šå‘½ä»¤ï¼‰
    return (false, null);
}
else
{
    // 4. å¤„ç†æ™®é€šä¼šå‘˜å‘½ä»¤ï¼ˆæŸ¥ã€ä¸Šåˆ†ã€ä¸‹åˆ†ã€æŠ•æ³¨ç­‰ï¼‰
    ProcessMessageAsync(member, message);
}
```

---

## ğŸ“‚ å®ç°æ–‡ä»¶

### 1. æ–°å»ºæ–‡ä»¶

#### `BaiShengVx3Plus/Services/Messages/Handlers/AdminCommandHandler.cs`

**åŠŸèƒ½**:
- åˆ·æ–°å‘½ä»¤å¤„ç†
- ç®¡ç†ä¸Šä¸‹åˆ†å‘½ä»¤å¤„ç†ï¼ˆæ ¼å¼1å’Œæ ¼å¼2ï¼‰
- ç¾¤æˆå‘˜åˆ—è¡¨åˆ·æ–°
- ä¸Šä¸‹åˆ†æ“ä½œæ‰§è¡Œ

**å…³é”®æ–¹æ³•**:
```csharp
// åˆ·æ–°å‘½ä»¤
public async Task<(int code, string? replyMessage, string? errorMessage)> HandleRefreshCommand(...)

// ç®¡ç†ä¸Šä¸‹åˆ†å‘½ä»¤
public async Task<(int code, string? replyMessage, string? errorMessage)> HandleCreditWithdrawCommand(...)

// åˆ·æ–°ç¾¤æˆå‘˜
private async Task<(bool success, List<string>? welcomeMessages)> RefreshGroupMembers(...)

// å¤„ç†æ ¼å¼1ï¼š@æ˜µç§° ä¸Š/ä¸‹é‡‘é¢
private async Task<(int code, string? replyMessage, string? errorMessage)> HandleCreditWithdrawByNickname(...)

// å¤„ç†æ ¼å¼2ï¼šIDä¸Š/ä¸‹é‡‘é¢
private async Task<(int code, string? replyMessage, string? errorMessage)> HandleCreditWithdrawById(...)

// æ‰§è¡Œä¸Šä¸‹åˆ†æ“ä½œ
private async Task<bool> ExecuteCreditWithdraw(...)
```

---

### 2. ä¿®æ”¹æ–‡ä»¶

#### `BaiShengVx3Plus/Services/Messages/Handlers/BinggoMessageHandler.cs`

**ä¿®æ”¹**:
1. æ·»åŠ  `AdminCommandHandler` å­—æ®µå’Œæ„é€ å‡½æ•°æ³¨å…¥
2. ä¿®æ”¹ `HandleMessageAsync` æ–¹æ³•ç­¾åï¼Œæ·»åŠ  `groupWxid` å’Œ `currentUserWxid` å‚æ•°
3. åœ¨æ¶ˆæ¯å¤„ç†å¼€å§‹æ—¶æ·»åŠ ç®¡ç†å‘˜æƒé™æ£€æŸ¥
4. ç®¡ç†å‘˜æ¶ˆæ¯ä¼˜å…ˆå¤„ç†ç®¡ç†å‘½ä»¤ï¼Œä¸åŒ¹é…åˆ™ä¸å½“ä½œæ™®é€šå‘½ä»¤
5. ä¿®æ”¹ `ShouldIgnoreMessage`ï¼Œä¸è¿‡æ»¤ `@` å¼€å¤´çš„æ¶ˆæ¯

**å…³é”®ä»£ç **:
```csharp
// ç®¡ç†å‘˜æƒé™æ£€æŸ¥
bool isAdmin = member.State == MemberState.ç®¡ç† || member.Wxid == currentUserWxid;

if (isAdmin)
{
    // å¤„ç†åˆ·æ–°å‘½ä»¤
    var (refreshCode, refreshReply, refreshError) = await _adminCommandHandler.HandleRefreshCommand(...);
    if (refreshCode != -1) return (true, refreshReply ?? refreshError);
    
    // å¤„ç†ç®¡ç†ä¸Šä¸‹åˆ†å‘½ä»¤
    var (creditCode, creditReply, creditError) = await _adminCommandHandler.HandleCreditWithdrawCommand(...);
    if (creditCode != -1) return (true, creditReply ?? creditError);
    
    // ç®¡ç†å‘˜çš„å…¶ä»–æ¶ˆæ¯ä¸å¤„ç†
    return (false, null);
}
```

#### `BaiShengVx3Plus/Services/Messages/Handlers/ChatMessageHandler.cs`

**ä¿®æ”¹**:
1. æ·»åŠ  `IUserInfoService` å­—æ®µå’Œæ„é€ å‡½æ•°æ³¨å…¥
2. åœ¨è°ƒç”¨ `BinggoMessageHandler.HandleMessageAsync` æ—¶ä¼ é€’ `groupWxid` å’Œ `currentUserWxid`

**å…³é”®ä»£ç **:
```csharp
// è·å–å½“å‰ç”¨æˆ· wxid
string currentUserWxid = _userInfoService.GetCurrentWxid();

// è°ƒç”¨ç‚³ç‹—æ¶ˆæ¯å¤„ç†å™¨
var (handled, replyMessage) = await _binggoMessageHandler.HandleMessageAsync(
    member, 
    message.Content,
    message.Receiver1,  // ç¾¤ID
    currentUserWxid);   // å½“å‰ç”¨æˆ·ID
```

#### `BaiShengVx3Plus/Views/VxMain_DevMenu.cs`

**ä¿®æ”¹**:
1. åœ¨è°ƒç”¨ `BinggoMessageHandler.HandleMessageAsync` æ—¶ä¼ é€’ `groupWxid` å’Œ `currentUserWxid`

**å…³é”®ä»£ç **:
```csharp
// è·å–å½“å‰ç”¨æˆ· wxid å’Œç¾¤ wxid
string currentUserWxid = _userInfoService.GetCurrentWxid();
string groupWxid = _groupBindingService.GetBoundGroups().FirstOrDefault()?.Wxid ?? "";

var (handled, replyMessage) = await _binggoMessageHandler.HandleMessageAsync(
    member, 
    message,
    groupWxid,
    currentUserWxid);
```

#### `BaiShengVx3Plus/Program.cs`

**ä¿®æ”¹**:
- åœ¨æœåŠ¡æ³¨å†Œä¸­æ·»åŠ  `AdminCommandHandler`

**å…³é”®ä»£ç **:
```csharp
services.AddSingleton<AdminCommandHandler>();  // ğŸ”¥ ç®¡ç†å‘˜å‘½ä»¤å¤„ç†å™¨
```

---

## ğŸ” ä¸ F5BotV2 çš„ä¸€è‡´æ€§

### 1. æ­£åˆ™è¡¨è¾¾å¼

**æ ¼å¼1**: `@([^ ]+).(ä¸Š|ä¸‹){1}(\d+)(.*)`
```csharp
// F5BotV2 Line 2718
string regexStr = @"@([^ ]+).(ä¸Š|ä¸‹){1}(\d+)(.*)";

// BaiShengVx3Plus AdminCommandHandler.cs Line 85
string regexStr = @"@([^ ]+).(ä¸Š|ä¸‹){1}(\d+)(.*)";
```

**æ ¼å¼2**: `(\d+)(ä¸Š|ä¸‹){1}(\d+)(.*)`
```csharp
// F5BotV2 Line 2785
regexStr = @"(\d+)(ä¸Š|ä¸‹){1}(\d+)(.*)";

// BaiShengVx3Plus AdminCommandHandler.cs Line 92
regexStr = @"(\d+)(ä¸Š|ä¸‹){1}(\d+)(.*)";
```

### 2. ç‰¹æ®Šåˆ¤æ–­

```csharp
// F5BotV2 Line 2729-2732
if (s4.Contains("ç•™") || s4.Contains("ä½™"))
{
    return 0;
}

// BaiShengVx3Plus AdminCommandHandler.cs Line 249-253
if (s4.Contains("ç•™") || s4.Contains("ä½™"))
{
    _logService.Info("AdminCommand", "åç¼€åŒ…å«'ç•™'æˆ–'ä½™'ï¼Œä¸å¤„ç†æ­¤å‘½ä»¤");
    return (0, null, null);
}
```

### 3. å›å¤æ ¼å¼

```csharp
// F5BotV2 Line 2780
wxHelper.CallSendText_11036(msgpack.room_wxid, 
    $"@{items[0].nickname}\r{items[0].id}{s2}{money}|ä½™:{items[0].Balance}");

// BaiShengVx3Plus AdminCommandHandler.cs Line 283-284
string replyMsg = $"@{member.Nickname}\r{member.Id}{s2}{money}|ä½™:{member.Balance}";
return (0, replyMsg, null);
```

**æ³¨æ„**: ä½¿ç”¨ `\r` æ¢è¡Œç¬¦ï¼Œè€Œä¸æ˜¯ `\r\n`ã€‚

### 4. å¼‚å¸¸æ¶ˆæ¯

```csharp
// F5BotV2 Line 2739, 2744, 2753, 2800
throw new Exception($"#[è­¦å‘Š]æ²¡æ‰¾åˆ°,{s1}");
throw new Exception($"#[è­¦å‘Š]é‡å,{s1}");
throw new Exception("#[è­¦å‘Š]é‡‘é¢é”™è¯¯");
throw new Exception("#[è­¦å‘Š]IDé”™è¯¯, IDä¸å­˜åœ¨");

// BaiShengVx3Plus AdminCommandHandler.cs Line 262, 267, 276, 332
throw new Exception($"#[è­¦å‘Š]æ²¡æ‰¾åˆ°,{s1}");
throw new Exception($"#[è­¦å‘Š]é‡å,{s1}");
throw new Exception("#[è­¦å‘Š]é‡‘é¢é”™è¯¯");
throw new Exception("#[è­¦å‘Š]IDé”™è¯¯, IDä¸å­˜åœ¨");
```

**å¤„ç†**: å¼‚å¸¸æ¶ˆæ¯ä»¥ `#` å¼€å¤´ï¼Œè¡¨ç¤ºå·²å¤„ç†çš„å¼‚å¸¸ï¼Œæ•è·åå»é™¤ `#` å¹¶ç›´æ¥è¾“å‡ºã€‚

### 5. åˆ·æ–°å‘½ä»¤å›å¤

```csharp
// F5BotV2 Line 2696
wxHelper.CallSendText_11036(room_wxid, $"^æ¬¢è¿:[{memok.id}]{m.nickname}");

// F5BotV2 Line 2622
wxHelper.CallSendText_11036(msgpack.room_wxid, $"^åˆ·æ–°å®Œæˆ");

// BaiShengVx3Plus AdminCommandHandler.cs Line 192-193
string welcomeMsg = $"^æ¬¢è¿:[{addedMember?.Id ?? 0}]{nickname}";
welcomeMessages.Add(welcomeMsg);

// BaiShengVx3Plus AdminCommandHandler.cs Line 58
return (0, "^åˆ·æ–°å®Œæˆ", null);
```

**æ³¨æ„**: æ‰€æœ‰åˆ·æ–°å‘½ä»¤çš„å›å¤éƒ½ä»¥ `^` å¼€å¤´ã€‚

---

## ğŸ¯ æµ‹è¯•å»ºè®®

### 1. åˆ·æ–°å‘½ä»¤æµ‹è¯•

```
åœºæ™¯1: æœ‰æ–°æˆå‘˜åŠ å…¥
1. åœ¨ç¾¤é‡Œæ·»åŠ æ–°æˆå‘˜
2. ç®¡ç†å‘˜å‘é€"åˆ·æ–°"
3. éªŒè¯å›å¤ï¼š
   ^æ¬¢è¿:[ID]æ˜µç§°
   ^æ¬¢è¿:[ID]æ˜µç§°
   ^åˆ·æ–°å®Œæˆ

åœºæ™¯2: æ²¡æœ‰æ–°æˆå‘˜
1. ç®¡ç†å‘˜å‘é€"åˆ·æ–°"
2. éªŒè¯å›å¤ï¼š
   ^åˆ·æ–°å®Œæˆ
```

### 2. ç®¡ç†ä¸Šä¸‹åˆ†æµ‹è¯•

```
åœºæ™¯1: @æ˜µç§° ä¸Šé‡‘é¢
1. ç®¡ç†å‘˜å‘é€"@å°æ˜ ä¸Š1000"
2. éªŒè¯å›å¤ï¼š
   @å°æ˜
   7ä¸Š1000|ä½™:1000

åœºæ™¯2: IDä¸Šé‡‘é¢
1. ç®¡ç†å‘˜å‘é€"7ä¸Š500"
2. éªŒè¯å›å¤ï¼š
   @å°æ˜
   7ä¸Š500|ä½™:1500

åœºæ™¯3: æ˜µç§°ä¸å­˜åœ¨
1. ç®¡ç†å‘˜å‘é€"@ä¸å­˜åœ¨ ä¸Š100"
2. éªŒè¯å›å¤ï¼š
   [è­¦å‘Š]æ²¡æ‰¾åˆ°,ä¸å­˜åœ¨

åœºæ™¯4: é‡å
1. ç¾¤é‡Œæœ‰ä¸¤ä¸ª"å°æ˜"
2. ç®¡ç†å‘˜å‘é€"@å°æ˜ ä¸Š100"
3. éªŒè¯å›å¤ï¼š
   [è­¦å‘Š]é‡å,å°æ˜

åœºæ™¯5: ç‰¹æ®Šåˆ¤æ–­ï¼ˆé¿å…ä¸ç»“ç®—æ¶ˆæ¯å†²çªï¼‰
1. ç®¡ç†å‘˜å‘é€"@å°æ˜ ä¸Š1000ç•™"
2. éªŒè¯ï¼šä¸å¤„ç†æ­¤å‘½ä»¤ï¼ˆè¿”å›ç©ºï¼‰
```

### 3. æƒé™æµ‹è¯•

```
åœºæ™¯1: ç®¡ç†å‘˜å‘é€æ™®é€šæ¶ˆæ¯
1. ç®¡ç†å‘˜å‘é€"123å¤§10"ï¼ˆæŠ•æ³¨å‘½ä»¤ï¼‰
2. éªŒè¯ï¼šä¸å¤„ç†ï¼ˆä¸å½“ä½œæŠ•æ³¨å‘½ä»¤ï¼‰

åœºæ™¯2: æ™®é€šä¼šå‘˜å‘é€ç®¡ç†å‘½ä»¤
1. æ™®é€šä¼šå‘˜å‘é€"åˆ·æ–°"
2. éªŒè¯ï¼šä¸å¤„ç†ï¼ˆæ²¡æœ‰ç®¡ç†å‘˜æƒé™ï¼‰

åœºæ™¯3: æœºå™¨äººè‡ªå·±å‘é€å‘½ä»¤
1. æœºå™¨äººè‡ªå·±å‘é€"åˆ·æ–°"ï¼ˆwxid == currentUserWxidï¼‰
2. éªŒè¯ï¼šæˆåŠŸå¤„ç†
```

---

## âœ… å®ç°å®Œæˆ

æ‰€æœ‰ç®¡ç†å‘˜å‘½ä»¤å·²å®Œæ•´å®ç°ï¼Œä¸ F5BotV2 **å®Œå…¨ä¸€è‡´**ï¼š

- âœ… åˆ·æ–°å‘½ä»¤
- âœ… ç®¡ç†ä¸Šä¸‹åˆ†ï¼ˆæ ¼å¼1ï¼š@æ˜µç§° ä¸Š/ä¸‹é‡‘é¢ï¼‰
- âœ… ç®¡ç†ä¸Šä¸‹åˆ†ï¼ˆæ ¼å¼2ï¼šIDä¸Š/ä¸‹é‡‘é¢ï¼‰
- âœ… æƒé™æ£€æŸ¥
- âœ… å›å¤æ ¼å¼å®Œå…¨ä¸€è‡´
- âœ… å¼‚å¸¸å¤„ç†å®Œå…¨ä¸€è‡´
- âœ… ç‰¹æ®Šåˆ¤æ–­å®Œå…¨ä¸€è‡´

**å¯ä»¥å¼€å§‹æµ‹è¯•äº†ï¼** ğŸ¯

