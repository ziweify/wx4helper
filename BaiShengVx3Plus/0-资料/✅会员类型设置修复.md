# ä¼šå‘˜ç±»å‹è®¾ç½®ä¿®å¤

## ğŸ› é—®é¢˜æè¿°

**ç”¨æˆ·åé¦ˆ**ï¼š
1. ä¼šå‘˜ç±»å‹æ˜¾ç¤ºæ··ä¹±ï¼šæ˜¾ç¤º"ç›˜å†…"ã€"ç›˜å¤–"ç­‰ï¼Œä¸ç¬¦åˆä¸šåŠ¡é€»è¾‘
2. å³é”®èœå•è®¾ç½®ä¼šå‘˜ç±»å‹åï¼Œ`State` åˆ—æ²¡æœ‰å˜åŒ–
3. æ•°æ®åº“ä¸­çš„ä¼šå‘˜ç±»å‹æ²¡æœ‰æ›´æ–°

## ğŸ” é—®é¢˜åŸå› 

### 1. æ¦‚å¿µæ··æ·†
é¡¹ç›®ä¸­å­˜åœ¨ä¸¤ä¸ªä¼šå‘˜ç±»å‹ç›¸å…³çš„æšä¸¾ï¼š

#### âŒ é”™è¯¯ä½¿ç”¨ï¼š`OrderType` æšä¸¾
```csharp
public enum OrderType
{
    å¾…å®š = 0,
    æ™®ä¼š = 1,
    ç›˜å†… = 2,       // âŒ è¿™æ˜¯è®¢å•ç±»å‹ï¼Œä¸æ˜¯ä¼šå‘˜çŠ¶æ€
    ç›˜å¤– = 3,
    æ‰˜ = 4,
    é»„ä¼š = 5
}
```

#### âœ… æ­£ç¡®ä½¿ç”¨ï¼š`MemberState` æšä¸¾
```csharp
public enum MemberState
{
    å·²åˆ é™¤ = -1,
    éä¼šå‘˜ = 0,
    ä¼šå‘˜ = 1,       // âœ… ä¼šå‘˜çŠ¶æ€
    æ‰˜ = 2,
    ç®¡ç† = 3,
    å·²é€€ç¾¤ = 4,
    æ™®ä¼š = 5,
    è“ä¼š = 6,
    ç´«ä¼š = 7,
    é»„ä¼š = 8        // ğŸ”¥ æ–°å¢
}
```

### 2. V2Member æ¨¡å‹ä½¿ç”¨ `State` å­—æ®µ
```csharp
public class V2Member
{
    // âœ… æ­£ç¡®å­—æ®µï¼šStateï¼ˆç±»å‹ä¸º MemberStateï¼‰
    [DataGridColumn(HeaderText = "çŠ¶æ€", Width = 80, Order = 6)]
    public MemberState State { get; set; }
}
```

### 3. å³é”®èœå•å¤„ç†å‡½æ•°çš„é—®é¢˜
åŸä»£ç åªè®°å½•äº†æ—¥å¿—ï¼Œ**æ²¡æœ‰å®é™…ä¿®æ”¹ `State` å­—æ®µ**ï¼š
```csharp
// âŒ åŸä»£ç 
private void TsmiSetMemberType_Click(object sender, EventArgs e)
{
    // ...
    string typeName = menuItem.Text;
    
    // âŒ TODO: V2Memberéœ€è¦æ·»åŠ MemberTypeå­—æ®µæ¥å­˜å‚¨ä¼šå‘˜ç±»å‹
    // âŒ ç›®å‰æš‚æ—¶è®°å½•åˆ°æ—¥å¿—ï¼Œåç»­å®Œå–„æ•°æ®æ¨¡å‹
    
    _logService.Info("ä¼šå‘˜ç®¡ç†", $"è®¾ç½®ä¼šå‘˜ç±»å‹\næ–°ç±»å‹ï¼š{typeName}");
    
    // âŒ æ²¡æœ‰ä¿®æ”¹ State å­—æ®µ
    // âŒ æ²¡æœ‰æ›´æ–°æ•°æ®åº“
}
```

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. å®Œå–„ `MemberState` æšä¸¾
æ·»åŠ "é»„ä¼š"åˆ° `MemberState`ï¼š
```csharp
public enum MemberState
{
    å·²åˆ é™¤ = -1,
    éä¼šå‘˜ = 0,
    ä¼šå‘˜ = 1,
    æ‰˜ = 2,
    ç®¡ç† = 3,
    å·²é€€ç¾¤ = 4,
    æ™®ä¼š = 5,
    è“ä¼š = 6,
    ç´«ä¼š = 7,
    é»„ä¼š = 8        // ğŸ”¥ æ–°å¢
}
```

### 2. ä¿®å¤å³é”®èœå•å¤„ç†å‡½æ•°
æ­£ç¡®æ˜ å°„èœå•é¡¹åˆ° `MemberState`ï¼Œå¹¶æ›´æ–°æ•°æ®åº“ï¼š
```csharp
private void TsmiSetMemberType_Click(object sender, EventArgs e)
{
    // ...
    
    // ğŸ”¥ æ ¹æ®èœå•é¡¹åç§°ç¡®å®šä¼šå‘˜ç±»å‹ï¼ˆä½¿ç”¨ MemberState æšä¸¾ï¼‰
    Models.MemberState newState = menuItem.Name switch
    {
        "tsmiSetNormal" => Models.MemberState.æ™®ä¼š,
        "tsmiSetMember" => Models.MemberState.ä¼šå‘˜,
        "tsmiSetAgent" => Models.MemberState.æ‰˜,
        "tsmiSetBlue" => Models.MemberState.è“ä¼š,
        "tsmiSetYellow" => Models.MemberState.é»„ä¼š,
        _ => selectedMember.State  // ä¿æŒä¸å˜
    };

    string typeName = menuItem.Text;
    var oldState = selectedMember.State;

    // ğŸ”¥ æ›´æ–°ä¼šå‘˜ State å­—æ®µ
    selectedMember.State = newState;

    // ğŸ”¥ æ›´æ–°æ•°æ®åº“
    if (_db != null)
    {
        _db.Update(selectedMember);
    }

    // è®°å½•æ—¥å¿—ï¼ˆåŒ…å«æ—§å€¼å’Œæ–°å€¼ï¼‰
    var currentUser = Services.Api.BoterApi.GetInstance().User;
    _logService.Info("ä¼šå‘˜ç®¡ç†", 
        $"è®¾ç½®ä¼šå‘˜ç±»å‹\n" +
        $"æ“ä½œäººï¼š{currentUser}\n" +
        $"ä¼šå‘˜ï¼š{selectedMember.Nickname} ({selectedMember.Wxid})\n" +
        $"åŸç±»å‹ï¼š{oldState}\n" +
        $"æ–°ç±»å‹ï¼š{typeName} ({newState})");

    // åˆ·æ–°UI
    dgvMembers.Refresh();
    this.ShowSuccessTip($"å·²å°†ä¼šå‘˜ã€{selectedMember.Nickname}ã€‘è®¾ç½®ä¸ºï¼š{typeName}");
}
```

## ğŸ“‹ ä¿®æ”¹æ–‡ä»¶æ¸…å•

1. **BaiShengVx3Plus/Models/Enums.cs**
   - åœ¨ `MemberState` æšä¸¾ä¸­æ·»åŠ  `é»„ä¼š = 8`

2. **BaiShengVx3Plus/Views/VxMain.cs**
   - ä¿®å¤ `TsmiSetMemberType_Click()` æ–¹æ³•
   - æ­£ç¡®æ˜ å°„èœå•é¡¹åˆ° `MemberState`
   - æ›´æ–° `selectedMember.State`
   - è°ƒç”¨ `_db.Update(selectedMember)` ä¿å­˜åˆ°æ•°æ®åº“
   - è®°å½•è¯¦ç»†æ—¥å¿—ï¼ˆåŒ…å«æ—§å€¼å’Œæ–°å€¼ï¼‰

## ğŸ¯ åŠŸèƒ½è¯´æ˜

### ä¼šå‘˜ç±»å‹å¯¹åº”å…³ç³»

| èœå•é€‰é¡¹ | MemberState æšä¸¾ | æ˜¾ç¤ºå€¼ |
|---------|-----------------|--------|
| æ™®ä¼š | æ™®ä¼š (5) | æ™®ä¼š |
| ä¼šå‘˜ï¼ˆç›˜å†…ï¼‰ | ä¼šå‘˜ (1) | ä¼šå‘˜ |
| æ‰˜ | æ‰˜ (2) | æ‰˜ |
| è“ä¼šï¼ˆç›˜å¤–ï¼‰ | è“ä¼š (6) | è“ä¼š |
| é»„ä¼š | é»„ä¼š (8) | é»„ä¼š |

### æ“ä½œæµç¨‹
1. åœ¨ä¼šå‘˜åˆ—è¡¨ä¸­å³é”®ç‚¹å‡»ä¼šå‘˜
2. é€‰æ‹©"è®¾ç½®ä¼šå‘˜ç±»å‹"
3. ä»å­èœå•ä¸­é€‰æ‹©ç±»å‹ï¼ˆæ™®ä¼šã€ä¼šå‘˜ã€æ‰˜ã€è“ä¼šã€é»„ä¼šï¼‰
4. ç³»ç»Ÿè‡ªåŠ¨ï¼š
   - æ›´æ–° `V2Member.State` å­—æ®µ
   - ä¿å­˜åˆ°æ•°æ®åº“
   - åˆ·æ–° UI æ˜¾ç¤º
   - è®°å½•è¯¦ç»†æ—¥å¿—

### æ—¥å¿—è®°å½•æ ¼å¼
```
è®¾ç½®ä¼šå‘˜ç±»å‹
æ“ä½œäººï¼šadmin
ä¼šå‘˜ï¼šå¼ ä¸‰ (wxid_xxx)
åŸç±»å‹ï¼šä¼šå‘˜
æ–°ç±»å‹ï¼šæ‰˜ (æ‰˜)
```

## ğŸ“Š éªŒè¯æ–¹æ³•

### æµ‹è¯•åœºæ™¯1ï¼šè®¾ç½®ä¼šå‘˜ç±»å‹
1. å³é”®ç‚¹å‡»ä¼šå‘˜ "å¼ ä¸‰"
2. é€‰æ‹©"è®¾ç½®ä¼šå‘˜ç±»å‹" â†’ "æ‰˜"
3. è§‚å¯Ÿ `State` åˆ—ï¼šåº”æ˜¾ç¤º"æ‰˜"
4. æŸ¥çœ‹æ•°æ®åº“ï¼š`SELECT * FROM V2Member WHERE Nickname='å¼ ä¸‰'`
5. éªŒè¯ `State` å­—æ®µå€¼ä¸º `2`ï¼ˆæ‰˜ï¼‰

### æµ‹è¯•åœºæ™¯2ï¼šè¿ç»­ä¿®æ”¹ç±»å‹
1. å°†ä¼šå‘˜è®¾ç½®ä¸º"æ™®ä¼š"
2. å†è®¾ç½®ä¸º"ä¼šå‘˜"
3. æœ€åè®¾ç½®ä¸º"è“ä¼š"
4. è§‚å¯Ÿæ¯æ¬¡ UI éƒ½æ­£ç¡®æ›´æ–°
5. æŸ¥çœ‹æ—¥å¿—ï¼Œç¡®è®¤æ¯æ¬¡æ“ä½œéƒ½æœ‰è®°å½•

### æµ‹è¯•åœºæ™¯3ï¼šé‡å¯åéªŒè¯
1. è®¾ç½®å‡ ä¸ªä¼šå‘˜çš„ç±»å‹
2. å…³é—­åº”ç”¨
3. é‡æ–°å¯åŠ¨ï¼Œç»‘å®šç¾¤
4. è§‚å¯Ÿä¼šå‘˜ç±»å‹æ˜¯å¦ä¿æŒï¼ˆä»æ•°æ®åº“æ­£ç¡®åŠ è½½ï¼‰

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. `OrderType` vs `MemberState`
- **`OrderType`**ï¼šè®¢å•ç±»å‹ï¼Œç”¨äº `V2MemberOrder.OrderType` å­—æ®µ
- **`MemberState`**ï¼šä¼šå‘˜çŠ¶æ€ï¼Œç”¨äº `V2Member.State` å­—æ®µ
- ä¸¤è€…æ˜¯**ä¸åŒçš„æ¦‚å¿µ**ï¼Œä¸è¦æ··æ·†

### 2. èœå•é¡¹å‘½å
èœå•é¡¹çš„ `Name` å±æ€§å¿…é¡»ä¸ `switch` è¡¨è¾¾å¼ä¸­çš„å­—ç¬¦ä¸²åŒ¹é…ï¼š
```csharp
"tsmiSetNormal"  â†’ æ™®ä¼š
"tsmiSetMember"  â†’ ä¼šå‘˜
"tsmiSetAgent"   â†’ æ‰˜
"tsmiSetBlue"    â†’ è“ä¼š
"tsmiSetYellow"  â†’ é»„ä¼š
```

### 3. æ•°æ®åº“è‡ªåŠ¨æ›´æ–°
ç”±äº `V2Member` å®ç°äº† `INotifyPropertyChanged`ï¼Œç†è®ºä¸Šå±æ€§å˜åŒ–ä¼šè‡ªåŠ¨è§¦å‘æ•°æ®åº“æ›´æ–°ã€‚ä½†ä¸ºäº†ç¡®ä¿å¯é æ€§ï¼Œæˆ‘ä»¬**æ˜¾å¼è°ƒç”¨** `_db.Update(selectedMember)`ã€‚

### 4. UI åˆ·æ–°
è°ƒç”¨ `dgvMembers.Refresh()` ç¡®ä¿ DataGridView ç«‹å³æ˜¾ç¤ºæœ€æ–°çš„ `State` å€¼ã€‚

## ğŸ‰ å®ŒæˆçŠ¶æ€

- âœ… `MemberState` æšä¸¾å·²æ·»åŠ "é»„ä¼š"
- âœ… å³é”®èœå•å¤„ç†å‡½æ•°å·²ä¿®å¤
- âœ… State å­—æ®µæ›´æ–°é€»è¾‘å·²å®ç°
- âœ… æ•°æ®åº“ä¿å­˜é€»è¾‘å·²å®ç°
- âœ… æ—¥å¿—è®°å½•å·²å®Œå–„ï¼ˆåŒ…å«æ—§å€¼å’Œæ–°å€¼ï¼‰
- â³ ç­‰å¾…ç¼–è¯‘æµ‹è¯•
- â³ ç­‰å¾…ç”¨æˆ·éªŒè¯

## ğŸ“ åç»­å»ºè®®

1. **è®¢å•åˆ›å»ºæ—¶è‡ªåŠ¨è·å–ä¼šå‘˜ç±»å‹**
   - åœ¨ `BinggoOrderService.CreateOrderAsync()` ä¸­
   - æ ¹æ® `member.State` è®¾ç½® `order.OrderType`
   - å»ºè®®æ˜ å°„å…³ç³»ï¼š
     - `MemberState.æ™®ä¼š` â†’ `OrderType.æ™®ä¼š`
     - `MemberState.ä¼šå‘˜` â†’ `OrderType.ç›˜å†…`
     - `MemberState.æ‰˜` â†’ `OrderType.æ‰˜`
     - `MemberState.è“ä¼š` â†’ `OrderType.ç›˜å¤–`
     - `MemberState.é»„ä¼š` â†’ `OrderType.é»„ä¼š`

2. **ä¼šå‘˜ç±»å‹ç»Ÿè®¡**
   - åœ¨ç»Ÿè®¡æœåŠ¡ä¸­æ·»åŠ å„ç±»å‹ä¼šå‘˜æ•°é‡ç»Ÿè®¡
   - æ˜¾ç¤ºåœ¨ä¸»ç•Œé¢ä¿¡æ¯æ 

3. **æ‰¹é‡è®¾ç½®ä¼šå‘˜ç±»å‹**
   - æ”¯æŒå¤šé€‰ä¼šå‘˜
   - ä¸€æ¬¡æ€§è®¾ç½®å¤šä¸ªä¼šå‘˜çš„ç±»å‹

