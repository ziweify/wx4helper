# 会员表右键菜单实现

## 📋 目录
1. [功能概述](#功能概述)
2. [实现细节](#实现细节)
3. [菜单功能](#菜单功能)
4. [使用说明](#使用说明)

---

## 🎯 功能概述

### 实现的功能
1. ✅ **会员表和订单表设置为只读**
   - 不允许直接在表格中编辑数据
   - 防止误操作导致数据错误
   
2. ✅ **会员表右键菜单**
   - 🔄 清零：清空会员余额和所有统计数据
   - 🗑️ 删除：删除会员记录
   - 👔 设置角色：管理、托、普会、蓝会、紫会

3. ✅ **现代化设计**
   - 使用 SunnyUI 的 `UIContextMenuStrip` 保持风格一致
   - Emoji 图标增强视觉效果
   - 层级菜单（角色设置）

---

## 🔧 实现细节

### 1. 表格只读设置

**位置**: `BaiShengVx3Plus/Views/VxMain.cs`

```csharp
private void ConfigureMembersDataGridView()
{
    // 🔥 从 V2Member 模型的特性自动配置
    dgvMembers.ConfigureFromModel<V2Member>();
    
    // 可选：隐藏额外的列（如果需要）
    dgvMembers.HideColumns("Account", "DisplayName", "BetWait");
    
    // 🔥 设置为只读，不允许直接修改数据
    dgvMembers.ReadOnly = true;
    dgvMembers.AllowUserToAddRows = false;
    dgvMembers.AllowUserToDeleteRows = false;
}

private void ConfigureOrdersDataGridView()
{
    // 🔥 从 V2MemberOrder 模型的特性自动配置
    dgvOrders.ConfigureFromModel<V2MemberOrder>();
    
    // 🔥 设置为只读，不允许直接修改数据
    dgvOrders.ReadOnly = true;
    dgvOrders.AllowUserToAddRows = false;
    dgvOrders.AllowUserToDeleteRows = false;
}
```

**说明**：
- `ReadOnly = true`: 所有单元格不可编辑
- `AllowUserToAddRows = false`: 禁止添加新行
- `AllowUserToDeleteRows = false`: 禁止删除行

---

### 2. 右键菜单设计

**位置**: `BaiShengVx3Plus/Views/VxMain.Designer.cs`

```csharp
// 🔥 右键菜单初始化（在 InitializeComponent 中）
cmsMembers.BackColor = Color.FromArgb(243, 249, 255);
cmsMembers.Font = new Font("微软雅黑", 10F);
cmsMembers.ImageScalingSize = new Size(20, 20);
cmsMembers.Items.AddRange(new ToolStripItem[] {
    new ToolStripMenuItem("🔄 清零", null, OnMenuClearBalance_Click) { Name = "menuClearBalance" },
    new ToolStripMenuItem("🗑️ 删除", null, OnMenuDeleteMember_Click) { Name = "menuDeleteMember" },
    new ToolStripSeparator(),
    new ToolStripMenuItem("👔 设置角色", null, new ToolStripItem[] {
        new ToolStripMenuItem("👑 管理", null, OnMenuSetRole_Click) { Name = "menuRoleAdmin", Tag = MemberState.管理 },
        new ToolStripMenuItem("🤖 托", null, OnMenuSetRole_Click) { Name = "menuRoleTrust", Tag = MemberState.托 },
        new ToolStripMenuItem("👤 普会", null, OnMenuSetRole_Click) { Name = "menuRoleNormal", Tag = MemberState.普会 },
        new ToolStripMenuItem("💎 蓝会", null, OnMenuSetRole_Click) { Name = "menuRoleBlue", Tag = MemberState.蓝会 },
        new ToolStripMenuItem("💜 紫会", null, OnMenuSetRole_Click) { Name = "menuRolePurple", Tag = MemberState.紫会 }
    }) { Name = "menuSetRole" }
});

// 🔥 绑定到 dgvMembers
dgvMembers.ContextMenuStrip = cmsMembers;
```

**设计特点**：
- ✅ 使用 SunnyUI 的背景色 `Color.FromArgb(243, 249, 255)` 保持风格一致
- ✅ 使用 Emoji 图标，美观且直观
- ✅ 分隔符清晰划分功能区域
- ✅ 层级菜单组织角色选项
- ✅ 使用 `Tag` 属性传递 `MemberState` 枚举值

---

## 📝 菜单功能

### 1. 🔄 清零

**功能**: 清空会员的余额和所有统计数据

**实现**:
```csharp
private void OnMenuClearBalance_Click(object? sender, EventArgs e)
{
    if (dgvMembers.CurrentRow?.DataBoundItem is not V2Member member)
    {
        UIMessageBox.ShowWarning("请先选择一个会员！");
        return;
    }

    var result = UIMessageBox.ShowAsk($"确定要清零会员 [{member.Nickname}] 的所有数据吗？\n\n此操作将重置余额和所有统计数据。");
    if (!result) return;

    // 🔥 清零操作（数据会自动保存）
    member.Balance = 0;
    member.BetCur = 0;
    member.BetWait = 0;
    member.IncomeToday = 0;
    member.CreditToday = 0;
    member.BetToday = 0;
    member.WithdrawToday = 0;
    member.BetTotal = 0;
    member.CreditTotal = 0;
    member.WithdrawTotal = 0;
    member.IncomeTotal = 0;

    dgvMembers.Refresh();
    UpdateStatistics();

    UIMessageBox.ShowSuccess($"会员 [{member.Nickname}] 已清零！");
}
```

**特点**：
- ✅ 二次确认避免误操作
- ✅ 自动保存到数据库（通过 `INotifyPropertyChanged`）
- ✅ 刷新统计信息
- ✅ 操作反馈（成功提示）
- ✅ 记录日志

---

### 2. 🗑️ 删除

**功能**: 删除会员记录

**实现**:
```csharp
private void OnMenuDeleteMember_Click(object? sender, EventArgs e)
{
    if (dgvMembers.CurrentRow?.DataBoundItem is not V2Member member)
    {
        UIMessageBox.ShowWarning("请先选择一个会员！");
        return;
    }

    var result = UIMessageBox.ShowAsk($"确定要删除会员 [{member.Nickname}] 吗？\n\n此操作不可恢复！");
    if (!result) return;

    // 🔥 从 BindingList 中移除（会自动从数据库删除）
    _membersBindingList?.Remove(member);

    UpdateStatistics();
    UIMessageBox.ShowSuccess($"会员 [{member.Nickname}] 已删除！");
}
```

**特点**：
- ✅ 二次确认避免误删除
- ✅ 自动从数据库删除（通过 `V2MemberBindingList`）
- ✅ 刷新统计信息
- ✅ 操作反馈（成功提示）
- ✅ 记录日志

---

### 3. 👔 设置角色

**功能**: 设置会员角色（管理、托、普会、蓝会、紫会）

**实现**:
```csharp
private void OnMenuSetRole_Click(object? sender, EventArgs e)
{
    if (dgvMembers.CurrentRow?.DataBoundItem is not V2Member member)
    {
        UIMessageBox.ShowWarning("请先选择一个会员！");
        return;
    }

    if (sender is not ToolStripMenuItem menuItem || menuItem.Tag is not MemberState newRole)
    {
        UIMessageBox.ShowWarning("无效的角色选择！");
        return;
    }

    var oldRole = member.State;
    _logService.Info("VxMain", $"设置会员角色: {member.Nickname} ({oldRole} -> {newRole})");

    // 🔥 修改角色（数据会自动保存）
    member.State = newRole;

    dgvMembers.Refresh();
    UIMessageBox.ShowSuccess($"会员 [{member.Nickname}] 的角色已设置为 [{newRole}]");
}
```

**特点**：
- ✅ 使用 `Tag` 属性传递枚举值
- ✅ 自动保存到数据库（通过 `INotifyPropertyChanged`）
- ✅ 记录角色变更日志
- ✅ 操作反馈（成功提示）

---

## 🎨 菜单结构

```
┌─────────────────────┐
│ 🔄 清零             │ ← 清空余额和统计
├─────────────────────┤
│ 🗑️ 删除             │ ← 删除会员记录
├─────────────────────┤
│ ─────────────────   │ ← 分隔符
├─────────────────────┤
│ 👔 设置角色      ▶  │ ← 层级菜单
│   ├─ 👑 管理        │
│   ├─ 🤖 托          │
│   ├─ 👤 普会        │
│   ├─ 💎 蓝会        │
│   └─ 💜 紫会        │
└─────────────────────┘
```

---

## 🚀 使用说明

### 在设计器中修改菜单

如果您想在设计器中修改菜单项，请按以下步骤操作：

1. **打开设计器**：
   - 在 Visual Studio 中打开 `VxMain.cs`
   - 点击顶部的 "查看设计器" 或按 `Shift+F7`

2. **找到右键菜单**：
   - 在设计器下方的组件栏中找到 `cmsMembers`
   - 点击它，会在窗体上显示菜单预览

3. **编辑菜单项**：
   - 直接在预览中编辑文本
   - 右键菜单项可以添加、删除、重新排序
   - 在属性窗口中配置事件处理器

4. **添加新菜单项**：
   - 在空白处输入新菜单项的文本
   - 双击菜单项会自动创建事件处理器
   - 在代码中实现功能逻辑

---

## 💡 扩展示例

### 添加新菜单项：禁用会员

1. **在设计器中添加**：
   ```csharp
   new ToolStripMenuItem("🚫 禁用", null, OnMenuDisableMember_Click) { Name = "menuDisableMember" }
   ```

2. **在 VxMain.cs 中实现**：
   ```csharp
   private void OnMenuDisableMember_Click(object? sender, EventArgs e)
   {
       if (dgvMembers.CurrentRow?.DataBoundItem is not V2Member member)
       {
           UIMessageBox.ShowWarning("请先选择一个会员！");
           return;
       }

       var result = UIMessageBox.ShowAsk($"确定要禁用会员 [{member.Nickname}] 吗？");
       if (!result) return;

       // 设置为禁用状态（假设有这个状态）
       member.State = MemberState.禁用;

       dgvMembers.Refresh();
       UIMessageBox.ShowSuccess($"会员 [{member.Nickname}] 已禁用！");
   }
   ```

---

## 🔥 优势总结

### 精简
- ✅ 菜单在设计器中可视化配置
- ✅ 事件处理器逻辑清晰简洁
- ✅ 利用 ORM 自动保存，无需手动写数据库代码

### 现代化
- ✅ 使用 SunnyUI 组件保持风格一致
- ✅ Emoji 图标增强视觉效果
- ✅ 二次确认避免误操作
- ✅ 操作反馈（成功/错误提示）

### 易维护
- ✅ 设计器中可视化编辑菜单
- ✅ 事件处理器与界面分离
- ✅ 数据自动保存，无需手动同步
- ✅ 日志记录便于追踪问题

---

## 📊 数据自动保存流程

```
┌──────────────┐
│ 用户右键点击 │
└──────┬───────┘
       │
       ▼
┌──────────────┐
│ 修改 V2Member │ ← member.Balance = 0
│   属性       │   member.State = MemberState.管理
└──────┬───────┘
       │
       ▼ (触发 INotifyPropertyChanged)
┌──────────────┐
│ V2MemberBindingList │ ← 自动监听 PropertyChanged 事件
│   检测到变化      │
└──────┬──────────┘
       │
       ▼
┌──────────────┐
│ SQLite ORM   │ ← connection.Update(member)
│  自动保存    │
└──────────────┘
```

**无需手动写任何数据库代码！** 🔥

---

**✅ 实现完成！**

2025-11-06

