# ğŸ“ å®Œå–„å¹³å°è„šæœ¬æŒ‡å—

## ğŸ¯ ç›®æ ‡

æ ¹æ® F5BotV2 çš„å®ç°ç»éªŒï¼Œå®Œå–„ `BsBrowserClient` çš„å¹³å°è„šæœ¬ï¼Œå®ç°çœŸå®çš„ç™»å½•ã€ä½™é¢è·å–å’ŒæŠ•æ³¨åŠŸèƒ½ã€‚

---

## ğŸ“š F5BotV2 çš„å…³é”®å®ç°

### 1. å“åº”æ‹¦æˆªï¼ˆæœ€é‡è¦ï¼‰

F5BotV2 é€šè¿‡æ‹¦æˆªHTTPå“åº”æ¥è·å–æ•°æ®ï¼Œè€Œä¸æ˜¯ä¾èµ–DOMå…ƒç´ ã€‚

**ç¤ºä¾‹ï¼šHy168bingoMember.cs**
```csharp
private void ChromeBroser_ResponseComplete(object sender, ResponseEventArgs args)
{
    // æ‹¦æˆªæŠ•æ³¨å“åº”
    if (args.Url.IndexOf("/makelib.php") != -1)
    {
        var postData = args.PostData; // POSTæ•°æ®
        var responseData = args.Context; // å“åº”å†…å®¹
        
        // è§£æå‚æ•°
        abcd = Regex.Match(postData, "abcd=([^&]+)").Groups[1].Value;
        ab = Regex.Match(postData, "ab=([^&]+)").Groups[1].Value;
        gid = Regex.Match(postData, "gid=([^&]+)").Groups[1].Value;
        
        // è§£æå“åº”
        var json = JObject.Parse(responseData);
        var success = json["success"]?.Value<bool>() ?? false;
    }
    
    // æ‹¦æˆªä½™é¢æ›´æ–°
    else if (args.Url.IndexOf("/gettodaywinlost") != -1)
    {
        var json = JObject.Parse(args.Context);
        var balance = json["balance"]?.Value<decimal>() ?? 0;
    }
}
```

**âœ… æˆ‘ä»¬å·²ç»å®ç°äº†è¿™ä¸ªåŠŸèƒ½ï¼**
- `WebView2ResourceHandler.OnWebResourceResponseReceived`
- `YunDing28Script.HandleResponse`

---

### 2. æŠ•æ³¨æ–¹æ³•

F5BotV2 çš„æŠ•æ³¨æ–¹æ³•é€šå¸¸åŒ…å«ä»¥ä¸‹æ­¥éª¤ï¼š

```csharp
public async Task<string> Bet(string playType, string betContent, float amount)
{
    // 1. æ„é€ POSTæ•°æ®
    var postData = new Dictionary<string, string>
    {
        { "xtype", "bet" },
        { "playtype", playType },
        { "content", betContent },
        { "amount", amount.ToString() },
        { "abcd", abcd },  // ä»æ‹¦æˆªä¸­è·å–
        { "ab", ab },      // ä»æ‹¦æˆªä¸­è·å–
        { "gid", gid }     // ä»æ‹¦æˆªä¸­è·å–
    };
    
    // 2. å‘é€POSTè¯·æ±‚
    var response = await HttpClient.PostAsync(betUrl, new FormUrlEncodedContent(postData));
    var content = await response.Content.ReadAsStringAsync();
    
    // 3. è§£æå“åº”
    var json = JObject.Parse(content);
    var success = json["success"]?.Value<bool>() ?? false;
    var orderId = json["data"]?["orderId"]?.ToString() ?? "";
    
    return orderId;
}
```

**âŒ æˆ‘ä»¬ç›®å‰ä½¿ç”¨çš„æ˜¯ JavaScript æ³¨å…¥ï¼Œè¿™ä¸å¤Ÿå¯é ï¼**

---

## ğŸ”§ æ”¹è¿›æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šæ··åˆæ¨¡å¼ï¼ˆæ¨èï¼‰

**æµç¨‹**ï¼š
1. ç”¨æˆ·æ‰‹åŠ¨ç™»å½•ï¼ˆæˆ–JavaScriptè¾…åŠ©ç™»å½•ï¼‰
2. **æ‹¦æˆªç™»å½•åçš„è¯·æ±‚ï¼Œè·å–å…³é”®å‚æ•°**ï¼ˆTokenã€Sessionã€Cookieç­‰ï¼‰
3. **ä½¿ç”¨è¿™äº›å‚æ•°ç›´æ¥å‘é€POSTè¯·æ±‚ä¸‹æ³¨**
4. é€šè¿‡æ‹¦æˆªå“åº”æ¥ç¡®è®¤æŠ•æ³¨ç»“æœ

**ä¼˜åŠ¿**ï¼š
- âœ… å¯é ï¼ˆä¸ä¾èµ–DOMç»“æ„ï¼‰
- âœ… å¿«é€Ÿï¼ˆç›´æ¥HTTPè¯·æ±‚ï¼‰
- âœ… æ˜“ç»´æŠ¤ï¼ˆåªéœ€å…³æ³¨APIæ¥å£ï¼‰

---

### æ–¹æ¡ˆ2ï¼šçº¯JavaScriptæ³¨å…¥

**æµç¨‹**ï¼š
1. JavaScriptæ³¨å…¥ç™»å½•
2. JavaScriptæ³¨å…¥é€‰æ‹©ç©æ³•
3. JavaScriptæ³¨å…¥è¾“å…¥é‡‘é¢
4. JavaScriptæ³¨å…¥ç‚¹å‡»ç¡®è®¤

**åŠ£åŠ¿**ï¼š
- âŒ ä¸å¯é ï¼ˆDOMéšæ—¶å¯èƒ½å˜åŒ–ï¼‰
- âŒ æ…¢ï¼ˆéœ€è¦ç­‰å¾…é¡µé¢æ¸²æŸ“ï¼‰
- âŒ éš¾ç»´æŠ¤ï¼ˆéœ€è¦é¢‘ç¹æ›´æ–°é€‰æ‹©å™¨ï¼‰

---

## ğŸ“ å…·ä½“å®æ–½æ­¥éª¤

### æ­¥éª¤1ï¼šåˆ†æç›®æ ‡ç½‘ç«™

ä»¥äº‘é¡¶28ä¸ºä¾‹ï¼š

1. **æ‰“å¼€æµè§ˆå™¨DevToolsï¼ˆF12ï¼‰â†’ Network**
2. **æ‰‹åŠ¨ç™»å½•**
   - è§‚å¯Ÿç™»å½•è¯·æ±‚ï¼š`POST https://yd28.vip/api/login`
   - æŸ¥çœ‹POSTæ•°æ®ï¼š`{"username":"xxx","password":"xxx"}`
   - æŸ¥çœ‹å“åº”ï¼š`{"code":0,"data":{"token":"xxx"}}`
   
3. **æ‰‹åŠ¨ä¸‹æ³¨**
   - è§‚å¯ŸæŠ•æ³¨è¯·æ±‚ï¼š`POST https://yd28.vip/api/bet/place`
   - æŸ¥çœ‹POSTæ•°æ®ï¼š`{"issueId":"xxx","betType":"å¤§","amount":10,"token":"xxx"}`
   - æŸ¥çœ‹å“åº”ï¼š`{"code":0,"data":{"orderId":"xxx","balance":990}}`

4. **è·å–ä½™é¢**
   - è§‚å¯Ÿä½™é¢è¯·æ±‚ï¼š`GET https://yd28.vip/api/user/info`
   - æŸ¥çœ‹å“åº”ï¼š`{"code":0,"data":{"balance":990}}`

---

### æ­¥éª¤2ï¼šå®ç°æ‹¦æˆªé€»è¾‘

**æ›´æ–° `YunDing28Script.HandleResponse`**:

```csharp
// å½“å‰å­—æ®µ
private string _token = "";
private string _sessionId = "";
private decimal _currentBalance = 0;

public void HandleResponse(ResponseEventArgs response)
{
    try
    {
        // 1. æ‹¦æˆªç™»å½•å“åº”
        if (response.Url.Contains("/api/login") && !string.IsNullOrEmpty(response.Context))
        {
            var json = JObject.Parse(response.Context);
            var code = json["code"]?.Value<int>() ?? -1;
            
            if (code == 0)
            {
                _token = json["data"]?["token"]?.ToString() ?? "";
                _sessionId = json["data"]?["sessionId"]?.ToString() ?? "";
                _logCallback($"âœ… ç™»å½•æˆåŠŸï¼ŒToken: {_token.Substring(0, 10)}...");
            }
        }
        
        // 2. æ‹¦æˆªæŠ•æ³¨å“åº”
        else if (response.Url.Contains("/api/bet/place") && !string.IsNullOrEmpty(response.Context))
        {
            var json = JObject.Parse(response.Context);
            var code = json["code"]?.Value<int>() ?? -1;
            
            if (code == 0)
            {
                var orderId = json["data"]?["orderId"]?.ToString() ?? "";
                var balance = json["data"]?["balance"]?.Value<decimal>() ?? 0;
                
                _currentBalance = balance;
                _logCallback($"âœ… æŠ•æ³¨æˆåŠŸ: {orderId}, ä½™é¢: {balance}");
            }
            else
            {
                var message = json["message"]?.ToString() ?? "æœªçŸ¥é”™è¯¯";
                _logCallback($"âŒ æŠ•æ³¨å¤±è´¥: {message}");
            }
        }
        
        // 3. æ‹¦æˆªä½™é¢å“åº”
        else if (response.Url.Contains("/api/user/info") && !string.IsNullOrEmpty(response.Context))
        {
            var json = JObject.Parse(response.Context);
            _currentBalance = json["data"]?["balance"]?.Value<decimal>() ?? 0;
            _logCallback($"ğŸ’° ä½™é¢æ›´æ–°: {_currentBalance}");
        }
    }
    catch (Exception ex)
    {
        _logCallback($"âŒ å“åº”å¤„ç†å¤±è´¥: {ex.Message}");
    }
}
```

---

### æ­¥éª¤3ï¼šå®ç°HTTPä¸‹æ³¨

**æ›´æ–° `PlaceBetAsync` ä½¿ç”¨ HttpClient**:

```csharp
private readonly HttpClient _httpClient = new HttpClient();

public async Task<(bool success, string orderId)> PlaceBetAsync(BetOrder order)
{
    try
    {
        if (string.IsNullOrEmpty(_token))
        {
            _logCallback("âŒ æœªç™»å½•ï¼Œæ— æ³•ä¸‹æ³¨");
            return (false, "");
        }
        
        // æ„é€ POSTæ•°æ®
        var postData = new
        {
            issueId = order.IssueId,
            playType = order.PlayType,
            betContent = order.BetContent,
            amount = order.Amount,
            token = _token
        };
        
        var json = JsonConvert.SerializeObject(postData);
        var content = new StringContent(json, Encoding.UTF8, "application/json");
        
        // å‘é€HTTPè¯·æ±‚
        var response = await _httpClient.PostAsync("https://yd28.vip/api/bet/place", content);
        var responseText = await response.Content.ReadAsStringAsync();
        
        // è§£æå“åº”
        var responseJson = JObject.Parse(responseText);
        var code = responseJson["code"]?.Value<int>() ?? -1;
        
        if (code == 0)
        {
            var orderId = responseJson["data"]?["orderId"]?.ToString() ?? "";
            _logCallback($"âœ… HTTPä¸‹æ³¨æˆåŠŸ: {orderId}");
            return (true, orderId);
        }
        else
        {
            var message = responseJson["message"]?.ToString() ?? "æœªçŸ¥é”™è¯¯";
            _logCallback($"âŒ HTTPä¸‹æ³¨å¤±è´¥: {message}");
            return (false, "");
        }
    }
    catch (Exception ex)
    {
        _logCallback($"âŒ HTTPä¸‹æ³¨å¼‚å¸¸: {ex.Message}");
        return (false, "");
    }
}
```

---

### æ­¥éª¤4ï¼šæ›´æ–°ç™»å½•æ–¹æ³•

**è¾…åŠ©ç™»å½•ï¼ˆè‡ªåŠ¨å¡«å…… + æ‰‹åŠ¨ç‚¹å‡»ï¼‰**:

```csharp
public async Task<bool> LoginAsync(string username, string password)
{
    try
    {
        // æ–¹æ³•1ï¼šè‡ªåŠ¨å¡«å……è¡¨å•ï¼Œç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»ç™»å½•
        var script = $@"
            (function() {{
                const usernameInput = document.querySelector('input[name=""username""]');
                const passwordInput = document.querySelector('input[name=""password""]');
                
                if (usernameInput && passwordInput) {{
                    usernameInput.value = '{username}';
                    passwordInput.value = '{password}';
                    
                    return {{ success: true, message: 'è¡¨å•å·²å¡«å……ï¼Œè¯·æ‰‹åŠ¨ç‚¹å‡»ç™»å½•æŒ‰é’®' }};
                }}
                
                return {{ success: false, message: 'æ‰¾ä¸åˆ°ç™»å½•è¡¨å•' }};
            }})();
        ";
        
        var result = await _webView.CoreWebView2.ExecuteScriptAsync(script);
        var json = JObject.Parse(result);
        var success = json["success"]?.Value<bool>() ?? false;
        
        if (success)
        {
            _logCallback("âœ… è¡¨å•å·²å¡«å……ï¼Œè¯·æ‰‹åŠ¨ç‚¹å‡»ç™»å½•");
            
            // ç­‰å¾…æ‹¦æˆªåˆ°ç™»å½•å“åº”ï¼ˆ10ç§’è¶…æ—¶ï¼‰
            var waitCount = 0;
            while (string.IsNullOrEmpty(_token) && waitCount < 100)
            {
                await Task.Delay(100);
                waitCount++;
            }
            
            return !string.IsNullOrEmpty(_token);
        }
        
        return false;
    }
    catch (Exception ex)
    {
        _logCallback($"âŒ ç™»å½•å¤±è´¥: {ex.Message}");
        return false;
    }
}
```

---

## ğŸ¯ å®Œæ•´å®æ–½æ¸…å•

### âœ… å·²å®Œæˆ
1. WebView2èµ„æºæ‹¦æˆªå™¨
2. Socketé€šä¿¡
3. åŸºæœ¬çš„å¹³å°è„šæœ¬æ¡†æ¶

### â³ å¾…å®Œæˆ
1. **åˆ†æçœŸå®ç½‘ç«™API**
   - ç™»å½•æ¥å£
   - æŠ•æ³¨æ¥å£
   - ä½™é¢æ¥å£
   - å¼€å¥–æ¥å£

2. **æ›´æ–°HandleResponse**
   - æ‹¦æˆªToken/Session
   - è§£ææŠ•æ³¨ç»“æœ
   - æ›´æ–°ä½™é¢

3. **æ›´æ–°PlaceBetAsync**
   - ä½¿ç”¨HttpClientç›´æ¥POST
   - ä¸ä¾èµ–JavaScriptæ³¨å…¥

4. **æ›´æ–°LoginAsync**
   - è¾…åŠ©å¡«å……è¡¨å•
   - æˆ–ä½¿ç”¨HTTP POSTç™»å½•

5. **æµ‹è¯•æµç¨‹**
   - å¯åŠ¨æµè§ˆå™¨
   - æ‰‹åŠ¨/è‡ªåŠ¨ç™»å½•
   - å‘é€æŠ•æ³¨å‘½ä»¤
   - éªŒè¯æŠ•æ³¨ç»“æœ

---

## ğŸ“Œ æ³¨æ„äº‹é¡¹

1. **å®‰å…¨æ€§**ï¼š
   - Tokenåº”è¯¥åŠ å¯†å­˜å‚¨
   - ä¸è¦åœ¨æ—¥å¿—ä¸­æ‰“å°å®Œæ•´Token

2. **é”™è¯¯å¤„ç†**ï¼š
   - ç½‘ç»œè¶…æ—¶
   - æŠ•æ³¨å¤±è´¥
   - ä½™é¢ä¸è¶³
   - å°ç›˜åæŠ•æ³¨

3. **é‡è¿æœºåˆ¶**ï¼š
   - Tokenè¿‡æœŸè‡ªåŠ¨é‡æ–°ç™»å½•
   - ç½‘ç»œæ–­å¼€è‡ªåŠ¨é‡è¿

4. **å¤šå¹³å°æ”¯æŒ**ï¼š
   - æ¯ä¸ªå¹³å°çš„APIä¸åŒ
   - éœ€è¦å•ç‹¬é€‚é…

---

## ğŸš€ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **é€‰æ‹©ä¸€ä¸ªçœŸå®çš„æµ‹è¯•å¹³å°**ï¼ˆä¾‹å¦‚äº‘é¡¶28æµ‹è¯•ç«™ï¼‰
2. **ä½¿ç”¨Chrome DevToolsåˆ†æAPI**
3. **æ›´æ–°YunDing28Scriptå®ç°**
4. **æµ‹è¯•å®Œæ•´æµç¨‹**

å®Œæˆåï¼Œå°±å¯ä»¥æ— ç¼å¯¹æ¥åˆ° `AutoBetService` å’Œ `AutoBetCoordinator`ï¼Œå®ç°è‡ªåŠ¨ä¸‹æ³¨ï¼

---

## ğŸ“š å‚è€ƒä»£ç 

- `BsBrowserClient/Services/WebView2ResourceHandler.cs` - æ‹¦æˆªå™¨
- `BsBrowserClient/PlatformScripts/YunDing28Script.cs` - å¹³å°è„šæœ¬
- `F5BotV2/BetSite/Hy168bingoMember.cs` - F5BotV2ç¤ºä¾‹
- `F5BotV2/CefBrowser/CefResourceRequestHandler.cs` - F5BotV2æ‹¦æˆªå™¨

