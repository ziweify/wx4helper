# 浏览器连接修复 - 主程序重启场景

## 问题描述

### 问题1：投注失败"未连接到浏览器"
- **现象**：封盘时投注失败，日志显示"浏览器未连接，无法推送投注命令"
- **原因**：`_browsers` 字典中找不到对应的 configId
- **触发条件**：主程序重启后，浏览器还在运行

### 问题2：浏览器重复启动
- **现象**：主程序重启后，即使浏览器已在运行，也会启动新的浏览器进程
- **原因**：
  1. `_browsers` 字典在主程序重启后被清空
  2. 浏览器重连需要时间（原来是 5 秒间隔）
  3. `StartBrowser` 立即执行时，浏览器还没来得及重连

---

## 解决方案

### 核心思路

**依靠连接握手而不是窗口查找**：
- 浏览器连接时发送 `configId` 和 `configName`
- 主程序根据 `configId` 自动创建 `BrowserClient`（主程序重启场景）
- 窗口标题显示配置名（仅用于观察）

### 修改内容

#### 1. 浏览器端修改

**文件**：`BsBrowserClient/Services/SocketServer.cs`

```csharp
// ✅ 握手消息同时发送 configId 和 configName
var handshake = new
{
    type = "hello",
    configId = _configId,
    configName = _configName  // 🔥 新增
};

// ✅ 重连间隔从 5 秒改为 1 秒
_onLog("⏳ 1秒后重试连接...");
await Task.Delay(1000, cancellationToken);  // 原来是 5000
```

**文件**：`BsBrowserClient/Program.cs` 和 `Form1.cs`

```csharp
// ✅ 窗口标题显示配置名
this.Text = $"BsBrowser-{configName}";  // 原来是 configId
```

#### 2. 主程序端修改

**文件**：`BaiShengVx3Plus/Services/AutoBet/AutoBetService.cs`

##### 修改 1：`OnBrowserConnected` 自动创建 BrowserClient

```csharp
private void OnBrowserConnected(int configId, TcpClient client)
{
    // ...
    
    if (_browsers.TryGetValue(configId, out var existingBrowser))
    {
        // 已存在，更新连接
        existingBrowser.AttachConnection(client);
    }
    else
    {
        // 🔥 主程序重启场景：自动创建 BrowserClient
        var browserClient = new BrowserClient(configId);
        browserClient.AttachConnection(client);
        _browsers[configId] = browserClient;
    }
    
    // ...
}
```

##### 修改 2：`StartBrowser` 等待浏览器重连

```csharp
public async Task<bool> StartBrowser(int configId)
{
    // ...
    
    // 🔥 如果 _browsers 字典为空，等待 2 秒给浏览器重连的机会
    if (!_browsers.ContainsKey(configId))
    {
        _log.Info("AutoBet", "⏳ 等待 2 秒，给已运行的浏览器重连的机会...");
        await Task.Delay(2000);
        
        // 再次检查
        if (_browsers.ContainsKey(configId))
        {
            _log.Info("AutoBet", "✅ 浏览器已自动重连！无需启动新进程");
            return true;
        }
    }
    
    // 启动新浏览器进程...
}
```

**文件**：`BaiShengVx3Plus/Services/AutoBet/AutoBetSocketServer.cs`

```csharp
// ✅ 解析配置名
var configName = handshake["configName"]?.ToString() ?? "";
_log.Info("AutoBetServer", $"✅ 浏览器握手成功");
_log.Info("AutoBetServer", $"   配置ID: {configId}");
_log.Info("AutoBetServer", $"   配置名: {configName}");
```

**文件**：`BaiShengVx3Plus/Services/AutoBet/BrowserClient.cs`

```csharp
// ✅ StartAsync 传入配置名
public async Task<bool> StartAsync(int port, string configName, string platform, string platformUrl)
{
    // ...
    Arguments = $"--config-id {_configId} --config-name \"{configName}\" --port {port} --platform {platform} --url {platformUrl}";
}
```

---

## 时序分析

### 场景1：主程序重启，浏览器还在运行

#### 修复前（会重复启动）

```
1. 主程序启动 
   → AutoBetService 构造 → Socket 服务器启动（端口 19527）
   → _browsers = {}

2. 检测到飞单开关开启 
   → 立即调用 StartBrowser(configId=1)
   → _browsers 字典为空
   → 启动新浏览器进程 ❌（重复启动！）

3. 旧浏览器尝试重连（5 秒后）
   → 连接到 Socket 服务器
   → OnBrowserConnected 创建 BrowserClient
   → _browsers[1] = browserClient
```

#### 修复后（自动重连）

```
1. 主程序启动 
   → AutoBetService 构造 → Socket 服务器启动（端口 19527）
   → _browsers = {}

2. 旧浏览器快速重连（1 秒内）
   → 连接到 Socket 服务器
   → OnBrowserConnected 自动创建 BrowserClient ✅
   → _browsers[1] = browserClient

3. 检测到飞单开关开启 
   → 调用 StartBrowser(configId=1)
   → _browsers 字典为空
   → 等待 2 秒 ⏳
   → 浏览器在等待期间重连完成
   → _browsers[1] 已存在 ✅
   → 直接返回 true（无需启动新进程）
```

### 场景2：首次启动，浏览器未运行

```
1. 主程序启动 
   → _browsers = {}

2. 检测到飞单开关开启 
   → 调用 StartBrowser(configId=1)
   → _browsers 字典为空
   → 等待 2 秒 ⏳
   → 等待后仍无重连
   → 启动新浏览器进程 ✅
```

---

## 关键参数

| 参数 | 值 | 说明 |
|-----|-----|------|
| **浏览器重连间隔** | 1 秒 | 从原来的 5 秒改为 1 秒，确保快速重连 |
| **主程序等待时间** | 2 秒 | 给浏览器 2 次重连机会（1秒 × 2） |
| **Socket 端口** | 19527 | 固定端口，浏览器主动连接 |

---

## 诊断日志

修复后，启动浏览器时会输出详细的诊断日志：

### 主程序重启场景（浏览器自动重连）

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔍 启动浏览器诊断: ConfigId=1
   当前 _browsers 字典: []
✅ 配置信息: 配置1 (YunDing28)
📌 _browsers 字典中无此 configId，检查是否为主程序重启场景
⏳ 等待 2 秒，给已运行的浏览器重连的机会...

[等待期间，浏览器重连]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔗 浏览器已通过 Socket 连接，配置ID: 1
   客户端地址: 127.0.0.1:xxxxx
   当前 _browsers 字典: []
✅ 配置信息: 配置1 (YunDing28)
📌 _browsers 字典中无此 configId，自动创建 BrowserClient（主程序重启场景）
✅ BrowserClient 已创建并附加连接
   提示：这通常发生在主程序重启后，浏览器自动重连的情况
✅ 浏览器 Socket 连接处理完成: 配置1
   更新后 _browsers 字典: [1]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[StartBrowser 继续]
✅ 浏览器已自动重连！无需启动新进程
   更新后 _browsers 字典: [1]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 首次启动场景（启动新浏览器）

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔍 启动浏览器诊断: ConfigId=1
   当前 _browsers 字典: []
✅ 配置信息: 配置1 (YunDing28)
📌 _browsers 字典中无此 configId，检查是否为主程序重启场景
⏳ 等待 2 秒，给已运行的浏览器重连的机会...
📌 等待后仍未重连，准备启动新浏览器进程
📌 _browsers 字典中无此 configId
   说明：如果浏览器已在运行，会在连接时自动添加到字典
🚀 启动新浏览器进程: 配置1
   ConfigId: 1
   平台: YunDing28
   URL: https://www.yunding28.com
✅ 浏览器进程已启动
   更新后 _browsers 字典: [1]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 测试要点

### 1. 主程序重启测试

**步骤**：
1. 启动主程序和浏览器，确认飞单正常工作
2. 关闭主程序（不关浏览器）
3. 重新启动主程序，飞单开关开启
4. **预期**：
   - 日志显示"等待 2 秒，给已运行的浏览器重连的机会"
   - 日志显示"浏览器已自动重连！无需启动新进程"
   - 不会启动新的浏览器窗口
   - 投注功能正常

### 2. 连接诊断测试

**步骤**：
1. 微信中发送 `123大10`
2. 等待封盘
3. **预期**：
   - 日志显示"尝试发送投注命令: configId=1"
   - 日志显示"当前 _browsers 字典包含的 configId: [1]"
   - 日志显示"找到浏览器客户端: configId=1"
   - 投注成功

### 3. 浏览器窗口标题测试

**预期**：
- 浏览器窗口标题显示 `BsBrowser-配置1`（配置名）
- 不是 `BsBrowser-1`（配置ID）

---

## 相关文件

- `BsBrowserClient/Services/SocketServer.cs` - 浏览器端 Socket 客户端
- `BsBrowserClient/Program.cs` - 浏览器端入口
- `BsBrowserClient/Form1.cs` - 浏览器端窗口
- `BaiShengVx3Plus/Services/AutoBet/AutoBetService.cs` - 主程序自动投注服务
- `BaiShengVx3Plus/Services/AutoBet/AutoBetSocketServer.cs` - 主程序 Socket 服务器
- `BaiShengVx3Plus/Services/AutoBet/BrowserClient.cs` - 浏览器客户端封装
- `BaiShengVx3Plus/Services/AutoBet/AutoBetCoordinator.cs` - 自动投注协调器
- `BaiShengVx3Plus/Views/VxMain.cs` - 主窗口（飞单开关事件）

---

## 修复日期

2025-11-14

