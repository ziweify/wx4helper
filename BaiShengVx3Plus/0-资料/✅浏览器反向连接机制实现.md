# ✅ 浏览器反向连接机制实现

## 📅 2025-11-07

## 🎯 核心改进

### 问题场景

1. ✅ **VxMain 先启动 → 启动浏览器** - 正常
2. ❌ **关闭 VxMain → 保留浏览器** - 浏览器失联
3. ❌ **重新启动 VxMain** - 浏览器无法重连

### 根本原因

- 之前：浏览器被动等待 VxMain 连接（监听端口）
- 问题：VxMain 重启后，端口可能改变，浏览器不知道新端口

### 解决方案：反向连接

**核心理念**：浏览器主动连接 VxMain（固定端口）

```
┌──────────────┐   握手（ConfigID）  ┌─────────────────┐
│BsBrowserClient│─────────────────────>│VxMain (19527)  │
│  (配置ID: 1)  │<──────确认───────────│  AutoBetServer  │
└──────────────┘   持续监听命令      └─────────────────┘
```

## 📝 实现细节

### 1️⃣ VxMain 端：固定端口服务器

**新增文件**：`BaiShengVx3Plus/Services/AutoBet/AutoBetSocketServer.cs`

```csharp
public class AutoBetSocketServer
{
    private const int SERVER_PORT = 19527; // 固定端口
    
    // 握手协议
    // 1. 浏览器发送: { type: "hello", configId: 1 }
    // 2. VxMain 回复: { type: "welcome", success: true }
    // 3. 保存连接到 _connections[configId]
    // 4. 通知 AutoBetService
}
```

**特点**：
- ✅ 监听固定端口 `19527`
- ✅ 接收浏览器握手消息
- ✅ 根据 `configId` 关联连接
- ✅ 支持多个浏览器同时连接
- ✅ 断线自动清理

### 2️⃣ BsBrowserClient 端：主动连接

**修改文件**：`BsBrowserClient/Services/SocketServer.cs`

```csharp
public class SocketServer
{
    private const int VXMAIN_SERVER_PORT = 19527;
    
    private async Task ConnectAndListenAsync()
    {
        while (true)
        {
            try
            {
                // 1. 连接到 VxMain
                _client = new TcpClient();
                await _client.ConnectAsync("127.0.0.1", VXMAIN_SERVER_PORT);
                
                // 2. 发送握手
                var handshake = new { type = "hello", configId = _configId };
                await _writer.WriteLineAsync(JsonConvert.SerializeObject(handshake));
                
                // 3. 等待确认
                var welcome = await _reader.ReadLineAsync();
                
                // 4. 持续处理命令
                await ProcessCommandsAsync();
            }
            catch
            {
                // 5秒后重试连接
                await Task.Delay(5000);
            }
        }
    }
}
```

**特点**：
- ✅ 启动时主动连接 VxMain
- ✅ 断线后自动重连（5秒间隔）
- ✅ 握手时发送自己的配置ID
- ✅ 支持 VxMain 重启后恢复连接

### 3️⃣ AutoBetService：连接管理

**修改文件**：`BaiShengVx3Plus/Services/AutoBet/AutoBetService.cs`

```csharp
public AutoBetService(ILogService log)
{
    _log = log;
    
    // 启动 Socket 服务器
    _socketServer = new AutoBetSocketServer(log, OnBrowserConnected);
    _socketServer.Start();
}

private void OnBrowserConnected(int configId, TcpClient client)
{
    // 1. 验证配置存在
    var config = GetConfig(configId);
    
    // 2. 创建或更新 BrowserClient
    var browserClient = new BrowserClient(configId);
    browserClient.AttachConnection(client);
    _browsers[configId] = browserClient;
    
    // 3. 更新配置状态
    config.Status = "已连接";
    SaveConfig(config);
}
```

### 4️⃣ 删除配置的 SQL 修复

**问题**：`_db.Delete<BetConfig>(id)` 语法错误

**修复**：

```csharp
public void DeleteConfig(int id)
{
    if (_db == null) return;
    
    var config = GetConfig(id);
    if (config != null && !config.IsDefault)
    {
        StopBrowser(id);
        
        // ✅ 使用 Execute 代替 Delete
        _db.Execute("DELETE FROM AutoBetConfigs WHERE Id = ?", id);
        
        // 删除相关的投注记录（可选）
        _db.Execute("DELETE FROM BetOrderRecords WHERE ConfigId = ?", id);
        
        _log.Info("AutoBet", $"配置已删除: {config.ConfigName}");
    }
}
```

## 🔄 工作流程

### 正常启动

```
1. VxMain 启动 → AutoBetSocketServer 监听 19527
2. 用户点击"启动浏览器" → BsBrowserClient 启动
3. BsBrowserClient 连接 19527 → 发送握手 { configId: 1 }
4. VxMain 确认 → 关联连接到配置1
5. ✅ 连接建立，可以通信
```

### VxMain 重启恢复

```
1. BsBrowserClient 已运行，VxMain 关闭
2. BsBrowserClient 检测到连接断开
3. 5秒后自动重试连接
4. VxMain 重启 → AutoBetSocketServer 监听 19527
5. BsBrowserClient 重连成功 → 发送握手 { configId: 1 }
6. VxMain 确认 → 恢复连接
7. ✅ 连接恢复，继续工作
```

### 浏览器先启动

```
1. BsBrowserClient 先启动 → 尝试连接 19527
2. 连接失败（VxMain 未启动）
3. 5秒后重试...
4. VxMain 启动 → AutoBetSocketServer 监听 19527
5. BsBrowserClient 重连成功 → 发送握手
6. ✅ 连接建立
```

## 📊 编译结果

```
⚠️ 编译失败（预期）
原因：BsBrowserClient进程 (PID: 36916) 正在运行，文件被锁定
解决：关闭浏览器后重新编译
```

## ✅ 已完成功能

1. ✅ **AutoBetSocketServer** - VxMain 固定端口服务器
2. ✅ **反向连接机制** - 浏览器主动连接
3. ✅ **握手协议** - 配置ID识别
4. ✅ **自动重连** - 断线后5秒重试
5. ✅ **连接管理** - 多浏览器支持
6. ✅ **配置删除修复** - SQL语法修正

## 🚀 使用说明

### 启动顺序无关

- ✅ VxMain 先启动 → 正常
- ✅ 浏览器先启动 → 自动重连
- ✅ VxMain 重启 → 自动恢复

### 配置ID识别

- 浏览器窗口标题：`BsBrowser-{configId}`
- 握手消息包含：`configId`
- VxMain 根据 `configId` 关联连接

### 状态同步

- 浏览器连接成功 → 配置状态更新为"已连接"
- 浏览器断开 → 自动清理连接
- VxMain 重启 → 浏览器自动重连并恢复状态

## 🔧 下一步测试

1. **关闭浏览器进程 (PID: 36916)**
2. **重新编译**：`dotnet build BaiShengVx3Plus/BaiShengVx3Plus.csproj`
3. **测试场景**：
   - VxMain → 启动浏览器 → 关闭 VxMain → 重启 VxMain（验证重连）
   - 启动浏览器 → 启动 VxMain（验证反向连接）
   - 配置管理器 → 删除配置（验证SQL修复）

---

**反向连接机制 = 无论启动顺序如何，总能建立连接！** 🎉

