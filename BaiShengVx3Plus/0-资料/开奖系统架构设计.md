# ğŸ¯ BaiShengVx3Plus å¼€å¥–ç³»ç»Ÿæ¶æ„è®¾è®¡

## ğŸ“‹ ç›®å½•
1. [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
2. [æ ¸å¿ƒæ¨¡å—](#æ ¸å¿ƒæ¨¡å—)
3. [æ•°æ®æµç¨‹](#æ•°æ®æµç¨‹)
4. [æŠ€æœ¯æ¶æ„](#æŠ€æœ¯æ¶æ„)
5. [å®ç°è·¯çº¿å›¾](#å®ç°è·¯çº¿å›¾)

---

## ç³»ç»Ÿæ¦‚è¿°

### è®¾è®¡åŸåˆ™
âœ… **ç°ä»£åŒ–**ï¼šä½¿ç”¨ä¾èµ–æ³¨å…¥ã€äº‹ä»¶é©±åŠ¨ã€å¼‚æ­¥ç¼–ç¨‹  
âœ… **ç²¾ç®€**ï¼šå•ä¸€èŒè´£ã€é¿å…å†—ä½™ã€ORM è‡ªåŠ¨åŒ–  
âœ… **æ˜“ç»´æŠ¤**ï¼šæ¸…æ™°çš„åˆ†å±‚ã€å®Œå–„çš„æ—¥å¿—ã€ç»Ÿä¸€çš„é”™è¯¯å¤„ç†  

### æ ¸å¿ƒåŠŸèƒ½
1. **ç™»å½•è®¤è¯**ï¼šWebAPI ç™»å½•ï¼Œè·å–ç”¨æˆ·æƒé™å’Œé…ç½®
2. **å¼€å¥–æœåŠ¡**ï¼šæœŸå·ç®¡ç†ã€å€’è®¡æ—¶ã€çŠ¶æ€å˜æ›´ã€å¼€å¥–æ•°æ®æ›´æ–°
3. **è®¢å•å¤„ç†**ï¼šæ¥æ”¶å¾®ä¿¡æ¶ˆæ¯ â†’ è§£æä¸‹æ³¨ â†’ ä¿å­˜è®¢å• â†’ å›å¤ç¡®è®¤
4. **ç»“ç®—ç³»ç»Ÿ**ï¼šå¼€å¥–åè‡ªåŠ¨ç»“ç®—è®¢å• â†’ æ›´æ–°ä¼šå‘˜ä½™é¢ â†’ å‘é€é€šçŸ¥
5. **é…ç½®ç®¡ç†**ï¼šèµ”ç‡ã€é™é¢ã€å°ç›˜æ—¶é—´ç­‰

---

## æ ¸å¿ƒæ¨¡å—

### 1. è®¤è¯ç™»å½•æ¨¡å— (`Services/Auth/`)

```
ILotteryAuthService
â”œâ”€â”€ LoginAsync(server, username, password)
â”œâ”€â”€ LogoutAsync()
â”œâ”€â”€ IsAuthenticated
â””â”€â”€ CurrentUser (LotteryUser)

LotteryAuthService (å®ç°)
â”œâ”€â”€ ä½¿ç”¨ HttpClient è°ƒç”¨ WebAPI
â”œâ”€â”€ ç¼“å­˜ Token å’Œç”¨æˆ·ä¿¡æ¯
â””â”€â”€ è‡ªåŠ¨åˆ·æ–° Token
```

**å‚è€ƒ**ï¼š`NPlans/Services/AuthService.cs`

---

### 2. å¼€å¥–æœåŠ¡æ¨¡å— (`Services/Lottery/`)

```
ILotteryService
â”œâ”€â”€ StartAsync()              // å¯åŠ¨æœåŠ¡
â”œâ”€â”€ StopAsync()               // åœæ­¢æœåŠ¡
â”œâ”€â”€ CurrentIssueId           // å½“å‰æœŸå·
â”œâ”€â”€ CurrentStatus            // å½“å‰çŠ¶æ€ (ç­‰å¾…/å¼€ç›˜/å°ç›˜/å¼€å¥–)
â”œâ”€â”€ SecondsToSeal            // è·ç¦»å°ç›˜ç§’æ•°
â”œâ”€â”€ Events:
â”‚   â”œâ”€â”€ IssueChanged         // æœŸå·å˜æ›´äº‹ä»¶
â”‚   â”œâ”€â”€ StatusChanged        // çŠ¶æ€å˜æ›´äº‹ä»¶ (å¼€ç›˜/å°ç›˜/å¼€å¥–)
â”‚   â”œâ”€â”€ CountdownTick        // å€’è®¡æ—¶æ›´æ–°äº‹ä»¶ (æ¯ç§’)
â”‚   â””â”€â”€ LotteryOpened        // å¼€å¥–æ•°æ®åˆ°è¾¾äº‹ä»¶

LotteryService (å®ç°)
â”œâ”€â”€ ä½¿ç”¨ System.Threading.Timer å®šæ—¶å™¨
â”œâ”€â”€ å®šæ—¶ä» WebAPI è·å–å½“å‰æœŸå·å’ŒçŠ¶æ€
â”œâ”€â”€ è®¡ç®—å€’è®¡æ—¶
â”œâ”€â”€ è§¦å‘å„ç§äº‹ä»¶
â””â”€â”€ è‡ªåŠ¨é‡è¿æœºåˆ¶
```

**å…³é”®é€»è¾‘**ï¼š
```csharp
// çŠ¶æ€æœº
enum LotteryStatus
{
    ç­‰å¾…ä¸­ = 0,  // ç³»ç»Ÿåˆå§‹åŒ–æˆ–åœæ­¢
    å¼€ç›˜ä¸­ = 1,  // å¯ä»¥æ¥å—ä¸‹æ³¨
    å°ç›˜ä¸­ = 2,  // åœæ­¢æ¥å—ä¸‹æ³¨ï¼Œç­‰å¾…å¼€å¥–
    å¼€å¥–ä¸­ = 3,  // å¼€å¥–æ•°æ®å¤„ç†ä¸­
}

// å®šæ—¶å™¨é€»è¾‘ï¼ˆæ¯ 1 ç§’æ‰§è¡Œä¸€æ¬¡ï¼‰
private async void OnTimerTick()
{
    // 1. è·å–æœ€æ–°æœŸå·å’ŒçŠ¶æ€
    var lotteryData = await _webApi.GetCurrentLotteryDataAsync();
    
    // 2. æ£€æŸ¥æœŸå·å˜æ›´
    if (lotteryData.IssueId != CurrentIssueId)
    {
        await OnIssueChangedAsync(lotteryData);
    }
    
    // 3. è®¡ç®—å€’è®¡æ—¶
    var secondsToSeal = CalculateSecondsToSeal(lotteryData);
    
    // 4. æ£€æŸ¥çŠ¶æ€å˜æ›´
    if (secondsToSeal <= 0 && CurrentStatus == LotteryStatus.å¼€ç›˜ä¸­)
    {
        await OnStatusChangedAsync(LotteryStatus.å°ç›˜ä¸­, lotteryData);
    }
    
    // 5. è§¦å‘å€’è®¡æ—¶äº‹ä»¶
    CountdownTick?.Invoke(this, new CountdownEventArgs(secondsToSeal));
}
```

**å‚è€ƒ**ï¼š`F5BotV2/Boter/BoterServices.cs` (Line 78-200)

---

### 3. è®¢å•å¤„ç†æ¨¡å— (`Services/Order/`)

```
IOrderService
â”œâ”€â”€ CreateOrderAsync(member, issueId, betContent, amount)
â”œâ”€â”€ SettleOrdersAsync(issueId, lotteryResult)
â”œâ”€â”€ GetPendingOrdersAsync(issueId)
â””â”€â”€ ValidateBetAsync(member, betContent, amount)

OrderService (å®ç°)
â”œâ”€â”€ è§£æä¸‹æ³¨å†…å®¹ (BinGouHelper)
â”œâ”€â”€ éªŒè¯é™é¢å’Œèµ”ç‡
â”œâ”€â”€ ä¿å­˜åˆ° V2MemberOrder è¡¨
â”œâ”€â”€ æ›´æ–°ä¼šå‘˜ä½™é¢
â””â”€â”€ å¼€å¥–åè‡ªåŠ¨ç»“ç®—
```

**ä¸‹æ³¨è§£ææµç¨‹**ï¼š
```
å¾®ä¿¡æ¶ˆæ¯: "1 100 äº”å• 10"
    â†“
è§£æå™¨ (BinGouHelper.ParseBetContent)
    â†“
éªŒè¯ (é™é¢ã€ä½™é¢ã€èµ”ç‡)
    â†“
åˆ›å»ºè®¢å• (ä¿å­˜åˆ°æ•°æ®åº“)
    â†“
æ›´æ–°ä¼šå‘˜ä½™é¢ (Balance -= amount)
    â†“
å›å¤ç¡®è®¤ (å·²è¿›ä»“ï¼æœŸå·ï¼šxxxï¼Œé‡‘é¢ï¼š100)
```

**å‚è€ƒ**ï¼š`F5BotV2/Game/BinGou/BinGouHelper.cs`

---

### 4. æ¶ˆæ¯å¤„ç†æ¨¡å— (`Services/Messages/Handlers/`)

```
ILotteryMessageHandler : IMessageHandler
â””â”€â”€ HandleAsync(message)

LotteryMessageHandler (å®ç°)
â”œâ”€â”€ æ£€æŸ¥å½“å‰çŠ¶æ€ (æ˜¯å¦å°ç›˜)
â”œâ”€â”€ è§£æä¸‹æ³¨å†…å®¹
â”œâ”€â”€ è°ƒç”¨ OrderService.CreateOrderAsync()
â”œâ”€â”€ ç”Ÿæˆå›å¤æ¶ˆæ¯
â””â”€â”€ å‘é€å¾®ä¿¡æ¶ˆæ¯
```

**é›†æˆåˆ°ç°æœ‰æ¶ˆæ¯ç³»ç»Ÿ**ï¼š
```csharp
// MessageDispatcher.cs
public class MessageDispatcher
{
    private readonly ILotteryService _lotteryService;
    private readonly IOrderService _orderService;
    
    public async Task ProcessTextMessageAsync(WxTextMessage message)
    {
        // æ£€æŸ¥æ˜¯å¦ä¸ºä¸‹æ³¨æ¶ˆæ¯
        if (IsBetMessage(message.Content))
        {
            // æ£€æŸ¥æ˜¯å¦å·²å°ç›˜
            if (_lotteryService.CurrentStatus == LotteryStatus.å°ç›˜ä¸­)
            {
                await SendReplyAsync(message.FromWxid, "å·²å°ç›˜ï¼Œè¯·ç­‰å¾…ä¸‹æœŸï¼");
                return;
            }
            
            // å¤„ç†è®¢å•
            var handler = new LotteryMessageHandler(_lotteryService, _orderService);
            await handler.HandleAsync(message);
        }
    }
}
```

---

### 5. é…ç½®ç®¡ç†æ¨¡å— (`Models/Settings/`)

```csharp
public class LotterySettings
{
    // èµ”ç‡é…ç½®
    public Dictionary<string, float> Odds { get; set; }  // ä¾‹å¦‚ï¼š{"å¤§": 1.95, "å°": 1.95}
    
    // é™é¢é…ç½®
    public float MinBet { get; set; } = 1.0f;
    public float MaxBet { get; set; } = 10000.0f;
    public float MaxBetPerIssue { get; set; } = 50000.0f;  // å•æœŸæœ€å¤§æŠ•æ³¨
    
    // å°ç›˜é…ç½®
    public int SealSecondsAhead { get; set; } = 30;  // æå‰ 30 ç§’å°ç›˜
    
    // å›å¤æ¶ˆæ¯é…ç½®
    public string ReplySuccess { get; set; } = "å·²è¿›ä»“ï¼";
    public string ReplyFailed { get; set; } = "å®¢å®˜æˆ‘æœ‰ç‚¹ä¸æ˜ç™½ï¼";
    public string ReplyInsufficient { get; set; } = "å®¢å®˜ä½ çš„è·åŒ…æ˜¯å¦ä¸è¶³ï¼";
    public string ReplySealed { get; set; } = "å·²å°ç›˜ï¼Œè¯·ç­‰å¾…ä¸‹æœŸï¼";
    
    // å¼€ç›˜æç¤º
    public string ReplyOpenNotice { get; set; } = "---------çº¿ä¸‹å¼€å§‹---------";
}
```

**æŒä¹…åŒ–**ï¼šä½¿ç”¨ SQLite å­˜å‚¨ï¼Œæˆ– JSON é…ç½®æ–‡ä»¶

---

### 6. UI ç”¨æˆ·æ§ä»¶ (`Views/Controls/`)

#### 6.1 å½“å‰æœŸå¼€å¥–æ•°æ®æ§ä»¶ (`UcLotteryDataCur.cs`)

```
æ˜¾ç¤ºå†…å®¹ï¼š
â”œâ”€â”€ å½“å‰æœŸå·ï¼šä¾‹å¦‚ "20251106-001"
â”œâ”€â”€ å¼€å¥–çŠ¶æ€ï¼šç­‰å¾…ä¸­ / å¼€ç›˜ä¸­ / å°ç›˜ä¸­ / å¼€å¥–ä¸­
â”œâ”€â”€ å€’è®¡æ—¶ï¼šè·ç¦»å°ç›˜è¿˜æœ‰ XX ç§’
â”œâ”€â”€ å¼€å¥–å·ç ï¼šP1 P2 P3 P4 P5 æ€»å’Œ å¤§å° å•åŒ é¾™è™
â””â”€â”€ ç»Ÿè®¡ä¿¡æ¯ï¼šæœ¬æœŸæŠ•æ³¨é‡‘é¢ã€è®¢å•æ•°

è®¾è®¡é£æ ¼ï¼š
- å¤§å·å­—ä½“æ˜¾ç¤ºæœŸå·
- å½©è‰²èƒŒæ™¯åŒºåˆ†çŠ¶æ€ (ç»¿è‰²=å¼€ç›˜, çº¢è‰²=å°ç›˜, é»„è‰²=å¼€å¥–)
- æ•°å­—çƒå½¢æ ·å¼æ˜¾ç¤ºå·ç 
- å®æ—¶å€’è®¡æ—¶åŠ¨ç”»
```

#### 6.2 ä¸ŠæœŸå¼€å¥–æ•°æ®æ§ä»¶ (`UcLotteryDataLast.cs`)

```
æ˜¾ç¤ºå†…å®¹ï¼š
â”œâ”€â”€ ä¸ŠæœŸæœŸå·
â”œâ”€â”€ å¼€å¥–å·ç 
â”œâ”€â”€ æœ¬æœŸç›ˆäº
â””â”€â”€ ç»“ç®—çŠ¶æ€
```

**æ•°æ®ç»‘å®š**ï¼š
```csharp
public class UcLotteryDataCur : UserControl
{
    private ILotteryService _lotteryService;
    
    public UcLotteryDataCur(ILotteryService lotteryService)
    {
        _lotteryService = lotteryService;
        
        // è®¢é˜…äº‹ä»¶
        _lotteryService.IssueChanged += OnIssueChanged;
        _lotteryService.StatusChanged += OnStatusChanged;
        _lotteryService.CountdownTick += OnCountdownTick;
        _lotteryService.LotteryOpened += OnLotteryOpened;
    }
    
    private void OnCountdownTick(object sender, CountdownEventArgs e)
    {
        UpdateUIThreadSafe(() =>
        {
            lblCountdown.Text = $"{e.Seconds} ç§’";
            lblCountdown.ForeColor = e.Seconds <= 10 ? Color.Red : Color.Black;
        });
    }
}
```

---

## æ•°æ®æµç¨‹

### å®Œæ•´ä¸šåŠ¡æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. ç³»ç»Ÿå¯åŠ¨                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. ç”¨æˆ·ç™»å½• (LotteryAuthService)                            â”‚
â”‚     - è°ƒç”¨ WebAPI ç™»å½•                                       â”‚
â”‚     - è·å–ç”¨æˆ·ä¿¡æ¯å’Œé…ç½®                                      â”‚
â”‚     - åˆå§‹åŒ–æ•°æ®åº“ (business_{wxid}.db)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. å¯åŠ¨å¼€å¥–æœåŠ¡ (LotteryService.StartAsync)                 â”‚
â”‚     - å¯åŠ¨å®šæ—¶å™¨ (æ¯ 1 ç§’)                                    â”‚
â”‚     - è·å–å½“å‰æœŸå·å’ŒçŠ¶æ€                                      â”‚
â”‚     - å¼€å§‹å€’è®¡æ—¶                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. å¼€ç›˜ (StatusChanged â†’ å¼€ç›˜ä¸­)                            â”‚
â”‚     - æ˜¾ç¤º"å¼€ç›˜æç¤º"                                         â”‚
â”‚     - UI æ§ä»¶æ›´æ–°çŠ¶æ€                                        â”‚
â”‚     - å…è®¸æ¥æ”¶ä¸‹æ³¨                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. æ¥æ”¶å¾®ä¿¡æ¶ˆæ¯                                             â”‚
â”‚     - WeixinX æ¨é€æ¶ˆæ¯åˆ° C#                                  â”‚
â”‚     - MessageDispatcher è·¯ç”±æ¶ˆæ¯                             â”‚
â”‚     - LotteryMessageHandler å¤„ç†ä¸‹æ³¨                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  6. è®¢å•å¤„ç† (OrderService.CreateOrderAsync)                 â”‚
â”‚     - è§£æä¸‹æ³¨å†…å®¹ (BinGouHelper)                            â”‚
â”‚     - éªŒè¯ï¼šä½™é¢ã€é™é¢ã€èµ”ç‡                                  â”‚
â”‚     - ä¿å­˜è®¢å•åˆ°æ•°æ®åº“ (V2MemberOrder)                       â”‚
â”‚     - æ›´æ–°ä¼šå‘˜ä½™é¢ (V2Member.Balance -= amount)              â”‚
â”‚     - å›å¤å¾®ä¿¡æ¶ˆæ¯ï¼š"å·²è¿›ä»“ï¼æœŸå·ï¼šxxxï¼Œé‡‘é¢ï¼š100"             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  7. å°ç›˜ (StatusChanged â†’ å°ç›˜ä¸­)                            â”‚
â”‚     - å€’è®¡æ—¶ = 0 æˆ–æå‰ N ç§’                                 â”‚
â”‚     - åœæ­¢æ¥æ”¶ä¸‹æ³¨                                           â”‚
â”‚     - å›å¤"å·²å°ç›˜"                                           â”‚
â”‚     - UI æ§ä»¶å˜çº¢è‰²                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  8. å¼€å¥– (LotteryOpened äº‹ä»¶)                                â”‚
â”‚     - WebAPI è¿”å›å¼€å¥–å·ç                                     â”‚
â”‚     - è§£æå·ç  (P1, P2, P3, P4, P5)                         â”‚
â”‚     - è®¡ç®—ç»“æœ (æ€»å’Œ, å¤§å°, å•åŒ, é¾™è™)                      â”‚
â”‚     - æ›´æ–° UI æ§ä»¶                                           â”‚
â”‚     - ä¿å­˜åˆ°å¼€å¥–æ•°æ®è¡¨ (BgLotteryData)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  9. ç»“ç®— (OrderService.SettleOrdersAsync)                    â”‚
â”‚     - æŸ¥è¯¢å½“æœŸæ‰€æœ‰è®¢å•                                        â”‚
â”‚     - é€ä¸ªç»“ç®—ï¼š                                             â”‚
â”‚       â”œâ”€â”€ è®¡ç®—ç›ˆäº (ä¸­å¥– = amount * odds, ä¸ä¸­ = -amount)   â”‚
â”‚       â”œâ”€â”€ æ›´æ–°è®¢å•çŠ¶æ€ (OrderStatus = å·²ç»“ç®—)                â”‚
â”‚       â”œâ”€â”€ æ›´æ–°ä¼šå‘˜ä½™é¢ (Balance += profit)                   â”‚
â”‚       â””â”€â”€ æ›´æ–°ä¼šå‘˜ç»Ÿè®¡ (IncomeToday, IncomeTotal)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  10. å‘é€ç»“ç®—é€šçŸ¥                                            â”‚
â”‚      - ç”Ÿæˆç»“ç®—æŠ¥å‘Šæ¶ˆæ¯                                       â”‚
â”‚      - å‘é€åˆ°å¾®ä¿¡ç¾¤                                          â”‚
â”‚      - ä¾‹å¦‚ï¼š"ç¬¬ xxx æœŸå¼€å¥–ç»“æœï¼š12345ï¼Œå¤§å•ã€‚æœ¬æœŸç›ˆäºï¼š+100" â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  11. æœŸå·å˜æ›´ (IssueChanged äº‹ä»¶)                            â”‚
â”‚      - æ£€æµ‹åˆ°æ–°æœŸå·                                          â”‚
â”‚      - é‡ç½®å€’è®¡æ—¶                                            â”‚
â”‚      - æ¸…ç©ºå½“å‰æœŸæ•°æ®                                         â”‚
â”‚      - å›åˆ°æ­¥éª¤ 4 (å¼€ç›˜)                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æŠ€æœ¯æ¶æ„

### ä¾èµ–æ³¨å…¥é…ç½® (`Program.cs`)

```csharp
services.AddSingleton<ILotteryAuthService, LotteryAuthService>();
services.AddSingleton<ILotteryService, LotteryService>();
services.AddSingleton<IOrderService, OrderService>();
services.AddSingleton<ISettingsService, SettingsService>();
services.AddSingleton<ILotteryMessageHandler, LotteryMessageHandler>();

// å¼€å¥–æ•°æ® BindingList
services.AddSingleton<BgLotteryDataBindingList>();
```

### æœåŠ¡å¯åŠ¨é¡ºåº

```csharp
// VxMain_Load æˆ– btnConnect_Click
private async void OnConnected()
{
    // 1. ç™»å½•è®¤è¯
    var authService = ServiceProvider.GetService<ILotteryAuthService>();
    var loginSuccess = await authService.LoginAsync(server, username, password);
    
    // 2. åˆå§‹åŒ–æ•°æ®åº“
    InitializeDatabase(authService.CurrentUser.Wxid);
    
    // 3. å¯åŠ¨å¼€å¥–æœåŠ¡
    var lotteryService = ServiceProvider.GetService<ILotteryService>();
    await lotteryService.StartAsync();
    
    // 4. è®¢é˜…äº‹ä»¶
    lotteryService.IssueChanged += OnLotteryIssueChanged;
    lotteryService.StatusChanged += OnLotteryStatusChanged;
    lotteryService.LotteryOpened += OnLotteryOpened;
}
```

### äº‹ä»¶å¤„ç†ç¤ºä¾‹

```csharp
// æœŸå·å˜æ›´
private async void OnLotteryIssueChanged(object sender, IssueChangedEventArgs e)
{
    _logService.Info("VxMain", $"æœŸå·å˜æ›´: {e.OldIssueId} â†’ {e.NewIssueId}");
    
    // æ›´æ–° UI
    UpdateUIThreadSafe(() =>
    {
        ucLotteryDataLast.SetData(e.LastLotteryData);
        ucLotteryDataCur.SetIssueId(e.NewIssueId);
    });
    
    // å‘é€å¼€ç›˜é€šçŸ¥
    if (_settingsService.AutoSendOpenNotice)
    {
        await SendGroupMessageAsync(_currentBoundContact.Wxid, 
            $"---------çº¿ä¸‹å¼€å§‹--------- \næœŸå·ï¼š{e.NewIssueId}");
    }
}

// å¼€å¥–æ•°æ®åˆ°è¾¾
private async void OnLotteryOpened(object sender, LotteryOpenedEventArgs e)
{
    _logService.Info("VxMain", $"å¼€å¥–æ•°æ®åˆ°è¾¾: {e.LotteryData.IssueId} - {e.LotteryData.NumbersString}");
    
    // æ›´æ–° UI
    UpdateUIThreadSafe(() =>
    {
        ucLotteryDataCur.SetLotteryNumbers(e.LotteryData);
    });
    
    // ç»“ç®—è®¢å•
    await _orderService.SettleOrdersAsync(e.LotteryData.IssueId, e.LotteryData);
    
    // å‘é€ç»“ç®—é€šçŸ¥
    var summary = await _orderService.GetSettlementSummaryAsync(e.LotteryData.IssueId);
    await SendGroupMessageAsync(_currentBoundContact.Wxid, summary);
}
```

---

## å®ç°è·¯çº¿å›¾

### Phase 1: åŸºç¡€æ¡†æ¶ (2-3 å¤©)

âœ… **ä»»åŠ¡1**: åˆ›å»ºæ ¸å¿ƒæ¥å£å’Œæ¨¡å‹
- [ ] `Contracts/ILotteryAuthService.cs`
- [ ] `Contracts/ILotteryService.cs`
- [ ] `Contracts/IOrderService.cs`
- [ ] `Models/LotteryUser.cs`
- [ ] `Models/BgLotteryData.cs` (å¤åˆ¶è‡ª F5BotV2ï¼Œç²¾ç®€)
- [ ] `Models/LotterySettings.cs`

âœ… **ä»»åŠ¡2**: å®ç°ç™»å½•è®¤è¯
- [ ] `Services/Lottery/LotteryAuthService.cs`
- [ ] WebAPI å®¢æˆ·ç«¯å°è£… (HttpClient)
- [ ] Token ç¼“å­˜å’Œåˆ·æ–°

âœ… **ä»»åŠ¡3**: å®ç°å¼€å¥–æœåŠ¡æ ¸å¿ƒé€»è¾‘
- [ ] `Services/Lottery/LotteryService.cs`
- [ ] å®šæ—¶å™¨é€»è¾‘
- [ ] çŠ¶æ€æœº
- [ ] äº‹ä»¶è§¦å‘

### Phase 2: è®¢å•å’Œæ¶ˆæ¯å¤„ç† (2-3 å¤©)

âœ… **ä»»åŠ¡4**: å®ç°è®¢å•æœåŠ¡
- [ ] `Services/Order/OrderService.cs`
- [ ] ä¸‹æ³¨è§£æå™¨ (`Helpers/BinGouHelper.cs`)
- [ ] è®¢å•éªŒè¯
- [ ] ç»“ç®—é€»è¾‘

âœ… **ä»»åŠ¡5**: é›†æˆæ¶ˆæ¯å¤„ç†
- [ ] `Services/Messages/Handlers/LotteryMessageHandler.cs`
- [ ] æ›´æ–° `MessageDispatcher` è·¯ç”±ä¸‹æ³¨æ¶ˆæ¯
- [ ] å¾®ä¿¡å›å¤æ¶ˆæ¯ç”Ÿæˆ

âœ… **ä»»åŠ¡6**: æ•°æ®åº“é›†æˆ
- [ ] ä½¿ç”¨ ORM åˆ›å»º `BgLotteryData` è¡¨
- [ ] åˆ›å»º `BgLotteryDataBindingList`
- [ ] ç¡®ä¿ä¸ `V2Member` å’Œ `V2MemberOrder` åŒæ­¥

### Phase 3: UI å’Œé…ç½® (2-3 å¤©)

âœ… **ä»»åŠ¡7**: å¼€å‘ UI æ§ä»¶
- [ ] `Views/Controls/UcLotteryDataCur.cs`
- [ ] `Views/Controls/UcLotteryDataLast.cs`
- [ ] é›†æˆåˆ° `VxMain` çš„ `pnl_opendata`

âœ… **ä»»åŠ¡8**: é…ç½®ç®¡ç†
- [ ] è®¾è®¡é…ç½®ç•Œé¢ (èµ”ç‡ã€é™é¢ã€å°ç›˜æ—¶é—´)
- [ ] å®ç° `Services/Settings/SettingsService.cs`
- [ ] æŒä¹…åŒ–é…ç½®

âœ… **ä»»åŠ¡9**: å®Œå–„ç®¡ç†åŠŸèƒ½
- [ ] æ‰‹åŠ¨å¼€å¥–
- [ ] æ’¤å•
- [ ] è¡¥å•
- [ ] ä¼šå‘˜ç®¡ç† (æ¸…é›¶ã€åˆ é™¤ã€è®¾ç½®è§’è‰²)

### Phase 4: æµ‹è¯•å’Œä¼˜åŒ– (1-2 å¤©)

âœ… **ä»»åŠ¡10**: é›†æˆæµ‹è¯•
- [ ] å®Œæ•´æµç¨‹æµ‹è¯• (ç™»å½• â†’ å¼€ç›˜ â†’ ä¸‹æ³¨ â†’ å°ç›˜ â†’ å¼€å¥– â†’ ç»“ç®—)
- [ ] è¾¹ç•Œæƒ…å†µæµ‹è¯• (ä½™é¢ä¸è¶³ã€é™é¢è¶…å‡ºã€å·²å°ç›˜ç­‰)
- [ ] å‹åŠ›æµ‹è¯• (å¤§é‡è®¢å•)

âœ… **ä»»åŠ¡11**: æ€§èƒ½ä¼˜åŒ–
- [ ] æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–
- [ ] UI åˆ·æ–°é¢‘ç‡ä¼˜åŒ–
- [ ] å¼‚æ­¥æ“ä½œä¼˜åŒ–

âœ… **ä»»åŠ¡12**: æ–‡æ¡£å’Œéƒ¨ç½²
- [ ] ç”¨æˆ·æ‰‹å†Œ
- [ ] API æ–‡æ¡£
- [ ] éƒ¨ç½²è„šæœ¬

---

## å…³é”®ä»£ç ç¤ºä¾‹

### å¼€å¥–æœåŠ¡æ ¸å¿ƒä»£ç 

```csharp
public class LotteryService : ILotteryService
{
    private System.Threading.Timer _timer;
    private readonly ILotteryWebApi _webApi;
    private readonly ILogService _logService;
    
    private int _currentIssueId;
    private LotteryStatus _currentStatus;
    private int _secondsToSeal;
    
    public event EventHandler<IssueChangedEventArgs> IssueChanged;
    public event EventHandler<StatusChangedEventArgs> StatusChanged;
    public event EventHandler<CountdownEventArgs> CountdownTick;
    public event EventHandler<LotteryOpenedEventArgs> LotteryOpened;
    
    public async Task StartAsync()
    {
        _timer = new System.Threading.Timer(
            callback: async _ => await OnTimerTickAsync(),
            state: null,
            dueTime: TimeSpan.Zero,
            period: TimeSpan.FromSeconds(1)
        );
    }
    
    private async Task OnTimerTickAsync()
    {
        try
        {
            // è·å–æœ€æ–°æ•°æ®
            var data = await _webApi.GetCurrentLotteryDataAsync();
            
            // æ£€æŸ¥æœŸå·å˜æ›´
            if (data.IssueId != _currentIssueId)
            {
                var oldIssueId = _currentIssueId;
                _currentIssueId = data.IssueId;
                
                // è·å–ä¸ŠæœŸå¼€å¥–æ•°æ®
                var lastData = await _webApi.GetLotteryDataAsync(oldIssueId);
                
                // è§¦å‘æœŸå·å˜æ›´äº‹ä»¶
                IssueChanged?.Invoke(this, new IssueChangedEventArgs
                {
                    OldIssueId = oldIssueId,
                    NewIssueId = data.IssueId,
                    LastLotteryData = lastData
                });
                
                // é‡ç½®çŠ¶æ€
                _currentStatus = LotteryStatus.å¼€ç›˜ä¸­;
                StatusChanged?.Invoke(this, new StatusChangedEventArgs
                {
                    OldStatus = LotteryStatus.ç­‰å¾…ä¸­,
                    NewStatus = LotteryStatus.å¼€ç›˜ä¸­,
                    IssueId = data.IssueId
                });
            }
            
            // è®¡ç®—å€’è®¡æ—¶
            _secondsToSeal = CalculateSecondsToSeal(data);
            
            // æ£€æŸ¥å°ç›˜
            if (_secondsToSeal <= 0 && _currentStatus == LotteryStatus.å¼€ç›˜ä¸­)
            {
                _currentStatus = LotteryStatus.å°ç›˜ä¸­;
                StatusChanged?.Invoke(this, new StatusChangedEventArgs
                {
                    OldStatus = LotteryStatus.å¼€ç›˜ä¸­,
                    NewStatus = LotteryStatus.å°ç›˜ä¸­,
                    IssueId = _currentIssueId
                });
            }
            
            // æ£€æŸ¥å¼€å¥–
            if (!string.IsNullOrEmpty(data.NumbersString) && _currentStatus != LotteryStatus.å¼€å¥–ä¸­)
            {
                _currentStatus = LotteryStatus.å¼€å¥–ä¸­;
                LotteryOpened?.Invoke(this, new LotteryOpenedEventArgs
                {
                    LotteryData = data
                });
            }
            
            // è§¦å‘å€’è®¡æ—¶äº‹ä»¶
            CountdownTick?.Invoke(this, new CountdownEventArgs
            {
                Seconds = _secondsToSeal,
                IssueId = _currentIssueId
            });
        }
        catch (Exception ex)
        {
            _logService.Error("LotteryService", "å®šæ—¶å™¨æ‰§è¡Œå¤±è´¥", ex);
        }
    }
    
    private int CalculateSecondsToSeal(BgLotteryData data)
    {
        // æ ¹æ®æœŸå·è®¡ç®—å°ç›˜æ—¶é—´
        // ä¾‹å¦‚ï¼šæ¯æœŸ 5 åˆ†é’Ÿï¼ŒæœŸå·æ ¼å¼ 20251106-001
        // å®ç°é€»è¾‘å‚è€ƒ F5BotV2
        return 300 - (int)(DateTime.Now - data.IssueStartTime).TotalSeconds;
    }
}
```

---

## æ€»ç»“

è¿™ä¸ªæ¶æ„è®¾è®¡éµå¾ªäº†ä»¥ä¸‹åŸåˆ™ï¼š

1. **åˆ†å±‚æ¸…æ™°**ï¼šServices â†’ ViewModels â†’ Views
2. **ä¾èµ–æ³¨å…¥**ï¼šæ‰€æœ‰æœåŠ¡é€šè¿‡ DI å®¹å™¨ç®¡ç†
3. **äº‹ä»¶é©±åŠ¨**ï¼šå¼€å¥–æœåŠ¡é€šè¿‡äº‹ä»¶é€šçŸ¥å…¶ä»–æ¨¡å—
4. **ORM è‡ªåŠ¨åŒ–**ï¼šæ•°æ®åº“æ“ä½œä½¿ç”¨ sqlite-net
5. **å¼‚æ­¥ç¼–ç¨‹**ï¼šæ‰€æœ‰ I/O æ“ä½œä½¿ç”¨ async/await
6. **å•ä¸€èŒè´£**ï¼šæ¯ä¸ªæœåŠ¡åªè´Ÿè´£ä¸€ä¸ªæ ¸å¿ƒåŠŸèƒ½
7. **æ˜“äºæµ‹è¯•**ï¼šæ¥å£æŠ½è±¡ï¼Œæ–¹ä¾¿å•å…ƒæµ‹è¯•
8. **æ˜“äºæ‰©å±•**ï¼šæ–°å¢åŠŸèƒ½åªéœ€æ·»åŠ æ–°æœåŠ¡

**ä¸‹ä¸€æ­¥**ï¼šè¯·æ‚¨ç¡®è®¤æ¶æ„è®¾è®¡ï¼Œæˆ‘å°†å¼€å§‹å®ç° Phase 1 çš„ä»£ç ã€‚

