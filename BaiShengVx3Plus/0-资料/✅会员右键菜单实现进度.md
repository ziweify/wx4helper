# 会员右键菜单实现进度

## ✅ 已完成

### 1. 会员类型枚举更新
- ✅ 添加了"普会"和"黄会"类型
- ✅ 更新了 `OrderType` 枚举：
  ```csharp
  待定 = 0,
  普会 = 1,
  盘内 = 2,  // 会员
  盘外 = 3,  // 蓝会
  托 = 4,
  黄会 = 5
  ```

### 2. UI设计
- ✅ 在 `VxMain.Designer.cs` 中添加了右键菜单 `cmsMembers`
- ✅ 菜单项：
  - 清分 (`tsmiClearBalance`)
  - 删除会员 (`tsmiDeleteMember`)
  - 设置会员类型 (`tsmiSetMemberType`) - 带子菜单
    - 普会
    - 会员（盘内）
    - 托
    - 蓝会（盘外）
    - 黄会
  - 分隔线
  - 资金变动 (`tsmiViewBalanceChange`)

## 🔄 需要实现

### 3. 事件处理程序（VxMain.cs）

#### 3.1 清分功能
```csharp
private void TsmiClearBalance_Click(object sender, EventArgs e)
{
    // 1. 获取选中的会员
    // 2. 确认对话框
    // 3. 记录清分前的余额
    // 4. 清空余额
    // 5. 记录到资金变动表（原因=清分，变动前->变动后=0）
    // 6. 记录日志：UserInfo角色、群、会员、清分前余额
    // 7. 更新数据库和UI
}
```

#### 3.2 删除会员功能（硬删除）
```csharp
private void TsmiDeleteMember_Click(object sender, EventArgs e)
{
    // 1. 获取选中的会员
    // 2. 确认对话框（警告：这是硬删除，不可恢复）
    // 3. 详细日志记录：
    //    - 操作人：UserInfo.Account
    //    - 操作人角色：UserInfo.Role
    //    - 群：GroupWxId
    //    - 被删除会员：Wxid, Nickname, Account
    //    - 会员当前余额
    //    - 会员统计数据（BetTotal, IncomeTotal等）
    // 4. 从数据库物理删除
    // 5. 从 BindingList 移除
    // 6. 更新UI
}
```

#### 3.3 设置会员类型
```csharp
private void TsmiSetMemberType_Click(object sender, EventArgs e)
{
    // 1. 获取选中的会员
    // 2. 根据点击的菜单项确定类型
    //    - tsmiSetNormal -> 普会
    //    - tsmiSetMember -> 盘内
    //    - tsmiSetAgent -> 托
    //    - tsmiSetBlue -> 盘外
    //    - tsmiSetYellow -> 黄会
    // 3. 更新会员的 OrderType
    // 4. 记录日志
    // 5. 更新数据库和UI
}
```

#### 3.4 查看资金变动
```csharp
private void TsmiViewBalanceChange_Click(object sender, EventArgs e)
{
    // 1. 获取选中的会员
    // 2. 创建并显示 BalanceChangeViewerForm
    // 3. 传入会员的 Wxid 作为查询条件
}
```

### 4. 资金变动查看窗口

#### 文件结构
- `Views/BalanceChangeViewerForm.cs`
- `Views/BalanceChangeViewerForm.Designer.cs`

#### 功能
- DataGridView 显示资金变动记录
- 筛选条件：
  - 会员名字（Nickname）
  - 微信ID（Wxid）
  - 时间范围
  - 变动原因
- 排序：默认按时间倒序
- 详细显示：
  - 变动前后余额
  - 变动金额
  - 原因
  - 关联订单信息和时间
  - 期号
  - 备注

### 5. 日志记录要求

删除会员日志格式：
```
操作：删除会员
操作人：admin (管理员)
群：群名称 (wxid_xxx)
被删除会员：
  - 昵称：张三
  - 微信ID：wxid_yyy
  - 账号：account123
  - 当前余额：1250.50
  - 今日下注：150.00
  - 今日盈亏：85.50
  - 总下注：5280.00
  - 总盈亏：450.30
删除时间：2025-11-07 12:34:56
```

清分日志格式：
```
操作：清分
操作人：admin (管理员)
群：群名称 (wxid_xxx)
会员：张三 (wxid_yyy)
清分前余额：1250.50
清分后余额：0.00
清分金额：-1250.50
操作时间：2025-11-07 12:34:56
```

## 📋 下一步工作

1. 在 VxMain.cs 中实现4个事件处理程序
2. 创建 BalanceChangeViewerForm 窗口
3. 测试所有功能
4. 完善日志记录

## 🎯 设计决策

1. **删除方式**：硬删除（物理删除）
   - 理由：有资金变动表可追溯
   - 好处：数据库更干净
   - 风险：详细日志记录降低风险

2. **资金变动表设计**：
   - 冗余记录订单ID、订单信息、订单时间
   - 支持按会员名字和Wxid查询
   - 所有金额变动都记录

3. **会员类型**：5种类型
   - 普会、盘内（会员）、盘外（蓝会）、托、黄会

