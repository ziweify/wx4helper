# 投注失败 - "未连接到浏览器" - 排查步骤

## ❌ 错误现象

```
✅ 执行结果:成功=False
   消息:未连接到浏览器
   错误信息:未连接到浏览器
```

---

## 🔍 排查步骤

### 步骤 1：检查浏览器是否启动

**操作**：
1. 打开 **任务管理器** (`Ctrl + Shift + Esc`)
2. 查看 **进程** 选项卡
3. 搜索 `BsBrowserClient.exe`

**预期结果**：
- ✅ 应该看到 `BsBrowserClient.exe` 进程
- ✅ 浏览器窗口应该可见，标题为 `BsBrowser-默认配置`

**如果没有看到**：
- ❌ 浏览器没有启动
- 原因：可能是 `飞单开关` 没有打开，或者启动失败
- 解决：打开 `配置/高级设置`，点击 `启动浏览器`

---

### 步骤 2：检查浏览器连接状态

**操作**：
1. 打开 **高级设置** (`配置` 按钮 → `高级设置`)
2. 查看 **连接状态**

**预期结果**：
- ✅ 应该显示 `已连接` 或类似的绿色状态
- ✅ 配置信息应该正确显示

**如果显示"未连接"**：
- ❌ 浏览器启动了，但 Socket 连接失败
- 原因：可能是端口冲突、Socket 服务未启动、或连接超时
- 解决：关闭浏览器，重启主程序

---

### 步骤 3：检查日志中的连接信息

**操作**：
1. 打开 **日志** 窗口
2. 搜索关键字：`BrowserClient`、`AttachConnection`、`IsConnected`

**预期日志**：
```
[BrowserClient] AttachConnection 调用:
  - ConfigId: 1
  - 传入的 connection == null: False
  - 传入的 connection.IsConnected: True
[BrowserClient] AttachConnection 完成:
  - _connection == null: False
  - _connection.IsConnected: True
  - IsConnected: True
```

**如果看到 `IsConnected: False`**：
- ❌ 连接对象为空或连接已断开
- 原因：
  1. `_connection` 为 `null` - 从未建立连接
  2. `_connection.IsConnected` 为 `false` - 连接已断开
- 解决：查看步骤 4

---

### 步骤 4：检查 `AutoBetSocketServer` 连接日志

**操作**：
1. 在日志中搜索：`OnBrowserConnected`、`Socket连接`

**预期日志**：
```
[AutoBetSocketServer] 浏览器已连接: ConfigName=默认配置, BrowserConfigId=xxx
[AutoBet] ✅ 浏览器连接成功: ConfigName=默认配置
[AutoBet] ✅ BrowserClient 已创建并附加连接
```

**如果没有看到这些日志**：
- ❌ Socket 服务器没有收到浏览器的连接请求
- 原因：
  1. Socket 服务器未启动（端口未监听）
  2. 浏览器的 Socket 客户端未启动
  3. 端口号不匹配
- 解决：查看步骤 5

---

### 步骤 5：检查 Socket 端口

**操作**：
1. 在日志中搜索：`Socket服务器已启动`、`端口`

**预期日志**：
```
[AutoBet] ✅ Socket服务器已启动，端口: 5555
```

2. 在浏览器窗口中，查看 **端口信息**

**预期**：
- 浏览器显示的端口应该与主程序一致（例如 `5555`）

**如果端口不一致**：
- ❌ 浏览器连接到了错误的端口
- 解决：关闭浏览器和主程序，重新启动

---

### 步骤 6：检查投注命令发送日志

**操作**：
1. 在日志中搜索：`SendBetCommandAsync`、`SendCommandAsync`

**预期日志**：
```
[AutoBet] 📤 尝试发送投注命令: configId=1
[AutoBet]    当前 _browsers 字典包含的 configId: [1]
[AutoBet] ✅ 找到浏览器客户端: configId=1
[AutoBet]    BrowserClient.IsConnected: True
[BrowserClient] SendCommandAsync 调用:
  - ConfigId: 1
  - _connection == null: False
  - _connection?.IsConnected: True
  - IsConnected: True
```

**如果看到 `IsConnected: False`**：
- ❌ 在发送命令时，连接状态为 `false`
- 原因：
  1. 连接在发送命令前断开了
  2. `_connection` 对象状态不正确
- 解决：查看步骤 7

---

### 步骤 7：检查 `ClientConnection.IsConnected`

`ClientConnection` 是 `AutoBetSocketServer` 中管理单个浏览器连接的对象。

**操作**：
1. 检查 `AutoBetSocketServer.ClientConnection` 的实现
2. 确认 `IsConnected` 属性的实现是否正确

**可能的问题**：
- `TcpClient.Connected` 不能准确反映连接状态
- Socket 在读取/写入时已经断开，但 `Connected` 仍为 `true`

**解决方案**：
在 `ClientConnection` 中添加心跳检测：
```csharp
public bool IsConnected
{
    get
    {
        try
        {
            return _client != null 
                && _client.Connected 
                && _client.Client.Poll(0, SelectMode.SelectRead) && !(_client.Available == 0);
        }
        catch
        {
            return false;
        }
    }
}
```

---

## 🎯 常见场景和解决方案

### 场景 1：首次启动，飞单开关关闭

**现象**：
- 浏览器没有启动
- 投注失败："未连接到浏览器"

**解决**：
1. 打开 `飞单开关`
2. 等待浏览器自动启动（2-3 秒）
3. 浏览器窗口出现后，登录平台
4. 确认高级设置中显示 `已连接`
5. 重新投注

---

### 场景 2：浏览器启动了，但连接失败

**现象**：
- 浏览器窗口可见
- 高级设置显示 `未连接`
- 投注失败："未连接到浏览器"

**解决**：
1. 关闭浏览器窗口
2. 关闭 `飞单开关`
3. 等待 2 秒
4. 重新打开 `飞单开关`
5. 等待浏览器重新启动并连接

---

### 场景 3：浏览器连接后又断开

**现象**：
- 浏览器窗口仍在
- 高级设置显示 `已连接`，但投注时报错
- 日志显示 `IsConnected: False`

**解决**：
1. 检查网络连接
2. 检查是否有防火墙/杀毒软件阻止 Socket 连接
3. 关闭并重新启动主程序和浏览器

---

### 场景 4：主程序重启后，旧浏览器未连接

**现象**：
- 关闭主程序前，浏览器在运行
- 重新启动主程序后，旧浏览器仍在运行
- 但投注失败："未连接到浏览器"

**解决**：
1. 关闭所有 `BsBrowserClient.exe` 进程
2. 关闭主程序
3. 重新启动主程序
4. 打开 `飞单开关`
5. 等待浏览器启动并连接

---

## 📋 诊断命令清单

在 **高级设置** 中，依次测试以下命令：

### 1. 测试连接
```
命令类型: Ping
预期结果: 成功
```

### 2. 测试投注
```
命令类型: 投注
投注内容: 1大10
预期结果: 成功（或返回平台错误，但不是"未连接"）
```

### 3. 查看日志
```
日志窗口 → 搜索 "IsConnected"
预期: 应该看到多个 "IsConnected: True"
```

---

## 🛠️ 如果以上步骤都无法解决

请提供以下信息：

1. **完整的日志文件**（从启动到投注失败）
2. **任务管理器截图**（显示 BsBrowserClient 进程）
3. **高级设置截图**（显示连接状态）
4. **浏览器窗口截图**（显示标题和内容）

这样我才能准确定位问题！

