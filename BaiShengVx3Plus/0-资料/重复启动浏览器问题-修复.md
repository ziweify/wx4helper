# 重复启动浏览器问题 - 修复

## 📋 问题描述

用户反馈：**启动程序后，弹出2个浏览器窗口，但配置只有1个。**

---

## 🔍 问题分析

### 启动流程追踪

```
程序启动
  ↓
LoadAppConfiguration()
  ├─ 读取配置：isAutoBetEnabled = true
  ├─ 设置 UI: swiAutoOrdersBet.Active = true (此时事件已解绑，不触发)
  ├─ 重新绑定事件
  └─ 发现飞单开启，延迟2秒后手动触发 swiAutoOrdersBet_ValueChanged
       ↓
      【第1次调用】swiAutoOrdersBet_ValueChanged 被触发
       ↓
       └─ _autoBetCoordinator.StartAsync(defaultConfig.Id)
            ↓
            ├─ 调用 _autoBetService.StartBrowser(configId)
            │    ├─ config.IsEnabled = true  ← 设置为启用
            │    └─ 等待3秒浏览器连接
            │
            └─ 同时，监控任务正在运行（每3秒检查一次）
                 ↓
                【监控任务检测】发现 config.IsEnabled = true 且未连接
                 ├─ 等待2秒（给老浏览器重连机会）
                 ├─ 2秒后再次检查，仍未连接
                 └─ 启动浏览器 ← 第2个浏览器！
```

### 根本原因

**时序冲突**：

1. `AutoBetCoordinator.StartAsync` 调用 `StartBrowser`
2. `StartBrowser` 内部设置 `config.IsEnabled = true`
3. 监控任务检测到 `IsEnabled = true`，2秒后启动浏览器
4. `StartBrowser` 等待3秒超时返回
5. **结果：2个地方都启动了浏览器！**

---

## ✅ 解决方案

### 1️⃣ 修改 `StartBrowser` - 不修改 `IsEnabled`

```csharp
// 旧代码（❌ 错误）
public async Task<bool> StartBrowser(int configId)
{
    var config = GetConfig(configId);
    
    // ❌ 问题：这里修改 IsEnabled，触发监控任务
    if (!config.IsEnabled)
    {
        config.IsEnabled = true;  // 触发 PropertyChanged
    }
    
    // 等待浏览器连接（3秒）
    // ...
}

// 新代码（✅ 正确）
public async Task<bool> StartBrowser(int configId)
{
    var config = GetConfig(configId);
    
    // ✅ 只负责等待连接，不修改 IsEnabled
    _log.Info("AutoBet", $"当前 IsEnabled 状态: {config.IsEnabled}");
    
    // 检查是否已连接
    if (_browsers.ContainsKey(configId))
    {
        return true;  // 已连接
    }
    
    // 等待浏览器连接（3秒）
    // ...
}
```

### 2️⃣ 修改 `AutoBetCoordinator.StartAsync` - 先设置 `IsEnabled`

```csharp
public async Task<bool> StartAsync(int configId)
{
    _log.Info("AutoBet", $"🚀 启动自动投注，配置ID: {configId}");
    
    // ✅ 1. 先设置 IsEnabled = true（触发监控任务）
    var config = _autoBetService.GetConfig(configId);
    if (!config.IsEnabled)
    {
        _log.Info("AutoBet", $"📌 设置配置 [{config.ConfigName}] 为启用状态");
        config.IsEnabled = true;  // PropertyChanged 自动保存，监控任务会看到
    }
    
    // ✅ 2. 等待浏览器连接（最多3秒）
    //    - 如果已有老浏览器，会在1-2秒内重连
    //    - 如果没有，监控任务会在2秒后启动新浏览器
    var success = await _autoBetService.StartBrowser(configId);
    if (!success)
    {
        _log.Error("AutoBet", "启动浏览器失败");
        return false;
    }
    
    // 3. 订阅开奖事件
    _lotteryService.IssueChanged += LotteryService_IssueChanged;
    _lotteryService.StatusChanged += LotteryService_StatusChanged;
    
    _isAutoBetEnabled = true;
    return true;
}
```

### 3️⃣ 监控任务增加"正在启动"检查

```csharp
// 🔥 记录正在启动的配置（防止重复启动）
private readonly HashSet<int> _startingConfigs = new();

private void MonitorBrowsers(object? state)
{
    foreach (var config in enabledConfigs)
    {
        // 检查是否已连接
        if (_browsers.ContainsKey(config.Id))
        {
            continue;
        }
        
        // 🔥 检查是否正在启动（防止重复启动）
        lock (_lock)
        {
            if (_startingConfigs.Contains(config.Id))
            {
                _log.Debug("AutoBet", $"⏳ 配置 [{config.ConfigName}] 正在启动中，跳过");
                continue;
            }
        }
        
        // 未连接，准备启动浏览器
        _ = Task.Run(async () =>
        {
            try
            {
                // 🔥 标记为正在启动
                lock (_lock)
                {
                    _startingConfigs.Add(configId);
                }
                
                // 等待2秒，给浏览器重连的机会
                await Task.Delay(2000);
                
                // 重新检查连接状态
                if (!_browsers.ContainsKey(configId))
                {
                    await StartBrowserInternal(configId);
                }
            }
            finally
            {
                // 🔥 移除启动标记
                lock (_lock)
                {
                    _startingConfigs.Remove(configId);
                }
            }
        });
    }
}
```

---

## 🎯 修复后的流程

### 正常启动流程（首次启动）

```
程序启动
  ↓
LoadAppConfiguration()
  ↓
延迟2秒后触发 swiAutoOrdersBet_ValueChanged
  ↓
AutoBetCoordinator.StartAsync(configId)
  ├─ config.IsEnabled = true  ← 设置为启用
  └─ StartBrowser(configId)
       ├─ 检查是否已连接：否
       └─ 等待3秒...
            ↓
           【同时】监控任务检测到 IsEnabled=true，未连接
            ├─ 检查是否正在启动：否
            ├─ 标记为正在启动 (_startingConfigs.Add)
            ├─ 等待2秒...
            ├─ 2秒后检查，仍未连接
            └─ 启动浏览器进程 ← 只启动1个！
                 ↓
                浏览器连接成功
                 ↓
           【3秒内】StartBrowser 检测到连接
            └─ 返回 true ← 成功！
```

### 重启流程（老浏览器存在）

```
程序重启（浏览器未关闭）
  ↓
LoadAppConfiguration()
  ↓
延迟2秒后触发 swiAutoOrdersBet_ValueChanged
  ↓
AutoBetCoordinator.StartAsync(configId)
  ├─ config.IsEnabled = true  ← 已经是 true
  └─ StartBrowser(configId)
       ├─ 检查是否已连接：否（老浏览器还在重连中）
       └─ 等待3秒...
            ↓
           【同时】老浏览器在1秒内重连成功
            └─ _browsers[configId] = browserClient
                 ↓
           【1秒后】StartBrowser 检测到连接
            └─ 返回 true ← 成功！
            
           【同时】监控任务检测到 IsEnabled=true
            ├─ 检查是否已连接：是 ← 老浏览器已连接
            └─ 跳过 ← 不启动新浏览器
```

---

## 📊 对比表

| 场景 | 修复前 | 修复后 |
|------|--------|--------|
| **首次启动** | 启动2个浏览器 | 只启动1个浏览器 |
| **主程序重启（浏览器存在）** | 老浏览器连接 + 启动新浏览器 | 只连接老浏览器 |
| **监控任务检测** | 立即启动，不检查"正在启动" | 检查"正在启动"，避免重复 |

---

## 📝 修改文件清单

### 修改文件

1. **`BaiShengVx3Plus/Services/AutoBet/AutoBetService.cs`**
   - 移除 `_enabledConfigs` 集合
   - 添加 `_startingConfigs` 集合（记录正在启动的配置）
   - 修改 `StartBrowser` - 不再修改 `IsEnabled`，只负责等待连接
   - 修改 `MonitorBrowsers` - 检查"正在启动"状态，防止重复启动

2. **`BaiShengVx3Plus/Services/AutoBet/AutoBetCoordinator.cs`**
   - 修改 `StartAsync` - 先设置 `IsEnabled = true`，再调用 `StartBrowser`

---

## ✅ 修复效果

### 修复前的问题：
❌ 启动程序后，弹出2个浏览器窗口  
❌ 监控任务和 `StartBrowser` 同时启动浏览器  
❌ 浪费资源，用户体验差  

### 修复后：
✅ 启动程序后，只启动1个浏览器  
✅ 监控任务检查"正在启动"状态，避免重复  
✅ `StartBrowser` 只负责等待连接，不修改 `IsEnabled`  
✅ 职责清晰，逻辑简洁  

---

## 🎯 总结

### 核心问题
**时序冲突**：`StartBrowser` 内部修改 `IsEnabled`，触发监控任务启动浏览器，导致重复启动。

### 核心解决
1. **职责分离**：
   - `StartBrowser` 只负责**等待连接**
   - 调用者负责设置 `IsEnabled`
   - 监控任务负责**启动浏览器**

2. **防重复启动**：
   - 使用 `_startingConfigs` 记录正在启动的配置
   - 监控任务检查此集合，避免重复启动

3. **时序协调**：
   - 监控任务等待2秒（给老浏览器重连）
   - `StartBrowser` 等待3秒（确保浏览器连接）
   - 时序错开，避免冲突

**完全符合用户的新设计方案！🎯**

