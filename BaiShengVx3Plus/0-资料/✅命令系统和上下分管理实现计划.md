# 命令系统和上下分管理实现计划

## 📋 待实现功能清单

### 1. 会员命令

#### 1.1 查询命令 ⏳
**命令格式**：`查` / `流水` / `货单`

**功能**：查询会员当日统计信息

**回复格式**（参考 F5BotV2）：
```
@张三
流~~记录
今日/本轮进货:150.00/50.00
今日上/下:1000.00/500.00
今日盈亏:85.50
```

**字段说明**：
- 今日进货：`member.BetToday`
- 本轮进货：`member.BetCur`
- 今日上：`member.CreditToday`
- 今日下：`member.WithdrawToday`
- 今日盈亏：`member.IncomeToday`

**实现位置**：`BinggoMessageHandler.cs`

#### 1.2 上分命令 ❌
**命令格式**：`上` / `上1000` / `上分1000`

**功能**：会员申请上分

**处理流程**：
1. 解析金额
2. 创建上分申请记录（`V2CreditWithdraw`）
3. 状态设为 `Pending`（等待处理）
4. 通知管理员

**回复格式**：
```
@张三
上分申请已提交
金额：1000.00
请等待管理员处理
```

**实现位置**：`BinggoMessageHandler.cs`

#### 1.3 下分命令 ❌
**命令格式**：`下` / `下500` / `下分500`

**功能**：会员申请下分

**处理流程**：
1. 解析金额
2. 检查余额是否足够
3. 创建下分申请记录（`V2CreditWithdraw`）
4. 状态设为 `Pending`（等待处理）
5. 通知管理员

**回复格式**：
```
@张三
下分申请已提交
金额：500.00
当前余额：1250.00
请等待管理员处理
```

**实现位置**：`BinggoMessageHandler.cs`

### 2. 管理命令

#### 2.1 封盘命令 ❌
**命令格式**：`封` / `封盘`

**功能**：立即封盘，停止接受下注

**回复格式**：
```
封盘成功
期号：114062936
```

#### 2.2 开盘命令 ❌
**命令格式**：`开` / `开盘`

**功能**：立即开盘，允许下注

#### 2.3 补单命令 ❌
**命令格式**：`补单 @会员 期号 内容 金额`

**示例**：`补单 @张三 114062935 123大 10`

**功能**：为会员补一个历史订单

### 3. 上下分管理窗口 ❌

#### 3.1 UI设计

**窗口名称**：`CreditWithdrawManageForm`

**布局**：
```
┌─────────────────────────────────────────────────┐
│  上下分管理                            [X]       │
├─────────────────────────────────────────────────┤
│  筛选: [全部状态 ▼] [刷新]  统计: 待处理 0 笔   │
├─────────────────────────────────────────────────┤
│  ID | 时间 | 昵称 | 动作 | 金额 | 状态 | 操作   │
│  1  | 10:30 | 张三 | 上分 | 1000 | 待处理 | [同意][拒绝] │
│  2  | 10:35 | 李四 | 下分 | 500  | 待处理 | [同意][拒绝] │
│  3  | 10:40 | 王五 | 上分 | 2000 | 已同意 |      │
├─────────────────────────────────────────────────┤
│  说明: 同意后会自动更新会员余额并记录到资金变动表 │
└─────────────────────────────────────────────────┘
```

#### 3.2 功能列表

**数据显示**：
- ID：申请ID
- 时间：申请时间（HH:mm:ss）
- 昵称：会员昵称
- 动作：上分/下分
- 金额：申请金额
- 状态：等待处理/已同意/已拒绝
- 操作：[同意] [拒绝] 按钮

**筛选功能**：
- 全部状态
- 等待处理
- 已同意
- 已拒绝

**统计信息**：
- 待处理笔数
- 待处理总金额
- 今日上分总额
- 今日下分总额

#### 3.3 数据模型

**V2CreditWithdraw** (已存在，需完善)：
```csharp
public class V2CreditWithdraw
{
    public long Id { get; set; }
    public string GroupWxId { get; set; }
    public string? Wxid { get; set; }
    public string? Nickname { get; set; }
    public float Amount { get; set; }
    public CreditWithdrawAction Action { get; set; }  // 上分/下分
    public CreditWithdrawStatus Status { get; set; }  // 等待/同意/拒绝
    public string TimeString { get; set; }
    public long Timestamp { get; set; }
    public string? Notes { get; set; }
    public string? ProcessedBy { get; set; }  // 🔥 新增：处理人
    public string? ProcessedTime { get; set; }  // 🔥 新增：处理时间
}

public enum CreditWithdrawAction { 未知 = 0, 上分 = 1, 下分 = 2 }
public enum CreditWithdrawStatus { 等待处理 = 0, 已同意 = 1, 已拒绝 = 2 }
```

#### 3.4 处理流程

**同意上分**：
1. 更新申请状态为"已同意"
2. 增加会员余额 `member.Balance += amount`
3. 更新 `member.CreditToday`、`member.CreditTotal`
4. 记录到资金变动表 `V2BalanceChange`：
   - `Reason = ChangeReason.上分`
   - `BalanceBefore` = 原余额
   - `BalanceAfter` = 新余额
   - `ChangeAmount` = +金额
   - `Notes` = "管理员同意上分申请"
5. 保存到数据库
6. 发送微信通知会员

**同意下分**：
1. 检查余额是否足够
2. 更新申请状态为"已同意"
3. 减少会员余额 `member.Balance -= amount`
4. 更新 `member.WithdrawToday`、`member.WithdrawTotal`
5. 记录到资金变动表 `V2BalanceChange`：
   - `Reason = ChangeReason.下分`
   - `BalanceBefore` = 原余额
   - `BalanceAfter` = 新余额
   - `ChangeAmount` = -金额
   - `Notes` = "管理员同意下分申请"
6. 保存到数据库
7. 发送微信通知会员

**拒绝申请**：
1. 更新申请状态为"已拒绝"
2. 记录拒绝原因（可选）
3. 发送微信通知会员

**微信通知格式**：
```
@张三
上分申请已通过
金额：1000.00
当前余额：2250.00
```

### 4. 资金变动记录集成

所有涉及余额变动的操作都必须记录到 `V2BalanceChange` 表：

| 操作 | ChangeReason | 实现状态 |
|------|--------------|----------|
| 下注 | 下注 | ⏳ 待集成 |
| 订单结算 | 订单结算 | ⏳ 待集成 |
| 订单取消 | 订单取消 | ❌ 未实现 |
| 上分 | 上分 | ❌ 未实现 |
| 下分 | 下分 | ❌ 未实现 |
| 清分 | 手动调整 | ✅ 已实现 |
| 清空数据 | 清空数据 | ✅ 已实现 |
| 补单 | 补单 | ❌ 未实现 |

## 📝 实现步骤

### 阶段1：命令系统完善（高优先级）

1. ✅ 在 `BinggoMessageHandler.cs` 中实现"查"命令
2. ✅ 实现"上分"命令（创建申请）
3. ✅ 实现"下分"命令（创建申请）
4. ❌ 实现"封盘"命令（管理员）
5. ❌ 实现"开盘"命令（管理员）
6. ❌ 实现"补单"命令（管理员）

### 阶段2：上下分管理窗口（高优先级）

1. ❌ 创建 `CreditWithdrawManageForm.cs` 和 `.Designer.cs`
2. ❌ 设计UI布局（DataGridView + 按钮）
3. ❌ 实现数据加载和筛选功能
4. ❌ 实现"同意"按钮逻辑
5. ❌ 实现"拒绝"按钮逻辑
6. ❌ 集成到 `VxMain.cs`（在开奖结果旁边添加按钮）

### 阶段3：资金变动记录集成（中优先级）

1. ❌ 在 `BinggoOrderService.CreateOrderAsync` 中记录下注
2. ❌ 在 `BinggoOrderService.SettleSingleOrderAsync` 中记录结算
3. ❌ 实现订单取消功能并记录
4. ❌ 在上下分处理中记录
5. ❌ 在补单功能中记录

### 阶段4：统计数据完善（低优先级）

1. ❌ 确保所有会员统计字段正确更新
2. ❌ 添加统计数据验证功能
3. ❌ 添加数据修复工具（如果数据不一致）

## 🔧 技术实现细节

### 命令解析

**上分命令**：
```csharp
// 支持格式：上、上1000、上分1000
if (Regex.IsMatch(message, @"^上(分)?(\d+)?$"))
{
    var match = Regex.Match(message, @"^上(分)?(\d+)?$");
    if (match.Groups[2].Success)
    {
        float amount = float.Parse(match.Groups[2].Value);
        // 处理上分申请
    }
    else
    {
        // 提示输入金额
        return "请输入上分金额，例如：上1000";
    }
}
```

**下分命令**：
```csharp
// 支持格式：下、下500、下分500
if (Regex.IsMatch(message, @"^下(分)?(\d+)?$"))
{
    var match = Regex.Match(message, @"^下(分)?(\d+)?$");
    if (match.Groups[2].Success)
    {
        float amount = float.Parse(match.Groups[2].Value);
        // 检查余额
        if (member.Balance < amount)
        {
            return $"余额不足！当前余额：{member.Balance:F2}";
        }
        // 处理下分申请
    }
    else
    {
        // 提示输入金额
        return "请输入下分金额，例如：下500";
    }
}
```

### 上下分处理服务

**ICreditWithdrawService** (新建)：
```csharp
public interface ICreditWithdrawService
{
    /// <summary>
    /// 创建上分申请
    /// </summary>
    Task<(bool success, string message)> CreateCreditRequestAsync(V2Member member, float amount);
    
    /// <summary>
    /// 创建下分申请
    /// </summary>
    Task<(bool success, string message)> CreateWithdrawRequestAsync(V2Member member, float amount);
    
    /// <summary>
    /// 同意申请
    /// </summary>
    Task<(bool success, string message)> ApproveRequestAsync(long requestId, string processedBy);
    
    /// <summary>
    /// 拒绝申请
    /// </summary>
    Task<(bool success, string message)> RejectRequestAsync(long requestId, string reason, string processedBy);
    
    /// <summary>
    /// 获取所有申请
    /// </summary>
    List<V2CreditWithdraw> GetAllRequests();
    
    /// <summary>
    /// 获取待处理申请
    /// </summary>
    List<V2CreditWithdraw> GetPendingRequests();
}
```

## 📊 数据库表初始化

在 `VxMain.InitializeDatabase()` 中添加：
```csharp
_db.CreateTable<V2BalanceChange>();  // 资金变动表（已添加）
_db.CreateTable<V2CreditWithdraw>(); // 上下分申请表（需添加）
```

## 🎯 预期效果

### 会员使用场景

**场景1：会员查询**
```
会员：查
系统：@张三
      流~~记录
      今日/本轮进货:150.00/50.00
      今日上/下:1000.00/500.00
      今日盈亏:85.50
```

**场景2：会员上分**
```
会员：上1000
系统：@张三
      上分申请已提交
      金额：1000.00
      请等待管理员处理

[管理员在上下分管理窗口点击"同意"]

系统：@张三
      上分申请已通过
      金额：1000.00
      当前余额：2250.00
```

**场景3：会员下分**
```
会员：下500
系统：@张三
      下分申请已提交
      金额：500.00
      当前余额：2250.00
      请等待管理员处理

[管理员在上下分管理窗口点击"同意"]

系统：@张三
      下分申请已通过
      金额：500.00
      当前余额：1750.00
```

### 管理员使用场景

**场景1：处理上下分申请**
1. 点击"上下分管理"按钮
2. 查看待处理列表
3. 点击"同意"或"拒绝"
4. 系统自动：
   - 更新会员余额
   - 记录资金变动
   - 发送微信通知
   - 更新统计数据

**场景2：查看资金变动记录**
1. 右键会员 → "资金变动"
2. 查看所有上下分记录
3. 筛选"上分"或"下分"
4. 核对金额和时间

## ⚠️ 注意事项

1. **余额检查**：下分时必须检查余额是否足够
2. **并发控制**：同一申请不能被多次处理
3. **数据一致性**：余额变动、统计更新、资金记录必须在同一事务中
4. **通知可靠性**：微信通知失败时应有日志记录
5. **权限控制**：只有管理员可以处理上下分申请
6. **审计日志**：所有操作都应详细记录操作人和时间

## 📅 时间估算

| 任务 | 预计时间 | 复杂度 |
|------|---------|--------|
| 查询命令 | 30分钟 | 低 |
| 上下分命令 | 1小时 | 中 |
| 上下分管理窗口 | 2小时 | 中 |
| 资金变动集成 | 1小时 | 中 |
| 测试和调试 | 1小时 | - |
| **总计** | **5.5小时** | - |

## ✅ 完成标准

1. 所有命令可以正常解析和回复
2. 上下分申请可以正常创建
3. 管理员可以同意/拒绝申请
4. 会员余额正确更新
5. 资金变动记录完整
6. 统计数据准确
7. 微信通知正常发送
8. 所有操作有详细日志

