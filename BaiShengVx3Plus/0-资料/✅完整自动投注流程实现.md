# ✅ 完整自动投注流程实现

## 📅 完成时间

2025-11-07

## 🎯 实现的功能

### 1. 自动登录流程 ✅

#### 实现位置
- **文件**: `BsBrowserClient/Form1.cs` → `TryAutoLoginAsync()`
- **文件**: `BsBrowserClient/PlatformScripts/YunDing28Script.cs` → `LoginAsync()`

#### 流程说明

```
用户点击"启动浏览器"
  ↓
VxMain 启动 BsBrowserClient.exe
  ↓
BsBrowserClient 初始化 WebView2
  ↓
导航到平台URL（如 https://yd28.vip）
  ↓
NavigationCompleted 事件触发
  ↓
TryAutoLoginAsync() 被调用
  ↓
通过 HTTP API 获取账号密码
  GET http://127.0.0.1:8888/api/config?configId=1
  ↓
调用平台脚本 LoginAsync(username, password)
  ↓
智能检测页面状态（login/home/game/agreement/notice）
  ↓
自动填充表单并点击登录按钮
  ↓
处理协议页面、公告弹窗等
  ↓
检测到已登录状态（home/game）
  ↓
通过 Socket 通知 VxMain 登录成功
  { type: "login_success", configId, username, timestamp }
```

#### 关键代码

**BsBrowserClient/Form1.cs**:
```csharp
// 绑定导航完成事件
_webView.CoreWebView2.NavigationCompleted += async (s, e) =>
{
    if (e.IsSuccess)
    {
        lblStatus.Text = "✅ 页面加载完成";
        OnLogMessage($"✅ 页面加载完成: {_webView.CoreWebView2.Source}");
        
        // ✅ 触发自动登录
        await TryAutoLoginAsync();
    }
};

private async Task TryAutoLoginAsync()
{
    // 1. 获取配置（账号密码）
    var httpClient = new System.Net.Http.HttpClient();
    var response = await httpClient.GetAsync($"http://127.0.0.1:8888/api/config?configId={_configId}");
    var json = await response.Content.ReadAsStringAsync();
    var config = JObject.Parse(json);
    var username = config["data"]?["Username"]?.ToString() ?? "";
    var password = config["data"]?["Password"]?.ToString() ?? "";
    
    // 2. 调用平台脚本登录
    var success = await _platformScript.LoginAsync(username, password);
    
    // 3. 通知VxMain登录成功
    if (success)
    {
        await _socketServer.SendToVxMain(new
        {
            type = "login_success",
            configId = _configId,
            username = username
        });
    }
}
```

**BsBrowserClient/PlatformScripts/YunDing28Script.cs**:
```csharp
public async Task<bool> LoginAsync(string username, string password)
{
    var maxAttempts = 60; // 最多等待60秒
    var attempt = 0;
    
    while (attempt < maxAttempts && !_isLoggedIn)
    {
        await Task.Delay(1000);
        
        // 检测页面状态
        var pageState = await DetectPageStateAsync();
        
        switch (pageState)
        {
            case "login":
                await AutoFillLoginFormAsync(username, password);
                break;
            case "home":
            case "game":
                _isLoggedIn = true;
                return true;
            case "agreement":
                await AutoAgreeAgreementAsync();
                break;
            case "notice":
                await AutoCloseNoticeAsync();
                break;
        }
    }
    
    return _isLoggedIn;
}
```

### 2. 两个控制开关 ✅

#### swi_OrdersTasking（收单开关）

**位置**: VxMain 快速设置面板

**功能**: 控制是否接收微信消息并处理投注

**实现**:
```csharp
// VxMain.cs
private void swi_OrdersTasking_ValueChanged(object? sender, bool value)
{
    // 更新消息处理器的全局开关
    Services.Messages.Handlers.BinggoMessageHandler.IsOrdersTaskingEnabled = value;
    
    if (value)
    {
        _logService.Info("VxMain", "✅ 订单任务已启用（收单中）");
    }
    else
    {
        _logService.Info("VxMain", "⏹️ 订单任务已禁用（收单停）");
    }
    
    // 保存到设置
    SaveSwitchSettings();
}

// BinggoMessageHandler.cs
public static bool IsOrdersTaskingEnabled { get; set; } = true;

public async Task<(bool handled, string? replyMessage)> HandleMessageAsync(
    V2Member member, string messageContent)
{
    // 检查收单开关
    if (!IsOrdersTaskingEnabled)
    {
        _logService.Info("MessageHandler", "⏸️ 收单已关闭，忽略消息");
        return (false, null);
    }
    
    // ... 处理投注消息
}
```

**状态保存**: 
- 保存到 `AppSettings` 表
- Key: `OrdersTasking`
- Value: `"1"` (开启) 或 `"0"` (关闭)

#### swiAutoOrdersBet（自动投注/飞单开关）

**位置**: VxMain 快速设置面板

**功能**: 控制是否启用自动投注功能

**实现**:
```csharp
// VxMain.cs
private async void swiAutoOrdersBet_ValueChanged(object? sender, bool value)
{
    if (value) // 开启自动投注
    {
        SaveAutoBetSettings(); // 先保存设置
        
        var defaultConfig = _autoBetService.GetConfigs().FirstOrDefault(c => c.IsDefault);
        var success = await _autoBetCoordinator.StartAsync(defaultConfig.Id);
        
        if (success)
        {
            _logService.Info("VxMain", "✅ 自动投注已启动");
            this.ShowSuccessTip("自动投注（飞单）已启动！");
        }
    }
    else // 停止自动投注
    {
        _autoBetCoordinator.Stop();
    }
    
    // 保存到设置
    SaveSwitchSettings();
}
```

**状态保存**: 
- 保存到 `AppSettings` 表
- Key: `AutoOrdersBet`
- Value: `"1"` (开启) 或 `"0"` (关闭)

### 3. 设置持久化 ✅

#### 开关状态保存/加载

```csharp
// 保存开关状态
private void SaveSwitchSettings()
{
    _db.Execute("INSERT OR REPLACE INTO AppSettings (Key, Value) VALUES (?, ?)", 
        "AutoOrdersBet", swiAutoOrdersBet.Active ? "1" : "0");
    
    _db.Execute("INSERT OR REPLACE INTO AppSettings (Key, Value) VALUES (?, ?)", 
        "OrdersTasking", swi_OrdersTasking.Active ? "1" : "0");
}

// 加载开关状态
private void LoadSwitchSettings()
{
    var autoBetValue = _db.ExecuteScalar<string>(
        "SELECT Value FROM AppSettings WHERE Key = ?", "AutoOrdersBet");
    var ordersTaskingValue = _db.ExecuteScalar<string>(
        "SELECT Value FROM AppSettings WHERE Key = ?", "OrdersTasking");
    
    swiAutoOrdersBet.Active = autoBetValue == "1";
    swi_OrdersTasking.Active = ordersTaskingValue == "1";
    
    // 同步到消息处理器
    BinggoMessageHandler.IsOrdersTaskingEnabled = swi_OrdersTasking.Active;
}
```

#### 调用时机

```csharp
// VxMain.cs - InitializeBinggoServices()
_autoBetService.SetDatabase(_db);
LoadAutoBetSettings();  // 加载自动投注配置
LoadSwitchSettings();   // ✅ 加载开关状态
```

## 🔄 完整流程演示

### 场景1：用户手动投注（收单模式）

```
1. 用户打开 VxMain
   ↓
2. 打开 swi_OrdersTasking 开关（收单中）
   ↓
3. 微信用户发送：大 10
   ↓
4. BinggoMessageHandler 检查 IsOrdersTaskingEnabled = true
   ↓
5. 解析投注内容，创建订单
   ↓
6. 回复：✅ 投注成功！订单号: xxx
```

### 场景2：自动投注（飞单模式）

```
1. 用户配置默认投注账号（快速设置面板）
   - 盘口：云顶
   - 账号：test123
   - 密码：******
   ↓
2. 点击"启动浏览器"
   ↓
3. BsBrowserClient 启动并加载 https://yd28.vip
   ↓
4. 页面加载完成 → 自动登录
   - 检测页面状态
   - 自动填充账号密码
   - 点击登录按钮
   - 处理协议、公告等
   ↓
5. 登录成功 → 通知 VxMain
   ↓
6. 打开 swiAutoOrdersBet 开关（飞单中）
   ↓
7. AutoBetCoordinator 启动
   - 订阅开奖服务事件
   ↓
8. 彩票状态变为"即将封盘"
   ↓
9. AutoBetCoordinator 触发
   - 📡 Socket 推送封盘通知到浏览器
   - 📡 Socket 推送投注命令到浏览器
   - 🌐 HTTP 队列添加订单（兜底）
   ↓
10. BsBrowserClient 收到命令
   - 执行平台脚本投注
   - 🌐 HTTP POST 结果到 VxMain
   ↓
11. VxMain 记录投注结果到数据库
```

### 场景3：两个开关协同工作

```
swi_OrdersTasking  = ON  (收单中)
swiAutoOrdersBet   = OFF (飞单停)

→ 用户可以通过微信发送投注命令
→ 不会自动投注到第三方平台

---

swi_OrdersTasking  = OFF (收单停)
swiAutoOrdersBet   = ON  (飞单中)

→ 忽略所有微信投注消息
→ 自动投注到第三方平台（封盘时触发）

---

swi_OrdersTasking  = ON  (收单中)
swiAutoOrdersBet   = ON  (飞单中)

→ 接收微信投注 + 自动飞单
→ 双重工作模式
```

## 📊 关键文件清单

### VxMain 端

| 文件 | 功能 |
|------|------|
| `Views/VxMain.cs` | 两个开关事件处理、设置保存加载 |
| `Services/AutoBet/AutoBetCoordinator.cs` | 协调开奖服务和自动投注 |
| `Services/AutoBet/AutoBetService.cs` | Socket + HTTP 双通道管理 |
| `Services/Messages/Handlers/BinggoMessageHandler.cs` | 检查 `IsOrdersTaskingEnabled` |

### BsBrowserClient 端

| 文件 | 功能 |
|------|------|
| `Form1.cs` | WebView2 初始化、自动登录触发 |
| `PlatformScripts/YunDing28Script.cs` | 智能登录、页面检测、自动填表 |
| `PlatformScripts/TongBaoScript.cs` | 通宝平台登录（支持验证码） |

## 🧪 测试步骤

### 1. 测试自动登录

```
1. 启动 VxMain
2. 快速设置面板填写账号密码
3. 点击"启动浏览器"
4. 观察日志：
   ✅ 页面加载完成
   🔍 检测页面状态，准备自动登录...
   ✅ 获取到配置: test123
   🔐 开始自动登录: test123
   [云顶] 🔐 开始智能登录流程...
   [云顶] 检测到登录页面，尝试自动填充...
   [云顶] ✅ 登录成功！
   ✅ 自动登录成功！
```

### 2. 测试收单开关

```
1. 打开 swi_OrdersTasking 开关
2. 微信用户发送：大 10
3. 观察：✅ 投注成功！
4. 关闭 swi_OrdersTasking 开关
5. 微信用户发送：小 20
6. 观察：⏸️ 收单已关闭，忽略消息
```

### 3. 测试自动投注开关

```
1. 确保浏览器已登录
2. 打开 swiAutoOrdersBet 开关
3. 等待"即将封盘"状态
4. 观察日志：
   🎯 触发封盘通知和自动投注
   📢 已推送封盘通知: 配置1 期号xxx 剩余30秒
   📤 已推送投注命令: 配置1 xxx 大 1元
   📝 订单已加入队列
   📥 [配置1] 投注结果: ✅ 成功 订单号:YDxxx
```

### 4. 测试设置持久化

```
1. 打开两个开关
2. 关闭 VxMain
3. 重新启动 VxMain
4. 观察：两个开关状态被正确恢复
5. 日志显示：✅ 开关状态已加载: 飞单=True, 收单=True
```

## 🎉 完成总结

### ✅ 已完成的功能

1. ✅ **自动登录流程**
   - 页面加载完成自动触发
   - 智能检测页面状态
   - 自动填表并登录
   - 处理协议、公告等
   - 支持云顶、通宝等多平台

2. ✅ **收单开关（swi_OrdersTasking）**
   - 控制微信消息处理
   - 保存到数据库
   - 应用重启后恢复状态
   - 全局静态字段控制

3. ✅ **自动投注开关（swiAutoOrdersBet）**
   - 控制自动投注功能
   - 启动/停止 AutoBetCoordinator
   - 保存到数据库
   - 应用重启后恢复状态

4. ✅ **设置持久化**
   - 开关状态保存到 `AppSettings` 表
   - 应用启动时自动加载
   - 实时保存，无需手动

5. ✅ **双通道通信**
   - Socket：实时推送（封盘通知、投注命令）
   - HTTP：数据交互（获取订单、提交结果）

### 📈 系统流程完整性

```
✅ 启动浏览器 → 自动加载平台URL
✅ 页面加载完成 → 自动登录
✅ 登录成功 → 通知VxMain
✅ 开启自动投注 → 订阅开奖事件
✅ 即将封盘 → 推送通知+命令
✅ 浏览器投注 → 提交结果
✅ 记录到数据库 → 完整闭环
```

### 🚀 可以投入使用！

整个自动投注系统已经完整实现，从浏览器启动、自动登录、消息处理、自动投注到结果记录，形成了完整的闭环流程。

**两个控制开关**让用户可以灵活控制系统行为：
- **收单开关**：控制是否接收微信投注
- **飞单开关**：控制是否自动投注到第三方平台

**自动登录**确保浏览器启动后无需手动干预即可进入工作状态。

**双通道通信**提供了高效可靠的通信机制，兼顾实时性和可调试性。

---

## 🔮 后续优化方向

1. **登录失败处理**
   - 账号密码错误提示
   - 验证码识别（通宝平台）
   - 登录超时重试

2. **余额监控**
   - 定时获取余额
   - 余额不足预警
   - 余额变化通知

3. **投注结果解析**
   - 解析平台返回的订单号
   - 解析余额变化
   - 解析投注状态

4. **多配置并行**
   - 支持多个浏览器同时工作
   - 每个浏览器独立配置
   - 负载均衡投注

5. **异常恢复**
   - 浏览器崩溃自动重启
   - 网络断线自动重连
   - 登录状态失效自动重登

**当前版本已经具备生产环境使用的基本条件！** 🎊

