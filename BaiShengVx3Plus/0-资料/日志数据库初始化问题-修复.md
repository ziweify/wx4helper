# æ—¥å¿—æ•°æ®åº“åˆå§‹åŒ–é—®é¢˜ - ä¿®å¤

## ğŸ› é—®é¢˜ç°è±¡

```
SQLite.SQLiteException: no such table: LogEntry
  at SQLite.SQLiteConnection.Insert(Object obj)
  at BaiShengVx3Plus.Services.Logging.LogService.WriteBatchToDatabase()
```

**é”™è¯¯åŸå› **ï¼šæ—¥å¿—å†™å…¥æ—¶ï¼Œ`LogEntry` è¡¨ä¸å­˜åœ¨ã€‚

---

## ğŸ” æ ¹æœ¬åŸå› 

### åŸå›  1ï¼šåˆå§‹åŒ–å¼‚å¸¸è¢«åæ‰

```csharp
// âŒ åŸæ¥çš„ä»£ç 
private void InitializeDatabase()
{
    try
    {
        using var connection = new SQLiteConnection(_dbPath);
        connection.CreateTable<LogEntry>();
    }
    catch (Exception ex)
    {
        Console.WriteLine($"åˆå§‹åŒ–æ—¥å¿—æ•°æ®åº“å¤±è´¥: {ex.Message}");
        // âŒ å¼‚å¸¸è¢«åæ‰ï¼Œåç»­å†™å…¥æ—¶æ‰å‘ç°è¡¨ä¸å­˜åœ¨
    }
}
```

**é—®é¢˜**ï¼š
- å¦‚æœ `CreateTable` å¤±è´¥ï¼Œå¼‚å¸¸è¢« `catch` åæ‰
- ç¨‹åºç»§ç»­è¿è¡Œï¼Œä½†è¡¨æ²¡æœ‰åˆ›å»º
- å†™å…¥æ—¥å¿—æ—¶æ‰æŠ¥é”™ `no such table`

---

### åŸå›  2ï¼šæ²¡æœ‰éªŒè¯è¡¨æ˜¯å¦åˆ›å»ºæˆåŠŸ

```csharp
// âŒ åŸæ¥çš„ä»£ç 
connection.CreateTable<LogEntry>();
// æ²¡æœ‰éªŒè¯è¡¨æ˜¯å¦çœŸçš„åˆ›å»ºäº†
```

**é—®é¢˜**ï¼š
- `CreateTable` å¯èƒ½é™é»˜å¤±è´¥
- æ²¡æœ‰éªŒè¯è¡¨æ˜¯å¦å­˜åœ¨
- æ— æ³•åŠæ—©å‘ç°é—®é¢˜

---

### åŸå›  3ï¼šWriteBatchToDatabase é‡å¤åˆ›å»ºè¡¨

```csharp
// âŒ åŸæ¥çš„ä»£ç ï¼ˆæˆ‘ä¹‹å‰æ·»åŠ çš„é˜²å¾¡æ€§ç¼–ç¨‹ï¼Œåè€Œå¯¼è‡´æ··ä¹±ï¼‰
private void WriteBatchToDatabase(List<LogEntry> logs)
{
    try
    {
        connection.CreateTable<LogEntry>();  // âŒ æ¯æ¬¡å†™å…¥éƒ½å°è¯•åˆ›å»ºè¡¨
        connection.RunInTransaction(() => { ... });
    }
    catch { ... }
}
```

**é—®é¢˜**ï¼š
- è¡¨çš„åˆ›å»ºåº”è¯¥åœ¨åˆå§‹åŒ–æ—¶ä¸€æ¬¡æ€§å®Œæˆ
- å†™å…¥æ—¶ä¸åº”è¯¥å†åˆ›å»ºè¡¨
- èŒè´£ä¸æ¸…æ™°

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ 1ï¼šå¼ºåŒ– InitializeDatabase

```csharp
private void InitializeDatabase()
{
    try
    {
        // ğŸ”¥ ç¡®ä¿æ•°æ®åº“ç›®å½•å­˜åœ¨
        var dbDir = Path.GetDirectoryName(_dbPath);
        if (!string.IsNullOrEmpty(dbDir) && !Directory.Exists(dbDir))
        {
            Directory.CreateDirectory(dbDir);
            Console.WriteLine($"åˆ›å»ºæ—¥å¿—æ•°æ®åº“ç›®å½•: {dbDir}");
        }
        
        Console.WriteLine($"åˆå§‹åŒ–æ—¥å¿—æ•°æ®åº“: {_dbPath}");
        
        using var connection = new SQLiteConnection(_dbPath);
        
        // ğŸ”¥ ä¸€æ¬¡æ€§åˆ›å»ºæ‰€æœ‰è¡¨
        connection.CreateTable<LogEntry>();
        
        Console.WriteLine("âœ… æ—¥å¿—æ•°æ®åº“è¡¨åˆå§‹åŒ–æˆåŠŸ");
        
        // ğŸ”¥ éªŒè¯è¡¨æ˜¯å¦åˆ›å»ºæˆåŠŸ
        var tableCount = connection.ExecuteScalar<int>(
            "SELECT COUNT(*) FROM sqlite_master WHERE type='table' AND name='LogEntry'");
        
        if (tableCount == 0)
        {
            throw new Exception("LogEntry è¡¨åˆ›å»ºå¤±è´¥ï¼");
        }
        
        Console.WriteLine($"âœ… LogEntry è¡¨éªŒè¯æˆåŠŸ");
    }
    catch (Exception ex)
    {
        Console.WriteLine($"âŒ åˆå§‹åŒ–æ—¥å¿—æ•°æ®åº“å¤±è´¥: {ex.Message}");
        Console.WriteLine($"   æ•°æ®åº“è·¯å¾„: {_dbPath}");
        Console.WriteLine($"   å †æ ˆ: {ex.StackTrace}");
        throw;  // ğŸ”¥ é‡æ–°æŠ›å‡ºå¼‚å¸¸ï¼Œè®©è°ƒç”¨è€…çŸ¥é“åˆå§‹åŒ–å¤±è´¥
    }
}
```

**æ”¹è¿›**ï¼š
- âœ… ç¡®ä¿æ•°æ®åº“ç›®å½•å­˜åœ¨
- âœ… è¾“å‡ºè¯¦ç»†çš„åˆå§‹åŒ–æ—¥å¿—
- âœ… éªŒè¯è¡¨æ˜¯å¦åˆ›å»ºæˆåŠŸ
- âœ… åˆå§‹åŒ–å¤±è´¥æ—¶**æŠ›å‡ºå¼‚å¸¸**ï¼ˆè€Œä¸æ˜¯åæ‰ï¼‰

---

### ä¿®å¤ 2ï¼šç®€åŒ– WriteBatchToDatabase

```csharp
private void WriteBatchToDatabase(List<LogEntry> logs)
{
    if (logs.Count == 0) return;

    try
    {
        using var connection = new SQLiteConnection(_dbPath);
        
        // ğŸ”¥ è¡¨å·²ç»åœ¨ InitializeDatabase ä¸­åˆ›å»ºï¼Œç›´æ¥å†™å…¥
        connection.RunInTransaction(() =>
        {
            foreach (var log in logs)
            {
                connection.Insert(log);
            }
        });
    }
    catch (Exception ex)
    {
        Console.WriteLine($"âŒ å†™å…¥æ—¥å¿—å¤±è´¥: {ex.Message}");
        Console.WriteLine($"   æ•°æ®åº“è·¯å¾„: {_dbPath}");
        Console.WriteLine($"   å¾…å†™å…¥æ—¥å¿—æ•°: {logs.Count}");
    }
}
```

**æ”¹è¿›**ï¼š
- âœ… ç§»é™¤é‡å¤çš„ `CreateTable` è°ƒç”¨
- âœ… èŒè´£æ¸…æ™°ï¼šåˆå§‹åŒ–æ—¶åˆ›å»ºè¡¨ï¼Œå†™å…¥æ—¶åªè´Ÿè´£å†™å…¥
- âœ… è¾“å‡ºè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯

---

## ğŸ“Š ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰ï¼ˆâŒï¼‰ï¼š

```
1. InitializeDatabase() æ‰§è¡Œ
2. CreateTable å¤±è´¥ï¼ˆä½†å¼‚å¸¸è¢«åæ‰ï¼‰
3. ç¨‹åºç»§ç»­è¿è¡Œ
4. WriteBatchToDatabase() æ‰§è¡Œ
5. Insert å¤±è´¥ â†’ "no such table: LogEntry" âŒ
```

### ä¿®å¤åï¼ˆâœ…ï¼‰ï¼š

```
1. InitializeDatabase() æ‰§è¡Œ
   - åˆ›å»ºæ•°æ®åº“ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
   - CreateTable<LogEntry>()
   - éªŒè¯è¡¨æ˜¯å¦å­˜åœ¨
   - å¦‚æœå¤±è´¥ â†’ æŠ›å‡ºå¼‚å¸¸ï¼Œç¨‹åºç»ˆæ­¢ âš ï¸
2. ç¨‹åºç»§ç»­è¿è¡Œï¼ˆè¡¨å·²å­˜åœ¨ï¼‰
3. WriteBatchToDatabase() æ‰§è¡Œ
   - ç›´æ¥å†™å…¥ï¼ˆä¸å†åˆ›å»ºè¡¨ï¼‰
   - æˆåŠŸ âœ…
```

---

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

1. **Fail Fast**ï¼šåˆå§‹åŒ–å¤±è´¥æ—¶ç«‹å³æŠ›å‡ºå¼‚å¸¸ï¼Œä¸è¦åæ‰
2. **å•ä¸€èŒè´£**ï¼š
   - `InitializeDatabase`ï¼šè´Ÿè´£åˆ›å»ºè¡¨
   - `WriteBatchToDatabase`ï¼šè´Ÿè´£å†™å…¥æ•°æ®
3. **éªŒè¯ç»“æœ**ï¼šåˆ›å»ºè¡¨åéªŒè¯æ˜¯å¦æˆåŠŸ
4. **è¯¦ç»†æ—¥å¿—**ï¼šè¾“å‡ºæ¸…æ™°çš„è¯Šæ–­ä¿¡æ¯

---

## ğŸš€ ä¸‹ä¸€æ­¥

ç”¨æˆ·ç°åœ¨åº”è¯¥ï¼š
1. âœ… ç¼–è¯‘å¹¶è¿è¡Œç¨‹åº
2. âœ… æŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºï¼Œç¡®è®¤çœ‹åˆ°ï¼š
   ```
   åˆå§‹åŒ–æ—¥å¿—æ•°æ®åº“: C:\Users\xxx\AppData\Local\BaiShengVx3Plus\Data\logs.db
   âœ… æ—¥å¿—æ•°æ®åº“è¡¨åˆå§‹åŒ–æˆåŠŸ
   âœ… LogEntry è¡¨éªŒè¯æˆåŠŸ
   ```
3. âœ… å¦‚æœä»ç„¶å¤±è´¥ï¼Œä¼šçœ‹åˆ°æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯å’Œæ•°æ®åº“è·¯å¾„
4. âœ… æ­£å¸¸è¿è¡Œåï¼Œä¸åº”è¯¥å†å‡ºç° `no such table` é”™è¯¯

**å¦‚æœåˆå§‹åŒ–å¤±è´¥ï¼Œç¨‹åºä¼šåœ¨å¯åŠ¨æ—¶ç«‹å³æŠ¥é”™ï¼Œè€Œä¸æ˜¯è¿è¡Œä¸€æ®µæ—¶é—´åæ‰å´©æºƒï¼**

