# 开奖表不存在问题 - 修复

## ❌ 错误现象

```
2025-11-14 21:11:29.643 信息 BinggoLotteryService ✅ 获取到开奖数据: 114064521 - 55,18,20,45,23 小单 龙
2025-11-14 21:11:29.643 错误 BinggoLotteryService 开奖队列检查异常: no such table: BinggoLotteryData
```

**症状**：
- 开奖服务能获取到开奖数据
- 但在访问数据库时报错"no such table: BinggoLotteryData"
- 导致开奖状态无法正常流转，系统卡住

---

## 🔍 问题分析

### 1. 初始化流程

```csharp
// VxMain.cs
InitializeDatabases()
    ↓
    第 242 行: InitializeGlobalTables(_globalDb)
        ↓
        第 3463 行: db.CreateTable<BinggoLotteryData>();  // 创建表
    ↓
InitializeBinggoServices()
    ↓
    第 325 行: _lotteryService.SetDatabase(_globalDb);
        ↓
        第 155 行: _db?.CreateTable<BinggoLotteryData>();  // 再次创建表（幂等）
    ↓
    第 400 行: _ = _lotteryService.StartAsync();  // 🔥 异步启动，不等待
        ↓
        第 187 行: await OnTimerTickAsync();  // 立即执行一次
            ↓
            第 328 行: await GetLotteryDataAsync(oldIssueId, forceRefresh: false);
                ↓
                第 666 行: _db.Table<BinggoLotteryData>()  // 🔥 访问表
                    ↓
                    ❌ no such table: BinggoLotteryData
```

### 2. 根本原因

**竞态条件 (Race Condition)**:

1. **主线程**：`InitializeGlobalTables` 正在创建表
2. **开奖线程**：`StartAsync` 异步启动，立即执行 `OnTimerTickAsync`
3. **开奖队列检查线程**：同时启动，开始访问数据库

由于 `StartAsync` 是**异步不等待**的（`_ = _lotteryService.StartAsync();`），所以开奖线程可能在表还没有完全创建完成时就开始访问数据库，导致 "no such table" 错误。

### 3. 为什么 F5BotV2 不会有这个问题？

F5BotV2 的数据库初始化是**同步**的，而且在启动服务之前已经完成了所有数据库操作。

---

## ✅ 修复方案

### 方案 1：防御性编程（已实现）

在 `GetLotteryDataAsync` 和保存数据的地方添加 `try-catch`，捕获 "no such table" 异常并忽略。

```csharp
// BinggoLotteryService.cs Line 664-683
if (!forceRefresh && _db != null)
{
    try
    {
        var local = _db.Table<BinggoLotteryData>()
            .Where(d => d.IssueId == issueId && !string.IsNullOrEmpty(d.LotteryData))
            .ToList()
            .FirstOrDefault(d => d.IsOpened);
        
        if (local != null)
        {
            _logService.Info("BinggoLotteryService", $"✓ 从本地缓存获取期号 {issueId} 数据");
            return local;
        }
    }
    catch (SQLite.SQLiteException ex) when (ex.Message.Contains("no such table"))
    {
        // 🔥 表不存在（可能是数据库刚初始化），忽略错误，直接从网络获取
        _logService.Warning("BinggoLotteryService", $"本地数据库表不存在，跳过本地查询，从网络获取: {ex.Message}");
    }
}
```

```csharp
// BinggoLotteryService.cs Line 397-409
if (_db != null)
{
    try
    {
        _db.InsertOrReplace(openedData);
        _bindingList?.LoadFromDatabase(100);
    }
    catch (SQLite.SQLiteException ex) when (ex.Message.Contains("no such table"))
    {
        // 🔥 表不存在（可能是数据库刚初始化），忽略错误
        _logService.Warning("BinggoLotteryService", $"保存开奖数据失败，表不存在: {ex.Message}");
    }
}
```

### 方案 2：启动前检查（已实现）

在 `StartAsync` 中添加数据库检查，确保数据库已设置。

```csharp
// BinggoLotteryService.cs Line 168-201
public async Task StartAsync()
{
    if (_isRunning)
    {
        _logService.Warning("BinggoLotteryService", "服务已在运行中");
        return;
    }
    
    // 🔥 防御性检查：确保数据库已设置
    if (_db == null)
    {
        _logService.Error("BinggoLotteryService", "❌ 数据库未设置，无法启动服务！请先调用 SetDatabase()");
        return;
    }
    
    _logService.Info("BinggoLotteryService", "🚀 开奖服务启动");
    _isRunning = true;
    
    // ... 启动定时器和开奖队列检查线程
}
```

### 方案 3：同步初始化（可选，暂未实现）

将 `StartAsync` 改为 `await` 等待，确保服务完全启动后再继续。

```csharp
// VxMain.cs Line 400
// 修改前：
_ = _lotteryService.StartAsync();  // 异步启动，不等待

// 修改后：
await _lotteryService.StartAsync();  // 等待服务完全启动
```

**注意**：这可能会导致 UI 阻塞，不推荐。

---

## 🎯 测试验证

### 1. 正常启动测试

```
步骤：
1. 关闭程序
2. 删除数据库文件（business.db）
3. 重新启动程序
4. 观察日志

预期结果：
✅ 全局数据库已打开: ...business.db
✅ 全局表: BinggoLotteryData
✅ LotteryService 已设置全局数据库（BinggoLotteryData）
🚀 开奖服务启动
✅ 开奖队列检查线程已启动
⚠️ 本地数据库表不存在，跳过本地查询，从网络获取 (可能出现)
✅ 获取到开奖数据: ...
```

### 2. 快速启动测试

```
步骤：
1. 快速重启程序（Ctrl+F5）
2. 观察是否还有 "no such table" 错误

预期结果：
✅ 不再出现 "no such table" 错误
✅ 开奖数据正常获取和保存
✅ 状态流转正常
```

---

## 📌 关键改进

1. **防御性编程**：在所有数据库访问点添加异常捕获
2. **启动前检查**：确保数据库已设置
3. **错误容忍**：即使表不存在，也能从网络获取数据，不影响核心功能

**这样开奖服务就像 F5BotV2 一样稳定了！** ✅

