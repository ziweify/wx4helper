# 🔍 账号密码配置诊断指南

## 📅 创建时间

2025-11-08

## 🐛 问题描述

用户反馈：
> "我默认配置有账号密码，可是启动飞单后，BrowserClient 提示'未配置账号密码，跳过自动登录'。请检查各项细节。"

## 🔎 可能的原因

### 1. 数据库中账号密码为空

**原因**：虽然 UI 中填写了账号密码，但保存失败或未保存到数据库。

**检查方法**：
- 查看日志是否有 "✅ 自动投注设置已保存"
- 查看日志中保存的用户名和密码是否正确

### 2. HTTP API 未正确返回数据

**原因**：HTTP API 返回的配置数据格式错误或字段缺失。

**检查方法**：
- 查看日志中 "✅ 返回配置" 的详细信息
- 确认用户名和密码字段是否为空

### 3. 浏览器解析 JSON 失败

**原因**：浏览器端解析 JSON 时字段名大小写不匹配。

**检查方法**：
- 查看浏览器日志 "📄 收到配置响应"
- 确认 JSON 字段名是否匹配（`Username` vs `username`）

### 4. 防抖机制未触发保存

**原因**：用户输入账号密码后立即启动浏览器，防抖延迟未完成。

**检查方法**：
- 确认输入账号密码后是否等待了至少 1 秒
- 检查防抖计时器是否正常工作

## 📊 完整数据流

### 保存流程

```
1. 用户在 txtAutoBetUsername/txtAutoBetPassword 输入账号密码
   ↓
2. TextChanged 事件触发 → DebounceSaveSettings()
   ↓
3. 防抖计时器启动（1秒延迟）
   ↓
4. 1秒后，计时器触发 → SaveAutoBetSettings()
   ↓
5. 获取默认配置（IsDefault = true）
   ↓
6. 更新配置：
   - defaultConfig.Username = txtAutoBetUsername.Text
   - defaultConfig.Password = txtAutoBetPassword.Text
   ↓
7. 调用 _autoBetService.SaveConfig(defaultConfig)
   ↓
8. SQLite-net 更新数据库表 BetConfig
   ↓
9. 日志输出：✅ 自动投注设置已保存
   - 用户名: xxx
   - 密码: ******
```

### 加载流程

```
1. 浏览器启动，页面加载完成
   ↓
2. NavigationCompleted 事件触发 → TryAutoLoginAsync()
   ↓
3. 通过 HTTP GET /api/config?configId=1
   ↓
4. VxMain 的 AutoBetHttpServer 处理请求
   ↓
5. 调用 _getConfig(configId) 获取配置
   ↓
6. 返回 JSON：
   {
     "success": true,
     "data": {
       "Id": 1,
       "ConfigName": "默认配置",
       "Platform": "云顶",
       "PlatformUrl": "https://yd28.vip",
       "Username": "xxx",
       "Password": "yyy",
       "cookieData": null,
       "cookieUpdateTime": null
     }
   }
   ↓
7. 浏览器解析 JSON：
   - username = config["data"]?["Username"]?.ToString()
   - password = config["data"]?["Password"]?.ToString()
   ↓
8. 检查账号密码是否为空
   ↓
9a. 如果为空：日志输出 "⚠️ 未配置账号密码，跳过自动登录"
9b. 如果不为空：调用 _platformScript.LoginAsync(username, password)
```

## 🔧 已添加的诊断日志

### VxMain 端（保存设置）

**文件**：`BaiShengVx3Plus/Views/VxMain.cs`

```csharp
private void SaveAutoBetSettings()
{
    // ...
    _logService.Info("VxMain", "✅ 自动投注设置已保存");
    _logService.Info("VxMain", $"   - 用户名: {(string.IsNullOrEmpty(username) ? "(空)" : username)}");
    _logService.Info("VxMain", $"   - 密码: {(string.IsNullOrEmpty(password) ? "(空)" : "******")}");
}
```

**预期日志**：
```
[时间] [VxMain] ✅ 自动投注设置已保存
[时间] [VxMain]    - 用户名: test123
[时间] [VxMain]    - 密码: ******
```

### VxMain 端（HTTP API 返回）

**文件**：`BaiShengVx3Plus/Services/AutoBet/AutoBetHttpServer.cs`

```csharp
private async Task HandleGetConfigAsync(...)
{
    // ...
    _log.Info("HTTP", $"✅ 返回配置: {config.ConfigName}");
    _log.Info("HTTP", $"   - 用户名: {(string.IsNullOrEmpty(config.Username) ? "(空)" : config.Username)}");
    _log.Info("HTTP", $"   - 密码: {(string.IsNullOrEmpty(config.Password) ? "(空)" : "******")}");
    _log.Info("HTTP", $"   - 平台: {config.Platform}");
}
```

**预期日志**：
```
[时间] [HTTP] 📩 GET /api/config?configId=1
[时间] [HTTP] ✅ 返回配置: 默认配置
[时间] [HTTP]    - 用户名: test123
[时间] [HTTP]    - 密码: ******
[时间] [HTTP]    - 平台: 云顶
```

### BrowserClient 端（解析配置）

**文件**：`BsBrowserClient/Form1.cs`

```csharp
private async Task TryAutoLoginAsync()
{
    // ...
    var json = await response.Content.ReadAsStringAsync();
    OnLogMessage($"📄 收到配置响应: {json.Substring(0, Math.Min(200, json.Length))}...");
    
    var config = Newtonsoft.Json.Linq.JObject.Parse(json);
    if (config["success"]?.Value<bool>() ?? false)
    {
        username = config["data"]?["Username"]?.ToString() ?? "";
        password = config["data"]?["Password"]?.ToString() ?? "";
        
        OnLogMessage($"✅ 获取到配置:");
        OnLogMessage($"   用户名: {(string.IsNullOrEmpty(username) ? "(空)" : username)}");
        OnLogMessage($"   密码: {(string.IsNullOrEmpty(password) ? "(空)" : "******")}");
    }
}
```

**预期日志**：
```
[时间] 🔍 检测页面状态，准备自动登录...
[时间] 📄 收到配置响应: {"success":true,"data":{"Id":1,"ConfigName":"默认配置"...
[时间] ✅ 获取到配置:
[时间]    用户名: test123
[时间]    密码: ******
[时间] 🔐 开始自动登录: test123
```

## 🧪 测试步骤

### 准备工作

1. **关闭所有进程**：
   ```powershell
   taskkill /IM BaiShengVx3Plus.exe /F
   taskkill /IM BsBrowserClient.exe /F
   ```

2. **重新编译**：
   ```powershell
   cd D:\gitcode\wx4helper
   dotnet build BaiShengVx3Plus/BaiShengVx3Plus.csproj
   ```

### 测试场景 1：输入账号密码并等待保存

**步骤**：
1. 启动 VxMain
2. 在快速设置面板输入：
   - 用户名：`test123`
   - 密码：`password123`
3. **等待 2 秒**（确保防抖完成）
4. 观察日志，应该看到：
   ```
   ✅ 自动投注设置已保存
      - 用户名: test123
      - 密码: ******
   ```
5. 点击"启动浏览器"
6. 观察日志

**预期结果**：
```
[VxMain] 🚀 手动启动浏览器...
[AutoBet] 🚀 启动浏览器: 默认配置
[AutoBetServer] 🔗 浏览器已连接，处理握手...
[AutoBet] ✅ 浏览器 Socket 连接成功: 默认配置
[HTTP] 📩 GET /api/config?configId=1
[HTTP] ✅ 返回配置: 默认配置
[HTTP]    - 用户名: test123
[HTTP]    - 密码: ******
[HTTP]    - 平台: 云顶
[Browser] 🔍 检测页面状态，准备自动登录...
[Browser] 📄 收到配置响应: {"success":true...
[Browser] ✅ 获取到配置:
[Browser]    用户名: test123
[Browser]    密码: ******
[Browser] 🔐 开始自动登录: test123
[Browser] ✅ 自动登录成功！
```

### 测试场景 2：立即启动浏览器（防抖未完成）

**步骤**：
1. 启动 VxMain
2. 在快速设置面板输入账号密码
3. **立即**点击"启动浏览器"（不等待）
4. 观察日志

**预期问题**：
- 可能看到 "⚠️ 未配置账号密码，跳过自动登录"
- 因为防抖计时器未完成，账号密码未保存到数据库

**解决方法**：
- 在 `btnStartBrowser_Click` 中，调用 `SaveAutoBetSettings()` 时不使用防抖，立即保存
- **已实现**：代码中已经添加了 `SaveAutoBetSettings();` 在启动浏览器之前

### 测试场景 3：检查数据库内容

**步骤**：
1. 使用 SQLite 工具（如 DB Browser for SQLite）打开数据库文件：
   ```
   D:\gitcode\wx4helper\BaiShengVx3Plus\bin\Debug\net8.0-windows\data\app.db
   ```
2. 查询 `BetConfig` 表：
   ```sql
   SELECT * FROM BetConfig WHERE IsDefault = 1;
   ```
3. 检查 `Username` 和 `Password` 字段是否有值

**预期结果**：
```
Id  | ConfigName | Platform | Username | Password     | IsDefault
----|------------|----------|----------|--------------|----------
1   | 默认配置   | 云顶     | test123  | password123  | 1
```

## 🔧 故障排查

### 问题 1：日志显示 "(空)"

**症状**：
```
[VxMain] ✅ 自动投注设置已保存
[VxMain]    - 用户名: (空)
[VxMain]    - 密码: (空)
```

**原因**：
- `txtAutoBetUsername.Text` 或 `txtAutoBetPassword.Text` 为空
- UI 控件未正确绑定

**解决方法**：
1. 检查 UI 控件名称是否正确（`VxMain.Designer.cs`）
2. 确认控件已在设计器中创建
3. 检查是否有其他代码清空了文本框

### 问题 2：HTTP API 返回 "(空)"

**症状**：
```
[HTTP] ✅ 返回配置: 默认配置
[HTTP]    - 用户名: (空)
[HTTP]    - 密码: (空)
```

**原因**：
- 数据库中的配置记录确实为空
- `SaveConfig` 未正确保存到数据库

**解决方法**：
1. 检查数据库文件是否可写
2. 检查 SQLite-net 的 `Update` 方法是否执行成功
3. 手动查询数据库确认数据

### 问题 3：浏览器解析失败

**症状**：
```
[Browser] 📄 收到配置响应: {"success":true,"data":{...
[Browser] ✅ 获取到配置:
[Browser]    用户名: (空)
[Browser]    密码: (空)
```

**原因**：
- JSON 字段名大小写不匹配
- `config["data"]?["Username"]` 返回 null

**解决方法**：
1. 检查 JSON 输出，确认字段名
2. 确认 C# 匿名对象序列化后的字段名首字母大写
3. 可以使用 `[JsonProperty("username")]` 指定序列化名称

### 问题 4：未找到默认配置

**症状**：
```
[VxMain] ⚠️ 未找到默认配置，无法保存设置
```

**原因**：
- 数据库中没有 `IsDefault = 1` 的记录
- 首次启动时未创建默认配置

**解决方法**：
- 在 `AutoBetService` 初始化时自动创建默认配置（如果不存在）

## 📝 代码检查清单

### ✅ 已确认的代码

1. **VxMain.cs - SaveAutoBetSettings()**
   - ✅ 获取默认配置
   - ✅ 更新 `Username` 和 `Password`
   - ✅ 调用 `SaveConfig`
   - ✅ 添加详细日志

2. **AutoBetHttpServer.cs - HandleGetConfigAsync()**
   - ✅ 返回 `Username` 和 `Password` 字段
   - ✅ 添加详细日志

3. **BsBrowserClient/Form1.cs - TryAutoLoginAsync()**
   - ✅ 解析 `Username` 和 `Password`
   - ✅ 检查是否为空
   - ✅ 添加详细日志

4. **防抖机制**
   - ✅ `DebounceSaveSettings()` 延迟 1 秒
   - ✅ `btnStartBrowser_Click` 中立即保存

### 🔍 需要确认的点

1. **默认配置是否存在**
   - 查询数据库：`SELECT * FROM BetConfig WHERE IsDefault = 1;`

2. **JSON 字段名大小写**
   - 确认序列化后是 `Username` 还是 `username`
   - C# 匿名对象默认首字母大写

3. **数据库文件权限**
   - 确认 `app.db` 可读写
   - 检查是否有文件锁定

## 🎯 下一步操作

1. **关闭所有进程**
2. **重新编译应用**
3. **按照测试场景 1 进行测试**
4. **观察详细日志**
5. **根据日志定位问题**

## 📊 日志分析模板

复制以下日志，填写实际输出：

### 保存账号密码时
```
[时间] [VxMain] ✅ 自动投注设置已保存
[时间] [VxMain]    - 用户名: ___________
[时间] [VxMain]    - 密码: ___________
```

### HTTP API 返回配置时
```
[时间] [HTTP] 📩 GET /api/config?configId=1
[时间] [HTTP] ✅ 返回配置: ___________
[时间] [HTTP]    - 用户名: ___________
[时间] [HTTP]    - 密码: ___________
[时间] [HTTP]    - 平台: ___________
```

### 浏览器解析配置时
```
[时间] [Browser] 🔍 检测页面状态，准备自动登录...
[时间] [Browser] 📄 收到配置响应: ___________
[时间] [Browser] ✅ 获取到配置:
[时间] [Browser]    用户名: ___________
[时间] [Browser]    密码: ___________
```

**根据这些日志，可以快速定位问题出在哪个环节。** 🔍

