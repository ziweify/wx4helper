# 消息模拟器诊断指南

## 📋 问题：消息模拟器收不到系统消息

如果您的消息模拟器收不到系统消息（倒计时、封盘、开盘、结算等），请按照以下步骤逐一排查。

---

## 🔍 诊断步骤

### 步骤 1：检查开发模式是否已启用

**操作**：
1. 点击主界面的 "设置" 按钮
2. 找到 "开发模式" 选项
3. 确认复选框已勾选 ✅

**验证**：
- 如果开发模式未启用，消息模拟器**不会**收到任何系统消息
- 即使您手动打开了消息模拟器窗口，系统也不会通知它

**日志标识**：
```
🔧 开发模式：已通知消息模拟器显示XXX消息
```

---

### 步骤 2：检查消息模拟器窗口是否已打开

**操作**：
1. 在会员列表中选择任意会员
2. 右键 → "开发选项" → "发送消息"
3. 确认消息模拟器窗口已打开

**注意**：
- 只有**已打开的消息模拟器窗口**才能收到系统消息
- 如果窗口未打开，系统消息不会被保存，关闭后再打开也看不到之前的消息

---

### 步骤 3：检查开奖服务是否正在运行

**诊断方法**：
打开日志窗口，查找以下日志：

```
✅ 期号变更: xxx → xxx
⏰ 30秒提醒: 期号 xxx
⏰ 15秒提醒: 期号 xxx
📢 发送封盘消息: 期号 xxx
```

**如果没有这些日志**，说明：
- 开奖服务未启动
- 或者系统时钟不同步

**解决方法**：
- 重启软件
- 检查系统时间是否准确

---

### 步骤 4：检查上一期是否已结算（仅针对开盘消息）

**问题**：开盘消息有严格的发送条件

**原理**：
系统会检查上一期是否已经结算完成（发送了中~名单和留~名单）。如果上一期未结算，开盘消息会被跳过。

**修复后的行为**：
- ✅ **开发模式**：即使上一期未结算，也会通知消息模拟器
- ⚠️ **非开发模式**：严格遵循规则，不发送开盘消息

**日志标识**：
```
⚠️ 上一期 xxx 尚未结算完成（已结算期号：0），正常情况下应跳过发送本期 xxx 的'线下开始'消息
🔧 开发模式：即使上一期未结算，仍通知消息模拟器显示开盘消息（仅用于测试）
```

**解决方法**：
1. 等待一期开奖并结算完成
2. 或者手动触发一次开奖（管理员命令）

---

### 步骤 5：检查日志中的通知调用

**查找日志**：

| 消息类型 | 日志关键字 |
|---------|-----------|
| 倒计时提醒 | `🔧 开发模式：已通知消息模拟器显示封盘提醒` |
| 封盘消息 | `🔧 开发模式：已通知消息模拟器显示封盘消息` |
| 开盘消息 | `🔧 开发模式：已通知消息模拟器显示开盘消息` |
| 中奖名单 | `🔧 开发模式：已通知消息模拟器显示中奖名单` |
| 留分名单 | `🔧 开发模式：已通知消息模拟器显示留分名单` |

**如果有这些日志**：
- ✅ 说明系统已经调用了 `NotifySystemMessage`
- ❌ 但消息模拟器仍未显示，可能是订阅问题

**如果没有这些日志**：
- ❌ 说明开发模式未启用，或者系统消息未发送

---

### 步骤 6：检查消息模拟器是否订阅了静态事件

**代码位置**：`MessageSimulatorForm.cs` → `SubscribeToStaticNotifications()`

**验证方法**：
在日志中查找：
```
已订阅静态消息通知: {会员昵称}
```

**如果没有这条日志**：
- 说明消息模拟器窗口创建时订阅失败
- 可能是代码异常

---

### 步骤 7：检查静态事件是否有订阅者

**诊断代码**：`BinggoLotteryService.cs` → `NotifySystemMessage` 调用处

**日志标识**：
```
[NotifySystemMessage] messageType=封盘提醒, message长度=xxx, imagePath=null, 订阅者数量=1
```

**如果订阅者数量 = 0**：
- 说明没有消息模拟器窗口订阅这个事件
- 或者窗口已关闭，但事件未取消订阅

---

## 🐛 常见问题

### 问题 1：开盘消息永远收不到

**原因**：
- 刚启动程序时，`_lastSettledIssueId = 0`
- 当前期号比如是 `20251209001`，上一期是 `20251208203`
- 条件 `0 < 20251208203` 为真，直接返回，不会发送开盘消息

**修复后的行为**：
- ✅ **开发模式**：即使上一期未结算，也通知消息模拟器
- ⚠️ 需要等待一期完整的开奖流程后，后续期号的开盘消息才会正常

### 问题 2：倒计时提醒偶尔收不到

**原因**：
- 倒计时提醒有防重复机制（`_reminded30Seconds`、`_reminded15Seconds`）
- 如果系统时钟跳跃，可能跳过提醒时间点

**验证**：
检查日志中是否有：
```
⏰ 30秒提醒: 期号 xxx
⏰ 15秒提醒: 期号 xxx
```

### 问题 3：封盘消息显示了，但订单列表是空的

**原因**：
- 这是正常的！封盘消息格式为：`{期号} 时间到! 停止进仓! 以此为准!\r{订单列表}\r------线下无效------`
- 如果本期没有订单，订单列表部分就是空的

**验证**：
查看消息内容是否包含 `------线下无效------`

### 问题 4：图片消息收不到

**原因**：
- 图片生成失败（C:\images\ 目录无权限）
- 或者 API 获取历史数据失败

**验证**：
检查日志：
```
✅ 图片生成成功: C:\images\img_xxx.jpg，大小: xxx 字节
🖼️ 调用 ShowSystemImage: C:\images\img_xxx.jpg
```

**解决方法**：
- 以管理员身份运行程序
- 手动创建 `C:\images\` 目录

---

## ✅ 完整的诊断清单

请按顺序检查以下项目：

| # | 检查项 | 状态 | 说明 |
|---|-------|------|------|
| 1 | 开发模式已启用 | ☐ | 设置 → 开发模式 |
| 2 | 消息模拟器窗口已打开 | ☐ | 会员右键 → 发送消息 |
| 3 | 开奖服务正在运行 | ☐ | 日志中有 "期号变更" |
| 4 | 至少有一期已开奖 | ☐ | 等待完整的开奖流程 |
| 5 | 日志中有 "已通知消息模拟器" | ☐ | 查找 `🔧 开发模式` 日志 |
| 6 | 消息模拟器已订阅事件 | ☐ | 日志中有 "已订阅静态消息通知" |
| 7 | 静态事件有订阅者 | ☐ | 订阅者数量 > 0 |

---

## 🧪 测试用例

### 测试用例 1：倒计时提醒

**前置条件**：
- 开发模式已启用
- 消息模拟器已打开
- 距离封盘时间 < 30 秒

**预期结果**：
- 倒计时 30 秒时，显示：`{期号} 还剩30秒`
- 倒计时 15 秒时，显示：`{期号} 还剩15秒`

**实际结果**：☐ 通过 / ☐ 失败

---

### 测试用例 2：封盘消息

**前置条件**：
- 开发模式已启用
- 消息模拟器已打开
- 已到封盘时间

**预期结果**：
- 显示：`{期号} 时间到! 停止进仓! 以此为准!\r{订单列表}\r------线下无效------`
- 播放封盘声音

**实际结果**：☐ 通过 / ☐ 失败

---

### 测试用例 3：开盘消息

**前置条件**：
- 开发模式已启用
- 消息模拟器已打开
- 状态变为"开盘中"

**预期结果**：
- 显示：`第{期号}队\r---------线下开始---------`
- 延迟后显示历史记录图片

**实际结果**：☐ 通过 / ☐ 失败

---

### 测试用例 4：结算消息

**前置条件**：
- 开发模式已启用
- 消息模拟器已打开
- 开奖数据到达

**预期结果**：
- 显示中~名单
- 显示留~名单

**实际结果**：☐ 通过 / ☐ 失败

---

## 📞 如果问题仍未解决

### 收集以下信息：

1. **日志文件**
   - 位置：`%LocalAppData%\BaiShengVx3Plus\Logs\`
   - 文件：`log_{日期}.txt`

2. **关键日志片段**
   - 搜索：`开发模式`
   - 搜索：`NotifySystemMessage`
   - 搜索：`已订阅静态消息通知`
   - 搜索：`订阅者数量`

3. **环境信息**
   - Windows 版本
   - 是否以管理员身份运行
   - 软件版本

4. **重现步骤**
   - 详细描述操作步骤
   - 预期结果 vs 实际结果

---

**最后更新**：2025-12-09  
**文档版本**：v1.0

