# å¼€å¥–ç³»ç»Ÿé›†æˆå®Œæˆ - å¿«é€Ÿå‚è€ƒ

## ğŸ‰ å½“å‰çŠ¶æ€

âœ… **ç¼–è¯‘æˆåŠŸï¼0 é”™è¯¯ï¼Œ0 è­¦å‘Š**

---

## ğŸ“‚ é¡¹ç›®ç»“æ„

```
BaiShengVx3Plus/
â”œâ”€â”€ Models/
â”‚   â”œâ”€â”€ Api/
â”‚   â”‚   â”œâ”€â”€ BsApiUser.cs                    # API ç”¨æˆ·æ¨¡å‹
â”‚   â”‚   â””â”€â”€ BsApiResponse.cs                # API å“åº”æ¨¡å‹ (Newtonsoft.Json)
â”‚   â”œâ”€â”€ Games/Binggo/
â”‚   â”‚   â”œâ”€â”€ BinggoLotteryStatus.cs          # å¼€å¥–çŠ¶æ€æšä¸¾
â”‚   â”‚   â”œâ”€â”€ BinggoLotteryData.cs            # å¼€å¥–æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ BinggoBetItem.cs                # æŠ•æ³¨é¡¹
â”‚   â”‚   â”œâ”€â”€ BinggoBetContent.cs             # æŠ•æ³¨å†…å®¹
â”‚   â”‚   â”œâ”€â”€ BinggoGameSettings.cs           # æ¸¸æˆé…ç½®
â”‚   â”‚   â””â”€â”€ Events/                         # äº‹ä»¶å‚æ•°
â”‚   â”œâ”€â”€ V2Member.cs                         # ä¼šå‘˜æ¨¡å‹
â”‚   â””â”€â”€ V2MemberOrder.cs                    # è®¢å•æ¨¡å‹ (å·²æ·»åŠ å¼€å¥–å­—æ®µ)
â”œâ”€â”€ Contracts/
â”‚   â”œâ”€â”€ IBsWebApiClient.cs                  # HTTP å®¢æˆ·ç«¯æ¥å£ (å«ç‚³ç‹— API)
â”‚   â”œâ”€â”€ IBsWebApiService.cs                 # WebAPI æœåŠ¡æ¥å£
â”‚   â””â”€â”€ Games/
â”‚       â”œâ”€â”€ IBinggoLotteryService.cs        # å¼€å¥–æœåŠ¡æ¥å£ (å·²æ·»åŠ  SetDatabase)
â”‚       â””â”€â”€ IBinggoOrderService.cs          # è®¢å•æœåŠ¡æ¥å£ (å¯ç©ºå‚æ•°)
â”œâ”€â”€ Services/
â”‚   â”œâ”€â”€ Api/
â”‚   â”‚   â”œâ”€â”€ BsWebApiClient.cs               # HTTP å®¢æˆ·ç«¯å®ç° (Newtonsoft.Json)
â”‚   â”‚   â””â”€â”€ BsWebApiService.cs              # WebAPI æœåŠ¡å®ç°
â”‚   â”œâ”€â”€ Games/Binggo/
â”‚   â”‚   â”œâ”€â”€ BinggoLotteryService.cs         # å¼€å¥–æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ BinggoOrderService.cs           # è®¢å•æœåŠ¡
â”‚   â”‚   â””â”€â”€ BinggoOrderValidator.cs         # è®¢å•éªŒè¯å™¨
â”‚   â””â”€â”€ Messages/Handlers/
â”‚       â””â”€â”€ BinggoMessageHandler.cs         # ç‚³ç‹—æ¶ˆæ¯å¤„ç†å™¨
â”œâ”€â”€ Helpers/
â”‚   â””â”€â”€ BinggoHelper.cs                     # ç‚³ç‹—ä¸šåŠ¡é€»è¾‘è¾…åŠ©
â””â”€â”€ Core/
    â””â”€â”€ BinggoLotteryDataBindingList.cs     # å¼€å¥–æ•°æ® BindingList
```

---

## ğŸ”§ æ ¸å¿ƒåŠŸèƒ½

### 1. WebAPI ç™»å½•è®¤è¯ âœ…
```csharp
// æ³¨å…¥
private readonly IBsWebApiService _apiService;

// ä½¿ç”¨
bool success = await _apiService.LoginAsync(username, password);
if (success)
{
    var user = _apiService.CurrentUser;
    // user.Token, user.ValidUntil
}
```

### 2. å¼€å¥–æœåŠ¡ âœ…
```csharp
// æ³¨å…¥
private readonly IBinggoLotteryService _lotteryService;

// åˆå§‹åŒ–
_lotteryService.SetDatabase(_db);
_lotteryService.SetBindingList(_lotteryDataBindingList);

// è®¢é˜…äº‹ä»¶
_lotteryService.LotteryOpened += OnLotteryOpened;
_lotteryService.StatusChanged += OnLotteryStatusChanged;
_lotteryService.IssueChanged += OnLotteryIssueChanged;

// å¯åŠ¨
await _lotteryService.StartAsync();

// æŸ¥è¯¢å¼€å¥–æ•°æ®ï¼ˆå…ˆæŸ¥æœ¬åœ°ï¼Œå†æŸ¥ç½‘ç»œï¼‰
var data = await _lotteryService.GetLotteryDataAsync(issueId);
```

### 3. è®¢å•æœåŠ¡ âœ…
```csharp
// æ³¨å…¥
private readonly IBinggoOrderService _orderService;

// åˆå§‹åŒ–
_orderService.SetDatabase(_db);
_orderService.SetOrdersBindingList(_ordersBindingList);
_orderService.SetMembersBindingList(_membersBindingList);

// åˆ›å»ºè®¢å•ï¼ˆä»å¾®ä¿¡æ¶ˆæ¯ï¼‰
var (success, message, order) = await _orderService.CreateOrderAsync(
    member, messageContent, issueId, currentStatus);

// ç»“ç®—è®¢å•
var (settledCount, summary) = await _orderService.SettleOrdersAsync(
    issueId, lotteryData);
```

### 4. æ¶ˆæ¯å¤„ç† âœ…
```csharp
// BinggoMessageHandler å·²æ³¨å†Œåˆ° MessageDispatcher
// è‡ªåŠ¨å¤„ç†ä»¥ä¸‹ç±»å‹çš„å¾®ä¿¡æ¶ˆæ¯ï¼š
// - æŠ•æ³¨æ¶ˆæ¯ï¼ˆè¯†åˆ«ç‚³ç‹—æŠ•æ³¨æ ¼å¼ï¼‰
// - è¡¥å•è¯·æ±‚
// - æŸ¥è¯¢ä½™é¢
// - æŸ¥è¯¢è®¢å•
```

---

## ğŸ¯ ä¾èµ–æ³¨å…¥é…ç½®

### Program.cs
```csharp
// ğŸ® æ¸¸æˆé…ç½®å’ŒæœåŠ¡
services.AddSingleton(new BinggoGameSettings());
services.AddSingleton<BinggoOrderValidator>();
services.AddSingleton<BinggoMessageHandler>();

// ğŸŒ WebAPI æœåŠ¡
services.AddHttpClient<IBsWebApiClient, BsWebApiClient>();
services.AddSingleton<IBsWebApiService, BsWebApiService>();

// ğŸ² ç‚³ç‹—å¼€å¥–å’Œè®¢å•æœåŠ¡
services.AddSingleton<IBinggoLotteryService, BinggoLotteryService>();
services.AddSingleton<IBinggoOrderService, BinggoOrderService>();

// æ¶ˆæ¯å¤„ç†
services.AddTransient<IMessageHandler, BinggoMessageHandler>();
```

### VxMain.cs
```csharp
public VxMain(
    // ... å…¶ä»–æœåŠ¡
    IBinggoLotteryService lotteryService,
    IBinggoOrderService orderService,
    BinggoMessageHandler binggoMessageHandler,
    BinggoGameSettings binggoSettings)
{
    // ... åˆå§‹åŒ–
}

private void InitializeBinggoServices()
{
    // åœ¨ InitializeDatabase() æœ«å°¾è°ƒç”¨
}
```

---

## ğŸ“Š æ•°æ®æµ

### å¼€å¥–æµç¨‹
```
BinggoLotteryService (å®šæ—¶è½®è¯¢)
    â†“
æ£€æŸ¥æœ¬åœ°ç¼“å­˜ (SQLite)
    â†“ (æœªæ‰¾åˆ°)
è¯·æ±‚ WebAPI
    â†“
ä¿å­˜åˆ°æœ¬åœ° (BinggoLotteryDataBindingList)
    â†“
è§¦å‘ LotteryOpened äº‹ä»¶
    â†“
VxMain.OnLotteryOpened()
    â†“
BinggoOrderService.SettleOrdersAsync()
    â†“
æ›´æ–°è®¢å•å’Œä¼šå‘˜ä½™é¢
```

### ä¸‹æ³¨æµç¨‹
```
å¾®ä¿¡æ¶ˆæ¯
    â†“
MessageDispatcher
    â†“
BinggoMessageHandler.HandleAsync()
    â†“
BinggoHelper.ParseBetMessage()
    â†“
BinggoOrderValidator.Validate()
    â†“
BinggoOrderService.CreateOrderAsync()
    â†“
æ‰£é™¤ä½™é¢ + ä¿å­˜è®¢å• (ç«‹å³, åŒæ­¥)
    â†“
è¿”å›å¾®ä¿¡ç¡®è®¤æ¶ˆæ¯
```

---

## ğŸ”‘ å…³é”®ä¿®å¤

### 1. JSON åºåˆ—åŒ–ç»Ÿä¸€
- âœ… å…¨éƒ¨ä½¿ç”¨ `Newtonsoft.Json`
- âœ… `BsApiResponse.Msg`ï¼ˆä¸æ˜¯ `Message`ï¼‰

### 2. ç±»å‹å®‰å…¨
- âœ… `float` â†” `decimal` æ˜¾å¼è½¬æ¢
- âœ… å¯ç©ºå‚æ•° `SQLiteConnection?`, `BindingList?`

### 3. ORM å­—æ®µ
- âœ… `V2MemberOrder` æ–°å¢: `BetContent`, `BetAmount`, `IsSettled`, `CreatedAt`

### 4. API æ–¹æ³•
- âœ… `BsWebApiClient` å®ç°: `GetCurrentBinggoDataAsync()`, `GetBinggoDataAsync()`, etc.
- âœ… `IBinggoLotteryService` æ·»åŠ : `SetDatabase()`, `SetBindingList()`

---

## ğŸ“¦ NuGet åŒ…

```xml
<PackageReference Include="SunnyUI" Version="3.6.9" />
<PackageReference Include="Microsoft.Extensions.DependencyInjection" Version="8.0.0" />
<PackageReference Include="Microsoft.Extensions.Hosting" Version="8.0.0" />
<PackageReference Include="Microsoft.Extensions.Http" Version="8.0.0" />  <!-- âœ… æ–°å¢ -->
<PackageReference Include="CommunityToolkit.Mvvm" Version="8.2.2" />
<PackageReference Include="sqlite-net-pcl" Version="1.9.172" />
<PackageReference Include="SQLitePCLRaw.bundle_e_sqlite3" Version="2.1.10" />
<PackageReference Include="System.Data.SQLite.Core" Version="1.0.118" />
<PackageReference Include="Newtonsoft.Json" Version="13.0.3" />  <!-- âœ… ç»Ÿä¸€ä½¿ç”¨ -->
```

---

## ğŸš€ ä¸‹ä¸€æ­¥

### P1: UI æ§ä»¶ (å¾…å¼€å‘)
- [ ] `UcBinggoDataCur` - å½“å‰æœŸæ•°æ®æ˜¾ç¤º
- [ ] `UcBinggoDataLast` - ä¸ŠæœŸæ•°æ®æ˜¾ç¤º
- [ ] `UcBinggoSettings` - æ¸¸æˆé…ç½®ç•Œé¢

### P2: æµ‹è¯•
- [ ] å•å…ƒæµ‹è¯• (BinggoHelper, BinggoOrderValidator)
- [ ] é›†æˆæµ‹è¯• (å¼€å¥–æµç¨‹, ä¸‹æ³¨æµç¨‹)
- [ ] UI æµ‹è¯•

### P3: æ–‡æ¡£
- [ ] API æ¥å£æ–‡æ¡£
- [ ] ç”¨æˆ·æ“ä½œæ‰‹å†Œ
- [ ] è¿ç»´éƒ¨ç½²æ–‡æ¡£

---

## âœ… ç¼–è¯‘å’Œè¿è¡Œ

### Visual Studio
```
1. æ‰“å¼€ BaiShengVx3Plus.sln
2. Ctrl+Shift+B (é‡æ–°ç”Ÿæˆ)
3. F5 (è¿è¡Œ)
```

### å‘½ä»¤è¡Œ
```bash
cd BaiShengVx3Plus
dotnet restore
dotnet build
dotnet run
```

---

## ğŸ“ ç›¸å…³æ–‡æ¡£

- [ç¼–è¯‘é”™è¯¯ä¿®å¤è®°å½•.md](./ç¼–è¯‘é”™è¯¯ä¿®å¤è®°å½•.md) - è¯¦ç»†ä¿®å¤è¿‡ç¨‹
- [å¼€å¥–ç³»ç»Ÿæ¶æ„è®¾è®¡.md](./å¼€å¥–ç³»ç»Ÿæ¶æ„è®¾è®¡.md) - æ¶æ„å›¾å’Œè®¾è®¡ç†å¿µ
- [å¼€å¥–ç³»ç»Ÿå®ç°è®¡åˆ’.md](./å¼€å¥–ç³»ç»Ÿå®ç°è®¡åˆ’.md) - åˆ†é˜¶æ®µå®ç°è®¡åˆ’
- [ä¸ºä»€ä¹ˆä½¿ç”¨Newtonsoft.Json.md](./ä¸ºä»€ä¹ˆä½¿ç”¨Newtonsoft.Json.md) - æŠ€æœ¯é€‰å‹è¯´æ˜

---

**é¡¹ç›®çŠ¶æ€**: âœ… **ç¼–è¯‘æˆåŠŸï¼Œæ ¸å¿ƒåŠŸèƒ½å®Œæ•´ï¼Œå¯è¿›å…¥æµ‹è¯•é˜¶æ®µ**  
**æ—¥æœŸ**: 2025å¹´11æœˆ6æ—¥

