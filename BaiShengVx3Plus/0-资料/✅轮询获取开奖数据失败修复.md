# âœ… è½®è¯¢è·å–å¼€å¥–æ•°æ®å¤±è´¥ä¿®å¤

## ğŸ› ç”¨æˆ·æŠ¥å‘Šçš„é—®é¢˜

```
2025-11-07 07:26:26.395 è­¦å‘Š BinggoLotteryService âŒ è½®è¯¢è¶…æ—¶ï¼Œæœªèƒ½è·å–å¼€å¥–æ•°æ®: 114062935
```

**é—®é¢˜æè¿°**ï¼šæœåŠ¡å™¨ä¸Šå·²ç»æœ‰å¼€å¥–æ•°æ®äº†ï¼Œä½†ç³»ç»Ÿè½®è¯¢å¤šæ¬¡åä»ç„¶æ— æ³•è·å–ã€‚

---

## ğŸ” é—®é¢˜åˆ†æ

### æ ¹æœ¬åŸå› ï¼šAPI å“åº”åˆ¤æ–­é€»è¾‘ä¸å®Œå–„

æ£€æŸ¥ `BoterApi.GetBgDataAsync(int issueId)` æ–¹æ³•ï¼Œå‘ç°ä»¥ä¸‹é—®é¢˜ï¼š

#### é—®é¢˜ 1ï¼šæ²¡æœ‰æ£€æŸ¥ API è¿”å›çš„ Code å’Œ Data

**æ—§ä»£ç **ï¼ˆç¬¬ 231-232 è¡Œï¼‰ï¼š
```csharp
var apiResponse = JsonConvert.DeserializeObject<BsApiResponse<object>>(json);
if (apiResponse != null && apiResponse.Code == 0 && apiResponse.Data != null)
{
    // ç›´æ¥è§£æ ...
}
```

**é—®é¢˜**ï¼š
- æ²¡æœ‰**ä¼˜å…ˆæ£€æŸ¥ `Code`**ï¼Œç›´æ¥è¿›å…¥ `if` å—
- å¦‚æœ `Code != 0`ï¼ˆå¦‚æœªå¼€å¥–ï¼‰ï¼Œä¼šè·³è¿‡æ•´ä¸ª `if`ï¼Œç›´æ¥è¿”å› fallback çš„ `Code = -1`

---

#### é—®é¢˜ 2ï¼šæ²¡æœ‰ä¼˜å…ˆæ£€æŸ¥ `lotteryData` å­—æ®µ

**å‚è€ƒ F5BotV2** çš„ `BoterBgDataResponse`ï¼š

```csharp
public class BoterBgDataResponse
{
    public int issueid { get; set; }
    public string lotteryData { get; set; }  // ğŸ”¥ å…³é”®å­—æ®µï¼Œæ ¼å¼ï¼š"73,24,15,18,26"
    public string lottery_time { get; set; }
    public int status { get; set; }
}
```

**æ—§ä»£ç **ï¼ˆç¬¬ 236-241 è¡Œï¼‰ï¼š
```csharp
string p1 = d["p1"]?.ToString() ?? "-1";
string p2 = d["p2"]?.ToString() ?? "-1";
// ... ç›´æ¥è§£æ p1-p5
```

**é—®é¢˜**ï¼š
- F5BotV2 çš„ API è¿”å›çš„ **`lotteryData` å­—æ®µæ˜¯å®Œæ•´çš„å·ç å­—ç¬¦ä¸²**ï¼ˆå¦‚ `"73,24,15,18,26"`ï¼‰
- æˆ‘ä»¬æ²¡æœ‰ä¼˜å…ˆæ£€æŸ¥è¿™ä¸ªå­—æ®µï¼Œè€Œæ˜¯ç›´æ¥å°è¯•è§£æ `p1`-`p5`
- å½“æœªå¼€å¥–æ—¶ï¼Œ`p1`-`p5` å¯èƒ½ä¸ºç©ºï¼Œä½†æˆ‘ä»¬ä»ç„¶è®¾ç½®é»˜è®¤å€¼ `"-1"` å¹¶è°ƒç”¨ `FillLotteryData`
- è¿™å¯¼è‡´ **å³ä½¿æ•°æ®æ— æ•ˆï¼Œä»ç„¶è¿”å› `Code=0`ï¼Œä½† `IsOpened=false`**

---

#### é—®é¢˜ 3ï¼šæ²¡æœ‰æ£€æŸ¥ `IsOpened` å­—æ®µ

**æ—§ä»£ç **ï¼ˆç¬¬ 241-252 è¡Œï¼‰ï¼š
```csharp
var bgData = new BinggoLotteryData().FillLotteryData(
    issueId, 
    $"{p1},{p2},{p3},{p4},{p5}", 
    lotteryTime
);

return new BsApiResponse<BinggoLotteryData>
{
    Code = 0,  // ğŸ”¥ é—®é¢˜ï¼šå³ä½¿æœªå¼€å¥–ä¹Ÿè¿”å› Code=0
    Msg = "æˆåŠŸ",
    Data = bgData
};
```

**é—®é¢˜**ï¼š
- `FillLotteryData` ä¼šæ ¹æ®å·ç å­—ç¬¦ä¸²åˆ¤æ–­ `IsOpened`ï¼ˆå¦‚æœå·ç æ˜¯ `-1,-1,-1,-1,-1` åˆ™ `IsOpened=false`ï¼‰
- ä½†æˆ‘ä»¬æ²¡æœ‰æ£€æŸ¥ `bgData.IsOpened`ï¼Œç›´æ¥è¿”å› `Code=0`
- è¿™å¯¼è‡´ `BinggoLotteryService.LoadPreviousLotteryDataAsync` è½®è¯¢é€»è¾‘ä¸­çš„åˆ¤æ–­å¤±è´¥ï¼š

```csharp
if (response.Code == 0 && response.Data != null && response.Data.IsOpened)
{
    // åªæœ‰åŒæ—¶æ»¡è¶³ä¸‰ä¸ªæ¡ä»¶æ‰è¿”å›ï¼Œå¦åˆ™ç»§ç»­è½®è¯¢
}
```

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ 1ï¼šå…ˆæ£€æŸ¥ API è¿”å›çš„ Code

å‚è€ƒ F5BotV2 çš„é€»è¾‘ï¼Œå…ˆæ£€æŸ¥ `Code != 0` æˆ– `Data == null`ï¼Œç›´æ¥è¿”å›å¤±è´¥ï¼š

```csharp
var apiResponse = JsonConvert.DeserializeObject<BsApiResponse<object>>(json);

// ğŸ”¥ ä¿®å¤ï¼šå‚è€ƒ F5BotV2ï¼Œå…ˆæ£€æŸ¥ code
if (apiResponse == null || apiResponse.Code != 0)
{
    Console.WriteLine($"âš ï¸ API è¿”å›å¤±è´¥: Code={apiResponse?.Code}, Msg={apiResponse?.Msg}");
    return new BsApiResponse<BinggoLotteryData>
    {
        Code = apiResponse?.Code ?? -1,
        Msg = apiResponse?.Msg ?? "APIè°ƒç”¨å¤±è´¥"
    };
}

// ğŸ”¥ ä¿®å¤ï¼šæ£€æŸ¥ data æ˜¯å¦ä¸ºç©º
if (apiResponse.Data == null)
{
    Console.WriteLine($"âš ï¸ æœŸå· {issueId} æ•°æ®ä¸ºç©ºï¼ˆdata=nullï¼‰");
    return new BsApiResponse<BinggoLotteryData>
    {
        Code = -1,
        Msg = "æ•°æ®ä¸ºç©º"
    };
}
```

---

### ä¿®å¤ 2ï¼šä¼˜å…ˆæ£€æŸ¥ `lotteryData` å­—æ®µ

å‚è€ƒ F5BotV2 çš„ API å“åº”ç»“æ„ï¼Œä¼˜å…ˆä½¿ç”¨ `lotteryData` å­—æ®µï¼š

```csharp
JObject d = JObject.Parse(apiResponse.Data.ToString()!);

// ğŸ”¥ ä¿®å¤ï¼šå‚è€ƒ F5BotV2ï¼Œä¼˜å…ˆæ£€æŸ¥ lotteryData å­—æ®µ
string lotteryDataStr = d["lotteryData"]?.ToString() ?? "";

if (!string.IsNullOrEmpty(lotteryDataStr))
{
    // ğŸ”¥ æ–¹å¼1ï¼šä½¿ç”¨ lotteryData å­—æ®µï¼ˆä¸ F5BotV2 å®Œå…¨ä¸€è‡´ï¼‰
    string lotteryTime = d["lottery_time"]?.ToString() ?? "";
    
    Console.WriteLine($"ğŸ“Š è§£æ lotteryData: {lotteryDataStr}, time={lotteryTime}");
    
    var bgData = new BinggoLotteryData().FillLotteryData(
        issueId, 
        lotteryDataStr, 
        lotteryTime
    );
    
    if (bgData.IsOpened)
    {
        Console.WriteLine($"âœ… å¼€å¥–æ•°æ®è§£ææˆåŠŸ: {issueId} - {bgData.ToLotteryString()}");
        return new BsApiResponse<BinggoLotteryData>
        {
            Code = 0,
            Msg = "æˆåŠŸ",
            Data = bgData
        };
    }
    else
    {
        Console.WriteLine($"âš ï¸ æœŸå· {issueId} æœªå¼€å¥–ï¼ˆIsOpened=falseï¼‰");
        return new BsApiResponse<BinggoLotteryData>
        {
            Code = -1,
            Msg = "æœªå¼€å¥–"
        };
    }
}
```

---

### ä¿®å¤ 3ï¼šå…œåº•æ–¹æ¡ˆï¼Œè§£æ `p1-p5` å¹¶æ£€æŸ¥æœ‰æ•ˆæ€§

å¦‚æœ API å“åº”ä¸­æ²¡æœ‰ `lotteryData` å­—æ®µï¼Œå°è¯•è§£æ `p1`-`p5`ï¼š

```csharp
else
{
    // ğŸ”¥ æ–¹å¼2ï¼šå…œåº•ï¼Œå°è¯•è§£æ p1-p5 å­—æ®µ
    string p1 = d["p1"]?.ToString() ?? "";
    string p2 = d["p2"]?.ToString() ?? "";
    string p3 = d["p3"]?.ToString() ?? "";
    string p4 = d["p4"]?.ToString() ?? "";
    string p5 = d["p5"]?.ToString() ?? "";
    string lotteryTime = d["lottery_time"]?.ToString() ?? "";
    
    Console.WriteLine($"ğŸ“Š è§£æ p1-p5: {p1},{p2},{p3},{p4},{p5}, time={lotteryTime}");
    
    // ğŸ”¥ æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å·ç éƒ½ä¸ºç©ºæˆ–æ— æ•ˆï¼ˆè¡¨ç¤ºæœªå¼€å¥–ï¼‰
    if (string.IsNullOrEmpty(p1) || string.IsNullOrEmpty(p2) || 
        string.IsNullOrEmpty(p3) || string.IsNullOrEmpty(p4) || 
        string.IsNullOrEmpty(p5))
    {
        Console.WriteLine($"âš ï¸ æœŸå· {issueId} æœªå¼€å¥–ï¼ˆå·ç ä¸ºç©ºï¼‰");
        return new BsApiResponse<BinggoLotteryData>
        {
            Code = -1,
            Msg = "æœªå¼€å¥–"
        };
    }
    
    var bgData = new BinggoLotteryData().FillLotteryData(
        issueId, 
        $"{p1},{p2},{p3},{p4},{p5}", 
        lotteryTime
    );
    
    if (bgData.IsOpened)
    {
        Console.WriteLine($"âœ… å¼€å¥–æ•°æ®è§£ææˆåŠŸ: {issueId} - {bgData.ToLotteryString()}");
        return new BsApiResponse<BinggoLotteryData>
        {
            Code = 0,
            Msg = "æˆåŠŸ",
            Data = bgData
        };
    }
    else
    {
        Console.WriteLine($"âš ï¸ æœŸå· {issueId} æœªå¼€å¥–ï¼ˆFillLotteryData å IsOpened=falseï¼‰");
        return new BsApiResponse<BinggoLotteryData>
        {
            Code = -1,
            Msg = "æœªå¼€å¥–"
        };
    }
}
```

---

## ğŸ”„ ä¿®å¤åçš„å®Œæ•´æµç¨‹

```
1ï¸âƒ£ æœŸå·å˜æ›´ï¼Œè§¦å‘è½®è¯¢ï¼ˆBinggoLotteryService.LoadPreviousLotteryDataAsyncï¼‰
   â†“
2ï¸âƒ£ è°ƒç”¨ BoterApi.GetBgDataAsync(issueId)
   â”œâ”€ æ£€æŸ¥ apiResponse.Code != 0ï¼Ÿ
   â”‚  â””â”€ æ˜¯ â†’ è¿”å› Code=-1, Msg="APIè°ƒç”¨å¤±è´¥" âŒ
   â”œâ”€ æ£€æŸ¥ apiResponse.Data == nullï¼Ÿ
   â”‚  â””â”€ æ˜¯ â†’ è¿”å› Code=-1, Msg="æ•°æ®ä¸ºç©º" âŒ
   â”œâ”€ è§£æ JObject
   â”œâ”€ æ£€æŸ¥ d["lotteryData"] æ˜¯å¦å­˜åœ¨ï¼Ÿ
   â”‚  â”œâ”€ æ˜¯ â†’ ä½¿ç”¨ lotteryData å­—æ®µï¼ˆF5BotV2 æ ‡å‡†ï¼‰âœ…
   â”‚  â””â”€ å¦ â†’ å°è¯•è§£æ p1-p5 å­—æ®µ âœ…
   â”œâ”€ è°ƒç”¨ FillLotteryData
   â”œâ”€ æ£€æŸ¥ bgData.IsOpenedï¼Ÿ
   â”‚  â”œâ”€ true â†’ è¿”å› Code=0, Data=bgData âœ…
   â”‚  â””â”€ false â†’ è¿”å› Code=-1, Msg="æœªå¼€å¥–" âŒ
   â†“
3ï¸âƒ£ BinggoLotteryService åˆ¤æ–­å“åº”
   â”œâ”€ Code=0 && Data!=null && Data.IsOpenedï¼Ÿ
   â”‚  â”œâ”€ true â†’ ä¿å­˜æ•°æ®åº“ï¼Œè§¦å‘ LotteryOpened äº‹ä»¶ âœ…
   â”‚  â””â”€ false â†’ ç­‰å¾… 5 ç§’åé‡è¯• â³
   â†“
4ï¸âƒ£ æœ€å¤šé‡è¯• 12 æ¬¡ï¼ˆ60ç§’ï¼‰
   â”œâ”€ æˆåŠŸ â†’ æ˜¾ç¤ºåœ¨ UcBinggoDataLast âœ…
   â””â”€ å¤±è´¥ â†’ æ˜¾ç¤º "â³ å¼€ å¥– ä¸­ â³" + é—ªçƒåŠ¨ç”» âš ï¸
```

---

## ğŸ“Š å¯¹æ¯”ï¼šä¿®å¤å‰ vs ä¿®å¤å

| åœºæ™¯ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| **API è¿”å› Code=10001 "è¯·ç™»å½•"** | âš ï¸ è·³è¿‡ `if` å—ï¼Œè¿”å› fallback `Code=-1` | âœ… æ˜ç¡®æ£€æŸ¥å¹¶è¿”å› `Code=-1, Msg="è¯·ç™»å½•"` |
| **API è¿”å› Data=null** | âš ï¸ è·³è¿‡ `if` å—ï¼Œè¿”å› fallback `Code=-1` | âœ… æ˜ç¡®æ£€æŸ¥å¹¶è¿”å› `Code=-1, Msg="æ•°æ®ä¸ºç©º"` |
| **API è¿”å› lotteryData="73,24,15,18,26"** | âš ï¸ å¿½ç•¥ `lotteryData`ï¼Œè§£æ `p1-p5`ï¼ˆå¯èƒ½å¤±è´¥ï¼‰ | âœ… ä¼˜å…ˆä½¿ç”¨ `lotteryData` å­—æ®µï¼ˆF5BotV2 æ ‡å‡†ï¼‰ |
| **API è¿”å› p1-p5 ä¸ºç©ºæˆ– null** | âš ï¸ è®¾ç½®ä¸º `"-1"`ï¼Œä»ç„¶è¿”å› `Code=0` | âœ… æ£€æŸ¥ä¸ºç©ºï¼Œè¿”å› `Code=-1, Msg="æœªå¼€å¥–"` |
| **FillLotteryData å IsOpened=false** | âš ï¸ ä»ç„¶è¿”å› `Code=0`ï¼Œå¯¼è‡´è½®è¯¢é€»è¾‘åˆ¤æ–­å¤±è´¥ | âœ… æ£€æŸ¥ `IsOpened`ï¼Œè¿”å› `Code=-1, Msg="æœªå¼€å¥–"` |

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### æµ‹è¯•åœºæ™¯ 1ï¼šæ­£å¸¸è·å–å¼€å¥–æ•°æ®

1. ç­‰å¾…å½“å‰æœŸå·å¼€å¥–ï¼ˆçº¦ 5 åˆ†é’Ÿï¼‰
2. è§‚å¯Ÿæ—¥å¿—ï¼š
   ```
   ğŸ“¡ GetBgData(114062935) API å“åº”: {"code":0,"data":{...}}
   ğŸ“Š è§£æ lotteryData: 73,24,15,18,26, time=2025-11-07 07:21:00
   âœ… å¼€å¥–æ•°æ®è§£ææˆåŠŸ: 114062935 - 73,24,15,18,26
   ```
3. æ£€æŸ¥ `UcBinggoDataLast`ï¼š
   - âœ… æ˜¾ç¤ºå®Œæ•´çš„ 5 ä¸ªå·ç 
   - âœ… æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯ï¼ˆå¦‚ "å°åŒ|é¾™"ï¼‰

---

### æµ‹è¯•åœºæ™¯ 2ï¼šæœªå¼€å¥–æ—¶çš„è½®è¯¢

1. åœ¨å½“å‰æœŸå·åˆ‡æ¢æ—¶ç«‹å³è§‚å¯Ÿï¼ˆå‰ 10 ç§’ï¼‰
2. è§‚å¯Ÿæ—¥å¿—ï¼š
   ```
   ğŸ“¡ ç¬¬ 1/12 æ¬¡è¯·æ±‚å¼€å¥–æ•°æ®: 114062935
   ğŸ“¡ GetBgData(114062935) API å“åº”: {"code":10001,"msg":"è¯·ç™»å½•"}
   âš ï¸ API è¿”å›å¤±è´¥: Code=10001, Msg=è¯·ç™»å½•
   â³ æš‚æ— å¼€å¥–æ•°æ®ï¼Œ5ç§’åé‡è¯•...
   ```
3. æ£€æŸ¥ `UcBinggoDataLast`ï¼š
   - âœ… æ˜¾ç¤ºæœŸå·å’Œå¼€å¥–æ—¶é—´
   - âœ… æ˜¾ç¤º "ğŸ² å¼€ å¥– ä¸­ ğŸ²"
   - âœ… å·ç ä½ç½®æ˜¾ç¤ºé—ªçƒçš„ "âœ±"

---

### æµ‹è¯•åœºæ™¯ 3ï¼šAPI è¿”å› Data=null

1. æ¨¡æ‹Ÿ API è¿”å› `{"code":0, "data":null}`
2. è§‚å¯Ÿæ—¥å¿—ï¼š
   ```
   ğŸ“¡ GetBgData(114062935) API å“åº”: {"code":0,"data":null}
   âš ï¸ æœŸå· 114062935 æ•°æ®ä¸ºç©ºï¼ˆdata=nullï¼‰
   ```
3. ç¡®è®¤ä¸ä¼šå´©æºƒï¼Œç»§ç»­è½®è¯¢

---

## ğŸ“ æ³¨æ„äº‹é¡¹

### âš ï¸ æ—¥å¿—å¢å¼º

ä¿®å¤åå¢åŠ äº†å¤§é‡ `Console.WriteLine` æ—¥å¿—ï¼Œä¾¿äºè°ƒè¯•ï¼š
- `ğŸ“¡ GetBgData({issueId}) API å“åº”: {json}`
- `ğŸ“Š è§£æ lotteryData: {lotteryDataStr}, time={lotteryTime}`
- `âš ï¸ æœŸå· {issueId} æœªå¼€å¥–ï¼ˆIsOpened=falseï¼‰`

**å»ºè®®**ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œè¿™äº›æ—¥å¿—å¯ä»¥ä¿ç•™ï¼Œå› ä¸ºå®ƒä»¬å¯¹äºæ’æŸ¥é—®é¢˜éå¸¸æœ‰ä»·å€¼ã€‚

---

### âš ï¸ F5BotV2 API å“åº”æ ¼å¼

æ ¹æ® F5BotV2 çš„ä»£ç åˆ†æï¼Œ`getbgData` æ¥å£è¿”å›çš„ JSON ç»“æ„ï¼š

```json
{
  "code": 0,
  "msg": "æˆåŠŸ",
  "data": {
    "issueid": 114062935,
    "lotteryData": "73,24,15,18,26",  // ğŸ”¥ å…³é”®å­—æ®µ
    "lottery_time": "2025-11-07 07:21:00",
    "status": 1,
    "date": "2025-11-07",
    "issue_day_index": 179
  }
}
```

**æˆ–è€…**ï¼ˆå½“ä½¿ç”¨ `p1-p5` å­—æ®µæ—¶ï¼‰ï¼š

```json
{
  "code": 0,
  "msg": "æˆåŠŸ",
  "data": {
    "issueid": 114062935,
    "p1": "73",
    "p2": "24",
    "p3": "15",
    "p4": "18",
    "p5": "26",
    "lottery_time": "2025-11-07 07:21:00"
  }
}
```

æˆ‘ä»¬çš„ä¿®å¤åŒæ—¶å…¼å®¹äº†è¿™ä¸¤ç§æ ¼å¼ï¼

---

## âœ… ç¼–è¯‘çŠ¶æ€

**ä¿®å¤å®Œæˆçš„æ–‡ä»¶**ï¼š
1. âœ… `BaiShengVx3Plus/Services/Api/BoterApi.cs`

**è¯·å…³é—­ç¨‹åºåé‡æ–°ç¼–è¯‘æµ‹è¯•ï¼**

---

**ğŸ‰ è½®è¯¢è·å–å¼€å¥–æ•°æ®å¤±è´¥é—®é¢˜å·²ä¿®å¤ï¼è¯·æµ‹è¯•å¹¶è§‚å¯Ÿæ—¥å¿—ï¼**

