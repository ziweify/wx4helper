# 联系人列表不显示问题诊断

> **问题描述**：启动程序后能自动连接获取到 UserInfo，但是联系人列表不显示在 dgvContacts 中，也没有保存到数据库。

---

## 🔍 问题诊断步骤

### 1. 检查日志

**打开日志窗口**（点击"日志"按钮），查找以下关键信息：

#### ✅ 应该看到的日志（正常流程）

```
[WeChatService] ========== 开始连接和初始化流程 ==========
[WeChatService] 成功注入到进程 XXXX
[WeChatService] Socket 连接成功
[WeChatService] 获取用户信息（第 1 次尝试）
[WeChatService] ✓ 用户信息获取成功: {昵称} ({wxid})
[UserInfoService] 用户信息已更新: {昵称} ({wxid})
[WeChatService] 初始化数据库，wxid: {wxid}
[ContactDataService] 设置当前微信 ID: {wxid}         <-- ✅ 关键1
[WeChatService] 开始刷新联系人列表
[WeChatService] ✓ 联系人刷新成功，共 X 个             <-- ✅ 关键2
[ContactDataService] 开始处理联系人数据
[ContactDataService] 解析到 X 个联系人               <-- ✅ 关键3
[ContactDataService] 联系人数据已保存到数据库        <-- ✅ 关键4
[VxMain] 📇 联系人数据已更新，共 X 个               <-- ✅ 关键5
[VxMain] 联系人列表已更新到 UI                      <-- ✅ 关键6
[WeChatService] ========== 连接和初始化流程完成 ==========
```

#### ❌ 可能看到的错误日志

**错误1：wxid 未设置**
```
[ContactDataService] 当前微信 ID 为空，无法保存联系人
```
→ **原因**：`SetCurrentWxid` 没有被调用  
→ **检查**：查看 `WeChatService.ConnectAndInitializeAsync` 第 96 行是否执行

**错误2：获取联系人失败**
```
[WeChatService] 获取联系人失败
```
→ **原因**：Socket 请求 `GetContacts` 返回 null  
→ **检查**：查看 C++ 服务器日志，检查数据库句柄

**错误3：解析失败**
```
[ContactDataService] 处理联系人数据失败
```
→ **原因**：JSON 解析异常  
→ **检查**：查看详细异常信息

**错误4：数据库保存失败**
```
[ContactDataService] 保存联系人到数据库失败
```
→ **原因**：数据库连接或表创建失败  
→ **检查**：查看数据库文件是否存在

---

### 2. 检查数据库

**打开数据库文件**：
```
路径：BaiShengVx3Plus/bin/Release/net8.0-windows/business.db
工具：DB Browser for SQLite 或其他 SQLite 工具
```

**检查表是否存在**：
```sql
-- 应该看到这个表
contacts_{wxid}

-- 例如：
contacts_wxid_abc123
```

**检查表中是否有数据**：
```sql
SELECT COUNT(*) FROM contacts_{wxid};
```

**如果表不存在** → 说明 `InitializeBusinessDatabaseAsync` 没有正确执行  
**如果表存在但无数据** → 说明 `SaveContactsAsync` 没有正确执行  
**如果表有数据但 UI 不显示** → 说明事件或 UI 更新有问题

---

### 3. 检查代码执行流程

**在以下位置添加断点调试**：

#### 断点1：`WeChatService.cs` 第 100 行
```csharp
var contacts = await RefreshContactsAsync(cancellationToken);
```
→ **检查**：`contacts.Count` 是否 > 0

#### 断点2：`ContactDataService.cs` 第 46 行
```csharp
var contacts = ParseContacts(data);
```
→ **检查**：`data` 是否包含有效的 JSON 数据

#### 断点3：`ContactDataService.cs` 第 50 行
```csharp
await SaveContactsAsync(contacts);
```
→ **检查**：进入这个方法后，`_currentWxid` 是否为空

#### 断点4：`ContactDataService.cs` 第 53 行
```csharp
ContactsUpdated?.Invoke(this, new ContactsUpdatedEventArgs { ... });
```
→ **检查**：事件是否有订阅者（`ContactsUpdated` 不为 null）

#### 断点5：`VxMain.cs` 第 716 行
```csharp
UpdateContactsList(e.Contacts);
```
→ **检查**：`e.Contacts.Count` 是否 > 0

---

### 4. 常见问题和解决方案

#### 问题A：wxid 未设置

**症状**：
- 日志显示 "当前微信 ID 为空，无法保存联系人"
- 数据库中没有 `contacts_{wxid}` 表

**原因**：
- `WeChatService.ConnectAndInitializeAsync` 第 96 行没有执行
- 或者 `userInfo.Wxid` 为空

**解决方案**：
1. 检查 `RefreshUserInfoAsync` 是否正确获取了 wxid
2. 确保第 96 行 `_contactDataService.SetCurrentWxid(userInfo.Wxid);` 被执行
3. 添加日志确认：
```csharp
_logService.Info("WeChatService", $"即将设置 wxid: {userInfo.Wxid}");
_contactDataService.SetCurrentWxid(userInfo.Wxid);
_logService.Info("WeChatService", "wxid 设置完成");
```

#### 问题B：GetContacts 返回空数据

**症状**：
- 日志显示 "获取联系人失败"
- 或者 "解析到 0 个联系人"

**原因**：
- C++ 服务器 `GetContacts` 返回了 null 或空数组
- 可能是数据库句柄未初始化

**解决方案**：
1. 检查 C++ 日志，看是否有 "contact.db handle is null" 错误
2. 确保 C++ 服务器的 `GetContacts` 实现正确
3. 在 C++ `HandleGetContacts` 中添加防御性检查

#### 问题C：事件未触发

**症状**：
- 日志显示 "解析到 X 个联系人"
- 但没有 "联系人数据已更新到 UI"

**原因**：
- `ContactsUpdated` 事件没有订阅者
- 或者事件触发失败

**解决方案**：
1. 检查 `VxMain` 构造函数中是否有：
```csharp
_contactDataService.ContactsUpdated += ContactDataService_ContactsUpdated;
```
2. 确保订阅在 `InitializeComponent()` 之后

#### 问题D：UI 不更新

**症状**：
- 日志显示所有步骤都成功
- 数据库中有数据
- 但 dgvContacts 仍然为空

**原因**：
- UI 更新在非 UI 线程执行
- 或者 `_contactsBindingList` 未绑定到 `dgvContacts`

**解决方案**：
1. 确保 `dgvContacts.DataSource = _contactsBindingList;` 在 `InitializeDataBindings` 中执行
2. 确保使用了 `Invoke` 切换到 UI 线程
3. 检查 `dgvContacts` 的可见性和数据绑定

---

### 5. 快速测试方法

#### 测试1：手动触发刷新

1. 启动程序，等待自动连接完成
2. 点击"刷新"按钮（在联系人列表旁边）
3. 查看日志和 dgvContacts

**预期**：应该显示联系人列表

#### 测试2：检查数据库

1. 关闭程序
2. 使用 SQLite 工具打开 `business.db`
3. 查找 `contacts_{wxid}` 表
4. 执行：`SELECT * FROM contacts_{wxid} LIMIT 10;`

**预期**：应该能看到联系人数据

#### 测试3：查看日志

1. 启动程序后立即点击"日志"按钮
2. 查找关键日志行（见上面"应该看到的日志"）
3. 定位第一个缺失或错误的日志

**预期**：所有关键日志都应该出现

---

### 6. 调试建议

#### 方法1：添加额外日志

在 `WeChatService.cs` 第 100 行后添加：
```csharp
var contacts = await RefreshContactsAsync(cancellationToken);
_logService.Info("WeChatService", $"✓✓✓ DEBUG: 获取到 {contacts.Count} 个联系人，准备记录前3个");
for (int i = 0; i < Math.Min(3, contacts.Count); i++)
{
    _logService.Info("WeChatService", $"  联系人 {i+1}: {contacts[i].Wxid} - {contacts[i].Nickname}");
}
```

#### 方法2：检查服务注入

在 `Program.cs` 中确认所有服务都已注册：
```csharp
services.AddSingleton<IWeChatService, WeChatService>();           // ✅
services.AddSingleton<IContactDataService, ContactDataService>(); // ✅
services.AddSingleton<IUserInfoService, UserInfoService>();       // ✅
```

#### 方法3：简化测试

创建一个测试按钮，只调用联系人刷新：
```csharp
private async void btnTestContacts_Click(object sender, EventArgs e)
{
    _logService.Info("Test", "===== 开始测试联系人功能 =====");
    
    // 1. 检查 wxid
    var currentUser = _userInfoService.CurrentUser;
    _logService.Info("Test", $"当前用户 wxid: {currentUser.Wxid}");
    
    // 2. 手动设置 wxid
    if (!string.IsNullOrEmpty(currentUser.Wxid))
    {
        _contactDataService.SetCurrentWxid(currentUser.Wxid);
        _logService.Info("Test", "wxid 已设置");
    }
    
    // 3. 调用刷新
    var contacts = await _wechatService.RefreshContactsAsync();
    _logService.Info("Test", $"刷新结果：{contacts.Count} 个联系人");
    
    _logService.Info("Test", "===== 测试完成 =====");
}
```

---

## 🎯 最可能的原因

根据经验，最常见的原因是：

### 1. wxid 未设置（70% 可能性）

**检查**：
```
日志中是否有 "设置当前微信 ID: wxid_xxx"
```

**如果没有** → `SetCurrentWxid` 没有被调用

### 2. 事件未触发（20% 可能性）

**检查**：
```
日志中是否有 "📇 联系人数据已更新"
```

**如果没有** → 事件订阅有问题

### 3. GetContacts 返回空（10% 可能性）

**检查**：
```
日志中是否有 "解析到 0 个联系人"
```

**如果是** → C++ 服务器问题

---

## 📝 请提供以下信息

为了更准确地诊断问题，请提供：

1. **日志内容**（从启动到连接完成的所有日志）
2. **数据库文件**（`business.db` 中是否有 `contacts_{wxid}` 表）
3. **具体的错误信息**（如果有的话）
4. **dgvContacts 的行数**（右下角状态栏应该显示）

---

## ✅ 解决方案检查清单

- [ ] 日志中有 "设置当前微信 ID: wxid_xxx"
- [ ] 日志中有 "解析到 X 个联系人"（X > 0）
- [ ] 日志中有 "联系人数据已保存到数据库"
- [ ] 日志中有 "📇 联系人数据已更新"
- [ ] 日志中有 "联系人列表已更新到 UI"
- [ ] 数据库中有 `contacts_{wxid}` 表
- [ ] `contacts_{wxid}` 表中有数据
- [ ] dgvContacts 显示数据

**如果所有日志都有，但 UI 不显示** → UI 绑定问题  
**如果缺少某个日志** → 该步骤执行失败

---

**请查看日志并告诉我哪一步失败了！** 🔍

