# 收单开关作用范围说明

## 📋 功能定义

**收单开关**（`IsOrdersTaskingEnabled`）用于控制是否接受会员的 **投注订单**。

## ✅ 受收单开关影响的操作

当收单开关 **关闭** 时，以下操作会被阻止：

| 操作类型 | 示例 | 是否阻止 |
|---------|------|----------|
| **投注订单** | `1大10`、`123大20`、`12大10小15` | ❌ **阻止** |

## ✅ 不受收单开关影响的操作

当收单开关 **关闭** 时，以下操作 **仍然允许**：

| 操作类型 | 示例 | 是否阻止 |
|---------|------|----------|
| **上分申请** | `上100`、`上5000` | ✅ **允许** |
| **下分申请** | `下100`、`下5000` | ✅ **允许** |
| **查询命令** | `查`、`流水`、`货单` | ✅ **允许** |
| **取消订单** | `取消`、`qx` | ✅ **允许** |

## 🎯 设计原则

**参考 F5BotV2**：
- 收单开关 **只控制投注行为**
- 财务操作（上下分）**不受影响**
- 管理功能（查询、取消）**不受影响**

## 🔧 实现位置

**`BaiShengVx3Plus/Services/Messages/Handlers/BinggoMessageHandler.cs`**

```csharp
// 🔥 检查是否为上下分命令（上下分不受收单开关影响）
string trimmedMsg = messageContent.Trim();
bool isCreditWithdrawCommand = Regex.IsMatch(trimmedMsg, @"^[上下]\d+$");

// ✅ 检查是否开启收单
if(!IsOrdersTaskingEnabled && !isCreditWithdrawCommand)
{
    // 🔥 如果是查询或取消命令，也允许通过
    if (trimmedMsg != "查" && trimmedMsg != "流水" && trimmedMsg != "货单" && 
        trimmedMsg != "取消" && trimmedMsg != "qx")
    {
        return (false, null);  // 只阻止投注消息
    }
}
```

## 📊 应用场景

### 场景1：临时关闭收单

**情况**：某期开奖延迟，管理员临时关闭收单

**效果**：
- ❌ 会员无法下注新订单
- ✅ 会员仍然可以申请上下分
- ✅ 会员仍然可以查询账户信息
- ✅ 会员仍然可以取消已有订单

### 场景2：日终结算

**情况**：当天最后一期结束，管理员关闭收单进行结算

**效果**：
- ❌ 会员无法下注新订单（已封盘）
- ✅ 会员可以查询今日流水
- ✅ 会员可以申请下分提现

## 🔍 验证方法

### 测试步骤

1. **关闭收单开关**（`VxMain` 右上角）
2. **测试投注**：发送 `1大10`
   - 期望：❌ 无反应（被阻止）
3. **测试上分**：发送 `上100`
   - 期望：✅ 成功，并播放上分声音
4. **测试查询**：发送 `查`
   - 期望：✅ 返回账户信息
5. **测试取消**：发送 `取消`
   - 期望：✅ 取消订单（如果有）

## 📝 历史问题

### 2025-11-19 修复前

**问题**：收单开关关闭时，**所有消息**（包括上下分）都被阻止

**影响**：
- ❌ 会员无法申请上下分
- ❌ 上下分声音不播放（因为代码根本没执行到）
- ❌ 开发模式有声音，正常模式无声音（因为开发模式跳过了收单检查）

### 2025-11-19 修复后

**修复**：细化收单开关的作用范围，只阻止投注消息

**改进**：
- ✅ 上下分不受收单开关影响
- ✅ 查询、取消不受收单开关影响
- ✅ 符合 F5BotV2 的设计原则

---

**文档创建时间**：2025-11-19  
**相关修复报告**：[🔥上下分声音被收单开关阻止问题修复报告.md](./🔥上下分声音被收单开关阻止问题修复报告.md)

