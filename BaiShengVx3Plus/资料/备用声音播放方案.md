# 🔊 备用声音播放方案（MediaPlayer）

## 方案说明

如果 `MP3Play`（MCI）无法正常工作，可以切换到 `System.Windows.Media.MediaPlayer`。

---

## 实现步骤

### 1. 修改项目文件

在 `BaiShengVx3Plus.csproj` 中添加引用：

```xml
<ItemGroup>
  <Reference Include="PresentationCore" />
  <Reference Include="WindowsBase" />
</ItemGroup>
```

---

### 2. 修改 SoundService.cs

```csharp
using System.Windows.Media;  // 添加引用

namespace BaiShengVx3Plus.Services.Sound
{
    public class SoundService
    {
        private readonly ILogService _logService;
        private readonly string _soundDirectory;
        
        // 🔥 使用 MediaPlayer 代替 MP3Play
        private MediaPlayer? _currentPlayer;

        public SoundService(ILogService logService)
        {
            _logService = logService;
            _soundDirectory = Path.Combine(Application.StartupPath, "sound");
            _logService.Info("SoundService", $"声音目录: {_soundDirectory}");
        }

        public void PlayMp3(string fileName)
        {
            try
            {
                string filePath = Path.Combine(_soundDirectory, fileName);
                
                _logService.Info("SoundService", $"🔊 准备播放声音: {fileName}");
                
                if (!File.Exists(filePath))
                {
                    _logService.Warning("SoundService", $"⚠️ 声音文件不存在: {filePath}");
                    return;
                }
                
                // 🔥 停止当前播放（如果有）
                if (_currentPlayer != null)
                {
                    try
                    {
                        _currentPlayer.Stop();
                        _currentPlayer.Close();
                    }
                    catch { }
                }
                
                // 🔥 创建新的 MediaPlayer 并播放
                _currentPlayer = new MediaPlayer();
                _currentPlayer.Open(new Uri(filePath, UriKind.Absolute));
                _currentPlayer.Play();
                
                _logService.Info("SoundService", $"✅ 声音播放已启动: {fileName}");
            }
            catch (Exception ex)
            {
                _logService.Error("SoundService", $"播放声音失败: {fileName}", ex);
            }
        }

        public void PlaySealingSound() => PlayMp3("mp3_fp.mp3");
        public void PlayLotterySound() => PlayMp3("mp3_kj.mp3");
        public void PlayCreditUpSound() => PlayMp3("mp3_shang.mp3");
        public void PlayCreditDownSound() => PlayMp3("mp3_xia.mp3");
    }
}
```

---

## 优缺点

### ✅ 优点

- **跨平台**：支持 .NET 8.0
- **稳定**：微软官方库，不依赖 Windows MCI
- **功能强大**：支持 MP3、WAV、WMA 等多种格式

### ❌ 缺点

- **引用较大**：需要引用 `PresentationCore.dll` 和 `WindowsBase.dll`
- **依赖 WPF**：虽然是 WinForms 项目，但需要部分 WPF 组件

---

## 测试步骤

1. 修改 `BaiShengVx3Plus.csproj`
2. 修改 `SoundService.cs`
3. 重新编译
4. 测试上下分功能，确认声音是否正常

---

**创建时间**：2025-11-18 15:40  
**状态**：⏳ 备用方案（如果 MP3Play 无法修复）

