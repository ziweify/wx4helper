# 🔊 设置窗口声音测试功能说明

## 📋 功能概述

在"设置"窗口中新增了"其他"选项卡，提供声音测试功能，方便用户诊断声音播放问题。

---

## 🎯 功能位置

**路径**：主菜单 → 设置 → 其他 → 声音测试

**快捷方式**：
1. 点击主窗口顶部的"设置"按钮
2. 切换到"其他"选项卡
3. 在"声音测试"区域点击测试按钮

---

## 🔘 测试按钮

| 按钮 | 功能 | 测试文件 |
|------|------|----------|
| 🔔 测试封盘声音 | 播放封盘提示音 | `sound/mp3_fp.mp3` |
| 🎲 测试开奖声音 | 播放开奖提示音 | `sound/mp3_kj.mp3` |
| 💰 测试上分声音 | 播放上分提示音 | `sound/mp3_shang.mp3` |
| 💸 测试下分声音 | 播放下分提示音 | `sound/mp3_xia.mp3` |

---

## 📊 测试结果显示

点击测试按钮后，窗口下方会显示详细的测试结果：

### ✅ 成功示例
```
✅ 上分声音播放命令已发送

文件路径: D:\程序目录\sound\mp3_shang.mp3
文件存在: 是

如果听不到声音，请检查：
1. sound文件夹是否存在
2. mp3_shang.mp3文件是否存在
3. 系统音量是否开启
```

### ❌ 失败示例
```
❌ 声音服务未初始化

请检查程序是否正确启动。
```

---

## 🔍 故障排查

### 问题1：声音服务未初始化

**症状**：点击测试按钮，提示"声音服务未初始化"

**原因**：
- 程序启动时声音服务未正确初始化
- 依赖注入配置缺失

**解决方案**：
1. 重启程序
2. 检查 `Program.cs` 中的 `services.AddSingleton<Services.Sound.SoundService>();`

### 问题2：文件不存在

**症状**：测试结果显示"文件存在: 否"

**原因**：
- `sound` 文件夹不存在
- MP3 文件未复制到输出目录

**解决方案**：
1. 手动复制 `sound` 文件夹到程序所在目录
2. 确保 `BaiShengVx3Plus.csproj` 包含以下配置：
   ```xml
   <None Include="sound\*.mp3">
     <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
   </None>
   ```
3. 重新编译项目：
   ```powershell
   cd D:\gitcode\wx4helper\BaiShengVx3Plus
   dotnet build --configuration Release
   ```
4. 从 `bin\Release\net8.0-windows\` 复制 **所有文件**（包括 `sound` 文件夹）

### 问题3：播放命令已发送，但听不到声音

**症状**：测试结果显示"✅ 播放命令已发送"，但没有听到声音

**可能原因**：
1. **系统音量关闭或静音**
   - 检查系统音量设置
   - 检查应用音量混合器

2. **音频输出设备未正确配置**
   - 检查 Windows 声音设置
   - 确认默认播放设备

3. **MCI 播放被阻止**
   - 某些安全软件可能阻止 MCI API
   - 尝试将程序添加到白名单

4. **MP3 文件损坏**
   - 用 Windows Media Player 手动播放文件
   - 如果无法播放，从 F5BotV2 复制完整文件

5. **声音播放不完整**（只有开头）
   - 这是已知问题，已通过异步保持对象引用修复
   - 确保使用最新版本的代码

---

## 🔧 技术实现

### 架构说明

1. **依赖注入**：`SoundService` 通过构造函数注入到 `SettingsForm`
2. **服务获取**：通过 `Program.ServiceProvider.GetService<SoundService>()` 获取
3. **播放机制**：使用 Windows MCI API (Media Control Interface)
4. **对象保持**：使用 `List<MP3Play>` 保持播放器对象引用，防止 GC 回收
5. **异步播放**：基于文件时长在后台保持对象引用

### 相关文件

- **UI 设计**：`BaiShengVx3Plus/Views/SettingsForm.Designer.cs`
- **事件处理**：`BaiShengVx3Plus/Views/SettingsForm.cs`
- **声音服务**：`BaiShengVx3Plus/Services/Sound/SoundService.cs`
- **MCI 封装**：`BaiShengVx3Plus/Utils/MP3Play.cs`

---

## 📝 使用建议

### 1. 声音文件部署

**开发环境**：
- 声音文件位于 `BaiShengVx3Plus/sound/`
- 编译后自动复制到 `bin/Debug/net8.0-windows/sound/`

**生产环境**：
- 必须手动复制 `sound/` 文件夹到程序所在目录
- 或者从编译输出目录完整复制所有文件

### 2. 快速诊断流程

1. **打开设置窗口** → 其他 → 声音测试
2. **点击任意测试按钮**
3. **查看测试结果**：
   - 如果显示"文件存在: 否" → 复制声音文件
   - 如果显示"✅ 播放命令已发送" 但听不到 → 检查音量和音频设备
   - 如果显示"❌ 声音服务未初始化" → 重启程序

### 3. 与实际功能对比

声音测试使用的 **完全相同** 的播放逻辑：
- 封盘时播放的声音 = 测试封盘声音
- 开奖时播放的声音 = 测试开奖声音
- 上分时播放的声音 = 测试上分声音
- 下分时播放的声音 = 测试下分声音

**因此**：如果测试能听到声音，实际使用时也应该能听到。

---

## 🎯 常见场景

### 场景1：部署到新服务器

1. 复制程序文件到服务器
2. **确保包含 `sound/` 文件夹**
3. 运行程序，打开设置窗口
4. 逐个测试所有声音
5. 确认所有声音都能正常播放

### 场景2：声音突然不播放

1. 打开设置窗口 → 其他 → 声音测试
2. 测试上分声音
3. 查看测试结果：
   - "文件不存在" → 可能被误删，重新复制
   - "播放命令已发送" 但听不到 → 检查系统音量
4. 修复问题后重新测试

### 场景3：更新声音文件

1. 替换 `sound/` 文件夹中的 MP3 文件
2. 重启程序
3. 打开设置窗口 → 其他 → 声音测试
4. 确认新声音文件播放正常

---

## 🔗 相关文档

- [🔥声音播放不完整修复报告](./🔥声音播放不完整修复报告.md)
- [🔥上下分声音被收单开关阻止问题修复报告](./🔥上下分声音被收单开关阻止问题修复报告.md)
- [声音播放功能说明](./声音播放功能说明.md)

---

**文档创建时间**：2025-11-19  
**功能版本**：v1.0  
**状态**：✅ 已完成

