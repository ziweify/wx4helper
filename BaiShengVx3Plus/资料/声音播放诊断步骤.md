# ğŸ”Š å£°éŸ³æ’­æ”¾è¯Šæ–­æ­¥éª¤

## é—®é¢˜æè¿°

- è·¯å¾„æ­£ç¡®ï¼ˆå•æ­¥è°ƒè¯•å·²ç¡®è®¤ï¼‰
- æ²¡æœ‰å¼‚å¸¸ï¼ˆ`play()` è°ƒç”¨æˆåŠŸï¼‰
- ä½†æ˜¯**æ²¡æœ‰å£°éŸ³**

---

## ğŸ“‹ è¯Šæ–­æ­¥éª¤

### 1. æ£€æŸ¥ MCI å‘½ä»¤è¿”å›å€¼

åœ¨å•æ­¥è°ƒè¯•æ—¶ï¼Œæ£€æŸ¥ä»¥ä¸‹è¿”å›å€¼ï¼ˆå·²æ·»åŠ  Debug è¾“å‡ºï¼‰ï¼š

```csharp
// BaiShengVx3Plus/Utils/MP3Play.cs

// FileName setter:
Line 63: Close all result: {return_value}      â† åº”è¯¥æ˜¯ 0ï¼ˆæˆåŠŸï¼‰
Line 66: Open result: {return_value}           â† åº”è¯¥æ˜¯ 0ï¼ˆæˆåŠŸï¼‰
Line 68: Set time format result: {return_value} â† åº”è¯¥æ˜¯ 0ï¼ˆæˆåŠŸï¼‰

// play():
Line 87: Play command result: {return_value}   â† åº”è¯¥æ˜¯ 0ï¼ˆæˆåŠŸï¼‰
```

**å¦‚æœè¿”å›å€¼ä¸æ˜¯ 0**ï¼š
- 272 (MCIERR_DRIVER_INTERNAL) = MCI é©±åŠ¨å†…éƒ¨é”™è¯¯
- 273 (MCIERR_MISSING_DEVICE_NAME) = ç¼ºå°‘è®¾å¤‡å
- 276 (MCIERR_INVALID_FILE) = æ— æ•ˆæ–‡ä»¶
- 277 (MCIERR_NULL_PARAMETER_BLOCK) = ç©ºå‚æ•°
- 286 (MCIERR_FILE_NOT_FOUND) = æ–‡ä»¶æœªæ‰¾åˆ°

---

### 2. æ‰‹åŠ¨æµ‹è¯• MCI å‘½ä»¤ï¼ˆå‘½ä»¤è¡Œï¼‰

æ‰“å¼€ **å‘½ä»¤æç¤ºç¬¦**ï¼ˆCMDï¼‰ï¼Œä¾æ¬¡æ‰§è¡Œï¼š

```cmd
cd D:\gitcode\wx4helper\BaiShengVx3Plus\bin\Debug\net8.0-windows\sound

:: 1. å…³é—­æ‰€æœ‰ MCI è®¾å¤‡
mcitest32 close all

:: 2. æ‰“å¼€ MP3 æ–‡ä»¶
mcitest32 open "mp3_shang.mp3" alias media

:: 3. æ’­æ”¾
mcitest32 play media

:: 4. æŸ¥è¯¢çŠ¶æ€
mcitest32 status media mode

:: 5. å…³é—­
mcitest32 close media
```

**æ³¨æ„**ï¼šWindows 10/11 å¯èƒ½ä¸å†é™„å¸¦ `mcitest32.exe`ï¼Œå¯ä»¥ä½¿ç”¨ PowerShellï¼š

```powershell
Add-Type -TypeDefinition @"
using System;
using System.Runtime.InteropServices;
public class MCI {
    [DllImport("winmm.dll")]
    public static extern int mciSendString(string command, System.Text.StringBuilder returnValue, int returnLength, IntPtr hwndCallback);
}
"@

$sb = New-Object System.Text.StringBuilder(128)

# å…³é—­æ‰€æœ‰
[MCI]::mciSendString("close all", $sb, $sb.Capacity, [IntPtr]::Zero)

# æ‰“å¼€æ–‡ä»¶ï¼ˆä½¿ç”¨ç»å¯¹è·¯å¾„ï¼‰
[MCI]::mciSendString("open `"D:\gitcode\wx4helper\BaiShengVx3Plus\bin\Debug\net8.0-windows\sound\mp3_shang.mp3`" alias media", $sb, $sb.Capacity, [IntPtr]::Zero)

# æ’­æ”¾
[MCI]::mciSendString("play media", $sb, $sb.Capacity, [IntPtr]::Zero)

# æŸ¥è¯¢çŠ¶æ€
[MCI]::mciSendString("status media mode", $sb, $sb.Capacity, [IntPtr]::Zero)
Write-Host "Status: $($sb.ToString())"
```

---

### 3. æ£€æŸ¥éŸ³é¢‘è¾“å‡ºè®¾å¤‡

#### æ–¹æ³• Aï¼šWindows è®¾ç½®

1. å³é”®ç‚¹å‡»ä»»åŠ¡æ å³ä¸‹è§’çš„éŸ³é‡å›¾æ ‡
2. é€‰æ‹© **"æ‰“å¼€å£°éŸ³è®¾ç½®"**
3. ç¡®è®¤ **"é€‰æ‹©è¾“å‡ºè®¾å¤‡"** ä¸æ˜¯ **"æ— "**
4. ç¡®è®¤éŸ³é‡ä¸æ˜¯ 0 æˆ–é™éŸ³

#### æ–¹æ³• Bï¼šPowerShell

```powershell
Get-AudioDevice -List
```

---

### 4. æµ‹è¯•å…¶ä»–éŸ³é¢‘æ’­æ”¾æ–¹å¼

åœ¨é¡¹ç›®ä¸­æ·»åŠ ä¸€ä¸ªæµ‹è¯•æ–¹æ³•ï¼Œä½¿ç”¨ **`System.Media.SoundPlayer`** æˆ– **`MediaPlayer`**ï¼š

#### æ–¹æ³• Aï¼šSoundPlayerï¼ˆä»…æ”¯æŒ WAVï¼‰

```csharp
// å¦‚æœæœ‰ WAV æ–‡ä»¶å¯ä»¥æµ‹è¯•
var player = new System.Media.SoundPlayer(@"D:\gitcode\wx4helper\BaiShengVx3Plus\bin\Debug\net8.0-windows\sound\test.wav");
player.PlaySync();  // åŒæ­¥æ’­æ”¾ï¼Œä¼šé˜»å¡ç›´åˆ°æ’­æ”¾å®Œæˆ
```

#### æ–¹æ³• Bï¼šMediaPlayerï¼ˆæ”¯æŒ MP3ï¼‰

```csharp
// éœ€è¦æ·»åŠ å¼•ç”¨: PresentationCore.dll
var player = new System.Windows.Media.MediaPlayer();
player.Open(new Uri(@"D:\gitcode\wx4helper\BaiShengVx3Plus\bin\Debug\net8.0-windows\sound\mp3_shang.mp3"));
player.Play();

// âš ï¸ MediaPlayer ä¹Ÿæ˜¯å¼‚æ­¥çš„ï¼Œéœ€è¦ä¿æŒå¼•ç”¨
System.Threading.Thread.Sleep(3000);  // ç­‰å¾… 3 ç§’
```

---

### 5. æ£€æŸ¥ F5BotV2 çš„ç¯å¢ƒ

å¯¹æ¯” F5BotV2 å’Œ BaiShengVx3Plus çš„ç¯å¢ƒå·®å¼‚ï¼š

| é¡¹ç›® | F5BotV2 | BaiShengVx3Plus |
|------|---------|-----------------|
| .NET ç‰ˆæœ¬ | .NET Framework 4.x | .NET 8.0 |
| è¿è¡Œæ–¹å¼ | Release / Debug | Release / Debug |
| éŸ³é¢‘è®¾å¤‡ | ? | ? |
| Windows ç‰ˆæœ¬ | ? | ? |

**æµ‹è¯•æ–¹æ³•**ï¼š
1. åŒæ—¶è¿è¡Œ F5BotV2 å’Œ BaiShengVx3Plus
2. åœ¨ F5BotV2 ä¸­è§¦å‘å£°éŸ³æ’­æ”¾ â†’ **æœ‰å£°éŸ³**
3. åœ¨ BaiShengVx3Plus ä¸­è§¦å‘å£°éŸ³æ’­æ”¾ â†’ **æ²¡æœ‰å£°éŸ³**

å¦‚æœ F5BotV2 æœ‰å£°éŸ³ï¼Œè¯´æ˜éŸ³é¢‘è®¾å¤‡æ²¡é—®é¢˜ï¼Œé—®é¢˜åœ¨äºä»£ç æˆ– .NET ç‰ˆæœ¬å·®å¼‚ã€‚

---

### 6. å°è¯•ä¸åŒçš„ alias åç§°

ä¿®æ”¹ `MP3Play.cs`ï¼Œä½¿ç”¨ **å”¯ä¸€çš„ alias åç§°**ï¼ˆè€Œä¸æ˜¯å›ºå®šçš„ "media"ï¼‰ï¼š

```csharp
// ğŸ”¥ æµ‹è¯•ï¼šä½¿ç”¨å”¯ä¸€ aliasï¼Œé¿å…å†²çª
private static int _instanceCounter = 0;
private string _alias;

public MP3Play()
{
    _alias = $"media{System.Threading.Interlocked.Increment(ref _instanceCounter)}";
}

public string FileName
{
    set
    {
        try
        {
            TemStr = "";
            TemStr = TemStr.PadLeft(127, Convert.ToChar(" "));
            Name = Name.PadLeft(260, Convert.ToChar(" "));
            mc.iName = value;
            ilong = APIClass.GetShortPathName(mc.iName, Name, Name.Length);
            Name = GetCurrPath(Name);
            Name = $"open {Convert.ToChar(34)}{Name}{Convert.ToChar(34)} alias {_alias}";  // ä½¿ç”¨å”¯ä¸€ alias
            
            ilong = APIClass.mciSendString($"close {_alias}", TemStr, TemStr.Length, 0);  // åªå…³é—­å½“å‰ alias
            ilong = APIClass.mciSendString(Name, TemStr, TemStr.Length, 0);
            ilong = APIClass.mciSendString($"set {_alias} time format milliseconds", TemStr, TemStr.Length, 0);
            
            mc.state = State.mStop;
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"[MP3Play] âŒ Exception in FileName setter: {ex.Message}");
        }
    }
}

public void play()
{
    TemStr = "";
    TemStr = TemStr.PadLeft(127, Convert.ToChar(" "));
    int result = APIClass.mciSendString($"play {_alias}", TemStr, TemStr.Length, 0);  // ä½¿ç”¨å”¯ä¸€ alias
    
    System.Diagnostics.Debug.WriteLine($"[MP3Play] Play command result: {result}");
    if (result != 0)
    {
        System.Diagnostics.Debug.WriteLine($"[MP3Play] âŒ Play failed with error code: {result}");
    }
    
    mc.state = State.mPlaying;
}

public void StopT()
{
    TemStr = "";
    TemStr = TemStr.PadLeft(128, Convert.ToChar(" "));
    ilong = APIClass.mciSendString($"close {_alias}", TemStr, 128, 0);  // ä½¿ç”¨å”¯ä¸€ alias
    mc.state = State.mStop;
}
```

---

## ğŸ”¬ æœ€å¯èƒ½çš„åŸå› 

### åŸå›  1ï¼šå¯¹è±¡è¿‡æ—©è¢«åƒåœ¾å›æ”¶

**ç—‡çŠ¶**ï¼š
- å£°éŸ³æ’­æ”¾æ—¶é—´å¾ˆçŸ­ï¼ˆ< 0.5 ç§’ï¼‰
- æˆ–è€…å®Œå…¨æ²¡æœ‰å£°éŸ³

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ä½¿ç”¨ `_recentPlayers` åˆ—è¡¨ä¿æŒå¼•ç”¨ âœ…ï¼ˆå·²å®ç°ï¼‰
- æˆ–è€…ä½¿ç”¨ `GC.KeepAlive(player)` åœ¨æ’­æ”¾åä¿æŒå¯¹è±¡å­˜æ´»

---

### åŸå›  2ï¼šMCI è®¾å¤‡å†²çª

**ç—‡çŠ¶**ï¼š
- ç¬¬ä¸€æ¬¡æ’­æ”¾æœ‰å£°éŸ³ï¼Œåç»­æ’­æ”¾æ²¡æœ‰å£°éŸ³
- æˆ–è€…å¿«é€Ÿè¿ç»­æ’­æ”¾æ—¶ï¼Œåªæœ‰æœ€åä¸€ä¸ªæœ‰å£°éŸ³

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ä½¿ç”¨å”¯ä¸€ alias åç§°ï¼ˆå¦‚ `media1`, `media2`, ...ï¼‰
- æˆ–è€…åœ¨æ’­æ”¾å‰è°ƒç”¨ `close all`

---

### åŸå›  3ï¼šéŸ³é¢‘è®¾å¤‡æœªé€‰æ‹©

**ç—‡çŠ¶**ï¼š
- æ‰€æœ‰éŸ³é¢‘æ’­æ”¾æ–¹å¼éƒ½æ²¡æœ‰å£°éŸ³
- åŒ…æ‹¬ F5BotV2 ä¹Ÿæ²¡æœ‰å£°éŸ³

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥ Windows å£°éŸ³è®¾ç½®
- ç¡®è®¤è¾“å‡ºè®¾å¤‡æ­£ç¡®

---

### åŸå›  4ï¼š.NET 8.0 ä¸ MCI å…¼å®¹æ€§é—®é¢˜

**ç—‡çŠ¶**ï¼š
- F5BotV2ï¼ˆ.NET Framework 4.xï¼‰æœ‰å£°éŸ³
- BaiShengVx3Plusï¼ˆ.NET 8.0ï¼‰æ²¡æœ‰å£°éŸ³

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ä½¿ç”¨ `System.Windows.Media.MediaPlayer`ï¼ˆéœ€è¦æ·»åŠ  PresentationCore å¼•ç”¨ï¼‰
- æˆ–è€…ä½¿ç”¨ `NAudio` åº“ï¼ˆNuGet åŒ…ï¼‰

---

## ğŸ“ ä¸‹ä¸€æ­¥

**è¯·æŒ‰é¡ºåºæ‰§è¡Œä»¥ä¸‹æ­¥éª¤**ï¼š

1. âœ… ç¡®è®¤ Debug è¾“å‡ºä¸­çš„ MCI è¿”å›å€¼ï¼ˆå·²æ·»åŠ æ—¥å¿—ï¼‰
2. â³ è¿è¡Œ F5BotV2ï¼Œç¡®è®¤å®ƒçš„å£°éŸ³æ˜¯å¦æ­£å¸¸
3. â³ åœ¨ BaiShengVx3Plus ä¸­å•æ­¥è°ƒè¯•ï¼ŒæŸ¥çœ‹ Output çª—å£çš„ Debug è¾“å‡º
4. â³ æ ¹æ®è¿”å›å€¼ï¼Œåˆ¤æ–­æ˜¯å“ªä¸€æ­¥å¤±è´¥äº†

**è¯·å°†ä»¥ä¸‹ä¿¡æ¯åé¦ˆç»™æˆ‘**ï¼š
- Output çª—å£ä¸­çš„æ‰€æœ‰ `[MP3Play]` å¼€å¤´çš„ Debug è¾“å‡º
- F5BotV2 çš„å£°éŸ³æ˜¯å¦æ­£å¸¸
- ä½ çš„ Windows ç‰ˆæœ¬å’ŒéŸ³é¢‘è®¾å¤‡

---

**åˆ›å»ºæ—¶é—´**ï¼š2025-11-18 15:35  
**çŠ¶æ€**ï¼šâ³ ç­‰å¾…è¯Šæ–­ç»“æœ

