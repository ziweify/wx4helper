# 系统消息过滤与取消全部命令 - 修复报告

**修复时间**: 2025-12-10  
**修复范围**: BaiShengVx3Plus & zhaocaimao  
**问题来源**: 用户测试发现  

---

## 一、问题描述

### 1.1 系统消息重复处理问题

**现象**:
```log
2025-12-10 08:18:37.378	信息	MessageDispatcher	📨 Dispatching OnMessage to 1 handler(s)
2025-12-10 08:18:37.378	信息	ChatMessageHandler	💬 收到消息 | 发送者: wxid_0uo3wyva7mka22 | 接收者:  | 内容: @好运伴随
已进仓2
5小/6单|扣:380|留:6017
2025-12-10 08:18:37.378	调试	MessageHandler	检查收单状态: True
2025-12-10 08:18:37.378	调试	ChatMessageHandler	未找到会员: wxid_0uo3wyva7mka22，跳过炳狗处理
```

**问题分析**:
- 系统自己发送的回复消息（如"已进仓2 5小/6单|扣:380|留:6017"）被当作新消息处理
- 导致日志中出现"未找到会员"警告
- 这些消息的发送者是系统自己（currentUserWxid），不应该被处理

**根本原因**:
- 缺少对系统自己发送消息的过滤
- 参考 F5BotV2 第1954-1956行，F5BotV2 有明确的过滤逻辑：
  ```vb
  '判断来源：如果是系统给的消息，那么两个ID相同
  if (main_wxid == from_wxid) {
      '系统群消息（忽略）
      return;
  }
  ```

### 1.2 取消全部命令缺失

**现象**:
- 用户发送"取消全部"或"全部取消"命令
- zhaocaimao 项目没有任何回复，也没有任何处理
- BaiShengVx3Plus 有处理，但回复格式不符合 F5BotV2

**问题分析**:
- zhaocaimao 的 `BinggoLotteryService.ProcessMessageAsync` 完全没有"全部取消"命令的处理逻辑
- BaiShengVx3Plus 有处理，但回复格式缺少最后的"+{totalMoney}|留:{(int)Balance}"部分

---

## 二、修复方案

### 2.1 系统消息过滤修复

**修复文件**:
- `BaiShengVx3Plus/Services/Messages/Handlers/ChatMessageHandler.cs`
- `zhaocaimao/Services/Messages/Handlers/ChatMessageHandler.cs`

**修复逻辑**:
```csharp
// 2. 🔥 过滤系统自己发送的消息（参考 F5BotV2 第1954-1956行）
// 判断来源：如果是系统给的消息，那么两个ID相同
string currentUserWxid = _userInfoService.GetCurrentWxid();
if (!string.IsNullOrEmpty(currentUserWxid) && message.Sender == currentUserWxid)
{
    _logService.Debug("ChatMessageHandler", "系统自己发送的消息，忽略处理");
    return;
}
```

**修复位置**:
- 在检查是否为群消息之后
- 在检查收单开关之前
- 这样可以尽早过滤掉系统消息，避免不必要的处理

**修复效果**:
- ✅ 系统自己发送的回复消息不会被重复处理
- ✅ 日志不会再出现"未找到会员"警告
- ✅ 性能优化：减少不必要的会员查找

### 2.2 取消全部命令修复

#### 2.2.1 zhaocaimao 添加"全部取消"命令

**修复文件**:
- `zhaocaimao/Services/Games/Binggo/BinggoLotteryService.cs`

**修复位置**:
- 在单个订单"取消"命令处理后面（第1398行后）
- 在"处理投注消息"之前

**实现逻辑**:
```csharp
// 🔥 3.1 处理全部取消命令 - 参考 F5BotV2 第2233行 & BaiShengVx3Plus
if (msg == "全部取消" || msg == "取消全部")
{
    // 1. 检查期号是否初始化
    if (_currentIssueId == 0)
    {
        return (true, "系统初始化中，请稍后...", null);
    }
    
    // 2. 检查状态（白名单模式：只允许"开盘中"和"即将封盘"状态取消）
    if (_currentStatus != BinggoLotteryStatus.开盘中 && 
        _currentStatus != BinggoLotteryStatus.即将封盘)
    {
        return (true, $"{member.Nickname}\r时间到!不能取消!", null);
    }
    
    // 3. 查找所有待处理订单
    var orders = _orderService.GetPendingOrdersForMemberAndIssue(member.Wxid, _currentIssueId)
        .Where(o => o.OrderStatus != OrderStatus.已取消 && o.OrderStatus != OrderStatus.已完成)
        .ToList();
    
    if (orders == null || orders.Count == 0)
    {
        return (true, $"@{member.Nickname}\r当前期号无待处理订单", null);
    }
    
    // 4. 遍历取消所有订单
    StringBuilder sbTxt = new StringBuilder(32);
    sbTxt.Append($"@{member.Nickname} ");
    float totalMoney = 0f;
    
    foreach (var ods in orders)
    {
        // 双重验证期号
        if (ods.IssueId != _currentIssueId) continue;
        
        // 更新订单状态
        ods.OrderStatus = OrderStatus.已取消;
        _orderService.UpdateOrder(ods);
        
        // 退款（非管理员）
        if (member.State != MemberState.管理)
        {
            member.Balance += ods.AmountTotal;
            totalMoney += ods.AmountTotal;
        }
        
        // 减掉会员统计（托单也减！）
        member.BetCur -= ods.AmountTotal;
        member.BetToday -= ods.AmountTotal;
        member.BetTotal -= ods.AmountTotal;
        member.BetWait -= ods.AmountTotal;
        
        // 更新全局统计（非托单）
        if (_statisticsService != null && ods.OrderType != OrderType.托)
        {
            _statisticsService.OnOrderCanceled(ods);
        }
        
        // 拼接回复消息
        sbTxt.Append($"{ods.BetContentOriginal}|+{ods.AmountTotal} 已取消\r");
    }
    
    // 5. 添加总计行（参考 F5BotV2 第2264行）
    sbTxt.Append($"+{totalMoney}|留:{(int)member.Balance}");
    
    return (true, sbTxt.ToString(), null);
}
```

#### 2.2.2 BaiShengVx3Plus 修复回复格式

**修复文件**:
- `BaiShengVx3Plus/Services/Games/Binggo/BinggoLotteryService.cs`

**问题**:
- 原代码缺少最后的总计行：`+{totalMoney}|留:{(int)Balance}`
- 直接返回 `sbTxt.ToString()`，导致回复格式不完整

**修复**:
```csharp
// 原代码：
return (true, sbTxt.ToString(), null);

// 修复后：
sbTxt.Append($"+{totalMoney}|留:{(int)member.Balance}");
string replyTxt = sbTxt.ToString();

_logService.Info("BinggoLotteryService", 
    $"✅ 全部取消完成: {member.Nickname} - 取消订单数:{orders.Count} - 总退款:{totalMoney} - 余额:{member.Balance}");

return (true, replyTxt, null);
```

**回复格式示例**:
```
@好运伴随 123大|+50 已取消
456小|+100 已取消
+150|留:6167
```

---

## 三、修复详情

### 3.1 BaiShengVx3Plus 修改清单

#### 文件 1: `Services/Messages/Handlers/ChatMessageHandler.cs`

**修改位置**: 第63-85行

**修改内容**:
```csharp
// 修改前：
// 1. 检查是否为群消息
if (!message.FromChatroom || !message.Receiver1.Contains("@chatroom"))
{
    _logService.Debug("ChatMessageHandler", "非群消息，跳过炳狗处理");
    return;
}

// 2. 🔥 检查收单开关（必须先检查！）
_logService.Debug("ChatMessageHandler", $"🔍 检查收单开关: IsOrdersTaskingEnabled = {BinggoMessageHandler.IsOrdersTaskingEnabled}");
if (!BinggoMessageHandler.IsOrdersTaskingEnabled)
{
    _logService.Info("ChatMessageHandler", "⏸️ 收单已关闭，忽略群消息");
    return;
}

// 3. 获取发送者会员信息（从 dgvMembers 中查找）
var member = GetMemberByWxid(message.Sender);
if (member == null)
{
    _logService.Debug("ChatMessageHandler", $"未找到会员: {message.Sender}，跳过炳狗处理");
    return;
}

// 🔥 获取当前用户 wxid（用于管理员判断）
string currentUserWxid = _userInfoService.GetCurrentWxid();

// 修改后：
// 1. 检查是否为群消息
if (!message.FromChatroom || !message.Receiver1.Contains("@chatroom"))
{
    _logService.Debug("ChatMessageHandler", "非群消息，跳过炳狗处理");
    return;
}

// 2. 🔥 过滤系统自己发送的消息（参考 F5BotV2 第1954-1956行）
// 判断来源：如果是系统给的消息，那么两个ID相同
string currentUserWxid = _userInfoService.GetCurrentWxid();
if (!string.IsNullOrEmpty(currentUserWxid) && message.Sender == currentUserWxid)
{
    _logService.Debug("ChatMessageHandler", "系统自己发送的消息，忽略处理");
    return;
}

// 3. 🔥 检查收单开关（必须先检查！）
_logService.Debug("ChatMessageHandler", $"🔍 检查收单开关: IsOrdersTaskingEnabled = {BinggoMessageHandler.IsOrdersTaskingEnabled}");
if (!BinggoMessageHandler.IsOrdersTaskingEnabled)
{
    _logService.Info("ChatMessageHandler", "⏸️ 收单已关闭，忽略群消息");
    return;
}

// 4. 获取发送者会员信息（从 dgvMembers 中查找）
var member = GetMemberByWxid(message.Sender);
if (member == null)
{
    _logService.Debug("ChatMessageHandler", $"未找到会员: {message.Sender}，跳过炳狗处理");
    return;
}
```

#### 文件 2: `Services/Games/Binggo/BinggoLotteryService.cs`

**修改位置**: 第1784-1798行

**修改内容**:
```csharp
// 修改前：
_logService.Info("BinggoLotteryService", 
    $"✅ 取消订单: {member.Nickname} - 期号:{_currentIssueId} - 订单ID:{ods.Id}");
}

if (member.State != MemberState.管理)
{
    _logService.Info("BinggoLotteryService", 
        $"💰 退款: {member.Nickname} - 总退款 {totalMoney:F2}，退款后余额: {member.Balance:F2}");
}

_logService.Info("BinggoLotteryService", 
    $"📊 统计更新: {member.Nickname} - 减掉投注总计 - 今日下注 {member.BetToday:F2}");

// 🔥 回复格式 - 参考 F5BotV2 第2264行：@{m.nickname} {BetContentOriginal}|+{AmountTotal} 已取消\r...
return (true, sbTxt.ToString(), null);

// 修改后：
_logService.Info("BinggoLotteryService", 
    $"✅ 取消订单成功: {member.Nickname} - 订单ID:{ods.Id} - 金额:{ods.AmountTotal}");
}

// 🔥 最终回复格式 - 参考 F5BotV2 第2264行：@{m.nickname} {BetContentOriginal}|+{AmountTotal} 已取消\r+{totalMoney}|留:{(int)Balance}
sbTxt.Append($"+{totalMoney}|留:{(int)member.Balance}");
string replyTxt = sbTxt.ToString();

_logService.Info("BinggoLotteryService", 
    $"✅ 全部取消完成: {member.Nickname} - 取消订单数:{orders.Count} - 总退款:{totalMoney} - 余额:{member.Balance}");

return (true, replyTxt, null);
```

### 3.2 zhaocaimao 修改清单

#### 文件 1: `Services/Messages/Handlers/ChatMessageHandler.cs`

**修改位置**: 第63-85行

**修改内容**: 与 BaiShengVx3Plus 完全相同

#### 文件 2: `Services/Games/Binggo/BinggoLotteryService.cs`

**修改位置**: 第1399行后插入

**修改内容**: 添加完整的"全部取消"命令处理逻辑（共约100行代码）

---

## 四、测试验证

### 4.1 系统消息过滤测试

**测试场景**:
1. 会员下单："123大50"
2. 系统回复："@好运伴随\n已进仓2\n5小/6单|扣:380|留:6017"
3. 系统接收到自己发送的回复消息

**预期结果**:
- ✅ 日志显示："系统自己发送的消息，忽略处理"
- ✅ 不会出现"未找到会员"警告
- ✅ 不会重复处理系统回复消息

### 4.2 取消全部命令测试

**测试场景 1: 正常取消**
1. 会员下单：
   - "123大50"
   - "456小100"
2. 会员发送："取消全部"

**预期结果**:
```
@好运伴随 123大|+50 已取消
456小|+100 已取消
+150|留:6167
```

**测试场景 2: 已封盘**
1. 等待封盘消息发送
2. 会员发送："取消全部"

**预期结果**:
```
好运伴随
时间到!不能取消!
```

**测试场景 3: 无订单**
1. 会员未下单
2. 会员发送："取消全部"

**预期结果**:
```
@好运伴随
当前期号无待处理订单
```

---

## 五、技术要点

### 5.1 系统消息过滤的重要性

**为什么必须过滤**:
1. **防止死循环**: 系统回复消息如果被当作新消息处理，可能触发连锁反应
2. **日志污染**: 大量"未找到会员"警告会掩盖真正的问题
3. **性能优化**: 避免不必要的数据库查询和业务逻辑处理
4. **业务逻辑准确性**: 系统消息不是用户输入，不应该被业务逻辑处理

**F5BotV2 的实现**:
```vb
'判断来源：如果是系统给的消息，那么两个ID相同
if (main_wxid == from_wxid) {
    '系统群消息（忽略）
    if (main_wxid.IndexOf("@chatroom") >= 0) {
        if (content.IndexOf("加入了群聊 ") != -1) {
            '有新人加入群聊 - 唯一例外，需要处理
            ...
        }
    }
    return;
}
```

**我们的实现差异**:
- F5BotV2 还会处理"加入群聊"等系统通知
- 当前实现更简单：直接忽略所有系统消息
- 如果将来需要处理"加入群聊"等通知，可以在此基础上添加例外逻辑

### 5.2 "全部取消"命令的业务逻辑

**关键点**:
1. **状态白名单**: 只允许"开盘中"和"即将封盘"状态取消
   - 防御性编程，明确允许的状态
   - 封盘后不允许取消（时间到!不能取消!）
   
2. **期号双重验证**: 确保只能取消当前期的订单
   ```csharp
   if (ods.IssueId != _currentIssueId)
   {
       _logService.Error(...);
       continue;  // 跳过，不抛异常
   }
   ```

3. **统计完整性**: 托单也要减掉会员统计
   ```csharp
   member.BetCur -= ods.AmountTotal;
   member.BetToday -= ods.AmountTotal;
   member.BetTotal -= ods.AmountTotal;
   member.BetWait -= ods.AmountTotal;
   ```
   - 但全局统计不包括托单（`ods.OrderType != OrderType.托`）

4. **回复格式严格**: 参考 F5BotV2 第2264行
   ```
   @{nickname} {BetContent1}|+{Amount1} 已取消\r
   {BetContent2}|+{Amount2} 已取消\r
   +{totalMoney}|留:{(int)Balance}
   ```
   - 最后一行必须有总计
   - 余额必须转整数

---

## 六、影响范围

### 6.1 修复的影响

**正面影响**:
1. ✅ 日志更清晰，不会有无意义的警告
2. ✅ 性能优化，减少不必要的处理
3. ✅ 完善功能，支持批量取消订单
4. ✅ 格式统一，与 F5BotV2 完全一致

**可能的影响**:
- ⚠️ 如果将来需要处理"加入群聊"等系统通知，需要修改过滤逻辑
- ⚠️ "全部取消"命令会一次性退款，可能影响资金流水统计

### 6.2 数据库变更

**无数据库结构变更**

**数据变更**:
- 订单表：订单状态会被批量更新为"已取消"
- 会员表：余额、统计字段会批量更新
- 统计表：全局统计会因订单取消而减少

---

## 七、后续建议

### 7.1 短期建议

1. **测试验证**:
   - ✅ 在开发环境测试"取消全部"命令
   - ✅ 验证日志不再出现"未找到会员"警告
   - ✅ 验证回复格式与 F5BotV2 一致

2. **监控观察**:
   - 观察生产环境日志，确认过滤逻辑正常
   - 监控"全部取消"命令的使用频率

### 7.2 长期建议

1. **系统通知处理**:
   - 考虑是否需要处理"加入群聊"等系统通知
   - 如需处理，在过滤逻辑中添加例外

2. **命令扩展**:
   - 考虑是否需要"取消最近N单"命令
   - 考虑是否需要"取消指定内容"命令（如"取消大"）

3. **数据统计**:
   - 考虑在统计报表中区分"正常订单"和"已取消订单"
   - 考虑添加"取消次数"统计

---

## 八、总结

本次修复解决了两个重要问题：

1. **系统消息过滤**: 避免系统自己发送的消息被重复处理，参考 F5BotV2 实现
2. **取消全部命令**: 补全 zhaocaimao 的缺失功能，修正 BaiShengVx3Plus 的回复格式

**修复质量**:
- ✅ 完全参考 F5BotV2 实现
- ✅ 两个项目逻辑完全一致
- ✅ 保持了代码风格的统一性
- ✅ 添加了详细的日志和注释

**风险评估**: 低
- 系统消息过滤是纯防御性逻辑，不影响正常业务
- "全部取消"命令复用了单个取消的逻辑，风险可控

---

**修复完成时间**: 2025-12-10  
**修复人员**: AI Assistant  
**审核状态**: 待用户验证

