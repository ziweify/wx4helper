# 📱 消息模拟器使用说明

> **版本**: 1.0.0  
> **日期**: 2025-11-18  
> **功能**: 开发模式下模拟会员/管理员发送消息，用于离线测试

---

## 🎯 功能特性

### **核心功能**

✅ **微信风格界面**: 模拟微信聊天窗口，直观易用  
✅ **真实业务流程**: 消息进入完整的业务处理流程（订单、上下分等）  
✅ **角色模拟**: 自动识别会员/管理员身份  
✅ **快捷命令**: 预设常用命令，快速测试  
✅ **消息历史**: 保留对话历史，方便查看  
✅ **单例模式**: 同一会员只能开一个窗口  
✅ **非模态窗口**: 可同时打开多个会员的窗口

### **支持的消息类型**

| 类型 | 示例 | 说明 |
|------|------|------|
| 会员投注 | `123大10`、`124小5` | 创建订单，扣除余额 |
| 会员上分 | `上100` | 申请上分，等待管理员审批 |
| 会员下分 | `下100` | 申请下分，等待管理员审批 |
| 会员查询 | `查` | 查询当前余额和统计 |
| 会员取消 | `取消` | 取消最近的订单 |
| 管理员上分 | `7上100` | 管理员给7号会员上分 |
| 管理员下分 | `7下100` | 管理员给7号会员下分 |
| 管理员命令 | `刷新`、`清零`、`封盘` | 管理员操作 |

---

## 📖 使用步骤

### **1. 开启开发模式**

1. 打开主程序 `VxMain`
2. 点击 **设置** 按钮
3. 勾选 **开发模式** 选项
4. 保存设置

![开发模式](https://via.placeholder.com/600x300?text=%E5%BC%80%E5%8F%91%E6%A8%A1%E5%BC%8F)

### **2. 绑定测试群**

1. 在 **联系人列表** 中选择一个群
2. 点击 **绑定** 按钮
3. 等待会员列表加载完成

![绑定群](https://via.placeholder.com/600x300?text=%E7%BB%91%E5%AE%9A%E7%BE%A4)

### **3. 打开消息模拟器**

1. 在 **会员表** 中选择一个会员（右键）
2. 选择 **🔧 开发选项** → **📱 发送消息（模拟窗口）**
3. 或按快捷键 `Ctrl+M`

![打开模拟器](https://via.placeholder.com/600x300?text=%E6%89%93%E5%BC%80%E6%A8%A1%E6%8B%9F%E5%99%A8)

### **4. 发送测试消息**

#### **方式1: 手动输入**

1. 在输入框输入消息（如：`123大10`）
2. 按 `Enter` 键或点击 **发送** 按钮
3. 查看系统回复

#### **方式2: 使用快捷命令**

1. 点击 **快捷命令** 下拉框
2. 选择一个命令（如：`123大10`）
3. 命令自动填入输入框
4. 按 `Enter` 键发送

![发送消息](https://via.placeholder.com/600x300?text=%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF)

---

## 🎨 界面说明

### **窗口布局**

```
┌─────────────────────────────────────────────────────────────┐
│  💬 消息模拟器 - 👤 会员 张三 (wxid_123)          [×]      │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  [15:30:20] 张三                            (右对齐)    │ │
│  │  123大10                                    (绿色)      │ │
│  │                                                          │ │
│  │  [15:30:21] 系统回复                        (左对齐)    │ │
│  │  已进仓1                                     (黑色)      │ │
│  │  1大10|扣:10|留:990                                     │ │
│  │                                                          │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                               │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ 请输入消息... (按 Enter 发送，Shift+Enter 换行)        │ │
│  └────────────────────────────────────────────────────────┘ │
│  快捷命令: [-- 请选择 --]  [清空历史]  [发送(Enter)]       │
└─────────────────────────────────────────────────────────────┘
```

### **消息颜色说明**

| 颜色 | 含义 | 对齐方式 |
|------|------|---------|
| 🟢 **绿色** | 会员发送的消息 | 右对齐 |
| ⚫ **黑色** | 系统正常回复 | 左对齐 |
| 🔴 **红色** | 错误消息 | 左对齐 |
| 🔘 **灰色** | 时间戳、提示信息 | 左对齐 |

---

## ⌨️ 快捷键

| 快捷键 | 功能 |
|--------|------|
| `Enter` | 发送消息 |
| `Shift+Enter` | 换行（不发送） |
| `Ctrl+M` | 打开消息模拟器（从会员表右键） |

---

## 💡 使用技巧

### **1. 测试投注流程**

```
步骤1: 发送 "123大10"
    ✅ 系统回复: 已进仓1, 1大10|扣:10|留:990

步骤2: 等待开奖（或手动开奖）
    ✅ 系统回复: 第123队 XX,XX,XX,XX,XX 大单 龙
    ✅ 系统回复: ----中~名单----
    ✅ 系统回复: 张三[1000] 10

步骤3: 发送 "查"
    ✅ 系统回复: 流~~记录
    ✅ 系统回复: 今日/本轮进货:10/0
    ✅ 系统回复: 今日盈亏:10
```

### **2. 测试上下分流程**

```
步骤1: 发送 "上100"
    ✅ 系统回复: ✅ 上分申请已提交，等待管理员审批

步骤2: 切换到管理员身份
    → 打开管理员的消息模拟器

步骤3: 管理员发送 "7上100" (7是会员ID)
    ✅ 系统回复: ✅ 已成功给会员 [张三] 上分 100元

步骤4: 切换回会员，发送 "查"
    ✅ 系统回复: 流~~记录
    ✅ 系统回复: 今日上/下:100/0
```

### **3. 测试取消订单**

```
步骤1: 发送 "123大10"
    ✅ 系统回复: 已进仓1

步骤2: 立即发送 "取消"
    ✅ 系统回复: ✅ 已取消最近的订单
    ✅ 系统回复: 退款已到账，当前余额: 1000

步骤3: 发送 "查"
    ✅ 确认余额已恢复
```

### **4. 同时测试多个会员**

1. 打开会员A的消息模拟器（如：张三）
2. 打开会员B的消息模拟器（如：李四）
3. 在两个窗口中分别发送消息
4. 切换到主窗口，查看订单表和会员表的实时更新

---

## 🔍 故障排查

### **问题1: 无法打开消息模拟器**

**症状**: 右键菜单中没有"发送消息"选项

**解决方案**:
1. 确认是否开启了 **开发模式**
2. 确认是否已绑定群组
3. 确认是否选中了会员

### **问题2: 消息发送后无回复**

**症状**: 消息显示为绿色（已发送），但没有系统回复

**可能原因**:
1. **收单开关关闭**: 发送消息前，确认收单开关已开启
2. **消息格式错误**: 检查消息格式是否正确（如：`123大10` 而非 `123 大 10`）
3. **会员余额不足**: 发送 `查` 命令确认余额

### **问题3: 系统回复为红色（错误）**

**症状**: 系统回复显示为红色错误消息

**常见错误**:
- `❌ 收单已关闭`: 开启收单开关
- `❌ 余额不足`: 管理员上分
- `❌ 金额不符合要求`: 检查投注金额（最小30元）
- `❌ 期号不存在`: 等待新一期开始

### **问题4: 窗口无法激活**

**症状**: 点击右键菜单后，窗口没有弹出

**解决方案**:
- 检查任务栏，窗口可能被最小化
- 同一会员只能开一个窗口，可能已经打开
- 关闭已有窗口，重新打开

---

## 🎯 测试场景示例

### **场景1: 完整投注流程测试**

```
目标: 测试从下注到结算的完整流程

步骤:
1. 打开会员"张三"的消息模拟器
2. 发送 "查" → 记录初始余额（如：1000）
3. 发送 "123大10" → 确认扣款成功（留：990）
4. 切换到主窗口，检查订单表（应有1条待结算订单）
5. 手动开奖（或等待自动开奖）
6. 切换回模拟器，发送 "查" → 确认余额变化
7. 检查订单表（订单状态应为"已结算"）

预期结果:
- 中奖: 余额增加（如：1000 - 10 + 19 = 1009）
- 不中: 余额减少（如：1000 - 10 = 990）
```

### **场景2: 边界测试**

```
目标: 测试各种边界情况

测试1: 最小投注金额
- 发送 "123大20" → ❌ 应提示"单注金额不能小于30元"
- 发送 "123大30" → ✅ 应成功下注

测试2: 余额不足
- 发送 "123大10000" → ❌ 应提示"余额不足"

测试3: 快速取消
- 发送 "123大10" → ✅ 成功
- 立即发送 "取消" → ✅ 应成功取消

测试4: 多次取消
- 发送 "取消" → ❌ 应提示"没有可取消的订单"
```

### **场景3: 管理员功能测试**

```
目标: 测试管理员命令

步骤:
1. 打开管理员的消息模拟器
2. 发送 "刷新" → ✅ 应刷新统计数据
3. 发送 "清零" → ✅ 应清零所有会员统计
4. 发送 "7上100" → ✅ 应给7号会员上分100
5. 发送 "7下100" → ✅ 应给7号会员下分100
6. 发送 "8查" → ✅ 应查询8号会员信息
```

---

## 🔒 安全说明

### **防作弊机制**

1. ✅ **开发模式检查**: 所有模拟功能都需要开发模式
2. ✅ **实时验证**: 每次打开菜单都重新检查开发模式状态
3. ✅ **日志记录**: 所有模拟消息都有完整日志
4. ✅ **环境隔离**: 生产环境无法启用开发模式

### **注意事项**

⚠️ **仅限开发环境使用**: 请勿在生产环境启用开发模式  
⚠️ **数据真实性**: 模拟消息会真实影响数据库（订单、余额等）  
⚠️ **测试前备份**: 建议使用测试数据库或定期备份  
⚠️ **清理测试数据**: 测试完成后，建议清理测试订单和会员

---

## 📊 技术架构

### **设计原则**

✅ **最小化修改**: 只新增窗口和菜单项，不修改任何业务逻辑  
✅ **复用现有流程**: 直接调用 `VxMain.SimulateMemberMessageAsync`  
✅ **单例模式**: 同一会员只能开一个窗口  
✅ **非模态窗口**: 支持同时打开多个会员窗口  
✅ **异常处理**: 完善的错误处理和日志记录

### **消息流转**

```
MessageSimulatorForm (UI层)
    ↓
VxMain.SimulateMemberMessageAsync (入口)
    ↓
BinggoMessageHandler.HandleMessageAsync (业务层)
    ↓
BinggoOrderService / AdminCommandHandler (服务层)
    ↓
数据库 (V2MemberOrder / V2CreditWithdraw / V2Member)
```

### **关键类**

| 类 | 职责 |
|-----|------|
| `MessageSimulatorForm` | 消息模拟器窗口（UI） |
| `VxMain.SimulateMemberMessageAsync` | 消息模拟入口（复用） |
| `BinggoMessageHandler` | 业务消息处理器 |
| `BinggoOrderService` | 订单服务 |
| `AdminCommandHandler` | 管理员命令处理器 |

---

## 📝 更新日志

### **v1.0.0 (2025-11-18)**

- ✅ 首次发布
- ✅ 支持会员/管理员消息模拟
- ✅ 微信风格界面
- ✅ 快捷命令
- ✅ 单例窗口管理
- ✅ 完整的消息历史

---

**💬 祝您测试愉快！**

