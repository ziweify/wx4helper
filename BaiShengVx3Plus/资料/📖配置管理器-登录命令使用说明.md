# 📖 配置管理器 - 登录命令使用说明

## 📋 功能概述

**登录命令** 按钮位于 **配置管理器 → 高级设置 → 命令面板** 中，用于向浏览器客户端发送登录命令，包含账号和密码信息。

---

## 🎯 使用场景

### 1. 测试自动登录功能

**场景**：验证 BsBrowserClient 是否能正确接收并使用登录凭据

**操作步骤**：
1. 打开配置管理器（主界面 → 自动飞单 → 配置管理）
2. 选择一个配置
3. 切换到 **高级设置** 标签页
4. 在 **基本设置** 中填写账号密码（如果还没填）
5. 点击 **登录** 按钮
6. 查看命令结果面板，确认发送成功

**期望结果**：
```
🔐 发送登录命令...
   用户名: kkk99
   密码: ******
   时间: 2025-11-18 14:30:27.854
✅ 登录命令已发送
   响应: 登录成功
```

---

### 2. 更新浏览器的登录凭据

**场景**：在主程序配置页面修改了账号密码后，需要更新浏览器端的登录凭据

**操作步骤**：
1. 在 **基本设置** 中修改账号或密码
2. 点击 **保存配置** 按钮（保存到数据库）
3. 切换到 **高级设置** 标签页
4. 点击 **登录** 按钮（重新发送登录命令）
5. 浏览器客户端会更新保存的登录凭据

**效果**：
- 浏览器客户端的 `_username` 和 `_password` 成员变量被更新
- 下次自动登录时使用新的账号密码

---

### 3. 手动触发登录

**场景**：浏览器已打开，但未登录（或登录失败），需要手动触发登录

**操作步骤**：
1. 确认浏览器已启动并连接到 VxMain
2. 在 **基本设置** 中确认账号密码正确
3. 切换到 **高级设置** 标签页
4. 点击 **登录** 按钮
5. 浏览器会执行登录操作

**浏览器端日志**：
```
[14:30:27.870] 🔌 收到命令:Login
[14:30:27.871] 💾 已保存登录凭据: 用户名=kkk99
[14:30:27.874] 🎲 🔐 开始登录通宝: kkk99
[14:30:28.500] 🎲 ✅ 登录成功
```

---

## 🔧 技术实现

### 命令格式

**JSON 结构**：
```json
{
  "command": "Login",
  "data": {
    "username": "kkk99",
    "password": "123456"
  }
}
```

---

### 数据流向

```
配置管理器（VxMain）
    ↓ 
点击【登录】按钮
    ↓
读取 txtUsername 和 txtPassword
    ↓
构造 Login 命令（JSON）
    ↓
SendCommandToBrowserAsync()
    ↓
通过 Socket 发送到浏览器客户端
    ↓
浏览器客户端（BsBrowserClient）
    ↓
接收 Login 命令
    ↓
保存账号密码到 _username 和 _password
    ↓
执行 _platformScript.LoginAsync(username, password)
    ↓
返回登录结果
```

---

### 核心代码

**位置**：`BaiShengVx3Plus/Views/AutoBet/BetConfigManagerForm.cs`

```csharp
private async void BtnLoginCommand_Click(object? sender, EventArgs e)
{
    if (_selectedConfig == null)
    {
        AppendCommandResult("❌ 错误:未选择配置");
        return;
    }

    var username = txtUsername.Text.Trim();
    var password = txtPassword.Text.Trim();

    if (string.IsNullOrEmpty(username) || string.IsNullOrEmpty(password))
    {
        AppendCommandResult("❌ 错误:账号或密码为空，请先在【基本设置】中填写");
        return;
    }

    try
    {
        btnLoginCommand.Enabled = false;
        AppendCommandResult($"🔐 发送登录命令...");
        AppendCommandResult($"   用户名: {username}");
        AppendCommandResult($"   密码: ******");
        AppendCommandResult($"   时间: {DateTime.Now:yyyy-MM-dd HH:mm:ss.fff}");

        // 构造 Login 命令
        var commandData = new
        {
            command = "Login",
            data = new
            {
                username = username,
                password = password
            }
        };

        // 发送到浏览器
        var result = await SendCommandToBrowserAsync(_selectedConfig.Id, commandData);

        if (result.success)
        {
            AppendCommandResult($"✅ 登录命令已发送");
            AppendCommandResult($"   响应: {result.message}");
            
            if (!string.IsNullOrEmpty(result.data))
            {
                AppendCommandResult($"   详情: {result.data}");
            }
        }
        else
        {
            AppendCommandResult($"❌ 登录命令失败: {result.errorMessage}");
        }
    }
    catch (Exception ex)
    {
        AppendCommandResult($"❌ 异常: {ex.Message}");
        _logService.Error("BetConfigManager", "发送登录命令失败", ex);
    }
    finally
    {
        btnLoginCommand.Enabled = true;
    }
}
```

---

## 🧪 测试步骤

### 前置条件

1. ✅ VxMain 已启动
2. ✅ 浏览器客户端已启动并连接到 VxMain
3. ✅ 配置中已填写账号密码

---

### 测试步骤

#### 1. 基本功能测试

**步骤**：
1. 打开配置管理器
2. 选择默认配置
3. 切换到【基本设置】，确认账号密码已填写
4. 切换到【高级设置】
5. 点击【登录】按钮

**期望结果**：
- 命令结果面板显示：
  ```
  🔐 发送登录命令...
     用户名: kkk99
     密码: ******
     时间: 2025-11-18 14:30:27.854
  ✅ 登录命令已发送
     响应: 登录成功
  ```

**浏览器端日志**：
- 显示接收到 Login 命令
- 显示保存登录凭据
- 显示执行登录并成功

---

#### 2. 账号密码为空测试

**步骤**：
1. 在【基本设置】中清空账号或密码
2. 切换到【高级设置】
3. 点击【登录】按钮

**期望结果**：
- 命令结果面板显示：
  ```
  ❌ 错误:账号或密码为空，请先在【基本设置】中填写
  ```

---

#### 3. 浏览器未启动测试

**步骤**：
1. 关闭浏览器客户端（或停止浏览器）
2. 点击【登录】按钮

**期望结果**：
- 命令结果面板显示：
  ```
  🔐 发送登录命令...
     用户名: kkk99
     密码: ******
     时间: 2025-11-18 14:30:27.854
  ❌ 登录命令失败: 浏览器未连接
  ```

---

#### 4. 更新账号密码测试

**步骤**：
1. 在【基本设置】中修改账号密码
2. 点击【保存配置】
3. 切换到【高级设置】
4. 点击【登录】按钮
5. 查看浏览器端日志，确认新的账号密码

**期望结果**：
- 浏览器端日志显示：
  ```
  [14:30:27.871] 💾 已保存登录凭据: 用户名=new_username
  ```

---

## 📊 UI 界面

### 位置

**配置管理器 → 高级设置 → 命令面板**

```
┌────────────────────────────────────────────────┐
│ 命令面板                                       │
├────────────────────────────────────────────────┤
│ 快捷按钮:                                      │
│ ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐          │
│ │ 投注 │ │ 刷新 │ │ Cookie│ │ 登录 │  ← 这里  │
│ └──────┘ └──────┘ └──────┘ └──────┘          │
├────────────────────────────────────────────────┤
│ 命令输入:                                      │
│ ┌────────────────────────────────────────┐    │
│ │ {"command":"Login","data":{...}}       │    │
│ └────────────────────────────────────────┘    │
│ ┌──────────┐                                   │
│ │ 发送命令 │                                   │
│ └──────────┘                                   │
├────────────────────────────────────────────────┤
│ 命令结果:                                      │
│ ┌────────────────────────────────────────┐    │
│ │ 🔐 发送登录命令...                     │    │
│ │    用户名: kkk99                       │    │
│ │    密码: ******                        │    │
│ │ ✅ 登录命令已发送                      │    │
│ └────────────────────────────────────────┘    │
└────────────────────────────────────────────────┘
```

---

## 🎯 与自动登录的关系

### 自动登录流程

```
1. VxMain 启动 BsBrowserClient.exe
   ↓
2. 浏览器启动后，通过 Socket 连接到 VxMain
   ↓
3. VxMain 自动发送 Login 命令（包含账号密码）
   ↓
4. 浏览器保存账号密码到 _username 和 _password
   ↓
5. 页面加载完成，触发自动登录
   ↓
6. 自动登录使用保存的账号密码（无需 HTTP API）
   ↓
7. 登录成功
```

---

### 登录命令的作用

| 场景 | 自动登录 | 登录命令按钮 |
|------|---------|------------|
| **浏览器启动时** | ✅ VxMain 自动发送 | ❌ 无需手动 |
| **修改账号密码后** | ❌ 不会自动更新 | ✅ 手动发送更新 |
| **测试登录功能** | ❌ 需要重启浏览器 | ✅ 直接测试 |
| **手动触发登录** | ❌ 只在页面加载时 | ✅ 任何时候都可以 |

---

## 📝 总结

### 功能特点

1. **快速测试**：无需重启浏览器，直接测试登录功能
2. **更新凭据**：修改账号密码后，快速更新浏览器端
3. **手动触发**：任何时候都可以手动触发登录
4. **详细反馈**：实时显示命令发送和响应结果

---

### 使用建议

1. **正常使用**：VxMain 会自动发送 Login 命令，无需手动点击
2. **修改密码**：修改配置后，点击【登录】按钮更新浏览器端
3. **调试测试**：开发调试时，使用【登录】按钮测试登录流程
4. **故障排查**：登录失败时，使用【登录】按钮重新尝试

---

**文档时间**：2025-11-18  
**相关文件**：`BaiShengVx3Plus/Views/AutoBet/BetConfigManagerForm.cs`  
**功能状态**：✅ 已实现并可用

