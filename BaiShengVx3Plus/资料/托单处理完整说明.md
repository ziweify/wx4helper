# 托单处理完整说明

## 📋 托单的定义

**托单**是指会员等级为"托"（`MemberState.托`）的会员下的订单，订单类型为 `OrderType.托`。

**托单的特殊性**：
- ✅ **正常扣钱、正常结算** - 影响会员个人余额和统计
- ❌ **不投注到平台** - 封盘时不发送到博彩平台
- ❌ **不计入全局统计** - 不影响 `BinggoStatisticsService` 的全局统计数据

---

## 🔄 托单的完整生命周期

### 1️⃣ 下单阶段 (`BinggoOrderService.CreateOrderAsync`)

#### 订单类型初始化
**代码位置**: `BinggoOrderService.cs` 第159行

```csharp
// 🔥 订单类型根据会员等级初始化（参考 F5BotV2）
// 托单：不投注到平台，但正常扣钱、正常结算
OrderType = member.State == MemberState.托 ? OrderType.托 : OrderType.待定,
```

**说明**：
- 会员等级为"托" → 订单类型 = `OrderType.托`
- 其他会员 → 订单类型 = `OrderType.待定`（投注后确定为盘内/盘外）

---

#### 扣除余额
**代码位置**: `BinggoOrderService.cs` 第176-185行

```csharp
// 4.1 扣除余额
// 🔥 重要：托单也要扣钱！（用户要求："托照样正常结算，什么都是走正常流程的，仅仅不投注而已"）
// 只有管理员不扣钱
if (member.State != MemberState.管理)
{
    _logService.Info("BinggoOrderService", 
        $"🔒 [下单] {member.Nickname} - 扣除前余额: {member.Balance:F2}");
    
    member.Balance -= (float)betContent.TotalAmount;
    
    _logService.Info("BinggoOrderService", 
        $"🔒 [下单] {member.Nickname} - 扣除 {betContent.TotalAmount:F2}，扣除后余额: {member.Balance:F2}");
}
```

**结果**：
- ✅ 托单：**扣除余额**（`member.Balance -= amount`）
- ❌ 管理：不扣除余额

---

#### 增加会员个人统计
**代码位置**: `BinggoOrderService.cs` 第188-192行

```csharp
// 4.2 增加待结算金额和统计（参考 F5BotV2 第 546 行）
// 🔥 重要：托单也要增加统计！（会员个人统计）
member.BetWait += (float)betContent.TotalAmount;
member.BetToday += (float)betContent.TotalAmount;
member.BetTotal += (float)betContent.TotalAmount;
member.BetCur += (float)betContent.TotalAmount;  // 本期下注
```

**结果**：
- ✅ 托单：**增加会员个人统计**
  - `BetWait`（待结算）
  - `BetToday`（今日下注）
  - `BetTotal`（总下注）
  - `BetCur`（本期下注）

---

#### 全局统计
**代码位置**: `BinggoOrderService.cs` 第217-219行

```csharp
// 🔥 7. 更新全局统计（实时增减，参考 F5BotV2 第 538-573 行：OnMemberOrderCreate）
// 注意：托单不计入统计（参考 F5BotV2 Line 548）
if (_statisticsService != null && order.OrderType != OrderType.托 && order.OrderStatus != OrderStatus.已取消)
{
    _statisticsService.OnOrderCreated(order);
}
```

**结果**：
- ❌ 托单：**不计入全局统计**（`_statisticsService.OnOrderCreated()` 不调用）
- ✅ 普通订单：计入全局统计

---

### 2️⃣ 封盘投注阶段 (`BinggoOrderService.GetPendingOrdersForIssue`)

**代码位置**: `BinggoOrderService.cs` 第559-561行

```csharp
// 🔥 排除托单（参考 F5BotV2）
var validOrders = allOrders
    .Where(o => o.OrderType != OrderType.托)
    .ToList();
```

**结果**：
- ❌ 托单：**不投注到平台**（从待投注订单列表中排除）
- ✅ 普通订单：投注到平台

**日志示例**：
```
📋 期号 114065211 的待投注订单: 5 单（排除 2 托单）
```

---

### 3️⃣ 开奖结算阶段

#### 📢 发送开奖消息到微信
**代码位置**: `BinggoLotteryService.cs` 第896-900行

```csharp
// 🔥 1. 获取当期所有订单（参考 F5BotV2 第 1420 行）
// 🔥 查询条件：期号匹配，且不是已取消/未知状态
// 🔥 重要：托单也要正常发送到微信（显示在中~名单和留~名单中）
var orders = allOrders
    .Where(o => o.IssueId == issueId 
        && o.OrderStatus != OrderStatus.已取消 
        && o.OrderStatus != OrderStatus.未知)
    .ToList();
```

**结果**：
- ✅ 托单：**正常显示在微信中~名单和留~名单中**
- ✅ 普通订单：正常显示

---

#### 更新会员余额和盈亏
**代码位置**: `BinggoOrderService.cs` 第503-521行

```csharp
var member = _membersBindingList?.FirstOrDefault(m => m.Wxid == order.Wxid);
if (member != null)  // 🔥 托单也正常结算（更新余额）
{
    _logService.Info("BinggoOrderService", 
        $"🔒 [开奖] {member.Nickname} - 结算前余额: {member.Balance:F2}, 待结算: {member.BetWait:F2}");
    
    // 🔥 关键逻辑（参考 F5BotV2 V2Member.OpenLottery）：
    // Balance += order.Profit (加上总赢金额，包含本金)
    // IncomeToday += (order.Profit - order.AmountTotal)  (今日盈亏 = 纯利)
    // IncomeTotal += (order.Profit - order.AmountTotal)  (总盈亏 = 纯利)
    
    member.Balance += order.Profit;  // 🔥 加上总赢金额
    member.IncomeToday += order.NetProfit;  // 🔥 今日盈亏（纯利）
    member.IncomeTotal += order.NetProfit;  // 🔥 总盈亏（纯利）
    
    // 🔥 扣除待结算金额（参考 F5BotV2 第 633 行: m.BetWait = m.BetWait - order.AmountTotal）
    member.BetWait -= order.AmountTotal;
    
    _logService.Info("BinggoOrderService", 
        $"🔒 [开奖] {member.Nickname} - 结算后余额: {member.Balance:F2}, 待结算: {member.BetWait:F2}, 今日盈亏: {member.IncomeToday:F2}");
```

**结果**：
- ✅ 托单：**正常结算**
  - 更新余额（`member.Balance += order.Profit`）
  - 更新今日盈亏（`member.IncomeToday += order.NetProfit`）
  - 更新总盈亏（`member.IncomeTotal += order.NetProfit`）
  - 减少待结算（`member.BetWait -= order.AmountTotal`）

---

#### 全局统计
**代码位置**: `BinggoOrderService.cs` 第525-528行

```csharp
// 🔥 更新全局盈利统计（参考 F5BotV2 第 626-635 行：OnMemberOrderFinish）
// 注意：托单不计入统计（参考 F5BotV2 Line 626）
if (_statisticsService != null && order.OrderType != OrderType.托)
{
    _statisticsService.OnOrderSettled(order);
}
```

**结果**：
- ❌ 托单：**不计入全局统计**（`_statisticsService.OnOrderSettled()` 不调用）
- ✅ 普通订单：计入全局统计

---

### 4️⃣ 取消订单阶段 (`BinggoLotteryService.HandleMessageAsync`)

#### 退款
**代码位置**: `BinggoLotteryService.cs` 第1283-1288行

```csharp
// 🔥 退款给会员（参考 F5BotV2 第2301行）
// 只有管理员不退款（因为下单时也没扣钱）
if (member.State != MemberState.管理)
{
    member.Balance += ods.AmountTotal;
    _logService.Info("BinggoLotteryService", 
        $"💰 退款: {member.Nickname} - 退款 {ods.AmountTotal:F2}，退款后余额: {member.Balance:F2}");
}
```

**结果**：
- ✅ 托单：**退款**（`member.Balance += ods.AmountTotal`）
- ❌ 管理：不退款

---

#### 减少会员个人统计
**代码位置**: `BinggoLotteryService.cs` 第1292-1298行

```csharp
// 🔥 减掉会员统计（参考 F5BotV2 第2302-2304行：OrderCancel 方法）
// 🔥 重要：托单也要减掉统计！（因为下单时增加了统计）
member.BetCur -= ods.AmountTotal;
member.BetToday -= ods.AmountTotal;
member.BetTotal -= ods.AmountTotal;
member.BetWait -= ods.AmountTotal;  // 减掉待结算金额

_logService.Info("BinggoLotteryService", 
    $"📊 统计更新: {member.Nickname} - 减掉投注 {ods.AmountTotal:F2} - 今日下注 {member.BetToday:F2}");
```

**结果**：
- ✅ 托单：**减少会员个人统计**
  - `BetCur`（本期下注）
  - `BetToday`（今日下注）
  - `BetTotal`（总下注）
  - `BetWait`（待结算）

---

#### 全局统计
**代码位置**: `BinggoLotteryService.cs` 第1304-1311行

```csharp
// 🔥 更新全局统计（参考 F5BotV2 第680-709行：OnMemberOrderCancel）
if (_statisticsService != null && ods.OrderType != OrderType.托)
{
    _logService.Info("BinggoLotteryService", 
        $"📊 调用统计服务减掉订单: 订单ID={ods.Id} 金额={ods.AmountTotal} 期号={ods.IssueId}");
    _statisticsService.OnOrderCanceled(ods);
    _logService.Info("BinggoLotteryService", 
        $"✅ 统计服务已调用: 总注={_statisticsService.BetMoneyTotal} 今投={_statisticsService.BetMoneyToday} 当前={_statisticsService.BetMoneyCur}");
}
```

**结果**：
- ❌ 托单：**不减少全局统计**（`_statisticsService.OnOrderCanceled()` 不调用）
- ✅ 普通订单：减少全局统计

---

## 📊 托单 vs 普通订单 对比表

| 操作 | 托单 | 普通订单 | 说明 |
|------|------|---------|------|
| **下单时** |  |  |  |
| 扣除余额 | ✅ 扣除 | ✅ 扣除 | 管理员不扣 |
| 增加个人统计 | ✅ 增加 | ✅ 增加 | BetWait, BetToday, BetTotal, BetCur |
| 计入全局统计 | ❌ 不计入 | ✅ 计入 | `_statisticsService.OnOrderCreated()` |
| **封盘时** |  |  |  |
| 投注到平台 | ❌ 不投注 | ✅ 投注 | **唯一区别：托单被排除** |
| **开奖时** |  |  |  |
| 发送到微信 | ✅ 发送 | ✅ 发送 | 显示在中~名单和留~名单中 |
| 结算余额 | ✅ 结算 | ✅ 结算 | Balance += Profit |
| 更新盈亏 | ✅ 更新 | ✅ 更新 | IncomeToday, IncomeTotal |
| 减少待结算 | ✅ 减少 | ✅ 减少 | BetWait -= AmountTotal |
| 计入全局统计 | ❌ 不计入 | ✅ 计入 | `_statisticsService.OnOrderSettled()` |
| **取消时** |  |  |  |
| 退款 | ✅ 退款 | ✅ 退款 | 管理员不退 |
| 减少个人统计 | ✅ 减少 | ✅ 减少 | BetWait, BetToday, BetTotal, BetCur |
| 减少全局统计 | ❌ 不减少 | ✅ 减少 | `_statisticsService.OnOrderCanceled()` |

---

## 🎯 核心设计原则

### 会员个人统计 vs 全局统计

#### 会员个人统计（`V2Member` 字段）
- `Balance`（余额）
- `BetWait`（待结算）
- `BetToday`（今日下注）
- `BetTotal`（总下注）
- `BetCur`（本期下注）
- `IncomeToday`（今日盈亏）
- `IncomeTotal`（总盈亏）

**托单**：✅ **影响会员个人统计**

---

#### 全局统计（`BinggoStatisticsService` 字段）
- `BetMoneyTotal`（全局总注）
- `BetMoneyToday`（全局今投）
- `BetMoneyCur`（全局当前）
- `IncomeTotal`（全局总盈）
- `IncomeToday`（全局今盈）

**托单**：❌ **不影响全局统计**

---

## 📝 总结

**托单的本质**：
> "托的输赢结果也正常发向微信，也跟正常订单一样结算流程，一样发布到微信，仅仅打包投注时候过滤掉"

**核心理念**：
1. ✅ **托单是真实订单** - 扣钱、结算、退款都正常进行
2. ✅ **托单影响会员个人数据** - 余额、个人统计都正常更新
3. ✅ **托单正常发送到微信** - 显示在中~名单和留~名单中
4. ❌ **托单不投注到平台** - 封盘时排除，不发送到博彩平台（**唯一区别**）
5. ❌ **托单不计入全局统计** - 不影响系统的全局统计数据

**代码实现关键点**：
- 订单类型根据会员等级初始化：`OrderType = member.State == MemberState.托 ? OrderType.托 : OrderType.待定`
- 扣款/退款判断：`if (member.State != MemberState.管理)`（托单正常扣款/退款）
- **封盘投注过滤**（**唯一过滤点**）：`Where(o => o.OrderType != OrderType.托)`（托单不投注）
- **开奖微信消息**：托单**不过滤**，正常显示在中~名单和留~名单中
- 全局统计过滤：`if (order.OrderType != OrderType.托)`（托单不计入全局统计）

**所有代码已正确实现，符合用户要求！** ✅

