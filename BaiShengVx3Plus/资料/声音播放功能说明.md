# 声音播放功能说明

## 📢 声音播放时机（参考 F5BotV2）

### 1. ✅ 封盘时播放声音
**文件**: `BinggoLotteryService.cs` (第1865行)  
**方法**: `SendSealingMessage()`  
**声音**: `mp3_fp.mp3` (封盘)  
**触发条件**: 当距离开奖剩余时间 = 配置的提前封盘秒数时

```csharp
// 🔥 播放封盘声音（参考 F5BotV2 第1247行）
// 声音是本地提示，不依赖群绑定状态，应该始终播放
_soundService?.PlaySealingSound();
```

**F5BotV2参考**: 第1247行 `PlayMp3("mp3_fp.mp3")`

**🔥 重要修复（2025-11-18）**:
- **问题**: 之前封盘声音在 `if (没有绑定群) return;` 之后，导致未绑定群时不播放
- **修复**: 将声音播放移到方法开头，在任何条件判断之前执行
- **理由**: 声音是本地提示，不应该依赖群绑定状态或微信连接状态

---

### 2. ✅ 开奖时播放声音
**文件**: `BinggoLotteryService.cs` (第888行 和 第968行)  
**方法**: `OnLotteryOpenedAsync()`  
**声音**: `mp3_kj.mp3` (开奖)  
**触发条件**: 
- 从API获取到开奖数据时
- 发送中奖名单和留分名单到微信群时

```csharp
// 🔥 播放开奖声音（参考 F5BotV2 第1411行）
_soundService?.PlayLotterySound();
```

**F5BotV2参考**: 第1411行 `PlayMp3("mp3_kj.mp3")`

**注意**: 开奖声音播放了2次（和 F5BotV2 一致）：
1. 第888行：开奖处理开始时
2. 第968行：发送中奖名单前

---

### 3. ✅ 上分时播放声音
**文件**: `CreditWithdrawService.cs` (第107行)  
**方法**: `ProcessCreditWithdraw()`  
**声音**: `mp3_shang.mp3` (上分)  
**触发条件**: 
- 上分操作成功后
- `isLoading = false` (不是加载历史数据)

```csharp
// 🔥 播放上分声音（参考 F5BotV2 第2597行：PlayMp3("mp3_shang.mp3")）
if (!isLoading && _soundService != null)
{
    try
    {
        _soundService.PlayCreditUpSound();
    }
    catch (Exception ex)
    {
        _logService.Warning("CreditWithdrawService", $"播放上分声音失败: {ex.Message}");
    }
}
```

**F5BotV2参考**: 第2597行 `PlayMp3("mp3_shang.mp3")`

---

### 4. ✅ 下分时播放声音
**文件**: `CreditWithdrawService.cs` (第151行)  
**方法**: `ProcessCreditWithdraw()`  
**声音**: `mp3_xia.mp3` (下分)  
**触发条件**: 
- 下分操作成功后
- `isLoading = false` (不是加载历史数据)

```csharp
// 🔥 播放下分声音（参考 F5BotV2 第2599行：PlayMp3("mp3_xia.mp3")）
if (!isLoading && _soundService != null)
{
    try
    {
        _soundService.PlayCreditDownSound();
    }
    catch (Exception ex)
    {
        _logService.Warning("CreditWithdrawService", $"播放下分声音失败: {ex.Message}");
    }
}
```

**F5BotV2参考**: 第2599行 `PlayMp3("mp3_xia.mp3")`

---

### 5. ❌ 开盘时没有声音（和 F5BotV2 一致）
**说明**: F5BotV2 中开盘时（"线下开始"消息）不播放声音，只有封盘、开奖、上分、下分时才播放。

---

## 🔊 声音文件位置

所有声音文件位于: `BaiShengVx3Plus\sound\`

| 文件名 | 说明 | 大小 |
|--------|------|------|
| `mp3_fp.mp3` | 封盘声音 | ✅ 存在 |
| `mp3_kj.mp3` | 开奖声音 | ✅ 存在 |
| `mp3_shang.mp3` | 上分声音 | ✅ 存在 |
| `mp3_xia.mp3` | 下分声音 | ✅ 存在 |
| `mp3_kjlose.mp3` | 开奖输了声音 | ✅ 存在（备用）|

---

## 🔧 声音服务注入

### 依赖注入配置
**文件**: `Program.cs` (第60行)

```csharp
services.AddSingleton<Services.Sound.SoundService>();  // 🔥 声音播放服务
```

### 服务构造函数
1. **BinggoLotteryService** (封盘、开奖声音)
   ```csharp
   public BinggoLotteryService(
       ILogService logService,
       IConfigurationService configService,
       Services.Sound.SoundService? soundService = null)
   ```

2. **CreditWithdrawService** (上分、下分声音)
   ```csharp
   public CreditWithdrawService(
       SQLiteConnection db,
       ILogService logService,
       BinggoStatisticsService statisticsService,
       IWeixinSocketClient? socketClient = null,
       Services.Sound.SoundService? soundService = null)
   ```

---

## 🐛 调试指南

### 如果没有声音，请检查：

1. **检查声音服务是否注入成功**
   - 查看日志：`✅ 创建声音文件目录: xxx\sound`
   - 如果没有这条日志，说明声音服务未创建

2. **检查声音播放日志**
   - 正常：`🔊 播放声音: mp3_xxx.mp3`
   - 文件不存在：`⚠️ 声音文件不存在: xxx`
   - 播放失败：`播放声音失败: xxx`

3. **检查声音文件是否存在**
   - 确保 `BaiShengVx3Plus\sound\` 目录下有所有 `.mp3` 文件
   - 文件大小不为 0

4. **检查 isLoading 参数**（仅上下分）
   - 上分/下分声音只在 `isLoading = false` 时播放
   - 如果是加载历史数据，不会播放声音

5. **检查异常捕获**
   - 上分/下分声音有 `try-catch`，异常会被记录为 Warning
   - 查看日志：`播放上分声音失败` 或 `播放下分声音失败`

---

## 📊 与 F5BotV2 对照表

| 事件 | F5BotV2 行号 | BaiShengVx3Plus 位置 | 声音文件 | 状态 |
|------|-------------|---------------------|----------|------|
| 封盘 | 第1247行 | `BinggoLotteryService.cs:1879` | `mp3_fp.mp3` | ✅ 已实现 |
| 开奖 | 第1411行 | `BinggoLotteryService.cs:888, 968` | `mp3_kj.mp3` | ✅ 已实现 |
| 上分 | 第2597行 | `CreditWithdrawService.cs:107` | `mp3_shang.mp3` | ✅ 已实现 |
| 下分 | 第2599行 | `CreditWithdrawService.cs:151` | `mp3_xia.mp3` | ✅ 已实现 |
| 开盘 | 无 | 无 | 无 | ❌ F5BotV2 也无 |

---

## ✅ 总结

- ✅ **封盘声音**: 已实现，和 F5BotV2 一致
- ✅ **开奖声音**: 已实现，和 F5BotV2 一致（播放2次）
- ✅ **上分声音**: 已实现，和 F5BotV2 一致
- ✅ **下分声音**: 已实现，和 F5BotV2 一致
- ❌ **开盘声音**: F5BotV2 也没有开盘声音

**所有声音播放点都已按照 F5BotV2 的设计实现完成！**

