# BsBrowserClient æ—¥å¿—æŒä¹…åŒ–è®¾è®¡æ–¹æ¡ˆ

> **ç›®æ ‡**: å°†å†…å­˜æ—¥å¿—æŒä¹…åŒ–åˆ°ç£ç›˜ï¼Œä¸å½±å“ç¨‹åºæ€§èƒ½  
> **æ—¥æœŸ**: 2025-12-16

---

## ğŸ“Š **æ—¥å¿—é‡åˆ†æ**

### **å½“å‰å†…å­˜æ—¥å¿—çŠ¶æ€**

| æŒ‡æ ‡ | å½“å‰å€¼ | è¯´æ˜ |
|------|--------|------|
| UI æ˜¾ç¤ºæœ€å¤§è¡Œæ•° | 1000 è¡Œ | `MAX_LOG_LINES` |
| å†…å­˜ç¼“å†²åŒºæœ€å¤§ | 2000 æ¡ | `MAX_LOG_LINES * 2` |
| ç¼“å†²åŒºå†…å­˜å ç”¨ | 200-400 KB | æ¯æ¡çº¦ 100-200 å­—èŠ‚ |
| æ—¥å¿—æ›´æ–°é¢‘ç‡ | 100ms/æ‰¹æ¬¡ | æ¯æ¬¡æœ€å¤š 50 æ¡ |

### **æ—¥å¿—ç±»å‹ä¸é¢‘ç‡ä¼°ç®—**

| æ—¥å¿—ç±»å‹ | é¢‘ç‡ | ç¤ºä¾‹ |
|---------|------|------|
| **System** | ä½é¢‘ (1-10/åˆ†é’Ÿ) | å¯åŠ¨ã€è¿æ¥ã€é…ç½®å˜æ›´ |
| **Socket** | ä¸­é¢‘ (10-60/åˆ†é’Ÿ) | å‘½ä»¤ã€å¿ƒè·³ã€å“åº” |
| **Bet** | ä¸­é¢‘ (10-100/åˆ†é’Ÿ) | æŠ•æ³¨æ“ä½œã€ç»“æœ |
| **Http** | **é«˜é¢‘ (100-1000/åˆ†é’Ÿ)** | æ¯ä¸ª HTTP è¯·æ±‚æ‹¦æˆª |

### **æ—¥å¿—æ–‡ä»¶å¤§å°é¢„ä¼°**

#### **åœºæ™¯ 1: æ­£å¸¸ä½¿ç”¨ï¼ˆHTTPæ—¥å¿—å…³é—­ï¼‰**

```
å¹³å‡æ¯æ¡æ—¥å¿—: 150 å­—èŠ‚
System + Socket + Bet: çº¦ 10 æ¡/ç§’
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ¯å°æ—¶: 10 * 3600 = 36,000 æ¡ â‰ˆ 5.4 MB
æ¯å¤©: 5.4 MB * 24 = 129.6 MB
æ¯æœˆ: 129.6 MB * 30 â‰ˆ 3.9 GB
```

#### **åœºæ™¯ 2: è°ƒè¯•æ¨¡å¼ï¼ˆHTTPæ—¥å¿—å¼€å¯ï¼‰**

```
å¹³å‡æ¯æ¡æ—¥å¿—: 200 å­—èŠ‚ï¼ˆHTTP æ—¥å¿—æ›´é•¿ï¼‰
System + Socket + Bet + HTTP: çº¦ 100 æ¡/ç§’
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ¯å°æ—¶: 100 * 3600 = 360,000 æ¡ â‰ˆ 72 MB
æ¯å¤©: 72 MB * 24 â‰ˆ 1.7 GB
æ¯æœˆ: 1.7 GB * 30 â‰ˆ 51 GB âš ï¸
```

### **ç»“è®º**

- âœ… **æ­£å¸¸ä½¿ç”¨**: æ—¥å¿—é‡é€‚ä¸­ï¼ˆæ¯å¤© ~130 MBï¼‰ï¼Œä¸å½±å“æŸ¥çœ‹å’Œåˆ†æ
- âš ï¸ **è°ƒè¯•æ¨¡å¼**: æ—¥å¿—é‡å·¨å¤§ï¼ˆæ¯å¤© ~1.7 GBï¼‰ï¼Œéœ€è¦è€ƒè™‘ï¼š
  - æ—¥å¿—æ–‡ä»¶è‡ªåŠ¨æ¸…ç†ï¼ˆä¿ç•™æœ€è¿‘ 7 å¤©ï¼‰
  - æ”¯æŒæ—¥å¿—çº§åˆ«è¿‡æ»¤
  - ä½¿ç”¨å‹ç¼©å­˜å‚¨ï¼ˆå¯å‡å°‘ 70-80% ç©ºé—´ï¼‰

---

## ğŸ¯ **è®¾è®¡æ–¹æ¡ˆé€‰æ‹©**

### **æ–¹æ¡ˆå¯¹æ¯”**

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | æ€§èƒ½å½±å“ |
|------|------|------|---------|
| **1. å®æ—¶å†™å…¥** | ç®€å•ï¼Œæ•°æ®ä¸ä¸¢å¤± | é¢‘ç¹ I/Oï¼Œå½±å“æ€§èƒ½ | âŒ é«˜ |
| **2. å®šæ—¶æ‰¹é‡å†™å…¥** | æ€§èƒ½å¥½ï¼ŒI/O é›†ä¸­ | ç¨‹åºå´©æºƒå¯èƒ½ä¸¢å¤±æ•°æ® | âš ï¸ ä¸­ |
| **3. ç¼“å†²åŒºæ¸…ç†æ—¶å†™å…¥** | æ€§èƒ½å¥½ï¼Œä¸ä¸¢å¤±æ•°æ® | å®ç°å¤æ‚ | âœ… ä½ |
| **4. å¼‚æ­¥é˜Ÿåˆ—å†™å…¥** | æœ€ä½³æ€§èƒ½ï¼Œä¸é˜»å¡ | å®ç°æœ€å¤æ‚ | âœ… æä½ |

### **âœ… æ¨èæ–¹æ¡ˆï¼šå¼‚æ­¥é˜Ÿåˆ— + ç¼“å†²åŒºè§¦å‘**

**æ ¸å¿ƒæ€è·¯**ï¼ˆç”¨æˆ·çš„å»ºè®®ï¼‰ï¼š

1. **åœ¨ç¼“å†²åŒºæ¸…ç†æ—¶å†™å…¥**
   ```csharp
   while (_logBuffer.Count > MAX_LOG_LINES * 2)
   {
       var oldLog = _logBuffer.Dequeue();
       _diskWriteQueue.Enqueue(oldLog);  // åŠ å…¥ç£ç›˜å†™å…¥é˜Ÿåˆ—
   }
   ```

2. **ç¨‹åºé€€å‡ºæ—¶å†™å…¥å‰©ä½™æ—¥å¿—**
   ```csharp
   protected override void OnFormClosing(FormClosingEventArgs e)
   {
       FlushAllLogs();  // å†™å…¥æ‰€æœ‰å‰©ä½™æ—¥å¿—
       base.OnFormClosing(e);
   }
   ```

3. **å¼‚æ­¥åå°çº¿ç¨‹å†™å…¥**
   ```csharp
   // åå°çº¿ç¨‹æŒç»­ç›‘å¬å†™å…¥é˜Ÿåˆ—ï¼Œæ‰¹é‡å†™å…¥ç£ç›˜
   Task.Run(() => DiskWriteWorker());
   ```

---

## ğŸ—ï¸ **è¯¦ç»†è®¾è®¡**

### **1. åŒç¼“å†²æœºåˆ¶**

```
[UI æ—¥å¿—ç¼“å†²åŒº] (_logBuffer)
      â†“ æ»¡äº†/æ¸…ç†
[ç£ç›˜å†™å…¥é˜Ÿåˆ—] (_diskWriteQueue)
      â†“ åå°çº¿ç¨‹
[ç£ç›˜æ–‡ä»¶] (æŒ‰æ—¥æœŸåˆ†æ–‡ä»¶)
```

### **2. æ•°æ®ç»“æ„**

```csharp
// å†…å­˜æ—¥å¿—ç¼“å†²åŒºï¼ˆåŸæœ‰ï¼‰
private readonly Queue<string> _logBuffer = new Queue<string>();
private const int MAX_LOG_LINES = 1000;

// ç£ç›˜å†™å…¥é˜Ÿåˆ—ï¼ˆæ–°å¢ï¼‰
private readonly ConcurrentQueue<string> _diskWriteQueue = new ConcurrentQueue<string>();
private readonly SemaphoreSlim _diskWriteSemaphore = new SemaphoreSlim(0);

// ç£ç›˜å†™å…¥çº¿ç¨‹ï¼ˆæ–°å¢ï¼‰
private CancellationTokenSource? _diskWriteCts;
private Task? _diskWriteTask;

// æ—¥å¿—æ–‡ä»¶è·¯å¾„
private readonly string _logFolder;
private string _currentLogFile = "";
private DateTime _currentLogDate = DateTime.MinValue;
```

### **3. å†™å…¥è§¦å‘æ—¶æœº**

#### **è§¦å‘ç‚¹ 1: ç¼“å†²åŒºæ¸…ç†**

```csharp
lock (_logBuffer)
{
    _logBuffer.Enqueue(logLine);
    
    // å¦‚æœç¼“å†²åŒºè¿‡å¤§ï¼Œç§»é™¤æ—§æ—¥å¿—å¹¶å†™å…¥ç£ç›˜
    while (_logBuffer.Count > MAX_LOG_LINES * 2)
    {
        var oldLog = _logBuffer.Dequeue();
        EnqueueDiskWrite(oldLog);  // ğŸ”¥ è§¦å‘ç£ç›˜å†™å…¥
    }
}
```

#### **è§¦å‘ç‚¹ 2: å®šæ—¶æ‰¹é‡å†™å…¥ï¼ˆå¯é€‰ï¼‰**

```csharp
// æ¯ 5 ç§’æ‰¹é‡å†™å…¥ä¸€æ¬¡ï¼ˆé˜²æ­¢ç¼“å†²åŒºä¸æ»¡å¯¼è‡´æ—¥å¿—ä¸å†™å…¥ï¼‰
private System.Threading.Timer? _diskFlushTimer;

private void InitializeDiskWriter()
{
    _diskFlushTimer = new Timer(
        callback: _ => FlushDiskWriteQueue(),
        state: null,
        dueTime: TimeSpan.FromSeconds(5),
        period: TimeSpan.FromSeconds(5)
    );
}
```

#### **è§¦å‘ç‚¹ 3: ç¨‹åºé€€å‡º**

```csharp
protected override void OnFormClosing(FormClosingEventArgs e)
{
    // 1. åœæ­¢æ¥æ”¶æ–°æ—¥å¿—
    _diskWriteCts?.Cancel();
    
    // 2. å†™å…¥æ‰€æœ‰å‰©ä½™æ—¥å¿—
    FlushAllLogs();
    
    // 3. ç­‰å¾…å†™å…¥å®Œæˆ
    _diskWriteTask?.Wait(TimeSpan.FromSeconds(5));
    
    base.OnFormClosing(e);
}
```

### **4. å¼‚æ­¥å†™å…¥å®ç°**

```csharp
/// <summary>
/// ç£ç›˜å†™å…¥å·¥ä½œçº¿ç¨‹
/// </summary>
private async Task DiskWriteWorker()
{
    var batchBuffer = new List<string>(100);
    
    while (!_diskWriteCts?.Token.IsCancellationRequested ?? false)
    {
        try
        {
            // ç­‰å¾…æ–°æ—¥å¿—æˆ–è¶…æ—¶ï¼ˆæœ€å¤šç­‰å¾… 1 ç§’ï¼‰
            await _diskWriteSemaphore.WaitAsync(1000, _diskWriteCts.Token);
            
            // æ‰¹é‡æ”¶é›†æ—¥å¿—ï¼ˆæœ€å¤š 100 æ¡ï¼‰
            batchBuffer.Clear();
            while (batchBuffer.Count < 100 && _diskWriteQueue.TryDequeue(out var log))
            {
                batchBuffer.Add(log);
            }
            
            if (batchBuffer.Count == 0) continue;
            
            // æ‰¹é‡å†™å…¥ç£ç›˜ï¼ˆå¼‚æ­¥ I/Oï¼‰
            await WriteBatchToDiskAsync(batchBuffer);
        }
        catch (OperationCanceledException)
        {
            break;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"ç£ç›˜å†™å…¥å¤±è´¥: {ex.Message}");
        }
    }
}
```

### **5. æ—¥å¿—æ–‡ä»¶ç®¡ç†**

#### **æŒ‰æ—¥æœŸåˆ†æ–‡ä»¶**

```csharp
private string GetLogFilePath()
{
    var today = DateTime.Now.Date;
    
    // å¦‚æœæ—¥æœŸå˜åŒ–ï¼Œåˆ‡æ¢åˆ°æ–°æ–‡ä»¶
    if (today != _currentLogDate)
    {
        _currentLogDate = today;
        _currentLogFile = Path.Combine(
            _logFolder,
            $"BsBrowserClient_{today:yyyyMMdd}.log"
        );
    }
    
    return _currentLogFile;
}
```

#### **è‡ªåŠ¨æ¸…ç†æ—§æ—¥å¿—**

```csharp
/// <summary>
/// æ¸…ç† 7 å¤©å‰çš„æ—¥å¿—æ–‡ä»¶
/// </summary>
private void CleanOldLogs()
{
    try
    {
        var cutoffDate = DateTime.Now.AddDays(-7);
        var logFiles = Directory.GetFiles(_logFolder, "BsBrowserClient_*.log");
        
        foreach (var file in logFiles)
        {
            var fileInfo = new FileInfo(file);
            if (fileInfo.LastWriteTime < cutoffDate)
            {
                File.Delete(file);
                Console.WriteLine($"å·²åˆ é™¤æ—§æ—¥å¿—: {fileInfo.Name}");
            }
        }
    }
    catch (Exception ex)
    {
        Console.WriteLine($"æ¸…ç†æ—§æ—¥å¿—å¤±è´¥: {ex.Message}");
    }
}
```

---

## âš¡ **æ€§èƒ½ä¼˜åŒ–**

### **1. æ‰¹é‡å†™å…¥**

```csharp
// âŒ ä½æ•ˆï¼šæ¯æ¡æ—¥å¿—éƒ½æ‰“å¼€æ–‡ä»¶
File.AppendAllText(logFile, log);

// âœ… é«˜æ•ˆï¼šæ‰¹é‡å†™å…¥ï¼ˆ100 æ¡ä¸€æ‰¹ï¼‰
using var writer = new StreamWriter(logFile, append: true, Encoding.UTF8);
foreach (var log in batchBuffer)
{
    await writer.WriteAsync(log);
}
await writer.FlushAsync();
```

**æ€§èƒ½æå‡**: å‡å°‘ 99% çš„æ–‡ä»¶æ‰“å¼€/å…³é—­æ“ä½œ

### **2. å¼‚æ­¥ I/O**

```csharp
// âŒ åŒæ­¥ I/Oï¼ˆé˜»å¡çº¿ç¨‹ï¼‰
File.AppendAllText(logFile, log);

// âœ… å¼‚æ­¥ I/Oï¼ˆä¸é˜»å¡ï¼‰
await writer.WriteAsync(log);
```

**æ€§èƒ½æå‡**: ä¸»çº¿ç¨‹å®Œå…¨ä¸é˜»å¡

### **3. æ— é”é˜Ÿåˆ—**

```csharp
// âœ… ä½¿ç”¨ ConcurrentQueueï¼ˆæ— é”ï¼‰
private readonly ConcurrentQueue<string> _diskWriteQueue = new();

// ç”Ÿäº§è€…ï¼ˆä¸»çº¿ç¨‹ï¼‰
_diskWriteQueue.Enqueue(log);

// æ¶ˆè´¹è€…ï¼ˆåå°çº¿ç¨‹ï¼‰
while (_diskWriteQueue.TryDequeue(out var log)) { ... }
```

**æ€§èƒ½æå‡**: æ— é”è®¾è®¡ï¼Œé›¶ç­‰å¾…

### **4. ä¿¡å·é‡é€šçŸ¥**

```csharp
// ç”Ÿäº§è€…ï¼šåŠ å…¥é˜Ÿåˆ—åé€šçŸ¥
_diskWriteQueue.Enqueue(log);
_diskWriteSemaphore.Release();  // é€šçŸ¥åå°çº¿ç¨‹

// æ¶ˆè´¹è€…ï¼šç­‰å¾…ä¿¡å·ï¼ˆä¸ç©ºè½¬ï¼‰
await _diskWriteSemaphore.WaitAsync(1000);
```

**æ€§èƒ½æå‡**: é¿å… CPU ç©ºè½¬

---

## ğŸ“ **å†…å­˜ä¸æ€§èƒ½ä¼°ç®—**

### **å†…å­˜å ç”¨**

| ç»„ä»¶ | å¤§å° | è¯´æ˜ |
|------|------|------|
| _logBuffer | 200-400 KB | æœ€å¤š 2000 æ¡ |
| _diskWriteQueue | 10-50 KB | é€šå¸¸å¾ˆå°‘ï¼ˆå¿«é€Ÿå†™å…¥ï¼‰ |
| å†™å…¥çº¿ç¨‹æ ˆ | 1 MB | åå°çº¿ç¨‹ |
| **æ€»è®¡** | **~1.5 MB** | éå¸¸å° |

### **CPU å ç”¨**

| æ“ä½œ | CPU æ—¶é—´ | é¢‘ç‡ |
|------|---------|------|
| å…¥é˜Ÿæ“ä½œ | < 1 Î¼s | æ¯æ¡æ—¥å¿— |
| æ‰¹é‡å†™å…¥ | 1-10 ms | æ¯ 1-5 ç§’ |
| **æ€» CPU å ç”¨** | **< 0.1%** | å‡ ä¹æ— å½±å“ |

### **ç£ç›˜ I/O**

| åœºæ™¯ | I/O æ¬¡æ•° | å†™å…¥é‡ |
|------|---------|--------|
| æ­£å¸¸ä½¿ç”¨ | 1-2 æ¬¡/ç§’ | 1.5 KB/æ¬¡ |
| è°ƒè¯•æ¨¡å¼ | 5-10 æ¬¡/ç§’ | 15 KB/æ¬¡ |

**ç»“è®º**: âœ… å¯¹ç¨‹åºæ€§èƒ½å’Œç”µè„‘å¡é¡¿çš„å½±å“**å‡ ä¹ä¸ºé›¶**

---

## ğŸ¯ **æœ€ç»ˆæ–¹æ¡ˆæ€»ç»“**

### **æ ¸å¿ƒè®¾è®¡**

1. **åŒé˜Ÿåˆ—æœºåˆ¶**
   - UI æ—¥å¿—ç¼“å†²åŒºï¼ˆåŸæœ‰ï¼‰ï¼šå¿«é€Ÿæ˜¾ç¤º
   - ç£ç›˜å†™å…¥é˜Ÿåˆ—ï¼ˆæ–°å¢ï¼‰ï¼šå¼‚æ­¥æŒä¹…åŒ–

2. **ä¸‰ä¸ªè§¦å‘ç‚¹**
   - âœ… ç¼“å†²åŒºæ¸…ç†æ—¶ï¼ˆç”¨æˆ·å»ºè®®ï¼‰
   - âœ… å®šæ—¶æ‰¹é‡å†™å…¥ï¼ˆ5 ç§’ï¼‰
   - âœ… ç¨‹åºé€€å‡ºæ—¶ï¼ˆç”¨æˆ·å»ºè®®ï¼‰

3. **æ€§èƒ½ä¿è¯**
   - å¼‚æ­¥å†™å…¥ï¼Œä¸é˜»å¡ä¸»çº¿ç¨‹
   - æ‰¹é‡å†™å…¥ï¼Œå‡å°‘ I/O æ¬¡æ•°
   - æ— é”é˜Ÿåˆ—ï¼Œé›¶ç­‰å¾…

4. **æ•°æ®å®‰å…¨**
   - ç¼“å†²åŒºæ»¡æ—¶ç«‹å³å†™å…¥ï¼ˆä¸ä¸¢å¤±ï¼‰
   - ç¨‹åºé€€å‡ºæ—¶å¼ºåˆ¶å†™å…¥ï¼ˆä¸ä¸¢å¤±ï¼‰
   - å¼‚å¸¸æ•è·ï¼Œå†™å…¥å¤±è´¥ä¸å½±å“ç¨‹åº

### **ä¼˜åŠ¿**

- âœ… **æ€§èƒ½å½±å“æå°**: CPU < 0.1%, å†…å­˜ ~1.5 MB
- âœ… **ä¸å½±å“ UI**: å¼‚æ­¥åå°å†™å…¥
- âœ… **ä¸ä¸¢å¤±æ—¥å¿—**: å¤šä¸ªè§¦å‘ç‚¹ä¿è¯æ•°æ®å®‰å…¨
- âœ… **æ˜“äºæŸ¥çœ‹**: æŒ‰æ—¥æœŸåˆ†æ–‡ä»¶ï¼Œæ–‡æœ¬æ ¼å¼
- âœ… **è‡ªåŠ¨æ¸…ç†**: ä¿ç•™æœ€è¿‘ 7 å¤©

### **æ—¥å¿—æ–‡ä»¶è·¯å¾„**

```
%LocalAppData%\BaiShengVx3Plus\log\
â”œâ”€â”€ BsBrowserClient_20251216.log  (ä»Šå¤©)
â”œâ”€â”€ BsBrowserClient_20251215.log  (æ˜¨å¤©)
â”œâ”€â”€ BsBrowserClient_20251214.log
â”œâ”€â”€ ...
â””â”€â”€ BsBrowserClient_20251210.log  (7 å¤©å‰ï¼Œè‡ªåŠ¨åˆ é™¤)
```

---

## ğŸš€ **å®ç°æ­¥éª¤**

1. âœ… åˆ†ææ—¥å¿—é‡å’Œæ€§èƒ½å½±å“
2. âœ… è®¾è®¡åŒé˜Ÿåˆ—æœºåˆ¶
3. â³ å®ç°ç£ç›˜å†™å…¥é˜Ÿåˆ—
4. â³ å®ç°å¼‚æ­¥å†™å…¥çº¿ç¨‹
5. â³ æ·»åŠ ä¸‰ä¸ªè§¦å‘ç‚¹
6. â³ å®ç°æ—¥å¿—æ–‡ä»¶ç®¡ç†
7. â³ æµ‹è¯•å’Œæ€§èƒ½éªŒè¯

---

**è¿™ä¸ªæ–¹æ¡ˆé‡‡ç”¨äº†ç”¨æˆ·å»ºè®®çš„æ ¸å¿ƒæ€è·¯ï¼ˆç¼“å†²åŒºæ¸…ç†æ—¶å†™å…¥ + ç¨‹åºé€€å‡ºæ—¶å†™å…¥ï¼‰ï¼Œå¹¶å¢å¼ºäº†å¼‚æ­¥æœºåˆ¶ï¼Œç¡®ä¿é«˜æ€§èƒ½å’Œæ•°æ®å®‰å…¨ï¼** ğŸ‰

