# 测试平台 - 重试逻辑测试说明

## 📋 修改说明

**修改时间**：2026-01-19  
**修改目的**：测试系统的重试投注逻辑

## 🎯 测试场景

模拟**投注超时后查询订单失败**的场景，让系统继续走重试投注流程（与通宝一样）。

### 真实场景说明

在真实的投注场景中，可能出现以下情况：
1. 投注请求超时
2. 系统查询订单验证是否成功
3. **订单尚未同步，查询不到**
4. 系统判断投注失败，继续重试投注

## ✅ 修改内容

### 修改的方法

**文件**：`BsBrowserClient/PlatformScripts/TestPlatformScript.cs`  
**方法**：`GetLotMainOrderInfosAsync`

### 修改前逻辑

```csharp
// 查询订单，返回实际的模拟订单
var filteredOrders = _mockOrders
    .Where(o => (o["state"]?.Value<int>() ?? 0) == state)
    .ToList();

return (true, pagedOrders, totalRecords, totalPages, "");
```

**问题**：订单能查询到 → 系统认为投注成功 → 不会重试

### 修改后逻辑

```csharp
// 🔥 测试场景：故意返回空订单列表，让外部继续走投注流程
_logCallback($"📋 [测试平台] 实际已生成 {_mockOrders.Count} 个订单，但故意返回空列表（测试重试逻辑）");
_logCallback($"✅ [测试平台] 获取订单成功: 0条记录 (实际订单数={_mockOrders.Count})");

// 返回空订单列表（模拟查不到订单的场景）
return (true, new List<JObject>(), 0, 0, "");
```

**效果**：订单查不到 → 系统认为投注失败 → 继续重试投注

## 📊 工作流程

### 完整的投注重试流程

```
1. 用户发起投注 (1234大10)
   ↓
2. 测试平台：投注超时（2秒）
   ↓
3. 测试平台：实际已生成订单 (TEST1737342550_1)
   ↓
4. 系统查询订单验证
   ↓
5. 测试平台：返回空订单列表 ✅
   ↓
6. 系统判断：投注失败，未找到订单
   ↓
7. 系统重试投注 (继续投注流程)
   ↓
8. 测试平台：再次超时，再次生成订单 (TEST1737342560_2)
   ↓
9. 系统再次查询订单
   ↓
10. 测试平台：再次返回空订单列表 ✅
    ↓
11. 系统继续重试...（直到达到最大重试次数）
```

## 📝 日志示例

### 第1次投注尝试

```
🎲 [测试平台] 开始投注: 期号115003692 共3项 1500元
   - P1 大: 500元
   - P2 大: 500元
   - P3 大: 500元
⏳ [测试平台] 模拟投注请求...
⏰ [测试平台] 投注请求超时，开始验证订单...
🎲 [测试平台] 实际已生成订单: TEST1737342550_1（模拟服务器已处理）
📝 [测试平台] 创建模拟订单: TEST1737342550_1 | 期号:115003692 | 金额:1500元 | 内容:1大500,2大500,3大500

🔍 [测试平台] 查询未结算订单 (金额:1500元)...
📤 [测试平台] 获取订单列表: state=0, page=1/20, timeout=3秒
📋 [测试平台] 实际已生成 1 个订单，但故意返回空列表（测试重试逻辑）
✅ [测试平台] 获取订单成功: 0条记录 (实际订单数=1)

⚠️ [测试平台] 未找到匹配订单（可能还未同步）
❌ [测试平台] 投注超时，但订单可能已生成: TEST1737342550_1
```

**返回结果**：
```json
{
  "status": false,
  "msg": "投注请求超时"
}
```

### 第2次投注尝试（系统重试）

```
🎲 [测试平台] 开始投注: 期号115003692 共3项 1500元
⏳ [测试平台] 模拟投注请求...
⏰ [测试平台] 投注请求超时，开始验证订单...
🎲 [测试平台] 实际已生成订单: TEST1737342560_2（模拟服务器已处理）
📝 [测试平台] 创建模拟订单: TEST1737342560_2 | 期号:115003692 | 金额:1500元 | 内容:1大500,2大500,3大500

🔍 [测试平台] 查询未结算订单 (金额:1500元)...
📤 [测试平台] 获取订单列表: state=0, page=1/20, timeout=3秒
📋 [测试平台] 实际已生成 2 个订单，但故意返回空列表（测试重试逻辑）
✅ [测试平台] 获取订单成功: 0条记录 (实际订单数=2)

⚠️ [测试平台] 未找到匹配订单（可能还未同步）
❌ [测试平台] 投注超时，但订单可能已生成: TEST1737342560_2
```

**返回结果**：
```json
{
  "status": false,
  "msg": "投注请求超时"
}
```

### 系统继续重试...

直到达到**最大重试次数**（例如：5次），然后放弃投注。

## 🎯 测试目的

### 验证的功能点

✅ **重试投注逻辑**
- 系统是否正确识别投注失败
- 系统是否自动重试投注
- 重试次数是否符合预期

✅ **订单查询逻辑**
- 系统是否正确调用订单查询接口
- 系统是否正确处理"查不到订单"的场景

✅ **超时处理逻辑**
- 系统是否正确处理投注超时
- 系统是否在超时后验证订单

✅ **最大重试次数**
- 系统是否有最大重试次数限制
- 达到最大重试次数后是否停止重试

## 🔧 如何恢复原始逻辑

如果需要测试"查询到订单"的场景，可以修改 `GetLotMainOrderInfosAsync` 方法：

### 当前逻辑（测试重试）

```csharp
// 返回空订单列表（模拟查不到订单的场景）
return (true, new List<JObject>(), 0, 0, "");
```

### 恢复为原始逻辑（测试验证成功）

```csharp
// 取消注释 #region 原始逻辑 部分的代码
// 注释掉 "返回空订单列表" 这一行
```

**原始逻辑已保留在代码中（注释掉），可以随时恢复。**

## 📊 预期测试结果

### 场景1：系统有重试逻辑

**预期**：
- 第1次投注失败 → 系统自动重试
- 第2次投注失败 → 系统继续重试
- ...
- 第N次投注失败 → 达到最大重试次数，停止重试

**日志特征**：
- 多次 `🎲 [测试平台] 开始投注`
- 多次 `❌ [测试平台] 投注超时`
- 最终 `已达到最大重试次数` 或类似提示

### 场景2：系统没有重试逻辑（BUG）

**预期**：
- 第1次投注失败 → 系统不重试，直接放弃

**日志特征**：
- 只有1次 `🎲 [测试平台] 开始投注`
- 只有1次 `❌ [测试平台] 投注超时`
- 没有后续重试

## 🎉 总结

✅ **修改完成**：查询订单始终返回空列表  
✅ **测试目的**：验证系统的重试投注逻辑  
✅ **与通宝一致**：外部流程完全一样，只是查询结果不同  
✅ **方便测试**：详细的日志输出，清晰的订单计数  
✅ **易于恢复**：原始逻辑已保留，可随时切换

**现在可以开始测试系统的重试逻辑了！** 🚀

---

**修改日期**：2026-01-19  
**修改人员**：AI Assistant  
**测试状态**：✅ 编译成功，等待实际测试
