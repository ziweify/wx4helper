# TongBaoScript 投注容错重试机制说明

## 🎯 设计目标

解决网络不稳定导致的投注失败问题，通过**智能重试**和**订单验证**确保投注成功。

---

## 🔥 核心机制

### **1. 时间控制**

```
当前时间 ──→ 封盘时间 ──→ 开奖时间
             ↑           ↑
        (开奖-20秒)   (+0秒)
```

**计算逻辑：**
- 开奖时间：由期号计算（使用 `BinggoTimeHelper.GetIssueOpenTime()`）
- 封盘时间：开奖时间 - 20秒
- **投注截止**：超过封盘时间立即停止

---

### **2. 重试流程**

```
开始投注
    ↓
发送投注请求（2秒超时）
    ↓
┌──────────────────────────────┐
│  是否成功返回？              │
│  ├─ ✅ 是：解析响应           │
│  │   ├─ status=true → 成功   │
│  │   └─ status=false         │
│  │       ├─ 致命错误 → 退出  │
│  │       └─ 普通错误 → 重试  │
│  │                            │
│  └─ ⏰ 否（超时2秒）：        │
│      ├─ 查询未结算订单        │
│      ├─ 检查金额是否匹配      │
│      │   ├─ ✅ 匹配 → 成功   │
│      │   └─ ❌ 不匹配 → 重试 │
│      └─ 继续投注              │
└──────────────────────────────┘
    ↓
检查是否超过封盘时间
    ├─ ✅ 未超过 → 继续循环
    └─ ❌ 超过 → 退出失败
```

---

## 📋 **详细步骤**

### **步骤1：计算时间**

```csharp
var openTime = BinggoTimeHelper.GetIssueOpenTime(issueId);
var sealTime = openTime.AddSeconds(-20);
```

**示例：**
- 期号：114070636
- 开奖时间：23:15:00
- 封盘时间：23:14:40

---

### **步骤2：发送投注请求**

```csharp
var result = await _httpHelper.PostAsync(new HttpRequestItem
{
    Url = url,
    PostData = fullPostData,
    ContentType = "application/x-www-form-urlencoded",
    Timeout = 2  // 🔥 2秒超时
});
```

---

### **步骤3：处理响应**

#### **情况A：请求成功返回**

```csharp
if (result.Success)
{
    var json = JObject.Parse(responseText);
    var succeed = json["status"]?.Value<bool>() ?? false;
    
    if (succeed)
    {
        // ✅ 投注成功，返回订单号
        return (true, orderId, responseText);
    }
    else
    {
        var msg = json["msg"]?.ToString() ?? "";
        
        // 🔥 致命错误（不再重试）
        if (msg.Contains("余额不足") || msg.Contains("封盘") || msg.Contains("已结束"))
        {
            return (false, "", responseText);
        }
        
        // 🔥 普通错误（继续重试）
        await Task.Delay(1000);
        continue;
    }
}
```

#### **情况B：请求超时（2秒无响应）**

```csharp
// ⏰ 请求超时，可能网络卡了
_logCallback($"⏰ 投注请求超时，开始验证订单...");

// 🔍 查询未结算订单
var (success, orderList, _, _, errorMsg) = await GetLotMainOrderInfosAsync(
    state: 0,       // 未结算
    pageNum: 1,
    pageCount: 20,
    timeout: 3      // 查询超时3秒
);

if (success && orderList != null && orderList.Count > 0)
{
    // 🔍 遍历订单，查找匹配的
    foreach (var order in orderList)
    {
        var orderAmount = order["amount"]?.Value<int>() ?? 0;
        var orderExpect = order["expect"]?.ToString() ?? "";
        
        // 🎯 匹配条件：金额相同 && 期号相同
        if (orderAmount == (int)totalAmount && orderExpect == issueId.ToString())
        {
            var orderId = order["orderid"]?.ToString() ?? "";
            _logCallback($"✅ 找到匹配订单！投注已成功");
            
            // ✅ 返回成功（订单已存在）
            return (true, orderId, "verified");
        }
    }
}

// ⚠️ 未找到订单，继续重试
await Task.Delay(1000);
continue;
```

---

## 🎯 **匹配逻辑**

### **订单匹配条件**

```csharp
// 🎯 必须同时满足两个条件：
1. 订单金额 == 投注总金额
2. 订单期号 == 投注期号
```

**示例：**

| 投注数据 | 订单数据 | 是否匹配 |
|----------|----------|----------|
| 期号: 114070636, 金额: 20 | 期号: 114070636, 金额: 20 | ✅ 匹配 |
| 期号: 114070636, 金额: 20 | 期号: 114070636, 金额: 30 | ❌ 不匹配（金额不同） |
| 期号: 114070636, 金额: 20 | 期号: 114070637, 金额: 20 | ❌ 不匹配（期号不同） |

---

## ⏰ **时间控制**

### **封盘检查（每次重试前）**

```csharp
var now = DateTime.Now;

if (now > sealTime)
{
    _logCallback($"⏰ 已超过封盘时间({sealTime:HH:mm:ss})，停止投注");
    return (false, "", "#已超过封盘时间，无法投注");
}

var remainingSeconds = (int)(sealTime - now).TotalSeconds;
_logCallback($"🔄 第{retryCount}次投注尝试 (距封盘还有{remainingSeconds}秒)");
```

**示例日志：**
```
⏰ 期号114070636 开奖时间: 23:15:00, 封盘时间: 23:14:40
🔄 第1次投注尝试 (距封盘还有35秒)
⏰ 投注请求超时，开始验证订单...
🔍 查询未结算订单 (金额:20元)...
⚠️ 未找到订单，等待1秒后继续投注...
🔄 第2次投注尝试 (距封盘还有33秒)
📥 投注响应: {"status":true...
✅ 投注成功: 25121423143510029526020 (第2次尝试)
```

---

## 🛡️ **容错策略**

### **1. 网络超时处理**

| 情况 | 超时设置 | 处理方式 |
|------|----------|----------|
| 投注请求 | 2秒 | 超时后查询订单验证 |
| 订单查询 | 3秒 | 超时后继续重试投注 |

### **2. 业务错误处理**

| 错误类型 | 是否重试 | 说明 |
|----------|----------|------|
| **余额不足** | ❌ 立即停止 | 致命错误，不再重试 |
| **已封盘** | ❌ 立即停止 | 致命错误，不再重试 |
| **已结束** | ❌ 立即停止 | 致命错误，不再重试 |
| **网络错误** | ✅ 继续重试 | 可恢复错误 |
| **超时无响应** | ✅ 查询订单 | 可能已成功 |
| **未知错误** | ✅ 继续重试 | 可恢复错误 |

### **3. 防死循环保护**

```csharp
const int maxRetries = 100;  // 最大重试次数

while (retryCount < maxRetries)
{
    // ... 重试逻辑 ...
}

// 超过最大重试
return (false, "", "#投注失败：超过最大重试次数");
```

---

## 📊 **典型场景示例**

### **场景1：网络卡顿，投注实际已成功**

```
23:14:30 | 🔄 第1次投注尝试 (距封盘还有10秒)
23:14:30 | 📤 发送投注请求
23:14:32 | ⏰ 投注请求超时（2秒无响应）
23:14:32 | 🔍 查询未结算订单 (金额:20元)...
23:14:33 | 📋 查询到 1 条未结算订单，开始匹配...
23:14:33 | ✅ 找到匹配订单！金额:20元, 期号:114070636
23:14:33 | 🎉 投注已成功（通过订单验证确认，第1次尝试）
```

**结果：** ✅ 成功（虽然投注请求超时，但通过订单验证确认成功）

---

### **场景2：第一次失败，重试成功**

```
23:14:30 | 🔄 第1次投注尝试 (距封盘还有10秒)
23:14:32 | ⏰ 投注请求超时
23:14:32 | 🔍 查询未结算订单...
23:14:33 | ⚠️ 未找到订单，等待1秒后继续投注...
23:14:34 | 🔄 第2次投注尝试 (距封盘还有6秒)
23:14:35 | 📥 投注响应: {"status":true...
23:14:35 | ✅ 投注成功: 25121423143510029526020 (第2次尝试)
```

**结果：** ✅ 成功（第2次重试成功）

---

### **场景3：超过封盘时间**

```
23:14:38 | 🔄 第3次投注尝试 (距封盘还有2秒)
23:14:40 | ⏰ 投注请求超时
23:14:40 | 🔍 查询未结算订单...
23:14:41 | ⚠️ 未找到订单，等待1秒后继续投注...
23:14:42 | ⏰ 已超过封盘时间(23:14:40)，停止投注
```

**结果：** ❌ 失败（超过封盘时间）

---

### **场景4：余额不足（立即停止）**

```
23:14:30 | 🔄 第1次投注尝试 (距封盘还有10秒)
23:14:31 | 📥 投注响应: {"status":false,"msg":"余额不足"...
23:14:31 | ❌ 投注失败: 余额不足 (errcode=...)
```

**结果：** ❌ 失败（不再重试）

---

## 📊 **性能优化**

| 操作 | 超时时间 | 重试间隔 | 说明 |
|------|----------|----------|------|
| 投注请求 | 2秒 | - | 快速失败，及时重试 |
| 订单查询 | 3秒 | - | 稍长超时，确保查询完整 |
| 重试等待 | - | 1秒 | 避免频繁请求，缓解服务器压力 |

---

## 🔍 **订单验证逻辑**

### **为什么需要订单验证？**

**问题：** 网络卡顿时，投注请求可能超时，但服务器可能已经处理成功。

**解决：** 通过查询订单列表，检查是否已有匹配的订单。

### **匹配条件**

```csharp
// 🎯 同时满足两个条件才算匹配
var orderAmount = order["amount"]?.Value<int>() ?? 0;      // 订单金额
var orderExpect = order["expect"]?.ToString() ?? "";       // 订单期号

if (orderAmount == (int)totalAmount && orderExpect == issueId.ToString())
{
    // ✅ 找到匹配订单
    return (true, orderId, "verified");
}
```

### **订单数据结构**

```json
{
    "orderid": "25121417131710029526020",
    "uuid": 10029526,
    "roomeng": "twbingo",
    "expect": "114070636",           // 🔥 期号
    "amount": 20,                     // 🔥 总金额（整数）
    "state": 0,                       // 0=未结算
    "subcount": 2,                    // 子订单数量
    "userdata": "平一单 平一双 ",    // 投注内容
    "createtime": 20251214231317
}
```

---

## ⚙️ **配置参数**

```csharp
// 🔥 可调整的参数
const int TIMEOUT_BET = 2;           // 投注超时（秒）
const int TIMEOUT_QUERY = 3;         // 查询超时（秒）
const int RETRY_DELAY = 1000;        // 重试间隔（毫秒）
const int MAX_RETRIES = 100;         // 最大重试次数
const int SEAL_BEFORE_OPEN = 20;     // 提前封盘（秒）
```

---

## 📖 **完整日志示例**

### **成功场景（第2次重试成功）**

```
🎲 开始投注: 期号114070636 共2项 20元
⏰ 期号114070636 开奖时间: 23:15:00, 封盘时间: 23:14:40
🔄 第1次投注尝试 (距封盘还有35秒)
📤 发送投注请求: https://api.fr.win2000.vip/frcomgame/createmainorder
📋 POST数据（完整）: uuid=10029526&sid=7d77c02f...
⏰ 投注请求超时，开始验证订单...
🔍 查询未结算订单 (金额:20元)...
📤 获取订单列表: state=0, page=1/20, date=20251215~20251215, timeout=3秒
📥 订单响应: {"status":true...
📋 查询到 0 条未结算订单，开始匹配...
⚠️ 未找到订单，等待1秒后继续投注...
🔄 第2次投注尝试 (距封盘还有33秒)
📤 发送投注请求: https://api.fr.win2000.vip/frcomgame/createmainorder
📥 投注响应: {"status":true,"BettingNumber":"25121423143510029526020"...
✅ 投注成功: 25121423143510029526020 (第2次尝试)
```

---

### **订单验证成功场景**

```
🎲 开始投注: 期号114070636 共2项 20元
⏰ 期号114070636 开奖时间: 23:15:00, 封盘时间: 23:14:40
🔄 第1次投注尝试 (距封盘还有8秒)
📤 发送投注请求: https://api.fr.win2000.vip/frcomgame/createmainorder
⏰ 投注请求超时，开始验证订单...
🔍 查询未结算订单 (金额:20元)...
📤 获取订单列表: state=0, page=1/20, date=20251215~20251215, timeout=3秒
📥 订单响应: {"status":true...
📋 查询到 1 条未结算订单，开始匹配...
✅ 找到匹配订单！金额:20元, 期号:114070636, 订单号:25121423143210029526019
   订单内容: 平一单 平一双 
🎉 投注已成功（通过订单验证确认，第1次尝试）
```

---

### **超过封盘时间场景**

```
🎲 开始投注: 期号114070636 共2项 20元
⏰ 期号114070636 开奖时间: 23:15:00, 封盘时间: 23:14:40
🔄 第1次投注尝试 (距封盘还有2秒)
📤 发送投注请求: https://api.fr.win2000.vip/frcomgame/createmainorder
⏰ 投注请求超时，开始验证订单...
🔍 查询未结算订单 (金额:20元)...
⚠️ 未找到订单，等待1秒后继续投注...
⏰ 已超过封盘时间(23:14:40)，停止投注
❌ 投注失败: #已超过封盘时间，无法投注
```

---

## 💡 **核心优势**

| 优势 | 说明 |
|------|------|
| ✅ **网络容错** | 超时后不放弃，验证订单确认是否成功 |
| ✅ **智能重试** | 失败自动重试，直到成功或封盘 |
| ✅ **时间控制** | 精确计算封盘时间，避免封盘后投注 |
| ✅ **订单验证** | 通过金额和期号双重匹配确认成功 |
| ✅ **致命错误识别** | 余额不足等错误立即停止，不浪费时间 |
| ✅ **防死循环** | 最大重试100次保护 |
| ✅ **详细日志** | 每步都有日志，便于调试 |

---

## 🎉 **总结**

**TongBaoScript 的 PlaceBetAsync 方法现在具备：**

✅ **2秒快速超时**（及时发现网络问题）  
✅ **订单验证机制**（确认是否已成功）  
✅ **智能重试循环**（直到成功或封盘）  
✅ **封盘时间控制**（精确到秒）  
✅ **致命错误识别**（避免无效重试）  
✅ **完整日志输出**（便于监控和调试）  

**这套机制可以有效应对网络不稳定的情况，确保投注成功率！** 🎊

