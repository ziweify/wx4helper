# AI终端命令执行 - 快速参考卡

## 🚦 快速判断

```
命令/路径包含中文？
  ├─ 是 → ❌ 不使用 run_terminal_cmd
  │       ✅ 创建脚本文件
  │       ✅ 让用户在终端执行
  │
  └─ 否 → ✅ 可以使用 run_terminal_cmd
```

## ❌ 禁止操作

```javascript
// ❌ 错误：使用 run_terminal_cmd 处理中文路径
run_terminal_cmd({
  command: 'cd "E:\\项目\\中文目录"'
})

// ❌ 错误：尝试注入 chcp 65001（已测试，无效！）
run_terminal_cmd({
  command: 'chcp 65001; cd 中文路径'
  // 虽然 chcp 执行成功，但路径已是乱码
})

// ❌ 错误：尝试设置编码（已测试，无效！）
run_terminal_cmd({
  command: '[Console]::OutputEncoding = [System.Text.Encoding]::UTF8; cd 中文路径'
  // 只影响输出，不影响脚本文件编码
})

// ❌ 错误：使用 -LiteralPath 参数
run_terminal_cmd({
  command: 'Rename-Item -LiteralPath "E:\\中文\\路径\\file.txt"'
  // 参数本身的中文已损坏
})

// ❌ 错误：使用绝对路径规避
run_terminal_cmd({
  command: 'cd "E:\\完整\\的\\中文\\路径"'
  // 绝对路径也包含中文，问题相同
})
```

**重要**：所有"运行时编码设置"方案都已验证无效！
原因：中文字符在写入临时脚本文件时就已损坏。

## ✅ 正确操作

```javascript
// ✅ 正确：使用write工具创建脚本（已验证有效！）
write({
  file_path: '项目/重命名文件.ps1',
  contents: `# PowerShell脚本 - UTF-8编码
$targetDir = Join-Path $baseDir "项目说明"  # ✅ 中文正常
$renameMap = @{
    "old.md" = "new-中文.md"  # ✅ 中文正常
}
# ... 脚本内容
`
})

// ✅ 正确：创建批处理脚本
write({
  file_path: '项目/rename.bat',
  contents: `@echo off
chcp 65001 >nul
cd /d "E:\\项目\\中文目录"
ren "old.md" "new.md"
pause`
})

// 然后告知用户
// "请在Cursor终端中执行：
//  cd "E:\\项目\\中文目录"
//  .\\重命名文件.ps1"
// 或
//  .\\rename.bat"
```

**关键**：`write`工具创建的脚本文件编码正确，中文完全正常！✅

**⚠️ 重要补充**：PowerShell脚本中的中文字符串字面量可能导致解析错误！

```powershell
# ❌ 错误：直接使用中文字符串
$title = "本地DLL引用"  # 可能导致"意外的标记"错误

# ✅ 正确：使用Base64编码
function Decode-UTF8Base64 {
    param([string]$base64)
    $bytes = [System.Convert]::FromBase64String($base64)
    return [System.Text.Encoding]::UTF8.GetString($bytes)
}
$title = Decode-UTF8Base64 "6Y+I7oSA5rm0RExM5a+u5pug5pWk"  # "本地DLL引用"
```

## 📝 标准回复

```
由于操作涉及中文路径，请您在Cursor终端中执行：

cd "【路径】"
【命令】

或双击运行：【脚本文件路径】
```

## 🔗 详细文档

`AI工作规则/终端命令执行规则.md`

---

**记住**：
- 用户环境正常 ✅
- 工具有限制 ⚠️
- 创建脚本 👍
- 让用户执行 👍
- 脚本中文字符串用Base64编码 🔐

