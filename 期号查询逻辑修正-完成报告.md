# æœŸå·æŸ¥è¯¢é€»è¾‘ä¿®æ­£ - å®ŒæˆæŠ¥å‘Š

## âœ… æ ¸å¿ƒè®¾è®¡åŸåˆ™

### æœŸå·æ¥æºï¼š**æ°¸è¿œé€šè¿‡è®¡ç®—å¾—åˆ°**
```
æœŸå· = BinggoHelper.GetCurrentIssueId()  // åŸºäºæ—¶é—´è®¡ç®—
      â†“
   ä¸ä¾èµ–æ•°æ®åº“
   ä¸ä¾èµ–API
   å®Œå…¨æœ¬åœ°è®¡ç®—
```

### æ•°æ®åº“ç”¨é€”ï¼š**åªå­˜å‚¨å¼€å¥–ç»“æœ**
```
æ•°æ®åº“æŸ¥è¯¢ = æ ¹æ®æœŸå·ç²¾å‡†æŸ¥è¯¢å¼€å¥–æ•°æ®
           â†“
        WHERE IssueId = ?
        (ç²¾å‡†åŒ¹é…ï¼Œä¸æ˜¯èŒƒå›´æŸ¥è¯¢)
```

## ğŸ”§ ä¿®æ”¹å†…å®¹

### 1. æœŸå·åŸºå‡†æ›´æ–°ï¼ˆå·²å®Œæˆï¼‰

**æ–‡ä»¶ï¼š**
- `BaiShengVx3Plus/Helpers/BinggoHelper.cs`
- `zhaocaimao/Helpers/BinggoHelper.cs`

```csharp
private const int FIRST_ISSUE_ID = 115000001;     // æ–°åŸºå‡†æœŸå·
private const long FIRST_TIMESTAMP = 1767222300;  // æ–°åŸºå‡†æ—¶é—´æˆ³
```

### 2. æŸ¥è¯¢é€»è¾‘ä¿®æ­£ï¼ˆæ ¸å¿ƒæ”¹åŠ¨ï¼‰

**æ–‡ä»¶ï¼š**
- `BaiShengVx3Plus/Services/Games/Binggo/BinggoLotteryService.cs`
- `zhaocaimao/Services/Games/Binggo/BinggoLotteryService.cs`

**ä¿®æ”¹ä½ç½®ï¼š** `GetRecentLotteryDataAsync()` æ–¹æ³•

#### ä¿®æ”¹å‰ï¼ˆé”™è¯¯ï¼‰ï¼š
```csharp
// âŒ æ¨¡ç³ŠæŸ¥è¯¢ï¼šæŸ¥è¯¢æœ€è¿‘1000æœŸ
var local = _db.Table<BinggoLotteryData>()
    .Where(d => d.IssueId >= minValidIssueId)
    .OrderByDescending(d => d.IssueId)
    .Take(count * 2)
    .ToList();
```

**é—®é¢˜ï¼š**
- ä¾èµ–æ•°æ®åº“ä¸­çš„æœŸå·
- å¯èƒ½æŸ¥åˆ°æ—§åŸºå‡†çš„æœŸå·ï¼ˆ114****ï¼‰
- æŸ¥è¯¢æ•ˆç‡ä½

#### ä¿®æ”¹åï¼ˆæ­£ç¡®ï¼‰ï¼š
```csharp
// âœ… ç²¾å‡†æŸ¥è¯¢ï¼šå…ˆè®¡ç®—æœŸå·ï¼Œå†æŸ¥è¯¢æ•°æ®
int currentIssueId = BinggoHelper.GetCurrentIssueId();  // æœ¬åœ°è®¡ç®—

for (int i = 1; i <= count; i++)
{
    int targetIssueId = BinggoHelper.GetPreviousIssueId(currentIssueId, i);  // è®¡ç®—ä¸ŠNæœŸ
    
    // ç²¾å‡†æŸ¥è¯¢è¯¥æœŸå·çš„æ•°æ®
    var data = _db.Table<BinggoLotteryData>()
        .Where(d => d.IssueId == targetIssueId)  // ç²¾å‡†åŒ¹é…
        .FirstOrDefault();
    
    if (data != null && data.IsOpened)
    {
        result.Add(data);
    }
}
```

**ä¼˜ç‚¹ï¼š**
- âœ… æœŸå·å®Œå…¨ç”±è®¡ç®—å¾—åˆ°ï¼Œä¸ä¾èµ–æ•°æ®åº“
- âœ… ç²¾å‡†æŸ¥è¯¢ï¼ŒWHERE IssueId = ?
- âœ… æ€§èƒ½é«˜æ•ˆï¼Œåˆ©ç”¨ä¸»é”®ç´¢å¼•
- âœ… æ°¸è¿œä¸ä¼šæŸ¥åˆ°æ—§åŸºå‡†çš„æœŸå·

### 3. æ¸…ç†æ—§æ•°æ®ï¼ˆä¸€æ¬¡æ€§æ“ä½œï¼‰

**æ–‡ä»¶ï¼š**
- `BaiShengVx3Plus/Services/Games/Binggo/BinggoLotteryService.cs`
- `zhaocaimao/Services/Games/Binggo/BinggoLotteryService.cs`

**æ–¹æ³•ï¼š** `CleanupOldLotteryData()`

```csharp
// ğŸ”¥ åªåˆ é™¤æ—§åŸºå‡†ï¼ˆ114å¼€å¤´ï¼‰çš„æ•°æ®
int deletedCount = _db.Execute(
    "DELETE FROM BinggoLotteryData WHERE IssueId < ?", 
    115000000);  // åˆ é™¤æ‰€æœ‰ < 115000000 çš„æ•°æ®
```

**ç‰¹ç‚¹ï¼š**
- åªåœ¨ç¨‹åºå¯åŠ¨æ—¶æ‰§è¡Œä¸€æ¬¡
- åªåˆ é™¤æ—§åŸºå‡†æ•°æ®ï¼ˆ114å¼€å¤´ï¼‰
- ä¸å½±å“æ­£å¸¸å†å²æ•°æ®ï¼ˆ115å¼€å¤´ï¼‰

## ğŸ“Š å®Œæ•´æ•°æ®æµç¨‹

### è·å–ä¸ŠæœŸå¼€å¥–æ•°æ®

```
1. è®¡ç®—å½“å‰æœŸå·
   currentIssueId = BinggoHelper.GetCurrentIssueId()
   ä¾‹å¦‚ï¼š115000033

2. è®¡ç®—ä¸ŠæœŸæœŸå·
   lastIssueId = BinggoHelper.GetPreviousIssueId(currentIssueId)
   ä¾‹å¦‚ï¼š115000032

3. ç²¾å‡†æŸ¥è¯¢æ•°æ®åº“
   SELECT * FROM BinggoLotteryData WHERE IssueId = 115000032
   
4. åˆ¤æ–­ç»“æœ
   â”œâ”€ æœ‰æ•°æ® â†’ æ˜¾ç¤ºå¼€å¥–ç»“æœ
   â””â”€ æ— æ•°æ® â†’ åŠ å…¥æ›´æ–°é˜Ÿåˆ—ï¼Œä»APIè·å–
```

### æœŸå·å˜æ›´æ—¶çš„å¤„ç†

```
æœŸå·å˜æ›´äº‹ä»¶
  â””â”€ oldIssueId = 115000032ï¼ˆè®¡ç®—å¾—åˆ°ï¼‰
  â””â”€ newIssueId = 115000033ï¼ˆè®¡ç®—å¾—åˆ°ï¼‰
      â”œâ”€ ä¸ŠæœŸåŠ å…¥å¼€å¥–é˜Ÿåˆ—
      â”‚   â””â”€ æŸ¥è¯¢æ•°æ®åº“ï¼šIssueId = 115000032
      â”‚       â”œâ”€ æœ‰æ•°æ® â†’ è§¦å‘å¼€å¥–äº‹ä»¶
      â”‚       â””â”€ æ— æ•°æ® â†’ ä»APIè·å–
      â””â”€ è§¦å‘æœŸå·å˜æ›´äº‹ä»¶
```

## ğŸ¯ å…³é”®ç‚¹æ€»ç»“

### âœ… æ­£ç¡®çš„åšæ³•

1. **æœŸå·æ°¸è¿œè®¡ç®—å¾—åˆ°**
   ```csharp
   int issueId = BinggoHelper.GetCurrentIssueId();  // ä¸æŸ¥æ•°æ®åº“
   ```

2. **æ•°æ®åº“åªå­˜ç»“æœ**
   ```csharp
   var data = _db.Table<BinggoLotteryData>()
       .Where(d => d.IssueId == targetIssueId)  // ç²¾å‡†æŸ¥è¯¢
       .FirstOrDefault();
   ```

3. **æ— æ•°æ®èµ°æ›´æ–°æµç¨‹**
   ```csharp
   if (data == null || !data.IsOpened)
   {
       // åŠ å…¥å¼€å¥–é˜Ÿåˆ—ï¼Œä»APIè·å–
       _lotteryQueue.AddOrUpdate(issueId, ...);
   }
   ```

### âŒ é”™è¯¯çš„åšæ³•

1. **ä»æ•°æ®åº“æŸ¥æœŸå·**
   ```csharp
   // âŒ é”™è¯¯
   var data = _db.Table<BinggoLotteryData>()
       .OrderByDescending(d => d.IssueId)
       .FirstOrDefault();
   int issueId = data.IssueId;  // å¯èƒ½æ˜¯æ—§æœŸå·
   ```

2. **èŒƒå›´æŸ¥è¯¢**
   ```csharp
   // âŒ é”™è¯¯
   var list = _db.Table<BinggoLotteryData>()
       .Where(d => d.IssueId >= minIssueId)
       .Take(count)
       .ToList();
   ```

## ğŸ“ æµ‹è¯•éªŒè¯

### éªŒè¯1ï¼šæœŸå·è®¡ç®—
```csharp
int currentIssueId = BinggoHelper.GetCurrentIssueId();
// åº”è¯¥è¿”å› 115å¼€å¤´çš„æœŸå·ï¼Œä¾‹å¦‚ 115000033
```

### éªŒè¯2ï¼šæ•°æ®æŸ¥è¯¢
```csharp
// ç²¾å‡†æŸ¥è¯¢æŒ‡å®šæœŸå·
var data = _db.Table<BinggoLotteryData>()
    .Where(d => d.IssueId == 115000032)
    .FirstOrDefault();
// åªæŸ¥è¯¢è¯¥æœŸå·ï¼Œä¸æŸ¥å…¶ä»–
```

### éªŒè¯3ï¼šå¯åŠ¨æ¸…ç†
```
ç¨‹åºå¯åŠ¨æ—¥å¿—åº”æ˜¾ç¤ºï¼š
[INFO] ğŸ—‘ï¸ æ¸…ç†äº† N æ¡æ—§åŸºå‡†æœŸå·æ•°æ®ï¼ˆ< 115000000ï¼‰
```

## ğŸ‰ æ€»ç»“

### ä¿®æ”¹å‰çš„é—®é¢˜
- âŒ æŸ¥è¯¢æœ€è¿‘NæœŸï¼Œä¾èµ–æ•°æ®åº“ä¸­çš„æœŸå·
- âŒ å¯èƒ½è¿”å›æ—§åŸºå‡†çš„114æœŸå·
- âŒ èŒƒå›´æŸ¥è¯¢æ•ˆç‡ä½

### ä¿®æ”¹åçš„ä¼˜åŠ¿
- âœ… æœŸå·å®Œå…¨ç”±æ—¶é—´è®¡ç®—ï¼Œä¸ä¾èµ–æ•°æ®åº“
- âœ… ç²¾å‡†æŸ¥è¯¢ï¼ŒWHERE IssueId = ?
- âœ… æ°¸è¿œä¸ä¼šæŸ¥åˆ°æ—§æœŸå·
- âœ… æ€§èƒ½æ›´é«˜ï¼Œé€»è¾‘æ›´æ¸…æ™°

**æ ¸å¿ƒåŸåˆ™ï¼šæœŸå·é è®¡ç®—ï¼Œæ•°æ®åº“åªå­˜ç»“æœï¼**

